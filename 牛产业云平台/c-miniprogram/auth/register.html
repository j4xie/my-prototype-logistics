<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>企业入驻 - 中国牛产业数智云平台</title>
  <link rel="stylesheet" href="../../assets/css/variables.css">
  <link rel="stylesheet" href="../../assets/css/common.css">
  <link rel="stylesheet" href="../../assets/css/mobile.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background: #F5F5F5;
      min-height: 100vh;
    }

    /* 顶部导航 */
    .nav-header {
      background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);
      color: white;
      padding: 16px;
      display: flex;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .back-btn {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      text-decoration: none;
      margin-right: 12px;
    }

    .nav-title {
      font-size: 18px;
      font-weight: 600;
    }

    /* 步骤指示器 */
    .steps-indicator {
      background: white;
      padding: 20px 16px;
      display: flex;
      justify-content: center;
      gap: 8px;
      border-bottom: 1px solid #E0E0E0;
    }

    .step-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .step-number {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #E0E0E0;
      color: #9E9E9E;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .step-item.active .step-number {
      background: #2E7D32;
      color: white;
    }

    .step-item.completed .step-number {
      background: #4CAF50;
      color: white;
    }

    .step-item.completed .step-number::before {
      content: "\F012C";
      font-family: "Material Design Icons";
    }

    .step-label {
      font-size: 13px;
      color: #9E9E9E;
      display: none;
    }

    .step-item.active .step-label {
      color: #2E7D32;
      font-weight: 500;
      display: block;
    }

    .step-line {
      width: 40px;
      height: 2px;
      background: #E0E0E0;
    }

    .step-item.completed+.step-line {
      background: #4CAF50;
    }

    @media (min-width: 480px) {
      .step-label {
        display: block;
      }
    }

    /* 主内容区 */
    .main-content {
      padding: 20px 16px;
      max-width: 600px;
      margin: 0 auto;
    }

    /* 步骤面板 */
    .step-panel {
      display: none;
      background: white;
      border-radius: 12px;
      padding: 24px 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .step-panel.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .step-title {
      font-size: 20px;
      font-weight: 600;
      color: #212121;
      margin-bottom: 8px;
    }

    .step-desc {
      font-size: 14px;
      color: #757575;
      margin-bottom: 24px;
    }

    /* 表单样式 */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
      color: #424242;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .form-label .required {
      color: #D32F2F;
    }

    .form-input {
      width: 100%;
      height: 48px;
      padding: 0 16px;
      border: 1px solid #E0E0E0;
      border-radius: 8px;
      font-size: 16px;
      color: #212121;
      background: #FAFAFA;
      transition: all 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: #2E7D32;
      background: white;
      box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
    }

    .form-input::placeholder {
      color: #BDBDBD;
    }

    .form-input.error {
      border-color: #D32F2F;
    }

    .form-textarea {
      height: 100px;
      padding: 12px 16px;
      resize: none;
    }

    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23757575' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
      padding-right: 40px;
    }

    /* 带按钮的输入框 */
    .input-with-btn {
      display: flex;
      gap: 12px;
    }

    .input-with-btn .form-input {
      flex: 1;
    }

    .sms-btn {
      width: 110px;
      height: 48px;
      background: #E8F5E9;
      color: #2E7D32;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s;
    }

    .sms-btn:hover {
      background: #C8E6C9;
    }

    .sms-btn:disabled {
      background: #F5F5F5;
      color: #9E9E9E;
      cursor: not-allowed;
    }

    /* 错误提示 */
    .error-message {
      color: #D32F2F;
      font-size: 12px;
      margin-top: 6px;
      display: none;
    }

    .form-group.has-error .error-message {
      display: block;
    }

    .form-group.has-error .form-input {
      border-color: #D32F2F;
    }

    /* 企业类型选择 */
    .type-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .type-item {
      padding: 16px;
      border: 2px solid #E0E0E0;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .type-item:hover {
      border-color: #A5D6A7;
      background: #F1F8E9;
    }

    .type-item.selected {
      border-color: #2E7D32;
      background: #E8F5E9;
    }

    .type-item .icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .type-item .name {
      font-size: 14px;
      font-weight: 500;
      color: #424242;
    }

    .type-item .desc {
      font-size: 12px;
      color: #9E9E9E;
      margin-top: 4px;
    }

    /* 图片上传 */
    .upload-area {
      border: 2px dashed #E0E0E0;
      border-radius: 12px;
      padding: 32px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .upload-area:hover {
      border-color: #A5D6A7;
      background: #F9FBE7;
    }

    .upload-area .icon {
      font-size: 48px;
      color: #BDBDBD;
      margin-bottom: 12px;
    }

    .upload-area .text {
      font-size: 14px;
      color: #757575;
    }

    .upload-area .hint {
      font-size: 12px;
      color: #9E9E9E;
      margin-top: 8px;
    }

    .upload-preview {
      position: relative;
      display: none;
    }

    .upload-preview img {
      width: 100%;
      max-height: 200px;
      object-fit: contain;
      border-radius: 8px;
    }

    .upload-preview .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
    }

    /* 省市选择 */
    .location-selects {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* 按钮组 */
    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 32px;
    }

    .btn {
      flex: 1;
      height: 50px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(46, 125, 50, 0.4);
    }

    .btn-secondary {
      background: #F5F5F5;
      color: #616161;
    }

    .btn-secondary:hover {
      background: #EEEEEE;
    }

    .btn:disabled {
      background: #BDBDBD;
      box-shadow: none;
      cursor: not-allowed;
    }

    /* 成功页面 */
    .success-panel {
      text-align: center;
      padding: 48px 24px;
    }

    .success-icon {
      width: 80px;
      height: 80px;
      background: #E8F5E9;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      font-size: 40px;
    }

    .success-title {
      font-size: 24px;
      font-weight: 600;
      color: #212121;
      margin-bottom: 12px;
    }

    .success-desc {
      font-size: 14px;
      color: #757575;
      margin-bottom: 32px;
      line-height: 1.6;
    }

    .success-info {
      background: #F5F5F5;
      border-radius: 12px;
      padding: 20px;
      text-align: left;
      margin-bottom: 32px;
    }

    .success-info-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #E0E0E0;
    }

    .success-info-item:last-child {
      border-bottom: none;
    }

    .success-info-label {
      color: #757575;
      font-size: 14px;
    }

    .success-info-value {
      color: #212121;
      font-size: 14px;
      font-weight: 500;
    }

    /* 协议勾选 */
    .agreement {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-top: 20px;
      font-size: 13px;
      color: #757575;
    }

    .agreement input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #2E7D32;
      margin-top: 2px;
    }

    .agreement a {
      color: #2E7D32;
      text-decoration: none;
    }

    /* Toast */
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.75);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      display: none;
    }

    .toast.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    /* Loading */
    .btn.loading::after {
      content: '';
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid white;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* 提示信息 */
    .form-hint {
      font-size: 12px;
      color: #9E9E9E;
      margin-top: 6px;
    }
  </style>
</head>

<body>
  <!-- 顶部导航 -->
  <header class="nav-header">
    <a href="login.html" class="back-btn"><i class="mdi mdi-arrow-left"></i></a>
    <span class="nav-title">企业入驻</span>
  </header>

  <!-- 步骤指示器 -->
  <div class="steps-indicator">
    <div class="step-item active" data-step="1">
      <div class="step-number">1</div>
      <span class="step-label">验证手机</span>
    </div>
    <div class="step-line"></div>
    <div class="step-item" data-step="2">
      <div class="step-number">2</div>
      <span class="step-label">企业信息</span>
    </div>
    <div class="step-line"></div>
    <div class="step-item" data-step="3">
      <div class="step-number">3</div>
      <span class="step-label">联系人</span>
    </div>
    <div class="step-line"></div>
    <div class="step-item" data-step="4">
      <div class="step-number">4</div>
      <span class="step-label">完成</span>
    </div>
  </div>

  <div class="main-content">
    <!-- Step 1: 手机验证 -->
    <div class="step-panel active" data-step="1">
      <h2 class="step-title">验证手机号</h2>
      <p class="step-desc">请输入您的手机号，用于接收验证码和后续登录</p>

      <form id="step1Form">
        <div class="form-group">
          <label class="form-label">
            手机号 <span class="required">*</span>
          </label>
          <input type="tel" class="form-input" name="phone" placeholder="请输入手机号" maxlength="11" required>
          <div class="error-message">请输入正确的手机号</div>
        </div>

        <div class="form-group">
          <label class="form-label">
            验证码 <span class="required">*</span>
          </label>
          <div class="input-with-btn">
            <input type="text" class="form-input" name="smsCode" placeholder="请输入验证码" maxlength="6" required>
            <button type="button" class="sms-btn" onclick="sendSmsCode(this)">获取验证码</button>
          </div>
          <div class="error-message">请输入6位验证码</div>
        </div>

        <div class="form-group">
          <label class="form-label">
            设置密码 <span class="required">*</span>
          </label>
          <input type="password" class="form-input" name="password" placeholder="请设置6-20位密码" minlength="6"
            maxlength="20" required>
          <div class="form-hint">密码需要6-20位，建议包含字母和数字</div>
          <div class="error-message">请设置6-20位密码</div>
        </div>

        <div class="agreement">
          <input type="checkbox" name="agree" id="agree" checked>
          <label for="agree">
            我已阅读并同意 <a href="#">《用户服务协议》</a> 和 <a href="#">《隐私政策》</a>
          </label>
        </div>

        <div class="btn-group">
          <button type="submit" class="btn btn-primary">下一步</button>
        </div>
      </form>
    </div>

    <!-- Step 2: 企业信息 -->
    <div class="step-panel" data-step="2">
      <h2 class="step-title">填写企业信息</h2>
      <p class="step-desc">请填写您的企业基本信息，便于其他用户了解您</p>

      <form id="step2Form">
        <div class="form-group">
          <label class="form-label">
            企业类型 <span class="required">*</span>
          </label>
          <div class="type-grid" id="typeGrid">
            <div class="type-item" data-type="FARM">
              <div class="icon"><i class="mdi mdi-barn"></i></div>
              <div class="name">养殖场</div>
              <div class="desc">肉牛/繁育场</div>
            </div>
            <div class="type-item" data-type="DEALER">
              <div class="icon"><i class="mdi mdi-handshake"></i></div>
              <div class="name">经纪人</div>
              <div class="desc">牛只贸易商</div>
            </div>
            <div class="type-item" data-type="SLAUGHTER">
              <div class="icon"><i class="mdi mdi-factory"></i></div>
              <div class="name">屠宰场</div>
              <div class="desc">屠宰加工企业</div>
            </div>
            <div class="type-item" data-type="FEED">
              <div class="icon"><i class="mdi mdi-barley"></i></div>
              <div class="name">饲料商</div>
              <div class="desc">饲料生产销售</div>
            </div>
            <div class="type-item" data-type="EQUIPMENT">
              <div class="icon"><i class="mdi mdi-tractor"></i></div>
              <div class="name">设备商</div>
              <div class="desc">养殖设备销售</div>
            </div>
            <div class="type-item" data-type="OTHER">
              <div class="icon"><i class="mdi mdi-package-variant"></i></div>
              <div class="name">其他</div>
              <div class="desc">其他服务商</div>
            </div>
          </div>
          <input type="hidden" name="enterpriseType" required>
          <div class="error-message">请选择企业类型</div>
        </div>

        <div class="form-group">
          <label class="form-label">
            企业名称 <span class="required">*</span>
          </label>
          <input type="text" class="form-input" name="enterpriseName" placeholder="请输入营业执照上的企业名称" required>
          <div class="error-message">请输入企业名称</div>
        </div>

        <div class="form-group">
          <label class="form-label">
            所在地区 <span class="required">*</span>
          </label>
          <div class="location-selects">
            <select class="form-input form-select" name="province" id="provinceSelect" required>
              <option value="">选择省份</option>
            </select>
            <select class="form-input form-select" name="city" id="citySelect" required>
              <option value="">选择城市</option>
            </select>
          </div>
          <div class="error-message">请选择所在地区</div>
        </div>

        <div class="form-group">
          <label class="form-label">
            详细地址
          </label>
          <input type="text" class="form-input" name="address" placeholder="请输入详细地址（选填）">
        </div>

        <div class="form-group">
          <label class="form-label">
            营业执照 <span class="required">*</span>
          </label>
          <div class="upload-area" onclick="triggerUpload('licenseInput')">
            <div class="icon"><i class="mdi mdi-file-document-outline"></i></div>
            <div class="text">点击上传营业执照</div>
            <div class="hint">支持 JPG、PNG 格式，大小不超过 5MB</div>
          </div>
          <div class="upload-preview" id="licensePreview">
            <img src="" alt="营业执照">
            <button type="button" class="remove-btn" onclick="removeUpload('license')">×</button>
          </div>
          <input type="file" id="licenseInput" accept="image/*" hidden onchange="handleUpload(this, 'license')">
          <input type="hidden" name="licenseImage">
          <div class="error-message">请上传营业执照</div>
        </div>

        <div class="btn-group">
          <button type="button" class="btn btn-secondary" onclick="prevStep()">上一步</button>
          <button type="submit" class="btn btn-primary">下一步</button>
        </div>
      </form>
    </div>

    <!-- Step 3: 联系人信息 -->
    <div class="step-panel" data-step="3">
      <h2 class="step-title">填写联系人信息</h2>
      <p class="step-desc">请填写企业联系人信息，便于客户与您联系</p>

      <form id="step3Form">
        <div class="form-group">
          <label class="form-label">
            联系人姓名 <span class="required">*</span>
          </label>
          <input type="text" class="form-input" name="contactName" placeholder="请输入联系人姓名" required>
          <div class="error-message">请输入联系人姓名</div>
        </div>

        <div class="form-group">
          <label class="form-label">
            职务
          </label>
          <input type="text" class="form-input" name="contactRole" placeholder="如：负责人、销售经理（选填）">
        </div>

        <div class="form-group">
          <label class="form-label">
            联系电话 <span class="required">*</span>
          </label>
          <input type="tel" class="form-input" name="contactPhone" placeholder="请输入联系电话" required>
          <div class="form-hint">默认使用注册手机号，可修改为其他联系电话</div>
          <div class="error-message">请输入联系电话</div>
        </div>

        <div class="form-group">
          <label class="form-label">
            微信号
          </label>
          <input type="text" class="form-input" name="contactWechat" placeholder="请输入微信号（选填）">
          <div class="form-hint">填写微信号方便客户添加您</div>
        </div>

        <div class="form-group">
          <label class="form-label">
            企业简介
          </label>
          <textarea class="form-input form-textarea" name="description" placeholder="简单介绍您的企业（选填）"></textarea>
        </div>

        <div class="btn-group">
          <button type="button" class="btn btn-secondary" onclick="prevStep()">上一步</button>
          <button type="submit" class="btn btn-primary">提交入驻</button>
        </div>
      </form>
    </div>

    <!-- Step 4: 完成 -->
    <div class="step-panel" data-step="4">
      <div class="success-panel">
        <div class="success-icon"><i class="mdi mdi-check"></i></div>
        <h2 class="success-title">入驻申请已提交</h2>
        <p class="success-desc">
          我们会在1-3个工作日内审核您的资料<br>
          审核结果将通过短信通知您
        </p>

        <div class="success-info">
          <div class="success-info-item">
            <span class="success-info-label">企业名称</span>
            <span class="success-info-value" id="resultName">-</span>
          </div>
          <div class="success-info-item">
            <span class="success-info-label">企业类型</span>
            <span class="success-info-value" id="resultType">-</span>
          </div>
          <div class="success-info-item">
            <span class="success-info-label">联系人</span>
            <span class="success-info-value" id="resultContact">-</span>
          </div>
          <div class="success-info-item">
            <span class="success-info-label">联系电话</span>
            <span class="success-info-value" id="resultPhone">-</span>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="goHome()">进入首页</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- JS -->
  <script src="../../assets/js/utils.js"></script>
  <script src="../../assets/js/formValidator.js"></script>
  <script src="../../assets/js/stateManager.js"></script>
  <script src="../../assets/js/dictionaries.js"></script>
  <script src="../../assets/js/mockData.js"></script>

  <script>
    // ==================== 全局变量 ====================
    let currentStep = 1;
    let formData = {
      phone: '',
      password: '',
      enterpriseType: '',
      enterpriseName: '',
      province: '',
      city: '',
      address: '',
      licenseImage: '',
      contactName: '',
      contactRole: '',
      contactPhone: '',
      contactWechat: '',
      description: ''
    };

    // ==================== 初始化 ====================
    document.addEventListener('DOMContentLoaded', function () {
      initProvinceSelect();
      initTypeSelect();
      initFormSubmits();
    });

    // ==================== 省市联动 ====================
    function initProvinceSelect() {
      const provinceSelect = document.getElementById('provinceSelect');
      const citySelect = document.getElementById('citySelect');

      // 填充省份
      const provinces = Dictionaries.getProvinces();
      provinces.forEach(p => {
        const option = document.createElement('option');
        option.value = p.code;
        option.textContent = p.name;
        provinceSelect.appendChild(option);
      });

      // 省份变化时更新城市
      provinceSelect.addEventListener('change', function () {
        const provinceCode = this.value;
        citySelect.innerHTML = '<option value="">选择城市</option>';

        if (provinceCode) {
          const cities = Dictionaries.getCitiesByProvince(provinceCode);
          cities.forEach(c => {
            const option = document.createElement('option');
            option.value = c.code;
            option.textContent = c.name;
            citySelect.appendChild(option);
          });
        }
      });
    }

    // ==================== 企业类型选择 ====================
    function initTypeSelect() {
      const typeItems = document.querySelectorAll('.type-item');
      const typeInput = document.querySelector('input[name="enterpriseType"]');

      typeItems.forEach(item => {
        item.addEventListener('click', function () {
          typeItems.forEach(i => i.classList.remove('selected'));
          this.classList.add('selected');
          typeInput.value = this.dataset.type;
        });
      });
    }

    // ==================== 表单提交 ====================
    function initFormSubmits() {
      // Step 1
      document.getElementById('step1Form').addEventListener('submit', async function (e) {
        e.preventDefault();
        if (await validateStep1(this)) {
          nextStep();
        }
      });

      // Step 2
      document.getElementById('step2Form').addEventListener('submit', async function (e) {
        e.preventDefault();
        if (await validateStep2(this)) {
          nextStep();
        }
      });

      // Step 3
      document.getElementById('step3Form').addEventListener('submit', async function (e) {
        e.preventDefault();
        if (await validateStep3(this)) {
          await submitRegister();
        }
      });
    }

    // ==================== 步骤验证 ====================
    async function validateStep1(form) {
      const phone = form.phone.value.trim();
      const smsCode = form.smsCode.value.trim();
      const password = form.password.value;
      const agree = form.agree.checked;

      // 验证手机号
      if (!/^1[3-9]\d{9}$/.test(phone)) {
        showFormError(form.phone, '请输入正确的手机号');
        return false;
      }

      // 验证验证码
      if (!/^\d{6}$/.test(smsCode)) {
        showFormError(form.smsCode, '请输入6位验证码');
        return false;
      }

      // 验证密码
      if (password.length < 6 || password.length > 20) {
        showFormError(form.password, '请设置6-20位密码');
        return false;
      }

      // 验证协议
      if (!agree) {
        showToast('请先同意用户协议');
        return false;
      }

      // 保存数据
      formData.phone = phone;
      formData.password = password;
      formData.contactPhone = phone; // 默认联系电话

      return true;
    }

    async function validateStep2(form) {
      const enterpriseType = form.enterpriseType.value;
      const enterpriseName = form.enterpriseName.value.trim();
      const province = form.province.value;
      const city = form.city.value;
      const licenseImage = form.licenseImage.value;

      // 验证企业类型
      if (!enterpriseType) {
        showToast('请选择企业类型');
        return false;
      }

      // 验证企业名称
      if (!enterpriseName) {
        showFormError(form.enterpriseName, '请输入企业名称');
        return false;
      }

      // 验证地区
      if (!province || !city) {
        showToast('请选择所在地区');
        return false;
      }

      // 验证营业执照（模拟）
      // 实际项目中需要真正上传

      // 保存数据
      formData.enterpriseType = enterpriseType;
      formData.enterpriseName = enterpriseName;
      formData.province = form.province.options[form.province.selectedIndex].text;
      formData.city = form.city.options[form.city.selectedIndex].text;
      formData.address = form.address.value.trim();

      return true;
    }

    async function validateStep3(form) {
      const contactName = form.contactName.value.trim();
      const contactPhone = form.contactPhone.value.trim();

      // 验证联系人姓名
      if (!contactName) {
        showFormError(form.contactName, '请输入联系人姓名');
        return false;
      }

      // 验证联系电话
      if (!/^1[3-9]\d{9}$/.test(contactPhone)) {
        showFormError(form.contactPhone, '请输入正确的联系电话');
        return false;
      }

      // 保存数据
      formData.contactName = contactName;
      formData.contactRole = form.contactRole.value.trim();
      formData.contactPhone = contactPhone;
      formData.contactWechat = form.contactWechat.value.trim();
      formData.description = form.description.value.trim();

      return true;
    }

    // ==================== 提交注册 ====================
    async function submitRegister() {
      const btn = document.querySelector('#step3Form .btn-primary');
      btn.classList.add('loading');
      btn.textContent = '提交中';

      // 模拟提交
      await Utils.sleep(2000);

      // 保存用户信息
      const newUser = {
        id: 'USER_' + Date.now(),
        phone: formData.phone,
        name: formData.contactName,
        enterpriseId: 'ENT_' + Date.now(),
        enterpriseName: formData.enterpriseName,
        enterpriseType: formData.enterpriseType,
        role: 'admin',
        status: 'pending'
      };

      globalState.set('user', newUser);
      globalState.set('auth.isLoggedIn', false); // 待审核

      // 显示结果
      document.getElementById('resultName').textContent = formData.enterpriseName;
      document.getElementById('resultType').textContent = getTypeLabel(formData.enterpriseType);
      document.getElementById('resultContact').textContent = formData.contactName;
      document.getElementById('resultPhone').textContent = formData.contactPhone;

      btn.classList.remove('loading');
      btn.textContent = '提交入驻';

      // 进入完成步骤
      nextStep();
    }

    // ==================== 步骤导航 ====================
    function nextStep() {
      if (currentStep < 4) {
        currentStep++;
        updateStepUI();
      }
    }

    function prevStep() {
      if (currentStep > 1) {
        currentStep--;
        updateStepUI();
      }
    }

    function updateStepUI() {
      // 更新步骤指示器
      document.querySelectorAll('.step-item').forEach((item, index) => {
        const step = index + 1;
        item.classList.remove('active', 'completed');

        if (step < currentStep) {
          item.classList.add('completed');
        } else if (step === currentStep) {
          item.classList.add('active');
        }
      });

      // 更新步骤线
      document.querySelectorAll('.step-line').forEach((line, index) => {
        if (index + 1 < currentStep) {
          line.style.background = '#4CAF50';
        } else {
          line.style.background = '#E0E0E0';
        }
      });

      // 切换面板
      document.querySelectorAll('.step-panel').forEach(panel => {
        panel.classList.remove('active');
        if (parseInt(panel.dataset.step) === currentStep) {
          panel.classList.add('active');
        }
      });

      // 预填充联系电话
      if (currentStep === 3) {
        const phoneInput = document.querySelector('#step3Form input[name="contactPhone"]');
        if (!phoneInput.value) {
          phoneInput.value = formData.phone;
        }
      }

      // 滚动到顶部
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ==================== 图片上传 ====================
    function triggerUpload(inputId) {
      document.getElementById(inputId).click();
    }

    function handleUpload(input, type) {
      const file = input.files[0];
      if (!file) return;

      // 验证文件类型
      if (!file.type.startsWith('image/')) {
        showToast('请上传图片文件');
        return;
      }

      // 验证文件大小
      if (file.size > 5 * 1024 * 1024) {
        showToast('图片大小不能超过5MB');
        return;
      }

      // 读取并预览
      const reader = new FileReader();
      reader.onload = function (e) {
        const preview = document.getElementById(type + 'Preview');
        preview.querySelector('img').src = e.target.result;
        preview.style.display = 'block';
        preview.previousElementSibling.style.display = 'none';

        // 保存数据
        formData[type + 'Image'] = e.target.result;
        document.querySelector('input[name="' + type + 'Image"]').value = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function removeUpload(type) {
      const preview = document.getElementById(type + 'Preview');
      preview.style.display = 'none';
      preview.previousElementSibling.style.display = 'block';
      document.getElementById(type + 'Input').value = '';
      document.querySelector('input[name="' + type + 'Image"]').value = '';
      formData[type + 'Image'] = '';
    }

    // ==================== 工具函数 ====================
    function sendSmsCode(btn) {
      const form = btn.closest('form');
      const phone = form.phone.value.trim();

      if (!/^1[3-9]\d{9}$/.test(phone)) {
        showFormError(form.phone, '请输入正确的手机号');
        return;
      }

      let seconds = 60;
      btn.disabled = true;
      btn.textContent = seconds + 's后重发';

      const timer = setInterval(() => {
        seconds--;
        if (seconds <= 0) {
          clearInterval(timer);
          btn.disabled = false;
          btn.textContent = '获取验证码';
        } else {
          btn.textContent = seconds + 's后重发';
        }
      }, 1000);

      showToast('验证码已发送');
    }

    function showFormError(input, message) {
      const formGroup = input.closest('.form-group');
      formGroup.classList.add('has-error');
      formGroup.querySelector('.error-message').textContent = message;
      input.focus();

      setTimeout(() => {
        formGroup.classList.remove('has-error');
      }, 3000);
    }

    function showToast(message, duration = 2000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    function getTypeLabel(type) {
      const types = {
        'FARM': '养殖场',
        'DEALER': '经纪人',
        'SLAUGHTER': '屠宰场',
        'FEED': '饲料商',
        'EQUIPMENT': '设备商',
        'OTHER': '其他'
      };
      return types[type] || type;
    }

    function goHome() {
      window.location.href = '../home/home.html';
    }

    // 输入时清除错误
    document.querySelectorAll('.form-input').forEach(input => {
      input.addEventListener('input', function () {
        this.closest('.form-group')?.classList.remove('has-error');
      });
    });
  </script>
</body>

</html>