<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>设备交易 - 中国牛产业数智云平台</title>
  <link rel="stylesheet" href="../../assets/css/variables.css">
  <link rel="stylesheet" href="../../assets/css/mobile.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background: #F5F5F5;
      min-height: 100vh;
      /* padding-bottom 由 mobile.css 的 body.has-bottom-nav 统一控制 */
    }

    /* 顶部搜索栏 - 蓝色主题 */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: linear-gradient(135deg, #1976D2 0%, #0D47A1 100%);
      padding: 12px 16px;
      max-width: 428px;
      margin: 0 auto;
    }

    .search-bar {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .back-btn {
      color: white;
      font-size: 20px;
      padding: 8px;
      cursor: pointer;
    }

    .search-input-wrap {
      flex: 1;
      display: flex;
      align-items: center;
      background: white;
      border-radius: 20px;
      padding: 0 16px;
      height: 40px;
    }

    .search-input-wrap input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 14px;
      background: transparent;
    }

    .search-input-wrap .search-icon {
      color: #9E9E9E;
      margin-right: 8px;
    }

    .search-input-wrap .clear-btn {
      color: #9E9E9E;
      cursor: pointer;
      display: none;
    }

    .search-input-wrap .clear-btn.show {
      display: block;
    }

    /* 筛选工具栏 */
    .filter-toolbar {
      position: fixed;
      top: 64px;
      left: 0;
      right: 0;
      z-index: 99;
      background: white;
      border-bottom: 1px solid #E0E0E0;
      max-width: 428px;
      margin: 0 auto;
    }

    .filter-tabs {
      display: flex;
      height: 44px;
    }

    .filter-tab {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 14px;
      color: #616161;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .filter-tab.active {
      color: #1976D2;
      border-bottom-color: #1976D2;
    }

    .filter-tab .arrow {
      font-size: 10px;
      transition: transform 0.2s;
    }

    .filter-tab.active .arrow {
      transform: rotate(180deg);
    }

    /* 快捷筛选条 */
    .quick-filters {
      display: flex;
      gap: 8px;
      padding: 8px 16px;
      overflow-x: auto;
      background: #FAFAFA;
    }

    .quick-filters::-webkit-scrollbar {
      display: none;
    }

    .quick-filter-tag {
      flex-shrink: 0;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      background: white;
      color: #616161;
      border: 1px solid #E0E0E0;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-filter-tag.active {
      background: #E3F2FD;
      color: #1976D2;
      border-color: #1976D2;
    }

    /* 筛选下拉面板 */
    .filter-dropdown {
      position: fixed;
      top: 108px;
      left: 0;
      right: 0;
      background: white;
      z-index: 98;
      max-height: 60vh;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .filter-dropdown.show {
      display: block;
    }

    .filter-dropdown-mask {
      position: fixed;
      top: 108px;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 97;
      display: none;
    }

    .filter-dropdown-mask.show {
      display: block;
    }

    .filter-section {
      padding: 16px;
      border-bottom: 1px solid #F0F0F0;
    }

    .filter-section:last-child {
      border-bottom: none;
    }

    .filter-section-title {
      font-size: 13px;
      color: #9E9E9E;
      margin-bottom: 12px;
    }

    .filter-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .filter-option {
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 13px;
      background: #F5F5F5;
      color: #424242;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-option.active {
      background: #1976D2;
      color: white;
    }

    .filter-actions {
      display: flex;
      gap: 12px;
      padding: 16px;
      border-top: 1px solid #E0E0E0;
    }

    .filter-actions button {
      flex: 1;
      height: 44px;
      border-radius: 22px;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-actions .reset-btn {
      background: #F5F5F5;
      border: none;
      color: #616161;
    }

    .filter-actions .confirm-btn {
      background: #1976D2;
      border: none;
      color: white;
    }

    /* 主内容区 */
    .main-content {
      margin-top: 152px;
      padding: 12px;
    }

    /* 结果统计 */
    .result-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 4px;
      font-size: 13px;
      color: #9E9E9E;
    }

    .result-stats .count {
      color: #1976D2;
      font-weight: 600;
    }

    .result-stats .sort-select {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #616161;
      cursor: pointer;
    }

    /* 列表卡片 */
    .equipment-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .equipment-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      display: flex;
      cursor: pointer;
      transition: all 0.2s;
    }

    .equipment-card:active {
      transform: scale(0.98);
    }

    .equipment-card-image {
      width: 120px;
      height: 120px;
      flex-shrink: 0;
      background: #E3F2FD;
      position: relative;
      overflow: hidden;
    }

    .equipment-card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .equipment-card-image .placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: #90CAF9;
    }

    .equipment-card-image .tag {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      color: white;
    }

    .equipment-card-image .tag.new {
      background: #4CAF50;
    }

    .equipment-card-image .tag.used {
      background: #FF9800;
    }

    .equipment-card-image .tag.video {
      background: #1976D2;
    }

    .equipment-card-info {
      flex: 1;
      padding: 12px;
      display: flex;
      flex-direction: column;
    }

    .equipment-card-title {
      font-size: 15px;
      font-weight: 600;
      color: #212121;
      margin-bottom: 6px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .equipment-card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 8px;
    }

    .equipment-card-tags span {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      background: #F5F5F5;
      color: #757575;
    }

    .equipment-card-specs {
      font-size: 12px;
      color: #9E9E9E;
      margin-bottom: 8px;
    }

    .equipment-card-bottom {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-top: auto;
    }

    .equipment-card-price {
      font-size: 18px;
      font-weight: 700;
      color: #E53935;
    }

    .equipment-card-price .unit {
      font-size: 12px;
      font-weight: 400;
    }

    .equipment-card-location {
      font-size: 11px;
      color: #9E9E9E;
    }

    /* 加载更多 */
    .load-more {
      text-align: center;
      padding: 20px;
      color: #9E9E9E;
      font-size: 13px;
    }

    .load-more.loading::after {
      content: '...';
      animation: dots 1s infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    /* 空状态 */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-state .icon {
      font-size: 64px;
      margin-bottom: 16px;
      color: #BDBDBD;
    }

    .empty-state .title {
      font-size: 16px;
      color: #424242;
      margin-bottom: 8px;
    }

    .empty-state .desc {
      font-size: 14px;
      color: #9E9E9E;
    }

    /* 浮动按钮 */
    .fab-filter {
      position: fixed;
      right: max(16px, calc(50% - 198px));
      bottom: 90px;
      width: 48px;
      height: 48px;
      background: #1976D2;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
      cursor: pointer;
      z-index: 90;
    }

    .fab-filter .badge {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 18px;
      height: 18px;
      background: #E53935;
      border-radius: 50%;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      display: none;
    }

    .fab-filter .badge.show {
      display: flex;
    }

    /* Toast */
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.75);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .toast.show {
      opacity: 1;
    }

    /* MDI 图标标准化 */
    .mdi {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      vertical-align: middle;
      line-height: 1;
    }

    .nav-item .icon,
    .nav-icon {
      display: flex !important;
      align-items: center;
      justify-content: center;
    }

    .nav-item .mdi,
    .nav-icon .mdi {
      width: 100%;
      height: 100%;
      font-size: inherit;
    }

    .search-icon,
    .clear-btn {
      display: flex;
      align-items: center;
    }
  </style>
</head>

<body class="theme-blue has-bottom-nav">
  <!-- 顶部搜索栏 -->
  <header class="header">
    <div class="search-bar">
      <div class="back-btn" onclick="goBack()"><i class="mdi mdi-arrow-left"></i></div>
      <div class="search-input-wrap">
        <span class="search-icon"><i class="mdi mdi-magnify"></i></span>
        <input type="text" id="searchInput" placeholder="搜索设备名称、品牌、型号">
        <span class="clear-btn" id="clearSearchBtn" onclick="clearSearch()"><i class="mdi mdi-close"></i></span>
      </div>
    </div>
  </header>

  <!-- 筛选工具栏 -->
  <div class="filter-toolbar">
    <div class="filter-tabs">
      <div class="filter-tab" data-filter="type" onclick="toggleFilter('type')">
        <span>类型</span>
        <span class="arrow"><i class="mdi mdi-menu-down"></i></span>
      </div>
      <div class="filter-tab" data-filter="price" onclick="toggleFilter('price')">
        <span>价格</span>
        <span class="arrow"><i class="mdi mdi-menu-down"></i></span>
      </div>
      <div class="filter-tab" data-filter="condition" onclick="toggleFilter('condition')">
        <span>新旧</span>
        <span class="arrow"><i class="mdi mdi-menu-down"></i></span>
      </div>
      <div class="filter-tab" data-filter="more" onclick="toggleFilter('more')">
        <span>更多</span>
        <span class="arrow"><i class="mdi mdi-menu-down"></i></span>
      </div>
    </div>
    <div class="quick-filters" id="quickFilters">
      <!-- 快捷筛选标签动态生成 -->
    </div>
  </div>

  <!-- 筛选下拉面板 -->
  <div class="filter-dropdown-mask" id="filterMask" onclick="closeFilterDropdown()"></div>
  <div class="filter-dropdown" id="filterDropdown">
    <!-- 设备类型筛选 -->
    <div id="typeFilter" class="filter-panel" style="display: none;">
      <div class="filter-section">
        <div class="filter-section-title">设备类型</div>
        <div class="filter-options" id="typeOptions">
          <!-- 动态生成 -->
        </div>
      </div>
      <div class="filter-actions">
        <button class="reset-btn" onclick="resetFilter('type')">重置</button>
        <button class="confirm-btn" onclick="confirmFilter('type')">确定</button>
      </div>
    </div>

    <!-- 价格筛选 -->
    <div id="priceFilter" class="filter-panel" style="display: none;">
      <div class="filter-section">
        <div class="filter-section-title">价格区间</div>
        <div class="filter-options">
          <div class="filter-option" data-value="0-1000" onclick="selectPrice(this)">1000以下</div>
          <div class="filter-option" data-value="1000-5000" onclick="selectPrice(this)">1000-5000</div>
          <div class="filter-option" data-value="5000-20000" onclick="selectPrice(this)">5000-2万</div>
          <div class="filter-option" data-value="20000-100000" onclick="selectPrice(this)">2万-10万</div>
          <div class="filter-option" data-value="100000-0" onclick="selectPrice(this)">10万以上</div>
        </div>
      </div>
      <div class="filter-actions">
        <button class="reset-btn" onclick="resetFilter('price')">重置</button>
        <button class="confirm-btn" onclick="confirmFilter('price')">确定</button>
      </div>
    </div>

    <!-- 新旧筛选 -->
    <div id="conditionFilter" class="filter-panel" style="display: none;">
      <div class="filter-section">
        <div class="filter-section-title">设备状态</div>
        <div class="filter-options">
          <div class="filter-option active" data-value="" onclick="selectCondition(this)">全部</div>
          <div class="filter-option" data-value="全新" onclick="selectCondition(this)">全新</div>
          <div class="filter-option" data-value="二手" onclick="selectCondition(this)">二手</div>
          <div class="filter-option" data-value="9成新" onclick="selectCondition(this)">9成新</div>
        </div>
      </div>
      <div class="filter-actions">
        <button class="reset-btn" onclick="resetFilter('condition')">重置</button>
        <button class="confirm-btn" onclick="confirmFilter('condition')">确定</button>
      </div>
    </div>

    <!-- 更多筛选 -->
    <div id="moreFilter" class="filter-panel" style="display: none;">
      <div class="filter-section">
        <div class="filter-section-title">所在地区</div>
        <div class="filter-options" id="regionOptions">
          <!-- 动态生成 -->
        </div>
      </div>
      <div class="filter-section">
        <div class="filter-section-title">品牌</div>
        <div class="filter-options">
          <div class="filter-option" data-value="" onclick="selectBrand(this)">不限</div>
          <div class="filter-option" data-value="牧康" onclick="selectBrand(this)">牧康</div>
          <div class="filter-option" data-value="德隆" onclick="selectBrand(this)">德隆</div>
          <div class="filter-option" data-value="金牧" onclick="selectBrand(this)">金牧</div>
          <div class="filter-option" data-value="其他" onclick="selectBrand(this)">其他</div>
        </div>
      </div>
      <div class="filter-actions">
        <button class="reset-btn" onclick="resetFilter('more')">重置</button>
        <button class="confirm-btn" onclick="confirmFilter('more')">确定</button>
      </div>
    </div>
  </div>

  <!-- 主内容区 -->
  <div class="main-content">
    <!-- 结果统计 -->
    <div class="result-stats">
      <span>共 <span class="count" id="resultCount">0</span> 件设备</span>
      <div class="sort-select" onclick="toggleSortMenu()">
        <span id="currentSort">最新发布</span>
        <span><i class="mdi mdi-menu-down"></i></span>
      </div>
    </div>

    <!-- 列表 -->
    <div class="equipment-list" id="equipmentList">
      <!-- 动态生成 -->
    </div>

    <!-- 加载更多 -->
    <div class="load-more" id="loadMore">下拉加载更多</div>
  </div>

  <!-- 筛选浮动按钮 -->
  <div class="fab-filter" onclick="openFullFilter()">
    <span><i class="mdi mdi-filter-variant"></i></span>
    <span class="badge" id="filterBadge">0</span>
  </div>

  <!-- 底部导航 -->
  <nav class="bottom-nav">
    <a href="../home/home.html" class="nav-item">
      <span class="nav-icon mdi mdi-home"></span>
      <span>首页</span>
    </a>
    <a href="../cattle/publish.html" class="nav-item">
      <span class="nav-icon mdi mdi-plus-circle"></span>
      <span>发布</span>
    </a>
    <a href="../ai-rag/chat.html" class="nav-item">
      <span class="nav-icon mdi mdi-robot"></span>
      <span>AI</span>
    </a>
    <a href="../enterprise/messages.html" class="nav-item">
      <span class="nav-icon mdi mdi-bell"></span>
      <span>消息</span>
    </a>
    <a href="../enterprise/center.html" class="nav-item">
      <span class="nav-icon mdi mdi-account"></span>
      <span>我的</span>
    </a>
  </nav>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- JS 框架 -->
  <script src="../../assets/js/utils.js"></script>
  <script src="../../assets/js/stateManager.js"></script>
  <script src="../../assets/js/dictionaries.js"></script>
  <script src="../../assets/js/mockData.js"></script>

  <script>
    // 消息提示
    function showMessage() {
      alert('消息功能开发中...');
    }

    // ==================== 状态管理 ====================
    const filterState = {
      equipmentType: null,
      priceRange: null,
      condition: null,
      region: null,
      brand: null,
      keyword: '',
      sort: 'latest' // latest, price_asc, price_desc
    };

    let currentPage = 1;
    const pageSize = 10;
    let isLoading = false;
    let hasMore = true;
    let allListings = [];

    // ==================== 初始化 ====================
    document.addEventListener('DOMContentLoaded', function () {
      initFilters();
      initQuickFilters();
      initSearch();
      loadListings();
    });

    // 初始化筛选选项
    function initFilters() {
      // 设备类型选项
      const typeOptions = document.getElementById('typeOptions');
      typeOptions.innerHTML = '<div class="filter-option active" data-value="" onclick="selectType(this)">全部</div>';

      Dictionaries.EQUIPMENT_TYPES.forEach(t => {
        const opt = document.createElement('div');
        opt.className = 'filter-option';
        opt.dataset.value = t.code;
        opt.textContent = t.name;
        opt.onclick = function () { selectType(this); };
        typeOptions.appendChild(opt);
      });

      // 地区选项
      const regionOptions = document.getElementById('regionOptions');
      regionOptions.innerHTML = '<div class="filter-option active" data-value="" onclick="selectRegion(this)">全国</div>';

      const provinces = Dictionaries.getProvinces();
      provinces.slice(0, 8).forEach(p => {
        const opt = document.createElement('div');
        opt.className = 'filter-option';
        opt.dataset.value = p;
        opt.textContent = p;
        opt.onclick = function () { selectRegion(this); };
        regionOptions.appendChild(opt);
      });
    }

    // 初始化快捷筛选
    function initQuickFilters() {
      const quickFilters = document.getElementById('quickFilters');
      const hotTags = ['饲料加工', '养殖设备', '冷链设备', 'TMR搅拌车', '饮水器', '全新'];

      hotTags.forEach(tag => {
        const el = document.createElement('div');
        el.className = 'quick-filter-tag';
        el.textContent = tag;
        el.onclick = function () { applyQuickFilter(this, tag); };
        quickFilters.appendChild(el);
      });
    }

    // 初始化搜索
    function initSearch() {
      const searchInput = document.getElementById('searchInput');
      const clearBtn = document.getElementById('clearSearchBtn');

      searchInput.addEventListener('input', function () {
        clearBtn.classList.toggle('show', this.value.length > 0);
      });

      searchInput.addEventListener('keyup', function (e) {
        if (e.key === 'Enter') {
          filterState.keyword = this.value.trim();
          currentPage = 1;
          loadListings();
        }
      });
    }

    // ==================== 筛选相关 ====================
    let activeFilter = null;

    function toggleFilter(type) {
      const tabs = document.querySelectorAll('.filter-tab');
      const dropdown = document.getElementById('filterDropdown');
      const mask = document.getElementById('filterMask');
      const panels = document.querySelectorAll('.filter-panel');

      if (activeFilter === type) {
        closeFilterDropdown();
        return;
      }

      // 隐藏所有面板
      panels.forEach(p => p.style.display = 'none');

      // 显示当前面板
      document.getElementById(type + 'Filter').style.display = 'block';

      // 更新tab状态
      tabs.forEach(t => t.classList.remove('active'));
      document.querySelector(`.filter-tab[data-filter="${type}"]`).classList.add('active');

      dropdown.classList.add('show');
      mask.classList.add('show');
      activeFilter = type;
    }

    function closeFilterDropdown() {
      const tabs = document.querySelectorAll('.filter-tab');
      const dropdown = document.getElementById('filterDropdown');
      const mask = document.getElementById('filterMask');

      tabs.forEach(t => t.classList.remove('active'));
      dropdown.classList.remove('show');
      mask.classList.remove('show');
      activeFilter = null;
    }

    function selectType(el) {
      const options = el.parentElement.querySelectorAll('.filter-option');
      options.forEach(o => o.classList.remove('active'));
      el.classList.add('active');
      filterState.equipmentType = el.dataset.value || null;
    }

    function selectPrice(el) {
      const options = el.parentElement.querySelectorAll('.filter-option');
      options.forEach(o => o.classList.remove('active'));
      el.classList.add('active');
      filterState.priceRange = el.dataset.value;
    }

    function selectCondition(el) {
      const options = el.parentElement.querySelectorAll('.filter-option');
      options.forEach(o => o.classList.remove('active'));
      el.classList.add('active');
      filterState.condition = el.dataset.value || null;
    }

    function selectRegion(el) {
      const options = el.parentElement.querySelectorAll('.filter-option');
      options.forEach(o => o.classList.remove('active'));
      el.classList.add('active');
      filterState.region = el.dataset.value || null;
    }

    function selectBrand(el) {
      const options = el.parentElement.querySelectorAll('.filter-option');
      options.forEach(o => o.classList.remove('active'));
      el.classList.add('active');
      filterState.brand = el.dataset.value || null;
    }

    function resetFilter(type) {
      switch (type) {
        case 'type':
          filterState.equipmentType = null;
          document.querySelectorAll('#typeOptions .filter-option').forEach((o, i) => {
            o.classList.toggle('active', i === 0);
          });
          break;
        case 'price':
          filterState.priceRange = null;
          document.querySelectorAll('#priceFilter .filter-option').forEach(o => {
            o.classList.remove('active');
          });
          break;
        case 'condition':
          filterState.condition = null;
          document.querySelectorAll('#conditionFilter .filter-option').forEach((o, i) => {
            o.classList.toggle('active', i === 0);
          });
          break;
        case 'more':
          filterState.region = null;
          filterState.brand = null;
          document.querySelectorAll('#moreFilter .filter-option').forEach(o => {
            o.classList.remove('active');
          });
          document.querySelectorAll('#regionOptions .filter-option').forEach((o, i) => {
            o.classList.toggle('active', i === 0);
          });
          break;
      }
    }

    function confirmFilter(type) {
      closeFilterDropdown();
      currentPage = 1;
      loadListings();
      updateFilterBadge();
    }

    function applyQuickFilter(el, tag) {
      // 切换状态
      el.classList.toggle('active');

      // 简单处理：添加到关键词
      if (el.classList.contains('active')) {
        filterState.keyword = tag;
        document.getElementById('searchInput').value = tag;
      } else {
        filterState.keyword = '';
        document.getElementById('searchInput').value = '';
      }

      // 取消其他快捷标签
      document.querySelectorAll('.quick-filter-tag').forEach(t => {
        if (t !== el) t.classList.remove('active');
      });

      currentPage = 1;
      loadListings();
    }

    function updateFilterBadge() {
      let count = 0;
      if (filterState.equipmentType) count++;
      if (filterState.priceRange) count++;
      if (filterState.condition) count++;
      if (filterState.region || filterState.brand) count++;

      const badge = document.getElementById('filterBadge');
      badge.textContent = count;
      badge.classList.toggle('show', count > 0);
    }

    // ==================== 数据加载 ====================
    function loadListings() {
      if (isLoading) return;
      isLoading = true;

      const loadMore = document.getElementById('loadMore');
      loadMore.textContent = '加载中';
      loadMore.classList.add('loading');

      // 模拟网络延迟
      setTimeout(() => {
        // 获取设备数据
        let data = [...MockData.EQUIPMENT_LISTINGS];

        // 设备类型筛选
        if (filterState.equipmentType) {
          data = data.filter(item => item.equipmentType === filterState.equipmentType);
        }

        // 价格筛选
        if (filterState.priceRange) {
          const [min, max] = filterState.priceRange.split('-').map(Number);
          data = data.filter(item => {
            if (max === 0) return item.price >= min;
            if (min === 0) return item.price <= max;
            return item.price >= min && item.price <= max;
          });
        }

        // 新旧筛选
        if (filterState.condition) {
          data = data.filter(item => item.condition === filterState.condition);
        }

        // 地区筛选
        if (filterState.region) {
          data = data.filter(item => item.location && item.location.province === filterState.region);
        }

        // 品牌筛选
        if (filterState.brand) {
          data = data.filter(item => item.brand === filterState.brand);
        }

        // 关键词搜索
        if (filterState.keyword) {
          const keyword = filterState.keyword.toLowerCase();
          data = data.filter(item =>
            item.title.toLowerCase().includes(keyword) ||
            item.description.toLowerCase().includes(keyword) ||
            item.brand.toLowerCase().includes(keyword) ||
            (item.model && item.model.toLowerCase().includes(keyword))
          );
        }

        // 排序
        switch (filterState.sort) {
          case 'price_asc':
            data.sort((a, b) => a.price - b.price);
            break;
          case 'price_desc':
            data.sort((a, b) => b.price - a.price);
            break;
          default:
            data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        }

        allListings = data;

        // 分页
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageData = data.slice(0, end);

        hasMore = end < data.length;

        renderListings(pageData, currentPage === 1);

        document.getElementById('resultCount').textContent = data.length;

        loadMore.textContent = hasMore ? '下拉加载更多' : '没有更多了';
        loadMore.classList.remove('loading');
        isLoading = false;
      }, 500);
    }

    function renderListings(data, replace = false) {
      const container = document.getElementById('equipmentList');

      if (replace) {
        container.innerHTML = '';
      }

      if (data.length === 0 && replace) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon"><i class="mdi mdi-cog-off-outline"></i></div>
            <div class="title">暂无符合条件的设备</div>
            <div class="desc">试试调整筛选条件</div>
          </div>
        `;
        return;
      }

      data.forEach(item => {
        const card = document.createElement('div');
        card.className = 'equipment-card';
        card.onclick = () => goToDetail(item.id);

        // 标签 - 基于 condition 和 video 判断
        let tagHtml = '';
        if (item.condition === '全新') {
          tagHtml = '<span class="tag new">全新</span>';
        } else if (item.condition === '二手' || item.condition === '9成新') {
          tagHtml = '<span class="tag used">' + item.condition + '</span>';
        }
        if (item.video) {
          tagHtml += '<span class="tag video" style="left:auto;right:8px;">视频</span>';
        }

        // 设备类型名称
        const typeInfo = Dictionaries.EQUIPMENT_TYPES.find(t => t.code === item.equipmentType);
        const typeName = typeInfo ? typeInfo.name : item.equipmentType;

        // 位置
        const locationText = item.location
          ? `${item.location.province} ${item.location.city}`
          : '';

        card.innerHTML = `
          <div class="equipment-card-image">
            <div class="placeholder"><i class="mdi mdi-cog"></i></div>
            ${tagHtml}
          </div>
          <div class="equipment-card-info">
            <div class="equipment-card-title">${item.title}</div>
            <div class="equipment-card-tags">
              <span>${typeName}</span>
              <span>${item.brand}</span>
              ${item.warranty ? '<span>' + item.warranty + '</span>' : ''}
            </div>
            <div class="equipment-card-specs">型号: ${item.model || '-'}</div>
            <div class="equipment-card-bottom">
              <div class="equipment-card-price">${formatPrice(item.price)}<span class="unit">${item.priceUnit}</span></div>
              <div class="equipment-card-location">${locationText}</div>
            </div>
          </div>
        `;

        container.appendChild(card);
      });
    }

    // 格式化价格
    function formatPrice(price) {
      if (price >= 10000) {
        return (price / 10000).toFixed(1) + '万';
      }
      return price.toLocaleString();
    }

    // ==================== 排序 ====================
    function toggleSortMenu() {
      const sortOptions = ['最新发布', '价格最低', '价格最高'];
      const sortValues = ['latest', 'price_asc', 'price_desc'];

      // 简单实现：循环切换
      const current = sortValues.indexOf(filterState.sort);
      const next = (current + 1) % sortValues.length;

      filterState.sort = sortValues[next];
      document.getElementById('currentSort').textContent = sortOptions[next];

      currentPage = 1;
      loadListings();
    }

    // ==================== 工具函数 ====================
    function goBack() {
      window.history.back();
    }

    function goToDetail(id) {
      window.location.href = `detail.html?id=${id}`;
    }

    function clearSearch() {
      const searchInput = document.getElementById('searchInput');
      searchInput.value = '';
      document.getElementById('clearSearchBtn').classList.remove('show');
      filterState.keyword = '';
      currentPage = 1;
      loadListings();
    }

    function openFullFilter() {
      toggleFilter('more');
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    // 滚动加载更多
    window.addEventListener('scroll', function () {
      if (isLoading || !hasMore) return;

      const loadMore = document.getElementById('loadMore');
      const rect = loadMore.getBoundingClientRect();

      if (rect.top < window.innerHeight + 100) {
        currentPage++;
        loadListings();
      }
    });
  </script>
</body>

</html>
