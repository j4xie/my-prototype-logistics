<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>发布活牛 - 中国牛产业数智云平台</title>
  <link rel="stylesheet" href="../../assets/css/variables.css">
  <link rel="stylesheet" href="../../assets/css/mobile.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background: #F5F5F5;
      min-height: 100vh;
      padding-bottom: 80px;
    }

    /* 顶部导航 */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      height: 48px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
      max-width: 428px;
      margin: 0 auto;
    }

    .header-back {
      font-size: 20px;
      color: #424242;
      cursor: pointer;
      padding: 8px;
    }

    .header-title {
      font-size: 17px;
      font-weight: 600;
      color: #212121;
    }

    .header-draft {
      font-size: 14px;
      color: #2E7D32;
      cursor: pointer;
    }

    /* 主内容 */
    .main-content {
      margin-top: 48px;
      padding: 12px;
    }

    /* 表单卡片 */
    .form-card {
      background: white;
      border-radius: 12px;
      margin-bottom: 12px;
      overflow: hidden;
    }

    .form-card-title {
      font-size: 16px;
      font-weight: 600;
      color: #212121;
      padding: 16px;
      border-bottom: 1px solid #F0F0F0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-card-title .required {
      font-size: 12px;
      color: #E53935;
    }

    .form-card-body {
      padding: 16px;
    }

    /* 图片上传区 */
    .image-upload-area {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .image-upload-item {
      width: 100px;
      height: 100px;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    .image-upload-btn {
      width: 100%;
      height: 100%;
      background: #F5F5F5;
      border: 1px dashed #BDBDBD;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .image-upload-btn:hover {
      border-color: #2E7D32;
      background: #E8F5E9;
    }

    .image-upload-btn .icon {
      font-size: 28px;
      color: #9E9E9E;
      margin-bottom: 4px;
    }

    .image-upload-btn span {
      font-size: 12px;
      color: #9E9E9E;
    }

    .image-preview {
      width: 100%;
      height: 100%;
      background: #E8F5E9;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-preview .placeholder {
      font-size: 40px;
      color: #A5D6A7;
    }

    .image-preview .remove-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 20px;
      height: 20px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      color: white;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .image-upload-tip {
      width: 100%;
      font-size: 12px;
      color: #9E9E9E;
      margin-top: 8px;
    }

    /* 视频上传 */
    .video-upload-area {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #F0F0F0;
    }

    .video-upload-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: #F5F5F5;
      border-radius: 8px;
      cursor: pointer;
    }

    .video-upload-btn .icon {
      font-size: 24px;
      color: #1976D2;
    }

    .video-upload-btn .text h4 {
      font-size: 14px;
      color: #424242;
      margin-bottom: 4px;
    }

    .video-upload-btn .text p {
      font-size: 12px;
      color: #9E9E9E;
    }

    /* 表单项 */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 14px;
      color: #424242;
      margin-bottom: 8px;
    }

    .form-label .required {
      color: #E53935;
      margin-left: 4px;
    }

    .form-input {
      width: 100%;
      height: 44px;
      border: 1px solid #E0E0E0;
      border-radius: 8px;
      padding: 0 12px;
      font-size: 15px;
      color: #212121;
      transition: border-color 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #2E7D32;
    }

    .form-input::placeholder {
      color: #BDBDBD;
    }

    .form-textarea {
      width: 100%;
      min-height: 120px;
      border: 1px solid #E0E0E0;
      border-radius: 8px;
      padding: 12px;
      font-size: 15px;
      color: #212121;
      resize: vertical;
      transition: border-color 0.2s;
    }

    .form-textarea:focus {
      outline: none;
      border-color: #2E7D32;
    }

    .form-input-group {
      display: flex;
      align-items: center;
    }

    .form-input-group .form-input {
      border-radius: 8px 0 0 8px;
      border-right: none;
    }

    .form-input-group .unit {
      height: 44px;
      padding: 0 16px;
      background: #F5F5F5;
      border: 1px solid #E0E0E0;
      border-left: none;
      border-radius: 0 8px 8px 0;
      display: flex;
      align-items: center;
      font-size: 14px;
      color: #757575;
    }

    /* 选择器 */
    .form-select {
      width: 100%;
      height: 44px;
      border: 1px solid #E0E0E0;
      border-radius: 8px;
      padding: 0 12px;
      font-size: 15px;
      color: #212121;
      background: white;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23757575' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }

    .form-select:focus {
      outline: none;
      border-color: #2E7D32;
    }

    /* 双列布局 */
    .form-row {
      display: flex;
      gap: 12px;
    }

    .form-row .form-group {
      flex: 1;
    }

    /* 选择器网格 */
    .select-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .select-grid-item {
      padding: 10px;
      border: 1px solid #E0E0E0;
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
      color: #424242;
      cursor: pointer;
      transition: all 0.2s;
    }

    .select-grid-item.active {
      border-color: #2E7D32;
      background: #E8F5E9;
      color: #2E7D32;
    }

    /* 复选框组 */
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .checkbox-item input {
      display: none;
    }

    .checkbox-item .checkbox-icon {
      width: 20px;
      height: 20px;
      border: 2px solid #BDBDBD;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: transparent;
      transition: all 0.2s;
    }

    .checkbox-item input:checked+.checkbox-icon {
      border-color: #2E7D32;
      background: #2E7D32;
      color: white;
    }

    .checkbox-item span {
      font-size: 14px;
      color: #424242;
    }

    /* 开关 */
    .switch-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #F0F0F0;
    }

    .switch-row:last-child {
      border-bottom: none;
    }

    .switch-label {
      font-size: 14px;
      color: #424242;
    }

    .switch {
      width: 48px;
      height: 28px;
      background: #E0E0E0;
      border-radius: 14px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }

    .switch.active {
      background: #2E7D32;
    }

    .switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .switch.active::after {
      transform: translateX(20px);
    }

    /* 地区选择 */
    .location-select {
      display: flex;
      gap: 8px;
    }

    .location-select select {
      flex: 1;
    }

    /* 提示信息 */
    .form-tip {
      font-size: 12px;
      color: #9E9E9E;
      margin-top: 8px;
    }

    .form-error {
      font-size: 12px;
      color: #E53935;
      margin-top: 8px;
      display: none;
    }

    .form-group.error .form-input,
    .form-group.error .form-select,
    .form-group.error .form-textarea {
      border-color: #E53935;
    }

    .form-group.error .form-error {
      display: block;
    }

    /* 底部操作 */
    .bottom-action {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 428px;
      height: 72px;
      background: white;
      display: flex;
      align-items: center;
      padding: 12px 16px;
      gap: 12px;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.08);
      z-index: 100;
    }

    .bottom-action .preview-btn {
      width: 100px;
      height: 48px;
      border-radius: 24px;
      background: #F5F5F5;
      border: none;
      font-size: 15px;
      color: #424242;
      cursor: pointer;
    }

    .bottom-action .submit-btn {
      flex: 1;
      height: 48px;
      border-radius: 24px;
      background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
      border: none;
      font-size: 16px;
      font-weight: 500;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .bottom-action .submit-btn:disabled {
      background: #BDBDBD;
      cursor: not-allowed;
    }

    .bottom-action .submit-btn.loading {
      pointer-events: none;
    }

    /* 字数统计 */
    .char-count {
      text-align: right;
      font-size: 12px;
      color: #9E9E9E;
      margin-top: 4px;
    }

    /* 成功弹窗 */
    .success-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 300;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .success-modal.show {
      opacity: 1;
      pointer-events: auto;
    }

    .success-modal-content {
      background: white;
      border-radius: 16px;
      width: 85%;
      max-width: 320px;
      padding: 32px 24px;
      text-align: center;
    }

    .success-modal .icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .success-modal h3 {
      font-size: 20px;
      color: #212121;
      margin-bottom: 8px;
    }

    .success-modal p {
      font-size: 14px;
      color: #757575;
      margin-bottom: 24px;
    }

    .success-modal .btns {
      display: flex;
      gap: 12px;
    }

    .success-modal .btns button {
      flex: 1;
      height: 44px;
      border-radius: 22px;
      font-size: 15px;
      border: none;
      cursor: pointer;
    }

    .success-modal .btns .secondary {
      background: #F5F5F5;
      color: #424242;
    }

    .success-modal .btns .primary {
      background: #2E7D32;
      color: white;
    }

    /* Toast */
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.75);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .toast.show {
      opacity: 1;
    }

    /* ==================== MDI 图标标准化 ==================== */
    .mdi {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      vertical-align: middle;
      line-height: 1;
    }

    .header-back {
      display: flex !important;
      align-items: center;
      justify-content: center;
    }

    .image-preview .remove-btn {
      display: flex !important;
      align-items: center;
      justify-content: center;
    }

    .success-modal .icon {
      display: flex !important;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>

<body>
  <!-- 顶部导航 -->
  <header class="header">
    <div class="header-back" onclick="goBack()"><i class="mdi mdi-arrow-left"></i></div>
    <div class="header-title">发布活牛</div>
    <div class="header-draft" onclick="saveDraft()">存草稿</div>
  </header>

  <!-- 主内容 -->
  <div class="main-content">
    <!-- 图片/视频上传 -->
    <div class="form-card">
      <div class="form-card-title">
        <span>图片/视频</span>
        <span class="required">* 必填</span>
      </div>
      <div class="form-card-body">
        <div class="image-upload-area" id="imageUploadArea">
          <div class="image-upload-item">
            <div class="image-upload-btn" onclick="uploadImage()">
              <span class="icon"><i class="mdi mdi-plus"></i></span>
              <span>添加图片</span>
            </div>
          </div>
        </div>
        <div class="image-upload-tip">建议上传3-9张高清图片，第一张为封面图</div>

        <div class="video-upload-area">
          <div class="video-upload-btn" onclick="uploadVideo()">
            <span class="icon"><i class="mdi mdi-play-circle-outline"></i></span>
            <div class="text">
              <h4>添加视频</h4>
              <p>上传视频可提高50%曝光率</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 基本信息 -->
    <div class="form-card">
      <div class="form-card-title">
        <span>基本信息</span>
      </div>
      <div class="form-card-body">
        <div class="form-group">
          <label class="form-label">标题<span class="required">*</span></label>
          <input type="text" class="form-input" id="title" placeholder="例：西门塔尔育肥牛 800-1200斤 50头" maxlength="50">
          <div class="char-count"><span id="titleCount">0</span>/50</div>
          <div class="form-error">请输入标题</div>
        </div>

        <div class="form-group">
          <label class="form-label">品种<span class="required">*</span></label>
          <select class="form-select" id="breed">
            <option value="">请选择品种</option>
          </select>
          <div class="form-error">请选择品种</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">数量<span class="required">*</span></label>
            <div class="form-input-group">
              <input type="number" class="form-input" id="quantity" placeholder="输入数量">
              <span class="unit">头</span>
            </div>
            <div class="form-error">请输入数量</div>
          </div>
          <div class="form-group">
            <label class="form-label">体重<span class="required">*</span></label>
            <div class="form-input-group">
              <input type="number" class="form-input" id="weight" placeholder="平均体重">
              <span class="unit">斤</span>
            </div>
            <div class="form-error">请输入体重</div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">月龄<span class="required">*</span></label>
            <div class="form-input-group">
              <input type="number" class="form-input" id="ageMonths" placeholder="平均月龄">
              <span class="unit">月</span>
            </div>
            <div class="form-error">请输入月龄</div>
          </div>
          <div class="form-group">
            <label class="form-label">性别<span class="required">*</span></label>
            <select class="form-select" id="gender">
              <option value="">请选择</option>
              <option value="male">公牛</option>
              <option value="female">母牛</option>
              <option value="mixed">公母混合</option>
            </select>
            <div class="form-error">请选择性别</div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">用途</label>
          <div class="select-grid" id="purposeGrid">
            <div class="select-grid-item active" data-value="fattening">育肥</div>
            <div class="select-grid-item" data-value="breeding">繁殖</div>
            <div class="select-grid-item" data-value="milking">产奶</div>
            <div class="select-grid-item" data-value="slaughter">屠宰</div>
            <div class="select-grid-item" data-value="calf">牛犊</div>
            <div class="select-grid-item" data-value="other">其他</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 价格信息 -->
    <div class="form-card">
      <div class="form-card-title">
        <span>价格信息</span>
      </div>
      <div class="form-card-body">
        <div class="form-group">
          <label class="form-label">单价<span class="required">*</span></label>
          <div class="form-input-group">
            <input type="number" class="form-input" id="price" placeholder="输入每斤价格" step="0.1">
            <span class="unit">元/斤</span>
          </div>
          <div class="form-tip">设置合理的价格可以更快成交</div>
          <div class="form-error">请输入价格</div>
        </div>

        <div class="switch-row">
          <span class="switch-label">支持议价</span>
          <div class="switch active" id="negotiableSwitch" onclick="toggleSwitch(this)"></div>
        </div>

        <div class="switch-row">
          <span class="switch-label">可分批采购</span>
          <div class="switch" id="batchSwitch" onclick="toggleSwitch(this)"></div>
        </div>
      </div>
    </div>

    <!-- 所在地 -->
    <div class="form-card">
      <div class="form-card-title">
        <span>所在地</span>
      </div>
      <div class="form-card-body">
        <div class="form-group">
          <label class="form-label">地区<span class="required">*</span></label>
          <div class="location-select">
            <select class="form-select" id="province">
              <option value="">选择省份</option>
            </select>
            <select class="form-select" id="city">
              <option value="">选择城市</option>
            </select>
          </div>
          <div class="form-error">请选择所在地</div>
        </div>

        <div class="form-group">
          <label class="form-label">详细地址</label>
          <input type="text" class="form-input" id="address" placeholder="输入详细地址（选填）">
        </div>
      </div>
    </div>

    <!-- 详细描述 -->
    <div class="form-card">
      <div class="form-card-title">
        <span>详细描述</span>
      </div>
      <div class="form-card-body">
        <div class="form-group">
          <textarea class="form-textarea" id="description" placeholder="详细描述牛只情况，如饲养方式、健康状况、疫苗接种等"
            maxlength="500"></textarea>
          <div class="char-count"><span id="descCount">0</span>/500</div>
        </div>
      </div>
    </div>

    <!-- 质量保障 -->
    <div class="form-card">
      <div class="form-card-title">
        <span>质量保障</span>
      </div>
      <div class="form-card-body">
        <div class="checkbox-group">
          <label class="checkbox-item">
            <input type="checkbox" name="cert" value="quarantine" checked>
            <span class="checkbox-icon"><i class="mdi mdi-check" style="font-size: 14px;"></i></span>
            <span>检疫合格</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="cert" value="vaccine">
            <span class="checkbox-icon"><i class="mdi mdi-check" style="font-size: 14px;"></i></span>
            <span>已接种疫苗</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="cert" value="health">
            <span class="checkbox-icon"><i class="mdi mdi-check" style="font-size: 14px;"></i></span>
            <span>健康承诺</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="cert" value="breed">
            <span class="checkbox-icon"><i class="mdi mdi-check" style="font-size: 14px;"></i></span>
            <span>品种保真</span>
          </label>
        </div>

        <div class="switch-row" style="margin-top: 16px;">
          <span class="switch-label">支持视频验货</span>
          <div class="switch active" id="videoVerifySwitch" onclick="toggleSwitch(this)"></div>
        </div>
      </div>
    </div>

    <!-- 联系方式 -->
    <div class="form-card">
      <div class="form-card-title">
        <span>联系方式</span>
      </div>
      <div class="form-card-body">
        <div class="form-group">
          <label class="form-label">联系人</label>
          <input type="text" class="form-input" id="contactName" placeholder="输入联系人姓名">
        </div>

        <div class="form-group">
          <label class="form-label">联系电话<span class="required">*</span></label>
          <input type="tel" class="form-input" id="contactPhone" placeholder="输入手机号码">
          <div class="form-error">请输入联系电话</div>
        </div>

        <div class="switch-row">
          <span class="switch-label">显示微信号</span>
          <div class="switch" id="showWechatSwitch" onclick="toggleSwitch(this)"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 底部操作 -->
  <div class="bottom-action">
    <button class="preview-btn" onclick="previewPublish()">预览</button>
    <button class="submit-btn" id="submitBtn" onclick="submitPublish()">立即发布</button>
  </div>

  <!-- 成功弹窗 -->
  <div class="success-modal" id="successModal">
    <div class="success-modal-content">
      <div class="icon"><i class="mdi mdi-check-circle" style="color: #2E7D32;"></i></div>
      <h3>发布成功</h3>
      <p>您的信息已提交，审核通过后将展示</p>
      <div class="btns">
        <button class="secondary" onclick="continuePublish()">继续发布</button>
        <button class="primary" onclick="viewMyPublish()">查看发布</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- JS 框架 -->
  <script src="../../assets/js/utils.js"></script>
  <script src="../../assets/js/stateManager.js"></script>
  <script src="../../assets/js/dictionaries.js"></script>
  <script src="../../assets/js/mockData.js"></script>
  <script src="../../assets/js/formValidator.js"></script>

  <script>
    // ==================== 状态 ====================
    const formData = {
      images: [],
      video: null,
      title: '',
      breed: '',
      quantity: '',
      weight: '',
      ageMonths: '',
      gender: '',
      purpose: 'fattening',
      price: '',
      negotiable: true,
      batchPurchase: false,
      province: '',
      city: '',
      address: '',
      description: '',
      certs: ['quarantine'],
      videoVerify: true,
      contactName: '',
      contactPhone: '',
      showWechat: false
    };

    // ==================== 初始化 ====================
    document.addEventListener('DOMContentLoaded', function () {
      // 检查登录状态
      if (!globalState.get('auth.isLoggedIn')) {
        showToast('请先登录');
        setTimeout(() => {
          window.location.href = '../auth/login.html?redirect=' + encodeURIComponent(window.location.href);
        }, 1000);
        return;
      }

      initBreedSelect();
      initProvinceSelect();
      initPurposeGrid();
      initFormListeners();
      loadDraft();
      prefillUserInfo();
    });

    // 初始化品种选择
    function initBreedSelect() {
      const breedSelect = document.getElementById('breed');

      Dictionaries.CATTLE_BREEDS.forEach(breed => {
        const option = document.createElement('option');
        option.value = breed.code;
        option.textContent = breed.name;
        breedSelect.appendChild(option);
      });
    }

    // 初始化省份选择
    function initProvinceSelect() {
      const provinceSelect = document.getElementById('province');
      const citySelect = document.getElementById('city');
      const provinces = Dictionaries.getProvinces();

      provinces.forEach(p => {
        const option = document.createElement('option');
        option.value = p.code;
        option.textContent = p.name;
        provinceSelect.appendChild(option);
      });

      provinceSelect.addEventListener('change', function () {
        formData.province = this.value;
        formData.city = '';

        citySelect.innerHTML = '<option value="">选择城市</option>';

        if (this.value) {
          const cities = Dictionaries.getCitiesByProvince(this.value);
          cities.forEach(c => {
            const option = document.createElement('option');
            option.value = c.code;
            option.textContent = c.name;
            citySelect.appendChild(option);
          });
        }
      });

      citySelect.addEventListener('change', function () {
        formData.city = this.value;
      });
    }

    // 初始化用途网格
    function initPurposeGrid() {
      const grid = document.getElementById('purposeGrid');
      const items = grid.querySelectorAll('.select-grid-item');

      items.forEach(item => {
        item.addEventListener('click', function () {
          items.forEach(i => i.classList.remove('active'));
          this.classList.add('active');
          formData.purpose = this.dataset.value;
        });
      });
    }

    // 初始化表单监听
    function initFormListeners() {
      // 标题
      const titleInput = document.getElementById('title');
      const titleCount = document.getElementById('titleCount');
      titleInput.addEventListener('input', function () {
        formData.title = this.value;
        titleCount.textContent = this.value.length;
      });

      // 品种
      document.getElementById('breed').addEventListener('change', function () {
        formData.breed = this.value;
      });

      // 数量
      document.getElementById('quantity').addEventListener('input', function () {
        formData.quantity = this.value;
      });

      // 体重
      document.getElementById('weight').addEventListener('input', function () {
        formData.weight = this.value;
      });

      // 月龄
      document.getElementById('ageMonths').addEventListener('input', function () {
        formData.ageMonths = this.value;
      });

      // 性别
      document.getElementById('gender').addEventListener('change', function () {
        formData.gender = this.value;
      });

      // 价格
      document.getElementById('price').addEventListener('input', function () {
        formData.price = this.value;
      });

      // 描述
      const descInput = document.getElementById('description');
      const descCount = document.getElementById('descCount');
      descInput.addEventListener('input', function () {
        formData.description = this.value;
        descCount.textContent = this.value.length;
      });

      // 认证
      document.querySelectorAll('input[name="cert"]').forEach(cb => {
        cb.addEventListener('change', function () {
          if (this.checked) {
            if (!formData.certs.includes(this.value)) {
              formData.certs.push(this.value);
            }
          } else {
            formData.certs = formData.certs.filter(c => c !== this.value);
          }
        });
      });

      // 联系人
      document.getElementById('contactName').addEventListener('input', function () {
        formData.contactName = this.value;
      });

      // 联系电话
      document.getElementById('contactPhone').addEventListener('input', function () {
        formData.contactPhone = this.value;
      });

      // 地址
      document.getElementById('address').addEventListener('input', function () {
        formData.address = this.value;
      });
    }

    // 预填用户信息
    function prefillUserInfo() {
      const user = globalState.get('user');
      if (user) {
        if (user.contactName) {
          document.getElementById('contactName').value = user.contactName;
          formData.contactName = user.contactName;
        }
        if (user.phone) {
          document.getElementById('contactPhone').value = user.phone;
          formData.contactPhone = user.phone;
        }
      }
    }

    // ==================== 图片视频上传 ====================
    function uploadImage() {
      // 模拟上传
      if (formData.images.length >= 9) {
        showToast('最多上传9张图片');
        return;
      }

      // 添加模拟图片
      formData.images.push({ id: Date.now(), url: null });
      renderImages();
      showToast('图片已添加');
    }

    function removeImage(index) {
      formData.images.splice(index, 1);
      renderImages();
    }

    function renderImages() {
      const area = document.getElementById('imageUploadArea');
      area.innerHTML = '';

      formData.images.forEach((img, index) => {
        const item = document.createElement('div');
        item.className = 'image-upload-item';
        item.innerHTML = `
          <div class="image-preview">
            <span class="placeholder"><i class="mdi mdi-cow"></i></span>
            <div class="remove-btn" onclick="removeImage(${index})"><i class="mdi mdi-close"></i></div>
          </div>
        `;
        area.appendChild(item);
      });

      if (formData.images.length < 9) {
        const addBtn = document.createElement('div');
        addBtn.className = 'image-upload-item';
        addBtn.innerHTML = `
          <div class="image-upload-btn" onclick="uploadImage()">
            <span class="icon"><i class="mdi mdi-plus"></i></span>
            <span>添加图片</span>
          </div>
        `;
        area.appendChild(addBtn);
      }
    }

    function uploadVideo() {
      formData.video = { id: Date.now() };
      showToast('视频已添加');
    }

    // ==================== 开关切换 ====================
    function toggleSwitch(el) {
      el.classList.toggle('active');
      const isActive = el.classList.contains('active');

      switch (el.id) {
        case 'negotiableSwitch':
          formData.negotiable = isActive;
          break;
        case 'batchSwitch':
          formData.batchPurchase = isActive;
          break;
        case 'videoVerifySwitch':
          formData.videoVerify = isActive;
          break;
        case 'showWechatSwitch':
          formData.showWechat = isActive;
          break;
      }
    }

    // ==================== 表单验证 ====================
    function validateForm() {
      let isValid = true;

      // 清除所有错误
      document.querySelectorAll('.form-group').forEach(g => g.classList.remove('error'));

      // 图片验证
      if (formData.images.length === 0) {
        showToast('请至少上传一张图片');
        return false;
      }

      // 标题验证
      if (!formData.title.trim()) {
        markError('title');
        isValid = false;
      }

      // 品种验证
      if (!formData.breed) {
        markError('breed');
        isValid = false;
      }

      // 数量验证
      if (!formData.quantity || formData.quantity <= 0) {
        markError('quantity');
        isValid = false;
      }

      // 体重验证
      if (!formData.weight || formData.weight <= 0) {
        markError('weight');
        isValid = false;
      }

      // 月龄验证
      if (!formData.ageMonths || formData.ageMonths <= 0) {
        markError('ageMonths');
        isValid = false;
      }

      // 性别验证
      if (!formData.gender) {
        markError('gender');
        isValid = false;
      }

      // 价格验证
      if (!formData.price || formData.price <= 0) {
        markError('price');
        isValid = false;
      }

      // 地区验证
      if (!formData.province || !formData.city) {
        document.getElementById('province').parentElement.parentElement.classList.add('error');
        isValid = false;
      }

      // 联系电话验证
      if (!formData.contactPhone || !/^1[3-9]\d{9}$/.test(formData.contactPhone)) {
        markError('contactPhone');
        isValid = false;
      }

      if (!isValid) {
        showToast('请完善必填信息');
      }

      return isValid;
    }

    function markError(fieldId) {
      const field = document.getElementById(fieldId);
      if (field) {
        field.closest('.form-group').classList.add('error');
      }
    }

    // ==================== 操作函数 ====================
    function goBack() {
      // 检查是否有未保存的内容
      if (formData.title || formData.images.length > 0) {
        if (confirm('是否保存草稿？')) {
          saveDraft();
        }
      }
      window.history.back();
    }

    function saveDraft() {
      globalState.set('publishDraft', formData);
      showToast('草稿已保存');
    }

    function loadDraft() {
      const draft = globalState.get('publishDraft');
      if (draft) {
        Object.assign(formData, draft);

        // 填充表单
        if (draft.title) document.getElementById('title').value = draft.title;
        if (draft.breed) document.getElementById('breed').value = draft.breed;
        if (draft.quantity) document.getElementById('quantity').value = draft.quantity;
        if (draft.weight) document.getElementById('weight').value = draft.weight;
        if (draft.ageMonths) document.getElementById('ageMonths').value = draft.ageMonths;
        if (draft.gender) document.getElementById('gender').value = draft.gender;
        if (draft.price) document.getElementById('price').value = draft.price;
        if (draft.description) document.getElementById('description').value = draft.description;
        if (draft.contactPhone) document.getElementById('contactPhone').value = draft.contactPhone;
        if (draft.contactName) document.getElementById('contactName').value = draft.contactName;

        // 渲染图片
        if (draft.images && draft.images.length > 0) {
          renderImages();
        }

        // 更新字数
        document.getElementById('titleCount').textContent = (draft.title || '').length;
        document.getElementById('descCount').textContent = (draft.description || '').length;
      }
    }

    function previewPublish() {
      if (!validateForm()) return;
      showToast('预览功能开发中');
    }

    function submitPublish() {
      if (!validateForm()) return;

      const btn = document.getElementById('submitBtn');
      btn.classList.add('loading');
      btn.textContent = '发布中...';

      // 模拟提交
      setTimeout(() => {
        btn.classList.remove('loading');
        btn.textContent = '立即发布';

        // 清除草稿
        globalState.remove('publishDraft');

        // 显示成功弹窗
        document.getElementById('successModal').classList.add('show');
      }, 1500);
    }

    function continuePublish() {
      document.getElementById('successModal').classList.remove('show');
      // 清空表单
      location.reload();
    }

    function viewMyPublish() {
      window.location.href = '../enterprise/my-publish.html';
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }
  </script>
</body>

</html>