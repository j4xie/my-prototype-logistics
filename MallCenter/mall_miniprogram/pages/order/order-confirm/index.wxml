<!--
  订单确认页面 - 增强版
  包含优惠券选择功能
-->
<wxs module="numberUtil" src="../../../utils/numberUtil.wxs"></wxs>
<view class="margin-bottom-bar">
  <!-- 收货地址 -->
  <view class="cu-list menu-avatar">
    <navigator class="cu-item" url='/pages/user/user-address/list/index?select=true' wx:if="{{orderSubParm.deliveryWay == '1'}}">
      <view class="cu-avatar round cuIcon-location bg-black"></view>
      <view class="content loc-content" wx:if="{{userAddress}}">
        <view class="flex padding-top-sm">
          <view class="cu-tag bg-red radius margin-right-sm" wx:if="{{userAddress.isDefault == '1'}}">默认</view>
          <view class="text-black">{{userAddress.userName}}</view>
          <view class="text-gray text-sm margin-left-sm">{{userAddress.telNum}}</view>
        </view>
        <view class="text-gray text-sm overflow-2 loc-info padding-bottom-sm address">
          {{userAddress.provinceName}}{{userAddress.cityName}}{{userAddress.countyName}}{{userAddress.detailInfo}}
        </view>
      </view>
      <view class="content loc-content" wx:if="{{!userAddress}}">
        请选择收货地址
      </view>
      <view class="action">
        <text class="cuIcon-right"></text>
      </view>
    </navigator>
  </view>

  <!-- 商品列表 -->
  <view class="cu-card article">
    <view class="cu-item">
      <view class="cu-list menu">
        <view wx:for="{{ orderConfirmData }}" wx:key="index">
          <view class="flex align-center">
            <image src="{{item.picUrl ? item.picUrl : '/public/img/no_pic.png'}}" mode="aspectFill" class="row-img margin-top-xs"></image>
          </view>
          <view class="row-info margin-left">
            <view class="text-black margin-top-xl overflow-2">{{item.spuName}}</view>
            <view class="text-gray text-sm margin-top-xs cu-tag round" wx:if="{{item.specInfo}}">{{item.specInfo}}</view>
            <view class="flex margin-top-sm">
              <view class="flex-sub">
                <text class="text-price text-xl text-blue text-bold margin-top-sm">{{item.salesPrice}}</text>
              </view>
              <view class="flex-twice text-gray text-sm text-right margin-right">
                x{{item.quantity}}
              </view>
            </view>
          </view>
        </view>

        <!-- 订单金额 -->
        <view class="cu-item margin-top-sm">
          <text class="text-gray text-sm">订单金额</text>
          <view class="action">
            <view class="text-price">{{salesPrice}}</view>
          </view>
        </view>

        <!-- 运费金额 -->
        <view class="cu-item margin-top-sm">
          <text class="text-gray text-sm">运费金额</text>
          <view class="action">
            <view class="text-price">{{freightPrice}}</view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 优惠券选择 -->
  <view class="coupon-section" bindtap="showCouponSelector">
    <view class="coupon-label">
      <text class="cuIcon-ticket text-orange"></text>
      <text>优惠券</text>
    </view>
    <view class="coupon-value">
      <block wx:if="{{selectedCoupon}}">
        <text class="coupon-discount">-¥{{couponDiscount}}</text>
        <text class="coupon-name">{{selectedCoupon.name}}</text>
      </block>
      <block wx:elif="{{availableCoupons.length > 0}}">
        <text class="coupon-available">{{availableCoupons.length}}张可用</text>
      </block>
      <block wx:else>
        <text class="coupon-none">暂无可用</text>
      </block>
      <text class="cuIcon-right"></text>
    </view>
  </view>

  <!-- 买家留言 -->
  <view class="cu-card mar-top-30">
    <view class="cu-item cu-form-group align-start" style="height:200rpx;">
      <input style="font-size:24rpx; margin-top:20rpx;" bindinput="userMessageInput" placeholder="给卖家留言"></input>
    </view>
  </view>
</view>

<!-- 底部结算栏 -->
<view class="cu-bar tabbar bg-white border foot">
  <view class="flex response">
    <view class="flex-sub price-summary">
      <view wx:if="{{selectedCoupon}}" class="discount-line">
        <text class="text-sm text-gray">优惠: </text>
        <text class="text-sm text-orange">-¥{{couponDiscount}}</text>
      </view>
    </view>
    <view class="flex-treble bar-rt">
      <text class="text-sm text-gray">共{{ orderConfirmData.length }}件，</text>
      <text class="text-sm text-gray">合计：</text>
      <text class="text-xl text-price text-blue text-bold">{{numberUtil.numberAddition(paymentPrice,0)}}</text>
      <button class="cu-btn shadow-blur margin-left-sm" style="background-color: #2967ff;font-weight:300;width:220rpx;" bindtap="orderSub" loading="{{loading}}" disabled="{{loading}}">
        <text class="text-white">提交订单</text>
      </button>
    </view>
  </view>
</view>

<!-- 优惠券选择弹窗 -->
<view class="coupon-modal {{showCouponModal ? 'show' : ''}}">
  <view class="coupon-modal-mask" bindtap="closeCouponModal"></view>
  <view class="coupon-modal-content">
    <view class="coupon-modal-header">
      <text>选择优惠券</text>
      <text class="cuIcon-close" bindtap="closeCouponModal"></text>
    </view>

    <scroll-view class="coupon-list" scroll-y>
      <!-- 不使用优惠券 -->
      <view class="coupon-item no-coupon {{!selectedCoupon ? 'selected' : ''}}" bindtap="clearCoupon">
        <view class="coupon-item-main">
          <view class="coupon-item-left">
            <text class="no-coupon-icon">×</text>
          </view>
          <view class="coupon-item-right">
            <view class="coupon-item-name">不使用优惠券</view>
            <view class="coupon-item-desc">原价支付</view>
          </view>
        </view>
        <view class="coupon-check" wx:if="{{!selectedCoupon}}">
          <text class="cuIcon-check"></text>
        </view>
      </view>

      <!-- 可用优惠券 -->
      <view class="coupon-group" wx:if="{{availableCoupons.length > 0}}">
        <view class="coupon-group-title">可用优惠券</view>
        <view
          class="coupon-item {{selectedCoupon && selectedCoupon.id === item.id ? 'selected' : ''}}"
          wx:for="{{availableCoupons}}"
          wx:key="id"
          bindtap="onCouponSelect"
          data-id="{{item.id}}"
        >
          <view class="coupon-item-main">
            <view class="coupon-item-left {{item.type}}">
              <view class="coupon-amount" wx:if="{{item.type === 'FIXED' || item.type === 'AMOUNT'}}">
                <text class="coupon-currency">¥</text>
                <text class="coupon-value-num">{{item.discountAmount}}</text>
              </view>
              <view class="coupon-amount" wx:elif="{{item.type === 'PERCENT'}}">
                <text class="coupon-value-num">{{item.discountPercent}}</text>
                <text class="coupon-unit">折</text>
              </view>
            </view>
            <view class="coupon-item-right">
              <view class="coupon-item-name">{{item.name}}</view>
              <view class="coupon-item-condition" wx:if="{{item.minAmount}}">满{{item.minAmount}}元可用</view>
              <view class="coupon-item-validity">有效期至 {{item.expireTime}}</view>
            </view>
          </view>
          <view class="coupon-check" wx:if="{{selectedCoupon && selectedCoupon.id === item.id}}">
            <text class="cuIcon-check"></text>
          </view>
        </view>
      </view>

      <!-- 不可用优惠券 -->
      <view class="coupon-group unavailable" wx:if="{{unavailableCoupons.length > 0}}">
        <view class="coupon-group-title">不可用优惠券</view>
        <view class="coupon-item disabled" wx:for="{{unavailableCoupons}}" wx:key="id">
          <view class="coupon-item-main">
            <view class="coupon-item-left">
              <view class="coupon-amount" wx:if="{{item.type === 'FIXED' || item.type === 'AMOUNT'}}">
                <text class="coupon-currency">¥</text>
                <text class="coupon-value-num">{{item.discountAmount}}</text>
              </view>
              <view class="coupon-amount" wx:elif="{{item.type === 'PERCENT'}}">
                <text class="coupon-value-num">{{item.discountPercent}}</text>
                <text class="coupon-unit">折</text>
              </view>
            </view>
            <view class="coupon-item-right">
              <view class="coupon-item-name">{{item.name}}</view>
              <view class="coupon-item-reason text-red">{{item.disabledReason}}</view>
            </view>
          </view>
        </view>
      </view>

      <!-- 空状态 -->
      <view class="coupon-empty" wx:if="{{availableCoupons.length === 0 && unavailableCoupons.length === 0}}">
        <text class="cuIcon-ticket"></text>
        <text>暂无优惠券</text>
      </view>
    </scroll-view>
  </view>
</view>

<user-auth/>
