<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.joolun.mall.mapper.AiDemandRecordMapper">
    <resultMap id="demandMap" type="com.joolun.mall.entity.AiDemandRecord">
        <id property="id" column="id"/>
        <result property="sessionId" column="session_id"/>
        <result property="messageId" column="message_id"/>
        <result property="userId" column="user_id"/>
        <result property="merchantId" column="merchant_id"/>
        <result property="openid" column="openid"/>
        <result property="userMessage" column="user_message"/>
        <result property="aiResponse" column="ai_response"/>
        <result property="extractedKeywords" column="extracted_keywords"/>
        <result property="extractedIntent" column="extracted_intent"/>
        <result property="confidenceScore" column="confidence_score"/>
        <result property="matchedProductIds" column="matched_product_ids"/>
        <result property="recommendedProductIds" column="recommended_product_ids"/>
        <result property="matchCount" column="match_count"/>
        <result property="demandType" column="demand_type"/>
        <result property="demandUrgency" column="demand_urgency"/>
        <result property="status" column="status"/>
        <result property="processedTime" column="processed_time"/>
        <result property="processedBy" column="processed_by"/>
        <result property="userFeedback" column="user_feedback"/>
        <result property="feedbackTime" column="feedback_time"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <sql id="demandSql">
        d.id,
        d.session_id,
        d.message_id,
        d.user_id,
        d.merchant_id,
        d.openid,
        d.user_message,
        d.ai_response,
        d.extracted_keywords,
        d.extracted_intent,
        d.confidence_score,
        d.matched_product_ids,
        d.recommended_product_ids,
        d.match_count,
        d.demand_type,
        d.demand_urgency,
        d.status,
        d.processed_time,
        d.processed_by,
        d.user_feedback,
        d.feedback_time,
        d.create_time,
        d.update_time
    </sql>

    <select id="selectPage1" resultMap="demandMap">
        SELECT
        <include refid="demandSql"/>
        FROM ai_demand_record d
        <where>
            <if test="query.sessionId != null and query.sessionId != ''">
                AND d.session_id = #{query.sessionId}
            </if>
            <if test="query.merchantId != null">
                AND d.merchant_id = #{query.merchantId}
            </if>
            <if test="query.demandType != null and query.demandType != ''">
                AND d.demand_type = #{query.demandType}
            </if>
            <if test="query.status != null">
                AND d.status = #{query.status}
            </if>
        </where>
        ORDER BY d.create_time DESC
    </select>

    <select id="selectBySessionId" resultMap="demandMap">
        SELECT
        <include refid="demandSql"/>
        FROM ai_demand_record d
        WHERE d.session_id = #{sessionId}
        ORDER BY d.create_time ASC
    </select>

    <select id="selectPendingDemands" resultMap="demandMap">
        SELECT
        <include refid="demandSql"/>
        FROM ai_demand_record d
        WHERE d.status = 0
          AND d.match_count = 0
        ORDER BY d.demand_urgency DESC, d.create_time ASC
        LIMIT #{limit}
    </select>

    <update id="updateFeedback">
        UPDATE ai_demand_record
        SET user_feedback = #{feedback}, feedback_time = NOW(), update_time = NOW()
        WHERE id = #{id}
    </update>
</mapper>
