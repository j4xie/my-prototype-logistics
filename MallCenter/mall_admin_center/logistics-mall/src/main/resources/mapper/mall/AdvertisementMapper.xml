<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.joolun.mall.mapper.AdvertisementMapper">
    <resultMap id="adMap" type="com.joolun.mall.entity.Advertisement">
        <id property="id" column="id"/>
        <result property="type" column="type"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="imageUrl" column="image_url"/>
        <result property="videoUrl" column="video_url"/>
        <result property="linkType" column="link_type"/>
        <result property="linkValue" column="link_value"/>
        <result property="position" column="position"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="status" column="status"/>
        <result property="viewCount" column="view_count"/>
        <result property="clickCount" column="click_count"/>
        <result property="createBy" column="create_by"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <sql id="adSql">
        ad.`id`,
        ad.`type`,
        ad.`title`,
        ad.`description`,
        ad.`image_url`,
        ad.`video_url`,
        ad.`link_type`,
        ad.`link_value`,
        ad.`position`,
        ad.`start_time`,
        ad.`end_time`,
        ad.`status`,
        ad.`view_count`,
        ad.`click_count`,
        ad.`create_by`,
        ad.`create_time`,
        ad.`update_time`
    </sql>

    <select id="selectPage1" resultMap="adMap">
        SELECT
        <include refid="adSql"/>
        FROM advertisement ad
        <where>
            <if test="query.type != null and query.type != ''">
                AND ad.`type` = #{query.type}
            </if>
            <if test="query.status != null">
                AND ad.`status` = #{query.status}
            </if>
            <if test="query.title != null and query.title != ''">
                AND ad.`title` LIKE CONCAT('%',#{query.title},'%')
            </if>
        </where>
        ORDER BY ad.`position` ASC, ad.`create_time` DESC
    </select>

    <select id="selectActiveByType" resultMap="adMap">
        SELECT
        <include refid="adSql"/>
        FROM advertisement ad
        WHERE ad.`status` = 1
          AND ad.`type` = #{type}
          AND (ad.`start_time` IS NULL OR ad.`start_time` &lt;= NOW())
          AND (ad.`end_time` IS NULL OR ad.`end_time` &gt;= NOW())
        ORDER BY ad.`position` ASC
    </select>

    <select id="selectActiveSplashAd" resultMap="adMap">
        SELECT
        <include refid="adSql"/>
        FROM advertisement ad
        WHERE ad.`status` = 1
          AND ad.`type` = 'splash_ad'
          AND (ad.`start_time` IS NULL OR ad.`start_time` &lt;= NOW())
          AND (ad.`end_time` IS NULL OR ad.`end_time` &gt;= NOW())
        ORDER BY ad.`position` ASC
        LIMIT 1
    </select>
</mapper>
