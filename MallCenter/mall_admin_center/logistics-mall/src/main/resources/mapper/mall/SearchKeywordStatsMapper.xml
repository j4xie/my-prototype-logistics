<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.joolun.mall.mapper.SearchKeywordStatsMapper">
    <resultMap id="statsMap" type="com.joolun.mall.entity.SearchKeywordStats">
        <id property="id" column="id"/>
        <result property="keyword" column="keyword"/>
        <result property="originalKeywords" column="original_keywords"/>
        <result property="searchCount" column="search_count"/>
        <result property="noResultCount" column="no_result_count"/>
        <result property="uniqueUsers" column="unique_users"/>
        <result property="uniqueMerchants" column="unique_merchants"/>
        <result property="firstSearchTime" column="first_search_time"/>
        <result property="lastSearchTime" column="last_search_time"/>
        <result property="status" column="status"/>
        <result property="priority" column="priority"/>
        <result property="isHot" column="is_hot"/>
        <result property="matchedProductIds" column="matched_product_ids"/>
        <result property="matchedCategoryIds" column="matched_category_ids"/>
        <result property="adminNote" column="admin_note"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <sql id="statsSql">
        s.`id`,
        s.`keyword`,
        s.`original_keywords`,
        s.`search_count`,
        s.`no_result_count`,
        s.`unique_users`,
        s.`unique_merchants`,
        s.`first_search_time`,
        s.`last_search_time`,
        s.`status`,
        s.`priority`,
        s.`is_hot`,
        s.`matched_product_ids`,
        s.`matched_category_ids`,
        s.`admin_note`,
        s.`create_time`,
        s.`update_time`
    </sql>

    <select id="selectPage1" resultMap="statsMap">
        SELECT
        <include refid="statsSql"/>
        FROM search_keyword_stats s
        <where>
            <if test="query.keyword != null and query.keyword != ''">
                AND s.`keyword` LIKE CONCAT('%',#{query.keyword},'%')
            </if>
            <if test="query.status != null">
                AND s.`status` = #{query.status}
            </if>
            <if test="query.priority != null">
                AND s.`priority` = #{query.priority}
            </if>
            <if test="query.isHot != null">
                AND s.`is_hot` = #{query.isHot}
            </if>
        </where>
        ORDER BY s.`priority` DESC, s.`no_result_count` DESC, s.`search_count` DESC
    </select>

    <select id="selectHotKeywords" resultMap="statsMap">
        SELECT
        <include refid="statsSql"/>
        FROM search_keyword_stats s
        WHERE s.`is_hot` = 1
           OR s.`search_count` >= 20
        ORDER BY s.`search_count` DESC
        LIMIT #{limit}
    </select>

    <select id="selectPendingHighPriority" resultMap="statsMap">
        SELECT
        <include refid="statsSql"/>
        FROM search_keyword_stats s
        WHERE s.`status` = 0
          AND s.`priority` >= 1
        ORDER BY s.`priority` DESC, s.`no_result_count` DESC
        LIMIT #{limit}
    </select>

    <select id="selectByKeyword" resultMap="statsMap">
        SELECT
        <include refid="statsSql"/>
        FROM search_keyword_stats s
        WHERE s.`keyword` = #{keyword}
    </select>

    <update id="incrementSearchCount">
        INSERT INTO search_keyword_stats (keyword, search_count, no_result_count, first_search_time, last_search_time, create_time)
        VALUES (#{keyword}, 1, #{noResult,jdbcType=BOOLEAN}, NOW(), NOW(), NOW())
        ON DUPLICATE KEY UPDATE
            search_count = search_count + 1,
            no_result_count = no_result_count + IF(#{noResult}, 1, 0),
            last_search_time = NOW(),
            update_time = NOW()
    </update>
</mapper>
