# 白垩纪系统完整指南 - 基于真实业务逻辑

## 📊 系统架构总览

```
┌─────────────────────────────────────────────────────────┐
│  前端 - React Native (端口 3010)                        │
│  ├─ 管理员界面: 入库、计划、盘点、分析                  │
│  └─ 员工界面: 每日记录、任务查看                       │
└────────────────┬────────────────────────────────────────┘
                 │
                 ↓
┌─────────────────────────────────────────────────────────┐
│  后端API - Node.js + Express + Prisma (端口 3001)       │
│  ├─ 库存管理API                                         │
│  ├─ 生产计划API (自动计算)                              │
│  ├─ 每日记录API                                         │
│  ├─ 盘点分析API                                         │
│  └─ AI桥接API ────────┐                                │
└───────────────────────│──────────────────────────────────┘
                        │
                        ↓
┌─────────────────────────────────────────────────────────┐
│  AI服务 - FastAPI + Llama-3.1-8B (端口 8085)           │
│  ├─ 成本结构分析                                        │
│  ├─ 效率优化建议                                        │
│  ├─ 浪费原因分析                                        │
│  └─ 改进方案推荐                                        │
└─────────────────────────────────────────────────────────┘
                        ↕
┌─────────────────────────────────────────────────────────┐
│  数据库 - MySQL (端口 3306)                             │
│  ├─ 原材料类型、库存                                     │
│  ├─ 生产计划、每日记录                                   │
│  ├─ 转换率配置                                          │
│  └─ 分析报告                                            │
└─────────────────────────────────────────────────────────┘
```

---

## 🎬 完整业务流程实例

### 背景故事
白垩纪水产加工厂在10月份的一个完整生产周期

---

### 📅 10月1日：原材料入库

**操作者**: 张经理（管理员）
**任务**: 记录新采购的2000kg鲈鱼入库

```
第1步: 登录系统
用户: super_admin
密码: 123456

第2步: 进入原材料入库
导航: 管理 → 库存管理 → 原材料入库
点击: [+ 新增入库]

第3步: 填写入库信息
┌──────────────────────────────┐
│ 原材料入库                   │
├──────────────────────────────┤
│ 原材料类型 *                 │
│ ┌──────────────────────────┐ │
│ │ 选择原材料类型 ▼         │ │ ← 点击
│ └──────────────────────────┘ │
└──────────────────────────────┘

🎯 MaterialTypeSelector 弹出:
┌──────────────────────────────┐
│ 选择原材料类型        [取消] │
├──────────────────────────────┤
│ 🔍 搜索原材料...             │
├──────────────────────────────┤
│ • 鲈鱼 (淡水鱼)           ✓  │ ← 选择
│ • 带鱼 (海水鱼)              │
│ • 黄花鱼 (海水鱼)            │
└──────────────────────────────┘

继续填写:
┌──────────────────────────────┐
│ 原材料类型: 鲈鱼 ✓           │
│ 数量: 2000 kg                │
│ 供应商: 海鲜批发商A          │
│ 单价: 5 元/kg                │
│ 总成本: 10000 元 (自动计算)  │
│ 入库日期: 2025-10-01         │
│ [提交入库]                    │
└──────────────────────────────┘

第4步: 提交成功
✅ 入库记录已保存
✅ 库存更新:
   - 鲈鱼总库存: 0kg → 2000kg
   - 可用库存: 0kg → 2000kg
```

**💡 如果原材料类型不存在**:
```
点击"选择原材料类型"
→ 搜索"石斑鱼" → 未找到
→ 滚动到底部 → 点击"➕ 添加新原材料类型"
→ 输入: 石斑鱼, 分类: 鱼类
→ 保存 → 自动选中
→ 继续填写数量

30秒完成！不需要退出页面或等待其他人！
```

---

### 📅 10月6日：创建生产计划

**操作者**: 张经理（管理员）
**任务**: 王老板订单 - 需要500kg鲈鱼片

```
第1步: 进入生产计划管理
导航: 管理 → 生产计划管理
点击: [+ 新建计划]

第2步: 填写计划信息
┌──────────────────────────────┐
│ 新建生产计划          [关闭] │
├──────────────────────────────┤
│ 商家 *: 王老板 ✓             │
│ 产品类型 *: 鲈鱼片 ✓         │
│ 计划产量 *: 500 kg           │
└──────────────────────────────┘

第3步: 系统自动计算（重点！）
┌──────────────────────────────┐
│ 💡 自动计算结果              │
├──────────────────────────────┤
│ 转换率配置: 50%              │
│ 损耗率: 5%                   │
│                              │
│ 预估原材料消耗:              │
│ ┌──────────────────────────┐ │
│ │ 鲈鱼: 1050 kg            │ │ ← 500÷0.5×1.05
│ └──────────────────────────┘ │
│                              │
│ 库存检查:                    │
│ ┌──────────────────────────┐ │
│ │ 鲈鱼总库存: 2000 kg      │ │
│ │ 已分配: 0 kg             │ │
│ │ 可用: 2000 kg            │ │
│ │                          │ │
│ │ 本计划需要: 1050 kg      │ │
│ │ 扣除后剩余: 950 kg ✓    │ │ ← 库存充足
│ └──────────────────────────┘ │
│                              │
│ [创建计划]                    │
└──────────────────────────────┘

第4步: 点击创建
系统自动:
✅ 生成批次号: #2025051
✅ 保存预估消耗: 1050kg
✅ 虚拟扣减库存:
   - 总库存: 2000kg (不变)
   - 已分配: 0kg → 1050kg
   - 可用: 2000kg → 950kg
✅ 计划状态: 待生产

第5步: 查看创建结果
┌──────────────────────────────┐
│ 批次 #2025051                │
│ 鲈鱼片 500kg - 待生产 🟡     │
│ 商家: 王老板                 │
│ 预估消耗: 1050kg鲈鱼         │
│ 预计完成: 2025-10-12         │
│ [开始生产]                    │
└──────────────────────────────┘
```

---

### 📅 10月7-11日：员工每日记录

**操作者**: 李师傅（操作员）
**任务**: 每天记录生产量

```
每天下班前操作:

登录: operator1 / 123456

导航: 加工 → 我的任务 → 批次 #2025051

点击: [记录今日产量]

┌──────────────────────────────┐
│ 今日生产记录          [关闭] │
├──────────────────────────────┤
│ 批次: #2025051               │
│ 产品: 鲈鱼片                 │
│ 日期: 2025-10-07             │
│                              │
│ 今日产量 (kg) *              │
│ ┌──────────────────────────┐ │
│ │ 100                      │ │ ← 填写当天产量
│ └──────────────────────────┘ │
│                              │
│ 工作时长 (小时)              │
│ ┌──────────────────────────┐ │
│ │ 8                        │ │
│ └──────────────────────────┘ │
│                              │
│ 流程问题                     │
│ ☐ 原材料质量问题             │
│ ☐ 设备故障                   │
│ ☐ 人手不足                   │
│ ☑ 无问题                     │
│                              │
│ [提交]                        │
└──────────────────────────────┘

提交后显示:
┌──────────────────────────────┐
│ ✅ 今日记录已保存             │
│ 今日产量: 100 kg             │
│ 累计产量: 100/500 kg (20%)   │
│ [确定]                        │
└──────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━
5天累计记录:
━━━━━━━━━━━━━━━━━━━━━━━━━━

10-07: 100kg (工时8h) → 累计100kg (20%)
10-08: 120kg (工时8h) → 累计220kg (44%)
10-09: 110kg (工时8h) → 累计330kg (66%)
10-10: 105kg (工时8h) → 累计435kg (87%)
10-11: 50kg (工时4h)  → 累计485kg (97%)

任务列表显示:
┌──────────────────────────────┐
│ 批次 #2025051                │
│ 鲈鱼片 - 生产中 🟢           │
│ 进度: 485/500 kg (97%)       │
│                              │
│ 📊 每日明细:                 │
│ 10-07: 100kg                 │
│ 10-08: 120kg ⭐ 最高        │
│ 10-09: 110kg                 │
│ 10-10: 105kg                 │
│ 10-11: 50kg                  │
│                              │
│ [标记完成]                    │
└──────────────────────────────┘
```

---

### 📅 10月11日：库存盘点

**操作者**: 张经理（管理员）
**任务**: 检查实际库存，分析差异

```
第1步: 查看批次完成情况
导航: 管理 → 生产计划管理 → #2025051

看到:
┌──────────────────────────────┐
│ 批次 #2025051 完成报告       │
├──────────────────────────────┤
│ 产量对比                     │
│ • 计划产量: 500 kg           │
│ • 实际产量: 485 kg           │
│ • 差异: -15 kg (-3%)         │
│                              │
│ 原材料预估                   │
│ • 预估消耗: 1050 kg          │
│ • 理论剩余: 950 kg           │
│                              │
│ [开始库存盘点]                │ ← 点击
└──────────────────────────────┘

第2步: 实际盘点
张经理去仓库实际测量

实际测量结果: 900kg

第3步: 输入盘点结果
┌──────────────────────────────┐
│ 库存盘点                     │
├──────────────────────────────┤
│ 原材料: 鲈鱼                 │
│                              │
│ 理论库存                     │
│ ┌──────────────────────────┐ │
│ │ 总库存: 2000 kg          │ │
│ │ 本批预估: 1050 kg        │ │
│ │ 理论剩余: 950 kg         │ │
│ └──────────────────────────┘ │
│                              │
│ 实际盘点 *                   │
│ ┌──────────────────────────┐ │
│ │ 900                      │ │ ← 输入实测值
│ └──────────────────────────┘ │
│                              │
│ [分析差异]                    │
└──────────────────────────────┘

第4步: 系统自动分析
┌──────────────────────────────┐
│ ⚠️ 差异分析结果               │
├──────────────────────────────┤
│ 理论剩余: 950 kg             │
│ 实际库存: 900 kg             │
│ 差异: -50 kg                 │
│                              │
│ 分析结论:                    │
│ ┌──────────────────────────┐ │
│ │ 实际库存少于理论库存     │ │
│ │ → 生产过程中浪费了50kg   │ │
│ │                          │ │
│ │ 浪费率: 4.76%            │ │
│ │ (50kg ÷ 1050kg)          │ │
│ │                          │ │
│ │ 浪费成本: ¥250           │ │
│ │ (50kg × 5元/kg)          │ │
│ └──────────────────────────┘ │
│                              │
│ [生成缺料报告]                │ ← 点击
└──────────────────────────────┘

第5步: 填写缺料报告
┌──────────────────────────────┐
│ 缺料报告                     │
├──────────────────────────────┤
│ 批次: #2025051               │
│ 原材料: 鲈鱼                 │
│ 缺少数量: 50 kg (自动填入)   │
│                              │
│ 缺少原因 *                   │
│ ☑ 边角料浪费 (主要)          │
│ ☐ 原材料腐坏                 │
│ ☐ 质量不合格丢弃             │
│ ☐ 操作失误                   │
│                              │
│ 详细说明 *                   │
│ ┌──────────────────────────┐ │
│ │ 鱼头、鱼尾、鱼骨等边角料 │ │
│ │ 约占4.76%，比预期的5%略  │ │
│ │ 好，属于正常范围         │ │
│ └──────────────────────────┘ │
│                              │
│ 改进措施                     │
│ ┌──────────────────────────┐ │
│ │ 1. 继续保持当前工艺      │ │
│ │ 2. 研究边角料产品化      │ │
│ │ 3. 尝试开发鱼头、鱼骨汤  │ │
│ └──────────────────────────┘ │
│                              │
│ [提交报告]                    │
└──────────────────────────────┘

第6步: 报告提交成功
✅ 缺料报告已保存
✅ 数据已记录用于后续分析
✅ 系统更新实际库存: 900kg
```

---

### 📅 10月12日：数据分析 + AI智能建议

**操作者**: 张经理（管理员）
**任务**: 查看数据，获取优化建议

```
第1步: 进入数据分析
导航: 管理 → 数据分析 → 生产效率分析

看到综合报告:
┌──────────────────────────────┐
│ 📊 10月生产数据分析          │
├──────────────────────────────┤
│ 批次 #2025051 分析           │
│                              │
│ 产量表现                     │
│ ┌──────────────────────────┐ │
│ │ 计划: 500 kg             │ │
│ │ 实际: 485 kg             │ │
│ │ 完成率: 97%              │ │
│ │ 差异: -15kg (-3%)        │ │
│ └──────────────────────────┘ │
│                              │
│ 原材料效率                   │
│ ┌──────────────────────────┐ │
│ │ 预估消耗: 1050 kg        │ │
│ │ 实际消耗: 1100 kg        │ │
│ │ 浪费: 50 kg (4.76%)      │ │
│ │ 浪费成本: ¥250           │ │
│ └──────────────────────────┘ │
│                              │
│ 每日产量趋势                 │
│ ┌──────────────────────────┐ │
│ │ kg                       │ │
│ │ 150│                     │ │
│ │    │     ●               │ │
│ │ 100│  ●  ● ● ●           │ │
│ │    │ ●         ●         │ │
│ │  50│                     │ │
│ │    └───────────────      │ │
│ │     7 8 9 10 11 日      │ │
│ │                          │ │
│ │ • 最高: 10-08 (120kg)    │ │
│ │ • 最低: 10-11 (50kg)     │ │
│ │ • 平均: 97kg/天          │ │
│ └──────────────────────────┘ │
│                              │
│ 流程问题统计                 │
│ • 总问题: 0次 ✅             │
│ • 按时完成: 100%             │
│                              │
│ ━━━━━━━━━━━━━━━━━━━━━━━━   │
│                              │
│ 🤖 AI 智能分析              │ ← AI集成点
│                              │
│ [获取AI优化建议] 按钮        │ ← 点击这里
└──────────────────────────────┘

第2步: 点击 "获取AI优化建议"

显示加载:
┌──────────────────────────────┐
│ 🤖 AI分析中...               │
│ ⏳ 正在分析成本数据          │
│ (通常需要3-8秒)              │
└──────────────────────────────┘

第3步: AI分析结果（3-8秒后）
┌──────────────────────────────────────┐
│ 🤖 AI分析结果                        │
├──────────────────────────────────────┤
│ 根据批次 #2025051 的数据分析：       │
│                                      │
│ **成本结构分析**：                   │
│ 1. 原材料成本: ¥5500 (82.1%)        │
│    - 正常范围，水产加工通常75-85%    │
│                                      │
│ 2. 人工成本: ¥960 (14.3%)           │
│    - 合理，标准范围10-20%            │
│                                      │
│ 3. 设备成本: ¥240 (3.6%)            │
│    - 良好，设备利用充分              │
│                                      │
│ **效率分析**：                       │
│ • 每日产量波动: 50-120kg             │
│ • 10月8日效率最高(120kg/天)         │
│ • 建议: 总结8日成功经验，标准化流程  │
│                                      │
│ **浪费分析**：                       │
│ • 浪费率4.76%在正常范围(3-7%)       │
│ • 主要是边角料，可考虑再利用         │
│                                      │
│ **优化建议**：                       │
│ 1. 保持当前工艺，浪费率已很低        │
│ 2. 研究10月8日高效率原因:           │
│    - 可能是原料质量好                │
│    - 可能是员工配合好                │
│    - 可能是设备状态佳                │
│ 3. 边角料产品化建议:                │
│    - 开发鱼头、鱼骨汤产品            │
│    - 预计可回收30-40%边角料         │
│    - 潜在增收: ¥100-150/批次        │
│ 4. 转换率调整建议:                  │
│    - 当前50%略高                    │
│    - 建议调整为48%                  │
│    - 更符合实际生产情况              │
│                                      │
│ **预期效果**：                       │
│ • 成本优化: 减少浪费10-20kg/批次    │
│ • 收入增加: 边角料产品化+¥120/批次  │
│ • 总利润提升: 约8-12%                │
└──────────────────────────────────────┘

第4步: 快速提问（可选）
┌──────────────────────────────┐
│ 💬 快速提问                   │
├──────────────────────────────┤
│ [如何提高每日产量稳定性？]   │
│ [人工成本如何优化？]         │
│ [设备利用率分析]             │
│                              │
│ 或输入自定义问题:            │
│ ┌──────────────────────────┐ │
│ │                          │ │
│ └──────────────────────────┘ │
│ [提问]                        │
└──────────────────────────────┘
```

---

## 🔧 MaterialTypeSelector 完整使用指南

### 使用场景1: 原材料入库 ⭐ 主要场景

```
位置: 库存管理 → 原材料入库
用户: 管理员
频率: 每次采购入库

常规操作:
1. 点击"原材料类型" → 从列表选择
2. 填写数量、供应商
3. 提交入库

快捷添加场景:
当第一次采购新品种（如石斑鱼）时:
1. 点击"原材料类型"
2. 搜索"石斑鱼" → 未找到
3. 点击底部"➕ 添加新原材料类型"
4. 输入名称: 石斑鱼
5. 选择分类: 鱼类
6. 保存 → 自动选中
7. 继续填写数量
8. 提交入库

时间: 30秒（传统方式需要10-30分钟）
```

### 使用场景2: 转换率配置

```
位置: 设置 → 转换率管理
用户: 管理员
频率: 新产品上线时

操作:
配置"石斑鱼 → 石斑鱼片"的转换率
1. 原材料: 石斑鱼 ← MaterialTypeSelector
2. 产品: 石斑鱼片
3. 转换率: 45%
4. 损耗率: 6%
5. 保存

如果"石斑鱼"不存在 → 快捷添加
```

### 使用场景3: 缺料报告

```
位置: 库存盘点后
用户: 管理员
频率: 每次盘点发现浪费时

操作:
报告浪费的原材料
1. 原材料: 鲈鱼 ← MaterialTypeSelector
2. 缺少数量: 50kg
3. 原因: 边角料浪费
4. 提交报告
```

---

## 🤖 AI服务集成说明

### AI服务状态
- ✅ 已配置: backend-ai-chat (端口8085)
- ✅ 模型: Llama-3.1-8B-Instruct
- ✅ 专用Prompt: 水产加工成本分析
- ✅ 成本: 超低（¥0.003/次）

### 使用场景
数据分析仪表板中的"AI优化建议"功能

### 分析能力
1. **成本结构分析** - 各项成本占比是否合理
2. **效率分析** - 每日产量波动原因
3. **浪费分析** - 浪费率是否正常，如何改进
4. **优化建议** - 具体可操作的改进措施
5. **预期效果** - 量化的优化收益预测

### 启动AI服务
```bash
cd backend-ai-chat
python main.py

# 或使用启动脚本
start-ai-service.cmd
```

---

## 📅 完整开发计划

### 已完成 ✅
- MaterialTypeSelector 组件
- 原材料类型管理API
- 快捷添加功能
- 生产计划基础框架
- AI服务配置

### 需要实现 🚧

#### P0 - 立即实现
1. **库存管理**
   - MaterialStock 表
   - 入库API连接
   - 库存查询和更新

2. **生产计划自动计算**
   - 查询转换率
   - 实时计算预估消耗
   - 库存检查和预留
   - 前端实时显示

#### P1 - 核心体验
3. **每日生产记录**
   - DailyProductionRecord 表
   - 员工记录界面
   - 累计统计

4. **库存盘点**
   - 盘点界面
   - 差异分析
   - 缺料报告

#### P2 - 增值功能
5. **数据分析 + AI**
   - 综合分析仪表板
   - AI服务集成
   - 智能建议显示
   - 趋势图表

---

## 🎯 系统核心价值

### 对管理员
- ✅ 库存精准追踪（知道每一克原材料去向）
- ✅ 浪费可量化（自动计算浪费率和成本）
- ✅ 决策有依据（AI智能分析，数据驱动）
- ✅ 效率可优化（发现最佳实践，复制推广）

### 对员工
- ✅ 操作简单（每天只需记录产量和工时）
- ✅ 进度清晰（实时看到任务完成度）
- ✅ 问题可反馈（记录流程问题）

### 对企业
- ✅ 成本降低（减少浪费2-5%）
- ✅ 质量提升（标准化流程）
- ✅ 数据积累（长期数据分析）
- ✅ 智能决策（AI辅助优化）

---

**下一步**: 从P0开始，实现库存管理和生产计划自动计算功能