# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is ç™½å©çºªé£Ÿå“æº¯æºç³»ç»Ÿ (Cretas Food Traceability System), focusing on **React Native mobile app** and **Spring Boot backend API** development:

1. **Spring Boot Backend** (Java 11 + Spring Boot 2.7.15 + MySQL + Spring Data JPA + Hibernate)
2. **React Native Mobile App** (Expo 53+ + TypeScript + React Navigation 7+ + Zustand)
3. **Python AI Service** (DeepSeek API integration for intelligent cost analysis)

## ğŸ”§ Server Management & Deployment

### å®å¡”é¢æ¿APIç®¡ç†

æœ¬é¡¹ç›®ä½¿ç”¨**å®å¡”é¢æ¿API**è¿›è¡ŒæœåŠ¡å™¨ç®¡ç†å’Œåº”ç”¨éƒ¨ç½²ã€‚

**é‡è¦é…ç½®**:
- **å®å¡”é¢æ¿åœ°å€**: `https://139.196.165.140:16435/a96c4c2e`
- **åº”ç”¨æœåŠ¡å™¨**: 139.196.165.140:10010

**è¯¦ç»†ä½¿ç”¨æŒ‡å—**: å‚è§ [`.claude/bt-api-guide.md`](./.claude/bt-api-guide.md)

**å¿«é€Ÿå‚è€ƒ**:
```bash
# 1. ç”ŸæˆAPIç­¾å
python3 << 'EOF'
import hashlib, time
api_sk = "YOUR_API_KEY"
request_time = str(int(time.time()))
md5_api_sk = hashlib.md5(api_sk.encode()).hexdigest()
request_token = hashlib.md5((request_time + md5_api_sk).encode()).hexdigest()
print(f"{request_time}|{request_token}")
EOF

# 2. è°ƒç”¨API (å¿…é¡»ä½¿ç”¨ -k å‚æ•°å’Œ HTTPS)
curl -k -X POST "https://106.14.165.234:8888/system?action=GetSystemTotal" \
  -d "request_time=$REQUEST_TIME" \
  -d "request_token=$REQUEST_TOKEN"
```

### Spring Boot åç«¯éƒ¨ç½²

**éƒ¨ç½²ä½ç½®**:
- JARæ–‡ä»¶: `/www/wwwroot/cretas/cretas-backend-system-1.0.0.jar`
- æ—¥å¿—æ–‡ä»¶: `/www/wwwroot/cretas/cretas-backend.log`
- ç«¯å£: 10010

**éƒ¨ç½²æ­¥éª¤**:
1. ç¼–è¯‘JAR: `mvn clean package -DskipTests`
2. ä¸Šä¼ åˆ°æœåŠ¡å™¨: `/www/wwwroot/cretas/`
3. æ‰§è¡Œé‡å¯è„šæœ¬: `bash /www/wwwroot/cretas/restart.sh`

**é‡å¯è„šæœ¬** (`/www/wwwroot/cretas/restart.sh`):
```bash
#!/bin/bash
cd /www/wwwroot/cretas
ps aux | grep cretas-backend-system | grep -v grep | awk '{print $2}' | xargs -r kill -9
sleep 2
nohup java -jar cretas-backend-system-1.0.0.jar --server.port=10010 > cretas-backend.log 2>&1 &
echo "Started with PID: $!"
```

## ğŸ¯ Development Strategy (IMPORTANT)

### Frontend-Backend Separation Development Approach

**CRITICAL**: This project follows a **two-phase development strategy** during Phase 1-3:

#### Phase 1-3: React Native Frontend Only
- **Focus**: Develop ONLY React Native frontend application
- **No Backend Implementation**: Do NOT create/modify any backend logic, functions, or database schema
- **API Interface Design**: Create complete API client interfaces in React Native
- **No Mock APIs**: All development is based on real API interface design
- **Requirement Collection**: Record ALL backend requirements in `/mnt/c/Users/Steve/cretas/backend/rn-update-tableandlogic.md`

#### Post-Phase 3: Backend Implementation
- **Backend Development**: Implement all collected backend requirements
- **Final Integration**: Connect frontend with implemented backend APIs

### Why This Strategy?
- âœ… **Parallel Development**: Frontend team can develop independently
- âœ… **Requirement Clarity**: All backend needs are centrally documented
- âœ… **Reduced Dependencies**: No blocking between frontend and backend teams
- âœ… **Efficient Integration**: Clear requirements lead to faster final integration

---

## ğŸ¯ Current Development Phase: Phase 3 åŠŸèƒ½å®Œå–„

**Status**: Phase 1-2 å·²å®Œæˆ âœ… | Phase 3 å¼€å‘ä¸­ ğŸ”¨ | Phase 4-5 è®¡åˆ’ä¸­ ğŸ“…

**Current Strategy**: **ä¼˜å…ˆå®Œå–„å·²æœ‰åŠŸèƒ½ï¼Œå†æ·»åŠ æ–°åŠŸèƒ½**

### Phase 3 Development Priority

#### P0 (ç´§æ€¥ä¿®å¤ - 2å°æ—¶)
- è®¾å¤‡ç›‘æ§é›†æˆåˆ°å¯¼èˆª (EquipmentMonitoringScreen)

#### P1 (æ ¸å¿ƒåŠŸèƒ½ - 3-4å¤©)
- AIæ™ºèƒ½åˆ†æè¯¦æƒ…é¡µ (DeepSeekAnalysisScreen)
- è´¨æ£€å®Œæ•´æµç¨‹ (CreateQualityRecordScreen, QualityInspectionDetailScreen)
- æˆæœ¬å¯¹æ¯”åˆ†æã€è®¾å¤‡å‘Šè­¦ã€åº“å­˜å¢å¼º

#### P2 (è¾…åŠ©åŠŸèƒ½ - 5-7å¤©)
- ç”¨æˆ·æ³¨å†Œæµç¨‹ (RegisterPhaseOne/Two)
- æ•°æ®æŠ¥è¡¨å¯¼å‡º (DataExportScreen)
- å·¥å‚è®¾ç½®ã€å‘˜å·¥æ•ˆç‡ã€åº“å­˜ç›˜ç‚¹ã€å¼‚å¸¸é¢„è­¦

**è¯¦è§**: [`docs/prd/PRD-Phase3-å®Œå–„è®¡åˆ’.md`](./docs/prd/PRD-Phase3-å®Œå–„è®¡åˆ’.md)

### ğŸ“± Already Implemented Pages (24ä¸ª)

**è®¤è¯æ¨¡å—**:
- âœ… EnhancedLoginScreen

**ä¸»å¯¼èˆª**:
- âœ… HomeScreen (é¦–é¡µ)
- âœ… ProfileScreen (ä¸ªäººä¸­å¿ƒ)

**è€ƒå‹¤æ¨¡å—**:
- âœ… TimeClockScreen (æ‰“å¡)
- âœ… AttendanceStatisticsScreen (å·¥æ—¶ç»Ÿè®¡)

**ç”Ÿäº§æ¨¡å—** (9ä¸ªé¡µé¢):
- âœ… ProcessingDashboard (ä»ªè¡¨æ¿)
- âœ… BatchListScreen, BatchDetailScreen, CreateBatchScreen
- âœ… QualityInspectionListScreen
- âœ… CostAnalysisDashboard (æˆæœ¬åˆ†æ)
- âœ… ProductionPlanManagementScreen (ç”Ÿäº§è®¡åˆ’)
- âœ… MaterialReceiptScreen, MaterialBatchManagementScreen (åŸææ–™)

**ç®¡ç†æ¨¡å—** (10ä¸ªé¡µé¢):
- âœ… ManagementScreen + ProductType, MaterialType, ConversionRate
- âœ… WorkType, AISettings, User, Whitelist, Supplier, Customer

**å¹³å°ç®¡ç†**:
- âœ… AIQuotaManagementScreen

### ğŸ”— Documentation Reference

**PRD Documents**:
- ğŸ“‹ [PRD-å®ç°çŠ¶æ€æ€»è§ˆ](./docs/prd/PRD-å®ç°çŠ¶æ€æ€»è§ˆ.md) - å®Œæ•´çš„é¡µé¢å®ç°æƒ…å†µå’Œä¼˜å…ˆçº§
- ğŸ“š [PRD-ç³»ç»Ÿäº§å“éœ€æ±‚æ–‡æ¡£-v4.0](./docs/prd/PRD-ç³»ç»Ÿäº§å“éœ€æ±‚æ–‡æ¡£-v4.0.md) - åˆ†é˜¶æ®µçš„éœ€æ±‚æ–‡æ¡£
- ğŸ› ï¸ [PRD-Phase3-å®Œå–„è®¡åˆ’](./docs/prd/PRD-Phase3-å®Œå–„è®¡åˆ’.md) - Phase 3çš„è¯¦ç»†å¼€å‘ä»»åŠ¡

**Backend Requirements**:
- ğŸ”§ [`backend/rn-update-tableandlogic.md`](./backend/rn-update-tableandlogic.md) - APIå’Œæ•°æ®åº“éœ€æ±‚

---

## Development Commands

### ğŸ“± React Native Development (PRIMARY FOCUS)

**Phase 1-3 Development Commands**:
```bash
cd frontend/CretasFoodTrace
npm install                   # Install dependencies
npm start                     # Start Expo development server (port 3010)
npx expo start               # Alternative start command (port 3010)
npx expo start --clear       # Start with cache cleared (port 3010)
npm run android              # Start on Android (port 3010)
npm run ios                  # Start on iOS (macOS only, port 3010)
npm run web                  # Start web version (port 3010)
```

**âš ï¸ PORT CONFIGURATION**:
- **React Native Dev Server**: Port `3010` (Expo/Metro bundler)
- **Backend API Server**: Port `3001` (Express API)
- **MySQL Database**: Port `3306` (default)

### ğŸ”§ Backend Services (Supporting Services Only)

**Note**: During Phase 1-3, backend is used only as a supporting service. DO NOT modify backend code.

```bash
cd backend
npm install                    # Install dependencies  
npm run dev                   # Start development server (port 3001)
npm run check                 # Run health checks
npm run studio                # Open Prisma Studio (for database inspection)
```

### ğŸš€ Quick Start Scripts (Windows)

**Primary Development Script**:
- `start-backend-rn.cmd` - **MAIN**: Start MySQL + Backend (3001) + React Native (3010) (one-click setup)

**Alternative Scripts**:
- `SOLUTION-HUB.cmd` - Development menu with PowerShell issue solutions
- `NO-PROFILE-DEV.cmd` - Bypass PowerShell profile issues completely

### ğŸ“‹ Backend Requirements Management

**View/Edit Backend Requirements**:
```bash
# Open the backend requirements document
code backend/rn-update-tableandlogic.md

# Or use any text editor
notepad backend/rn-update-tableandlogic.md
```

**IMPORTANT**: All backend logic, API implementations, and database schema changes should be documented in `backend/rn-update-tableandlogic.md`, NOT implemented during Phase 1-3.

## Architecture Overview

### Backend Architecture
- **Framework**: Express.js with ES modules (`"type": "module"`)
- **Database**: MySQL with Prisma ORM (can migrate to PostgreSQL)
- **Authentication**: JWT with refresh tokens, complex multi-role system
- **Mobile Support**: Dedicated `/api/mobile/*` routes for React Native
- **Key Features**: 
  - DeepSeek LLM integration for intelligent analysis
  - File upload with mobile optimization
  - Device binding and activation system
  - Multi-stage registration with phone verification
- **File Structure**:
  - `/src/controllers/` - Request handlers (authController.js, platformController.js)
  - `/src/middleware/` - Authentication, validation, error handling, mobileAuth
  - `/src/routes/` - API routes (auth.js, mobile.js, platform.js, users.js)
  - `/src/services/` - Business logic (cronJobs.js, factoryService.js)
  - `/src/config/` - Configuration (permissions.js, database.js)
  - `/src/utils/` - Utilities (jwt.js, password.js, logger.js)
  - `/prisma/schema.prisma` - Database schema with complex user roles

### React Native Architecture (Primary Focus)
- **Framework**: Expo 53+ with React Native 0.79+
- **Navigation**: React Navigation 7+ with permission-based routing
- **State Management**: Zustand with persistent storage
- **Authentication**: 
  - Multi-role system (developer, platform_admin, factory roles)
  - Biometric authentication with Expo LocalAuthentication
  - Device binding and secure token storage
- **Key Features**:
  - Camera integration for QR scanning and photo capture
  - GPS location tracking
  - DeepSeek AI analysis integration
  - Offline-first architecture with sync
  - Push notifications
- **Development Strategy**: 9-week phased approach
  - **Phase 0** (1 week): Environment setup
  - **Phase 1** (3 weeks): Complete authentication system migration
  - **Phase 2** (3 weeks): Processing module + DeepSeek LLM integration
  - **Phase 3** (2 weeks): App activation system + production release
- **Module Structure**:
  - `/src/components/` - UI components (auth, permissions, forms)
  - `/src/modules/` - Feature modules (auth, processing, farming, logistics, sales)
  - `/src/services/` - API clients and services (authService, activationService)
  - `/src/navigation/` - Smart navigation with permission guards
  - `/src/store/` - Zustand stores (authStore, navigationStore, permissionStore)
  - `/src/screens/` - Screen components organized by feature

## Database Schema (MySQL/PostgreSQL via Prisma)

The system supports a complex multi-tenant architecture with sophisticated role management:

### Core Models
- `Factory` - Manufacturing facilities with industry/region coding and factory ID generation
- `User` - Factory employees with complex role hierarchy and department structure
- `PlatformAdmin` - Platform-level administrators with system-wide permissions
- `UserWhitelist` - Phone number pre-approval system with expiration management
- `Session` - User session management with device tracking
- `FactorySettings` - Factory-specific configuration
- `UserRoleHistory` - Role change tracking and audit trail

### User Roles & Permissions (8 Role System)
**Platform Roles**: 
- `developer` (system_developer) - Full system access
- `platform_admin` (platform_super_admin) - Platform management
- `platform_operator` - Limited platform operations

**Factory Roles**:
- `factory_super_admin` - Factory-wide admin access
- `permission_admin` - User permission management
- `department_admin` - Department-level administration
- `operator` - Operational access
- `viewer` - Read-only access
- `unactivated` - Pending activation

## Mobile API Architecture

### Mobile-Specific Endpoints (`/api/mobile/*`)
- **Authentication**: Unified login, device binding, biometric support
- **Registration**: Two-phase registration with phone verification
- **File Upload**: Mobile-optimized image upload with compression
- **DeepSeek Integration**: AI analysis with cost control (target: <Â¥30/month)
- **App Activation**: Device-based activation system
- **Health Check**: Service availability monitoring

### Key Mobile APIs
```javascript
POST /api/mobile/auth/unified-login      // Smart login (platform vs factory user)
POST /api/mobile/auth/register-phase-one // Phone verification stage
POST /api/mobile/auth/register-phase-two // Complete registration
POST /api/mobile/auth/bind-device       // Device binding for security
POST /api/mobile/upload/mobile          // Image upload with optimization
POST /api/mobile/analysis/deepseek      // AI analysis requests
POST /api/mobile/activation/activate    // App activation
```

## Authentication System (Mobile-Optimized)

### Multi-Stage Authentication Flow
1. **Phone Verification** â†’ **Whitelist Check** â†’ **Registration/Login**
2. **Smart User Detection**: System automatically detects platform vs factory users
3. **Device Binding**: Secure device registration with unique device IDs
4. **Biometric Integration**: Fingerprint/Face ID support via Expo LocalAuthentication
5. **Token Management**: AccessToken + RefreshToken + TempToken + DeviceToken

### Mobile Registration Flow
```javascript
// Phase 1: Phone verification and whitelist check
POST /api/mobile/auth/register-phase-one
{
  phoneNumber: "+8613800000000",
  verificationType: "registration"
}

// Phase 2: Complete profile with temporary token
POST /api/mobile/auth/register-phase-two
{
  tempToken: "temp_xxx",
  username: "user123", 
  password: "secure_password",
  fullName: "å¼ ä¸‰",
  department: "ç”Ÿäº§éƒ¨"
  // Additional factory user fields
}
```

### Smart Login System
The unified login automatically determines user type:
- **Platform Users**: Developer, platform admins (priority 1)
- **Factory Users**: Factory roles within specific factories (priority 2)
- **Navigation**: Smart post-login redirection based on role and permissions

## Development Environment Setup

### React Native + Backend Setup (Windows)
**Recommended Approach**: Use `start-backend-rn.cmd`
1. Automatically starts MySQL service
2. Launches backend server (port 3001)
3. Starts Expo React Native development server
4. Opens new terminal windows for each service

### Manual Setup
```bash
# 1. Database Setup
cd backend
cp .env.example .env
# Configure DATABASE_URL in .env
npm run migrate
npm run seed

# 2. Backend
npm run dev

# 3. React Native (new terminal)
cd frontend/CretasFoodTrace  
npx expo start
```

### PowerShell Issues (Windows)
The project includes comprehensive PowerShell profile management:
- **Primary Solution**: Use `start-backend-rn.cmd` (bypasses PowerShell entirely)
- **Alternative**: Use `SOLUTION-HUB.cmd` for guided PowerShell fixes
- **Emergency**: Use `NO-PROFILE-DEV.cmd` for immediate development access
- **Critical Rule**: Never use `Add-Content` to modify PowerShell profiles (causes corruption)

## React Native Development Strategy (9-Week Plan)

### Phase Overview
- **Phase 0** (1 week): Environment setup and project initialization
- **Phase 1** (3 weeks): Complete authentication system migration with 8-role support
- **Phase 2** (3 weeks): Processing module implementation + DeepSeek LLM integration  
- **Phase 3** (2 weeks): App activation system + production release preparation

### Key Development Principles
1. **Mobile-First Design**: Optimize for Android with Material Design 3
2. **Offline-First Architecture**: Core features work without network connectivity
3. **Performance Targets**: <3s startup, <500ms page transitions, <200MB memory
4. **Cost Control**: DeepSeek AI analysis <Â¥30/month, cache hit rate >60%

## Key Development Patterns

### âš ï¸ Code Quality Principles (CRITICAL)

**DO NOT Use Degradation/Fallback Patterns**

é™çº§å¤„ç†(Degradation/Fallback)æ˜¯ä¸€ç§**æ²»æ ‡ä¸æ²»æœ¬**çš„æ–¹æ³•ï¼Œåœ¨æœ¬é¡¹ç›®ä¸­**ä¸¥æ ¼ç¦æ­¢**ä½¿ç”¨ã€‚

**âŒ ç¦æ­¢çš„é™çº§å¤„ç†æ¨¡å¼**:
```javascript
// âŒ BAD: ä½¿ç”¨é™çº§å¤„ç†æ©ç›–é—®é¢˜
try {
  const result = await apiCall();
  return result;
} catch (error) {
  console.log('API failed, using fallback');
  return mockData; // é™çº§åˆ°Mockæ•°æ®
}

// âŒ BAD: æ¡ä»¶é™çº§
if (feature.isAvailable()) {
  return feature.execute();
} else {
  return simplifiedVersion(); // é™çº§åˆ°ç®€åŒ–ç‰ˆæœ¬
}
```

**âœ… æ­£ç¡®çš„é—®é¢˜è§£å†³æ–¹æ³•**:
```javascript
// âœ… GOOD: æ‰¾åˆ°å¹¶ä¿®å¤æ ¹æœ¬åŸå› 
try {
  const result = await apiCall();
  return result;
} catch (error) {
  logger.error('API call failed', error);
  // 1. è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯
  // 2. å‘ç”¨æˆ·æ˜¾ç¤ºæ˜ç¡®çš„é”™è¯¯æç¤º
  // 3. åœ¨backend/rn-update-tableandlogic.mdä¸­è®°å½•éœ€è¦ä¿®å¤çš„é—®é¢˜
  throw new UserFacingError('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
}

// âœ… GOOD: å®ç°å®Œæ•´åŠŸèƒ½æˆ–ä¸å®ç°
if (!feature.isAvailable()) {
  // 1. è®°å½•ä¸ºå¾…å®ç°åŠŸèƒ½
  // 2. å‘ç”¨æˆ·æ˜ç¡®è¯´æ˜åŠŸèƒ½æœªå¼€æ”¾
  throw new FeatureNotAvailableError('è¯¥åŠŸèƒ½å³å°†ä¸Šçº¿');
}
return feature.execute();
```

**ä¸ºä»€ä¹ˆç¦æ­¢é™çº§å¤„ç†**:
1. **æ©ç›–é—®é¢˜**: é™çº§å¤„ç†ä¼šéšè—çœŸå®çš„é”™è¯¯å’Œé—®é¢˜
2. **å»¶è¿Ÿä¿®å¤**: è®©å¼€å‘è€…å¿½ç•¥æ ¹æœ¬åŸå› ï¼Œé—®é¢˜æ°¸è¿œå¾—ä¸åˆ°çœŸæ­£è§£å†³
3. **æŠ€æœ¯å€ºåŠ¡**: ç§¯ç´¯å¤§é‡çš„"ä¸´æ—¶æ–¹æ¡ˆ"ï¼Œæœ€ç»ˆå¯¼è‡´ä»£ç éš¾ä»¥ç»´æŠ¤
4. **ç”¨æˆ·ä½“éªŒ**: é™çº§åŠŸèƒ½å¾€å¾€ä½“éªŒä¸ä½³ï¼Œä¸å¦‚æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·
5. **æµ‹è¯•å›°éš¾**: å¢åŠ äº†æµ‹è¯•å¤æ‚åº¦ï¼Œéš¾ä»¥å‘ç°é—®é¢˜

**æ­£ç¡®çš„å¼€å‘æµç¨‹**:
1. **é‡åˆ°é—®é¢˜** â†’ **åˆ†ææ ¹æœ¬åŸå› ** â†’ **è®°å½•é—®é¢˜**
2. **å‰ç«¯é˜¶æ®µ**(Phase 1-3): åœ¨`backend/rn-update-tableandlogic.md`ä¸­è®°å½•åç«¯éœ€æ±‚
3. **åç«¯é˜¶æ®µ**(Phase 4+): å®ç°å®Œæ•´çš„åç«¯åŠŸèƒ½ï¼Œå½»åº•è§£å†³é—®é¢˜
4. **ç”¨æˆ·äº¤äº’**: å‘ç”¨æˆ·æ˜ç¡®æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯æˆ–åŠŸèƒ½çŠ¶æ€ï¼Œä¸è¦ç”¨é™çº§æ©ç›–

**ä¾‹å¤–æƒ…å†µ** (ä»…åœ¨ä»¥ä¸‹åœºæ™¯å…è®¸):
- **ç¦»çº¿æ¨¡å¼**: Appè®¾è®¡å°±æ˜¯ç¦»çº¿ä¼˜å…ˆï¼Œæœ¬åœ°å­˜å‚¨æ˜¯æ ¸å¿ƒåŠŸèƒ½
- **ç½‘ç»œä¼˜åŒ–**: é¢„åŠ è½½ã€ç¼“å­˜ç­‰æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µ
- **ä¼˜é›…é™çº§**: UIç»„ä»¶åœ¨æ—§è®¾å¤‡ä¸Šçš„æ¸²æŸ“ä¼˜åŒ–(å¦‚åŠ¨ç”»ç®€åŒ–)

ä½†å³ä½¿åœ¨è¿™äº›åœºæ™¯ï¼Œä¹Ÿå¿…é¡»:
- åœ¨è®¾è®¡æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜
- å‘ç”¨æˆ·æ¸…æ™°å±•ç¤ºå½“å‰çŠ¶æ€(å¦‚"ç¦»çº¿æ¨¡å¼")
- æä¾›å®Œæ•´çš„åŠŸèƒ½åˆ‡æ¢æœºåˆ¶

---

## ğŸš« ç¦æ­¢çš„å¼€å‘æ¨¡å¼ (Anti-Patterns)

åŸºäºå¯¹é¡¹ç›®ä»£ç çš„æ·±å…¥åˆ†æï¼Œå‘ç°äº†**8å¤§ç±»ã€67+ä¸ª"æ²»æ ‡ä¸æ²»æœ¬"çš„åæ¨¡å¼å®ä¾‹**ã€‚ä»¥ä¸‹æ˜¯å®Œæ•´çš„ç¦æ­¢è§„èŒƒå’Œæ­£ç¡®åšæ³•ã€‚

### 1. é”™è¯¯å¤„ç†è§„èŒƒ

#### âŒ ç¦æ­¢åšæ³•

**1.1 æ•è·é”™è¯¯åé™é»˜å¤±è´¥æˆ–è¿”å›å‡æ•°æ®**
```typescript
// âŒ BAD: é”™è¯¯è¢«åæ‰ï¼Œç”¨æˆ·çœ‹åˆ°å‡æ•°æ®
try {
  const data = await api.getStatistics();
  return data;
} catch (error) {
  console.error('åŠ è½½å¤±è´¥:', error);
  // è¿”å›å…¨0æ•°æ®ï¼Œç”¨æˆ·ä»¥ä¸ºçœŸçš„æ˜¯0ï¼Œå®é™…æ˜¯APIå¤±è´¥
  return { todayOutput: 0, completedBatches: 0 };
}

// âŒ BAD: Promise.allSettled æ©ç›–å…³é”®APIå¤±è´¥
const [r1, r2, r3] = await Promise.allSettled([api1(), api2(), api3()]);
const data1 = r1.status === 'fulfilled' ? r1.value : null;
// åªæ‰“å°æ—¥å¿—ï¼Œç”¨æˆ·ä¸çŸ¥é“æŸäº›æ•°æ®åŠ è½½å¤±è´¥
if (r1.status === 'rejected') {
  console.warn('APIå¤±è´¥:', r1.reason);
}
```

**1.2 æ³›å‹é”™è¯¯å¤„ç† - æ‰€æœ‰é”™è¯¯åŒæ ·å¯¹å¾…**
```typescript
// âŒ BAD: ä½¿ç”¨ any ç±»å‹ï¼Œå¤±å»ç±»å‹å®‰å…¨
catch (err: any) {
  console.error('æ“ä½œå¤±è´¥:', err);
  Alert.alert('å¤±è´¥', err.message || 'è¯·é‡è¯•');
  // ç½‘ç»œé”™è¯¯ã€è®¤è¯é”™è¯¯ã€æœåŠ¡å™¨é”™è¯¯éƒ½æ˜¾ç¤ºåŒæ ·æ¶ˆæ¯
}
```

**1.3 ç©ºcatchå—æˆ–åªæ‰“å°æ—¥å¿—**
```typescript
// âŒ BAD: é”™è¯¯è¢«å®Œå…¨å¿½ç•¥
try {
  await criticalOperation();
} catch (error) {
  // ä»€ä¹ˆéƒ½ä¸åšï¼Œæˆ–åªæ‰“å°
  console.error(error);
}
```

#### âœ… æ­£ç¡®åšæ³•

**æ–¹æ¡ˆ1: æ˜ç¡®æ˜¾ç¤ºé”™è¯¯ï¼Œä¸è¿”å›å‡æ•°æ®**
```typescript
// âœ… GOOD: æ˜¾ç¤ºé”™è¯¯çŠ¶æ€UI
try {
  const data = await api.getStatistics();
  setStatsData(data);
  setError(null);
} catch (error) {
  console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
  // ä¸è¿”å›å‡æ•°æ®ï¼Œè®¾ç½®é”™è¯¯çŠ¶æ€
  setError({
    message: 'æ— æ³•åŠ è½½ç»Ÿè®¡æ•°æ®ï¼Œè¯·ç¨åé‡è¯•',
    canRetry: true,
    onRetry: () => loadStatistics(),
  });
  setStatsData(null); // ä¸æ˜¾ç¤ºå‡æ•°æ®
}
```

**æ–¹æ¡ˆ2: åŒºåˆ†é”™è¯¯ç±»å‹ï¼Œé’ˆå¯¹æ€§å¤„ç†**
```typescript
// âœ… GOOD: æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒæç¤º
import { AxiosError } from 'axios';

try {
  await login(username, password);
} catch (error) {
  if (error instanceof AxiosError) {
    if (!error.response) {
      // ç½‘ç»œé”™è¯¯
      Alert.alert(
        'ç½‘ç»œé”™è¯¯',
        'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥',
        [{ text: 'é‡è¯•', onPress: () => retry() }]
      );
    } else if (error.response.status === 401) {
      // è®¤è¯å¤±è´¥
      Alert.alert('ç™»å½•å¤±è´¥', 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
    } else if (error.response.status >= 500) {
      // æœåŠ¡å™¨é”™è¯¯
      Alert.alert('æœåŠ¡å™¨é”™è¯¯', 'è¯·ç¨åé‡è¯•');
      reportServerError(error);
    } else {
      Alert.alert('é”™è¯¯', error.response.data?.message || 'æ“ä½œå¤±è´¥');
    }
  } else {
    Alert.alert('æœªçŸ¥é”™è¯¯', error.message);
  }
}
```

**æ–¹æ¡ˆ3: Promise.allSettled ä»…ç”¨äºéå…³é”®æ•°æ®**
```typescript
// âœ… GOOD: å…³é”®æ•°æ®å¿…é¡»æˆåŠŸï¼Œéå…³é”®æ•°æ®å¯ä»¥éƒ¨åˆ†å¤±è´¥
// å…³é”®æ•°æ® - å¿…é¡»æˆåŠŸ
const overview = await dashboardAPI.getOverview();

// éå…³é”®æ•°æ® - å¯ä»¥éƒ¨åˆ†å¤±è´¥
const [productionResult, equipmentResult] = await Promise.allSettled([
  dashboardAPI.getProduction(),
  dashboardAPI.getEquipment(),
]);

// å¤±è´¥æ—¶æ˜ç¡®æç¤ºç”¨æˆ·
if (productionResult.status === 'rejected') {
  showToast('ç”Ÿäº§æ•°æ®åŠ è½½å¤±è´¥', 'warning');
  console.error('ç”Ÿäº§æ•°æ®APIå¤±è´¥:', productionResult.reason);
}

// ä½¿ç”¨çœŸå®æ•°æ®æˆ–nullï¼Œä¸ç”¨å‡æ•°æ®
const production = productionResult.status === 'fulfilled'
  ? productionResult.value
  : null;
```

**æ–¹æ¡ˆ4: å®šä¹‰ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å™¨**
```typescript
// âœ… GOOD: ç»Ÿä¸€é”™è¯¯å¤„ç†ç­–ç•¥
enum ErrorSeverity {
  CRITICAL,  // å¿…é¡»Alertï¼ˆç™»å½•å¤±è´¥ã€æ”¯ä»˜å¤±è´¥ï¼‰
  HIGH,      // Toastæç¤ºï¼ˆæ•°æ®åŠ è½½å¤±è´¥ï¼‰
  MEDIUM,    // é¡µé¢å†…é”™è¯¯æç¤ºï¼ˆè¡¨å•éªŒè¯ï¼‰
  LOW,       // ä»…æ—¥å¿—ï¼ˆæ€§èƒ½ç›‘æ§ï¼‰
}

interface ErrorPolicy {
  severity: ErrorSeverity;
  userMessage: string;
  canRetry?: boolean;
  reportToBackend?: boolean;
}

class ErrorHandler {
  static handle(error: Error, policy: ErrorPolicy) {
    console.error(error);

    if (policy.reportToBackend) {
      reportError(error);
    }

    switch (policy.severity) {
      case ErrorSeverity.CRITICAL:
        Alert.alert('é”™è¯¯', policy.userMessage,
          policy.canRetry ? [
            { text: 'é‡è¯•', onPress: () => retry() },
            { text: 'å–æ¶ˆ' }
          ] : [{ text: 'ç¡®å®š' }]
        );
        break;
      case ErrorSeverity.HIGH:
        showToast(policy.userMessage, 'error');
        break;
      case ErrorSeverity.MEDIUM:
        setError(policy.userMessage);
        break;
      case ErrorSeverity.LOW:
        // ä»…æ—¥å¿—
        break;
    }
  }
}

// ä½¿ç”¨
try {
  await loadCriticalData();
} catch (error) {
  ErrorHandler.handle(error, {
    severity: ErrorSeverity.HIGH,
    userMessage: 'æ•°æ®åŠ è½½å¤±è´¥',
    canRetry: true,
    reportToBackend: true,
  });
}
```

---

### 2. æ•°æ®éªŒè¯è§„èŒƒ

#### âŒ ç¦æ­¢åšæ³•

**2.1 ä½¿ç”¨ `as any` ç»•è¿‡ç±»å‹æ£€æŸ¥**
```typescript
// âŒ BAD: å…³é—­TypeScriptä¿æŠ¤
const data = (response as any).data || response;
const items = data.items || [];

// âŒ BAD: å‚æ•°ä½¿ç”¨any
function processData(item: any) {
  return item.value || 0;
}
```

**2.2 è¿‡åº¦ä½¿ç”¨å¯é€‰é“¾å’Œ `||` é»˜è®¤å€¼**
```typescript
// âŒ BAD: è¯¯åˆ¤åˆæ³•çš„0ã€falseã€''
const count = data?.items?.length || 0;  // å¦‚æœlengthæ˜¯0ï¼Œè¿˜æ˜¯è¿”å›0ï¼Œæ— æ³•åŒºåˆ†
const value = obj?.prop?.subprop?.value || 'default';  // falseã€0ã€'' éƒ½ä¼šç”¨é»˜è®¤å€¼

// âŒ BAD: è¶…è¿‡2å±‚å¯é€‰é“¾ï¼Œè¡¨æ˜æ•°æ®ç»“æ„ä¸æ˜ç¡®
const deepValue = obj?.a?.b?.c?.d?.e || 'default';
```

**2.3 æœªéªŒè¯APIå“åº”ç›´æ¥ä½¿ç”¨**
```typescript
// âŒ BAD: ç›´æ¥ä½¿ç”¨ï¼Œæ²¡æœ‰éªŒè¯ç»“æ„
const response = await api.getData();
// åç«¯è¿”å›æ ¼å¼å˜äº†ï¼Œç›´æ¥crash
const total = response.data.summary.total;
```

#### âœ… æ­£ç¡®åšæ³•

**æ–¹æ¡ˆ1: ä½¿ç”¨ `??` æ›¿ä»£ `||`**
```typescript
// âœ… GOOD: åªæœ‰ null/undefined æ‰ç”¨é»˜è®¤å€¼ï¼Œ0æ˜¯åˆæ³•çš„
const count = data?.items?.length ?? 0;
const isEnabled = config?.feature?.enabled ?? false;  // false æ˜¯åˆæ³•å€¼
const username = user?.username ?? 'Guest';
```

**æ–¹æ¡ˆ2: ä½¿ç”¨ Zod è¿›è¡Œè¿è¡Œæ—¶éªŒè¯**
```typescript
// âœ… GOOD: å®šä¹‰ä¸¥æ ¼çš„schema
import { z } from 'zod';

const UserSchema = z.object({
  id: z.union([z.string(), z.number()]),
  username: z.string().min(1),
  email: z.string().email(),
  phone: z.string().optional(),
  createdAt: z.string().datetime(),
});

const DashboardSchema = z.object({
  success: z.boolean(),
  data: z.object({
    summary: z.object({
      completedBatches: z.number(),
      totalBatches: z.number(),
      onDutyWorkers: z.number(),
    }),
  }),
});

// ä½¿ç”¨æ—¶éªŒè¯
try {
  const response = await api.getDashboard();
  const validated = DashboardSchema.parse(response);

  // ç±»å‹å®‰å…¨ï¼Œæœ‰æ™ºèƒ½æç¤º
  const count = validated.data.summary.completedBatches;

} catch (error) {
  if (error instanceof z.ZodError) {
    console.error('APIå“åº”æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ:', error.errors);
    reportBackendIssue('INVALID_API_RESPONSE', error);
    setError('æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
  }
}
```

**æ–¹æ¡ˆ3: å®šä¹‰æ˜ç¡®çš„TypeScriptæ¥å£**
```typescript
// âœ… GOOD: ä¸¥æ ¼çš„ç±»å‹å®šä¹‰
interface User {
  id: string;
  username: string;
  email: string;
  phone: string | null;  // æ˜ç¡®å¯ä»¥ä¸ºnull
  createdAt: string;
}

// ä¸ä½¿ç”¨any
function transformUser(backendUser: unknown): User {
  const validated = UserSchema.parse(backendUser);
  return {
    id: validated.id.toString(),
    username: validated.username,
    email: validated.email,
    phone: validated.phone ?? null,
    createdAt: validated.createdAt,
  };
}
```

**æ–¹æ¡ˆ4: é™åˆ¶å¯é€‰é“¾æ·±åº¦**
```typescript
// âœ… GOOD: æœ€å¤š2å±‚å¯é€‰é“¾ï¼Œè¶…è¿‡è¯´æ˜æ•°æ®ç»“æ„æœ‰é—®é¢˜
const value = data?.summary?.total;  // OK

// å¦‚æœéœ€è¦æ›´æ·±å±‚æ¬¡ï¼Œå…ˆéªŒè¯
if (data?.deep?.nested?.structure) {
  const structure = data.deep.nested.structure;
  // åç»­ä¸éœ€è¦å¯é€‰é“¾
  const value = structure.value;
}
```

---

### 3. å®‰å…¨é™çº§è§„èŒƒ

#### âŒ ç¦æ­¢åšæ³•

**3.1 SecureStore â†’ AsyncStorage é™é»˜é™çº§**
```typescript
// âŒ BAD: å®‰å…¨æ€§å¤§å¹…é™ä½ä½†ç”¨æˆ·ä¸çŸ¥æƒ…
try {
  await SecureStore.setItemAsync('access_token', token);
} catch (error) {
  console.warn('SecureStore unavailable, falling back to AsyncStorage');
  // ä»ç¡¬ä»¶åŠ å¯†é™çº§åˆ°æ˜æ–‡å­˜å‚¨ï¼Œç”¨æˆ·å®Œå…¨ä¸çŸ¥é“ï¼
  await AsyncStorage.setItem('access_token', token);
}
```

**3.2 åŠŸèƒ½é™çº§ä¸é€šçŸ¥ç”¨æˆ·**
```typescript
// âŒ BAD: åŒé‡é€»è¾‘è·¯å¾„ï¼Œé™çº§é€»è¾‘æ©ç›–é—®é¢˜
if (record.status) {
  return getStatusFromField(record.status);
} else {
  // é™çº§ï¼šæ ¹æ®æ—¶é—´å­—æ®µæ¨æ–­çŠ¶æ€
  return inferStatusFromTime(record);
}
```

**3.3 APIå¤±è´¥æ—¶é™é»˜ä½¿ç”¨Mockæ•°æ®**
```typescript
// âŒ BAD: ç”¨æˆ·ä»¥ä¸ºAPIæ­£å¸¸ï¼Œå®é™…ç”¨çš„å‡æ•°æ®
try {
  const data = await api.getRealData();
  return data;
} catch (error) {
  console.error('API failed, using mock data');
  return mockData;  // é™çº§åˆ°å‡æ•°æ®
}
```

#### âœ… æ­£ç¡®åšæ³•

**æ–¹æ¡ˆ1: ä¸é™çº§ï¼Œç›´æ¥æŠ›é”™**
```typescript
// âœ… GOOD: SecureStoreä¸å¯ç”¨æ—¶æŠ¥é”™
static async storeTokens(tokens: AuthTokens): Promise<void> {
  try {
    await SecureStore.setItemAsync('access_token', tokens.accessToken);
    await SecureStore.setItemAsync('refresh_token', tokens.refreshToken);
  } catch (error) {
    // ä¸é™çº§ï¼Œç›´æ¥æŠ›å‡ºé”™è¯¯
    throw new SecurityError(
      'SecureStoreä¸å¯ç”¨ï¼Œæ— æ³•å®‰å…¨å­˜å‚¨ä»¤ç‰Œã€‚è¯·æ£€æŸ¥è®¾å¤‡è®¾ç½®ã€‚',
      'SECURE_STORAGE_UNAVAILABLE'
    );
  }
}
```

**æ–¹æ¡ˆ2: é™çº§æ—¶æ˜ç¡®é€šçŸ¥ç”¨æˆ·**
```typescript
// âœ… GOOD: é™çº§æ—¶è­¦å‘Šç”¨æˆ·å¹¶è®°å½•äº‹ä»¶
static async storeTokens(tokens: AuthTokens): Promise<void> {
  try {
    await SecureStore.setItemAsync('access_token', tokens.accessToken);
  } catch (error) {
    // è®°å½•é™çº§äº‹ä»¶
    await Analytics.logSecurityDegradation('SECURE_STORAGE_FALLBACK');

    // æ˜ç¡®è­¦å‘Šç”¨æˆ·
    Alert.alert(
      'âš ï¸ å®‰å…¨è­¦å‘Š',
      'æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒå®‰å…¨å­˜å‚¨åŠŸèƒ½ï¼Œç™»å½•ä¿¡æ¯å°†ä»¥è¾ƒä½çš„å®‰å…¨çº§åˆ«ä¿å­˜ã€‚å»ºè®®ä½¿ç”¨æ”¯æŒå®‰å…¨å­˜å‚¨çš„è®¾å¤‡ã€‚',
      [{ text: 'æˆ‘çŸ¥é“äº†', style: 'cancel' }]
    );

    // é™çº§å­˜å‚¨ï¼Œä½†æ·»åŠ é¢å¤–åŠ å¯†
    const encrypted = await encryptToken(tokens.accessToken);
    await AsyncStorage.setItem('access_token', encrypted);
  }
}
```

**æ–¹æ¡ˆ3: ç»Ÿä¸€æ•°æ®æºï¼Œä¸è¦é™çº§é€»è¾‘**
```typescript
// âœ… GOOD: ä¸¥æ ¼è¦æ±‚åç«¯è¿”å›statuså­—æ®µ
const getCurrentStatus = (record: AttendanceRecord) => {
  if (!record) {
    return { text: 'æœªçŸ¥çŠ¶æ€', color: '#999' };
  }

  // ä¸¥æ ¼è¦æ±‚statuså­—æ®µ
  if (!record.status) {
    console.error('åç«¯æ•°æ®ç¼ºå°‘statuså­—æ®µ', record);
    reportBackendDataIssue('MISSING_STATUS_FIELD', record);
    return { text: 'æ•°æ®å¼‚å¸¸', color: '#F44336' };
  }

  // å•ä¸€é€»è¾‘è·¯å¾„
  switch (record.status) {
    case 'WORKING': return { text: 'å·¥ä½œä¸­', color: '#4CAF50' };
    case 'ON_BREAK': return { text: 'ä¼‘æ¯ä¸­', color: '#FF9800' };
    case 'OFF_WORK': return { text: 'å·²ä¸‹ç­', color: '#999' };
    default:
      console.error('æœªçŸ¥çŠ¶æ€å€¼', record.status);
      return { text: 'æœªçŸ¥çŠ¶æ€', color: '#999' };
  }
};
```

**æ–¹æ¡ˆ4: Mockæ•°æ®ä»…åœ¨å¼€å‘ç¯å¢ƒ**
```typescript
// âœ… GOOD: ç”Ÿäº§ç¯å¢ƒä¸å…è®¸Mockæ•°æ®
async getFactories(params: GetFactoriesParams) {
  if (__DEV__) {
    console.warn('[DEV] ä½¿ç”¨Mockæ•°æ®ï¼Œåç«¯APIæœªå®ç°');
    return mockFactories;
  }

  // ç”Ÿäº§ç¯å¢ƒå¿…é¡»è°ƒç”¨çœŸå®API
  const response = await this.client.get('/api/factories', { params });
  return response.data;
}
```

---

### 4. é…ç½®ç®¡ç†è§„èŒƒ

#### âŒ ç¦æ­¢åšæ³•

**4.1 ç¡¬ç¼–ç è¶…æ—¶æ—¶é—´ã€é‡è¯•æ¬¡æ•°**
```typescript
// âŒ BAD: é­”æ³•æ•°å­—
setTimeout(() => retry(), 3000);
axios.get(url, { timeout: 30000 });
for (let i = 0; i < 3; i++) { retry(); }
```

**4.2 ç¡¬ç¼–ç GPSåæ ‡ã€URL**
```typescript
// âŒ BAD: æ‰€æœ‰ç”¨æˆ·éƒ½æ˜¾ç¤ºåœ¨ä¸Šæµ·æ‰“å¡
setGpsLocation({
  latitude: 31.2304,
  longitude: 121.4737,
});
```

**4.3 è§’è‰²å­—ç¬¦ä¸²ç›´æ¥æ¯”è¾ƒ**
```typescript
// âŒ BAD: æ‹¼å†™é”™è¯¯é£é™©
if (role === 'factory_super_admin' || role === 'department_admin') {
  // ...
}
```

#### âœ… æ­£ç¡®åšæ³•

**æ–¹æ¡ˆ1: é…ç½®é›†ä¸­ç®¡ç†**
```typescript
// âœ… GOOD: config/timeouts.ts
export const TIMEOUTS = {
  DEFAULT_API: 30_000,
  LONG_OPERATION: 60_000,
  FILE_UPLOAD: 120_000,
  NETWORK_CHECK: 5_000,
} as const;

export const RETRY_CONFIG = {
  MAX_ATTEMPTS: 3,
  BASE_DELAY: 1_000,
  MAX_DELAY: 10_000,
} as const;

// ä½¿ç”¨
axios.get(url, { timeout: TIMEOUTS.DEFAULT_API });
setTimeout(() => retry(), RETRY_CONFIG.BASE_DELAY);
```

**æ–¹æ¡ˆ2: ä½¿ç”¨æšä¸¾å’Œå¸¸é‡**
```typescript
// âœ… GOOD: config/roles.ts
export const ROLES = {
  PLATFORM_ADMIN: 'platform_admin',
  FACTORY_SUPER_ADMIN: 'factory_super_admin',
  DEPARTMENT_ADMIN: 'department_admin',
  OPERATOR: 'operator',
  VIEWER: 'viewer',
} as const;

export type Role = typeof ROLES[keyof typeof ROLES];

export const ADMIN_ROLES: Role[] = [
  ROLES.FACTORY_SUPER_ADMIN,
  ROLES.DEPARTMENT_ADMIN,
];

// ä½¿ç”¨
if (ADMIN_ROLES.includes(user.role)) {
  // æœ‰ç±»å‹æç¤ºï¼Œæ— æ‹¼å†™é”™è¯¯é£é™©
}
```

**æ–¹æ¡ˆ3: ç¯å¢ƒé…ç½®åˆ†ç¦»**
```typescript
// âœ… GOOD: .env.development
GPS_MOCK_ENABLED=true
GPS_DEFAULT_LAT=31.2304
GPS_DEFAULT_LNG=121.4737
API_BASE_URL=http://localhost:3001

// .env.production
GPS_MOCK_ENABLED=false
API_BASE_URL=https://api.production.com

// ä»£ç ä¸­
const getGPSLocation = async () => {
  if (process.env.GPS_MOCK_ENABLED === 'true') {
    console.warn('âš ï¸ ä½¿ç”¨Mock GPSæ•°æ®');
    return {
      latitude: parseFloat(process.env.GPS_DEFAULT_LAT!),
      longitude: parseFloat(process.env.GPS_DEFAULT_LNG!),
    };
  }

  // ç”Ÿäº§ç¯å¢ƒè·å–çœŸå®GPS
  return await Location.getCurrentPositionAsync();
};
```

---

### 5. TODOå’Œæœªå®ç°åŠŸèƒ½è§„èŒƒ

#### âŒ ç¦æ­¢åšæ³•

**5.1 ç”Ÿäº§ä»£ç åŒ…å«TODO**
```typescript
// âŒ BAD: TODOå †ç§¯è¡¨æ˜åŠŸèƒ½æœªå®Œæˆ
export class BiometricManager {
  static async authenticate(): Promise<boolean> {
    // TODO: æœªæ¥å®ç°ç”Ÿç‰©è¯†åˆ«
    return false;  // å‡å®ç°
  }
}
```

**5.2 Mockæ•°æ®å‡è£…APIå·²å®ç°**
```typescript
// âŒ BAD: è°ƒç”¨è€…ä»¥ä¸ºAPIå·²ç»é€šäº†
/**
 * TODO: åç«¯APIæœªå®ç°ï¼Œå½“å‰ä½¿ç”¨Mockæ•°æ®
 */
async getFactories() {
  return mockFactories;
}
```

#### âœ… æ­£ç¡®åšæ³•

**æ–¹æ¡ˆ1: æŠ›å‡º NotImplementedError**
```typescript
// âœ… GOOD: æ˜ç¡®å‘ŠçŸ¥åŠŸèƒ½æœªå®ç°
class NotImplementedError extends Error {
  constructor(
    message: string,
    public featureName: string,
    public metadata?: Record<string, any>
  ) {
    super(message);
    this.name = 'NotImplementedError';
  }
}

export class BiometricManager {
  static async authenticate(): Promise<boolean> {
    throw new NotImplementedError(
      'ç”Ÿç‰©è¯†åˆ«åŠŸèƒ½å°šæœªå®ç°',
      'BIOMETRIC_AUTH',
      {
        plannedPhase: 'Phase 4',
        trackingIssue: '#123',
      }
    );
  }
}
```

**æ–¹æ¡ˆ2: ä½¿ç”¨åŠŸèƒ½å¼€å…³**
```typescript
// âœ… GOOD: config/features.ts
export const FEATURES = {
  BIOMETRIC_AUTH: false,
  GPS_LOCATION: false,
  PLATFORM_MANAGEMENT: false,
  AI_ANALYSIS: true,
} as const;

// ä½¿ç”¨
import { FEATURES } from '@/config/features';

if (!FEATURES.BIOMETRIC_AUTH) {
  throw new FeatureDisabledError(
    'ç”Ÿç‰©è¯†åˆ«åŠŸèƒ½æœªå¯ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜'
  );
}

// ç»§ç»­æ‰§è¡Œå®ç°
```

**æ–¹æ¡ˆ3: Mockæ•°æ®ä»…å¼€å‘ç¯å¢ƒï¼Œç”Ÿäº§æŠ›é”™**
```typescript
// âœ… GOOD: åŒºåˆ†å¼€å‘/ç”Ÿäº§ç¯å¢ƒ
async getFactories(params: GetFactoriesParams) {
  if (__DEV__) {
    console.warn(
      '[DEV ONLY] getFactoriesä½¿ç”¨Mockæ•°æ®\n' +
      'åç«¯API: POST /api/platform/factories\n' +
      'çŠ¶æ€: æœªå®ç°\n' +
      'Issue: #456'
    );
    return mockFactories;
  }

  // ç”Ÿäº§ç¯å¢ƒå¿…é¡»è°ƒç”¨çœŸå®APIæˆ–æŠ¥é”™
  throw new NotImplementedError(
    'getFactories APIå°šæœªå®ç°',
    'PLATFORM_GET_FACTORIES'
  );
}
```

**æ–¹æ¡ˆ4: TODOå…³è”Issueè¿½è¸ª**
```typescript
// âœ… GOOD: TODOå¿…é¡»æœ‰Issueç¼–å·å’Œè´Ÿè´£äºº
// TODO(#123, @username): å®ç°GPSå®šä½åŠŸèƒ½
// é¢„è®¡å®Œæˆæ—¶é—´: Phase 3 Week 2
// ä¾èµ–: expo-location åŒ…é›†æˆ

// æ›´å¥½çš„æ–¹å¼ï¼šä¸ç”¨TODOï¼Œç›´æ¥å®ç°æˆ–æŠ›NotImplementedError
```

---

### 6. è¿”å›å€¼å’ŒçŠ¶æ€å¤„ç†è§„èŒƒ

#### âŒ ç¦æ­¢åšæ³•

**6.1 è¿”å›nullæ©ç›–é”™è¯¯åŸå› **
```typescript
// âŒ BAD: è°ƒç”¨è€…æ— æ³•åŒºåˆ†ä¸åŒå¤±è´¥åŸå› 
function getUserId(): number | null {
  if (!user) return null;  // ç”¨æˆ·æœªç™»å½•ï¼Ÿ
  if (isNaN(userId)) return null;  // IDæ ¼å¼é”™è¯¯ï¼Ÿ
  return userId;
}
```

**6.2 æ—©æœŸè¿”å›nullå¯¼è‡´é™é»˜å¤±è´¥**
```typescript
// âŒ BAD: å‡½æ•°æå‰è¿”å›ï¼Œæ²¡æœ‰é”™è¯¯æç¤º
async function loadData() {
  if (!userId) {
    console.warn('ç”¨æˆ·IDä¸å­˜åœ¨');
    return;  // é™é»˜å¤±è´¥
  }
  // ...
}
```

#### âœ… æ­£ç¡®åšæ³•

**æ–¹æ¡ˆ1: ä½¿ç”¨Resultç±»å‹**
```typescript
// âœ… GOOD: æ˜ç¡®åŒºåˆ†æˆåŠŸå’Œå¤±è´¥
type Result<T, E = string> =
  | { ok: true; value: T }
  | { ok: false; error: E };

type UserIdError = 'NO_USER' | 'INVALID_ID' | 'PARSE_ERROR';

function getUserId(): Result<number, UserIdError> {
  if (!user) {
    return { ok: false, error: 'NO_USER' };
  }

  const userId = typeof user.id === 'string'
    ? parseInt(user.id, 10)
    : user.id;

  if (isNaN(userId)) {
    return { ok: false, error: 'INVALID_ID' };
  }

  return { ok: true, value: userId };
}

// ä½¿ç”¨æ—¶å¯ä»¥é’ˆå¯¹æ€§å¤„ç†
const result = getUserId();
if (!result.ok) {
  switch (result.error) {
    case 'NO_USER':
      showError('è¯·å…ˆç™»å½•');
      navigate('Login');
      break;
    case 'INVALID_ID':
      showError('ç”¨æˆ·IDæ ¼å¼é”™è¯¯');
      reportBug('INVALID_USER_ID', { user });
      break;
    case 'PARSE_ERROR':
      showError('æ•°æ®è§£æå¤±è´¥');
      break;
  }
  return;
}

const userId = result.value;  // ç±»å‹å®‰å…¨çš„number
```

**æ–¹æ¡ˆ2: æŠ›å‡ºå…·ä½“é”™è¯¯**
```typescript
// âœ… GOOD: å®šä¹‰å…·ä½“é”™è¯¯ç±»å‹
class AuthenticationError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'AuthenticationError';
  }
}

class DataIntegrityError extends Error {
  constructor(message: string, public data?: any) {
    super(message);
    this.name = 'DataIntegrityError';
  }
}

function getUserId(): number {
  if (!user) {
    throw new AuthenticationError('ç”¨æˆ·æœªç™»å½•');
  }

  const userId = typeof user.id === 'string'
    ? parseInt(user.id, 10)
    : user.id;

  if (isNaN(userId)) {
    throw new DataIntegrityError('ç”¨æˆ·IDæ ¼å¼æ— æ•ˆ', { userId: user.id });
  }

  return userId;
}

// ä½¿ç”¨æ—¶å¯ä»¥æ•è·ç‰¹å®šé”™è¯¯
try {
  const userId = getUserId();
  await loadUserData(userId);
} catch (error) {
  if (error instanceof AuthenticationError) {
    showError('è¯·å…ˆç™»å½•');
    navigate('Login');
  } else if (error instanceof DataIntegrityError) {
    showError('æ•°æ®é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
    reportBug('DATA_INTEGRITY_ISSUE', error.data);
  } else {
    showError('æœªçŸ¥é”™è¯¯');
  }
}
```

---

### 7. ä»£ç è´¨é‡å¼ºåˆ¶è¦æ±‚

#### å¼ºåˆ¶è§„èŒƒ

1. **TypeScriptä¸¥æ ¼æ¨¡å¼**
   - æ‰€æœ‰ç”Ÿäº§ä»£ç å¿…é¡»é€šè¿‡ `strict: true`
   - å¯ç”¨ `noImplicitAny`, `strictNullChecks`, `strictFunctionTypes`

2. **ç¦æ­¢ä½¿ç”¨ `any`**
   ```typescript
   // âŒ BAD
   function process(data: any) { }
   const result = response as any;

   // âœ… GOOD
   function process(data: unknown) {
     const validated = schema.parse(data);
     // ...
   }
   ```

   **ä¾‹å¤–æƒ…å†µ**ï¼ˆå¿…é¡»æ³¨é‡Šè¯´æ˜ï¼‰:
   ```typescript
   // âœ… ACCEPTABLE: ç¬¬ä¸‰æ–¹åº“ç±»å‹ä¸å®Œæ•´
   // @ts-expect-error - react-native-paperç±»å‹å®šä¹‰ç¼ºå¤±
   const theme = useTheme() as any;
   ```

3. **æ‰€æœ‰APIè°ƒç”¨å¿…é¡»æœ‰é”™è¯¯å¤„ç†**
   ```typescript
   // âŒ BAD: æ²¡æœ‰é”™è¯¯å¤„ç†
   const data = await api.getData();

   // âœ… GOOD: æœ‰é”™è¯¯å¤„ç†
   try {
     const data = await api.getData();
     setData(data);
   } catch (error) {
     handleError(error);
   }
   ```

4. **å…³é”®åŠŸèƒ½å¿…é¡»æœ‰å•å…ƒæµ‹è¯•**
   - è®¤è¯ç›¸å…³å‡½æ•°
   - æ•°æ®éªŒè¯å‡½æ•°
   - ä¸šåŠ¡é€»è¾‘è®¡ç®—
   - è¦†ç›–ç‡ç›®æ ‡: >70%

---

## ğŸ“ Code Reviewæ£€æŸ¥æ¸…å•

### é”™è¯¯å¤„ç† (Error Handling)
- [ ] æ‰€æœ‰try-catchä½¿ç”¨å…·ä½“é”™è¯¯ç±»å‹ï¼ˆä¸æ˜¯ `any`ï¼‰
- [ ] é”™è¯¯æœ‰æ˜ç¡®çš„ç”¨æˆ·æç¤ºï¼ˆä¸åªæ˜¯console.logï¼‰
- [ ] å…³é”®æ“ä½œå¤±è´¥æ—¶é€šçŸ¥ç”¨æˆ·
- [ ] æ²¡æœ‰ç©ºçš„catchå—æˆ–åªæ‰“å°æ—¥å¿—çš„catch
- [ ] Promise.allSettledä»…ç”¨äºéå…³é”®æ•°æ®ï¼Œå¤±è´¥æœ‰æç¤º

### æ•°æ®éªŒè¯ (Data Validation)
- [ ] APIå“åº”æœ‰è¿è¡Œæ—¶éªŒè¯ï¼ˆZod/Yupï¼‰
- [ ] æ²¡æœ‰ `as any` ç±»å‹æ–­è¨€ï¼ˆæˆ–æœ‰å……åˆ†ç†ç”±å¹¶æ³¨é‡Šï¼‰
- [ ] å¯é€‰é“¾ä¸è¶…è¿‡2å±‚
- [ ] ä½¿ç”¨ `??` è€Œé `||` ä½œä¸ºé»˜è®¤å€¼
- [ ] TypeScript strictæ¨¡å¼é€šè¿‡

### é™çº§å¤„ç† (Degradation)
- [ ] é™çº§æ—¶æœ‰ç”¨æˆ·é€šçŸ¥ï¼ˆAlert/Toastï¼‰
- [ ] é™çº§äº‹ä»¶è¢«è®°å½•åˆ°Analytics
- [ ] æ²¡æœ‰SecureStoreé™é»˜é™çº§åˆ°AsyncStorage
- [ ] Promise.allSettledå¤±è´¥æœ‰ç”¨æˆ·æç¤º
- [ ] åŒºåˆ†å¼€å‘/ç”Ÿäº§ç¯å¢ƒï¼ˆMockæ•°æ®ï¼‰

### é…ç½®ç®¡ç† (Configuration)
- [ ] æ²¡æœ‰ç¡¬ç¼–ç çš„è¶…æ—¶/é‡è¯•æ¬¡æ•°
- [ ] æ²¡æœ‰ç¡¬ç¼–ç çš„GPS/URL
- [ ] è§’è‰²åˆ¤æ–­ä½¿ç”¨æšä¸¾
- [ ] æ²¡æœ‰é­”æ³•æ•°å­—ï¼ˆä½¿ç”¨å¸¸é‡ï¼‰

### TODOå’Œæœªå®ç°åŠŸèƒ½
- [ ] ç”Ÿäº§ä»£ç æ²¡æœ‰TODO/FIXME/HACK
- [ ] æœªå®ç°åŠŸèƒ½æŠ›å‡ºNotImplementedError
- [ ] Mockæ•°æ®ä»…åœ¨å¼€å‘ç¯å¢ƒ
- [ ] TODOå…³è”Issueç¼–å·

### å®‰å…¨æ€§ (Security)
- [ ] æ•æ„Ÿæ•°æ®ä½¿ç”¨SecureStore
- [ ] Tokenä¸å­˜å‚¨åœ¨AsyncStorage
- [ ] é™çº§æ—¶æœ‰å®‰å…¨è­¦å‘Š

### ç±»å‹å®‰å…¨ (Type Safety)
- [ ] TypeScriptä¸¥æ ¼æ¨¡å¼é€šè¿‡
- [ ] æ²¡æœ‰æ»¥ç”¨å¯é€‰é“¾
- [ ] APIç±»å‹æœ‰æ˜ç¡®å®šä¹‰
- [ ] æ²¡æœ‰ `any` ç±»å‹ï¼ˆæˆ–æœ‰æ³¨é‡Šè¯´æ˜ï¼‰
- [ ] å‡½æ•°è¿”å›ç±»å‹æ˜ç¡®
- [ ] ä½¿ç”¨Resultç±»å‹æˆ–æŠ›å‡ºé”™è¯¯ï¼ˆä¸è¿”å›nullï¼‰

---

## âš™ï¸ ESLintè‡ªåŠ¨åŒ–è§„åˆ™

åˆ›å»º `.eslintrc.js` è‡ªåŠ¨æ£€æµ‹åæ¨¡å¼ï¼š

```javascript
module.exports = {
  extends: [
    '@react-native-community',
    'plugin:@typescript-eslint/recommended',
  ],
  rules: {
    // ç¦æ­¢ä½¿ç”¨any
    '@typescript-eslint/no-explicit-any': 'error',

    // ç¦æ­¢ç©ºcatchå—
    'no-empty': ['error', { allowEmptyCatch: false }],

    // é™åˆ¶console.log (ç”Ÿäº§ç¯å¢ƒ)
    'no-console': process.env.NODE_ENV === 'production' ? 'error' : 'warn',

    // ç¦æ­¢TODOæ³¨é‡Š (ç”Ÿäº§ç¯å¢ƒ)
    'no-warning-comments': process.env.NODE_ENV === 'production' ? ['error', {
      terms: ['TODO', 'FIXME', 'HACK', 'XXX'],
      location: 'anywhere'
    }] : 'warn',

    // è¦æ±‚ä½¿ç”¨const
    'prefer-const': 'error',

    // ç¦æ­¢é­”æ³•æ•°å­—
    '@typescript-eslint/no-magic-numbers': ['warn', {
      ignore: [0, 1, -1],
      ignoreArrayIndexes: true,
      ignoreEnums: true,
      enforceConst: true,
    }],

    // è¦æ±‚Promiseæœ‰é”™è¯¯å¤„ç†
    '@typescript-eslint/no-floating-promises': 'error',

    // ç¦æ­¢æœªä½¿ç”¨çš„å˜é‡
    '@typescript-eslint/no-unused-vars': ['error', {
      argsIgnorePattern: '^_',
    }],

    // è¦æ±‚æ˜ç¡®çš„å‡½æ•°è¿”å›ç±»å‹
    '@typescript-eslint/explicit-function-return-type': ['warn', {
      allowExpressions: true,
      allowTypedFunctionExpressions: true,
    }],
  },
};
```

### è‡ªå®šä¹‰ESLintæ’ä»¶æ£€æµ‹é¡¹ç›®ç‰¹å®šåæ¨¡å¼

```javascript
// eslint-plugin-cretas/rules/no-silent-degradation.js
module.exports = {
  meta: {
    type: 'problem',
    docs: {
      description: 'ç¦æ­¢é™é»˜é™çº§å¤„ç†',
      category: 'Best Practices',
    },
  },
  create(context) {
    return {
      // æ£€æµ‹SecureStore â†’ AsyncStorageé™çº§
      CatchClause(node) {
        const sourceCode = context.getSourceCode();
        const catchBody = node.body.body;

        const hasSecureStoreError = node.param &&
          node.param.name.toLowerCase().includes('securestore');
        const hasAsyncStorage = catchBody.some(stmt => {
          const code = sourceCode.getText(stmt);
          return code.includes('AsyncStorage');
        });
        const hasAlert = catchBody.some(stmt => {
          const code = sourceCode.getText(stmt);
          return code.includes('Alert') || code.includes('showToast');
        });

        if (hasSecureStoreError && hasAsyncStorage && !hasAlert) {
          context.report({
            node,
            message: 'é™çº§åˆ°AsyncStorageæ—¶å¿…é¡»é€šçŸ¥ç”¨æˆ·ï¼ˆä½¿ç”¨Alertæˆ–Toastï¼‰',
          });
        }
      },

      // æ£€æµ‹Promise.allSettledåçš„é”™è¯¯å¤„ç†
      CallExpression(node) {
        if (
          node.callee.type === 'MemberExpression' &&
          node.callee.object.name === 'Promise' &&
          node.callee.property.name === 'allSettled'
        ) {
          context.report({
            node,
            message: 'ä½¿ç”¨Promise.allSettledæ—¶è¯·ç¡®ä¿å¤±è´¥æƒ…å†µæœ‰ç”¨æˆ·æç¤º',
          });
        }
      },
    };
  },
};
```

### CI/CDé›†æˆ

```yaml
# .github/workflows/code-quality.yml
name: Code Quality Check

on: [push, pull_request]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3

      - name: Install dependencies
        run: npm ci

      - name: ESLintæ£€æŸ¥
        run: npm run lint

      - name: TypeScriptä¸¥æ ¼æ¨¡å¼æ£€æŸ¥
        run: npx tsc --noEmit --strict

      - name: æ£€æµ‹TODO (ç”Ÿäº§åˆ†æ”¯)
        if: github.ref == 'refs/heads/main'
        run: |
          if grep -r "TODO\|FIXME\|HACK" frontend/CretasFoodTrace/src --exclude-dir=node_modules; then
            echo "âŒ ç”Ÿäº§ä»£ç ä¸å…è®¸åŒ…å«TODO/FIXME/HACK"
            exit 1
          fi

      - name: æ£€æµ‹ç¡¬ç¼–ç GPSåæ ‡
        run: |
          if grep -r "latitude.*31\.2304\|longitude.*121\.4737" frontend/CretasFoodTrace/src; then
            echo "âš ï¸ è­¦å‘Š: æ£€æµ‹åˆ°ç¡¬ç¼–ç GPSåæ ‡"
          fi
```

---

## ğŸ¯ ä¿®å¤ä¼˜å…ˆçº§å»ºè®®

### P0 - ç«‹å³ä¿®å¤ (å®‰å…¨å’Œæ•°æ®é—®é¢˜)

1. **SecureStoreé™çº§ä¸é€šçŸ¥ç”¨æˆ·** ğŸ”´
   - æ–‡ä»¶: `tokenManager.ts`, `apiClient.ts`
   - é£é™©: æ•æ„Ÿæ•°æ®æ˜æ–‡å­˜å‚¨
   - ä¿®å¤: è¦ä¹ˆä¸é™çº§æŠ›é”™ï¼Œè¦ä¹ˆAlerté€šçŸ¥

2. **Promise.allSettledæ©ç›–å…³é”®APIå¤±è´¥** ğŸ”´
   - æ–‡ä»¶: `QuickStatsPanel.tsx`
   - é£é™©: ç”¨æˆ·çœ‹åˆ°é”™è¯¯æ•°æ®
   - ä¿®å¤: å…³é”®æ•°æ®å¿…é¡»æˆåŠŸï¼Œå¤±è´¥æ˜ç¡®æç¤º

3. **è¿”å›å‡æ•°æ®æ©ç›–é”™è¯¯** ğŸ”´
   - æ–‡ä»¶: `QuickStatsPanel.tsx`, `ProcessingDashboard.tsx`
   - é£é™©: ç”¨æˆ·åŸºäºé”™è¯¯æ•°æ®å†³ç­–
   - ä¿®å¤: æ˜¾ç¤ºé”™è¯¯çŠ¶æ€UI

### P1 - é«˜ä¼˜å…ˆçº§ (æ ¸å¿ƒåŠŸèƒ½)

4. **ç¦æ­¢ `as any` ç»•è¿‡ç±»å‹æ£€æŸ¥** ğŸŸ¡
   - æ–‡ä»¶: æ‰€æœ‰APIè°ƒç”¨å¤„
   - ä¿®å¤: ä½¿ç”¨ZodéªŒè¯

5. **æ³›å‹é”™è¯¯å¤„ç†** ğŸŸ¡
   - æ–‡ä»¶: hooks, services
   - ä¿®å¤: åŒºåˆ†é”™è¯¯ç±»å‹

6. **ç¡¬ç¼–ç å…³é”®é…ç½®** ğŸŸ¡
   - æ–‡ä»¶: `TimeClockScreen.tsx`, `enhancedApiClient.ts`
   - ä¿®å¤: ä½¿ç”¨é…ç½®æ–‡ä»¶

### P2 - ä¸­ä¼˜å…ˆçº§ (ä»£ç è´¨é‡)

7. **TODOä»£ç æ¸…ç†** ğŸŸ 
8. **ç»Ÿä¸€é”™è¯¯æç¤º** ğŸŸ 
9. **é™åˆ¶å¯é€‰é“¾æ·±åº¦** ğŸŸ 

---

### Mobile Architecture Patterns
- **Permission-Based Navigation**: Routes dynamically adapt to user roles
- **Smart Service Loading**: Services load based on user permissions and network state
- **Biometric Integration**: Seamless fingerprint/Face ID authentication
- **Device Management**: Secure device binding with unique identification

### State Management (Zustand)
```javascript
// Core stores for React Native
/src/store/
â”œâ”€â”€ authStore.ts          // Authentication state and user management
â”œâ”€â”€ navigationStore.ts    // Navigation state and permission-based routing
â”œâ”€â”€ permissionStore.ts    // Role-based permission management
â””â”€â”€ index.ts              // Store exports and persistence configuration
```

### Modal Layout Pattern (React Native Paper)

**Standard Modal Layout for Management Screens**

All management screens with create/edit modals MUST follow this standardized layout pattern to ensure:
- âœ… All form fields visible without scrolling (for forms with up to 8 fields)
- âœ… Action buttons always visible at bottom of modal
- âœ… Consistent user experience across all management screens
- âœ… Proper ScrollView behavior for content overflow

#### Implementation Requirements

**Modal Structure**:
```typescript
<Modal
  visible={modalVisible}
  onDismiss={() => setModalVisible(false)}
  contentContainerStyle={styles.modalContent}
>
  {/* Modal title - OUTSIDE ScrollView */}
  <Text style={styles.modalTitle}>
    {editingItem ? 'ç¼–è¾‘é¡¹ç›®' : 'æ·»åŠ é¡¹ç›®'}
  </Text>

  {/* Scrollable content area */}
  <ScrollView
    style={styles.modalScrollView}
    contentContainerStyle={{ paddingBottom: 16 }}
  >
    {/* All form inputs go here */}
    <TextInput label="å­—æ®µ1" />
    <TextInput label="å­—æ®µ2" />
    {/* ... more inputs ... */}
  </ScrollView>

  {/* Action buttons - OUTSIDE ScrollView, at bottom */}
  <View style={styles.modalActions}>
    <Button mode="outlined" onPress={() => setModalVisible(false)}>
      å–æ¶ˆ
    </Button>
    <Button mode="contained" onPress={handleSave}>
      {editingItem ? 'æ›´æ–°' : 'åˆ›å»º'}
    </Button>
  </View>
</Modal>
```

**Required StyleSheet Properties**:
```typescript
const styles = StyleSheet.create({
  modalContent: {
    backgroundColor: 'white',
    padding: 20,
    margin: 20,
    borderRadius: 8,
    maxHeight: 800,  // âš ï¸ CRITICAL: Use 800px fixed height, NOT percentage
  },
  modalScrollView: {
    flexGrow: 0,      // âš ï¸ CRITICAL: Must be 0, not 1
    flexShrink: 1,    // Allows shrinking if content is small
  },
  modalActions: {
    flexDirection: 'row',
    justifyContent: 'flex-end',
    gap: 12,
    paddingTop: 16,
    marginTop: 8,
    borderTopWidth: 1,
    borderTopColor: '#e0e0e0',
  },
});
```

#### Critical Design Rules

1. **Modal Title Position**: MUST be outside `<ScrollView>` to remain visible at top
2. **Action Buttons Position**: MUST be outside `<ScrollView>` to remain fixed at bottom
3. **maxHeight Value**: MUST use `800` (fixed pixels), NOT `'85%'` or percentage values
   - Reason: Percentage heights cause layout collapse on Android
   - 800px accommodates forms with 6-8 input fields without scrolling
4. **ScrollView flexGrow**: MUST be `0`, NOT `1`
   - Reason: `flex: 1` or `flexGrow: 1` causes content to disappear
5. **ScrollView flexShrink**: MUST be `1` to allow proper sizing
6. **Content Padding**: Add `contentContainerStyle={{ paddingBottom: 16 }}` for proper spacing

#### Screens Implementing This Pattern

**å·²å®Œæˆ (Completed)**:
- âœ… MaterialTypeManagementScreen.tsx (åŸææ–™ç±»å‹ç®¡ç†)
- âœ… WhitelistManagementScreen.tsx (ç™½åå•ç®¡ç†)
- âœ… SupplierManagementScreen.tsx (ä¾›åº”å•†ç®¡ç†)
- âœ… WorkTypeManagementScreen.tsx (å·¥ç§ç®¡ç†)
- âœ… CustomerManagementScreen.tsx (å®¢æˆ·ç®¡ç†)
- âœ… UserManagementScreen.tsx (ç”¨æˆ·ç®¡ç†)

**å¾…åº”ç”¨ (To Be Applied)**:
- ğŸ”² ProductTypeManagementScreen.tsx (äº§å“ç±»å‹ç®¡ç†)
- ğŸ”² ConversionRateManagementScreen.tsx (è½¬åŒ–ç‡ç®¡ç†)
- ğŸ”² Any future management screens with create/edit modals

#### Common Issues Solved

**Issue 1: Modal content not displaying**
- âŒ Problem: Using `flex: 1` or `flexGrow: 1` on ScrollView
- âœ… Solution: Use `flexGrow: 0` and `flexShrink: 1`

**Issue 2: Buttons hidden below scrollable content**
- âŒ Problem: Buttons inside ScrollView
- âœ… Solution: Move buttons outside ScrollView in separate View

**Issue 3: Need to scroll to see last field**
- âŒ Problem: Modal height too small (e.g., `maxHeight: '85%'` or 650px)
- âœ… Solution: Use `maxHeight: 800` fixed pixels

**Issue 4: Layout collapse on Android**
- âŒ Problem: Using percentage-based heights (`'85%'`)
- âœ… Solution: Use fixed pixel values (800)

#### When to Use This Pattern

- âœ… Create/Edit modals in management screens
- âœ… Forms with 3-8 input fields
- âœ… Modals requiring action buttons (Save/Cancel)
- âœ… Any screen where users need to see all fields at once

#### When NOT to Use This Pattern

- âŒ Full-screen forms (use regular Screen instead)
- âŒ Forms with >10 fields (consider multi-step form)
- âŒ Simple confirmation dialogs (use Dialog component)
- âŒ Bottom sheets or slide-up panels (use different component)

### Error Handling
- **Backend**: Centralized middleware with mobile-optimized responses
- **Mobile**: User-friendly error messages with offline fallback
- **Logging**: Winston logger with mobile request tracking

## Testing Strategy (Phase 1-3 Frontend Focus)

### ğŸ“± React Native Frontend Testing

#### Component Testing
- **Framework**: React Native Testing Library + Jest
- **Focus Areas**: 
  - UI component rendering and behavior
  - User interaction flows (navigation, forms, buttons)
  - State management (Zustand stores)
  - Permission-based UI changes
- **Command**: `npm test` (in CretasFoodTrace directory)

#### API Interface Testing
- **Mock Data**: Use sample data to test API client interfaces
- **Network Simulation**: Test offline/online state handling
- **Error Handling**: Test API error scenarios without backend
- **Request Formation**: Verify API requests are properly formatted

#### Authentication Flow Testing
- **Login/Logout Flows**: Test complete authentication flows
- **Biometric Integration**: Test biometric authentication flows  
- **Token Management**: Test token storage and refresh logic
- **Permission Routing**: Test role-based navigation

#### Integration Testing
- **Screen Navigation**: Test navigation between screens
- **Form Validation**: Test input validation and error handling
- **Offline Functionality**: Test offline storage and sync
- **Device Features**: Test camera, GPS, notifications

### ğŸ”§ Backend Requirements Validation

#### Requirements Documentation Testing
- **Completeness Check**: Ensure all frontend needs are documented
- **API Specification**: Verify API interfaces are fully specified
- **Data Model Validation**: Check database schema requirements
- **Integration Points**: Validate frontend-backend integration points

#### Post-Development Validation (Phase 4+)
- **Backend Implementation Testing**: Validate implemented backends match requirements
- **API Contract Testing**: Ensure API responses match frontend expectations
- **End-to-End Testing**: Complete system integration testing

## Security Considerations

### Mobile Security
- **Secure Storage**: Expo SecureStore for sensitive data (tokens, biometric settings)
- **Device Binding**: Unique device identification and registration
- **Token Security**: Multi-layer token system (access, refresh, temp, device)
- **Biometric Protection**: Secure biometric authentication with fallback

### API Security
- **Mobile Middleware**: Dedicated authentication for mobile endpoints
- **Rate Limiting**: API call throttling for mobile clients
- **Permission Validation**: Real-time role verification
- **Input Sanitization**: Zod schemas for all mobile API inputs

## Performance Optimization

### Mobile Performance
- **Startup Time**: Target <3 seconds cold start
- **Memory Management**: Target <200MB steady state
- **Bundle Size**: Target <50MB APK
- **Network Optimization**: Request batching and intelligent caching

### DeepSeek LLM Optimization
- **Cost Control**: Intelligent caching (5-minute cache for similar queries)
- **Request Optimization**: Data preprocessing to reduce token usage
- **Fallback Strategy**: Basic analysis when LLM service unavailable
- **Usage Monitoring**: Real-time cost tracking and limits

## Deployment Strategy

### Mobile App Deployment
- **Development**: Expo development builds for testing
- **Staging**: Internal distribution via Expo
- **Production**: Google Play Store release with app activation
- **Enterprise**: APK distribution with activation codes

### Backend Deployment
- **Development**: Local MySQL with backend on port 3001
- **Production**: PostgreSQL on cloud platforms (Neon, Supabase)
- **API Versioning**: Mobile API versioning for backward compatibility

## Common Issues & Solutions (Phase 1-3 Focus)

### ğŸ“± React Native Development Issues

#### Expo/Metro Cache Issues
- **Clear cache**: `npx expo start --clear`
- **Reset Metro**: `npx react-native start --reset-cache`
- **Reinstall dependencies**: `rm -rf node_modules && npm install`
- **Clear Expo cache**: `expo r -c` or `expo start --clear`

#### Device/Emulator Issues
- **Android Emulator**: Ensure Android Studio and AVD properly configured
- **Network Connection**: Use `10.0.2.2:3001` for Android emulator â†’ backend
- **Permissions**: Manually grant camera, location, storage permissions in emulator settings
- **Hot Reload Issues**: Restart Expo development server if hot reload stops working

#### API Interface Development Issues
- **Backend Not Available**: Use mock data to continue frontend development
- **API Design Questions**: Document questions in `backend/rn-update-tableandlogic.md`
- **Response Format Uncertainty**: Create sample response format and document it
- **Network Error Handling**: Implement offline fallback UI for all API calls

#### State Management Issues  
- **Zustand Store Issues**: Verify store persistence configuration
- **Permission State**: Ensure permission state updates trigger UI re-renders
- **Navigation State**: Check navigation state persistence across app restarts

### ğŸ”§ Backend Service Issues (Supporting Only)

#### Backend Health Check
- **Service Status**: Run `npm run check` in backend directory
- **Database Connection**: Verify MySQL service: `sc query MySQL80` (Windows)
- **Port Conflicts**: 
  - Backend API: Ensure port 3001 is available
  - React Native Dev Server: Ensure port 3010 is available
  - MySQL: Ensure port 3306 is available
- **Health Endpoint**: Test `curl http://localhost:3001/api/mobile/health`
- **Port Check Commands (Windows)**:
  ```cmd
  netstat -ano | findstr :3001  # Backend API
  netstat -ano | findstr :3010  # React Native
  netstat -ano | findstr :3306  # MySQL
  ```

**IMPORTANT**: During Phase 1-3, do NOT attempt to fix backend issues by modifying code. Instead:
1. Document the issue in `backend/rn-update-tableandlogic.md`
2. Create workarounds in frontend if possible
3. Continue with frontend development

### ğŸ“‹ Requirements Documentation Issues

#### Missing Backend Requirements
- **Symptom**: Frontend needs API that doesn't exist
- **Solution**: 
  1. Document exact requirement in `backend/rn-update-tableandlogic.md`
  2. Include API endpoint specification
  3. Create mock data for frontend development
  4. Continue frontend development

#### Unclear API Specifications
- **Symptom**: Unsure about request/response format
- **Solution**:
  1. Research similar patterns in existing codebase
  2. Define proposed API format
  3. Document in requirements file
  4. Implement frontend assuming proposed format

### ğŸ’» Development Environment Issues

#### PowerShell Issues (Windows)
- **Primary Solution**: Use `start-backend-rn.cmd` (bypasses PowerShell entirely)
- **Alternative**: Use `SOLUTION-HUB.cmd` â†’ appropriate fix option
- **Emergency**: Use `NO-PROFILE-DEV.cmd` for immediate access
- **CRITICAL**: Never use `Add-Content` to modify PowerShell profiles

#### Git Workflow Issues
- **Branch Naming**: Use format `feature/rn-phase-X-[feature-name]`
- **Requirements Documentation**: Always commit requirement changes with feature code
- **Code Review**: Focus on API interface design and requirement documentation completeness

## Development Workflow (Phase 1-3)

### ğŸ“± React Native Frontend Development Workflow

#### Daily Development Routine
1. **Start Environment**: Run `start-backend-rn.cmd` (starts MySQL + Backend + React Native)
2. **Check Services**: Verify Expo development server is running
3. **Frontend Focus**: Develop React Native components, screens, and logic
4. **API Interface Design**: Create API client calls (without backend implementation)
5. **Requirements Documentation**: Record any needed backend changes in requirements document
6. **Code Quality**: Follow TypeScript strict mode, no `any` types
7. **Testing**: Test React Native components and user flows

#### Backend Requirements Management Workflow
1. **Identify Backend Need**: When frontend needs backend functionality
2. **Document Requirement**: Add detailed requirement to `backend/rn-update-tableandlogic.md`
3. **Design API Interface**: Create frontend API client interface
4. **Mock Response**: Use sample data for frontend development
5. **Continue Frontend**: Don't wait for backend implementation

#### Requirement Documentation Template
When adding backend requirements, include:
```markdown
### [Feature Name] - [Date]
**Frontend Context**: What frontend feature needs this
**API Endpoint**: POST/GET /api/mobile/[endpoint]
**Request Format**: JSON structure
**Response Format**: Expected response structure
**Database Changes**: New tables/fields needed
**Business Logic**: Backend logic requirements
**Priority**: High/Medium/Low
```

### Git Workflow
- **Feature Branches**: `feature/rn-phase-X-[feature-name]`
- **Commit Messages**: Use Chinese for feature descriptions
- **Code Review Focus**: 
  - React Native component quality
  - API interface design
  - Requirements documentation completeness
  - Mobile performance and UX

### Testing Accounts & Data
- **Username**: `admin`
- **Password**: `Admin@123456`
- **Test Device ID**: `test-device-123`
- **Activation Codes**: `DEV_TEST_2024`, `CRETAS_MOBILE_2024`
- **Test Factory ID**: `FAC001`
- **Test Phone**: `+86138000000000`

## Project Focus Areas (Phase 1-3: Frontend Only)

### ğŸ“± Current Development Priority: React Native Frontend

#### Phase 1 (3 weeks): Authentication System
- **Focus**: Complete React Native authentication UI and flows
- **Key Deliverables**:
  - Login/register screens with 8-role support
  - Biometric authentication integration
  - Permission-based navigation system
  - Token management and secure storage
- **Backend Requirements**: Document all auth-related backend needs in requirements file

#### Phase 2 (3 weeks): Processing Module + Smart Features
- **Focus**: React Native processing module with DeepSeek integration
- **Key Deliverables**:
  - Processing data input forms
  - AI analysis interface (with mock responses)
  - Camera integration for QR scanning
  - GPS location tracking
  - Offline data storage and sync
- **Backend Requirements**: Document processing APIs and DeepSeek integration needs

#### Phase 3 (2 weeks): App Activation & Completion
- **Focus**: App activation system and production readiness
- **Key Deliverables**:
  - Device activation flow
  - Production build optimization
  - Complete testing and QA
  - Requirements documentation review
- **Backend Requirements**: Finalize all backend requirement specifications

### ğŸ¯ Frontend-Only Success Metrics

#### Technical Performance
- **App Startup**: <3s cold start (measured in frontend)
- **Page Transitions**: <500ms navigation (React Navigation)
- **Bundle Size**: <50MB APK (Expo build)
- **Memory Usage**: <200MB steady state (React Native profiling)

#### Functional Completeness
- **UI Components**: 100% of planned screens implemented
- **User Flows**: Complete authentication, processing, navigation flows
- **API Interfaces**: All frontend API clients implemented
- **Offline Functionality**: Local storage and sync mechanisms

#### Requirements Documentation Quality
- **Backend APIs**: Complete API specifications documented
- **Database Schema**: All needed table/field changes documented
- **Business Logic**: All backend logic requirements documented
- **Integration Points**: Clear frontend-backend integration specifications

### ğŸ”„ Post-Phase 3: Backend Development

After Phase 1-3 completion:
1. **Backend Implementation**: Implement all documented requirements
2. **API Development**: Create all specified endpoints
3. **Database Updates**: Apply all schema changes
4. **Integration Testing**: Connect frontend with implemented backend
5. **Production Deployment**: Deploy complete system

This frontend-first approach ensures rapid React Native development while maintaining clear backend requirements for future implementation.