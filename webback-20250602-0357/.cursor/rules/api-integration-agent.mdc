---
description:
globs:
alwaysApply: false
---
---
description: é£Ÿå“æº¯æºç³»ç»ŸAPIé›†æˆä»£ç†è§„åˆ™ - APIå¯¹æ¥å¼€å‘æ—¶ - APIå®¢æˆ·ç«¯å°è£…æ—¶ - APIæ–‡æ¡£ç¼–å†™æ—¶ - ç¯å¢ƒåˆ‡æ¢é…ç½®æ—¶ - é”™è¯¯å¤„ç†ä¼˜åŒ–æ—¶ - APIæµ‹è¯•éªŒè¯æ—¶ - ç¡®ä¿ç±»å‹å®‰å…¨çš„APIæœåŠ¡å±‚å®ç°
globs:
alwaysApply: false
---

# é£Ÿå“æº¯æºç³»ç»ŸAPIé›†æˆä»£ç†è§„åˆ™

## ä½¿ç”¨åœºæ™¯
- **APIå¯¹æ¥å¼€å‘æ—¶** - æ— è®ºæ˜¯Mock APIè¿˜æ˜¯çœŸå®åç«¯API
- **APIå®¢æˆ·ç«¯å°è£…æ—¶** - åˆ›å»ºç±»å‹å®‰å…¨çš„APIæœåŠ¡å±‚
- **APIæ–‡æ¡£ç¼–å†™æ—¶** - åŸºäºæ ‡å‡†åŒ–æ¨¡æ¿åˆ›å»ºæ–‡æ¡£
- **ç¯å¢ƒåˆ‡æ¢é…ç½®æ—¶** - Mockç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒçš„æ— ç¼åˆ‡æ¢
- **é”™è¯¯å¤„ç†ä¼˜åŒ–æ—¶** - ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- **APIæµ‹è¯•éªŒè¯æ—¶** - ç¡®ä¿æ¥å£åŠŸèƒ½æ­£ç¡®æ€§

## ğŸ—ï¸ æ ¸å¿ƒåŸåˆ™

### ğŸ“‹ APIè®¾è®¡æ ‡å‡†
ä¸¥æ ¼éµå¾ªé£Ÿå“æº¯æºç³»ç»Ÿçš„APIè®¾è®¡è§„èŒƒï¼š

#### RESTfulæ¶æ„
- **èµ„æºå¯¼å‘**: URLä½¿ç”¨åè¯å¤æ•° (`/traces`, `/products`, `/users`)
- **HTTPè¯­ä¹‰**: GET(æŸ¥è¯¢)ã€POST(åˆ›å»º)ã€PUT(æ›´æ–°)ã€PATCH(éƒ¨åˆ†æ›´æ–°)ã€DELETE(åˆ é™¤)
- **æ ‡å‡†çŠ¶æ€ç **: 200/201/400/401/403/404/422/500
- **åˆ†é¡µæ”¯æŒ**: `?page=1&limit=20&sort=createdAt&order=desc`

#### URLç»“æ„è§„èŒƒ
```typescript
// åŸºç¡€æ¨¡å¼
/api/v1/{resource}
/api/v1/{resource}/{id}
/api/v1/{resource}/{id}/{sub-resource}

// é£Ÿå“æº¯æºå…·ä½“å®ä¾‹
/api/v1/traces                    // æº¯æºæ‰¹æ¬¡åˆ—è¡¨
/api/v1/traces/{id}              // ç‰¹å®šæ‰¹æ¬¡è¯¦æƒ…
/api/v1/traces/{id}/verify       // æ‰¹æ¬¡éªŒè¯
/api/v1/products                 // äº§å“åˆ—è¡¨
/api/v1/users/profile           // ç”¨æˆ·èµ„æ–™
```

#### å“åº”æ ¼å¼æ ‡å‡†
```typescript
// æˆåŠŸå“åº”
interface SuccessResponse<T> {
  success: true;
  data: T;
  meta?: PaginationMeta;
}

// é”™è¯¯å“åº”
interface ErrorResponse {
  success: false;
  error: {
    code: string;
    message: string;
    details?: ValidationError[];
  };
}

// åˆ†é¡µå…ƒæ•°æ®
interface PaginationMeta {
  total: number;
  page: number;
  limit: number;
  totalPages: number;
}
```

### ğŸ”§ æŠ€æœ¯å®ç°è¦æ±‚

#### TypeScriptç±»å‹å®‰å…¨
```typescript
// 1. å®šä¹‰å®Œæ•´çš„æ¥å£ç±»å‹
interface TraceResponse {
  id: string;
  batchCode: string;
  productName: string;
  status: 'ACTIVE' | 'COMPLETED' | 'CANCELLED';
  stages: ProductionStage[];
  createdAt: string;
  updatedAt: string;
}

// 2. APIå®¢æˆ·ç«¯ç±»å‹å®‰å…¨è°ƒç”¨
const trace = await apiClient.get<TraceResponse>(`/traces/${id}`);
const traces = await apiClient.get<PaginatedResponse<TraceResponse>>('/traces');

// 3. è¯·æ±‚å‚æ•°ç±»å‹å®šä¹‰
interface TraceCreateRequest {
  batchCode: string;
  productName: string;
  farmId: string;
  harvestDate: string;
}
```

#### ç¯å¢ƒæŠ½è±¡å±‚è®¾è®¡
```typescript
// ç¯å¢ƒé…ç½®æŠ½è±¡
interface ApiConfig {
  baseURL: string;
  timeout: number;
  useMockData: boolean;
  mockDelay?: number;
  retryAttempts: number;
}

// è‡ªåŠ¨ç¯å¢ƒæ£€æµ‹
export const getApiConfig = (): ApiConfig => {
  const env = process.env.NEXT_PUBLIC_API_ENV || 'mock';

  const configs = {
    mock: {
      baseURL: '/api',
      timeout: 10000,
      useMockData: true,
      mockDelay: 300,
      retryAttempts: 3
    },
    development: {
      baseURL: 'http://localhost:8000/api/v1',
      timeout: 15000,
      useMockData: false,
      retryAttempts: 3
    },
    production: {
      baseURL: 'https://api.farm.com/v1',
      timeout: 20000,
      useMockData: false,
      retryAttempts: 5
    }
  };

  return configs[env] || configs.mock;
};
```

#### æœåŠ¡å±‚å°è£…æ¨¡å¼
```typescript
// åŸºç¡€APIæœåŠ¡ç±»
export abstract class BaseApiService {
  protected apiClient: ApiClient;

  constructor(apiClient: ApiClient) {
    this.apiClient = apiClient;
  }

  protected async handleRequest<T>(request: () => Promise<T>): Promise<T> {
    try {
      return await request();
    } catch (error) {
      if (error instanceof ApiError) {
        this.handleApiError(error);
      }
      throw error;
    }
  }

  protected handleApiError(error: ApiError): void {
    // ç»Ÿä¸€é”™è¯¯å¤„ç†é€»è¾‘
    console.error(`API Error [${error.status}]:`, error.message);
  }
}

// å…·ä½“ä¸šåŠ¡æœåŠ¡å®ç°
export class TraceService extends BaseApiService {
  async getTrace(id: string): Promise<TraceResponse> {
    return this.handleRequest(() =>
      this.apiClient.get<TraceResponse>(`/traces/${id}`)
    );
  }

  async createTrace(data: TraceCreateRequest): Promise<TraceResponse> {
    return this.handleRequest(() =>
      this.apiClient.post<TraceResponse>('/traces', data)
    );
  }

  async verifyTrace(id: string, verificationCode?: string): Promise<VerificationResponse> {
    return this.handleRequest(() =>
      this.apiClient.post<VerificationResponse>(`/traces/${id}/verify`, { verificationCode })
    );
  }
}
```

### ğŸ”„ ç¯å¢ƒåˆ‡æ¢æœºåˆ¶

#### Mock APIæ”¯æŒ
```typescript
// Mockç¯å¢ƒæ ‡è¯†å’Œé…ç½®
const isMockEnv = process.env.NEXT_PUBLIC_API_ENV === 'mock';

// æœåŠ¡å·¥å‚æ¨¡å¼
export class ApiServiceFactory {
  static createTraceService(): TraceService {
    const config = getApiConfig();
    const apiClient = new ApiClient(config);

    if (config.useMockData) {
      return new MockTraceService(apiClient);
    }

    return new TraceService(apiClient);
  }
}

// MockæœåŠ¡å®ç°
class MockTraceService extends TraceService {
  async getTrace(id: string): Promise<TraceResponse> {
    // Mockç‰¹å®šé€»è¾‘ï¼Œå¦‚æ¨¡æ‹Ÿå»¶è¿Ÿ
    await this.simulateDelay();
    return super.getTrace(id);
  }

  private async simulateDelay(): Promise<void> {
    const delay = process.env.NEXT_PUBLIC_MOCK_DELAY || 300;
    await new Promise(resolve => setTimeout(resolve, Number(delay)));
  }
}
```

#### çœŸå®APIé›†æˆå‡†å¤‡
```typescript
// ç”Ÿäº§ç¯å¢ƒAPIæœåŠ¡
class ProductionTraceService extends TraceService {
  constructor(apiClient: ApiClient) {
    super(apiClient);

    // ç”Ÿäº§ç¯å¢ƒç‰¹æ®Šé…ç½®
    this.setupProductionInterceptors();
  }

  private setupProductionInterceptors(): void {
    // è¯·æ±‚ç­¾å
    this.apiClient.interceptors.request.use((config) => {
      config.headers['X-API-Key'] = process.env.NEXT_PUBLIC_API_KEY;
      return config;
    });

    // å“åº”éªŒè¯
    this.apiClient.interceptors.response.use((response) => {
      this.validateResponseSignature(response);
      return response;
    });
  }
}
```

## ğŸ¯ ä¸šåŠ¡åŸŸAPIå®ç°

### è®¤è¯æ¨¡å— (AuthService)
```typescript
export class AuthService extends BaseApiService {
  async login(credentials: LoginRequest): Promise<AuthResponse> {
    return this.handleRequest(() =>
      this.apiClient.post<AuthResponse>('/auth/login', credentials)
    );
  }

  async logout(): Promise<void> {
    return this.handleRequest(() =>
      this.apiClient.post<void>('/auth/logout')
    );
  }

  async refreshToken(): Promise<TokenResponse> {
    return this.handleRequest(() =>
      this.apiClient.post<TokenResponse>('/auth/refresh')
    );
  }

  async verifyToken(): Promise<UserProfile> {
    return this.handleRequest(() =>
      this.apiClient.get<UserProfile>('/auth/verify')
    );
  }
}
```

### æº¯æºæ¨¡å— (TraceService)
```typescript
export class TraceService extends BaseApiService {
  async getTraces(params?: TraceQueryParams): Promise<PaginatedResponse<TraceResponse>> {
    return this.handleRequest(() =>
      this.apiClient.get<PaginatedResponse<TraceResponse>>('/traces', { params })
    );
  }

  async getTraceByBatchCode(batchCode: string): Promise<TraceResponse> {
    return this.handleRequest(() =>
      this.apiClient.get<TraceResponse>(`/traces/batch/${batchCode}`)
    );
  }

  async generateQRCode(traceId: string): Promise<QRCodeResponse> {
    return this.handleRequest(() =>
      this.apiClient.post<QRCodeResponse>(`/traces/${traceId}/qr-code`)
    );
  }
}
```

### å†œä¸šæ¨¡å— (FarmingService)
```typescript
export class FarmingService extends BaseApiService {
  async getFarmingRecords(farmId: string): Promise<FarmingRecord[]> {
    return this.handleRequest(() =>
      this.apiClient.get<FarmingRecord[]>(`/farming/farms/${farmId}/records`)
    );
  }

  async createFarmingActivity(data: FarmingActivityRequest): Promise<FarmingActivity> {
    return this.handleRequest(() =>
      this.apiClient.post<FarmingActivity>('/farming/activities', data)
    );
  }

  async updateEnvironmentData(recordId: string, data: EnvironmentData): Promise<void> {
    return this.handleRequest(() =>
      this.apiClient.put<void>(`/farming/records/${recordId}/environment`, data)
    );
  }
}
```

### åŠ å·¥æ¨¡å— (ProcessingService)
```typescript
export class ProcessingService extends BaseApiService {
  async getProcessingRecords(facilityId: string): Promise<ProcessingRecord[]> {
    return this.handleRequest(() =>
      this.apiClient.get<ProcessingRecord[]>(`/processing/facilities/${facilityId}/records`)
    );
  }

  async startProcessing(data: ProcessingStartRequest): Promise<ProcessingRecord> {
    return this.handleRequest(() =>
      this.apiClient.post<ProcessingRecord>('/processing/start', data)
    );
  }

  async addQualityTest(recordId: string, data: QualityTestData): Promise<QualityTest> {
    return this.handleRequest(() =>
      this.apiClient.post<QualityTest>(`/processing/records/${recordId}/quality-tests`, data)
    );
  }
}
```

### ç‰©æµæ¨¡å— (LogisticsService)
```typescript
export class LogisticsService extends BaseApiService {
  async getLogisticsRecords(carrierId: string): Promise<LogisticsRecord[]> {
    return this.handleRequest(() =>
      this.apiClient.get<LogisticsRecord[]>(`/logistics/carriers/${carrierId}/records`)
    );
  }

  async startTransport(data: TransportStartRequest): Promise<LogisticsRecord> {
    return this.handleRequest(() =>
      this.apiClient.post<LogisticsRecord>('/logistics/transport/start', data)
    );
  }

  async updateLocation(recordId: string, location: LocationUpdate): Promise<void> {
    return this.handleRequest(() =>
      this.apiClient.put<void>(`/logistics/records/${recordId}/location`, location)
    );
  }
}
```

## ğŸ› ï¸ é”™è¯¯å¤„ç†ä¸é‡è¯•æœºåˆ¶

### ç»Ÿä¸€é”™è¯¯å¤„ç†
```typescript
export class ApiErrorHandler {
  static handle(error: ApiError): void {
    switch (error.status) {
      case 401:
        // æœªæˆæƒï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
        window.location.href = '/login';
        break;
      case 403:
        // æƒé™ä¸è¶³ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        showErrorMessage('æƒé™ä¸è¶³ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
        break;
      case 422:
        // éªŒè¯é”™è¯¯ï¼Œæ˜¾ç¤ºå…·ä½“å­—æ®µé”™è¯¯
        showValidationErrors(error.details);
        break;
      case 500:
        // æœåŠ¡å™¨é”™è¯¯ï¼Œæ˜¾ç¤ºé€šç”¨é”™è¯¯ä¿¡æ¯
        showErrorMessage('æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        break;
      default:
        showErrorMessage(error.message || 'æœªçŸ¥é”™è¯¯');
    }
  }
}
```

### è‡ªåŠ¨é‡è¯•æœºåˆ¶
```typescript
export class RetryHandler {
  static async withRetry<T>(
    operation: () => Promise<T>,
    maxRetries: number = 3,
    delay: number = 1000
  ): Promise<T> {
    let lastError: Error;

    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        return await operation();
      } catch (error) {
        lastError = error as Error;

        if (attempt === maxRetries) {
          throw lastError;
        }

        // æŒ‡æ•°é€€é¿
        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, attempt - 1)));
      }
    }

    throw lastError!;
  }
}
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨
```typescript
// 1. åˆ›å»ºAPIæœåŠ¡å®ä¾‹
const traceService = ApiServiceFactory.createTraceService();
const authService = new AuthService(apiClient);

// 2. ä½¿ç”¨æœåŠ¡
try {
  const traces = await traceService.getTraces({ page: 1, limit: 20 });
  console.log('æº¯æºè®°å½•:', traces.data);
} catch (error) {
  ApiErrorHandler.handle(error as ApiError);
}

// 3. å¸¦é‡è¯•çš„æ“ä½œ
const trace = await RetryHandler.withRetry(
  () => traceService.getTrace('trace-123'),
  3,
  1000
);
```

### ç¯å¢ƒåˆ‡æ¢
```typescript
// å¼€å‘ç¯å¢ƒé…ç½®
process.env.NEXT_PUBLIC_API_ENV = 'development';

// Mockç¯å¢ƒé…ç½®
process.env.NEXT_PUBLIC_API_ENV = 'mock';
process.env.NEXT_PUBLIC_MOCK_DELAY = '500';

// ç”Ÿäº§ç¯å¢ƒé…ç½®
process.env.NEXT_PUBLIC_API_ENV = 'production';
process.env.NEXT_PUBLIC_API_KEY = 'your-api-key';
```

## å…³é”®è§„åˆ™
- å§‹ç»ˆä½¿ç”¨TypeScriptç±»å‹å®šä¹‰ç¡®ä¿ç±»å‹å®‰å…¨
- é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶APIç¯å¢ƒåˆ‡æ¢
- å®ç°ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- éµå¾ªRESTful APIè®¾è®¡è§„èŒƒ
- ä½¿ç”¨æœåŠ¡å±‚æ¨¡å¼å°è£…APIè°ƒç”¨
- æ”¯æŒMock APIå’ŒçœŸå®APIçš„æ— ç¼åˆ‡æ¢

## ç¤ºä¾‹

<example>
**æ­£ç¡®çš„APIé›†æˆå®ç°**ï¼š

```typescript
// 1. å®šä¹‰ç±»å‹
interface UserProfile {
  id: string;
  name: string;
  email: string;
  role: 'ADMIN' | 'USER';
}

// 2. åˆ›å»ºæœåŠ¡
class UserService extends BaseApiService {
  async getProfile(): Promise<UserProfile> {
    return this.handleRequest(() =>
      this.apiClient.get<UserProfile>('/users/profile')
    );
  }
}

// 3. ä½¿ç”¨æœåŠ¡
const userService = new UserService(apiClient);
const profile = await userService.getProfile();
```
</example>

<example type="invalid">
**é”™è¯¯çš„APIé›†æˆæ–¹å¼**ï¼š

```typescript
// 1. ç¼ºå°‘ç±»å‹å®šä¹‰
const response = await fetch('/api/users/profile');
const data = await response.json(); // anyç±»å‹

// 2. æ²¡æœ‰é”™è¯¯å¤„ç†
const user = await apiClient.get('/users/profile'); // å¯èƒ½æŠ›å‡ºå¼‚å¸¸

// 3. ç¡¬ç¼–ç URL
const url = 'http://localhost:8000/api/users/profile'; // ä¸æ”¯æŒç¯å¢ƒåˆ‡æ¢
```
</example>
