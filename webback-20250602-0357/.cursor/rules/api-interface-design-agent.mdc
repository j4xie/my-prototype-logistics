---
description:
globs:
alwaysApply: false
---
---
description: é£Ÿå“æº¯æºç³»ç»ŸAPIæ¥å£è®¾è®¡è§„èŒƒ - è®¾è®¡æ–°çš„APIæ¥å£æ—¶ - ç¼–å†™æˆ–æ›´æ–°APIæ–‡æ¡£æ—¶ - è¿›è¡ŒAPIæ¶æ„è§„åˆ’æ—¶ - å‰åç«¯æ¥å£è”è°ƒæ—¶ - APIç‰ˆæœ¬å‡çº§æˆ–é‡æ„æ—¶ - ç¡®ä¿RESTfulè®¾è®¡å’Œä¸šåŠ¡æ¨¡å‹è§„èŒƒ
globs:
alwaysApply: false
---

# é£Ÿå“æº¯æºç³»ç»ŸAPIæ¥å£è®¾è®¡è§„èŒƒ

## ä½¿ç”¨åœºæ™¯
- è®¾è®¡æ–°çš„APIæ¥å£æ—¶
- ç¼–å†™æˆ–æ›´æ–°APIæ–‡æ¡£æ—¶
- è¿›è¡ŒAPIæ¶æ„è§„åˆ’æ—¶
- å‰åç«¯æ¥å£è”è°ƒæ—¶
- APIç‰ˆæœ¬å‡çº§æˆ–é‡æ„æ—¶

## å…³é”®è§„åˆ™

### ğŸ—ï¸ RESTfulè®¾è®¡åŸåˆ™
- ä¸¥æ ¼éµå¾ªRESTfulæ¶æ„é£æ ¼ï¼Œèµ„æºå¯¼å‘è®¾è®¡
- URLä½¿ç”¨åè¯å¤æ•°å½¢å¼ï¼Œé¿å…åŠ¨è¯ (å¦‚ `/traces` ä¸æ˜¯ `/getTraces`)
- HTTPæ–¹æ³•è¯­ä¹‰åŒ–ï¼šGET(æŸ¥è¯¢)ã€POST(åˆ›å»º)ã€PUT(å®Œæ•´æ›´æ–°)ã€PATCH(éƒ¨åˆ†æ›´æ–°)ã€DELETE(åˆ é™¤)
- ä½¿ç”¨æ ‡å‡†HTTPçŠ¶æ€ç ï¼š200ã€201ã€400ã€401ã€403ã€404ã€422ã€500ç­‰
- æ”¯æŒåˆ†é¡µã€æ’åºã€ç­›é€‰ï¼š`?page=1&limit=20&sort=createdAt&filter=status:active`

### ğŸ“ URLç»“æ„è§„èŒƒ
- åŸºç¡€è·¯å¾„ï¼š`/api/v1/{resource}`
- åµŒå¥—èµ„æºï¼š`/api/v1/traces/{id}/events` (æº¯æºæ‰¹æ¬¡ä¸‹çš„äº‹ä»¶)
- æŸ¥è¯¢æ“ä½œï¼š`/api/v1/traces/{id}/verify` (ç‰¹æ®ŠæŸ¥è¯¢)
- æ‰¹é‡æ“ä½œï¼š`/api/v1/traces/batch` (æ‰¹é‡å¤„ç†)
- ä½¿ç”¨kebab-caseï¼š`/api/v1/farming-records` ä¸æ˜¯ `/api/v1/farmingRecords`

### ğŸ¯ ä¸šåŠ¡åŸŸæ¨¡å‹
- **è®¤è¯åŸŸ** (`/auth`): ç™»å½•ã€æ³¨é”€ã€ä»¤ç‰Œã€æƒé™éªŒè¯
- **æº¯æºåŸŸ** (`/traces`): æº¯æºæ‰¹æ¬¡ã€æŸ¥è¯¢ã€éªŒè¯ã€äºŒç»´ç 
- **å†œä¸šåŸŸ** (`/farming`): ç§æ¤/å…»æ®–è®°å½•ã€ç¯å¢ƒæ•°æ®ã€å†œäº‹æ´»åŠ¨
- **åŠ å·¥åŸŸ** (`/processing`): ç”Ÿäº§å·¥è‰ºã€è´¨é‡æ£€æµ‹ã€è®¾å¤‡ç›‘æ§
- **ç‰©æµåŸŸ** (`/logistics`): è¿è¾“è®°å½•ã€è½¦è¾†è·Ÿè¸ªã€ä»“å‚¨ç®¡ç†
- **ç”¨æˆ·åŸŸ** (`/users`): ç”¨æˆ·ä¿¡æ¯ã€åå¥½è®¾ç½®ã€æ¶ˆæ¯é€šçŸ¥
- **ç®¡ç†åŸŸ** (`/admin`): ç³»ç»Ÿç®¡ç†ã€æƒé™é…ç½®ã€æ•°æ®ç»Ÿè®¡

### ğŸ“Š å“åº”æ•°æ®ç»“æ„
- ç»Ÿä¸€å“åº”æ ¼å¼ï¼š`{ status, data, meta, errors }`
- æˆåŠŸå“åº”ï¼š`{ status: "success", data: {...}, meta: {...} }`
- é”™è¯¯å“åº”ï¼š`{ status: "error", errors: [{code, message, field}] }`
- åˆ—è¡¨å“åº”åŒ…å«metaï¼š`{ total, page, limit, totalPages }`
- æ—¶é—´æ ¼å¼ä½¿ç”¨ISO 8601ï¼š`2023-05-21T10:30:00Z`
- é‡‘é¢ä½¿ç”¨å­—ç¬¦ä¸²é¿å…ç²¾åº¦é—®é¢˜ï¼š`"amount": "123.45"`

### ğŸ” è®¤è¯ä¸æˆæƒ
- ä½¿ç”¨JWT Bearer Tokenï¼š`Authorization: Bearer <token>`
- ä»¤ç‰ŒåŒ…å«ç”¨æˆ·IDã€è§’è‰²ã€æƒé™åˆ—è¡¨
- æ”¯æŒä»¤ç‰Œåˆ·æ–°æœºåˆ¶ï¼š`/auth/refresh`
- æƒé™æ£€æŸ¥ï¼š`read:traces`ã€`write:farms`ã€`admin:users`
- å…¬å¼€æ¥å£æ— éœ€è®¤è¯ï¼š`/traces/public/{batchCode}`

### ğŸ“ å­—æ®µå‘½åè§„èŒƒ
- ä½¿ç”¨camelCaseï¼š`createdAt`ã€`batchCode`ã€`farmingType`
- å¸ƒå°”å€¼ä½¿ç”¨is/haså‰ç¼€ï¼š`isActive`ã€`hasPermission`
- ä¸»é”®ç»Ÿä¸€ä½¿ç”¨idï¼š`{ "id": "trace-123" }`
- å¤–é”®ä½¿ç”¨å®Œæ•´åç§°ï¼š`{ "userId": "user-456", "traceId": "trace-123" }`
- æšä¸¾å€¼ä½¿ç”¨UPPER_SNAKE_CASEï¼š`"status": "IN_PROGRESS"`

### ğŸ›ï¸ æŸ¥è¯¢å‚æ•°è§„èŒƒ
- åˆ†é¡µï¼š`?page=1&limit=20` (é»˜è®¤limit=20ï¼Œæœ€å¤§100)
- æ’åºï¼š`?sort=createdAt&order=desc` (é»˜è®¤asc)
- ç­›é€‰ï¼š`?filter=status:active,type:organic`
- æœç´¢ï¼š`?search=keyword` (æ¨¡ç³Šæœç´¢)
- å­—æ®µé€‰æ‹©ï¼š`?fields=id,name,createdAt` (å‡å°‘æ•°æ®ä¼ è¾“)
- å…³è”æŸ¥è¯¢ï¼š`?include=user,location` (åŒ…å«å…³è”æ•°æ®)

### âš ï¸ é”™è¯¯å¤„ç†è§„èŒƒ
- 422éªŒè¯é”™è¯¯åŒ…å«å…·ä½“å­—æ®µä¿¡æ¯
- é”™è¯¯ç ä½¿ç”¨ä¸šåŠ¡è¯­ä¹‰ï¼š`BATCH_NOT_FOUND`ã€`INVALID_QR_CODE`
- å¤šè¯­è¨€é”™è¯¯æ¶ˆæ¯æ”¯æŒï¼š`Accept-Language: zh-CN`
- æ•æ„Ÿé”™è¯¯ä¿¡æ¯è„±æ•ï¼šä¸æš´éœ²ç³»ç»Ÿå†…éƒ¨ä¿¡æ¯
- æä¾›é”™è¯¯è§£å†³å»ºè®®ï¼š`"suggestion": "è¯·æ£€æŸ¥æ‰¹æ¬¡ç¼–ç æ ¼å¼"`

## ç¤ºä¾‹

<example>
**ä¼˜ç§€çš„APIè®¾è®¡**ï¼š

```yaml
# è·å–æº¯æºæ‰¹æ¬¡åˆ—è¡¨
GET /api/v1/traces?page=1&limit=20&sort=createdAt&filter=status:active

# å“åº”
{
  "status": "success",
  "data": [
    {
      "id": "trace-123",
      "batchCode": "2023051501",
      "productName": "æœ‰æœºè¥¿çº¢æŸ¿",
      "status": "COMPLETED",
      "farmingType": "ORGANIC",
      "createdAt": "2023-05-15T08:00:00Z",
      "location": {
        "province": "å±±ä¸œçœ",
        "city": "å¯¿å…‰å¸‚"
      }
    }
  ],
  "meta": {
    "total": 156,
    "page": 1,
    "limit": 20,
    "totalPages": 8
  }
}

# åˆ›å»ºæ–°çš„æº¯æºæ‰¹æ¬¡
POST /api/v1/traces
Content-Type: application/json
Authorization: Bearer <token>

{
  "batchCode": "2023051502",
  "productName": "æœ‰æœºé»„ç“œ",
  "farmingType": "ORGANIC",
  "plantingDate": "2023-03-01T00:00:00Z",
  "location": {
    "province": "å±±ä¸œçœ",
    "city": "å¯¿å…‰å¸‚",
    "address": "å¯¿å…‰å¸‚å†œä¸šå›­åŒºAåŒº"
  }
}
```
</example>

<example type="invalid">
**é”™è¯¯çš„APIè®¾è®¡**ï¼š

```yaml
# é”™è¯¯ï¼šä½¿ç”¨åŠ¨è¯ï¼Œéæ ‡å‡†è·¯å¾„
GET /api/getTraces?pageNum=1&pageSize=20

# é”™è¯¯ï¼šä¸ä¸€è‡´çš„å“åº”æ ¼å¼
{
  "code": 200,
  "msg": "success",
  "result": [...],
  "total": 156
}

# é”™è¯¯ï¼šå­—æ®µå‘½åä¸è§„èŒƒ
{
  "trace_id": "123",
  "batch_code": "2023051501",
  "create_time": "2023-05-15 08:00:00",
  "is_completed": 1
}

# é”™è¯¯ï¼šæ¨¡ç³Šçš„é”™è¯¯ä¿¡æ¯
{
  "code": 400,
  "message": "å‚æ•°é”™è¯¯"
}
```
</example>

## æ•°æ®æ¨¡å‹è®¾è®¡è§„èŒƒ

### ğŸŒ¾ å†œä¸šæ¨¡å—æ•°æ®æ¨¡å‹
```typescript
// å†œåœºä¿¡æ¯
interface Farm {
  id: string;
  name: string;
  location: LocationInfo;
  farmType: 'CROP' | 'LIVESTOCK' | 'MIXED';
  certifications: string[];
  ownerId: string;
  createdAt: string;
}

// ç§æ¤è®°å½•
interface FarmingRecord {
  id: string;
  farmId: string;
  traceId: string;
  cropType: string;
  variety: string;
  plantingDate: string;
  harvestDate?: string;
  area: number; // å¹³æ–¹ç±³
  environmentData: EnvironmentData[];
  activities: FarmingActivity[];
  status: 'PLANTED' | 'GROWING' | 'HARVESTED';
}
```

### ğŸ­ åŠ å·¥æ¨¡å—æ•°æ®æ¨¡å‹
```typescript
// åŠ å·¥è®°å½•
interface ProcessingRecord {
  id: string;
  traceId: string;
  facilityId: string;
  processType: string;
  rawMaterials: RawMaterial[];
  processes: ProcessStep[];
  qualityTests: QualityTest[];
  outputProducts: Product[];
  startTime: string;
  endTime?: string;
  status: 'IN_PROGRESS' | 'COMPLETED' | 'FAILED';
}
```

### ğŸš› ç‰©æµæ¨¡å—æ•°æ®æ¨¡å‹
```typescript
// è¿è¾“è®°å½•
interface LogisticsRecord {
  id: string;
  traceId: string;
  carrierId: string;
  vehicleId: string;
  route: RoutePoint[];
  temperature?: TemperatureLog[];
  humidity?: HumidityLog[];
  startTime: string;
  endTime?: string;
  status: 'PENDING' | 'IN_TRANSIT' | 'DELIVERED' | 'DELAYED';
}
```

## æ¥å£æ–‡æ¡£æ¨¡æ¿

æ¯ä¸ªAPIæ¥å£æ–‡æ¡£å¿…é¡»åŒ…å«ï¼š
1. **æ¥å£æ¦‚è¿°**ï¼šåŠŸèƒ½æè¿°ã€é€‚ç”¨åœºæ™¯
2. **è¯·æ±‚ä¿¡æ¯**ï¼šHTTPæ–¹æ³•ã€URLã€Headers
3. **è·¯å¾„å‚æ•°**ï¼šå‚æ•°åã€ç±»å‹ã€æ˜¯å¦å¿…éœ€ã€æè¿°
4. **æŸ¥è¯¢å‚æ•°**ï¼šå‚æ•°åã€ç±»å‹ã€é»˜è®¤å€¼ã€å–å€¼èŒƒå›´
5. **è¯·æ±‚ä½“**ï¼šæ•°æ®ç»“æ„ã€å­—æ®µè¯´æ˜ã€éªŒè¯è§„åˆ™
6. **å“åº”æ ¼å¼**ï¼šæˆåŠŸå“åº”ã€é”™è¯¯å“åº”ã€çŠ¶æ€ç è¯´æ˜
7. **ä¸šåŠ¡è§„åˆ™**ï¼šç‰¹æ®Šé€»è¾‘ã€æƒé™è¦æ±‚ã€é™åˆ¶æ¡ä»¶
8. **ä½¿ç”¨ç¤ºä¾‹**ï¼šå®Œæ•´çš„è¯·æ±‚/å“åº”ç¤ºä¾‹
9. **é”™è¯¯ç è¡¨**ï¼šä¸šåŠ¡é”™è¯¯ç ã€é”™è¯¯æè¿°ã€è§£å†³æ–¹æ¡ˆ

## ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥

- **URLç‰ˆæœ¬æ§åˆ¶**ï¼š`/api/v1/`, `/api/v2/`
- **å‘åå…¼å®¹åŸåˆ™**ï¼šæ–°ç‰ˆæœ¬ä¸ç ´åç°æœ‰åŠŸèƒ½
- **å­—æ®µæ‰©å±•**ï¼šæ–°å¢å­—æ®µæ ‡è®°ä¸ºå¯é€‰
- **åºŸå¼ƒæ ‡è®°**ï¼š`@deprecated` æ³¨é‡Šè¿‡æ—¶å­—æ®µ
- **è¿ç§»æŒ‡å—**ï¼šæä¾›ç‰ˆæœ¬å‡çº§æ–‡æ¡£
