# 最终实施方案 - 完整批次管理系统

## ✅ 确认的业务逻辑

### 核心流程
```
1. 原材料入库 (管理员)
   → 选择原材料类型 (MaterialTypeSelector)
   → 选择供应商 (MerchantSelector) ⭐ 必填
   → 填写数量、单价
   → 提交 → 生成原材料批次

2. 创建生产计划 (管理员)
   → 选择商家（客户）
   → 选择产品类型
   → 输入计划产量
   → 系统自动计算预估原材料消耗
   → 选择原材料批次 (MaterialBatchSelector) ⭐ 核心
   → 创建成功 → 预留批次数量

3. 员工每日记录 (员工)
   → 记录每日产量
   → 记录工作时长
   → 勾选流程问题
   → 提交 → 累计更新

4. 库存盘点 (管理员)
   → 选择批次盘点
   → 输入实际数量
   → 系统分析差异
   → 填写缺料报告

5. 数据分析 + AI (管理员)
   → 查看生产数据
   → 点击 AI 分析
   → 获取优化建议
```

---

## 📊 完整数据库设计

### 1. 原材料批次表（核心新增）

```prisma
// 原材料入库批次表
model MaterialBatch {
  id              String   @id @default(uuid())
  batchNumber     String   @unique @map("batch_number")  // MAT-20251001-001
  factoryId       String   @map("factory_id")
  materialTypeId  String   @map("material_type_id")

  // 数量信息
  inboundQuantity Decimal  @map("inbound_quantity") @db.Decimal(10, 2)  // 入库数量
  remainingQuantity Decimal @map("remaining_quantity") @db.Decimal(10, 2)  // 剩余数量
  reservedQuantity Decimal  @default(0) @map("reserved_quantity") @db.Decimal(10, 2)  // 已预留
  usedQuantity    Decimal  @default(0) @map("used_quantity") @db.Decimal(10, 2)  // 已使用

  // 成本信息
  unitPrice       Decimal  @map("unit_price") @db.Decimal(10, 2)  // 单价
  totalCost       Decimal  @map("total_cost") @db.Decimal(12, 2)  // 总成本

  // 供应商信息 ⭐ 重要
  merchantId      String   @map("merchant_id")  // 供应商ID（必填）

  // 日期信息
  inboundDate     DateTime @map("inbound_date") @db.Date  // 入库日期
  expiryDate      DateTime? @map("expiry_date") @db.Date  // 保质期
  productionDate  DateTime? @map("production_date") @db.Date  // 生产日期

  // 状态
  status          BatchInventoryStatus @default(available) @map("status")
  // available - 可用
  // reserved - 已预留
  // depleted - 已用完
  // expired - 已过期

  // 质量信息
  qualityGrade    String?  @map("quality_grade")  // 质量等级: A/B/C
  qualityReport   Json?    @map("quality_report")  // 质检报告
  storageLocation String?  @map("storage_location")  // 存储位置

  // 其他信息
  notes           String?  @db.Text
  createdBy       Int      @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // 关联关系
  factory         Factory         @relation(fields: [factoryId], references: [id], onDelete: Cascade)
  materialType    RawMaterialType @relation(fields: [materialTypeId], references: [id])
  merchant        Merchant        @relation(fields: [merchantId], references: [id])  // 供应商关联
  creator         User            @relation(fields: [createdBy], references: [id])

  // 使用记录
  planUsages      ProductionPlanBatchUsage[]
  adjustments     MaterialBatchAdjustment[]  // 库存调整记录

  @@index([factoryId, materialTypeId, status])
  @@index([inboundDate])
  @@index([expiryDate])
  @@index([merchantId])  // 供应商索引
  @@index([status, expiryDate])  // 状态和保质期联合索引
  @@map("material_batches")
}

// 批次库存状态枚举
enum BatchInventoryStatus {
  available  // 可用
  reserved   // 已预留
  depleted   // 已用完
  expired    // 已过期

  @@map("batch_inventory_status")
}

// 生产计划-批次使用关联表
model ProductionPlanBatchUsage {
  id                String   @id @default(uuid())
  productionPlanId  String   @map("production_plan_id")
  materialBatchId   String   @map("material_batch_id")
  plannedQuantity   Decimal  @map("planned_quantity") @db.Decimal(10, 2)  // 计划使用
  actualQuantity    Decimal? @map("actual_quantity") @db.Decimal(10, 2)   // 实际使用
  unitPrice         Decimal  @map("unit_price") @db.Decimal(10, 2)        // 锁定单价
  totalCost         Decimal  @map("total_cost") @db.Decimal(12, 2)        // 锁定成本
  createdAt         DateTime @default(now()) @map("created_at")

  productionPlan ProductionPlan @relation(fields: [productionPlanId], references: [id], onDelete: Cascade)
  materialBatch  MaterialBatch  @relation(fields: [materialBatchId], references: [id])

  @@unique([productionPlanId, materialBatchId])
  @@index([productionPlanId])
  @@index([materialBatchId])
  @@map("production_plan_batch_usages")
}

// 批次库存调整记录表（可选）
model MaterialBatchAdjustment {
  id              String   @id @default(uuid())
  materialBatchId String   @map("material_batch_id")
  adjustmentType  String   @map("adjustment_type")  // loss / damage / correction
  quantity        Decimal  @db.Decimal(10, 2)       // 调整数量（+ 或 -）
  reason          String   @db.Text                 // 调整原因
  adjustedBy      Int      @map("adjusted_by")
  adjustedAt      DateTime @default(now()) @map("adjusted_at")

  materialBatch MaterialBatch @relation(fields: [materialBatchId], references: [id])
  adjuster      User          @relation(fields: [adjustedBy], references: [id])

  @@index([materialBatchId])
  @@index([adjustedAt])
  @@map("material_batch_adjustments")
}

// Merchant 表需要添加关联（在原有基础上）
model Merchant {
  // ... 原有字段

  materialBatches MaterialBatch[]  // 新增：关联原材料批次
}
```

---

## 🎬 完整操作流程（包含供应商）

### 场景1: 原材料入库（完整版）

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第1步: 登录
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

用户: super_admin
密码: 123456

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第2步: 进入原材料入库界面
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

导航: 管理 → 库存管理 → 原材料入库
点击: [+ 新增入库]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第3步: 填写入库信息（完整表单）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌──────────────────────────────────┐
│ 原材料入库                [X 关闭]│
├──────────────────────────────────┤
│ 📦 基本信息                       │
├──────────────────────────────────┤
│                                  │
│ 原材料类型 *                     │
│ ┌────────────────────────────┐  │
│ │ 选择原材料类型 ▼           │  │ ← MaterialTypeSelector
│ └────────────────────────────┘  │
└──────────────────────────────────┘

点击后弹出 MaterialTypeSelector:
┌──────────────────────────────────┐
│ 选择原材料类型            [取消] │
├──────────────────────────────────┤
│ 🔍 搜索原材料...                 │
├──────────────────────────────────┤
│ • 鲈鱼 (淡水鱼)               ✓  │ ← 选择
│ • 带鱼 (海水鱼)                  │
│ • 黄花鱼 (海水鱼)                │
│ • 大虾 (虾蟹类)                  │
│                                  │
│ ↓ 滚动到底部 ↓                  │
│ ➕ 找不到？点击添加新原材料类型  │ ← 如需添加新类型
└──────────────────────────────────┘

选择后继续填写:
┌──────────────────────────────────┐
│ 原材料入库                [X 关闭]│
├──────────────────────────────────┤
│ 📦 基本信息                       │
├──────────────────────────────────┤
│ 原材料类型 *                     │
│ 鲈鱼 ✓                           │
│                                  │
│ 供应商 * ⭐ 重要                 │
│ ┌────────────────────────────┐  │
│ │ 选择供应商 ▼               │  │ ← MerchantSelector (类似MaterialTypeSelector)
│ └────────────────────────────┘  │
└──────────────────────────────────┘

点击后弹出 MerchantSelector:
┌──────────────────────────────────┐
│ 选择供应商                [取消] │
├──────────────────────────────────┤
│ 🔍 搜索供应商...                 │
├──────────────────────────────────┤
│ • 海鲜批发市场 (MER001)       ✓  │ ← 选择
│   陈老板 +8613700000001          │
│   主营: 海鲜批发                 │
│                                  │
│ • 大润发超市 (MER002)            │
│   王采购 +8613700000002          │
│   主营: 连锁超市                 │
│                                  │
│ ↓ 滚动到底部 ↓                  │
│ ➕ 找不到？点击添加新供应商      │ ← 快捷添加供应商
└──────────────────────────────────┘

继续填写完整信息:
┌──────────────────────────────────┐
│ 原材料入库                [X 关闭]│
├──────────────────────────────────┤
│ 📦 基本信息                       │
├──────────────────────────────────┤
│ 原材料类型 *                     │
│ 鲈鱼 ✓                           │
│                                  │
│ 供应商 *                         │
│ 海鲜批发市场 (陈老板) ✓          │
│                                  │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│ 💰 数量和价格                    │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                  │
│ 入库数量 (kg) *                  │
│ ┌────────────────────────────┐  │
│ │ 1000                       │  │
│ └────────────────────────────┘  │
│                                  │
│ 单价 (元/kg) *                   │
│ ┌────────────────────────────┐  │
│ │ 5.0                        │  │
│ └────────────────────────────┘  │
│                                  │
│ 总成本 (自动计算)                │
│ ┌────────────────────────────┐  │
│ │ ¥5000                      │  │ ← 1000 × 5.0
│ └────────────────────────────┘  │
│                                  │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│ 📅 日期信息                      │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                  │
│ 入库日期 *                       │
│ 2025-10-01                       │
│                                  │
│ 生产日期                         │
│ 2025-09-30 (可选)                │
│                                  │
│ 保质期                           │
│ 2025-10-08 (7天)                 │
│                                  │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│ 📋 其他信息                      │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                  │
│ 质量等级                         │
│ ┌────────────────────────────┐  │
│ │ A级 ▼                      │  │
│ └────────────────────────────┘  │
│                                  │
│ 存储位置                         │
│ ┌────────────────────────────┐  │
│ │ 冷库A-1区                  │  │
│ └────────────────────────────┘  │
│                                  │
│ 备注                             │
│ ┌────────────────────────────┐  │
│ │ 鲈鱼质量很好，活鱼新鲜      │  │
│ └────────────────────────────┘  │
│                                  │
│        [取消]  [提交入库]        │
└──────────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第4步: 提交成功
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

系统自动生成:
┌──────────────────────────────────┐
│ ✅ 入库成功                       │
├──────────────────────────────────┤
│ 批次号: MAT-20251001-001         │
│ 原材料: 鲈鱼                     │
│ 数量: 1000 kg                    │
│ 供应商: 海鲜批发市场 (陈老板)    │
│ 成本: ¥5000                      │
│                                  │
│ 📊 库存更新:                     │
│ 鲈鱼总库存: 0kg → 1000kg         │
│                                  │
│ [查看批次] [继续入库] [关闭]     │
└──────────────────────────────────┘

数据库记录:
MaterialBatch {
  batchNumber: "MAT-20251001-001"
  materialTypeId: "鲈鱼ID"
  inboundQuantity: 1000
  remainingQuantity: 1000
  reservedQuantity: 0
  usedQuantity: 0
  unitPrice: 5.0
  totalCost: 5000
  merchantId: "海鲜批发市场ID" ⭐
  inboundDate: 2025-10-01
  expiryDate: 2025-10-08
  status: "available"
  qualityGrade: "A"
  storageLocation: "冷库A-1区"
}
```

---

### 场景2: 创建生产计划（选择批次）

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
前置条件: 已有多个批次
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

当前库存:
批次A: MAT-20251001-001 - 1000kg ¥5/kg   (供应商: 陈老板)
批次B: MAT-20251003-002 - 800kg  ¥4.8/kg (供应商: 王采购)
批次C: MAT-20251005-003 - 1200kg ¥5.2/kg (供应商: 陈老板)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第1步: 创建计划基本信息
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

导航: 管理 → 生产计划管理 → [+ 新建]

┌──────────────────────────────────┐
│ 新建生产计划              [X 关闭]│
├──────────────────────────────────┤
│ 📋 订单信息                       │
├──────────────────────────────────┤
│                                  │
│ 商家（客户）*                     │
│ ┌────────────────────────────┐  │
│ │ 王老板 ▼                   │  │ ← 选择客户
│ └────────────────────────────┘  │
│                                  │
│ 产品类型 *                       │
│ ┌────────────────────────────┐  │
│ │ 鲈鱼片 ▼                   │  │
│ └────────────────────────────┘  │
│                                  │
│ 计划产量 (kg) *                  │
│ ┌────────────────────────────┐  │
│ │ 500                        │  │
│ └────────────────────────────┘  │
└──────────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第2步: 系统自动计算
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

界面自动展开:
┌──────────────────────────────────┐
│ 💡 系统自动计算                   │
├──────────────────────────────────┤
│ 查询转换率配置:                  │
│ 鲈鱼 → 鲈鱼片                    │
│ • 转换率: 50%                    │
│ • 损耗率: 5%                     │
│                                  │
│ 计算预估消耗:                    │
│ • 基础需求: 500 ÷ 0.5 = 1000kg  │
│ • 含损耗: 1000 × 1.05 = 1050kg  │
│                                  │
│ ✅ 预估需要: 1050 kg 鲈鱼        │
└──────────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第3步: 选择原材料批次 ⭐ 核心
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌──────────────────────────────────┐
│ 原材料批次选择 *                  │
│                          [帮助]  │
├──────────────────────────────────┤
│ 原材料: 鲈鱼                     │
│ 需要总量: 1050 kg                │
│                                  │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│ 📦 可用批次（3个）               │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                  │
│ ┌──────────────────────────────┐ │
│ │ ☑ 批次A: MAT-20251001-001   │ │ ← 勾选
│ │━━━━━━━━━━━━━━━━━━━━━━━━━━│ │
│ │ 📊 详细信息:                │ │
│ │ • 可用: 1000 kg             │ │
│ │ • 单价: ¥5.0/kg             │ │
│ │ • 供应商: 海鲜批发市场 ⭐   │ │ ← 显示供应商
│ │   (陈老板 138****0001)      │ │
│ │ • 入库: 2025-10-01          │ │
│ │ • 保质期: 2025-10-08        │ │
│ │   ⚠️ 剩余 2天！            │ │ ← 保质期预警
│ │ • 质量: A级                 │ │
│ │ • 存储: 冷库A-1区           │ │
│ │                             │ │
│ │ 使用数量 (kg): *            │ │
│ │ ┌─────────────────────────┐ │ │
│ │ │ 1000                    │ │ │ ← 输入数量
│ │ └─────────────────────────┘ │ │
│ │                             │ │
│ │ 💰 成本: ¥5000              │ │ ← 自动计算
│ └──────────────────────────────┘ │
│                                  │
│ ┌──────────────────────────────┐ │
│ │ ☑ 批次B: MAT-20251003-002   │ │ ← 勾选
│ │━━━━━━━━━━━━━━━━━━━━━━━━━━│ │
│ │ 📊 详细信息:                │ │
│ │ • 可用: 800 kg              │ │
│ │ • 单价: ¥4.8/kg             │ │
│ │ • 供应商: 大润发超市 ⭐     │ │ ← 显示供应商
│ │   (王采购 138****0002)      │ │
│ │ • 入库: 2025-10-03          │ │
│ │ • 保质期: 2025-10-10        │ │
│ │   ✓ 剩余 4天               │ │
│ │ • 质量: A级                 │ │
│ │                             │ │
│ │ 使用数量 (kg): *            │ │
│ │ ┌─────────────────────────┐ │ │
│ │ │ 50                      │ │ │ ← 输入数量
│ │ └─────────────────────────┘ │ │
│ │                             │ │
│ │ 💰 成本: ¥240               │ │
│ └──────────────────────────────┘ │
│                                  │
│ ┌──────────────────────────────┐ │
│ │ ☐ 批次C: MAT-20251005-003   │ │ ← 不勾选
│ │   鲈鱼 1200kg ¥5.2/kg        │ │
│ │   供应商: 海鲜批发市场       │ │
│ │   保质期: 2025-10-12         │ │
│ └──────────────────────────────┘ │
│                                  │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│ 📊 统计汇总                      │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                  │
│ ✅ 已选数量: 1050 kg (满足)      │
│    需要数量: 1050 kg             │
│                                  │
│ 💰 原材料成本:                   │
│    ┌────────────────────────┐   │
│    │ 批次A: ¥5000           │   │
│    │ 批次B: ¥240            │   │
│    │ ────────────────       │   │
│    │ 合计: ¥5240            │   │ ← 精准成本
│    │ 平均: ¥4.99/kg         │   │
│    └────────────────────────┘   │
│                                  │
│ 📦 供应商分布:                   │
│    • 海鲜批发市场: 1000kg (95%)  │ ← 供应商统计
│    • 大润发超市: 50kg (5%)       │
│                                  │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│ 💡 智能推荐                      │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                  │
│ 当前选择: 先进先出方案 ✓         │
│                                  │
│ 其他方案:                        │
│ • 成本最优: ¥5090 (省¥150)      │
│   但批次A可能过期 ⚠️            │
│                                  │
│ [查看其他方案] [确认选择]        │
└──────────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第4步: 确认并创建
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

点击 [确认选择]

返回生产计划表单，看到完整信息:
┌──────────────────────────────────┐
│ 新建生产计划              [X 关闭]│
├──────────────────────────────────┤
│ 商家: 王老板 ✓                   │
│ 产品: 鲈鱼片 ✓                   │
│ 计划产量: 500 kg ✓               │
│                                  │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                  │
│ 原材料批次: ✓                    │
│ • 批次A (1000kg) ¥5000           │
│   供应商: 海鲜批发市场            │
│ • 批次B (50kg) ¥240              │
│   供应商: 大润发超市              │
│ 总计: 1050kg ¥5240               │
│                                  │
│ 预计完成: 2025-10-12             │
│                                  │
│ 备注                             │
│ ┌────────────────────────────┐  │
│ │ 王老板订单，优先处理        │  │
│ └────────────────────────────┘  │
│                                  │
│        [取消]  [创建计划]        │ ← 点击创建
└──────────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
第5步: 创建成功
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

系统自动处理:
✅ 生成计划号: #2025051
✅ 保存批次使用记录:
   ProductionPlanBatchUsage {
     planId: #2025051
     batchId: MAT-20251001-001
     quantity: 1000
     unitPrice: 5.0
     totalCost: 5000
   }
   ProductionPlanBatchUsage {
     planId: #2025051
     batchId: MAT-20251003-002
     quantity: 50
     unitPrice: 4.8
     totalCost: 240
   }

✅ 更新批次状态:
   批次A:
   - reservedQuantity: 0 → 1000
   - remainingQuantity: 1000 → 0
   - status: available → depleted

   批次B:
   - reservedQuantity: 0 → 50
   - remainingQuantity: 800 → 750
   - status: available → reserved

✅ 更新总库存:
   鲈鱼总库存: 3000kg
   已分配: 1050kg
   可用: 1950kg

成功提示:
┌──────────────────────────────────┐
│ ✅ 生产计划创建成功               │
├──────────────────────────────────┤
│ 计划号: #2025051                 │
│ 产品: 鲈鱼片 500kg               │
│ 商家: 王老板                     │
│                                  │
│ 原材料:                          │
│ • 批次A: 1000kg (供应商: 陈老板)  │
│ • 批次B: 50kg (供应商: 王采购)   │
│ 原材料成本: ¥5240                │
│                                  │
│ 预计完成: 2025-10-12             │
│                                  │
│ [查看详情] [关闭]                │
└──────────────────────────────────┘
```

---

## 📊 数据追溯示例

### 完整的追溯链条

```
产品问题追溯:

客户投诉: 鲈鱼片有质量问题

第1步: 查询生产计划
批次#2025051 → 鲈鱼片 500kg → 王老板

第2步: 查询使用的原材料批次
ProductionPlanBatchUsage 记录:
├─ 批次A: MAT-20251001-001 (1000kg)
└─ 批次B: MAT-20251003-002 (50kg)

第3步: 查询批次详情
批次A详情:
├─ 供应商: 海鲜批发市场 (陈老板) ⭐
├─ 联系方式: +8613700000001
├─ 入库日期: 2025-10-01
├─ 生产日期: 2025-09-30
├─ 保质期: 2025-10-08
├─ 质量等级: A级
└─ 质检报告: {...}

批次B详情:
├─ 供应商: 大润发超市 (王采购) ⭐
├─ 联系方式: +8613700000002
├─ 入库日期: 2025-10-03
└─ 质量等级: A级

第4步: 定位问题
分析: 批次A已接近保质期（入库7天后）
可能原因: 原材料不够新鲜

第5步: 采取行动
✅ 联系供应商陈老板
✅ 要求赔偿或换货
✅ 调整策略: 减少从该供应商采购
✅ 更新供应商评级
```

---

## 🎨 组件复用：MerchantSelector

### 快捷添加供应商

```
类似 MaterialTypeSelector 的设计:

┌──────────────────────────────────┐
│ 选择供应商                [取消] │
├──────────────────────────────────┤
│ 🔍 搜索供应商...                 │
├──────────────────────────────────┤
│ • 海鲜批发市场 (MER001)          │
│   陈老板 +8613700000001          │
│                                  │
│ • 大润发超市 (MER002)            │
│   王采购 +8613700000002          │
│                                  │
│ ↓ 滚动到底部 ↓                  │
├──────────────────────────────────┤
│ ┌────────────────────────────┐  │
│ │ ➕ 找不到？点击添加新供应商 │  │ ← 蓝色按钮
│ └────────────────────────────┘  │
└──────────────────────────────────┘

点击后展开:
┌──────────────────────────────────┐
│ 添加新供应商                     │
├──────────────────────────────────┤
│ 供应商名称 *                     │
│ ┌────────────────────────────┐  │
│ │ 新鲜海产供应商              │  │
│ └────────────────────────────┘  │
│                                  │
│ 供应商代码 *                     │
│ ┌────────────────────────────┐  │
│ │ MER003                     │  │
│ └────────────────────────────┘  │
│                                  │
│ 联系人                           │
│ ┌────────────────────────────┐  │
│ │ 李老板                      │  │
│ └────────────────────────────┘  │
│                                  │
│ 联系电话                         │
│ ┌────────────────────────────┐  │
│ │ +8613800000003             │  │
│ └────────────────────────────┘  │
│                                  │
│ 业务类型                         │
│ ┌────────────────────────────┐  │
│ │ 海鲜批发 ▼                 │  │
│ └────────────────────────────┘  │
│                                  │
│        [取消]  [保存]            │
└──────────────────────────────────┘

保存后:
✅ 供应商已添加
✅ 自动选中
✅ 返回入库表单
```

---

## 🗂️ 需要实现的组件清单

### 新增组件

1. **MaterialBatchSelector** ⭐ 核心
   - 显示可用批次列表
   - 多选 + 输入数量
   - 实时计算成本
   - 智能推荐方案
   - 保质期预警

2. **MerchantSelector** (类似 MaterialTypeSelector)
   - 显示供应商列表
   - 搜索功能
   - 快捷添加新供应商
   - 显示联系方式

3. **BatchInventoryView**
   - 查看所有批次
   - 按原材料类型分组
   - 显示剩余量、保质期
   - 状态筛选

---

## 📋 完整的字段清单

### 原材料入库表单字段

| 字段 | 类型 | 必填 | 组件 | 说明 |
|------|------|------|------|------|
| 原材料类型 | 选择 | ✅ | MaterialTypeSelector | 鲈鱼、带鱼等 |
| 供应商 | 选择 | ✅ | MerchantSelector | 供应商信息 ⭐ |
| 入库数量 | 数字 | ✅ | TextInput | kg |
| 单价 | 数字 | ✅ | TextInput | 元/kg |
| 总成本 | 数字 | - | 自动计算 | 数量×单价 |
| 入库日期 | 日期 | ✅ | DatePicker | 默认今天 |
| 生产日期 | 日期 | ❌ | DatePicker | 可选 |
| 保质期 | 日期 | ❌ | DatePicker | 可选 |
| 质量等级 | 选择 | ❌ | Picker | A/B/C级 |
| 存储位置 | 文本 | ❌ | TextInput | 冷库A-1区 |
| 备注 | 文本 | ❌ | TextInput | 多行 |

### 生产计划表单字段

| 字段 | 类型 | 必填 | 组件 | 说明 |
|------|------|------|------|------|
| 商家 | 选择 | ✅ | MerchantSelector | 客户（王老板）|
| 产品类型 | 选择 | ✅ | ProductTypeSelector | 鲈鱼片等 |
| 计划产量 | 数字 | ✅ | TextInput | kg |
| 预估消耗 | 显示 | - | 自动计算 | 基于转换率 |
| 原材料批次 | 选择 | ✅ | MaterialBatchSelector ⭐ | 多选批次 |
| 预计完成日期 | 日期 | ❌ | DatePicker | 可选 |
| 备注 | 文本 | ❌ | TextInput | 多行 |

---

## 🎯 总结：供应商的重要性

### 为什么必须记录供应商？

1. **质量追溯**
   ```
   产品有问题 → 追溯到批次 → 追溯到供应商
   → 联系供应商处理
   ```

2. **成本分析**
   ```
   供应商A: 平均¥5.0/kg
   供应商B: 平均¥4.8/kg
   → 供应商B更有价格优势
   ```

3. **供应商评估**
   ```
   陈老板:
   - 共采购10批次
   - 质量问题: 2次 (20%)
   - 评级: B

   王采购:
   - 共采购8批次
   - 质量问题: 0次 (0%)
   - 评级: A+

   → 优先从王采购采购
   ```

4. **采购优化**
   ```
   数据分析:
   • 供应商A: 平均交货3天，质量A级，价格中等
   • 供应商B: 平均交货1天，质量A级，价格最低 ⭐
   • 供应商C: 平均交货5天，质量B级，价格最高

   决策: 优先选择供应商B
   ```

---

## 📚 文档已创建

**BATCH_BASED_INVENTORY_DESIGN.md** - 包含：
- ✅ 完整的批次管理设计
- ✅ MaterialBatch 表结构（包含 merchantId）
- ✅ MaterialBatchSelector 组件设计
- ✅ 完整的业务流程示例
- ✅ 供应商追溯流程

---

## 🚀 下一步

需要我开始实现吗？包括：

1. **更新 Prisma Schema**
   - MaterialBatch 表（含 merchantId）
   - ProductionPlanBatchUsage 表
   - 相关枚举和关联

2. **创建组件**
   - MaterialBatchSelector ⭐
   - MerchantSelector（类似 MaterialTypeSelector）

3. **后端API**
   - 批次管理CRUD
   - 批次查询和推荐
   - 供应商管理

要开始实施吗？