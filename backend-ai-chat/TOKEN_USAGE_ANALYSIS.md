# 🔢 白垩纪 AI 成本分析 - Token 使用量分析

## 📊 Token 消耗估算

### 单次分析的 Token 组成

#### 1. System Prompt (系统提示 - 仅首次)
```
约 350 tokens (中文)
```

**内容**:
- AI 角色定位
- 4 大核心任务说明
- 回复要求
- 示例场景

#### 2. User Prompt (用户输入 - 每次)

**典型批次成本数据**:
```
**批次信息**：
- 批次号: BATCH_20251003_00001
- 原材料: 大黄鱼 500kg
- 原材料成本: ¥2000.00 (4.00元/kg)
- 产品类别: 鲜品
- 预期售价: ¥12/kg

**成本结构**：
- 原材料成本: ¥2000.00 (55.6%)
- 人工成本: ¥1200.00 (33.3%)
- 设备成本: ¥400.00 (11.1%)
- 其他成本: ¥0.00 (0.0%)
- **总成本**: ¥3600.00

**人工统计**：
- 参与员工: 8人
- 总工时: 6小时0分钟
- 人工成本: ¥1200.00
- 员工明细: 张三(2h, ¥400), 李四(1.5h, ¥300), 王五(1h, ¥200), ...

**设备统计**：
- 使用设备: 3台
- 总使用时长: 4小时30分钟
- 设备成本: ¥400.00
- 设备明细: 切割机(2h, ¥200), 冷藏柜(2h, ¥150), ...

**利润分析**：
- 预期收入: ¥6000.00
- 利润: ¥2400.00 (40.0%)
- 盈亏平衡价: ¥7.20/kg

请分析：
1. 成本结构是否合理？
2. 有哪些优化空间？
3. 具体改进建议是什么？
```

**Token 估算**: 约 **400-500 tokens** (中文)

#### 3. AI Response (AI 回复 - 每次)

**典型回复**:
```
根据提供的成本数据分析：

1. **成本结构分析**：
   ✅ 原材料成本占比 55.6%，属于水产加工行业的合理范围（50-60%）
   ⚠️  人工成本占比 33.3%，略高于行业平均水平（25-30%）
   ✅ 设备成本占比 11.1%，控制良好

   总体评估：成本结构基本合理，但人工成本有优化空间。

2. **优化建议**：

   **人工成本优化**（优先级：高）：
   - 当前8名员工，总工时6小时，人均0.75小时
   - 建议：优化人员配置，减少1-2名操作工，或延长工作时长提高效率
   - 预期效果：人工成本可降至¥1000（占比27.8%），节省¥200

   **生产效率提升**：
   - 分析员工明细，张三工作2小时产出最高，可作为标杆
   - 建议：制定标准操作流程（SOP），提升整体效率
   - 预期效果：相同产出下，总工时可缩短至5小时

   **设备利用优化**：
   - 当前设备成本¥400，利用率良好
   - 建议：设备使用集中化，避免空转浪费

3. **利润提升路径**：

   **短期（1-2周）**：
   - 优化人员配置 → 人工成本降至¥1000
   - 新利润：¥2600（利润率 43.3%）

   **中期（1-2月）**：
   - 提升生产效率 + 降低损耗 → 总成本降至¥3200
   - 新利润：¥2800（利润率 46.7%）

   **盈亏平衡分析**：
   - 当前盈亏平衡价：¥7.20/kg
   - 优化后盈亏平衡价：¥6.40/kg（降低11%）
   - 竞争力显著提升

**具体行动建议**：
1. 立即行动：重新评估8名员工的工作分配
2. 本周完成：制定标准操作流程
3. 下月目标：人工成本占比降至28%以下
```

**Token 估算**: 约 **600-800 tokens** (中文)

---

## 💰 成本计算

### Llama-3.1-8B-Instruct (Hugging Face)

**价格**: 约 **$0.15 / 1M tokens** (输入 + 输出)

### 单次分析 Token 消耗

#### 首次对话（含 System Prompt）
- System Prompt: 350 tokens
- User Prompt: 450 tokens
- AI Response: 700 tokens
- **总计**: ~1500 tokens

#### 后续对话（无 System Prompt）
- User Prompt: 450 tokens
- AI Response: 700 tokens
- **总计**: ~1150 tokens

#### 多轮对话（5轮）
```
第1轮: 1500 tokens (含 System)
第2轮: 1150 tokens
第3轮: 1150 tokens
第4轮: 1150 tokens
第5轮: 1150 tokens
━━━━━━━━━━━━━━━━━━━━━
总计:  6100 tokens
```

---

## 📈 月度成本预测

### 使用场景假设

**每日分析量**:
- 小型工厂: 10 批次/天
- 中型工厂: 30 批次/天
- 大型工厂: 50 批次/天

**平均对话轮数**: 2轮（首次分析 + 1次追问）

### 成本计算

#### 小型工厂（10批次/天）
```
每次分析: 1500 + 1150 = 2650 tokens
每日消耗: 10 × 2650 = 26,500 tokens
每月消耗: 26,500 × 30 = 795,000 tokens

月度成本: 0.795M × $0.15 = $0.12 (约 ¥0.85)
```

#### 中型工厂（30批次/天）
```
每次分析: 2650 tokens
每日消耗: 30 × 2650 = 79,500 tokens
每月消耗: 79,500 × 30 = 2,385,000 tokens

月度成本: 2.385M × $0.15 = $0.36 (约 ¥2.55)
```

#### 大型工厂（50批次/天）
```
每次分析: 2650 tokens
每日消耗: 50 × 2650 = 132,500 tokens
每月消耗: 132,500 × 30 = 3,975,000 tokens

月度成本: 3.975M × $0.15 = $0.60 (约 ¥4.25)
```

---

## 🎯 成本控制目标

### 原定目标
> DeepSeek AI 成本控制: **<¥30/月**

### 当前使用 Llama-3.1-8B 成本
✅ **远低于预算！**

| 工厂规模 | 每日批次 | 月度成本 | 预算占比 |
|---------|---------|---------|---------|
| 小型 | 10 | ¥0.85 | 2.8% |
| 中型 | 30 | ¥2.55 | 8.5% |
| 大型 | 50 | ¥4.25 | 14.2% |
| **超大型** | 100 | ¥8.50 | 28.3% |

**结论**: 即使是超大型工厂（100批次/天），月度成本也仅 **¥8.5**，远低于 ¥30 预算。

---

## 🔧 优化建议

### 1. 缓存优化（已规划）
**实现**: 相似问题 5 分钟缓存

**效果预估**:
- 缓存命中率: 30-40%
- 成本节省: 30-40%
- **优化后月成本**: 中型工厂 ¥2.55 → ¥1.53

### 2. Prompt 优化
**当前 Prompt 长度**: ~450 tokens

**优化方向**:
- ✂️ 精简批次信息格式
- 📊 使用表格代替列表
- 🔢 减少小数位数

**预期节省**: 100-150 tokens/次 (约 22-33%)

**优化示例**:
```
原格式 (450 tokens):
- 批次号: BATCH_20251003_00001
- 原材料: 大黄鱼 500kg
- 原材料成本: ¥2000.00 (4.00元/kg)
...

优化格式 (350 tokens):
批次: BATCH_20251003_00001
原料: 大黄鱼 500kg @ ¥4/kg = ¥2000
人工: 8人 6h = ¥1200 (33%)
设备: 3台 4.5h = ¥400 (11%)
利润: ¥2400 (40%)
```

### 3. 智能压缩
**策略**:
- 少于 5 个员工 → 显示全部明细
- 5-10 个员工 → 显示前 5 个
- 超过 10 个 → 仅显示统计数据

**效果**: 大批次数据可节省 30-50% tokens

---

## 📊 Token 监控建议

### 实时监控指标
1. **每次分析 Token 数**
2. **每日总消耗**
3. **月度累计消耗**
4. **平均对话轮数**

### 告警阈值
- ⚠️  单次分析 > 3000 tokens (异常)
- ⚠️  每日消耗 > 150,000 tokens (中型工厂)
- 🚨 月度消耗 > 3M tokens (约 ¥2.12，触发优化)

### 监控实现
```javascript
// backend/src/controllers/processingController.js
const aiResult = await aiResponse.json();

// 记录 token 使用
console.log(`[AI Token] Batch: ${batchId}, Tokens: ${aiResult.token_count || 'N/A'}`);

// 可选: 存储到数据库用于分析
await prisma.aiUsageLog.create({
  data: {
    batchId,
    tokenCount: aiResult.token_count,
    sessionId: aiResult.session_id,
    timestamp: new Date()
  }
});
```

---

## 🎯 结论

### 当前状态
✅ **成本完全可控**
- 单次分析: ~1500 tokens (首次) / ~1150 tokens (后续)
- 月度成本: ¥0.85 - ¥8.50 (取决于规模)
- **远低于 ¥30 预算**

### 优化潜力
通过缓存 + Prompt 优化，成本可进一步降低 **50-60%**

### 建议
1. ✅ 当前配置可直接投入使用
2. 🔄 实施缓存机制（优先级：中）
3. ✂️  优化 Prompt 格式（优先级：低）
4. 📊 添加 Token 监控（优先级：中）

---

**分析时间**: 2025-01-03
**基于模型**: Llama-3.1-8B-Instruct
**价格参考**: $0.15 / 1M tokens (Hugging Face Inference API)
