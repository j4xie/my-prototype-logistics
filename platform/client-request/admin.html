<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>客户需求反馈 - 管理后台</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:"Microsoft YaHei","PingFang SC","Helvetica Neue",Arial,sans-serif;background:#f0f2f5;color:#333;line-height:1.6}

  /* Header */
  .header{background:linear-gradient(135deg,#1a5276,#2980b9);color:#fff;padding:20px 24px;position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,.15)}
  .header h1{font-size:20px;font-weight:600}
  .header .subtitle{font-size:13px;opacity:.8;margin-top:2px}
  .header-row{display:flex;align-items:center;justify-content:space-between}
  .btn-back{background:rgba(255,255,255,.2);color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;display:none;align-items:center;gap:6px;transition:background .2s}
  .btn-back:hover{background:rgba(255,255,255,.35)}
  .btn-back svg{width:16px;height:16px;fill:currentColor}

  /* Container */
  .container{max-width:960px;margin:0 auto;padding:16px}

  /* Stats */
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
  .stat-card{background:#fff;border-radius:10px;padding:16px 20px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
  .stat-card .label{font-size:13px;color:#888}
  .stat-card .value{font-size:28px;font-weight:700;color:#1a5276;margin-top:4px}
  .stat-card .unit{font-size:14px;font-weight:400;color:#666}

  /* Company cards */
  .company-grid{display:grid;gap:12px}
  .company-card{background:#fff;border-radius:10px;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,.06);cursor:pointer;transition:transform .15s,box-shadow .15s;border-left:4px solid #1a5276}
  .company-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
  .company-card .name{font-size:18px;font-weight:600;color:#1a5276}
  .company-card .contact{font-size:13px;color:#666;margin-top:6px}
  .company-card .contact span{margin-right:16px}
  .company-card .progress-row{display:flex;align-items:center;gap:12px;margin-top:12px}
  .progress-bar-bg{flex:1;height:8px;background:#e8e8e8;border-radius:4px;overflow:hidden}
  .progress-bar-fill{height:100%;border-radius:4px;transition:width .4s}
  .progress-text{font-size:13px;color:#666;white-space:nowrap}
  .company-card .updated{font-size:12px;color:#aaa;margin-top:8px}

  /* Detail view */
  .detail-view{display:none}
  .detail-header{margin-bottom:16px}
  .detail-header h2{font-size:22px;color:#1a5276;font-weight:700}
  .detail-meta{font-size:13px;color:#888;margin-top:4px}

  /* Filter buttons */
  .filter-bar{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
  .filter-btn{padding:6px 16px;border-radius:20px;border:1px solid #d0d0d0;background:#fff;cursor:pointer;font-size:13px;color:#555;transition:all .2s}
  .filter-btn.active{background:#1a5276;color:#fff;border-color:#1a5276}
  .filter-btn:hover:not(.active){background:#f5f5f5}

  /* Spec sections */
  .spec-section{background:#fff;border-radius:10px;margin-bottom:12px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.06)}
  .spec-section-title{font-size:15px;font-weight:600;padding:14px 20px;background:#fafafa;border-bottom:1px solid #eee;color:#1a5276}
  .spec-table{width:100%;border-collapse:collapse}
  .spec-table th,.spec-table td{padding:10px 16px;text-align:left;border-bottom:1px solid #f0f0f0;font-size:13px}
  .spec-table th{width:160px;color:#666;font-weight:500;background:#fafbfc}
  .spec-table td{color:#333}
  .spec-table tr:last-child th,.spec-table tr:last-child td{border-bottom:none}
  .spec-table .cell-status{display:inline-block;padding:2px 10px;border-radius:4px;font-size:12px;font-weight:500}
  .status-applicable{background:#e8f5e9;color:#2e7d32}
  .status-not-applicable{background:#ffebee;color:#c62828}
  .status-adjust{background:#fff3e0;color:#e65100}
  .status-pending{background:#f5f5f5;color:#9e9e9e}
  .spec-table .remark{font-size:12px;color:#888;margin-top:4px}

  /* Loading / Empty */
  .loading{text-align:center;padding:60px 20px;color:#999;font-size:15px}
  .loading .spinner{display:inline-block;width:32px;height:32px;border:3px solid #e0e0e0;border-top-color:#1a5276;border-radius:50%;animation:spin .8s linear infinite;margin-bottom:12px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .empty-state{text-align:center;padding:60px 20px;color:#aaa}

  /* Responsive */
  @media(max-width:640px){
    .stats{grid-template-columns:1fr}
    .stat-card .value{font-size:22px}
    .header h1{font-size:17px}
    .container{padding:12px}
    .spec-table th{width:120px}
    .company-card .name{font-size:16px}
    .filter-bar{gap:6px}
    .filter-btn{padding:5px 12px;font-size:12px}
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-row">
    <div>
      <h1>客户需求反馈 - 管理后台</h1>
      <div class="subtitle">白垩纪食品溯源系统 - 客户规格确认总览</div>
    </div>
    <button class="btn-back" id="btnBack" onclick="showListView()">
      <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
      返回列表
    </button>
  </div>
</div>

<div class="container">
  <!-- List View -->
  <div id="listView">
    <div class="stats" id="statsCards">
      <div class="stat-card"><div class="label">企业总数</div><div class="value" id="statTotal">--</div></div>
      <div class="stat-card"><div class="label">平均完成率</div><div class="value" id="statAvg">--<span class="unit">%</span></div></div>
      <div class="stat-card"><div class="label">最近更新</div><div class="value" id="statRecent" style="font-size:16px">--</div></div>
    </div>
    <div id="companyList" class="company-grid">
      <div class="loading"><div class="spinner"></div><br>正在加载企业列表...</div>
    </div>
  </div>

  <!-- Detail View -->
  <div class="detail-view" id="detailView">
    <div class="detail-header">
      <h2 id="detailName"></h2>
      <div class="detail-meta" id="detailMeta"></div>
    </div>
    <div class="filter-bar">
      <button class="filter-btn active" data-filter="all" onclick="applyFilter('all',this)">全部</button>
      <button class="filter-btn" data-filter="adjust" onclick="applyFilter('adjust',this)">仅"需调整"</button>
      <button class="filter-btn" data-filter="must" onclick="applyFilter('must',this)">仅"必须有"</button>
    </div>
    <div id="detailContent">
      <div class="loading"><div class="spinner"></div><br>正在加载详情...</div>
    </div>
  </div>
</div>

<script>
const API_BASE = '/api/public/client-requirement';
const PASSWORD = 'cretas2026';
const SESSION_KEY = 'cretas_admin_auth';

const SPEC_SECTIONS = [
  { id: "s3-1", title: "3.1 原材料类型信息", fields: ["材料编码","材料名称","材料分类","计量单位","参考单价","存储类型","保质期天数","最低库存预警","最高库存上限","备注"] },
  { id: "s3-2", title: "3.2 产品类型信息", fields: ["产品编码","产品名称","产品分类","产品品类","计量单位","出厂单价","产品规格","包装规格","保质期天数","标准工时","工序步骤","产品图片","备注"] },
  { id: "s3-3", title: "3.3 供应商信息", fields: ["供应商编码","供应商名称","联系人","联系电话","邮箱","地址","营业执照号","经营类型","供应材料","资质证书","付款条件","供货周期","信用额度","供应商评分"] },
  { id: "s3-4", title: "3.4 客户信息", fields: ["客户编码","客户名称","客户类型","行业","联系人","联系电话","收货地址","开票地址","税号","付款条件","信用额度","客户评分"] },
  { id: "s3-5", title: "3.5 设备信息", fields: ["设备编码","设备名称","设备类型","型号","制造商","序列号","购入日期","购入价格","折旧年限","每小时成本","功率","安装位置","保养周期","保修到期"] },
  { id: "s3-6", title: "3.6 产品配方（BOM）", fields: ["产品类型","原材料类型","标准用量","得率","参考单价","税率"] },
  { id: "s4-1", title: "4.1 原材料入库", fields: ["批次号","原材料类型","供应商","入库数量","计量单位","单件重量","进货单价","入库日期","生产日期","到期日期","存储位置","质检证书","入库状态","备注"] },
  { id: "s4-2", title: "4.2 生产计划", fields: ["计划编号","产品类型","计划数量","计量单位","计划开始时间","计划结束时间","优先级","计划状态","计划类型","来源类型","客户订单号","客户名称","预估材料成本","预估人工成本","备注"] },
  { id: "s4-3", title: "4.3 生产批次（生产执行）", fields: ["批次号","关联计划","产品类型","计划产量","投入量","计量单位","实际产量","良品数量","不良品数量","得率","生产效率","批次状态","质量状态","开始时间","结束时间","使用设备","生产负责人","工人数量","材料成本","人工成本","设备成本","总成本","单位成本","备注"] },
  { id: "s4-4", title: "4.4 工序过程记录", fields: ["关联批次","工序类型","开始时间","结束时间","工序时长","投入重量","产出重量","损耗重量","损耗率","合格数量","不合格数量","返工数量","环境温度","产品温度","目标温度","使用设备","设备运行时长","设备停机时长","设备OEE","用水量","用电量","操作员","工人数量","pH值","盐度","ATP检测值","备注"] },
  { id: "s4-5", title: "4.5 原材料消耗记录", fields: ["关联生产批次","原材料批次","消耗数量","单价","消耗金额","消耗时间","记录人","备注"] },
  { id: "s4-6", title: "4.6 质量检验记录", fields: ["关联生产批次","质检员","检验日期","抽样数量","合格数量","不合格数量","合格率","检验结论","检验详情"] },
  { id: "s4-7", title: "4.7 出货发运记录", fields: ["出货单号","客户","订单号","产品名称","出货数量","计量单位","单价","总金额","发货日期","收货地址","物流公司","运单号","出货状态","备注"] },
  { id: "s4-8", title: "4.8 溯源标签", fields: ["标签编码","标签类型","关联类型","关联批次","溯源码","二维码内容","产品名称","产品规格","生产日期","保质期","到期日期","标签状态","打印次数","贴标时间"] },
  { id: "s5-1", title: "5.1 考勤打卡记录", fields: ["员工","打卡日期","上班打卡时间","下班打卡时间","休息开始时间","休息结束时间","工作时长","休息时长","考勤状态","打卡位置","打卡设备"] },
  { id: "s5-2", title: "5.2 生产批次工时记录", fields: ["生产批次","员工","签入时间","签出时间","工作时长","人工成本","分配人","状态","备注"] },
  { id: "s6-1", title: "6.1 废弃处置记录", fields: ["处置类型","数量","原因","日期","处置方式","预估损失","实际损失","回收价值","审批人","审批日期"] },
  { id: "s7-1", title: "7.1 环境监控数据", fields: ["监控设备","数据类型","监控值","位置","采集时间","数据来源"] }
];

const TOTAL_FIELDS = SPEC_SECTIONS.reduce((sum, s) => sum + s.fields.length, 0);

// --- Auth ---
function checkAuth() {
  if (sessionStorage.getItem(SESSION_KEY) === 'true') return true;
  const pwd = prompt('请输入管理密码：');
  if (pwd === PASSWORD) {
    sessionStorage.setItem(SESSION_KEY, 'true');
    return true;
  }
  alert('密码错误，无权访问');
  window.location.href = 'about:blank';
  return false;
}

// --- API helpers ---
async function fetchJSON(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error('请求失败: ' + res.status);
  const json = await res.json();
  if (json.success === false) throw new Error(json.message || '接口返回错误');
  return json.data !== undefined ? json.data : json;
}

// --- Format helpers ---
function formatTime(t) {
  if (!t) return '--';
  const d = new Date(t);
  if (isNaN(d.getTime())) return t;
  const pad = n => String(n).padStart(2, '0');
  return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes());
}

function progressColor(pct) {
  if (pct >= 80) return '#27ae60';
  if (pct >= 50) return '#f39c12';
  if (pct >= 20) return '#e67e22';
  return '#e74c3c';
}

function statusClass(status) {
  if (!status) return 'status-pending';
  const s = status.trim();
  if (s === '适用' || s === '必须有') return 'status-applicable';
  if (s === '不适用') return 'status-not-applicable';
  if (s === '需调整') return 'status-adjust';
  return 'status-pending';
}

function statusBg(status) {
  if (!status) return '#f5f5f5';
  const s = status.trim();
  if (s === '适用' || s === '必须有') return '#e8f5e9';
  if (s === '不适用') return '#ffebee';
  if (s === '需调整') return '#fff3e0';
  return '#f5f5f5';
}

// --- Count completed fields from responses ---
function countCompleted(responses) {
  if (!responses || typeof responses !== 'object') return 0;
  let count = 0;
  for (const sectionId in responses) {
    const section = responses[sectionId];
    if (!section || typeof section !== 'object') continue;
    for (const field in section) {
      const val = section[field];
      if (val && typeof val === 'object') {
        if (val.status && val.status.trim() !== '' && val.status.trim() !== '待定') count++;
      } else if (val && String(val).trim() !== '') {
        count++;
      }
    }
  }
  return count;
}

// --- Views ---
let companiesData = [];
let currentFilter = 'all';
let currentDetailData = null;

function showListView() {
  document.getElementById('listView').style.display = '';
  document.getElementById('detailView').style.display = 'none';
  document.getElementById('btnBack').style.display = 'none';
}

function showDetailView() {
  document.getElementById('listView').style.display = 'none';
  document.getElementById('detailView').style.display = '';
  document.getElementById('btnBack').style.display = 'flex';
}

// --- Load companies ---
async function loadCompanies() {
  const listEl = document.getElementById('companyList');
  try {
    const data = await fetchJSON(API_BASE + '/companies');
    companiesData = Array.isArray(data) ? data : [];
    renderStats();
    renderCompanyList();
  } catch (e) {
    listEl.innerHTML = '<div class="empty-state">加载失败: ' + e.message + '</div>';
  }
}

function renderStats() {
  document.getElementById('statTotal').textContent = companiesData.length;

  if (companiesData.length === 0) {
    document.getElementById('statAvg').innerHTML = '--<span class="unit">%</span>';
    document.getElementById('statRecent').textContent = '--';
    return;
  }

  let totalPct = 0;
  let latestTime = null;
  companiesData.forEach(c => {
    const completed = c.completedFields != null ? c.completedFields : countCompleted(c.responses);
    const pct = Math.round((completed / TOTAL_FIELDS) * 100);
    totalPct += pct;
    const t = c.updatedAt || c.lastUpdated;
    if (t) {
      const d = new Date(t);
      if (!latestTime || d > latestTime) latestTime = d;
    }
  });

  const avg = Math.round(totalPct / companiesData.length);
  document.getElementById('statAvg').innerHTML = avg + '<span class="unit">%</span>';
  document.getElementById('statRecent').textContent = latestTime ? formatTime(latestTime) : '--';
}

function renderCompanyList() {
  const listEl = document.getElementById('companyList');
  if (companiesData.length === 0) {
    listEl.innerHTML = '<div class="empty-state">暂无企业数据</div>';
    return;
  }

  listEl.innerHTML = companiesData.map(c => {
    const completed = c.completedFields != null ? c.completedFields : countCompleted(c.responses);
    const pct = Math.round((completed / TOTAL_FIELDS) * 100);
    const color = progressColor(pct);
    const contact = c.contactName || '--';
    const phone = c.contactPhone || '--';
    const updated = formatTime(c.updatedAt || c.lastUpdated);
    const id = c.id || c.companyId;

    return '<div class="company-card" onclick="loadDetail(\'' + id + '\')">' +
      '<div class="name">' + escHtml(c.companyName || '--') + '</div>' +
      '<div class="contact"><span>联系人: ' + escHtml(contact) + '</span><span>电话: ' + escHtml(phone) + '</span></div>' +
      '<div class="progress-row">' +
        '<div class="progress-bar-bg"><div class="progress-bar-fill" style="width:' + pct + '%;background:' + color + '"></div></div>' +
        '<div class="progress-text">' + completed + ' / ' + TOTAL_FIELDS + ' (' + pct + '%)</div>' +
      '</div>' +
      '<div class="updated">最近更新: ' + updated + '</div>' +
    '</div>';
  }).join('');
}

function escHtml(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

// --- Load detail ---
async function loadDetail(companyId) {
  showDetailView();
  document.getElementById('detailContent').innerHTML = '<div class="loading"><div class="spinner"></div><br>正在加载详情...</div>';
  document.getElementById('detailName').textContent = '';
  document.getElementById('detailMeta').textContent = '';
  currentFilter = 'all';
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === 'all'));

  try {
    const data = await fetchJSON(API_BASE + '/' + companyId);
    currentDetailData = data;
    renderDetail(data);
  } catch (e) {
    document.getElementById('detailContent').innerHTML = '<div class="empty-state">加载失败: ' + e.message + '</div>';
  }
}

function renderDetail(data) {
  const name = data.companyName || '--';
  const contact = data.contactName || '--';
  const phone = data.contactPhone || '--';
  const updated = formatTime(data.updatedAt || data.lastUpdated);

  document.getElementById('detailName').textContent = name;
  document.getElementById('detailMeta').textContent = '联系人: ' + contact + '  |  电话: ' + phone + '  |  最近更新: ' + updated;

  const responses = data.responses || {};
  renderSections(responses);
}

function renderSections(responses) {
  const container = document.getElementById('detailContent');
  let html = '';

  SPEC_SECTIONS.forEach(section => {
    const sectionData = responses[section.id] || {};
    let rowsHtml = '';
    let visibleCount = 0;

    section.fields.forEach(field => {
      const val = sectionData[field];
      let status = '';
      let remark = '';
      let importance = '';

      if (val && typeof val === 'object') {
        status = val.status || '';
        remark = val.remark || val.note || '';
        importance = val.importance || '';
      } else if (typeof val === 'string') {
        status = val;
      }

      // Filter logic
      const show = shouldShowRow(status, importance);
      const bg = statusBg(status);
      const cls = statusClass(status);

      rowsHtml += '<tr class="spec-row" data-status="' + escHtml(status) + '" data-importance="' + escHtml(importance) + '" style="' + (show ? '' : 'display:none;') + '">' +
        '<th>' + escHtml(field) + '</th>' +
        '<td style="background:' + bg + '">' +
          (status ? '<span class="cell-status ' + cls + '">' + escHtml(status) + '</span>' : '<span class="cell-status status-pending">待定</span>') +
          (importance ? ' <span style="font-size:12px;color:#666">(' + escHtml(importance) + ')</span>' : '') +
          (remark ? '<div class="remark">备注: ' + escHtml(remark) + '</div>' : '') +
        '</td>' +
      '</tr>';

      if (show) visibleCount++;
    });

    const sectionHidden = visibleCount === 0 && currentFilter !== 'all';
    html += '<div class="spec-section" data-section="' + section.id + '" style="' + (sectionHidden ? 'display:none' : '') + '">' +
      '<div class="spec-section-title">' + escHtml(section.title) + '</div>' +
      '<table class="spec-table"><tbody>' + rowsHtml + '</tbody></table>' +
    '</div>';
  });

  container.innerHTML = html || '<div class="empty-state">暂无规格数据</div>';
}

function shouldShowRow(status, importance) {
  if (currentFilter === 'all') return true;
  if (currentFilter === 'adjust') return status && status.trim() === '需调整';
  if (currentFilter === 'must') return importance && importance.trim() === '必须有';
  return true;
}

function applyFilter(filter, btn) {
  currentFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  if (currentDetailData) {
    renderSections(currentDetailData.responses || {});
  }
}

// --- Init ---
document.addEventListener('DOMContentLoaded', function() {
  if (!checkAuth()) return;
  loadCompanies();
});
</script>
</body>
</html>
