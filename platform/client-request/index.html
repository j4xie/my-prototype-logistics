<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI å·¥å‚å…¥é©»å‘å¯¼ â€” ç™½å©çºªé£Ÿå“æº¯æºç³»ç»Ÿ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   1. Custom Properties
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --primary: #4338ca;
  --primary-light: #6366f1;
  --primary-glow: rgba(99, 102, 241, 0.35);
  --accent: #f59e0b;
  --accent-glow: rgba(245, 158, 11, 0.3);
  --success: #059669;
  --success-light: #34d399;
  --danger: #dc2626;
  --warning: #f59e0b;

  --text: #0f172a;
  --text-secondary: #475569;
  --text-muted: #94a3b8;

  --glass-bg: rgba(255, 255, 255, 0.62);
  --glass-border: rgba(255, 255, 255, 0.55);
  --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.06), 0 2px 8px rgba(0, 0, 0, 0.04);
  --glass-blur: blur(20px) saturate(180%);

  --chat-dark: #0f172a;
  --chat-surface: #1e293b;
  --chat-ai-bg: rgba(99, 102, 241, 0.12);
  --chat-ai-border: rgba(99, 102, 241, 0.25);
  --chat-user-bg: rgba(16, 185, 129, 0.12);
  --chat-user-border: rgba(16, 185, 129, 0.25);

  --radius: 20px;
  --radius-sm: 12px;
  --radius-xs: 8px;
  --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);

  --font-display: 'Plus Jakarta Sans', 'Noto Sans SC', system-ui, sans-serif;
  --font-body: 'Noto Sans SC', 'Plus Jakarta Sans', system-ui, sans-serif;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   2. Reset & Base
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--font-body);
  background: #e8eaf6;
  color: var(--text);
  line-height: 1.7;
  min-height: 100vh;
  overflow-x: hidden;
}

::selection { background: rgba(99, 102, 241, 0.2); color: var(--primary); }
:focus-visible { outline: 2px solid var(--primary-light); outline-offset: 2px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   3. Animated Background
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bg-effects {
  position: fixed; inset: 0; z-index: 0;
  overflow: hidden; pointer-events: none;
}
.bg-orb {
  position: absolute; border-radius: 50%;
  filter: blur(90px); opacity: 0.55;
  will-change: transform;
}
.bg-orb-1 {
  width: 650px; height: 650px;
  background: #c7d2fe;
  top: -15%; left: -10%;
  animation: orb1 28s ease-in-out infinite;
}
.bg-orb-2 {
  width: 500px; height: 500px;
  background: #ddd6fe;
  top: 30%; right: -8%;
  animation: orb2 24s ease-in-out infinite;
}
.bg-orb-3 {
  width: 400px; height: 400px;
  background: #fce7f3;
  bottom: -5%; left: 25%;
  animation: orb3 30s ease-in-out infinite;
}
.bg-orb-4 {
  width: 350px; height: 350px;
  background: #bae6fd;
  top: 10%; right: 30%;
  animation: orb4 22s ease-in-out infinite;
}
@keyframes orb1 {
  0%, 100% { transform: translate(0, 0) scale(1); }
  33% { transform: translate(80px, 60px) scale(1.05); }
  66% { transform: translate(-40px, 80px) scale(0.95); }
}
@keyframes orb2 {
  0%, 100% { transform: translate(0, 0) scale(1); }
  33% { transform: translate(-60px, -40px) scale(0.95); }
  66% { transform: translate(40px, -60px) scale(1.08); }
}
@keyframes orb3 {
  0%, 100% { transform: translate(0, 0) scale(1); }
  40% { transform: translate(70px, -50px) scale(1.1); }
  70% { transform: translate(-50px, 30px) scale(0.92); }
}
@keyframes orb4 {
  0%, 100% { transform: translate(0, 0); }
  50% { transform: translate(-60px, 50px); }
}

.bg-grid {
  position: absolute; inset: 0;
  background-image: radial-gradient(circle, rgba(0,0,0,0.03) 1px, transparent 1px);
  background-size: 28px 28px;
}
.bg-noise {
  position: absolute; inset: 0;
  opacity: 0.018;
  background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   4. Brand Header
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.brand-header {
  position: relative; z-index: 10;
  display: flex; align-items: center; justify-content: space-between;
  max-width: 960px; margin: 0 auto;
  padding: 24px 24px 0;
}
.brand-left {
  display: flex; align-items: center; gap: 12px;
}
.brand-mark {
  width: 44px; height: 44px; border-radius: 14px;
  background: linear-gradient(135deg, var(--primary), #7c3aed);
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; color: #fff;
  box-shadow: 0 4px 14px rgba(67, 56, 202, 0.3);
}
.brand-name {
  font-family: var(--font-display);
  font-size: 20px; font-weight: 800;
  letter-spacing: -0.02em;
  background: linear-gradient(135deg, var(--primary), #7c3aed);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}
.brand-sub {
  font-size: 12px; color: var(--text-muted); font-weight: 400;
  letter-spacing: 0.02em;
}
.ai-badge {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 6px 16px; border-radius: 100px;
  background: rgba(99, 102, 241, 0.08);
  border: 1px solid rgba(99, 102, 241, 0.15);
  color: var(--primary); font-size: 13px; font-weight: 600;
  font-family: var(--font-display);
}
.ai-badge::before {
  content: 'âœ¦'; font-size: 14px;
  animation: sparkle 2s ease-in-out infinite;
}
@keyframes sparkle {
  0%, 100% { opacity: 0.6; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.2); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   5. Wizard Container & Step Indicator
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wizard-container {
  position: relative; z-index: 10;
  max-width: 960px; margin: 0 auto;
  padding: 16px 24px 40px;
}

.step-indicator {
  display: flex; align-items: center; justify-content: center;
  gap: 0; margin: 20px 0 28px;
  background: var(--glass-bg);
  backdrop-filter: var(--glass-blur);
  -webkit-backdrop-filter: var(--glass-blur);
  border: 1px solid var(--glass-border);
  border-radius: 100px; padding: 10px 28px;
  box-shadow: var(--glass-shadow);
}
.step-dot {
  width: 34px; height: 34px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700;
  font-family: var(--font-display);
  background: #e2e8f0; color: #94a3b8;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative; cursor: default;
}
.step-dot.active {
  background: linear-gradient(135deg, var(--primary), #7c3aed);
  color: #fff;
  box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2), 0 4px 12px rgba(67, 56, 202, 0.3);
  transform: scale(1.08);
}
.step-dot.completed {
  background: var(--success); color: #fff;
  box-shadow: 0 2px 8px rgba(5, 150, 105, 0.25);
}
.step-line {
  width: 48px; height: 3px; border-radius: 2px;
  background: #e2e8f0; margin: 0 4px;
  transition: background 0.5s ease;
}
.step-line.completed {
  background: linear-gradient(90deg, var(--success), var(--success-light));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   6. Glass Card
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card {
  background: var(--glass-bg);
  backdrop-filter: var(--glass-blur);
  -webkit-backdrop-filter: var(--glass-blur);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius);
  padding: 32px;
  margin-bottom: 20px;
  box-shadow: var(--glass-shadow);
  animation: cardIn 0.55s cubic-bezier(0.23, 1, 0.32, 1) both;
}
@keyframes cardIn {
  from { opacity: 0; transform: translateY(16px) scale(0.98); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.card h2 {
  font-family: var(--font-display);
  font-size: 22px; font-weight: 700;
  letter-spacing: -0.02em;
  color: var(--text); margin-bottom: 20px;
  display: flex; align-items: center; gap: 10px;
}
.card h2::before {
  content: '';
  width: 4px; height: 24px; border-radius: 2px;
  background: linear-gradient(180deg, var(--primary), #7c3aed);
  flex-shrink: 0;
}
.card h3 {
  font-family: var(--font-display);
  font-size: 16px; font-weight: 600;
  margin-bottom: 12px; color: var(--text);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   7. Form Controls
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.form-group { margin-bottom: 20px; }
.form-group label {
  display: block; font-size: 13px; font-weight: 500;
  margin-bottom: 6px; color: var(--text-secondary);
  letter-spacing: 0.01em;
}
.form-group label .req { color: var(--danger); margin-right: 2px; }
.form-group input, .form-group textarea, .form-group select {
  width: 100%; padding: 11px 16px;
  background: rgba(255,255,255,0.6);
  border: 1.5px solid rgba(0,0,0,0.08);
  border-radius: var(--radius-xs);
  font-size: 14px; font-family: var(--font-body);
  color: var(--text);
  transition: all var(--transition);
}
.form-group input:hover, .form-group textarea:hover, .form-group select:hover {
  border-color: rgba(0,0,0,0.15);
}
.form-group input:focus, .form-group textarea:focus, .form-group select:focus {
  outline: none;
  border-color: var(--primary-light);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  background: rgba(255,255,255,0.85);
}
.form-group input::placeholder, .form-group textarea::placeholder {
  color: #b0b8c9;
}
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   8. Buttons
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn {
  display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  padding: 11px 26px; border: none; border-radius: var(--radius-xs);
  font-size: 14px; font-weight: 600; font-family: var(--font-body);
  cursor: pointer; transition: all var(--transition);
  letter-spacing: 0.01em;
}
.btn-primary {
  background: linear-gradient(135deg, var(--primary), #6d28d9);
  color: #fff;
  box-shadow: 0 4px 14px rgba(67, 56, 202, 0.25);
}
.btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 20px rgba(67, 56, 202, 0.35);
}
.btn-primary:active { transform: translateY(0); }
.btn-primary:disabled {
  background: #cbd5e1; color: #94a3b8;
  box-shadow: none; cursor: not-allowed; transform: none;
}
.btn-outline {
  background: rgba(255,255,255,0.5);
  color: var(--primary); border: 1.5px solid rgba(67, 56, 202, 0.2);
}
.btn-outline:hover {
  background: rgba(99, 102, 241, 0.06);
  border-color: rgba(67, 56, 202, 0.35);
}
.btn-success {
  background: linear-gradient(135deg, var(--success), #0d9488);
  color: #fff;
  box-shadow: 0 4px 14px rgba(5, 150, 105, 0.25);
}
.btn-success:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 20px rgba(5, 150, 105, 0.35);
}
.btn-row {
  display: flex; gap: 12px; justify-content: flex-end; margin-top: 28px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   9. Module Cards (Step 2)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.module-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px;
}
.module-card {
  position: relative; padding: 20px;
  background: rgba(255,255,255,0.5);
  border: 2px solid rgba(0,0,0,0.06);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all 0.35s cubic-bezier(0.23, 1, 0.32, 1);
}
.module-card:hover {
  transform: translateY(-3px);
  border-color: rgba(99, 102, 241, 0.25);
  box-shadow: 0 8px 25px rgba(99, 102, 241, 0.1);
}
.module-card.selected {
  border-color: var(--primary);
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.06), rgba(139, 92, 246, 0.04));
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12), 0 4px 16px rgba(67, 56, 202, 0.1);
}
.module-card .icon {
  width: 48px; height: 48px; border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  font-size: 24px; margin-bottom: 10px;
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.05));
}
.module-card.selected .icon {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1));
}
.module-card .name {
  font-family: var(--font-display);
  font-size: 15px; font-weight: 700; color: var(--text);
}
.module-card .desc { font-size: 12.5px; color: var(--text-secondary); margin-top: 4px; }
.module-card .field-count {
  font-size: 11.5px; color: var(--text-muted); margin-top: 8px;
  font-weight: 500; letter-spacing: 0.01em;
}
.module-card .check {
  position: absolute; top: 12px; right: 12px;
  width: 24px; height: 24px; border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), #7c3aed);
  color: #fff;
  display: none; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700;
  box-shadow: 0 2px 8px rgba(67, 56, 202, 0.3);
}
.module-card.selected .check { display: flex; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   10. Chat UI (Step 3) â€” Dark Mode
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#step3 {
  background: var(--chat-dark);
  border: 1px solid rgba(148, 163, 184, 0.08);
  padding: 0;
  overflow: hidden;
}
.chat-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 20px;
  background: linear-gradient(135deg, var(--primary), #7c3aed);
  color: #fff;
  border-radius: var(--radius) var(--radius) 0 0;
}
.chat-header strong {
  font-family: var(--font-display);
  font-size: 16px; font-weight: 700;
}
.chat-header .module-label {
  font-size: 13px; opacity: 0.85; margin-top: 2px;
}
.chat-header .btn-outline {
  color: rgba(255,255,255,0.9); border-color: rgba(255,255,255,0.35);
  background: rgba(255,255,255,0.08);
  padding: 6px 14px; font-size: 12px;
}
.chat-header .btn-outline:hover {
  background: rgba(255,255,255,0.15);
  border-color: rgba(255,255,255,0.5);
}

.chat-body {
  height: 420px; overflow-y: auto; padding: 20px;
  background: var(--chat-dark);
  border-left: 1px solid rgba(148, 163, 184, 0.06);
  border-right: 1px solid rgba(148, 163, 184, 0.06);
  scroll-behavior: smooth;
}
.chat-body::-webkit-scrollbar { width: 5px; }
.chat-body::-webkit-scrollbar-track { background: transparent; }
.chat-body::-webkit-scrollbar-thumb {
  background: rgba(148, 163, 184, 0.15); border-radius: 3px;
}

.chat-msg { margin-bottom: 18px; display: flex; gap: 10px; }
.chat-msg.ai { flex-direction: row; }
.chat-msg.user { flex-direction: row-reverse; }

.chat-avatar {
  width: 36px; height: 36px; border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; flex-shrink: 0;
}
.chat-msg.ai .chat-avatar {
  background: rgba(99, 102, 241, 0.15);
  box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
}
.chat-msg.user .chat-avatar {
  background: rgba(16, 185, 129, 0.15);
  box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
}

.chat-bubble {
  max-width: 78%; padding: 12px 16px;
  border-radius: 16px; font-size: 14px; line-height: 1.7;
}
.chat-msg.ai .chat-bubble {
  background: var(--chat-ai-bg);
  border: 1px solid var(--chat-ai-border);
  border-top-left-radius: 4px;
  color: #e2e8f0;
}
.chat-msg.user .chat-bubble {
  background: var(--chat-user-bg);
  border: 1px solid var(--chat-user-border);
  border-top-right-radius: 4px;
  color: #e2e8f0;
}

.quick-replies {
  display: flex; flex-wrap: wrap; gap: 8px;
  margin: 10px 0 10px 46px;
}
.quick-reply-btn {
  padding: 7px 16px;
  background: rgba(99, 102, 241, 0.08);
  border: 1px solid rgba(99, 102, 241, 0.3);
  border-radius: 100px;
  color: #a5b4fc; font-size: 13px; font-weight: 500;
  cursor: pointer; transition: all var(--transition);
  font-family: var(--font-body);
}
.quick-reply-btn:hover {
  background: rgba(99, 102, 241, 0.2);
  border-color: rgba(99, 102, 241, 0.5);
  color: #c7d2fe;
  transform: translateY(-1px);
}

.topics-bar {
  margin: 8px 0 8px 46px; font-size: 12px; color: #64748b;
  display: flex; gap: 14px; flex-wrap: wrap;
}
.topics-bar .covered { color: var(--success-light); }
.topics-bar .remaining { color: #fbbf24; }

.chat-loading {
  display: flex; align-items: center; gap: 10px;
  margin: 10px 0 10px 46px;
  font-size: 13px; color: #64748b;
}
.chat-loading .dots span {
  display: inline-block; width: 7px; height: 7px;
  background: #6366f1; border-radius: 50%; margin: 0 2px;
  animation: bounce 1.4s ease-in-out infinite;
}
.chat-loading .dots span:nth-child(2) { animation-delay: 0.2s; }
.chat-loading .dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes bounce {
  0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
  40% { transform: translateY(-10px); opacity: 1; }
}

.module-complete-card {
  background: rgba(16, 185, 129, 0.08);
  border: 1px solid rgba(16, 185, 129, 0.25);
  border-radius: var(--radius-sm);
  padding: 16px 20px; margin: 14px 0 14px 46px;
}
.module-complete-card h4 {
  color: var(--success-light); font-size: 14px;
  font-family: var(--font-display); font-weight: 700;
  margin-bottom: 6px;
}
.module-complete-card p { font-size: 13px; color: #94a3b8; }

.chat-footer {
  display: flex; gap: 10px; padding: 14px 20px;
  border-top: 1px solid rgba(148, 163, 184, 0.08);
  background: var(--chat-surface);
}
.chat-footer input {
  flex: 1; padding: 11px 16px;
  background: rgba(255,255,255,0.05);
  border: 1.5px solid rgba(148, 163, 184, 0.12);
  border-radius: var(--radius-xs);
  font-size: 14px; font-family: var(--font-body);
  color: #e2e8f0; transition: all var(--transition);
}
.chat-footer input::placeholder { color: #475569; }
.chat-footer input:focus {
  outline: none;
  border-color: var(--primary-light);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
  background: rgba(255,255,255,0.08);
}
.chat-footer .btn-primary {
  padding: 11px 20px;
}

#step3 .step3-bottom-bar {
  padding: 14px 20px;
  display: flex; gap: 12px; justify-content: space-between;
  background: var(--chat-surface);
  border-top: 1px solid rgba(148, 163, 184, 0.06);
}
#step3 .step3-bottom-bar .btn-outline {
  color: #94a3b8; border-color: rgba(148, 163, 184, 0.15);
  background: transparent;
}
#step3 .step3-bottom-bar .btn-outline:hover {
  color: #e2e8f0; border-color: rgba(148, 163, 184, 0.3);
  background: rgba(255,255,255,0.03);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   11. Assessment (Step 4)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.assess-summary {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.06), rgba(139, 92, 246, 0.04));
  border: 1px solid rgba(99, 102, 241, 0.12);
  border-radius: var(--radius-sm); padding: 18px 22px; margin-bottom: 22px;
  font-size: 15px;
}
.assess-summary strong { color: var(--text); }
.confidence {
  display: inline-flex; align-items: center;
  padding: 3px 12px; border-radius: 100px;
  font-size: 12px; font-weight: 700;
  font-family: var(--font-display);
}
.conf-high { background: rgba(5, 150, 105, 0.1); color: var(--success); border: 1px solid rgba(5, 150, 105, 0.2); }
.conf-med { background: rgba(245, 158, 11, 0.1); color: #d97706; border: 1px solid rgba(245, 158, 11, 0.2); }
.conf-low { background: rgba(220, 38, 38, 0.1); color: var(--danger); border: 1px solid rgba(220, 38, 38, 0.2); }

.assess-table {
  width: 100%; border-collapse: separate; border-spacing: 0;
  font-size: 13px; border-radius: var(--radius-xs); overflow: hidden;
}
.assess-table th {
  background: rgba(99, 102, 241, 0.06);
  padding: 10px 14px; text-align: left;
  font-family: var(--font-display); font-weight: 600;
  color: var(--text-secondary); font-size: 12px;
  letter-spacing: 0.03em; text-transform: uppercase;
  border-bottom: 2px solid rgba(99, 102, 241, 0.1);
}
.assess-table td {
  padding: 10px 14px;
  border-bottom: 1px solid rgba(0,0,0,0.04);
  color: var(--text);
}
.assess-table tr:hover td { background: rgba(99, 102, 241, 0.02); }
.assess-table tr:last-child td { border-bottom: none; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   12. Result (Step 5)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.result-card { text-align: center; padding: 44px 32px; }
.result-card .icon {
  font-size: 64px; margin-bottom: 18px;
  animation: resultPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.2s both;
}
@keyframes resultPop {
  from { opacity: 0; transform: scale(0.3); }
  to { opacity: 1; transform: scale(1); }
}
.result-card h2 {
  font-family: var(--font-display);
  color: var(--success); font-size: 24px;
  margin-bottom: 8px; justify-content: center;
}
.result-card h2::before { display: none; }

.result-info {
  display: grid; grid-template-columns: 1fr 1fr; gap: 14px;
  margin-top: 28px; text-align: left;
}
.result-item {
  background: rgba(255,255,255,0.5);
  border: 1px solid rgba(0,0,0,0.04);
  padding: 16px 18px; border-radius: var(--radius-sm);
  transition: all var(--transition);
}
.result-item:hover {
  background: rgba(255,255,255,0.7);
  box-shadow: 0 4px 12px rgba(0,0,0,0.04);
}
.result-item .label {
  font-size: 12px; color: var(--text-muted);
  font-weight: 500; letter-spacing: 0.02em;
  text-transform: uppercase; margin-bottom: 4px;
}
.result-item .value {
  font-size: 17px; font-weight: 700;
  font-family: var(--font-display);
  color: var(--primary);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   13. Step Transition Animation
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.animate-in {
  animation: cardIn 0.55s cubic-bezier(0.23, 1, 0.32, 1) both !important;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   14. Responsive
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 640px) {
  .brand-header { padding: 16px 16px 0; flex-wrap: wrap; gap: 8px; }
  .wizard-container { padding: 12px 16px 32px; }
  .card { padding: 22px 18px; border-radius: 16px; }
  .form-row { grid-template-columns: 1fr; }
  .module-grid { grid-template-columns: 1fr; }
  .chat-body { height: 320px; }
  .chat-bubble { max-width: 88%; }
  .step-indicator { padding: 8px 16px; }
  .step-dot { width: 30px; height: 30px; font-size: 12px; }
  .step-line { width: 28px; }
  .result-info { grid-template-columns: 1fr; }
  .ai-badge { display: none; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   15. Utilities
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hidden { display: none !important; }
</style>
</head>
<body>

<!-- ===== Animated Background ===== -->
<div class="bg-effects" aria-hidden="true">
  <div class="bg-orb bg-orb-1"></div>
  <div class="bg-orb bg-orb-2"></div>
  <div class="bg-orb bg-orb-3"></div>
  <div class="bg-orb bg-orb-4"></div>
  <div class="bg-grid"></div>
  <div class="bg-noise"></div>
</div>

<!-- ===== Brand Header ===== -->
<header class="brand-header">
  <div class="brand-left">
    <div class="brand-mark">C</div>
    <div>
      <div class="brand-name">CRETAS</div>
      <div class="brand-sub">ç™½å©çºªé£Ÿå“æº¯æºç³»ç»Ÿ</div>
    </div>
  </div>
  <div class="ai-badge">AI æ™ºèƒ½å…¥é©»</div>
</header>

<!-- ===== Wizard ===== -->
<div class="wizard-container">
  <!-- Step Indicator -->
  <div class="step-indicator" id="stepIndicator">
    <div class="step-dot active" data-step="1">1</div>
    <div class="step-line"></div>
    <div class="step-dot" data-step="2">2</div>
    <div class="step-line"></div>
    <div class="step-dot" data-step="3">3</div>
    <div class="step-line"></div>
    <div class="step-dot" data-step="4">4</div>
    <div class="step-line"></div>
    <div class="step-dot" data-step="5">5</div>
  </div>

  <!-- Step 1: Basic Info -->
  <div id="step1" class="card">
    <h2>å·¥å‚åŸºæœ¬ä¿¡æ¯</h2>
    <p style="color:var(--text-secondary);margin:-12px 0 22px;font-size:14px;">è¯·å¡«å†™æ‚¨çš„å·¥å‚ä¿¡æ¯ï¼Œå¸®åŠ© AI æ›´å¥½åœ°äº†è§£æ‚¨çš„éœ€æ±‚</p>
    <div class="form-row">
      <div class="form-group">
        <label><span class="req">*</span> å·¥å‚åç§°</label>
        <input id="factoryName" placeholder="å¦‚ï¼šå…­è†³é—¨é£Ÿå“åŠ å·¥å‚">
      </div>
      <div class="form-group">
        <label>è”ç³»äºº</label>
        <input id="contactName" placeholder="è´Ÿè´£äººå§“å">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>è”ç³»ç”µè¯</label>
        <input id="contactPhone" placeholder="æ‰‹æœºå·ç ">
      </div>
      <div class="form-group">
        <label>è¡Œä¸š</label>
        <select id="industry">
          <option value="">è¯·é€‰æ‹©è¡Œä¸š</option>
          <option value="è‚‰ç±»åŠ å·¥">è‚‰ç±»åŠ å·¥</option>
          <option value="æ°´äº§åŠ å·¥">æ°´äº§åŠ å·¥</option>
          <option value="ä¹³åˆ¶å“">ä¹³åˆ¶å“</option>
          <option value="çƒ˜ç„™é£Ÿå“">çƒ˜ç„™é£Ÿå“</option>
          <option value="æœè”¬åŠ å·¥">æœè”¬åŠ å·¥</option>
          <option value="é¥®æ–™">é¥®æ–™</option>
          <option value="è°ƒå‘³å“">è°ƒå‘³å“</option>
          <option value="å†·å†»é£Ÿå“">å†·å†»é£Ÿå“</option>
          <option value="ä¼‘é—²é£Ÿå“">ä¼‘é—²é£Ÿå“</option>
          <option value="ç²®æ²¹åŠ å·¥">ç²®æ²¹åŠ å·¥</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>å·¥å‚è§„æ¨¡</label>
        <select id="scale">
          <option value="">è¯·é€‰æ‹©</option>
          <option value="å°å‹(50äººä»¥ä¸‹)">å°å‹ (50äººä»¥ä¸‹)</option>
          <option value="ä¸­å‹(50-200äºº)">ä¸­å‹ (50-200äºº)</option>
          <option value="å¤§å‹(200-500äºº)">å¤§å‹ (200-500äºº)</option>
          <option value="è¶…å¤§å‹(500äººä»¥ä¸Š)">è¶…å¤§å‹ (500äººä»¥ä¸Š)</option>
        </select>
      </div>
      <div class="form-group">
        <label>ä¸»è¦äº§å“</label>
        <input id="products" placeholder="å¦‚ï¼šçŒªè‚‰é¦™è‚ ã€è…Šè‚‰ã€ç«è…¿">
      </div>
    </div>
    <div class="form-group">
      <label>å·¥å‚ç®€ä»‹ (å¯é€‰)</label>
      <textarea id="description" rows="3" placeholder="ç®€è¦æè¿°æ‚¨çš„å·¥å‚æƒ…å†µã€å½“å‰ä¿¡æ¯åŒ–æ°´å¹³..."></textarea>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="goToStep2()">ä¸‹ä¸€æ­¥ â†’</button>
    </div>
  </div>

  <!-- Step 2: Module Selection -->
  <div id="step2" class="card hidden">
    <h2>é€‰æ‹©åŠŸèƒ½æ¨¡å—</h2>
    <p style="color:var(--text-secondary);margin:-12px 0 22px;font-size:14px;">è¯·é€‰æ‹©æ‚¨éœ€è¦çš„ç³»ç»Ÿæ¨¡å—ï¼ˆè‡³å°‘é€‰1ä¸ªï¼‰ï¼ŒAI å°†é’ˆå¯¹é€‰ä¸­æ¨¡å—ä¸æ‚¨æ·±å…¥å¯¹è¯</p>
    <div class="module-grid" id="moduleGrid"></div>
    <div class="btn-row">
      <button class="btn btn-outline" onclick="goToStep(1)">â† ä¸Šä¸€æ­¥</button>
      <button class="btn btn-primary" id="btnStep2Next" onclick="goToStep3()" disabled>ä¸‹ä¸€æ­¥ â†’</button>
    </div>
  </div>

  <!-- Step 3: AI Chat -->
  <div id="step3" class="card hidden" style="padding:0;">
    <div class="chat-header">
      <div>
        <strong>AI éœ€æ±‚è°ƒç ”</strong>
        <div class="module-label" id="chatModuleLabel">æ¨¡å— 1/4: äººæ•ˆæ•°æ®é‡‡é›†</div>
      </div>
      <button class="btn btn-outline" onclick="skipModule()">è·³è¿‡æ­¤æ¨¡å—</button>
    </div>
    <div class="chat-body" id="chatBody"></div>
    <div class="chat-footer">
      <input id="chatInput" placeholder="è¯·è¾“å…¥æˆ–é€‰æ‹©ä¸Šæ–¹å¿«æ·å›å¤..." onkeydown="if(event.key==='Enter')sendChat()">
      <button class="btn btn-primary" onclick="sendChat()">å‘é€</button>
    </div>
    <div class="step3-bottom-bar">
      <button class="btn btn-outline" onclick="goToStep(2)">â† è¿”å›æ¨¡å—é€‰æ‹©</button>
      <div style="display:flex;gap:10px;">
        <button class="btn btn-success hidden" id="btnNextModule" onclick="nextModule()">ç»§ç»­ä¸‹ä¸€æ¨¡å— â†’</button>
        <button class="btn btn-success hidden" id="btnToAssess" onclick="goToStep4()">ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š</button>
      </div>
    </div>
  </div>

  <!-- Step 4: Assessment -->
  <div id="step4" class="card hidden">
    <h2>AI è¯„ä¼°ç»“æœ</h2>
    <div id="assessContent">
      <div style="text-align:center;padding:44px;color:var(--text-muted);">
        <div class="chat-loading" style="justify-content:center;"><div class="dots"><span></span><span></span><span></span></div> AI æ­£åœ¨åˆ†æå¯¹è¯è®°å½•å¹¶ç”Ÿæˆè¯„ä¼°...</div>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-outline" onclick="goToStep(3)">â† è¿”å›å¯¹è¯</button>
      <button class="btn btn-success" id="btnFinalize" onclick="goToStep5()" disabled>ç¡®è®¤åˆ›å»ºå·¥å‚</button>
    </div>
  </div>

  <!-- Step 5: Result -->
  <div id="step5" class="card hidden">
    <div class="result-card" id="resultContent">
      <div style="text-align:center;padding:44px;color:var(--text-muted);">
        <div class="chat-loading" style="justify-content:center;"><div class="dots"><span></span><span></span><span></span></div> æ­£åœ¨åˆ›å»ºå·¥å‚...</div>
      </div>
    </div>
  </div>
</div>

<script>
// ========== Configuration ==========
const API_BASE = '/api/public/client-requirement';

// ========== MODULES constant (field catalog) ==========
const MODULES = [
  {
    id: "m0", name: "äººæ•ˆæ•°æ®é‡‡é›†", icon: "ğŸ¯",
    desc: "è§†è§‰è¯†åˆ«è¡¥å……çš„äººå·¥å½•å…¥å­—æ®µ",
    sections: [
      { id: "s-vl-1", title: "å·¥äººèº«ä»½ä¿¡æ¯", fields: [{name:"å·¥å·"},{name:"å§“å"},{name:"ç­ç»„"},{name:"å·¥ç§/å²—ä½"},{name:"æŠ€èƒ½ç­‰çº§"},{name:"æ—¶è–ª/æ—¥è–ª"}]},
      { id: "s-vl-2", title: "è€ƒå‹¤æ‰“å¡", fields: [{name:"æ‰“å¡æ—¥æœŸ"},{name:"ä¸Šç­æ‰“å¡æ—¶é—´"},{name:"ä¸‹ç­æ‰“å¡æ—¶é—´"},{name:"è€ƒå‹¤çŠ¶æ€"},{name:"æ‰“å¡æ–¹å¼"}]},
      { id: "s-vl-3", title: "å·¥æ—¶è®°å½•", fields: [{name:"ç”Ÿäº§æ‰¹æ¬¡å·"},{name:"ç­¾å…¥æ—¶é—´"},{name:"ç­¾å‡ºæ—¶é—´"},{name:"ä¼‘æ¯æ—¶é•¿"},{name:"å®é™…å·¥ä½œæ—¶é•¿"}]},
      { id: "s-vl-4", title: "è®¾å¤‡/å·¥ä½ç»‘å®š", fields: [{name:"å·¥ä½ç¼–å·"},{name:"å·¥ä½åç§°"},{name:"ç»‘å®šè®¾å¤‡"},{name:"æ‘„åƒå¤´ID"}]},
      { id: "s-vl-5", title: "äº§é‡æ•°æ®", fields: [{name:"äº§å“ç±»å‹"},{name:"è®¡åˆ’äº§é‡"},{name:"å®é™…äº§é‡"},{name:"åˆæ ¼å“æ•°é‡"},{name:"ä¸è‰¯å“æ•°é‡"},{name:"è¿”å·¥æ•°é‡"}]},
      { id: "s-vl-6", title: "å·¥åºå…³è”", fields: [{name:"å·¥åºç±»å‹"},{name:"å…³è”æ‰¹æ¬¡"},{name:"å·¥åºå¼€å§‹æ—¶é—´"},{name:"å·¥åºç»“æŸæ—¶é—´"}]}
    ]
  },
  {
    id: "m1", name: "åŸºç¡€æ•°æ®", icon: "ğŸ“¦",
    desc: "åŸææ–™ã€äº§å“ã€ä¾›åº”å•†ã€å®¢æˆ·ã€è®¾å¤‡",
    sections: [
      { id: "s3-1", title: "åŸææ–™ç±»å‹", fields: [{name:"ææ–™ç¼–ç "},{name:"ææ–™åç§°"},{name:"ææ–™åˆ†ç±»"},{name:"è®¡é‡å•ä½"},{name:"å‚è€ƒå•ä»·"},{name:"å­˜å‚¨ç±»å‹"},{name:"ä¿è´¨æœŸå¤©æ•°"},{name:"æœ€ä½åº“å­˜é¢„è­¦"},{name:"æœ€é«˜åº“å­˜ä¸Šé™"},{name:"å¤‡æ³¨"}]},
      { id: "s3-2", title: "äº§å“ç±»å‹", fields: [{name:"äº§å“ç¼–ç "},{name:"äº§å“åç§°"},{name:"äº§å“åˆ†ç±»"},{name:"è®¡é‡å•ä½"},{name:"å‡ºå‚å•ä»·"},{name:"äº§å“è§„æ ¼"},{name:"åŒ…è£…è§„æ ¼"},{name:"ä¿è´¨æœŸå¤©æ•°"},{name:"æ ‡å‡†å·¥æ—¶"},{name:"å·¥åºæ­¥éª¤"},{name:"äº§å“å›¾ç‰‡"},{name:"å¤‡æ³¨"}]},
      { id: "s3-3", title: "ä¾›åº”å•†ä¿¡æ¯", fields: [{name:"ä¾›åº”å•†ç¼–ç "},{name:"ä¾›åº”å•†åç§°"},{name:"è”ç³»äºº"},{name:"è”ç³»ç”µè¯"},{name:"é‚®ç®±"},{name:"åœ°å€"},{name:"è¥ä¸šæ‰§ç…§å·"},{name:"ç»è¥ç±»å‹"},{name:"ä¾›åº”ææ–™"},{name:"èµ„è´¨è¯ä¹¦"},{name:"ä»˜æ¬¾æ¡ä»¶"},{name:"ä¾›è´§å‘¨æœŸ"},{name:"ä¿¡ç”¨é¢åº¦"},{name:"ä¾›åº”å•†è¯„åˆ†"}]},
      { id: "s3-4", title: "å®¢æˆ·ä¿¡æ¯", fields: [{name:"å®¢æˆ·ç¼–ç "},{name:"å®¢æˆ·åç§°"},{name:"å®¢æˆ·ç±»å‹"},{name:"è¡Œä¸š"},{name:"è”ç³»äºº"},{name:"è”ç³»ç”µè¯"},{name:"æ”¶è´§åœ°å€"},{name:"å¼€ç¥¨åœ°å€"},{name:"ç¨å·"},{name:"ä»˜æ¬¾æ¡ä»¶"},{name:"ä¿¡ç”¨é¢åº¦"},{name:"å®¢æˆ·è¯„åˆ†"}]},
      { id: "s3-5", title: "è®¾å¤‡ä¿¡æ¯", fields: [{name:"è®¾å¤‡ç¼–ç "},{name:"è®¾å¤‡åç§°"},{name:"è®¾å¤‡ç±»å‹"},{name:"å‹å·"},{name:"åˆ¶é€ å•†"},{name:"åºåˆ—å·"},{name:"è´­å…¥æ—¥æœŸ"},{name:"è´­å…¥ä»·æ ¼"},{name:"æŠ˜æ—§å¹´é™"},{name:"æ¯å°æ—¶æˆæœ¬"},{name:"åŠŸç‡"},{name:"å®‰è£…ä½ç½®"},{name:"ä¿å…»å‘¨æœŸ"},{name:"ä¿ä¿®åˆ°æœŸ"}]},
      { id: "s3-6", title: "äº§å“é…æ–¹ï¼ˆBOMï¼‰", fields: [{name:"äº§å“ç±»å‹"},{name:"åŸææ–™ç±»å‹"},{name:"æ ‡å‡†ç”¨é‡"},{name:"å¾—ç‡"},{name:"å‚è€ƒå•ä»·"},{name:"ç¨ç‡"}]}
    ]
  },
  {
    id: "m2", name: "ç”Ÿäº§ç®¡ç†", icon: "ğŸ­",
    desc: "ç”Ÿäº§è®¡åˆ’ã€æ‰¹æ¬¡æ‰§è¡Œã€å·¥åºè®°å½•ã€è´¨æ£€",
    sections: [
      { id: "s4-2", title: "ç”Ÿäº§è®¡åˆ’", fields: [{name:"è®¡åˆ’ç¼–å·"},{name:"äº§å“ç±»å‹"},{name:"è®¡åˆ’æ•°é‡"},{name:"è®¡é‡å•ä½"},{name:"è®¡åˆ’å¼€å§‹æ—¶é—´"},{name:"è®¡åˆ’ç»“æŸæ—¶é—´"},{name:"ä¼˜å…ˆçº§"},{name:"è®¡åˆ’çŠ¶æ€"},{name:"è®¡åˆ’ç±»å‹"},{name:"æ¥æºç±»å‹"},{name:"å®¢æˆ·è®¢å•å·"},{name:"å®¢æˆ·åç§°"},{name:"é¢„ä¼°ææ–™æˆæœ¬"},{name:"é¢„ä¼°äººå·¥æˆæœ¬"},{name:"å¤‡æ³¨"}]},
      { id: "s4-3", title: "ç”Ÿäº§æ‰¹æ¬¡", fields: [{name:"æ‰¹æ¬¡å·"},{name:"å…³è”è®¡åˆ’"},{name:"äº§å“ç±»å‹"},{name:"è®¡åˆ’äº§é‡"},{name:"æŠ•å…¥é‡"},{name:"å®é™…äº§é‡"},{name:"è‰¯å“æ•°é‡"},{name:"ä¸è‰¯å“æ•°é‡"},{name:"å¾—ç‡"},{name:"ç”Ÿäº§æ•ˆç‡"},{name:"æ‰¹æ¬¡çŠ¶æ€"},{name:"è´¨é‡çŠ¶æ€"},{name:"å¼€å§‹æ—¶é—´"},{name:"ç»“æŸæ—¶é—´"},{name:"ä½¿ç”¨è®¾å¤‡"},{name:"ç”Ÿäº§è´Ÿè´£äºº"},{name:"å·¥äººæ•°é‡"},{name:"ææ–™æˆæœ¬"},{name:"äººå·¥æˆæœ¬"},{name:"è®¾å¤‡æˆæœ¬"},{name:"æ€»æˆæœ¬"},{name:"å•ä½æˆæœ¬"},{name:"å¤‡æ³¨"}]},
      { id: "s4-4", title: "å·¥åºè¿‡ç¨‹è®°å½•", fields: [{name:"å…³è”æ‰¹æ¬¡"},{name:"å·¥åºç±»å‹"},{name:"å¼€å§‹æ—¶é—´"},{name:"ç»“æŸæ—¶é—´"},{name:"å·¥åºæ—¶é•¿"},{name:"æŠ•å…¥é‡é‡"},{name:"äº§å‡ºé‡é‡"},{name:"æŸè€—é‡é‡"},{name:"æŸè€—ç‡"},{name:"åˆæ ¼æ•°é‡"},{name:"ä¸åˆæ ¼æ•°é‡"},{name:"è¿”å·¥æ•°é‡"},{name:"ç¯å¢ƒæ¸©åº¦"},{name:"äº§å“æ¸©åº¦"},{name:"ç›®æ ‡æ¸©åº¦"},{name:"ä½¿ç”¨è®¾å¤‡"},{name:"è®¾å¤‡è¿è¡Œæ—¶é•¿"},{name:"è®¾å¤‡åœæœºæ—¶é•¿"},{name:"è®¾å¤‡OEE"},{name:"ç”¨æ°´é‡"},{name:"ç”¨ç”µé‡"},{name:"æ“ä½œå‘˜"},{name:"å·¥äººæ•°é‡"},{name:"pHå€¼"},{name:"ç›åº¦"},{name:"ATPæ£€æµ‹å€¼"},{name:"å¤‡æ³¨"}]},
      { id: "s4-5", title: "åŸææ–™æ¶ˆè€—è®°å½•", fields: [{name:"å…³è”ç”Ÿäº§æ‰¹æ¬¡"},{name:"åŸææ–™æ‰¹æ¬¡"},{name:"æ¶ˆè€—æ•°é‡"},{name:"å•ä»·"},{name:"æ¶ˆè€—é‡‘é¢"},{name:"æ¶ˆè€—æ—¶é—´"},{name:"è®°å½•äºº"},{name:"å¤‡æ³¨"}]},
      { id: "s4-6", title: "è´¨é‡æ£€éªŒè®°å½•", fields: [{name:"å…³è”ç”Ÿäº§æ‰¹æ¬¡"},{name:"è´¨æ£€å‘˜"},{name:"æ£€éªŒæ—¥æœŸ"},{name:"æŠ½æ ·æ•°é‡"},{name:"åˆæ ¼æ•°é‡"},{name:"ä¸åˆæ ¼æ•°é‡"},{name:"åˆæ ¼ç‡"},{name:"æ£€éªŒç»“è®º"},{name:"æ£€éªŒè¯¦æƒ…"}]}
    ]
  },
  {
    id: "m3", name: "äººæ•ˆç®¡ç†", icon: "ğŸ‘·",
    desc: "å‘˜å·¥è€ƒå‹¤ã€å·¥æ—¶ç»Ÿè®¡ã€äººå·¥æˆæœ¬",
    sections: [
      { id: "s5-1", title: "è€ƒå‹¤æ‰“å¡è®°å½•", fields: [{name:"å‘˜å·¥"},{name:"æ‰“å¡æ—¥æœŸ"},{name:"ä¸Šç­æ‰“å¡æ—¶é—´"},{name:"ä¸‹ç­æ‰“å¡æ—¶é—´"},{name:"ä¼‘æ¯å¼€å§‹æ—¶é—´"},{name:"ä¼‘æ¯ç»“æŸæ—¶é—´"},{name:"å·¥ä½œæ—¶é•¿"},{name:"ä¼‘æ¯æ—¶é•¿"},{name:"è€ƒå‹¤çŠ¶æ€"},{name:"æ‰“å¡ä½ç½®"},{name:"æ‰“å¡è®¾å¤‡"}]},
      { id: "s5-2", title: "ç”Ÿäº§æ‰¹æ¬¡å·¥æ—¶è®°å½•", fields: [{name:"ç”Ÿäº§æ‰¹æ¬¡"},{name:"å‘˜å·¥"},{name:"ç­¾å…¥æ—¶é—´"},{name:"ç­¾å‡ºæ—¶é—´"},{name:"å·¥ä½œæ—¶é•¿"},{name:"äººå·¥æˆæœ¬"},{name:"åˆ†é…äºº"},{name:"çŠ¶æ€"},{name:"å¤‡æ³¨"}]}
    ]
  },
  {
    id: "m4", name: "ä»“å‚¨ç‰©æµ", icon: "ğŸšš",
    desc: "åŸææ–™å…¥åº“ã€æˆå“å‡ºè´§ã€æº¯æºæ ‡ç­¾",
    sections: [
      { id: "s4-1", title: "åŸææ–™å…¥åº“", fields: [{name:"æ‰¹æ¬¡å·"},{name:"åŸææ–™ç±»å‹"},{name:"ä¾›åº”å•†"},{name:"å…¥åº“æ•°é‡"},{name:"è®¡é‡å•ä½"},{name:"å•ä»¶é‡é‡"},{name:"è¿›è´§å•ä»·"},{name:"å…¥åº“æ—¥æœŸ"},{name:"ç”Ÿäº§æ—¥æœŸ"},{name:"åˆ°æœŸæ—¥æœŸ"},{name:"å­˜å‚¨ä½ç½®"},{name:"è´¨æ£€è¯ä¹¦"},{name:"å…¥åº“çŠ¶æ€"},{name:"å¤‡æ³¨"}]},
      { id: "s4-7", title: "å‡ºè´§å‘è¿è®°å½•", fields: [{name:"å‡ºè´§å•å·"},{name:"å®¢æˆ·"},{name:"è®¢å•å·"},{name:"äº§å“åç§°"},{name:"å‡ºè´§æ•°é‡"},{name:"è®¡é‡å•ä½"},{name:"å•ä»·"},{name:"æ€»é‡‘é¢"},{name:"å‘è´§æ—¥æœŸ"},{name:"æ”¶è´§åœ°å€"},{name:"ç‰©æµå…¬å¸"},{name:"è¿å•å·"},{name:"å‡ºè´§çŠ¶æ€"},{name:"å¤‡æ³¨"}]},
      { id: "s4-8", title: "æº¯æºæ ‡ç­¾", fields: [{name:"æ ‡ç­¾ç¼–ç "},{name:"æ ‡ç­¾ç±»å‹"},{name:"å…³è”ç±»å‹"},{name:"å…³è”æ‰¹æ¬¡"},{name:"æº¯æºç "},{name:"äºŒç»´ç å†…å®¹"},{name:"äº§å“åç§°"},{name:"äº§å“è§„æ ¼"},{name:"ç”Ÿäº§æ—¥æœŸ"},{name:"ä¿è´¨æœŸ"},{name:"åˆ°æœŸæ—¥æœŸ"},{name:"æ ‡ç­¾çŠ¶æ€"},{name:"æ‰“å°æ¬¡æ•°"},{name:"è´´æ ‡æ—¶é—´"}]}
    ]
  },
  {
    id: "m5", name: "å…¶ä»–", icon: "ğŸ“Š",
    desc: "åºŸå¼ƒå¤„ç½®ã€ç¯å¢ƒç›‘æ§",
    sections: [
      { id: "s6-1", title: "åºŸå¼ƒå¤„ç½®è®°å½•", fields: [{name:"å¤„ç½®ç±»å‹"},{name:"æ•°é‡"},{name:"åŸå› "},{name:"æ—¥æœŸ"},{name:"å¤„ç½®æ–¹å¼"},{name:"é¢„ä¼°æŸå¤±"},{name:"å®é™…æŸå¤±"},{name:"å›æ”¶ä»·å€¼"},{name:"å®¡æ‰¹äºº"},{name:"å®¡æ‰¹æ—¥æœŸ"}]},
      { id: "s7-1", title: "ç¯å¢ƒç›‘æ§æ•°æ®", fields: [{name:"ç›‘æ§è®¾å¤‡"},{name:"æ•°æ®ç±»å‹"},{name:"ç›‘æ§å€¼"},{name:"ä½ç½®"},{name:"é‡‡é›†æ—¶é—´"},{name:"æ•°æ®æ¥æº"}]}
    ]
  }
];

const TOTAL_FIELDS = MODULES.reduce((sum, m) => sum + m.sections.reduce((s, sec) => s + sec.fields.length, 0), 0);

// ========== State ==========
let state = {
  currentStep: 1,
  companyId: null,
  selectedModules: [],
  currentModuleIndex: 0,
  conversations: {},
  moduleSummaries: {},
  completedModules: [],
  chatLoading: false,
  assessmentData: null,
  resultData: null,
};

try {
  const saved = localStorage.getItem('onboarding_wizard_state');
  if (saved) {
    const parsed = JSON.parse(saved);
    Object.assign(state, parsed);
  }
} catch(e) {}

function saveState() {
  try { localStorage.setItem('onboarding_wizard_state', JSON.stringify(state)); } catch(e) {}
}

// ========== Step Navigation ==========
function goToStep(n) {
  state.currentStep = n;
  saveState();
  renderStep();
}

function renderStep() {
  for (let i = 1; i <= 5; i++) {
    const el = document.getElementById('step' + i);
    const wasHidden = el.classList.contains('hidden');
    el.classList.toggle('hidden', i !== state.currentStep);
    // Trigger animation when step becomes visible
    if (wasHidden && i === state.currentStep) {
      el.classList.remove('animate-in');
      void el.offsetHeight;
      el.classList.add('animate-in');
    }
  }
  document.querySelectorAll('.step-dot').forEach(dot => {
    const s = parseInt(dot.dataset.step);
    dot.classList.remove('active', 'completed');
    if (s === state.currentStep) dot.classList.add('active');
    else if (s < state.currentStep) dot.classList.add('completed');
  });
  document.querySelectorAll('.step-line').forEach((line, i) => {
    line.classList.toggle('completed', i + 1 < state.currentStep);
  });
  // Scroll to top smoothly
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ========== Step 1 ==========
function goToStep2() {
  const name = document.getElementById('factoryName').value.trim();
  if (!name) { alert('è¯·è¾“å…¥å·¥å‚åç§°'); return; }
  goToStep(2);
  renderModuleGrid();
}

// ========== Step 2: Module Selection ==========
function renderModuleGrid() {
  const grid = document.getElementById('moduleGrid');
  grid.innerHTML = '';
  MODULES.forEach((m, idx) => {
    const fieldCount = m.sections.reduce((s, sec) => s + sec.fields.length, 0);
    const selected = state.selectedModules.includes(m.id);
    const div = document.createElement('div');
    div.className = 'module-card' + (selected ? ' selected' : '');
    div.onclick = () => toggleModule(m.id);
    div.style.animationDelay = (idx * 0.06) + 's';
    div.innerHTML = `
      <div class="check">&#10003;</div>
      <div class="icon">${m.icon}</div>
      <div class="name">${m.name}</div>
      <div class="desc">${m.desc}</div>
      <div class="field-count">${fieldCount} ä¸ªæ•°æ®å­—æ®µ</div>
    `;
    grid.appendChild(div);
  });
  updateStep2Btn();
}

function toggleModule(id) {
  const idx = state.selectedModules.indexOf(id);
  if (idx >= 0) state.selectedModules.splice(idx, 1);
  else state.selectedModules.push(id);
  saveState();
  renderModuleGrid();
}

function updateStep2Btn() {
  document.getElementById('btnStep2Next').disabled = state.selectedModules.length === 0;
}

// ========== Step 3: AI Chat ==========
async function goToStep3() {
  goToStep(3);
  state.currentModuleIndex = 0;

  // Create company if not yet created (needed for chat API)
  if (!state.companyId) {
    try {
      const resp = await fetch(API_BASE + '/wizard/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json; charset=utf-8' },
        body: JSON.stringify(getBasicInfo())
      });
      const data = await resp.json();
      if (data.success) {
        state.companyId = data.data.companyId;
        saveState();
      }
    } catch(e) {
      console.error('Failed to create company:', e);
    }
  }

  const selectedMods = state.selectedModules.filter(m => !state.completedModules.includes(m));
  if (selectedMods.length === 0) {
    goToStep4();
    return;
  }
  await startModuleChat();
}

function getCurrentModuleId() {
  const remaining = state.selectedModules.filter(m => !state.completedModules.includes(m));
  return remaining.length > 0 ? remaining[0] : null;
}

async function startModuleChat() {
  const moduleId = getCurrentModuleId();
  if (!moduleId) { goToStep4(); return; }

  const mod = MODULES.find(m => m.id === moduleId);
  const completedCount = state.completedModules.length;
  const totalSelected = state.selectedModules.length;
  document.getElementById('chatModuleLabel').textContent =
    `æ¨¡å— ${completedCount + 1}/${totalSelected}: ${mod ? mod.name : moduleId}`;

  if (!state.conversations[moduleId]) {
    state.conversations[moduleId] = [];
  }

  renderChat();

  if (state.conversations[moduleId].length === 0) {
    state.chatLoading = true;
    renderChat();

    try {
      const basicInfo = getBasicInfo();
      const resp = await fetch(API_BASE + '/wizard/start-module', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json; charset=utf-8' },
        body: JSON.stringify({
          companyId: state.companyId || 'preview',
          moduleId: moduleId,
          selectedModules: state.selectedModules,
          priorModulesSummary: state.moduleSummaries,
        })
      });
      const data = await resp.json();
      if (data.success) {
        const d = data.data;
        state.conversations[moduleId].push({ role: 'assistant', content: d.message });
        handleAIResponse(d);
      } else {
        console.warn('Start module API returned:', data.message);
        const fallbackMsg = mod
          ? `æ‚¨å¥½ï¼è®©æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹è´µå·¥å‚åœ¨ã€Œ${mod.name}ã€æ–¹é¢çš„æƒ…å†µã€‚è¯·ç®€è¦æè¿°ä¸€ä¸‹ç›®å‰çš„ç®¡ç†æµç¨‹å’Œæ•°æ®è®°å½•æ–¹å¼ã€‚`
          : 'æ‚¨å¥½ï¼è¯·æè¿°ä¸€ä¸‹è´µå·¥å‚åœ¨è¿™ä¸ªæ¨¡å—æ–¹é¢çš„åŸºæœ¬æƒ…å†µã€‚';
        state.conversations[moduleId].push({ role: 'assistant', content: fallbackMsg });
      }
    } catch(e) {
      console.error('Start module chat failed:', e);
      const fallbackMsg = mod
        ? `æ‚¨å¥½ï¼è®©æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹è´µå·¥å‚åœ¨ã€Œ${mod.name}ã€æ–¹é¢çš„æƒ…å†µã€‚è¯·ç®€è¦æè¿°ä¸€ä¸‹ç›®å‰çš„ç®¡ç†æµç¨‹å’Œæ•°æ®è®°å½•æ–¹å¼ã€‚`
        : 'æ‚¨å¥½ï¼è¯·æè¿°ä¸€ä¸‹è´µå·¥å‚åœ¨è¿™ä¸ªæ¨¡å—æ–¹é¢çš„åŸºæœ¬æƒ…å†µã€‚';
      state.conversations[moduleId].push({ role: 'assistant', content: fallbackMsg });
    }
    state.chatLoading = false;
    saveState();
    renderChat();
  }
}

async function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg || state.chatLoading) return;
  input.value = '';

  const moduleId = getCurrentModuleId();
  if (!moduleId) return;

  state.conversations[moduleId].push({ role: 'user', content: msg });
  state.chatLoading = true;
  saveState();
  renderChat();

  try {
    const resp = await fetch(API_BASE + '/wizard/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json; charset=utf-8' },
      body: JSON.stringify({
        companyId: state.companyId || 'preview',
        moduleId: moduleId,
        message: msg,
        conversationHistory: state.conversations[moduleId],
      })
    });
    const data = await resp.json();
    if (data.success) {
      const d = data.data;
      state.conversations[moduleId].push({ role: 'assistant', content: d.message });
      handleAIResponse(d);
    } else {
      state.conversations[moduleId].push({ role: 'assistant', content: data.message || 'æŠ±æ­‰ï¼ŒAI æš‚æ—¶æ— æ³•å›å¤ã€‚è¯·å†è¯•ä¸€æ¬¡ã€‚' });
    }
  } catch(e) {
    state.conversations[moduleId].push({ role: 'assistant', content: 'æŠ±æ­‰ï¼Œæš‚æ—¶æ— æ³•è¿æ¥AIæœåŠ¡ã€‚è¯·ç¨åé‡è¯•ã€‚' });
  }

  state.chatLoading = false;
  saveState();
  renderChat();
}

function sendQuickReply(text) {
  document.getElementById('chatInput').value = text;
  sendChat();
}

let lastAIResponse = null;

function handleAIResponse(d) {
  lastAIResponse = d;
  if (d.moduleComplete) {
    const moduleId = getCurrentModuleId();
    if (moduleId && d.moduleSummary) {
      state.moduleSummaries[moduleId] = d.moduleSummary;
    }
    if (moduleId && !state.completedModules.includes(moduleId)) {
      state.completedModules.push(moduleId);
    }
    saveState();
  }
  updateChatButtons();
}

function updateChatButtons() {
  const remaining = state.selectedModules.filter(m => !state.completedModules.includes(m));
  const btnNext = document.getElementById('btnNextModule');
  const btnAssess = document.getElementById('btnToAssess');

  if (lastAIResponse && lastAIResponse.moduleComplete) {
    if (remaining.length > 0) {
      btnNext.classList.remove('hidden');
      btnAssess.classList.add('hidden');
    } else {
      btnNext.classList.add('hidden');
      btnAssess.classList.remove('hidden');
    }
  } else {
    btnNext.classList.add('hidden');
    btnAssess.classList.add('hidden');
  }
}

function skipModule() {
  const moduleId = getCurrentModuleId();
  if (moduleId && !state.completedModules.includes(moduleId)) {
    state.completedModules.push(moduleId);
    state.moduleSummaries[moduleId] = '(è·³è¿‡)';
  }
  saveState();
  nextModule();
}

async function nextModule() {
  lastAIResponse = null;
  document.getElementById('btnNextModule').classList.add('hidden');
  const remaining = state.selectedModules.filter(m => !state.completedModules.includes(m));
  if (remaining.length === 0) {
    goToStep4();
  } else {
    await startModuleChat();
  }
}

function renderChat() {
  const body = document.getElementById('chatBody');
  const moduleId = getCurrentModuleId();
  if (!moduleId) { body.innerHTML = ''; return; }

  const msgs = state.conversations[moduleId] || [];
  let html = '';

  msgs.forEach((msg, i) => {
    const isAI = msg.role === 'assistant';
    html += `<div class="chat-msg ${isAI ? 'ai' : 'user'}">
      <div class="chat-avatar">${isAI ? 'ğŸ¤–' : 'ğŸ‘¤'}</div>
      <div class="chat-bubble">${escapeHtml(msg.content)}</div>
    </div>`;
  });

  if (lastAIResponse && lastAIResponse.suggestedReplies && lastAIResponse.suggestedReplies.length > 0 && !state.chatLoading) {
    html += '<div class="quick-replies">';
    lastAIResponse.suggestedReplies.forEach(r => {
      html += `<button class="quick-reply-btn" onclick="sendQuickReply('${escapeAttr(r)}')">${escapeHtml(r)}</button>`;
    });
    html += '</div>';
  }

  if (lastAIResponse && (lastAIResponse.topicsCovered?.length || lastAIResponse.topicsRemaining?.length)) {
    html += '<div class="topics-bar">';
    if (lastAIResponse.topicsCovered?.length) {
      html += `<span class="covered">&#10003; å·²è¦†ç›–: ${lastAIResponse.topicsCovered.join(', ')}</span>`;
    }
    if (lastAIResponse.topicsRemaining?.length) {
      html += `<span class="remaining">&#9679; å¾…äº†è§£: ${lastAIResponse.topicsRemaining.join(', ')}</span>`;
    }
    html += '</div>';
  }

  if (lastAIResponse && lastAIResponse.moduleComplete) {
    const summary = lastAIResponse.moduleSummary || state.moduleSummaries[moduleId] || '';
    html += `<div class="module-complete-card">
      <h4>&#10003; æ¨¡å—è°ƒç ”å®Œæˆ</h4>
      <p>${escapeHtml(summary)}</p>
    </div>`;
  }

  if (state.chatLoading) {
    html += `<div class="chat-loading"><div class="dots"><span></span><span></span><span></span></div> AI æ­£åœ¨æ€è€ƒ...</div>`;
  }

  body.innerHTML = html;
  body.scrollTop = body.scrollHeight;
  updateChatButtons();
}

// ========== Step 4: Assessment ==========
async function goToStep4() {
  goToStep(4);
  document.getElementById('btnFinalize').disabled = true;

  try {
    const resp = await fetch(API_BASE + '/wizard/assess', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json; charset=utf-8' },
      body: JSON.stringify({
        companyId: state.companyId || 'preview',
        selectedModules: state.selectedModules,
        allConversations: state.conversations,
      })
    });
    const data = await resp.json();
    if (data.success) {
      state.assessmentData = data.data;
      saveState();
      renderAssessment(data.data);
      document.getElementById('btnFinalize').disabled = false;
    } else {
      document.getElementById('assessContent').innerHTML =
        `<div style="color:var(--danger);padding:20px;">è¯„ä¼°å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
    }
  } catch(e) {
    document.getElementById('assessContent').innerHTML =
      `<div style="color:var(--danger);padding:20px;">æ— æ³•è¿æ¥AIæœåŠ¡: ${e.message}</div>`;
  }
}

function renderAssessment(data) {
  const confClass = data.confidence >= 0.8 ? 'conf-high' : data.confidence >= 0.6 ? 'conf-med' : 'conf-low';
  let html = `
    <div class="assess-summary">
      <strong>${escapeHtml(data.summary || '')}</strong>
      <span class="confidence ${confClass}" style="margin-left:12px;">
        ç½®ä¿¡åº¦: ${Math.round((data.confidence || 0) * 100)}%
      </span>
    </div>
  `;

  if (data.moduleInsights && Object.keys(data.moduleInsights).length > 0) {
    html += '<h3 style="margin-top:16px;">æ¨¡å—æ´å¯Ÿ</h3>';
    for (const [mid, insight] of Object.entries(data.moduleInsights)) {
      const mod = MODULES.find(m => m.id === mid);
      html += `<div style="padding:10px 14px;margin:6px 0;background:rgba(99,102,241,0.04);border:1px solid rgba(99,102,241,0.08);border-radius:10px;font-size:14px;">
        <strong>${mod ? mod.icon + ' ' + mod.name : mid}:</strong> ${escapeHtml(insight)}
      </div>`;
    }
  }

  if (data.items && data.items.length > 0) {
    html += `<h3 style="margin-top:20px;">å­—æ®µè¯„ä¼° (${data.items.length} é¡¹)</h3>
    <div style="max-height:300px;overflow-y:auto;border-radius:10px;border:1px solid rgba(0,0,0,0.04);">
    <table class="assess-table">
      <thead><tr><th>æ¨¡å—</th><th>å­—æ®µ</th><th>é€‚ç”¨</th><th>ç½®ä¿¡åº¦</th><th>è¾“å…¥æ–¹å¼</th><th>ç†ç”±</th></tr></thead>
      <tbody>`;
    data.items.forEach(item => {
      const confC = item.confidence >= 0.8 ? 'conf-high' : item.confidence >= 0.6 ? 'conf-med' : 'conf-low';
      html += `<tr>
        <td>${escapeHtml(item.section || '')}</td>
        <td>${escapeHtml(item.fieldName || '')}</td>
        <td>${item.applicable ? '<span style="color:var(--success);font-weight:700;">&#10003;</span>' : '<span style="color:var(--text-muted);">&#10007;</span>'}</td>
        <td><span class="confidence ${confC}" style="font-size:11px;">${Math.round(item.confidence * 100)}%</span></td>
        <td><span style="font-size:12px;color:var(--text-secondary);">${escapeHtml(item.inputMode || '')}</span></td>
        <td style="font-size:12px;color:var(--text-secondary);">${escapeHtml(item.reasoning || '')}</td>
      </tr>`;
    });
    html += '</tbody></table></div>';
  }

  if (data.stageTemplates && data.stageTemplates.length > 0) {
    html += '<h3 style="margin-top:20px;">å·¥åºæ¨¡æ¿</h3><div style="display:flex;gap:8px;flex-wrap:wrap;">';
    data.stageTemplates.forEach(s => {
      const style = s.isKey
        ? 'background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.2);color:var(--primary);'
        : 'background:rgba(0,0,0,0.03);border:1px solid rgba(0,0,0,0.06);color:var(--text-secondary);';
      html += `<div style="${style}padding:7px 14px;border-radius:100px;font-size:13px;font-weight:500;">
        ${s.order}. ${escapeHtml(s.displayName || s.stageName)}${s.isKey ? ' <strong style="color:var(--primary);">(å…³é”®)</strong>' : ''}
      </div>`;
    });
    html += '</div>';
  }

  document.getElementById('assessContent').innerHTML = html;
}

// ========== Step 5: Finalize ==========
async function goToStep5() {
  goToStep(5);

  if (!state.companyId) {
    try {
      const resp = await fetch(API_BASE + '/wizard/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json; charset=utf-8' },
        body: JSON.stringify(getBasicInfo())
      });
      const data = await resp.json();
      if (data.success) {
        state.companyId = data.data.companyId;
        saveState();
      }
    } catch(e) {
      console.error('Failed to create company:', e);
    }
  }

  try {
    const resp = await fetch(API_BASE + '/wizard/finalize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json; charset=utf-8' },
      body: JSON.stringify({
        companyId: state.companyId,
        assessmentData: state.assessmentData || {},
      })
    });
    const data = await resp.json();
    if (data.success) {
      state.resultData = data.data;
      saveState();
      renderResult(data.data);
    } else {
      document.getElementById('resultContent').innerHTML =
        `<div style="color:var(--danger);padding:20px;">åˆ›å»ºå¤±è´¥: ${escapeHtml(data.message || 'æœªçŸ¥é”™è¯¯')}</div>`;
    }
  } catch(e) {
    document.getElementById('resultContent').innerHTML =
      `<div style="color:var(--danger);padding:20px;">è¿æ¥å¤±è´¥: ${e.message}</div>`;
  }
}

function renderResult(data) {
  const users = data.users || [];
  let usersHtml = '';
  if (users.length > 0) {
    usersHtml = users.map(u => `<div style="font-size:13px;color:var(--text);">${u.username || u.name} <span style="color:var(--text-muted);">(å¯†ç : 123456)</span></div>`).join('');
  } else {
    usersHtml = '<div style="font-size:13px;color:var(--text-muted);">é»˜è®¤ç”¨æˆ·å·²åˆ›å»ºï¼ˆå¯†ç : 123456ï¼‰</div>';
  }

  document.getElementById('resultContent').innerHTML = `
    <div class="icon">&#10003;</div>
    <h2>å·¥å‚åˆ›å»ºæˆåŠŸ!</h2>
    <p style="color:var(--text-secondary);font-size:15px;">æ‚¨çš„å·¥å‚å·²æˆåŠŸå…¥é©»ç™½å©çºªé£Ÿå“æº¯æºç³»ç»Ÿ</p>
    <div class="result-info">
      <div class="result-item">
        <div class="label">å·¥å‚ ID</div>
        <div class="value">${escapeHtml(data.factoryId || '')}</div>
      </div>
      <div class="result-item">
        <div class="label">è¡¨å•æ¨¡æ¿</div>
        <div class="value">${data.formTemplatesCreated || 0} ä¸ª</div>
      </div>
      <div class="result-item">
        <div class="label">é¢„è­¦è§„åˆ™</div>
        <div class="value">${data.alertsCreated || 0} æ¡</div>
      </div>
      <div class="result-item">
        <div class="label">é»˜è®¤ç”¨æˆ·</div>
        <div class="value">${usersHtml}</div>
      </div>
    </div>
    <div style="margin-top:28px;">
      <button class="btn btn-primary" onclick="resetWizard()">åˆ›å»ºå¦ä¸€ä¸ªå·¥å‚</button>
    </div>
  `;
}

function resetWizard() {
  state = {
    currentStep: 1,
    companyId: null,
    selectedModules: [],
    currentModuleIndex: 0,
    conversations: {},
    moduleSummaries: {},
    completedModules: [],
    chatLoading: false,
    assessmentData: null,
    resultData: null,
  };
  localStorage.removeItem('onboarding_wizard_state');
  document.getElementById('factoryName').value = '';
  document.getElementById('contactName').value = '';
  document.getElementById('contactPhone').value = '';
  document.getElementById('industry').value = '';
  document.getElementById('scale').value = '';
  document.getElementById('products').value = '';
  document.getElementById('description').value = '';
  goToStep(1);
}

// ========== Helpers ==========
function getBasicInfo() {
  return {
    factoryName: document.getElementById('factoryName').value.trim(),
    contactName: document.getElementById('contactName').value.trim(),
    contactPhone: document.getElementById('contactPhone').value.trim(),
    industry: document.getElementById('industry').value,
    scale: document.getElementById('scale').value,
    products: document.getElementById('products').value.trim(),
    description: document.getElementById('description').value.trim(),
  };
}

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function escapeAttr(str) {
  if (!str) return '';
  return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

// ========== Init ==========
renderStep();
if (state.currentStep === 2) renderModuleGrid();
</script>
</body>
</html>
