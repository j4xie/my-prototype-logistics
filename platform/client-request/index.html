<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ•°æ®é‡‡é›†èƒ½åŠ›è°ƒç ” - ç™½å©çºªé£Ÿå“æº¯æºç³»ç»Ÿ</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --primary: #1a5276;
  --primary-light: #2980b9;
  --success: #27ae60;
  --danger: #e74c3c;
  --warning: #f39c12;
  --gray: #95a5a6;
  --light: #f8f9fa;
  --border: #e0e0e0;
  --text: #333;
  --radius: 8px;
}

body {
  font-family: "Microsoft YaHei", "PingFang SC", -apple-system, sans-serif;
  background: #f0f2f5;
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
}

/* ç™»å½•é®ç½© */
.login-overlay {
  position: fixed;
  inset: 0;
  background: linear-gradient(135deg, #1a5276 0%, #2c3e50 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
}
.login-overlay.hidden { display: none; }

.login-box {
  background: #fff;
  border-radius: 12px;
  padding: 40px;
  width: 100%;
  max-width: 420px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
.login-box h1 {
  color: var(--primary);
  font-size: 22px;
  text-align: center;
  margin-bottom: 8px;
}
.login-box .subtitle {
  color: #666;
  font-size: 14px;
  text-align: center;
  margin-bottom: 30px;
}
.login-box label {
  display: block;
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 6px;
  color: #444;
}
.login-box label .required { color: var(--danger); }
.login-box input {
  width: 100%;
  padding: 12px 14px;
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 15px;
  margin-bottom: 16px;
  transition: border-color 0.2s;
}
.login-box input:focus {
  outline: none;
  border-color: var(--primary);
}
.login-box button {
  width: 100%;
  padding: 14px;
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s;
}
.login-box button:hover { background: var(--primary-light); }
.login-box button:disabled { background: #bdc3c7; cursor: not-allowed; }
.login-error {
  color: var(--danger);
  font-size: 13px;
  text-align: center;
  margin-top: 12px;
}

/* é¡¶éƒ¨å¯¼èˆª */
.header {
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  color: #fff;
  padding: 16px 20px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.header-content {
  max-width: 900px;
  margin: 0 auto;
}
.header h1 { font-size: 18px; font-weight: 600; }
.header .company-name {
  font-size: 13px;
  opacity: 0.9;
  margin-top: 2px;
}
.progress-bar {
  background: rgba(255,255,255,0.2);
  height: 4px;
  border-radius: 2px;
  margin-top: 12px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: #2ecc71;
  transition: width 0.3s;
}
.progress-text {
  font-size: 12px;
  opacity: 0.9;
  margin-top: 6px;
  display: flex;
  justify-content: space-between;
}

/* ä¸»å†…å®¹ */
.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
}

/* è¯´æ˜å¡ç‰‡ */
.intro-card {
  background: #e8f6ff;
  border: 1px solid #b3d9f2;
  border-radius: var(--radius);
  padding: 16px 20px;
  margin-bottom: 20px;
}
.intro-card h3 {
  color: var(--primary);
  font-size: 15px;
  margin-bottom: 8px;
}
.intro-card p {
  font-size: 14px;
  color: #555;
  line-height: 1.7;
}
.intro-card .icon { font-size: 18px; margin-right: 6px; }
.intro-card .tip {
  margin-top: 10px;
  padding: 10px 12px;
  background: #fff;
  border-radius: 6px;
  font-size: 13px;
  color: #666;
}
.intro-card .tip b { color: var(--primary); }

/* æ¨¡å—å®¹å™¨ */
.module {
  margin-bottom: 24px;
}
.module-header {
  background: linear-gradient(135deg, var(--primary), #34495e);
  color: #fff;
  padding: 14px 20px;
  border-radius: var(--radius) var(--radius) 0 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
}
.module-header:hover { opacity: 0.95; }
.module-title {
  font-size: 16px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
}
.module-title .icon { font-size: 20px; }
.module-title .toggle-icon {
  font-size: 12px;
  transition: transform 0.2s;
}
.module.collapsed .module-title .toggle-icon { transform: rotate(-90deg); }
.module-desc {
  font-size: 12px;
  opacity: 0.85;
}
.module-stats {
  font-size: 13px;
  background: rgba(255,255,255,0.2);
  padding: 4px 12px;
  border-radius: 12px;
}
.module-content {
  background: #fff;
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 var(--radius) var(--radius);
}
.module.collapsed .module-content { display: none; }

/* ç« èŠ‚ */
.section {
  border-bottom: 1px solid #eee;
}
.section:last-child { border-bottom: none; }
.section-header {
  padding: 12px 18px;
  background: var(--light);
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  user-select: none;
}
.section-header:hover { background: #eef2f5; }
.section-title {
  font-size: 14px;
  font-weight: 600;
  color: #444;
  display: flex;
  align-items: center;
  gap: 8px;
}
.section-title .toggle-icon {
  font-size: 10px;
  color: #888;
  transition: transform 0.2s;
}
.section.collapsed .toggle-icon { transform: rotate(-90deg); }

/* å…¨é€‰æŒ‰é’® */
.section-action {
  display: flex;
  align-items: center;
  gap: 8px;
}
.btn-toggle-all {
  padding: 5px 12px;
  border-radius: 14px;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid var(--success);
  background: #e8f5e9;
  color: var(--success);
}
.btn-toggle-all:hover {
  background: var(--success);
  color: #fff;
  transform: scale(1.05);
}
.btn-toggle-all.has-unchecked {
  border-color: var(--warning);
  background: #fff3e0;
  color: #e67e22;
}
.btn-toggle-all.has-unchecked:hover {
  background: var(--warning);
  color: #fff;
}

.section-content {
  padding: 0;
}
.section.collapsed .section-content { display: none; }

/* å­—æ®µè¡Œ */
.field-row {
  display: flex;
  align-items: flex-start;
  padding: 12px 18px;
  border-bottom: 1px solid #f5f5f5;
  transition: background 0.15s;
}
.field-row:last-child { border-bottom: none; }
.field-row:hover { background: #fafbfc; }
.field-row.unchecked { background: #fef9f3; }

/* å‹¾é€‰æ¡† */
.field-checkbox {
  width: 26px;
  height: 26px;
  border: 3px solid #ccc;
  border-radius: 6px;
  margin-right: 12px;
  margin-top: 2px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.2s;
  background: #fff;
}
.field-checkbox:hover {
  border-color: var(--primary);
  transform: scale(1.1);
  box-shadow: 0 2px 8px rgba(26,82,118,0.2);
}
.field-checkbox.checked {
  background: var(--success);
  border-color: var(--success);
}
.field-checkbox.checked:hover {
  background: #219a52;
  border-color: #219a52;
}
.field-checkbox.checked::after {
  content: 'âœ“';
  color: #fff;
  font-size: 14px;
  font-weight: bold;
}

.field-info {
  flex: 1;
  min-width: 0;
}
.field-name {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
  margin-bottom: 2px;
}
.field-row.unchecked .field-name {
  color: #999;
  text-decoration: line-through;
}
.field-example {
  font-size: 12px;
  color: #888;
  margin-bottom: 6px;
}
.field-example span {
  background: #f0f0f0;
  padding: 2px 6px;
  border-radius: 4px;
  margin-left: 4px;
}

/* å¤‡æ³¨è¾“å…¥ */
.note-input {
  margin-top: 4px;
}
.note-input input {
  width: 100%;
  padding: 6px 10px;
  border: 1px solid #e0e0e0;
  border-radius: 4px;
  font-size: 12px;
  background: #fafafa;
  transition: all 0.2s;
}
.note-input input:focus {
  outline: none;
  border-color: var(--primary);
  background: #fff;
  box-shadow: 0 0 0 2px rgba(26,82,118,0.1);
}
.note-input input::placeholder { color: #aaa; }

/* ä¿å­˜çŠ¶æ€æç¤º */
.save-toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #333;
  color: #fff;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 14px;
  opacity: 0;
  transform: translateY(10px);
  transition: all 0.3s;
  z-index: 200;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.save-toast.show {
  opacity: 1;
  transform: translateY(0);
}
.save-toast.success { background: var(--success); }
.save-toast.error { background: var(--danger); }

/* å“åº”å¼ */
@media (max-width: 600px) {
  .login-box { padding: 30px 24px; }
  .container { padding: 12px; }
  .module-header { padding: 12px 14px; flex-wrap: wrap; gap: 8px; }
  .section-header { padding: 10px 14px; }
  .field-row { padding: 10px 14px; }
  .field-checkbox { width: 22px; height: 22px; }
}
</style>
</head>
<body>

<!-- ç™»å½•é®ç½© -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h1>æ•°æ®é‡‡é›†èƒ½åŠ›è°ƒç ”</h1>
    <p class="subtitle">ç™½å©çºªé£Ÿå“æº¯æºç³»ç»Ÿ - è¯·è¾“å…¥å…¬å¸ä¿¡æ¯</p>
    <form id="loginForm">
      <label>å…¬å¸åç§° <span class="required">*</span></label>
      <input type="text" id="companyName" placeholder="è¯·è¾“å…¥æ‚¨çš„å…¬å¸åç§°" required>
      <label>è”ç³»äºº</label>
      <input type="text" id="contactName" placeholder="æ‚¨çš„å§“å">
      <label>è”ç³»ç”µè¯</label>
      <input type="tel" id="contactPhone" placeholder="æ‚¨çš„ç”µè¯å·ç ">
      <button type="submit" id="loginBtn">å¼€å§‹å¡«å†™</button>
    </form>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- ä¸»å†…å®¹ -->
<header class="header">
  <div class="header-content">
    <h1>æ•°æ®é‡‡é›†èƒ½åŠ›è°ƒç ”</h1>
    <div class="company-name" id="displayCompanyName"></div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    <div class="progress-text">
      <span>å¯æä¾›çš„æ•°æ®å­—æ®µ</span>
      <span id="progressText">0 / 0</span>
    </div>
  </div>
</header>

<div class="container">
  <div class="intro-card">
    <h3><span class="icon">ğŸ“‹</span> å¡«å†™è¯´æ˜</h3>
    <p>è¯·å‹¾é€‰è´µå·¥å‚<strong>ç›®å‰å¯ä»¥æä¾›</strong>çš„æ•°æ®å­—æ®µã€‚æ‰€æœ‰å­—æ®µ<strong>é»˜è®¤å·²å‹¾é€‰</strong>ï¼Œå¦‚æœæŸä¸ªå­—æ®µ<strong>æš‚æ—¶æ— æ³•æä¾›</strong>ï¼Œè¯·ç‚¹å‡»å–æ¶ˆå‹¾é€‰ã€‚</p>
    <div class="tip">
      <b>æç¤ºï¼š</b>å¯åœ¨å¤‡æ³¨æ è¯´æ˜æ•°æ®æ¥æºï¼ˆå¦‚"ERPç³»ç»Ÿ"ã€"çº¸è´¨è®°å½•"ã€"éœ€è¦æ”¹é€ "ç­‰ï¼‰
    </div>
  </div>
  <div id="modulesContainer"></div>
</div>

<!-- ä¿å­˜æç¤º -->
<div class="save-toast" id="saveToast"></div>

<script>
const API_BASE = '/api/public/client-requirement';

// æŒ‰æ¨¡å—ç»„ç»‡çš„æ•°æ®ç»“æ„
const MODULES = [
  {
    id: "m0",
    name: "äººæ•ˆæ•°æ®é‡‡é›†ï¼ˆVLè¡¥å……ï¼‰",
    icon: "ğŸ¯",
    desc: "è§†è§‰è¯†åˆ«æ— æ³•è‡ªåŠ¨è·å–ï¼Œéœ€è¦äººå·¥å½•å…¥æˆ–ç³»ç»Ÿå¯¹æ¥çš„å…³é”®å­—æ®µ",
    sections: [
      { id: "s-vl-1", title: "å·¥äººèº«ä»½ä¿¡æ¯", fields: [
        {name:"å·¥å·", example:"EMP035"},
        {name:"å§“å", example:"å¼ ä¸‰"},
        {name:"ç­ç»„", example:"Aç­/Bç­/Cç­"},
        {name:"å·¥ç§/å²—ä½", example:"åŒ…è£…å·¥/åˆ‡å‰²å·¥/è´¨æ£€å‘˜"},
        {name:"æŠ€èƒ½ç­‰çº§", example:"åˆçº§/ä¸­çº§/é«˜çº§"},
        {name:"æ—¶è–ª/æ—¥è–ª", example:"50å…ƒ/å°æ—¶"}
      ]},
      { id: "s-vl-2", title: "è€ƒå‹¤æ‰“å¡", fields: [
        {name:"æ‰“å¡æ—¥æœŸ", example:"2026-01-30"},
        {name:"ä¸Šç­æ‰“å¡æ—¶é—´", example:"07:58:00"},
        {name:"ä¸‹ç­æ‰“å¡æ—¶é—´", example:"17:05:00"},
        {name:"è€ƒå‹¤çŠ¶æ€", example:"æ­£å¸¸/è¿Ÿåˆ°/æ—©é€€/ç¼ºå‹¤"},
        {name:"æ‰“å¡æ–¹å¼", example:"äººè„¸/æŒ‡çº¹/åˆ·å¡/App"}
      ]},
      { id: "s-vl-3", title: "å·¥æ—¶è®°å½•", fields: [
        {name:"ç”Ÿäº§æ‰¹æ¬¡å·", example:"PB-F001-20260130-0001"},
        {name:"ç­¾å…¥æ—¶é—´", example:"08:15:00"},
        {name:"ç­¾å‡ºæ—¶é—´", example:"16:45:00"},
        {name:"ä¼‘æ¯æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰", example:"60"},
        {name:"å®é™…å·¥ä½œæ—¶é•¿", example:"450åˆ†é’Ÿ"}
      ]},
      { id: "s-vl-4", title: "è®¾å¤‡/å·¥ä½ç»‘å®š", fields: [
        {name:"å·¥ä½ç¼–å·", example:"WS-A01"},
        {name:"å·¥ä½åç§°", example:"åŒ…è£…çº¿1å·ä½"},
        {name:"ç»‘å®šè®¾å¤‡", example:"åŒ…è£…æœºA"},
        {name:"æ‘„åƒå¤´ID", example:"CAM-WS-A01"}
      ]},
      { id: "s-vl-5", title: "äº§é‡æ•°æ®ï¼ˆVLè¡¥å……ï¼‰", fields: [
        {name:"äº§å“ç±»å‹", example:"åŸå‘³çŒªè‚‰é¦™è‚  500g"},
        {name:"è®¡åˆ’äº§é‡", example:"500 kg"},
        {name:"å®é™…äº§é‡", example:"480 kg"},
        {name:"åˆæ ¼å“æ•°é‡", example:"465 kg"},
        {name:"ä¸è‰¯å“æ•°é‡", example:"15 kg"},
        {name:"è¿”å·¥æ•°é‡", example:"5 kg"}
      ]},
      { id: "s-vl-6", title: "å·¥åºå…³è”", fields: [
        {name:"å·¥åºç±»å‹", example:"åŒ…è£…/çŒè£…/åˆ‡å‰²/åŒ–æ–™"},
        {name:"å…³è”æ‰¹æ¬¡", example:"PB-F001-20260130-0001"},
        {name:"å·¥åºå¼€å§‹æ—¶é—´", example:"08:15:00"},
        {name:"å·¥åºç»“æŸæ—¶é—´", example:"12:00:00"}
      ]}
    ]
  },
  {
    id: "m1",
    name: "åŸºç¡€æ•°æ®",
    icon: "ğŸ“¦",
    desc: "åŸææ–™ã€äº§å“ã€ä¾›åº”å•†ã€å®¢æˆ·ã€è®¾å¤‡ç­‰åŸºç¡€ä¿¡æ¯",
    sections: [
      { id: "s3-1", title: "åŸææ–™ç±»å‹", fields: [
        {name:"ææ–™ç¼–ç ", example:"RM-PORK-001"},
        {name:"ææ–™åç§°", example:"çŒªåè…¿è‚‰"},
        {name:"ææ–™åˆ†ç±»", example:"è‚‰ç±»/è°ƒå‘³æ–™/åŒ…è£…ææ–™"},
        {name:"è®¡é‡å•ä½", example:"kg/g/ç®±"},
        {name:"å‚è€ƒå•ä»·", example:"45.50å…ƒ"},
        {name:"å­˜å‚¨ç±»å‹", example:"å†·è—/å†·å†»/å¸¸æ¸©"},
        {name:"ä¿è´¨æœŸå¤©æ•°", example:"180å¤©"},
        {name:"æœ€ä½åº“å­˜é¢„è­¦", example:"100.00"},
        {name:"æœ€é«˜åº“å­˜ä¸Šé™", example:"5000.00"},
        {name:"å¤‡æ³¨", example:"éœ€æä¾›åŠ¨ç‰©æ£€ç–«è¯æ˜"}
      ]},
      { id: "s3-2", title: "äº§å“ç±»å‹", fields: [
        {name:"äº§å“ç¼–ç ", example:"PT-SAUSAGE-001"},
        {name:"äº§å“åç§°", example:"åŸå‘³çŒªè‚‰é¦™è‚  500g"},
        {name:"äº§å“åˆ†ç±»", example:"é¦™è‚ ç±»/è…Šè‚‰ç±»/é€Ÿå†»ç±»"},
        {name:"äº§å“å“ç±»", example:"ç†Ÿé£Ÿ/åŠæˆå“/ç”Ÿé²œ"},
        {name:"è®¡é‡å•ä½", example:"kg/è¢‹/ç®±"},
        {name:"å‡ºå‚å•ä»·", example:"38.00å…ƒ"},
        {name:"äº§å“è§„æ ¼", example:"500g/è¢‹, 20è¢‹/ç®±"},
        {name:"åŒ…è£…è§„æ ¼", example:"çœŸç©ºåŒ…è£… 500g"},
        {name:"ä¿è´¨æœŸå¤©æ•°", example:"90å¤©"},
        {name:"æ ‡å‡†å·¥æ—¶", example:"120åˆ†é’Ÿ"},
        {name:"å·¥åºæ­¥éª¤", example:"æ¥æ”¶â†’åˆ‡å‰²â†’è°ƒå‘³â†’çŒè£…â†’åŒ…è£…"},
        {name:"äº§å“å›¾ç‰‡", example:"JPG/PNG â‰¤5MB"},
        {name:"å¤‡æ³¨", example:"å®šåˆ¶äº§å“éœ€å•ç‹¬é…æ–¹"}
      ]},
      { id: "s3-3", title: "ä¾›åº”å•†ä¿¡æ¯", fields: [
        {name:"ä¾›åº”å•†ç¼–ç ", example:"SUP-001"},
        {name:"ä¾›åº”å•†åç§°", example:"ä¸Šæµ·ä¼˜å“è‚‰ç±»æœ‰é™å…¬å¸"},
        {name:"è”ç³»äºº", example:"å¼ ç»ç†"},
        {name:"è”ç³»ç”µè¯", example:"13800138000"},
        {name:"é‚®ç®±", example:"zhang@yp-meat.com"},
        {name:"åœ°å€", example:"ä¸Šæµ·å¸‚æ¾æ±ŸåŒºæ³—æ³¾é•‡å·¥ä¸šè·¯88å·"},
        {name:"è¥ä¸šæ‰§ç…§å·", example:"91310117MA1GRXXX"},
        {name:"ç»è¥ç±»å‹", example:"è‚‰ç±»ä¾›åº”"},
        {name:"ä¾›åº”ææ–™", example:"çŒªåè…¿è‚‰, çŒªäº”èŠ±, çŒªæ’éª¨"},
        {name:"èµ„è´¨è¯ä¹¦", example:"ISO22000, HACCP"},
        {name:"ä»˜æ¬¾æ¡ä»¶", example:"æœˆç»“30å¤©"},
        {name:"ä¾›è´§å‘¨æœŸ", example:"3å¤©"},
        {name:"ä¿¡ç”¨é¢åº¦", example:"500000.00å…ƒ"},
        {name:"ä¾›åº”å•†è¯„åˆ†", example:"1-5æ˜Ÿ"}
      ]},
      { id: "s3-4", title: "å®¢æˆ·ä¿¡æ¯", fields: [
        {name:"å®¢æˆ·ç¼–ç ", example:"CUS-001"},
        {name:"å®¢æˆ·åç§°", example:"æ°¸è¾‰è¶…å¸‚(æµ¦ä¸œåº—)"},
        {name:"å®¢æˆ·ç±»å‹", example:"è¶…å¸‚/é¤é¥®/æ‰¹å‘å•†/ç”µå•†"},
        {name:"è¡Œä¸š", example:"é›¶å”®è¿é”"},
        {name:"è”ç³»äºº", example:"æé‡‡è´­"},
        {name:"è”ç³»ç”µè¯", example:"13900139000"},
        {name:"æ”¶è´§åœ°å€", example:"ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒºé™†å®¶å˜´ç¯è·¯1000å·"},
        {name:"å¼€ç¥¨åœ°å€", example:"åŒä¸Š"},
        {name:"ç¨å·", example:"91310115..."},
        {name:"ä»˜æ¬¾æ¡ä»¶", example:"è´§åˆ°ä»˜æ¬¾ / æœˆç»“60å¤©"},
        {name:"ä¿¡ç”¨é¢åº¦", example:"200000.00å…ƒ"},
        {name:"å®¢æˆ·è¯„åˆ†", example:"1-5æ˜Ÿ"}
      ]},
      { id: "s3-5", title: "è®¾å¤‡ä¿¡æ¯", fields: [
        {name:"è®¾å¤‡ç¼–ç ", example:"EQ-CUT-001"},
        {name:"è®¾å¤‡åç§°", example:"å…¨è‡ªåŠ¨åˆ‡å‰²æœºAçº¿"},
        {name:"è®¾å¤‡ç±»å‹", example:"åˆ‡å‰²/çŒè£…/åŒ…è£…/å†·è—"},
        {name:"å‹å·", example:"KR-500A"},
        {name:"åˆ¶é€ å•†", example:"ç§‘ç‘é£Ÿå“æœºæ¢°"},
        {name:"åºåˆ—å·", example:"SN20240315001"},
        {name:"è´­å…¥æ—¥æœŸ", example:"2024-03-15"},
        {name:"è´­å…¥ä»·æ ¼", example:"85000.00å…ƒ"},
        {name:"æŠ˜æ—§å¹´é™", example:"10å¹´"},
        {name:"æ¯å°æ—¶æˆæœ¬", example:"15.50å…ƒ/å°æ—¶"},
        {name:"åŠŸç‡", example:"5.50 kW"},
        {name:"å®‰è£…ä½ç½®", example:"Aè½¦é—´-2å·çº¿"},
        {name:"ä¿å…»å‘¨æœŸ", example:"500å°æ—¶"},
        {name:"ä¿ä¿®åˆ°æœŸ", example:"2027-03-15"}
      ]},
      { id: "s3-6", title: "äº§å“é…æ–¹ï¼ˆBOMï¼‰", fields: [
        {name:"äº§å“ç±»å‹", example:"åŸå‘³çŒªè‚‰é¦™è‚  500g"},
        {name:"åŸææ–™ç±»å‹", example:"çŒªåè…¿è‚‰"},
        {name:"æ ‡å‡†ç”¨é‡", example:"0.400 kg"},
        {name:"å¾—ç‡", example:"90.00%"},
        {name:"å‚è€ƒå•ä»·", example:"45.50å…ƒ"},
        {name:"ç¨ç‡", example:"13.00%"}
      ]}
    ]
  },
  {
    id: "m2",
    name: "ç”Ÿäº§ç®¡ç†",
    icon: "ğŸ­",
    desc: "ç”Ÿäº§è®¡åˆ’ã€æ‰¹æ¬¡æ‰§è¡Œã€å·¥åºè®°å½•ã€æ¶ˆè€—ä¸è´¨æ£€",
    sections: [
      { id: "s4-2", title: "ç”Ÿäº§è®¡åˆ’", fields: [
        {name:"è®¡åˆ’ç¼–å·", example:"PP-F001-20260129-0001"},
        {name:"äº§å“ç±»å‹", example:"åŸå‘³çŒªè‚‰é¦™è‚  500g"},
        {name:"è®¡åˆ’æ•°é‡", example:"1000.00 kg"},
        {name:"è®¡é‡å•ä½", example:"kg/è¢‹/ç®±"},
        {name:"è®¡åˆ’å¼€å§‹æ—¶é—´", example:"2026-01-30 08:00"},
        {name:"è®¡åˆ’ç»“æŸæ—¶é—´", example:"2026-01-30 18:00"},
        {name:"ä¼˜å…ˆçº§", example:"æœ€é«˜/é«˜/ä¸­/ä½/æœ€ä½"},
        {name:"è®¡åˆ’çŠ¶æ€", example:"å¾…å®¡æ‰¹/å·²æ‰¹å‡†/ç”Ÿäº§ä¸­"},
        {name:"è®¡åˆ’ç±»å‹", example:"å¸¸è§„/ç´§æ€¥/è¯•äº§"},
        {name:"æ¥æºç±»å‹", example:"äººå·¥åˆ›å»º/å®¢æˆ·è®¢å•/AIé¢„æµ‹"},
        {name:"å®¢æˆ·è®¢å•å·", example:"ORD-YH-20260128-055"},
        {name:"å®¢æˆ·åç§°", example:"æ°¸è¾‰è¶…å¸‚"},
        {name:"é¢„ä¼°ææ–™æˆæœ¬", example:"22760.00å…ƒ"},
        {name:"é¢„ä¼°äººå·¥æˆæœ¬", example:"3500.00å…ƒ"},
        {name:"å¤‡æ³¨", example:"å®¢æˆ·è¦æ±‚1æœˆ31æ—¥å‰äº¤è´§"}
      ]},
      { id: "s4-3", title: "ç”Ÿäº§æ‰¹æ¬¡ï¼ˆæ‰§è¡Œï¼‰", fields: [
        {name:"æ‰¹æ¬¡å·", example:"PB-F001-20260130-0001"},
        {name:"å…³è”è®¡åˆ’", example:"PP-F001-20260129-0001"},
        {name:"äº§å“ç±»å‹", example:"åŸå‘³çŒªè‚‰é¦™è‚  500g"},
        {name:"è®¡åˆ’äº§é‡", example:"500.00 kg"},
        {name:"æŠ•å…¥é‡", example:"600.00 kg"},
        {name:"è®¡é‡å•ä½", example:"kg/è¢‹/ç®±"},
        {name:"å®é™…äº§é‡", example:"480.00 kg"},
        {name:"è‰¯å“æ•°é‡", example:"465.00 kg"},
        {name:"ä¸è‰¯å“æ•°é‡", example:"15.00 kg"},
        {name:"å¾—ç‡", example:"80.00%"},
        {name:"ç”Ÿäº§æ•ˆç‡", example:"96.00%"},
        {name:"æ‰¹æ¬¡çŠ¶æ€", example:"å·²è®¡åˆ’/ç”Ÿäº§ä¸­/å·²å®Œæˆ"},
        {name:"è´¨é‡çŠ¶æ€", example:"å¾…æ£€/åˆæ ¼/ä¸åˆæ ¼"},
        {name:"å¼€å§‹æ—¶é—´", example:"2026-01-30 08:15:00"},
        {name:"ç»“æŸæ—¶é—´", example:"2026-01-30 16:45:00"},
        {name:"ä½¿ç”¨è®¾å¤‡", example:"å…¨è‡ªåŠ¨åˆ‡å‰²æœºAçº¿"},
        {name:"ç”Ÿäº§è´Ÿè´£äºº", example:"ç‹ç­é•¿"},
        {name:"å·¥äººæ•°é‡", example:"8äºº"},
        {name:"ææ–™æˆæœ¬", example:"22760.00å…ƒ"},
        {name:"äººå·¥æˆæœ¬", example:"3200.00å…ƒ"},
        {name:"è®¾å¤‡æˆæœ¬", example:"131.75å…ƒ"},
        {name:"æ€»æˆæœ¬", example:"26091.75å…ƒ"},
        {name:"å•ä½æˆæœ¬", example:"54.36å…ƒ"},
        {name:"å¤‡æ³¨", example:"å®¢æˆ·å®šåˆ¶é…æ–¹ï¼Œè¾£åº¦å‡åŠ"}
      ]},
      { id: "s4-4", title: "å·¥åºè¿‡ç¨‹è®°å½•", fields: [
        {name:"å…³è”æ‰¹æ¬¡", example:"PB-F001-20260130-0001"},
        {name:"å·¥åºç±»å‹", example:"åŸæ–™æ¥æ”¶/åˆ‡å‰²/æ…æ‹Œ/çŒè£…/åŒ…è£…"},
        {name:"å¼€å§‹æ—¶é—´", example:"2026-01-30 08:15:00"},
        {name:"ç»“æŸæ—¶é—´", example:"2026-01-30 09:15:00"},
        {name:"å·¥åºæ—¶é•¿", example:"60åˆ†é’Ÿ"},
        {name:"æŠ•å…¥é‡é‡", example:"600.000 kg"},
        {name:"äº§å‡ºé‡é‡", example:"540.000 kg"},
        {name:"æŸè€—é‡é‡", example:"60.000 kg"},
        {name:"æŸè€—ç‡", example:"10.00%"},
        {name:"åˆæ ¼æ•°é‡", example:"530.00 kg"},
        {name:"ä¸åˆæ ¼æ•°é‡", example:"10.00 kg"},
        {name:"è¿”å·¥æ•°é‡", example:"5.00 kg"},
        {name:"ç¯å¢ƒæ¸©åº¦", example:"4.5â„ƒ"},
        {name:"äº§å“æ¸©åº¦", example:"-1.2â„ƒ"},
        {name:"ç›®æ ‡æ¸©åº¦", example:"0~4â„ƒ"},
        {name:"ä½¿ç”¨è®¾å¤‡", example:"åˆ‡å‰²æœºA"},
        {name:"è®¾å¤‡è¿è¡Œæ—¶é•¿", example:"55åˆ†é’Ÿ"},
        {name:"è®¾å¤‡åœæœºæ—¶é•¿", example:"5åˆ†é’Ÿ"},
        {name:"è®¾å¤‡OEE", example:"91.67%"},
        {name:"ç”¨æ°´é‡", example:"200.00 L"},
        {name:"ç”¨ç”µé‡", example:"5.50 kWh"},
        {name:"æ“ä½œå‘˜", example:"å¼ ä¸‰"},
        {name:"å·¥äººæ•°é‡", example:"3äºº"},
        {name:"pHå€¼", example:"5.80"},
        {name:"ç›åº¦", example:"2.50%"},
        {name:"ATPæ£€æµ‹å€¼", example:"150.00 RLU"},
        {name:"å¤‡æ³¨", example:"åŸæ–™è§£å†»åé¢œè‰²æ­£å¸¸"}
      ]},
      { id: "s4-5", title: "åŸææ–™æ¶ˆè€—è®°å½•", fields: [
        {name:"å…³è”ç”Ÿäº§æ‰¹æ¬¡", example:"PB-F001-20260130-0001"},
        {name:"åŸææ–™æ‰¹æ¬¡", example:"MB-F001-20260129-0001 (çŒªåè…¿è‚‰)"},
        {name:"æ¶ˆè€—æ•°é‡", example:"200.00 kg"},
        {name:"å•ä»·", example:"45.50å…ƒ"},
        {name:"æ¶ˆè€—é‡‘é¢", example:"9100.00å…ƒ"},
        {name:"æ¶ˆè€—æ—¶é—´", example:"2026-01-30 08:30:00"},
        {name:"è®°å½•äºº", example:"å¼ ä¸‰"},
        {name:"å¤‡æ³¨", example:"ç¬¬ä¸€æ‰¹æ¬¡æŠ•æ–™"}
      ]},
      { id: "s4-6", title: "è´¨é‡æ£€éªŒè®°å½•", fields: [
        {name:"å…³è”ç”Ÿäº§æ‰¹æ¬¡", example:"PB-F001-20260130-0001"},
        {name:"è´¨æ£€å‘˜", example:"è´¨æ£€å‘˜æå››"},
        {name:"æ£€éªŒæ—¥æœŸ", example:"2026-01-30"},
        {name:"æŠ½æ ·æ•°é‡", example:"50è¢‹"},
        {name:"åˆæ ¼æ•°é‡", example:"48è¢‹"},
        {name:"ä¸åˆæ ¼æ•°é‡", example:"2è¢‹"},
        {name:"åˆæ ¼ç‡", example:"96.00%"},
        {name:"æ£€éªŒç»“è®º", example:"åˆæ ¼/ä¸åˆæ ¼/æœ‰æ¡ä»¶æ”¾è¡Œ"},
        {name:"æ£€éªŒè¯¦æƒ…", example:"æ„Ÿå®˜æ£€éªŒæ­£å¸¸ï¼Œå¾®ç”Ÿç‰©åˆæ ¼"}
      ]}
    ]
  },
  {
    id: "m3",
    name: "äººæ•ˆç®¡ç†",
    icon: "ğŸ‘·",
    desc: "å‘˜å·¥è€ƒå‹¤ã€å·¥æ—¶ç»Ÿè®¡ã€äººå·¥æˆæœ¬æ ¸ç®—",
    sections: [
      { id: "s5-1", title: "è€ƒå‹¤æ‰“å¡è®°å½•", fields: [
        {name:"å‘˜å·¥", example:"å¼ ä¸‰(å·¥å·:EMP035)"},
        {name:"æ‰“å¡æ—¥æœŸ", example:"2026-01-30"},
        {name:"ä¸Šç­æ‰“å¡æ—¶é—´", example:"2026-01-30 07:58:00"},
        {name:"ä¸‹ç­æ‰“å¡æ—¶é—´", example:"2026-01-30 17:05:00"},
        {name:"ä¼‘æ¯å¼€å§‹æ—¶é—´", example:"2026-01-30 12:00:00"},
        {name:"ä¼‘æ¯ç»“æŸæ—¶é—´", example:"2026-01-30 13:00:00"},
        {name:"å·¥ä½œæ—¶é•¿", example:"487åˆ†é’Ÿ"},
        {name:"ä¼‘æ¯æ—¶é•¿", example:"60åˆ†é’Ÿ"},
        {name:"è€ƒå‹¤çŠ¶æ€", example:"æ­£å¸¸/è¿Ÿåˆ°/æ—©é€€/ç¼ºå‹¤"},
        {name:"æ‰“å¡ä½ç½®", example:"Aè½¦é—´å…¥å£"},
        {name:"æ‰“å¡è®¾å¤‡", example:"iPad-Aè½¦é—´ / æ‰‹æœºApp"}
      ]},
      { id: "s5-2", title: "ç”Ÿäº§æ‰¹æ¬¡å·¥æ—¶è®°å½•", fields: [
        {name:"ç”Ÿäº§æ‰¹æ¬¡", example:"PB-F001-20260130-0001"},
        {name:"å‘˜å·¥", example:"å¼ ä¸‰(å·¥å·:EMP035)"},
        {name:"ç­¾å…¥æ—¶é—´", example:"2026-01-30 08:15:00"},
        {name:"ç­¾å‡ºæ—¶é—´", example:"2026-01-30 16:45:00"},
        {name:"å·¥ä½œæ—¶é•¿", example:"510åˆ†é’Ÿ"},
        {name:"äººå·¥æˆæœ¬", example:"425.00å…ƒ"},
        {name:"åˆ†é…äºº", example:"ç‹ç­é•¿"},
        {name:"çŠ¶æ€", example:"å·²åˆ†é…/å·¥ä½œä¸­/å·²å®Œæˆ"},
        {name:"å¤‡æ³¨", example:"è´Ÿè´£åˆ‡å‰²å’ŒçŒè£…å·¥åº"}
      ]}
    ]
  },
  {
    id: "m4",
    name: "ä»“å‚¨ç‰©æµ",
    icon: "ğŸšš",
    desc: "åŸææ–™å…¥åº“ã€æˆå“å‡ºè´§ã€æº¯æºæ ‡ç­¾",
    sections: [
      { id: "s4-1", title: "åŸææ–™å…¥åº“", fields: [
        {name:"æ‰¹æ¬¡å·", example:"MB-F001-20260129-0001"},
        {name:"åŸææ–™ç±»å‹", example:"çŒªåè…¿è‚‰"},
        {name:"ä¾›åº”å•†", example:"ä¸Šæµ·ä¼˜å“è‚‰ç±»æœ‰é™å…¬å¸"},
        {name:"å…¥åº“æ•°é‡", example:"500.00 kg"},
        {name:"è®¡é‡å•ä½", example:"kg/g/ç®±"},
        {name:"å•ä»¶é‡é‡", example:"25.000 kg"},
        {name:"è¿›è´§å•ä»·", example:"45.50å…ƒ"},
        {name:"å…¥åº“æ—¥æœŸ", example:"2026-01-29"},
        {name:"ç”Ÿäº§æ—¥æœŸ", example:"2026-01-28"},
        {name:"åˆ°æœŸæ—¥æœŸ", example:"2026-07-28"},
        {name:"å­˜å‚¨ä½ç½®", example:"AåŒº-å†·åº“2-è´§æ¶3-å±‚2"},
        {name:"è´¨æ£€è¯ä¹¦", example:"åŠ¨æ£€è¯å·: 310117-20260128-001"},
        {name:"å…¥åº“çŠ¶æ€", example:"å¯ç”¨/å·²ç”¨å®Œ/å·²è¿‡æœŸ"},
        {name:"å¤‡æ³¨", example:"å†·é“¾è¿è¾“ï¼Œåˆ°è´§æ¸©åº¦-2â„ƒ"}
      ]},
      { id: "s4-7", title: "å‡ºè´§å‘è¿è®°å½•", fields: [
        {name:"å‡ºè´§å•å·", example:"SH-F001-20260131-0001"},
        {name:"å®¢æˆ·", example:"æ°¸è¾‰è¶…å¸‚(æµ¦ä¸œåº—)"},
        {name:"è®¢å•å·", example:"ORD-YH-20260128-055"},
        {name:"äº§å“åç§°", example:"åŸå‘³çŒªè‚‰é¦™è‚  500g"},
        {name:"å‡ºè´§æ•°é‡", example:"960è¢‹"},
        {name:"è®¡é‡å•ä½", example:"è¢‹/ç®±/kg"},
        {name:"å•ä»·", example:"38.00å…ƒ"},
        {name:"æ€»é‡‘é¢", example:"36480.00å…ƒ"},
        {name:"å‘è´§æ—¥æœŸ", example:"2026-01-31"},
        {name:"æ”¶è´§åœ°å€", example:"ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒºé™†å®¶å˜´ç¯è·¯1000å·"},
        {name:"ç‰©æµå…¬å¸", example:"é¡ºä¸°å†·è¿"},
        {name:"è¿å•å·", example:"SF1234567890"},
        {name:"å‡ºè´§çŠ¶æ€", example:"å¾…å‘è´§/å·²å‘è´§/å·²ç­¾æ”¶"},
        {name:"å¤‡æ³¨", example:"å†·é“¾è¿è¾“ï¼Œè¦æ±‚åˆ°è¾¾æ¸©åº¦â‰¤4â„ƒ"}
      ]},
      { id: "s4-8", title: "æº¯æºæ ‡ç­¾", fields: [
        {name:"æ ‡ç­¾ç¼–ç ", example:"LBL-F001-PB101-0001"},
        {name:"æ ‡ç­¾ç±»å‹", example:"äºŒç»´ç /æ¡å½¢ç /RFID/NFC"},
        {name:"å…³è”ç±»å‹", example:"ç”Ÿäº§æ‰¹æ¬¡/åŸææ–™æ‰¹æ¬¡/å‡ºè´§æ‰¹æ¬¡"},
        {name:"å…³è”æ‰¹æ¬¡", example:"PB-F001-20260130-0001"},
        {name:"æº¯æºç ", example:"CT20260130F001PB101"},
        {name:"äºŒç»´ç å†…å®¹", example:"https://trace.cretas.com/t/CT2026..."},
        {name:"äº§å“åç§°", example:"åŸå‘³çŒªè‚‰é¦™è‚  500g"},
        {name:"äº§å“è§„æ ¼", example:"500g/è¢‹"},
        {name:"ç”Ÿäº§æ—¥æœŸ", example:"2026-01-30"},
        {name:"ä¿è´¨æœŸ", example:"90å¤©"},
        {name:"åˆ°æœŸæ—¥æœŸ", example:"2026-04-30"},
        {name:"æ ‡ç­¾çŠ¶æ€", example:"å·²ç”Ÿæˆ/å·²æ‰“å°/å·²è´´æ ‡"},
        {name:"æ‰“å°æ¬¡æ•°", example:"1æ¬¡"},
        {name:"è´´æ ‡æ—¶é—´", example:"2026-01-30 17:15:00"}
      ]}
    ]
  },
  {
    id: "m5",
    name: "å…¶ä»–",
    icon: "ğŸ“Š",
    desc: "åºŸå¼ƒå¤„ç½®ã€ç¯å¢ƒç›‘æ§ç­‰",
    sections: [
      { id: "s6-1", title: "åºŸå¼ƒå¤„ç½®è®°å½•", fields: [
        {name:"å¤„ç½®ç±»å‹", example:"æŠ¥åºŸ/å›æ”¶/é€€è´§/æèµ /é”€æ¯"},
        {name:"æ•°é‡", example:"15.00 kg"},
        {name:"åŸå› ", example:"è´¨æ£€ä¸åˆæ ¼/è¿‡æœŸ/æŸå"},
        {name:"æ—¥æœŸ", example:"2026-01-30"},
        {name:"å¤„ç½®æ–¹å¼", example:"ç„šçƒ§/å¡«åŸ‹/å›æ”¶åˆ©ç”¨"},
        {name:"é¢„ä¼°æŸå¤±", example:"500.00å…ƒ"},
        {name:"å®é™…æŸå¤±", example:"480.00å…ƒ"},
        {name:"å›æ”¶ä»·å€¼", example:"50.00å…ƒ"},
        {name:"å®¡æ‰¹äºº", example:"æç»ç†"},
        {name:"å®¡æ‰¹æ—¥æœŸ", example:"2026-01-30"}
      ]},
      { id: "s7-1", title: "ç¯å¢ƒç›‘æ§æ•°æ®", fields: [
        {name:"ç›‘æ§è®¾å¤‡", example:"æ¸©åº¦ä¼ æ„Ÿå™¨-å†·åº“A"},
        {name:"æ•°æ®ç±»å‹", example:"æ¸©åº¦/æ¹¿åº¦/å‹åŠ›"},
        {name:"ç›‘æ§å€¼", example:"-18.5â„ƒ"},
        {name:"ä½ç½®", example:"å†·åº“A-ä¸­å¿ƒ"},
        {name:"é‡‡é›†æ—¶é—´", example:"2026-01-30 10:00:00"},
        {name:"æ•°æ®æ¥æº", example:"IoTè‡ªåŠ¨é‡‡é›†/äººå·¥å½•å…¥"}
      ]}
    ]
  }
];

let companyId = null;
let companyName = null;
let feedbackData = {};
let saveQueue = [];
let saveTimer = null;

// è®¡ç®—æ€»å­—æ®µæ•°
const TOTAL_FIELDS = MODULES.reduce((sum, m) =>
  sum + m.sections.reduce((s, sec) => s + sec.fields.length, 0), 0);

// ========== åˆå§‹åŒ– ==========
document.addEventListener('DOMContentLoaded', () => {
  const savedCompanyId = localStorage.getItem('cr_companyId');
  const savedCompanyName = localStorage.getItem('cr_companyName');

  if (savedCompanyId && savedCompanyName) {
    companyId = savedCompanyId;
    companyName = savedCompanyName;
    loadExistingData();
  }

  document.getElementById('loginForm').addEventListener('submit', handleLogin);
});

async function handleLogin(e) {
  e.preventDefault();
  const btn = document.getElementById('loginBtn');
  const errorEl = document.getElementById('loginError');
  const name = document.getElementById('companyName').value.trim();
  const contact = document.getElementById('contactName').value.trim();
  const phone = document.getElementById('contactPhone').value.trim();

  if (!name) {
    errorEl.textContent = 'è¯·è¾“å…¥å…¬å¸åç§°';
    return;
  }

  btn.disabled = true;
  btn.textContent = 'ç™»å½•ä¸­...';
  errorEl.textContent = '';

  try {
    const res = await fetch(API_BASE + '/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ companyName: name, contactName: contact, contactPhone: phone })
    });
    const data = await res.json();

    if (data.success) {
      companyId = data.data.companyId;
      companyName = data.data.companyName;
      localStorage.setItem('cr_companyId', companyId);
      localStorage.setItem('cr_companyName', companyName);

      if (data.data.feedbacks && data.data.feedbacks.length > 0) {
        data.data.feedbacks.forEach(f => {
          const key = f.section + '_' + f.rowIndex;
          feedbackData[key] = {
            checked: f.applicability !== 'ä¸é€‚ç”¨',
            note: f.note || ''
          };
        });
      }

      showMainContent();
    } else {
      errorEl.textContent = data.message || 'ç™»å½•å¤±è´¥';
    }
  } catch (err) {
    errorEl.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•';
  } finally {
    btn.disabled = false;
    btn.textContent = 'å¼€å§‹å¡«å†™';
  }
}

async function loadExistingData() {
  try {
    const res = await fetch(API_BASE + '/' + companyId);
    const data = await res.json();

    if (data.success && data.data.feedbacks) {
      data.data.feedbacks.forEach(f => {
        const key = f.section + '_' + f.rowIndex;
        feedbackData[key] = {
          checked: f.applicability !== 'ä¸é€‚ç”¨',
          note: f.note || ''
        };
      });
    }
    showMainContent();
  } catch (err) {
    localStorage.removeItem('cr_companyId');
    localStorage.removeItem('cr_companyName');
  }
}

function showMainContent() {
  document.getElementById('loginOverlay').classList.add('hidden');
  document.getElementById('displayCompanyName').textContent = companyName;
  renderModules();
  updateProgress();
}

// ========== æ¸²æŸ“ ==========
function renderModules() {
  const container = document.getElementById('modulesContainer');
  container.innerHTML = '';

  MODULES.forEach(module => {
    const moduleEl = document.createElement('div');
    moduleEl.className = 'module';
    moduleEl.dataset.id = module.id;

    // è®¡ç®—æ¨¡å—ç»Ÿè®¡
    let totalFields = 0;
    let checkedFields = 0;
    module.sections.forEach(section => {
      section.fields.forEach((_, i) => {
        totalFields++;
        const key = section.id + '_' + i;
        const data = feedbackData[key];
        if (!data || data.checked) checkedFields++;
      });
    });

    moduleEl.innerHTML = `
      <div class="module-header" onclick="toggleModule('${module.id}')">
        <div>
          <div class="module-title">
            <span class="icon">${module.icon}</span>
            <span>${module.name}</span>
            <span class="toggle-icon">â–¼</span>
          </div>
          <div class="module-desc">${module.desc}</div>
        </div>
        <div class="module-stats">${checkedFields}/${totalFields} å¯æä¾›</div>
      </div>
      <div class="module-content">
        ${module.sections.map(section => renderSection(section)).join('')}
      </div>
    `;

    container.appendChild(moduleEl);
  });
}

function renderSection(section) {
  const uncheckedCount = section.fields.filter((_, i) => {
    const key = section.id + '_' + i;
    return feedbackData[key] && !feedbackData[key].checked;
  }).length;
  const allChecked = uncheckedCount === 0;

  return `
    <div class="section" data-id="${section.id}">
      <div class="section-header">
        <span class="section-title" onclick="toggleSection('${section.id}')">
          <span class="toggle-icon">â–¼</span>
          ${section.title}
        </span>
        <div class="section-action">
          <button class="btn-toggle-all ${allChecked ? '' : 'has-unchecked'}" onclick="event.stopPropagation(); toggleAllInSection('${section.id}')">
            ${allChecked ? 'â˜‘ å…¨éƒ¨å¯æä¾›' : uncheckedCount + ' é¡¹æ— æ³•æä¾›'}
          </button>
        </div>
      </div>
      <div class="section-content">
        ${section.fields.map((field, i) => renderField(section.id, i, field)).join('')}
      </div>
    </div>
  `;
}

function renderField(sectionId, index, field) {
  const key = sectionId + '_' + index;
  const data = feedbackData[key] || { checked: true, note: '' };
  const checkedClass = data.checked ? 'checked' : '';
  const rowClass = data.checked ? '' : 'unchecked';

  return `
    <div class="field-row ${rowClass}" data-key="${key}">
      <div class="field-checkbox ${checkedClass}" onclick="toggleField('${key}')" title="ç‚¹å‡»åˆ‡æ¢"></div>
      <div class="field-info">
        <div class="field-name">${field.name}</div>
        <div class="field-example">ç¤ºä¾‹ï¼š<span>${field.example}</span></div>
        <div class="note-input">
          <input type="text" placeholder="å¤‡æ³¨ï¼ˆå¦‚ï¼šæ•°æ®æ¥æºã€æ ¼å¼è¯´æ˜ç­‰ï¼‰" value="${escapeHtml(data.note)}" onchange="updateNote('${key}', this.value)">
        </div>
      </div>
    </div>
  `;
}

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// ========== äº¤äº’ ==========
function toggleModule(moduleId) {
  const module = document.querySelector(`.module[data-id="${moduleId}"]`);
  module.classList.toggle('collapsed');
}

function toggleSection(sectionId) {
  const section = document.querySelector(`.section[data-id="${sectionId}"]`);
  section.classList.toggle('collapsed');
}

function toggleAllInSection(sectionId) {
  let section = null;
  for (const m of MODULES) {
    section = m.sections.find(s => s.id === sectionId);
    if (section) break;
  }
  if (!section) return;

  let hasUnchecked = false;
  section.fields.forEach((_, i) => {
    const key = sectionId + '_' + i;
    if (feedbackData[key] && !feedbackData[key].checked) {
      hasUnchecked = true;
    }
  });

  const newCheckedState = hasUnchecked;

  section.fields.forEach((_, i) => {
    const key = sectionId + '_' + i;
    if (!feedbackData[key]) {
      feedbackData[key] = { checked: true, note: '' };
    }
    feedbackData[key].checked = newCheckedState;
    queueSave(key);

    const row = document.querySelector(`.field-row[data-key="${key}"]`);
    const checkbox = row.querySelector('.field-checkbox');
    if (newCheckedState) {
      row.classList.remove('unchecked');
      checkbox.classList.add('checked');
    } else {
      row.classList.add('unchecked');
      checkbox.classList.remove('checked');
    }
  });

  updateSectionButton(sectionId);
  updateModuleStats();
  updateProgress();
}

function toggleField(key) {
  if (!feedbackData[key]) {
    feedbackData[key] = { checked: true, note: '' };
  }
  feedbackData[key].checked = !feedbackData[key].checked;

  const row = document.querySelector(`.field-row[data-key="${key}"]`);
  const checkbox = row.querySelector('.field-checkbox');

  if (feedbackData[key].checked) {
    row.classList.remove('unchecked');
    checkbox.classList.add('checked');
  } else {
    row.classList.add('unchecked');
    checkbox.classList.remove('checked');
  }

  queueSave(key);
  updateProgress();
  updateSectionButton(key.split('_')[0]);
  updateModuleStats();
}

function updateNote(key, value) {
  if (!feedbackData[key]) {
    feedbackData[key] = { checked: true, note: '' };
  }
  feedbackData[key].note = value;
  queueSave(key);
}

function updateSectionButton(sectionId) {
  let section = null;
  for (const m of MODULES) {
    section = m.sections.find(s => s.id === sectionId);
    if (section) break;
  }
  if (!section) return;

  const uncheckedCount = section.fields.filter((_, i) => {
    const key = sectionId + '_' + i;
    return feedbackData[key] && !feedbackData[key].checked;
  }).length;

  const sectionEl = document.querySelector(`.section[data-id="${sectionId}"]`);
  const btn = sectionEl.querySelector('.btn-toggle-all');
  const allChecked = uncheckedCount === 0;

  btn.className = 'btn-toggle-all ' + (allChecked ? '' : 'has-unchecked');
  btn.textContent = allChecked ? 'â˜‘ å…¨éƒ¨å¯æä¾›' : uncheckedCount + ' é¡¹æ— æ³•æä¾›';
}

function updateModuleStats() {
  MODULES.forEach(module => {
    let totalFields = 0;
    let checkedFields = 0;
    module.sections.forEach(section => {
      section.fields.forEach((_, i) => {
        totalFields++;
        const key = section.id + '_' + i;
        const data = feedbackData[key];
        if (!data || data.checked) checkedFields++;
      });
    });

    const moduleEl = document.querySelector(`.module[data-id="${module.id}"]`);
    const statsEl = moduleEl.querySelector('.module-stats');
    statsEl.textContent = `${checkedFields}/${totalFields} å¯æä¾›`;
  });
}

function updateProgress() {
  let checkedCount = 0;
  MODULES.forEach(module => {
    module.sections.forEach(section => {
      section.fields.forEach((_, i) => {
        const key = section.id + '_' + i;
        const data = feedbackData[key];
        if (!data || data.checked) {
          checkedCount++;
        }
      });
    });
  });

  const pct = Math.round(checkedCount / TOTAL_FIELDS * 100);
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressText').textContent = `${checkedCount} / ${TOTAL_FIELDS} å¯æä¾›`;
}

// ========== ä¿å­˜ ==========
function queueSave(key) {
  if (!saveQueue.includes(key)) {
    saveQueue.push(key);
  }

  if (saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(doSave, 800);
}

async function doSave() {
  if (saveQueue.length === 0) return;

  const keysToSave = [...saveQueue];
  saveQueue = [];

  const items = keysToSave.map(key => {
    const [sectionId, indexStr] = key.split('_');
    const index = parseInt(indexStr);

    let fieldName = '';
    for (const m of MODULES) {
      const section = m.sections.find(s => s.id === sectionId);
      if (section) {
        fieldName = section.fields[index].name;
        break;
      }
    }

    const data = feedbackData[key] || { checked: true, note: '' };

    return {
      section: sectionId,
      rowIndex: index,
      fieldName: fieldName,
      applicability: data.checked ? 'é€‚ç”¨' : 'ä¸é€‚ç”¨',
      priority: data.checked ? 'å¯æä¾›' : 'æš‚æ— æ³•æä¾›',
      note: data.note || ''
    };
  });

  showToast('ä¿å­˜ä¸­...', '');

  try {
    const res = await fetch(API_BASE + '/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ companyId, items })
    });
    const data = await res.json();

    if (data.success) {
      showToast('å·²ä¿å­˜', 'success');
    } else {
      showToast('ä¿å­˜å¤±è´¥', 'error');
      keysToSave.forEach(k => { if (!saveQueue.includes(k)) saveQueue.push(k); });
    }
  } catch (err) {
    showToast('ç½‘ç»œé”™è¯¯', 'error');
    keysToSave.forEach(k => { if (!saveQueue.includes(k)) saveQueue.push(k); });
  }
}

function showToast(msg, type) {
  const toast = document.getElementById('saveToast');
  toast.textContent = msg;
  toast.className = 'save-toast show ' + type;

  setTimeout(() => {
    toast.classList.remove('show');
  }, 2000);
}
</script>
</body>
</html>
