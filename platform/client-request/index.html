<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI å·¥å‚å…¥é©»å‘å¯¼ - ç™½å©çºªé£Ÿå“æº¯æºç³»ç»Ÿ</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --primary: #1a5276;
  --primary-light: #2980b9;
  --success: #27ae60;
  --danger: #e74c3c;
  --warning: #f39c12;
  --gray: #95a5a6;
  --light: #f8f9fa;
  --border: #e0e0e0;
  --text: #333;
  --radius: 8px;
  --chat-ai: #f0f4ff;
  --chat-user: #e8f5e9;
}

body {
  font-family: "Microsoft YaHei", "PingFang SC", -apple-system, sans-serif;
  background: #f0f2f5;
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
}

/* ===== Layout ===== */
.wizard-container {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
}

/* ===== Step Indicator ===== */
.step-indicator {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin: 20px 0 30px;
}
.step-dot {
  width: 36px; height: 36px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 600;
  background: var(--border);
  color: #999;
  transition: all 0.3s;
}
.step-dot.active { background: var(--primary); color: #fff; }
.step-dot.completed { background: var(--success); color: #fff; }
.step-line {
  width: 40px; height: 2px;
  background: var(--border);
  align-self: center;
  transition: background 0.3s;
}
.step-line.completed { background: var(--success); }

/* ===== Cards ===== */
.card {
  background: #fff;
  border-radius: 12px;
  padding: 30px;
  margin-bottom: 20px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.06);
}
.card h2 { font-size: 20px; color: var(--primary); margin-bottom: 16px; }
.card h3 { font-size: 16px; margin-bottom: 12px; }

/* ===== Forms ===== */
.form-group { margin-bottom: 18px; }
.form-group label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; color: #444; }
.form-group label .req { color: var(--danger); }
.form-group input, .form-group textarea, .form-group select {
  width: 100%; padding: 10px 14px;
  border: 1px solid var(--border); border-radius: 6px;
  font-size: 14px; transition: border-color 0.2s;
}
.form-group input:focus, .form-group textarea:focus, .form-group select:focus {
  outline: none; border-color: var(--primary);
}
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

/* ===== Buttons ===== */
.btn {
  padding: 10px 24px; border: none; border-radius: 6px;
  font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;
}
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-light); }
.btn-primary:disabled { background: #bdc3c7; cursor: not-allowed; }
.btn-outline { background: #fff; color: var(--primary); border: 1px solid var(--primary); }
.btn-outline:hover { background: #f0f4ff; }
.btn-success { background: var(--success); color: #fff; }
.btn-success:hover { background: #219a52; }
.btn-row { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }

/* ===== Module Cards (Step 2) ===== */
.module-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px; }
.module-card {
  border: 2px solid var(--border); border-radius: 10px; padding: 18px;
  cursor: pointer; transition: all 0.2s; position: relative;
}
.module-card:hover { border-color: var(--primary-light); }
.module-card.selected { border-color: var(--primary); background: #f0f4ff; }
.module-card .icon { font-size: 28px; margin-bottom: 8px; }
.module-card .name { font-size: 15px; font-weight: 600; }
.module-card .desc { font-size: 12px; color: #666; margin-top: 4px; }
.module-card .field-count { font-size: 11px; color: var(--gray); margin-top: 6px; }
.module-card .check {
  position: absolute; top: 10px; right: 10px;
  width: 22px; height: 22px; border-radius: 50%;
  background: var(--success); color: #fff;
  display: none; align-items: center; justify-content: center;
  font-size: 13px;
}
.module-card.selected .check { display: flex; }

/* ===== Chat UI (Step 3) ===== */
.chat-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 16px; background: var(--primary); color: #fff;
  border-radius: 12px 12px 0 0;
}
.chat-header .module-label { font-size: 14px; opacity: 0.9; }
.chat-body {
  height: 400px; overflow-y: auto; padding: 16px;
  background: #fafbfc; border-left: 1px solid var(--border); border-right: 1px solid var(--border);
}
.chat-msg { margin-bottom: 16px; display: flex; gap: 10px; }
.chat-msg.ai { flex-direction: row; }
.chat-msg.user { flex-direction: row-reverse; }
.chat-avatar {
  width: 32px; height: 32px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; flex-shrink: 0;
}
.chat-msg.ai .chat-avatar { background: var(--chat-ai); }
.chat-msg.user .chat-avatar { background: var(--chat-user); }
.chat-bubble {
  max-width: 75%; padding: 10px 14px;
  border-radius: 12px; font-size: 14px; line-height: 1.6;
}
.chat-msg.ai .chat-bubble { background: var(--chat-ai); border-top-left-radius: 4px; }
.chat-msg.user .chat-bubble { background: var(--chat-user); border-top-right-radius: 4px; }

.quick-replies { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0 8px 42px; }
.quick-reply-btn {
  padding: 6px 14px; border: 1px solid var(--primary); border-radius: 20px;
  background: #fff; color: var(--primary); font-size: 13px;
  cursor: pointer; transition: all 0.2s;
}
.quick-reply-btn:hover { background: var(--primary); color: #fff; }

.topics-bar {
  margin: 8px 0 8px 42px; font-size: 12px; color: #888;
  display: flex; gap: 12px; flex-wrap: wrap;
}
.topics-bar .covered { color: var(--success); }
.topics-bar .remaining { color: var(--warning); }

.chat-footer {
  display: flex; gap: 8px; padding: 12px 16px;
  border: 1px solid var(--border); border-top: none;
  border-radius: 0 0 12px 12px; background: #fff;
}
.chat-footer input {
  flex: 1; padding: 10px 14px; border: 1px solid var(--border);
  border-radius: 6px; font-size: 14px;
}
.chat-footer input:focus { outline: none; border-color: var(--primary); }

.chat-loading {
  display: flex; align-items: center; gap: 8px; margin: 8px 0 8px 42px;
  font-size: 13px; color: #888;
}
.chat-loading .dots span {
  display: inline-block; width: 6px; height: 6px;
  background: #aaa; border-radius: 50%; margin: 0 2px;
  animation: bounce 1.4s ease-in-out infinite;
}
.chat-loading .dots span:nth-child(2) { animation-delay: 0.2s; }
.chat-loading .dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes bounce {
  0%, 80%, 100% { transform: translateY(0); }
  40% { transform: translateY(-8px); }
}

.module-complete-card {
  background: #f0fff0; border: 1px solid #c3e6cb; border-radius: 10px;
  padding: 14px 18px; margin: 12px 0 12px 42px;
}
.module-complete-card h4 { color: var(--success); font-size: 14px; margin-bottom: 6px; }
.module-complete-card p { font-size: 13px; color: #555; }

/* ===== Assessment Table (Step 4) ===== */
.assess-summary {
  background: #f0f4ff; border-radius: 8px; padding: 16px; margin-bottom: 20px;
}
.assess-summary .confidence {
  display: inline-block; padding: 3px 10px; border-radius: 12px;
  font-size: 12px; font-weight: 600;
}
.conf-high { background: #d4edda; color: #155724; }
.conf-med { background: #fff3cd; color: #856404; }
.conf-low { background: #f8d7da; color: #721c24; }

.assess-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.assess-table th { background: #f5f5f5; padding: 8px 12px; text-align: left; border-bottom: 2px solid var(--border); }
.assess-table td { padding: 8px 12px; border-bottom: 1px solid #eee; }
.assess-table tr:hover { background: #fafafa; }

/* ===== Result (Step 5) ===== */
.result-card {
  text-align: center; padding: 40px;
}
.result-card .icon { font-size: 60px; margin-bottom: 16px; }
.result-card h2 { color: var(--success); margin-bottom: 12px; }
.result-info { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; text-align: left; }
.result-item { background: var(--light); padding: 12px; border-radius: 8px; }
.result-item .label { font-size: 12px; color: #888; }
.result-item .value { font-size: 16px; font-weight: 600; color: var(--primary); }

/* ===== Responsive ===== */
@media (max-width: 600px) {
  .form-row { grid-template-columns: 1fr; }
  .module-grid { grid-template-columns: 1fr; }
  .chat-body { height: 300px; }
  .chat-bubble { max-width: 90%; }
}

.hidden { display: none !important; }
</style>
</head>
<body>

<div class="wizard-container">
  <!-- Step Indicator -->
  <div class="step-indicator" id="stepIndicator">
    <div class="step-dot active" data-step="1">1</div>
    <div class="step-line"></div>
    <div class="step-dot" data-step="2">2</div>
    <div class="step-line"></div>
    <div class="step-dot" data-step="3">3</div>
    <div class="step-line"></div>
    <div class="step-dot" data-step="4">4</div>
    <div class="step-line"></div>
    <div class="step-dot" data-step="5">5</div>
  </div>

  <!-- Step 1: Basic Info -->
  <div id="step1" class="card">
    <h2>Step 1: å·¥å‚åŸºæœ¬ä¿¡æ¯</h2>
    <div class="form-row">
      <div class="form-group">
        <label><span class="req">*</span> å·¥å‚åç§°</label>
        <input id="factoryName" placeholder="å¦‚ï¼šå…­è†³é—¨é£Ÿå“åŠ å·¥å‚">
      </div>
      <div class="form-group">
        <label>è”ç³»äºº</label>
        <input id="contactName" placeholder="è´Ÿè´£äººå§“å">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>è”ç³»ç”µè¯</label>
        <input id="contactPhone" placeholder="æ‰‹æœºå·ç ">
      </div>
      <div class="form-group">
        <label>è¡Œä¸š</label>
        <select id="industry">
          <option value="">è¯·é€‰æ‹©è¡Œä¸š</option>
          <option value="è‚‰ç±»åŠ å·¥">è‚‰ç±»åŠ å·¥</option>
          <option value="æ°´äº§åŠ å·¥">æ°´äº§åŠ å·¥</option>
          <option value="ä¹³åˆ¶å“">ä¹³åˆ¶å“</option>
          <option value="çƒ˜ç„™é£Ÿå“">çƒ˜ç„™é£Ÿå“</option>
          <option value="æœè”¬åŠ å·¥">æœè”¬åŠ å·¥</option>
          <option value="é¥®æ–™">é¥®æ–™</option>
          <option value="è°ƒå‘³å“">è°ƒå‘³å“</option>
          <option value="å†·å†»é£Ÿå“">å†·å†»é£Ÿå“</option>
          <option value="ä¼‘é—²é£Ÿå“">ä¼‘é—²é£Ÿå“</option>
          <option value="ç²®æ²¹åŠ å·¥">ç²®æ²¹åŠ å·¥</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>å·¥å‚è§„æ¨¡</label>
        <select id="scale">
          <option value="">è¯·é€‰æ‹©</option>
          <option value="å°å‹(50äººä»¥ä¸‹)">å°å‹ (50äººä»¥ä¸‹)</option>
          <option value="ä¸­å‹(50-200äºº)">ä¸­å‹ (50-200äºº)</option>
          <option value="å¤§å‹(200-500äºº)">å¤§å‹ (200-500äºº)</option>
          <option value="è¶…å¤§å‹(500äººä»¥ä¸Š)">è¶…å¤§å‹ (500äººä»¥ä¸Š)</option>
        </select>
      </div>
      <div class="form-group">
        <label>ä¸»è¦äº§å“</label>
        <input id="products" placeholder="å¦‚ï¼šçŒªè‚‰é¦™è‚ ã€è…Šè‚‰ã€ç«è…¿">
      </div>
    </div>
    <div class="form-group">
      <label>å·¥å‚ç®€ä»‹ (å¯é€‰)</label>
      <textarea id="description" rows="3" placeholder="ç®€è¦æè¿°æ‚¨çš„å·¥å‚æƒ…å†µ..."></textarea>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="goToStep2()">ä¸‹ä¸€æ­¥</button>
    </div>
  </div>

  <!-- Step 2: Module Selection -->
  <div id="step2" class="card hidden">
    <h2>Step 2: é€‰æ‹©åŠŸèƒ½æ¨¡å—</h2>
    <p style="color:#666;margin-bottom:16px;">è¯·é€‰æ‹©æ‚¨éœ€è¦çš„ç³»ç»Ÿæ¨¡å—ï¼ˆè‡³å°‘é€‰1ä¸ªï¼‰ï¼ŒAIå°†é’ˆå¯¹é€‰ä¸­æ¨¡å—ä¸æ‚¨æ·±å…¥å¯¹è¯ã€‚</p>
    <div class="module-grid" id="moduleGrid"></div>
    <div class="btn-row">
      <button class="btn btn-outline" onclick="goToStep(1)">ä¸Šä¸€æ­¥</button>
      <button class="btn btn-primary" id="btnStep2Next" onclick="goToStep3()" disabled>ä¸‹ä¸€æ­¥</button>
    </div>
  </div>

  <!-- Step 3: AI Chat -->
  <div id="step3" class="card hidden" style="padding:0;">
    <div class="chat-header">
      <div>
        <strong>AI éœ€æ±‚è°ƒç ”</strong>
        <div class="module-label" id="chatModuleLabel">æ¨¡å— 1/4: äººæ•ˆæ•°æ®é‡‡é›†</div>
      </div>
      <button class="btn btn-outline" style="color:#fff;border-color:#fff;padding:6px 14px;font-size:12px;" onclick="skipModule()">è·³è¿‡æ­¤æ¨¡å—</button>
    </div>
    <div class="chat-body" id="chatBody"></div>
    <div class="chat-footer">
      <input id="chatInput" placeholder="è¯·è¾“å…¥æˆ–é€‰æ‹©ä¸Šæ–¹å¿«æ·å›å¤..." onkeydown="if(event.key==='Enter')sendChat()">
      <button class="btn btn-primary" onclick="sendChat()">å‘é€</button>
    </div>
    <div style="padding:12px 16px;display:flex;gap:12px;justify-content:space-between;">
      <button class="btn btn-outline" onclick="goToStep(2)">è¿”å›æ¨¡å—é€‰æ‹©</button>
      <button class="btn btn-success hidden" id="btnNextModule" onclick="nextModule()">ç»§ç»­ä¸‹ä¸€æ¨¡å—</button>
      <button class="btn btn-success hidden" id="btnToAssess" onclick="goToStep4()">ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š</button>
    </div>
  </div>

  <!-- Step 4: Assessment -->
  <div id="step4" class="card hidden">
    <h2>Step 4: AI è¯„ä¼°ç»“æœ</h2>
    <div id="assessContent">
      <div style="text-align:center;padding:40px;color:#888;">
        <div class="chat-loading"><div class="dots"><span></span><span></span><span></span></div> AI æ­£åœ¨åˆ†æå¯¹è¯è®°å½•å¹¶ç”Ÿæˆè¯„ä¼°...</div>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-outline" onclick="goToStep(3)">è¿”å›å¯¹è¯</button>
      <button class="btn btn-success" id="btnFinalize" onclick="goToStep5()" disabled>ç¡®è®¤åˆ›å»ºå·¥å‚</button>
    </div>
  </div>

  <!-- Step 5: Result -->
  <div id="step5" class="card hidden">
    <div class="result-card" id="resultContent">
      <div style="text-align:center;padding:40px;color:#888;">
        <div class="chat-loading"><div class="dots"><span></span><span></span><span></span></div> æ­£åœ¨åˆ›å»ºå·¥å‚...</div>
      </div>
    </div>
  </div>
</div>

<script>
// ========== Configuration ==========
const API_BASE = '/api/public/client-requirement';

// ========== MODULES constant (field catalog) ==========
const MODULES = [
  {
    id: "m0", name: "äººæ•ˆæ•°æ®é‡‡é›†", icon: "ğŸ¯",
    desc: "è§†è§‰è¯†åˆ«è¡¥å……çš„äººå·¥å½•å…¥å­—æ®µ",
    sections: [
      { id: "s-vl-1", title: "å·¥äººèº«ä»½ä¿¡æ¯", fields: [{name:"å·¥å·"},{name:"å§“å"},{name:"ç­ç»„"},{name:"å·¥ç§/å²—ä½"},{name:"æŠ€èƒ½ç­‰çº§"},{name:"æ—¶è–ª/æ—¥è–ª"}]},
      { id: "s-vl-2", title: "è€ƒå‹¤æ‰“å¡", fields: [{name:"æ‰“å¡æ—¥æœŸ"},{name:"ä¸Šç­æ‰“å¡æ—¶é—´"},{name:"ä¸‹ç­æ‰“å¡æ—¶é—´"},{name:"è€ƒå‹¤çŠ¶æ€"},{name:"æ‰“å¡æ–¹å¼"}]},
      { id: "s-vl-3", title: "å·¥æ—¶è®°å½•", fields: [{name:"ç”Ÿäº§æ‰¹æ¬¡å·"},{name:"ç­¾å…¥æ—¶é—´"},{name:"ç­¾å‡ºæ—¶é—´"},{name:"ä¼‘æ¯æ—¶é•¿"},{name:"å®é™…å·¥ä½œæ—¶é•¿"}]},
      { id: "s-vl-4", title: "è®¾å¤‡/å·¥ä½ç»‘å®š", fields: [{name:"å·¥ä½ç¼–å·"},{name:"å·¥ä½åç§°"},{name:"ç»‘å®šè®¾å¤‡"},{name:"æ‘„åƒå¤´ID"}]},
      { id: "s-vl-5", title: "äº§é‡æ•°æ®", fields: [{name:"äº§å“ç±»å‹"},{name:"è®¡åˆ’äº§é‡"},{name:"å®é™…äº§é‡"},{name:"åˆæ ¼å“æ•°é‡"},{name:"ä¸è‰¯å“æ•°é‡"},{name:"è¿”å·¥æ•°é‡"}]},
      { id: "s-vl-6", title: "å·¥åºå…³è”", fields: [{name:"å·¥åºç±»å‹"},{name:"å…³è”æ‰¹æ¬¡"},{name:"å·¥åºå¼€å§‹æ—¶é—´"},{name:"å·¥åºç»“æŸæ—¶é—´"}]}
    ]
  },
  {
    id: "m1", name: "åŸºç¡€æ•°æ®", icon: "ğŸ“¦",
    desc: "åŸææ–™ã€äº§å“ã€ä¾›åº”å•†ã€å®¢æˆ·ã€è®¾å¤‡",
    sections: [
      { id: "s3-1", title: "åŸææ–™ç±»å‹", fields: [{name:"ææ–™ç¼–ç "},{name:"ææ–™åç§°"},{name:"ææ–™åˆ†ç±»"},{name:"è®¡é‡å•ä½"},{name:"å‚è€ƒå•ä»·"},{name:"å­˜å‚¨ç±»å‹"},{name:"ä¿è´¨æœŸå¤©æ•°"},{name:"æœ€ä½åº“å­˜é¢„è­¦"},{name:"æœ€é«˜åº“å­˜ä¸Šé™"},{name:"å¤‡æ³¨"}]},
      { id: "s3-2", title: "äº§å“ç±»å‹", fields: [{name:"äº§å“ç¼–ç "},{name:"äº§å“åç§°"},{name:"äº§å“åˆ†ç±»"},{name:"è®¡é‡å•ä½"},{name:"å‡ºå‚å•ä»·"},{name:"äº§å“è§„æ ¼"},{name:"åŒ…è£…è§„æ ¼"},{name:"ä¿è´¨æœŸå¤©æ•°"},{name:"æ ‡å‡†å·¥æ—¶"},{name:"å·¥åºæ­¥éª¤"},{name:"äº§å“å›¾ç‰‡"},{name:"å¤‡æ³¨"}]},
      { id: "s3-3", title: "ä¾›åº”å•†ä¿¡æ¯", fields: [{name:"ä¾›åº”å•†ç¼–ç "},{name:"ä¾›åº”å•†åç§°"},{name:"è”ç³»äºº"},{name:"è”ç³»ç”µè¯"},{name:"é‚®ç®±"},{name:"åœ°å€"},{name:"è¥ä¸šæ‰§ç…§å·"},{name:"ç»è¥ç±»å‹"},{name:"ä¾›åº”ææ–™"},{name:"èµ„è´¨è¯ä¹¦"},{name:"ä»˜æ¬¾æ¡ä»¶"},{name:"ä¾›è´§å‘¨æœŸ"},{name:"ä¿¡ç”¨é¢åº¦"},{name:"ä¾›åº”å•†è¯„åˆ†"}]},
      { id: "s3-4", title: "å®¢æˆ·ä¿¡æ¯", fields: [{name:"å®¢æˆ·ç¼–ç "},{name:"å®¢æˆ·åç§°"},{name:"å®¢æˆ·ç±»å‹"},{name:"è¡Œä¸š"},{name:"è”ç³»äºº"},{name:"è”ç³»ç”µè¯"},{name:"æ”¶è´§åœ°å€"},{name:"å¼€ç¥¨åœ°å€"},{name:"ç¨å·"},{name:"ä»˜æ¬¾æ¡ä»¶"},{name:"ä¿¡ç”¨é¢åº¦"},{name:"å®¢æˆ·è¯„åˆ†"}]},
      { id: "s3-5", title: "è®¾å¤‡ä¿¡æ¯", fields: [{name:"è®¾å¤‡ç¼–ç "},{name:"è®¾å¤‡åç§°"},{name:"è®¾å¤‡ç±»å‹"},{name:"å‹å·"},{name:"åˆ¶é€ å•†"},{name:"åºåˆ—å·"},{name:"è´­å…¥æ—¥æœŸ"},{name:"è´­å…¥ä»·æ ¼"},{name:"æŠ˜æ—§å¹´é™"},{name:"æ¯å°æ—¶æˆæœ¬"},{name:"åŠŸç‡"},{name:"å®‰è£…ä½ç½®"},{name:"ä¿å…»å‘¨æœŸ"},{name:"ä¿ä¿®åˆ°æœŸ"}]},
      { id: "s3-6", title: "äº§å“é…æ–¹ï¼ˆBOMï¼‰", fields: [{name:"äº§å“ç±»å‹"},{name:"åŸææ–™ç±»å‹"},{name:"æ ‡å‡†ç”¨é‡"},{name:"å¾—ç‡"},{name:"å‚è€ƒå•ä»·"},{name:"ç¨ç‡"}]}
    ]
  },
  {
    id: "m2", name: "ç”Ÿäº§ç®¡ç†", icon: "ğŸ­",
    desc: "ç”Ÿäº§è®¡åˆ’ã€æ‰¹æ¬¡æ‰§è¡Œã€å·¥åºè®°å½•ã€è´¨æ£€",
    sections: [
      { id: "s4-2", title: "ç”Ÿäº§è®¡åˆ’", fields: [{name:"è®¡åˆ’ç¼–å·"},{name:"äº§å“ç±»å‹"},{name:"è®¡åˆ’æ•°é‡"},{name:"è®¡é‡å•ä½"},{name:"è®¡åˆ’å¼€å§‹æ—¶é—´"},{name:"è®¡åˆ’ç»“æŸæ—¶é—´"},{name:"ä¼˜å…ˆçº§"},{name:"è®¡åˆ’çŠ¶æ€"},{name:"è®¡åˆ’ç±»å‹"},{name:"æ¥æºç±»å‹"},{name:"å®¢æˆ·è®¢å•å·"},{name:"å®¢æˆ·åç§°"},{name:"é¢„ä¼°ææ–™æˆæœ¬"},{name:"é¢„ä¼°äººå·¥æˆæœ¬"},{name:"å¤‡æ³¨"}]},
      { id: "s4-3", title: "ç”Ÿäº§æ‰¹æ¬¡", fields: [{name:"æ‰¹æ¬¡å·"},{name:"å…³è”è®¡åˆ’"},{name:"äº§å“ç±»å‹"},{name:"è®¡åˆ’äº§é‡"},{name:"æŠ•å…¥é‡"},{name:"å®é™…äº§é‡"},{name:"è‰¯å“æ•°é‡"},{name:"ä¸è‰¯å“æ•°é‡"},{name:"å¾—ç‡"},{name:"ç”Ÿäº§æ•ˆç‡"},{name:"æ‰¹æ¬¡çŠ¶æ€"},{name:"è´¨é‡çŠ¶æ€"},{name:"å¼€å§‹æ—¶é—´"},{name:"ç»“æŸæ—¶é—´"},{name:"ä½¿ç”¨è®¾å¤‡"},{name:"ç”Ÿäº§è´Ÿè´£äºº"},{name:"å·¥äººæ•°é‡"},{name:"ææ–™æˆæœ¬"},{name:"äººå·¥æˆæœ¬"},{name:"è®¾å¤‡æˆæœ¬"},{name:"æ€»æˆæœ¬"},{name:"å•ä½æˆæœ¬"},{name:"å¤‡æ³¨"}]},
      { id: "s4-4", title: "å·¥åºè¿‡ç¨‹è®°å½•", fields: [{name:"å…³è”æ‰¹æ¬¡"},{name:"å·¥åºç±»å‹"},{name:"å¼€å§‹æ—¶é—´"},{name:"ç»“æŸæ—¶é—´"},{name:"å·¥åºæ—¶é•¿"},{name:"æŠ•å…¥é‡é‡"},{name:"äº§å‡ºé‡é‡"},{name:"æŸè€—é‡é‡"},{name:"æŸè€—ç‡"},{name:"åˆæ ¼æ•°é‡"},{name:"ä¸åˆæ ¼æ•°é‡"},{name:"è¿”å·¥æ•°é‡"},{name:"ç¯å¢ƒæ¸©åº¦"},{name:"äº§å“æ¸©åº¦"},{name:"ç›®æ ‡æ¸©åº¦"},{name:"ä½¿ç”¨è®¾å¤‡"},{name:"è®¾å¤‡è¿è¡Œæ—¶é•¿"},{name:"è®¾å¤‡åœæœºæ—¶é•¿"},{name:"è®¾å¤‡OEE"},{name:"ç”¨æ°´é‡"},{name:"ç”¨ç”µé‡"},{name:"æ“ä½œå‘˜"},{name:"å·¥äººæ•°é‡"},{name:"pHå€¼"},{name:"ç›åº¦"},{name:"ATPæ£€æµ‹å€¼"},{name:"å¤‡æ³¨"}]},
      { id: "s4-5", title: "åŸææ–™æ¶ˆè€—è®°å½•", fields: [{name:"å…³è”ç”Ÿäº§æ‰¹æ¬¡"},{name:"åŸææ–™æ‰¹æ¬¡"},{name:"æ¶ˆè€—æ•°é‡"},{name:"å•ä»·"},{name:"æ¶ˆè€—é‡‘é¢"},{name:"æ¶ˆè€—æ—¶é—´"},{name:"è®°å½•äºº"},{name:"å¤‡æ³¨"}]},
      { id: "s4-6", title: "è´¨é‡æ£€éªŒè®°å½•", fields: [{name:"å…³è”ç”Ÿäº§æ‰¹æ¬¡"},{name:"è´¨æ£€å‘˜"},{name:"æ£€éªŒæ—¥æœŸ"},{name:"æŠ½æ ·æ•°é‡"},{name:"åˆæ ¼æ•°é‡"},{name:"ä¸åˆæ ¼æ•°é‡"},{name:"åˆæ ¼ç‡"},{name:"æ£€éªŒç»“è®º"},{name:"æ£€éªŒè¯¦æƒ…"}]}
    ]
  },
  {
    id: "m3", name: "äººæ•ˆç®¡ç†", icon: "ğŸ‘·",
    desc: "å‘˜å·¥è€ƒå‹¤ã€å·¥æ—¶ç»Ÿè®¡ã€äººå·¥æˆæœ¬",
    sections: [
      { id: "s5-1", title: "è€ƒå‹¤æ‰“å¡è®°å½•", fields: [{name:"å‘˜å·¥"},{name:"æ‰“å¡æ—¥æœŸ"},{name:"ä¸Šç­æ‰“å¡æ—¶é—´"},{name:"ä¸‹ç­æ‰“å¡æ—¶é—´"},{name:"ä¼‘æ¯å¼€å§‹æ—¶é—´"},{name:"ä¼‘æ¯ç»“æŸæ—¶é—´"},{name:"å·¥ä½œæ—¶é•¿"},{name:"ä¼‘æ¯æ—¶é•¿"},{name:"è€ƒå‹¤çŠ¶æ€"},{name:"æ‰“å¡ä½ç½®"},{name:"æ‰“å¡è®¾å¤‡"}]},
      { id: "s5-2", title: "ç”Ÿäº§æ‰¹æ¬¡å·¥æ—¶è®°å½•", fields: [{name:"ç”Ÿäº§æ‰¹æ¬¡"},{name:"å‘˜å·¥"},{name:"ç­¾å…¥æ—¶é—´"},{name:"ç­¾å‡ºæ—¶é—´"},{name:"å·¥ä½œæ—¶é•¿"},{name:"äººå·¥æˆæœ¬"},{name:"åˆ†é…äºº"},{name:"çŠ¶æ€"},{name:"å¤‡æ³¨"}]}
    ]
  },
  {
    id: "m4", name: "ä»“å‚¨ç‰©æµ", icon: "ğŸšš",
    desc: "åŸææ–™å…¥åº“ã€æˆå“å‡ºè´§ã€æº¯æºæ ‡ç­¾",
    sections: [
      { id: "s4-1", title: "åŸææ–™å…¥åº“", fields: [{name:"æ‰¹æ¬¡å·"},{name:"åŸææ–™ç±»å‹"},{name:"ä¾›åº”å•†"},{name:"å…¥åº“æ•°é‡"},{name:"è®¡é‡å•ä½"},{name:"å•ä»¶é‡é‡"},{name:"è¿›è´§å•ä»·"},{name:"å…¥åº“æ—¥æœŸ"},{name:"ç”Ÿäº§æ—¥æœŸ"},{name:"åˆ°æœŸæ—¥æœŸ"},{name:"å­˜å‚¨ä½ç½®"},{name:"è´¨æ£€è¯ä¹¦"},{name:"å…¥åº“çŠ¶æ€"},{name:"å¤‡æ³¨"}]},
      { id: "s4-7", title: "å‡ºè´§å‘è¿è®°å½•", fields: [{name:"å‡ºè´§å•å·"},{name:"å®¢æˆ·"},{name:"è®¢å•å·"},{name:"äº§å“åç§°"},{name:"å‡ºè´§æ•°é‡"},{name:"è®¡é‡å•ä½"},{name:"å•ä»·"},{name:"æ€»é‡‘é¢"},{name:"å‘è´§æ—¥æœŸ"},{name:"æ”¶è´§åœ°å€"},{name:"ç‰©æµå…¬å¸"},{name:"è¿å•å·"},{name:"å‡ºè´§çŠ¶æ€"},{name:"å¤‡æ³¨"}]},
      { id: "s4-8", title: "æº¯æºæ ‡ç­¾", fields: [{name:"æ ‡ç­¾ç¼–ç "},{name:"æ ‡ç­¾ç±»å‹"},{name:"å…³è”ç±»å‹"},{name:"å…³è”æ‰¹æ¬¡"},{name:"æº¯æºç "},{name:"äºŒç»´ç å†…å®¹"},{name:"äº§å“åç§°"},{name:"äº§å“è§„æ ¼"},{name:"ç”Ÿäº§æ—¥æœŸ"},{name:"ä¿è´¨æœŸ"},{name:"åˆ°æœŸæ—¥æœŸ"},{name:"æ ‡ç­¾çŠ¶æ€"},{name:"æ‰“å°æ¬¡æ•°"},{name:"è´´æ ‡æ—¶é—´"}]}
    ]
  },
  {
    id: "m5", name: "å…¶ä»–", icon: "ğŸ“Š",
    desc: "åºŸå¼ƒå¤„ç½®ã€ç¯å¢ƒç›‘æ§",
    sections: [
      { id: "s6-1", title: "åºŸå¼ƒå¤„ç½®è®°å½•", fields: [{name:"å¤„ç½®ç±»å‹"},{name:"æ•°é‡"},{name:"åŸå› "},{name:"æ—¥æœŸ"},{name:"å¤„ç½®æ–¹å¼"},{name:"é¢„ä¼°æŸå¤±"},{name:"å®é™…æŸå¤±"},{name:"å›æ”¶ä»·å€¼"},{name:"å®¡æ‰¹äºº"},{name:"å®¡æ‰¹æ—¥æœŸ"}]},
      { id: "s7-1", title: "ç¯å¢ƒç›‘æ§æ•°æ®", fields: [{name:"ç›‘æ§è®¾å¤‡"},{name:"æ•°æ®ç±»å‹"},{name:"ç›‘æ§å€¼"},{name:"ä½ç½®"},{name:"é‡‡é›†æ—¶é—´"},{name:"æ•°æ®æ¥æº"}]}
    ]
  }
];

const TOTAL_FIELDS = MODULES.reduce((sum, m) => sum + m.sections.reduce((s, sec) => s + sec.fields.length, 0), 0);

// ========== State ==========
let state = {
  currentStep: 1,
  companyId: null,
  selectedModules: [],
  // Chat state
  currentModuleIndex: 0,
  conversations: {},      // { "m2": [{role, content}, ...] }
  moduleSummaries: {},     // { "m2": "summary..." }
  completedModules: [],
  chatLoading: false,
  // Assessment
  assessmentData: null,
  // Result
  resultData: null,
};

// Load from localStorage
try {
  const saved = localStorage.getItem('onboarding_wizard_state');
  if (saved) {
    const parsed = JSON.parse(saved);
    Object.assign(state, parsed);
  }
} catch(e) {}

function saveState() {
  try { localStorage.setItem('onboarding_wizard_state', JSON.stringify(state)); } catch(e) {}
}

// ========== Step Navigation ==========
function goToStep(n) {
  state.currentStep = n;
  saveState();
  renderStep();
}

function renderStep() {
  for (let i = 1; i <= 5; i++) {
    document.getElementById('step' + i).classList.toggle('hidden', i !== state.currentStep);
  }
  // Update step indicator
  document.querySelectorAll('.step-dot').forEach(dot => {
    const s = parseInt(dot.dataset.step);
    dot.classList.remove('active', 'completed');
    if (s === state.currentStep) dot.classList.add('active');
    else if (s < state.currentStep) dot.classList.add('completed');
  });
  document.querySelectorAll('.step-line').forEach((line, i) => {
    line.classList.toggle('completed', i + 1 < state.currentStep);
  });
}

// ========== Step 1 ==========
function goToStep2() {
  const name = document.getElementById('factoryName').value.trim();
  if (!name) { alert('è¯·è¾“å…¥å·¥å‚åç§°'); return; }
  goToStep(2);
  renderModuleGrid();
}

// ========== Step 2: Module Selection ==========
function renderModuleGrid() {
  const grid = document.getElementById('moduleGrid');
  grid.innerHTML = '';
  MODULES.forEach(m => {
    const fieldCount = m.sections.reduce((s, sec) => s + sec.fields.length, 0);
    const selected = state.selectedModules.includes(m.id);
    const div = document.createElement('div');
    div.className = 'module-card' + (selected ? ' selected' : '');
    div.onclick = () => toggleModule(m.id);
    div.innerHTML = `
      <div class="check">&#10003;</div>
      <div class="icon">${m.icon}</div>
      <div class="name">${m.name}</div>
      <div class="desc">${m.desc}</div>
      <div class="field-count">${fieldCount} ä¸ªæ•°æ®å­—æ®µ</div>
    `;
    grid.appendChild(div);
  });
  updateStep2Btn();
}

function toggleModule(id) {
  const idx = state.selectedModules.indexOf(id);
  if (idx >= 0) state.selectedModules.splice(idx, 1);
  else state.selectedModules.push(id);
  saveState();
  renderModuleGrid();
}

function updateStep2Btn() {
  document.getElementById('btnStep2Next').disabled = state.selectedModules.length === 0;
}

// ========== Step 3: AI Chat ==========
async function goToStep3() {
  goToStep(3);
  state.currentModuleIndex = 0;
  // Find first non-completed selected module
  const selectedMods = state.selectedModules.filter(m => !state.completedModules.includes(m));
  if (selectedMods.length === 0) {
    // All done
    goToStep4();
    return;
  }
  await startModuleChat();
}

function getCurrentModuleId() {
  const remaining = state.selectedModules.filter(m => !state.completedModules.includes(m));
  return remaining.length > 0 ? remaining[0] : null;
}

async function startModuleChat() {
  const moduleId = getCurrentModuleId();
  if (!moduleId) { goToStep4(); return; }

  const mod = MODULES.find(m => m.id === moduleId);
  const completedCount = state.completedModules.length;
  const totalSelected = state.selectedModules.length;
  document.getElementById('chatModuleLabel').textContent =
    `æ¨¡å— ${completedCount + 1}/${totalSelected}: ${mod ? mod.name : moduleId}`;

  // Initialize conversation for this module if not exists
  if (!state.conversations[moduleId]) {
    state.conversations[moduleId] = [];
  }

  renderChat();

  // If no messages yet, call start-module
  if (state.conversations[moduleId].length === 0) {
    state.chatLoading = true;
    renderChat();

    try {
      const basicInfo = getBasicInfo();
      const resp = await fetch(API_BASE + '/wizard/start-module', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          companyId: state.companyId || 'preview',
          moduleId: moduleId,
          selectedModules: state.selectedModules,
          priorModulesSummary: state.moduleSummaries,
        })
      });
      const data = await resp.json();
      if (data.success) {
        const d = data.data;
        state.conversations[moduleId].push({ role: 'assistant', content: d.message });
        handleAIResponse(d);
      }
    } catch(e) {
      console.error('Start module chat failed:', e);
      state.conversations[moduleId].push({ role: 'assistant', content: 'æ‚¨å¥½ï¼è¯·æè¿°ä¸€ä¸‹è´µå·¥å‚åœ¨è¿™ä¸ªæ¨¡å—æ–¹é¢çš„åŸºæœ¬æƒ…å†µã€‚' });
    }
    state.chatLoading = false;
    saveState();
    renderChat();
  }
}

async function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg || state.chatLoading) return;
  input.value = '';

  const moduleId = getCurrentModuleId();
  if (!moduleId) return;

  state.conversations[moduleId].push({ role: 'user', content: msg });
  state.chatLoading = true;
  saveState();
  renderChat();

  try {
    const resp = await fetch(API_BASE + '/wizard/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        companyId: state.companyId || 'preview',
        moduleId: moduleId,
        message: msg,
        conversationHistory: state.conversations[moduleId],
      })
    });
    const data = await resp.json();
    if (data.success) {
      const d = data.data;
      state.conversations[moduleId].push({ role: 'assistant', content: d.message });
      handleAIResponse(d);
    }
  } catch(e) {
    state.conversations[moduleId].push({ role: 'assistant', content: 'æŠ±æ­‰ï¼Œæš‚æ—¶æ— æ³•è¿æ¥AIæœåŠ¡ã€‚è¯·ç¨åé‡è¯•ã€‚' });
  }

  state.chatLoading = false;
  saveState();
  renderChat();
}

function sendQuickReply(text) {
  document.getElementById('chatInput').value = text;
  sendChat();
}

let lastAIResponse = null;

function handleAIResponse(d) {
  lastAIResponse = d;
  if (d.moduleComplete) {
    const moduleId = getCurrentModuleId();
    if (moduleId && d.moduleSummary) {
      state.moduleSummaries[moduleId] = d.moduleSummary;
    }
    if (moduleId && !state.completedModules.includes(moduleId)) {
      state.completedModules.push(moduleId);
    }
    saveState();
  }
  updateChatButtons();
}

function updateChatButtons() {
  const remaining = state.selectedModules.filter(m => !state.completedModules.includes(m));
  const btnNext = document.getElementById('btnNextModule');
  const btnAssess = document.getElementById('btnToAssess');

  if (lastAIResponse && lastAIResponse.moduleComplete) {
    if (remaining.length > 0) {
      btnNext.classList.remove('hidden');
      btnAssess.classList.add('hidden');
    } else {
      btnNext.classList.add('hidden');
      btnAssess.classList.remove('hidden');
    }
  } else {
    btnNext.classList.add('hidden');
    btnAssess.classList.add('hidden');
  }
}

function skipModule() {
  const moduleId = getCurrentModuleId();
  if (moduleId && !state.completedModules.includes(moduleId)) {
    state.completedModules.push(moduleId);
    state.moduleSummaries[moduleId] = '(è·³è¿‡)';
  }
  saveState();
  nextModule();
}

async function nextModule() {
  lastAIResponse = null;
  document.getElementById('btnNextModule').classList.add('hidden');
  const remaining = state.selectedModules.filter(m => !state.completedModules.includes(m));
  if (remaining.length === 0) {
    goToStep4();
  } else {
    await startModuleChat();
  }
}

function renderChat() {
  const body = document.getElementById('chatBody');
  const moduleId = getCurrentModuleId();
  if (!moduleId) { body.innerHTML = ''; return; }

  const msgs = state.conversations[moduleId] || [];
  let html = '';

  msgs.forEach((msg, i) => {
    const isAI = msg.role === 'assistant';
    html += `<div class="chat-msg ${isAI ? 'ai' : 'user'}">
      <div class="chat-avatar">${isAI ? 'ğŸ¤–' : 'ğŸ‘¤'}</div>
      <div class="chat-bubble">${escapeHtml(msg.content)}</div>
    </div>`;
  });

  // Quick replies
  if (lastAIResponse && lastAIResponse.suggestedReplies && lastAIResponse.suggestedReplies.length > 0 && !state.chatLoading) {
    html += '<div class="quick-replies">';
    lastAIResponse.suggestedReplies.forEach(r => {
      html += `<button class="quick-reply-btn" onclick="sendQuickReply('${escapeAttr(r)}')">${escapeHtml(r)}</button>`;
    });
    html += '</div>';
  }

  // Topics bar
  if (lastAIResponse && (lastAIResponse.topicsCovered?.length || lastAIResponse.topicsRemaining?.length)) {
    html += '<div class="topics-bar">';
    if (lastAIResponse.topicsCovered?.length) {
      html += `<span class="covered">&#10003; å·²è¦†ç›–: ${lastAIResponse.topicsCovered.join(', ')}</span>`;
    }
    if (lastAIResponse.topicsRemaining?.length) {
      html += `<span class="remaining">&#9679; å¾…äº†è§£: ${lastAIResponse.topicsRemaining.join(', ')}</span>`;
    }
    html += '</div>';
  }

  // Module complete card
  if (lastAIResponse && lastAIResponse.moduleComplete) {
    const summary = lastAIResponse.moduleSummary || state.moduleSummaries[moduleId] || '';
    html += `<div class="module-complete-card">
      <h4>&#10003; æ¨¡å—è°ƒç ”å®Œæˆ</h4>
      <p>${escapeHtml(summary)}</p>
    </div>`;
  }

  // Loading indicator
  if (state.chatLoading) {
    html += `<div class="chat-loading"><div class="dots"><span></span><span></span><span></span></div> AI æ­£åœ¨æ€è€ƒ...</div>`;
  }

  body.innerHTML = html;
  body.scrollTop = body.scrollHeight;
  updateChatButtons();
}

// ========== Step 4: Assessment ==========
async function goToStep4() {
  goToStep(4);
  document.getElementById('btnFinalize').disabled = true;

  try {
    const resp = await fetch(API_BASE + '/wizard/assess', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        companyId: state.companyId || 'preview',
        selectedModules: state.selectedModules,
        allConversations: state.conversations,
      })
    });
    const data = await resp.json();
    if (data.success) {
      state.assessmentData = data.data;
      saveState();
      renderAssessment(data.data);
      document.getElementById('btnFinalize').disabled = false;
    } else {
      document.getElementById('assessContent').innerHTML =
        `<div style="color:red;padding:20px;">è¯„ä¼°å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
    }
  } catch(e) {
    document.getElementById('assessContent').innerHTML =
      `<div style="color:red;padding:20px;">æ— æ³•è¿æ¥AIæœåŠ¡: ${e.message}</div>`;
  }
}

function renderAssessment(data) {
  const confClass = data.confidence >= 0.8 ? 'conf-high' : data.confidence >= 0.6 ? 'conf-med' : 'conf-low';
  let html = `
    <div class="assess-summary">
      <strong>${escapeHtml(data.summary || '')}</strong>
      <span class="confidence ${confClass}" style="margin-left:12px;">
        ç½®ä¿¡åº¦: ${Math.round((data.confidence || 0) * 100)}%
      </span>
    </div>
  `;

  // Module insights
  if (data.moduleInsights && Object.keys(data.moduleInsights).length > 0) {
    html += '<h3 style="margin-top:16px;">æ¨¡å—æ´å¯Ÿ</h3>';
    for (const [mid, insight] of Object.entries(data.moduleInsights)) {
      const mod = MODULES.find(m => m.id === mid);
      html += `<div style="padding:8px 12px;margin:4px 0;background:#f9f9f9;border-radius:6px;">
        <strong>${mod ? mod.icon + ' ' + mod.name : mid}:</strong> ${escapeHtml(insight)}
      </div>`;
    }
  }

  // Field assessment table
  if (data.items && data.items.length > 0) {
    html += `<h3 style="margin-top:20px;">å­—æ®µè¯„ä¼° (${data.items.length} é¡¹)</h3>
    <div style="max-height:300px;overflow-y:auto;">
    <table class="assess-table">
      <thead><tr><th>æ¨¡å—</th><th>å­—æ®µ</th><th>é€‚ç”¨</th><th>ç½®ä¿¡åº¦</th><th>è¾“å…¥æ–¹å¼</th><th>ç†ç”±</th></tr></thead>
      <tbody>`;
    data.items.forEach(item => {
      const confC = item.confidence >= 0.8 ? 'conf-high' : item.confidence >= 0.6 ? 'conf-med' : 'conf-low';
      html += `<tr>
        <td>${escapeHtml(item.section || '')}</td>
        <td>${escapeHtml(item.fieldName || '')}</td>
        <td>${item.applicable ? '&#10003;' : '&#10007;'}</td>
        <td><span class="confidence ${confC}" style="font-size:11px;">${Math.round(item.confidence * 100)}%</span></td>
        <td>${escapeHtml(item.inputMode || '')}</td>
        <td style="font-size:12px;color:#666;">${escapeHtml(item.reasoning || '')}</td>
      </tr>`;
    });
    html += '</tbody></table></div>';
  }

  // Stage templates
  if (data.stageTemplates && data.stageTemplates.length > 0) {
    html += '<h3 style="margin-top:20px;">å·¥åºæ¨¡æ¿</h3><div style="display:flex;gap:8px;flex-wrap:wrap;">';
    data.stageTemplates.forEach(s => {
      const style = s.isKey ? 'background:#e3f2fd;border:1px solid #90caf9;' : 'background:#f5f5f5;border:1px solid #ddd;';
      html += `<div style="${style}padding:6px 12px;border-radius:6px;font-size:13px;">
        ${s.order}. ${escapeHtml(s.displayName || s.stageName)}${s.isKey ? ' <strong>(å…³é”®)</strong>' : ''}
      </div>`;
    });
    html += '</div>';
  }

  document.getElementById('assessContent').innerHTML = html;
}

// ========== Step 5: Finalize ==========
async function goToStep5() {
  goToStep(5);

  // First ensure company exists
  if (!state.companyId) {
    try {
      const resp = await fetch(API_BASE + '/wizard/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(getBasicInfo())
      });
      const data = await resp.json();
      if (data.success) {
        state.companyId = data.data.companyId;
        saveState();
      }
    } catch(e) {
      console.error('Failed to create company:', e);
    }
  }

  try {
    const resp = await fetch(API_BASE + '/wizard/finalize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        companyId: state.companyId,
        assessmentData: state.assessmentData || {},
      })
    });
    const data = await resp.json();
    if (data.success) {
      state.resultData = data.data;
      saveState();
      renderResult(data.data);
    } else {
      document.getElementById('resultContent').innerHTML =
        `<div style="color:red;padding:20px;">åˆ›å»ºå¤±è´¥: ${escapeHtml(data.message || 'æœªçŸ¥é”™è¯¯')}</div>`;
    }
  } catch(e) {
    document.getElementById('resultContent').innerHTML =
      `<div style="color:red;padding:20px;">è¿æ¥å¤±è´¥: ${e.message}</div>`;
  }
}

function renderResult(data) {
  const users = data.users || [];
  let usersHtml = '';
  if (users.length > 0) {
    usersHtml = users.map(u => `<div style="font-size:13px;">${u.username || u.name} (å¯†ç : 123456)</div>`).join('');
  } else {
    usersHtml = '<div style="font-size:13px;color:#888;">é»˜è®¤ç”¨æˆ·å·²åˆ›å»ºï¼ˆå¯†ç : 123456ï¼‰</div>';
  }

  document.getElementById('resultContent').innerHTML = `
    <div class="icon">&#10003;</div>
    <h2>å·¥å‚åˆ›å»ºæˆåŠŸ!</h2>
    <p style="color:#666;">æ‚¨çš„å·¥å‚å·²æˆåŠŸå…¥é©»ç™½å©çºªé£Ÿå“æº¯æºç³»ç»Ÿ</p>
    <div class="result-info">
      <div class="result-item">
        <div class="label">å·¥å‚ ID</div>
        <div class="value">${escapeHtml(data.factoryId || '')}</div>
      </div>
      <div class="result-item">
        <div class="label">è¡¨å•æ¨¡æ¿</div>
        <div class="value">${data.formTemplatesCreated || 0} ä¸ª</div>
      </div>
      <div class="result-item">
        <div class="label">é¢„è­¦è§„åˆ™</div>
        <div class="value">${data.alertsCreated || 0} æ¡</div>
      </div>
      <div class="result-item">
        <div class="label">é»˜è®¤ç”¨æˆ·</div>
        <div class="value">${usersHtml}</div>
      </div>
    </div>
    <div style="margin-top:24px;">
      <button class="btn btn-primary" onclick="resetWizard()">åˆ›å»ºå¦ä¸€ä¸ªå·¥å‚</button>
    </div>
  `;
}

function resetWizard() {
  state = {
    currentStep: 1,
    companyId: null,
    selectedModules: [],
    currentModuleIndex: 0,
    conversations: {},
    moduleSummaries: {},
    completedModules: [],
    chatLoading: false,
    assessmentData: null,
    resultData: null,
  };
  localStorage.removeItem('onboarding_wizard_state');
  // Clear form inputs
  document.getElementById('factoryName').value = '';
  document.getElementById('contactName').value = '';
  document.getElementById('contactPhone').value = '';
  document.getElementById('industry').value = '';
  document.getElementById('scale').value = '';
  document.getElementById('products').value = '';
  document.getElementById('description').value = '';
  goToStep(1);
}

// ========== Helpers ==========
function getBasicInfo() {
  return {
    factoryName: document.getElementById('factoryName').value.trim(),
    contactName: document.getElementById('contactName').value.trim(),
    contactPhone: document.getElementById('contactPhone').value.trim(),
    industry: document.getElementById('industry').value,
    scale: document.getElementById('scale').value,
    products: document.getElementById('products').value.trim(),
    description: document.getElementById('description').value.trim(),
  };
}

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function escapeAttr(str) {
  if (!str) return '';
  return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

// ========== Init ==========
renderStep();
if (state.currentStep === 2) renderModuleGrid();
</script>
</body>
</html>
