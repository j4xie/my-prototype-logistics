# 基于批次的库存管理设计方案

## 🎯 核心概念：批次管理

### 为什么需要批次管理？

1. **追溯性**: 知道每批产品用的是哪批原材料
2. **成本准确**: 不同批次采购价不同，精准计算成本
3. **先进先出**: 管理保质期，避免浪费
4. **质量追溯**: 如果产品有问题，能追溯到原材料批次

---

## 📋 数据库设计

### 方案A: 原材料批次表（推荐）

```prisma
// 原材料入库批次表
model MaterialBatch {
  id              String   @id @default(uuid())
  batchNumber     String   @unique  // 批次号：MAT-20251001-001
  factoryId       String
  materialTypeId  String   // 关联原材料类型

  // 入库信息
  inboundQuantity Decimal  @db.Decimal(10, 2)  // 入库数量
  remainingQuantity Decimal @db.Decimal(10, 2)  // 剩余数量
  usedQuantity    Decimal  @default(0) @db.Decimal(10, 2)  // 已使用

  // 成本信息
  unitPrice       Decimal  @db.Decimal(10, 2)  // 单价
  totalCost       Decimal  @db.Decimal(12, 2)  // 总成本

  // 供应商和日期
  merchantId      String?
  inboundDate     DateTime @db.Date
  expiryDate      DateTime? @db.Date  // 保质期

  // 状态
  status          String   @default("available")  // available / depleted / expired

  // 其他信息
  qualityGrade    String?  // 质量等级
  storageLocation String?  // 存储位置
  notes           String?  @db.Text
  createdBy       Int
  createdAt       DateTime @default(now())

  factory         Factory         @relation(...)
  materialType    RawMaterialType @relation(...)
  merchant        Merchant?       @relation(...)
  creator         User            @relation(...)

  // 关联到生产计划的使用记录
  planUsages      ProductionPlanBatchUsage[]

  @@index([factoryId, materialTypeId, status])
  @@index([inboundDate])
  @@index([batchNumber])
}

// 生产计划-批次使用关联表
model ProductionPlanBatchUsage {
  id                String   @id @default(uuid())
  productionPlanId  String
  materialBatchId   String
  plannedQuantity   Decimal  @db.Decimal(10, 2)  // 计划使用数量
  actualQuantity    Decimal? @db.Decimal(10, 2)  // 实际使用数量
  createdAt         DateTime @default(now())

  productionPlan ProductionPlan @relation(...)
  materialBatch  MaterialBatch  @relation(...)

  @@unique([productionPlanId, materialBatchId])
  @@index([productionPlanId])
  @@index([materialBatchId])
}

// 生产计划表增强
model ProductionPlan {
  // ... 原有字段

  // 新增：关联使用的原材料批次
  batchUsages     ProductionPlanBatchUsage[]

  // 废弃字段（不再使用）
  // estimatedMaterialUsage
  // 改为从 batchUsages 中汇总
}
```

---

## 🎬 完整业务流程实例（修正版）

### 📅 10月1日：原材料入库（批次A）

```
管理员张经理操作:

┌──────────────────────────────┐
│ 原材料入库                   │
├──────────────────────────────┤
│ 原材料类型 *                 │
│ 鲈鱼 ✓                       │ ← MaterialTypeSelector
│                              │
│ 入库数量 (kg) *              │
│ 1000                         │
│                              │
│ 单价 (元/kg) *               │
│ 5.0                          │
│                              │
│ 总成本                       │
│ ¥5000 (自动计算)             │
│                              │
│ 供应商                       │
│ 海鲜批发商A ✓                │
│                              │
│ 入库日期                     │
│ 2025-10-01                   │
│                              │
│ 保质期                       │
│ 2025-10-08 (7天)             │
│                              │
│ [提交入库]                    │
└──────────────────────────────┘

提交后系统自动:
✅ 生成批次号: MAT-20251001-001
✅ 创建批次记录:
   - 入库数量: 1000kg
   - 剩余数量: 1000kg
   - 已使用: 0kg
   - 单价: ¥5/kg
   - 总成本: ¥5000
   - 状态: 可用
✅ 更新库存汇总:
   - 鲈鱼总库存: +1000kg
```

---

### 📅 10月3日：第二批入库（批次B）

```
又采购了一批鲈鱼，价格更便宜

┌──────────────────────────────┐
│ 原材料入库                   │
├──────────────────────────────┤
│ 原材料类型: 鲈鱼 ✓           │
│ 入库数量: 800 kg             │
│ 单价: 4.8 元/kg              │ ← 比批次A便宜
│ 总成本: ¥3840                │
│ 供应商: 海鲜批发商B ✓        │
│ 入库日期: 2025-10-03         │
│ [提交]                        │
└──────────────────────────────┘

✅ 生成批次号: MAT-20251003-002
✅ 创建批次记录
✅ 库存汇总:
   - 鲈鱼总库存: 1000kg → 1800kg

当前有2个批次:
┌──────────────────────────────┐
│ 📦 鲈鱼库存批次              │
├──────────────────────────────┤
│ 批次A: MAT-20251001-001      │
│ • 剩余: 1000kg               │
│ • 单价: ¥5/kg                │
│ • 入库: 10-01                │
│ • 保质期: 10-08 (7天后)      │
│                              │
│ 批次B: MAT-20251003-002      │
│ • 剩余: 800kg                │
│ • 单价: ¥4.8/kg              │
│ • 入库: 10-03                │
│ • 保质期: 10-10 (7天后)      │
└──────────────────────────────┘
```

---

### 📅 10月6日：创建生产计划（选择批次）⭐ 核心修正

```
管理员创建生产计划:

第1步: 基本信息
┌──────────────────────────────┐
│ 新建生产计划          [关闭] │
├──────────────────────────────┤
│ 商家 *: 王老板 ✓             │
│ 产品类型 *: 鲈鱼片 ✓         │
│ 计划产量 *: 500 kg           │
└──────────────────────────────┘

第2步: 系统自动计算
┌──────────────────────────────┐
│ 💡 自动计算                  │
├──────────────────────────────┤
│ 转换率: 50%                  │
│ 损耗率: 5%                   │
│ 预估需要: 1050 kg鲈鱼        │
└──────────────────────────────┘

第3步: 选择原材料批次 ⭐ 关键步骤
┌──────────────────────────────┐
│ 原材料批次选择 *             │
├──────────────────────────────┤
│ 需要总量: 1050 kg            │
│                              │
│ 可用批次列表:                │
│ ┌──────────────────────────┐ │
│ │ ☑ 批次A: MAT-20251001-001│ │ ← 勾选
│ │   鲈鱼 1000kg 可用       │ │
│ │   单价¥5/kg 保质期10-08  │ │
│ │   使用: [1000] kg ←输入  │ │ ← 输入使用数量
│ │                          │ │
│ │ ☑ 批次B: MAT-20251003-002│ │ ← 勾选
│ │   鲈鱼 800kg 可用        │ │
│ │   单价¥4.8/kg 保质期10-10│ │
│ │   使用: [50] kg ←输入    │ │ ← 输入使用数量
│ │                          │ │
│ │ ☐ 批次C: MAT-20251005-003│ │
│ │   带鱼 500kg 可用        │ │ ← 不同类型，不可选
│ │   (灰色，不可选)         │ │
│ └──────────────────────────┘ │
│                              │
│ 已选择总量: 1050 kg ✓        │ ← 自动汇总
│ 需要总量: 1050 kg            │
│                              │
│ 💰 成本计算:                 │
│ ┌──────────────────────────┐ │
│ │ 批次A: 1000kg×¥5 = ¥5000 │ │
│ │ 批次B: 50kg×¥4.8 = ¥240  │ │
│ │ 原材料成本: ¥5240        │ │ ← 自动精准计算
│ └──────────────────────────┘ │
│                              │
│ [取消]  [创建计划]           │
└──────────────────────────────┘

第4步: 智能批次推荐（可选功能）
┌──────────────────────────────┐
│ 💡 推荐方案:                 │
├──────────────────────────────┤
│ 方案1: 先进先出 (推荐)       │
│ ├─ 批次A: 1000kg (保质期近)  │
│ └─ 批次B: 50kg               │
│ 总成本: ¥5240                │
│                              │
│ 方案2: 成本最优              │
│ └─ 批次B: 800kg (单价低)     │
│ └─ 批次A: 250kg              │
│ 总成本: ¥5090 (省¥150)      │
│                              │
│ 方案3: 自定义                │
│ 手动选择批次和数量           │
│                              │
│ [应用推荐] [自定义选择]      │
└──────────────────────────────┘

第5步: 创建成功
✅ 生产计划 #2025051 已创建
✅ 批次预留:
   - 批次A: 1000kg → 剩余0kg
   - 批次B: 50kg → 剩余750kg
✅ 原材料成本锁定: ¥5240
```

---

## 🔧 组件设计：MaterialBatchSelector

### 组件功能

```typescript
// MaterialBatchSelector.tsx (新建组件)

interface MaterialBatchSelectorProps {
  materialTypeId: string;        // 原材料类型ID
  requiredQuantity: number;      // 需要的总数量
  onSelect: (batches: {          // 选择回调
    batchId: string;
    quantity: number;
    unitPrice: number;
  }[]) => void;
}

功能:
1. 显示该原材料类型的所有可用批次
2. 支持多选批次
3. 输入每个批次的使用数量
4. 自动计算总量和总成本
5. 验证: 选择的总量 ≥ 需要的数量
6. 智能推荐: 先进先出 / 成本最优
7. 批次详情: 保质期、供应商、质量等级
```

### 界面设计

```
┌──────────────────────────────────┐
│ 选择原材料批次            [关闭] │
├──────────────────────────────────┤
│ 原材料: 鲈鱼                     │
│ 需要总量: 1050 kg                │
│                                  │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│ 可用批次 (按入库日期排序)        │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                  │
│ ┌──────────────────────────────┐ │
│ │ ☑ 批次A: MAT-20251001-001   │ │
│ │ ┌────────────────────────────┤ │
│ │ │ 📦 基本信息                │ │
│ │ │ • 可用: 1000 kg            │ │
│ │ │ • 单价: ¥5.0/kg            │ │
│ │ │ • 供应商: 海鲜批发商A       │ │
│ │ │ • 入库: 2025-10-01         │ │
│ │ │ • 保质期: 2025-10-08       │ │
│ │ │   ⚠️ 剩余2天              │ │
│ │ │ • 质量: A级                │ │
│ │ │                            │ │
│ │ │ 使用数量 (kg):             │ │
│ │ │ ┌────────────────────────┐ │ │
│ │ │ │ 1000                   │ │ │ ← 输入
│ │ │ └────────────────────────┘ │ │
│ │ │                            │ │
│ │ │ 成本: ¥5000                │ │ ← 自动计算
│ │ └────────────────────────────┤ │
│ └──────────────────────────────┘ │
│                                  │
│ ┌──────────────────────────────┐ │
│ │ ☑ 批次B: MAT-20251003-002   │ │
│ │ ┌────────────────────────────┤ │
│ │ │ 📦 基本信息                │ │
│ │ │ • 可用: 800 kg             │ │
│ │ │ • 单价: ¥4.8/kg            │ │
│ │ │ • 供应商: 海鲜批发商B       │ │
│ │ │ • 入库: 2025-10-03         │ │
│ │ │ • 保质期: 2025-10-10       │ │
│ │ │ • 质量: A级                │ │
│ │ │                            │ │
│ │ │ 使用数量 (kg):             │ │
│ │ │ ┌────────────────────────┐ │ │
│ │ │ │ 50                     │ │ │ ← 输入
│ │ │ └────────────────────────┘ │ │
│ │ │                            │ │
│ │ │ 成本: ¥240                 │ │ ← 自动计算
│ │ └────────────────────────────┤ │
│ └──────────────────────────────┘ │
│                                  │
│ ┌──────────────────────────────┐ │
│ │ ☐ 批次C: MAT-20251005-003   │ │ ← 未勾选
│ │   鲈鱼 1200kg 可用           │ │
│ │   单价¥5.2/kg 保质期10-12   │ │
│ └──────────────────────────────┘ │
│                                  │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│ 汇总统计                         │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                  │
│ 已选择数量: 1050 kg ✓            │
│ 需要数量: 1050 kg                │
│ 状态: 满足需求 ✓                │
│                                  │
│ 原材料总成本: ¥5240              │
│ 平均单价: ¥4.99/kg               │
│                                  │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│ 智能推荐                         │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                  │
│ 💡 建议使用"先进先出"方案:      │
│ • 优先使用批次A (保质期仅剩2天)  │
│ • 可降低浪费风险                 │
│                                  │
│ ⚠️ 如选择"成本最优"方案:        │
│ • 可省成本¥150                   │
│ • 但批次A可能过期                │
│                                  │
│ [应用推荐] [确认选择] [取消]    │
└──────────────────────────────────┘
```

---

## 📊 数据流转示例

### 入库阶段
```
入库3次:
├─ 批次A: 1000kg × ¥5.0 = ¥5000  (10-01入库)
├─ 批次B: 800kg × ¥4.8 = ¥3840   (10-03入库)
└─ 批次C: 1200kg × ¥5.2 = ¥6240  (10-05入库)

总库存: 3000kg
总价值: ¥15080
```

### 计划阶段
```
计划#001: 需要1050kg鲈鱼
├─ 选择: 批次A 1000kg + 批次B 50kg
├─ 成本: ¥5000 + ¥240 = ¥5240
└─ 平均: ¥4.99/kg

系统自动:
├─ 批次A: 剩余 1000kg → 0kg (状态: 已用完)
├─ 批次B: 剩余 800kg → 750kg
└─ 总库存: 3000kg → 1950kg (实时更新)
```

### 生产阶段
```
员工每日记录产量 (不涉及批次)
只记录: 今日生产了多少kg鲈鱼片
```

### 盘点阶段
```
盘点批次B:
理论剩余: 750kg
实际测量: 720kg
差异: -30kg (浪费)
```

---

## 🎯 核心优势

### 1. 成本精准
```
不同批次单价不同:
批次A: ¥5.0/kg
批次B: ¥4.8/kg
批次C: ¥5.2/kg

使用批次A+B: ¥5240
使用批次B+C: ¥5336 (贵¥96)

精准成本核算，不是平均值！
```

### 2. 先进先出
```
批次A保质期: 10-08 (最早)
批次B保质期: 10-10
批次C保质期: 10-12 (最晚)

系统推荐: 优先用批次A
避免: 批次A过期浪费
```

### 3. 质量追溯
```
如果产品有问题:
批次#2025051 → 使用了批次A和批次B
→ 批次A: 供应商A，10-01采购
→ 批次B: 供应商B，10-03采购

可以追溯:
- 哪个供应商的原材料有问题
- 什么时间采购的
- 同批次原材料是否有其他问题
```

### 4. 库存准确
```
实时库存:
不是简单的 "总量-消耗"
而是每个批次的详细状态:

批次A: 0kg (已用完)
批次B: 750kg (部分使用)
批次C: 1200kg (未使用)

总计: 1950kg (精确到每个批次)
```

---

## 🎨 MaterialBatchSelector 组件规格

### 功能特性

1. **批次列表显示**
   - 按入库日期排序（先进先出）
   - 显示：批次号、可用量、单价、保质期、供应商
   - 保质期预警（剩余<3天标红）
   - 过滤：只显示该原材料类型的批次

2. **批次选择**
   - 多选支持（Checkbox）
   - 输入使用数量
   - 实时验证：不超过批次可用量
   - 自动汇总：总量、总成本

3. **智能推荐**
   - 方案A: 先进先出（优先保质期近的）
   - 方案B: 成本最优（优先单价低的）
   - 方案C: 自定义选择
   - 显示每种方案的成本对比

4. **验证规则**
   - 必须选择至少1个批次
   - 选择的总量必须 ≥ 需要的数量
   - 不能超过批次可用量
   - 保质期已过的批次不可选

5. **数据输出**
```typescript
onSelect([
  { batchId: 'batch-a-id', quantity: 1000, unitPrice: 5.0 },
  { batchId: 'batch-b-id', quantity: 50, unitPrice: 4.8 }
])
```

---

## 📋 实施步骤

### Step 1: 数据库迁移
```bash
# 添加 MaterialBatch 和 ProductionPlanBatchUsage 表
cd backend
npx prisma migrate dev --name add_material_batch_management
```

### Step 2: 后端API
```javascript
// 新增API端点
GET  /api/mobile/materials/batches?materialTypeId=xxx
POST /api/mobile/materials/batches (入库创建批次)
GET  /api/mobile/materials/batches/:id
PUT  /api/mobile/materials/batches/:id/reserve (预留)
PUT  /api/mobile/materials/batches/:id/consume (消耗)
GET  /api/mobile/materials/batches/recommendations (智能推荐)
```

### Step 3: 前端组件
```typescript
// 创建新组件
src/components/processing/MaterialBatchSelector.tsx

// 增强生产计划创建界面
src/screens/management/ProductionPlanManagementScreen.tsx
```

### Step 4: 业务逻辑
```javascript
// 创建计划时
1. 查询可用批次
2. 用户选择批次和数量
3. 验证总量
4. 计算总成本
5. 创建计划
6. 预留批次数量
7. 更新批次剩余量
```

---

## 🎬 完整流程示例（最终版）

### 场景: 王老板订单从入库到完成

```
10-01: 入库批次A (1000kg ¥5/kg)
       ✅ MAT-20251001-001

10-03: 入库批次B (800kg ¥4.8/kg)
       ✅ MAT-20251003-002

10-06: 创建计划 (500kg鲈鱼片)
       ├─ 系统计算: 需要1050kg鲈鱼
       ├─ 选择批次:
       │  ├─ 批次A: 1000kg
       │  └─ 批次B: 50kg
       ├─ 成本: ¥5240
       └─ ✅ 计划创建成功

10-07: 员工记录 100kg
10-08: 员工记录 120kg
10-09: 员工记录 110kg
10-10: 员工记录 105kg
10-11: 员工记录 50kg
       ✅ 累计485kg (97%)

10-11: 库存盘点
       ├─ 批次A: 理论0kg, 实际0kg ✓
       ├─ 批次B: 理论750kg, 实际720kg
       ├─ 差异: -30kg (浪费4%)
       └─ 填写缺料报告

10-12: AI分析
       ├─ 成本结构分析
       ├─ 效率趋势分析
       ├─ 浪费原因分析
       └─ 优化建议
```

---

## 💡 关键修正总结

### ❌ 之前的理解
```
创建计划时: 选择"原材料类型"
系统自动: 从总库存扣减
问题: 无法追溯成本，无法先进先出
```

### ✅ 正确的理解
```
创建计划时: 选择"原材料批次"
系统处理: 从指定批次扣减
优势:
  1. 成本精准（不同批次单价不同）
  2. 先进先出（管理保质期）
  3. 质量追溯（追溯到供应商）
  4. 库存精确（批次级别管理）
```

---

## 🚀 下一步行动

### 立即要做的
1. **设计 MaterialBatchSelector 组件**
2. **修改数据库 schema**（添加 MaterialBatch 表）
3. **实现批次管理API**
4. **更新生产计划创建流程**

### 预计工作量
- 数据库设计: 2小时
- 后端API: 1天
- MaterialBatchSelector组件: 1天
- 生产计划界面集成: 0.5天
- 测试: 0.5天
- **总计: 3天**

---

**这次理解对了吗？需要我开始实现 MaterialBatchSelector 组件和相关功能吗？** 🎯
