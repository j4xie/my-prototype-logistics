# 硬件集成架构设计方案 (最终版)

## 用户需求总结

| 功能场景 | 硬件设备 | 核心目标 |
|---------|---------|---------|
| 智能称重+自动入库 | 电子秤+摄像头 | 产品称重质检、**软件端计数**、自动入库 |
| 工人效率识别 | 摄像头 | 身份识别、工位关联、效率计算 |
| 姿势分析 | 摄像头+Qwen VL | 人工姿势识别、效率分析 |
| OCR标签质检 | 摄像头 | 标签检查、报警、追踪处理 |

**规模**: 50+台设备 | **部署**: 私有云/混合部署 | **AI**: Qwen VL

### 特殊要求
- **食品加工厂**: IP67/68防水、304不锈钢、耐腐蚀
- **秤规格**: 小型(30-150kg)、中型(300-500kg)、大型(1T)
- **无线传输**: 需要WiFi无线传输提高车间灵活性
- **计数功能**: 软件端实现 (查询产品单重自动计算)

---

## 硬件选型方案 (最终确定)

### 一、摄像头：海康威视 ✅

| 项目 | 内容 |
|------|------|
| **品牌** | 海康威视 Hikvision |
| **开放平台** | https://open.hikvision.com/ |
| **Java SDK** | `artemis-http-client-1.1.13.RELEASE` |
| **支持功能** | 视频取流(RTSP/RTMP/HLS)、人脸识别、行为分析 |
| **部署要求** | iSecure Center 综合安防管理平台 |

### 二、电子秤选品矩阵 ✅

---

#### 2.1 微型桌面秤 (1-30kg) 选品对比

| 品牌/型号 | 开放接口 | 云平台 | 内置无线 | 需WiFi模块 | 开发复杂度 | 单价 | 推荐 |
|----------|---------|--------|----------|-----------|-----------|------|------|
| **矽策 XC709S** | ✅ 有API | ✅ 有 | ✅ 双WiFi | ❌ 不需要 | ⭐⭐ 低 | ¥1,500+ | 🌟 首选 |
| **顶尖 CL5000J** | ⚠️ 非官方 | ❌ 无 | ❌ 无 | ✅ 需要 | ⭐⭐⭐ 中 | ¥800-1,000 | 备选 |
| **大华 TMA系列** | ✅ 有SDK | ✅ 大华云 | ⚠️ 部分有 | ⚠️ 视型号 | ⭐⭐ 低 | ¥600-900 | 备选 |
| **安衡 RS232款** | ⚠️ 标准协议 | ❌ 无 | ❌ 无 | ✅ 需要 | ⭐⭐⭐⭐ 高 | ¥400-500 | 预算优先 |

**微型桌面秤推荐方案**:

| 方案 | 品牌 | 优势 | 劣势 | 总成本(20台) |
|------|------|------|------|-------------|
| **A. 云平台集成** | 矽策 XC709S | 内置WiFi+云平台+开放API，开发最简单 | 价格较高 | ¥30,000+ |
| **B. 成熟生态** | 大华 TMA-07 | 有云平台和SDK，社区资源丰富 | 部分型号需加装WiFi | ¥15,000-20,000 |
| **C. 最低成本** | 安衡+WiFi模块 | 价格最低 | 无开放平台，需自研协议 | ¥8,000+¥4,400 |

---

#### 2.2 小型台秤 (30-150kg) 选品对比

> ⚠️ **重要说明**: 柯力是传感器/显示仪表厂商，D2008是称重显示仪表（非成品秤）。以下选品均为**成品电子秤**（秤台+传感器+显示器一体化）。

| 品牌/型号 | 开放接口 | 云平台 | 内置无线 | 需WiFi模块 | 开发复杂度 | 单价 |
|----------|---------|--------|----------|-----------|-----------|------|
| **友声 TCS系列** | ✅ RS232串口 | ❌ 无 | ❌ 无 | ✅ 需要 | ⭐⭐ 低 | ¥300-800 |
| **安衡 ERP电子秤** | ✅ RS232+USB | ❌ 无 | ❌ 无 | ✅ 需要 | ⭐⭐ 低 | ¥300-600 |
| **英展 SB731系列** | ⚠️ RS232可选 | ❌ 无 | ❌ 无 | ✅ 需要 | ⭐⭐⭐ 中 | ¥400-900 |
| **亚津 DS12P物联网** | ✅ 衡管家API | ✅ 有 | ✅ GPRS/WiFi | ❌ 不需要 | ⭐⭐ 低 | ¥3,000+ |
| **巨天 JDT-WN-Q20S** | ✅ 可定制API | ✅ 4G物联网 | ✅ WiFi+4G | ❌ 不需要 | ⭐⭐ 低 | ¥2,500+ |
| **托利多 IND570** | ✅ InTouch | ✅ 远程监控 | ✅ WiFi/蓝牙 | ❌ 不需要 | ⭐⭐ 低 | ¥8,000+ |

**小型台秤推荐**:
- 🌟 **性价比首选**: 友声 TCS系列 (60/100/150/300kg可选，不锈钢台面，RS232串口，加装WiFi模块)
- 🌟 **物联网首选**: 亚津 DS12P (内置GPRS+衡管家云平台，开箱即用)
- 🌟 **高端首选**: 巨天 JDT-WN-Q20S (WiFi+4G双模，7寸触摸屏，可定制ERP对接)

---

#### 2.3 中大型磅秤 (300kg-3T) 选品对比

> ⚠️ **重要说明**: 柯力是传感器/显示仪表厂商，D2008-SS是称重显示仪表（非成品秤）。以下选品均为**成品地磅**（秤台+传感器+仪表一体化）。

| 用途 | 品牌/型号 | 开放接口 | 云平台 | 内置无线 | 需WiFi模块 | 单价 |
|------|----------|---------|--------|----------|-----------|------|
| **中型磅秤 (1吨)** | 上海耀华 A12E 1×1米 | ✅ RS232 | ❌ 无 | ❌ 无 | ✅ 需要 | ¥1,300-1,600 |
| **大型地磅 (2吨)** | 上海耀华 A12E 1.2×1.2米 | ✅ RS232 | ❌ 无 | ❌ 无 | ✅ 需要 | ¥1,600-2,750 |
| **大型地磅 (3吨)** | 上海耀华 A12E 1.2×1.5米 | ✅ RS232 | ❌ 无 | ❌ 无 | ✅ 需要 | ¥1,850-2,200 |
| **物联网地磅** | 亚津物联网地磅 | ✅ 衡管家API | ✅ 有 | ✅ GPRS | ❌ 不需要 | ¥5,000-15,000 |
| **无人值守地磅** | 捷俊通/磅师傅 | ✅ 完整SDK | ✅ 有 | ✅ 4G/WiFi | ❌ 不需要 | ¥50,000+ |

**耀华地磅特点**: 配柯力传感器4只、上海耀华XK3190-A12E仪表，成品整机，即插即用，无需专业安装

**中大型磅秤物联网方案分析**:

| 方案 | 优势 | 劣势 | 适用场景 |
|------|------|------|---------|
| **上海耀华成品地磅** | 价格实惠、成熟稳定、RS232接口 | 需加装WiFi模块 | 性价比首选 |
| **亚津物联网地磅+衡管家** | 有成熟云平台+APP | 价格较高，API需确认 | 标准物联网需求 |
| **传统秤+WiFi模块** | 成本最低，灵活性高 | 需自研协议和平台 | 预算有限 |
| **捷俊通/磅师傅无人值守** | 完整解决方案，含软硬件 | 价格最高 | 汽车衡、物流园区 |

**重要结论**: 中大型工业秤推荐两种路线:
1. **性价比路线**: 上海耀华成品地磅 + WiFi模块 (¥1,500-2,200 + ¥220)
2. **物联网路线**: 亚津物联网地磅 (¥5,000-15,000，含衡管家云平台)

---

#### 2.4 三种采购方案对比分析 ⭐

基于**价格**和**开发复杂度**两个维度，对比三种采购策略：

---

##### 方案A: 纯内置WiFi物联网秤方案

**策略**: 全部选择内置WiFi+云平台的物联网秤，依赖厂商API

| 秤类型 | 选品 | 单价 | 数量 | 小计 | 对接方式 |
|--------|------|------|------|------|---------|
| 微型桌面秤 | 矽策 XC709S | ¥1,500 | 20 | ¥30,000 | HTTP API |
| 小型台秤 | 亚津 DS12P物联网 | ¥3,000 | 20 | ¥60,000 | 衡管家API |
| 中型磅秤 | 柯力物联网整体方案 | ¥8,000 | 10 | ¥80,000 | 柯力云API |
| 大型地磅 | 亚津物联网地磅 | ¥12,000 | 5 | ¥60,000 | 衡管家API |
| **秤小计** | | | 55台 | **¥230,000** | |
| WiFi模块 | 不需要 | ¥0 | 0 | **¥0** | |
| **硬件总成本** | | | | **¥230,000** | |

**开发复杂度分析**:
| 工作项 | 工时 | 说明 |
|--------|------|------|
| 矽策API对接 | 2天 | HTTP/JSON，文档完善 |
| 亚津衡管家API对接 | 3天 | 需申请开发者权限 |
| 柯力云API对接 | 3天 | 需整体方案采购 |
| 数据聚合层开发 | 2天 | 统一多平台数据格式 |
| **开发工时合计** | **10天** | |

**优点**:
- ✅ 开箱即用，硬件调试简单
- ✅ 厂商提供技术支持
- ✅ 无需处理底层串口协议

**缺点**:
- ❌ 硬件成本最高 (+¥99,400 vs 方案B)
- ❌ 数据分散在3个第三方平台
- ❌ 依赖厂商API稳定性
- ❌ 部分厂商API开放程度需确认
- ❌ 可能有API调用限制或收费

---

##### 方案B: 纯外接WiFi模块方案 (修正版)

**策略**: 全部选择传统成品秤 + 串口转WiFi模块，自研协议解析

| 秤类型 | 选品 | 单价 | 数量 | 小计 | 对接方式 |
|--------|------|------|------|------|---------|
| 微型桌面秤 | 大华 ACS-30Ab | ¥300 | 20 | ¥6,000 | RS232串口 |
| 小型台秤 | 友声 TCS-150kg | ¥600 | 20 | ¥12,000 | RS232串口 |
| 中型磅秤 | 耀华 A12E 1吨 | ¥1,500 | 10 | ¥15,000 | RS232串口 |
| 大型地磅 | 耀华 A12E 3吨 | ¥2,200 | 5 | ¥11,000 | RS232串口 |
| **秤小计** | | | 55台 | **¥44,000** | |
| WiFi模块 | 微雪RS232-TO-WIFI | ¥220 | 55 | **¥12,100** | MQTT |
| **硬件总成本** | | | | **¥56,100** | |

**开发复杂度分析**:
| 工作项 | 工时 | 说明 |
|--------|------|------|
| 大华ACS串口协议 | 2天 | 标准ASCII协议 |
| 友声TCS协议解析 | 2天 | 通用耀华协议 |
| 耀华A12E协议解析 | 2天 | 官方文档，ASCII定长帧 |
| WiFi模块MQTT配置 | 1天 | 微雪模块配置工具 |
| 边缘网关串口采集 | 2天 | jSerialComm库 |
| MQTT上报统一 | 1天 | 统一数据格式 |
| **开发工时合计** | **10天** | |

**优点**:
- ✅ **硬件成本最低** (比原方案节省¥88,500，仅需¥44,000)
- ✅ 数据完全自主，无第三方依赖
- ✅ 耀华协议文档完善，通用性强
- ✅ 无API调用限制或费用
- ✅ 国内成熟品牌，售后有保障

**缺点**:
- ❌ 需要自研串口协议解析
- ❌ WiFi模块安装调试工作量大
- ❌ 需要处理串口稳定性问题

---

##### 方案C: 混合方案 (⭐ 推荐)

**策略**: 微型秤选内置WiFi物联网秤 (开发简单)，其他秤选传统成品秤+模块 (成本低)

| 秤类型 | 选品 | 单价 | 数量 | 小计 | 对接方式 |
|--------|------|------|------|------|---------|
| 微型桌面秤 | 矽策 XC709S (WiFi) | ¥1,500 | 20 | ¥30,000 | HTTP API ✅ |
| 小型台秤 | 友声 TCS-150kg + 模块 | ¥820 | 20 | ¥16,400 | RS232+MQTT |
| 中型磅秤 | 耀华 A12E 1吨 + 模块 | ¥1,720 | 10 | ¥17,200 | RS232+MQTT |
| 大型地磅 | 耀华 A12E 3吨 + 模块 | ¥2,420 | 5 | ¥12,100 | RS232+MQTT |
| **硬件总成本** | | | 55台 | **¥75,700** | |

**开发复杂度分析**:
| 工作项 | 工时 | 说明 |
|--------|------|------|
| 矽策API对接 | 2天 | HTTP/JSON，文档完善 |
| 友声/耀华协议解析 | 2天 | 通用ASCII定长帧协议 |
| WiFi模块MQTT配置 | 0.5天 | 仅35台需要 |
| 边缘网关串口采集 | 2天 | jSerialComm库 |
| MQTT上报统一 | 1天 | 两种数据源合并 |
| **开发工时合计** | **7.5天** | |

**优点**:
- ✅ **硬件成本大幅降低** (仅需¥75,700，比原方案节省¥64,500)
- ✅ 开发复杂度最低 (比方案A/B都少)
- ✅ 微型秤用API简单，大秤用串口成本低
- ✅ 友声/耀华协议文档完善，开发有保障
- ✅ 只需维护1个第三方API (矽策)

**缺点**:
- ⚠️ 需维护两种对接方式 (API + 串口)
- ⚠️ 矽策API仍有第三方依赖

---

##### 三方案对比矩阵 (修正后)

| 维度 | 方案A (纯物联网) | 方案B (纯外接模块) ⭐ | 方案C (混合) |
|------|-----------------|-------------------|----------------|
| **硬件成本** | ¥230,000 | **¥56,100** | ¥75,700 |
| **vs原方案节省** | -¥0 | **-¥88,500** | -¥64,500 |
| **开发工时** | 10天 | 10天 | 7.5天 |
| **开发复杂度** | ⭐⭐⭐ 中 | ⭐⭐ 低 | ⭐⭐ 低 |
| **数据自主性** | ❌ 分散在3平台 | ✅ 完全自主 | ⚠️ 1平台+自主 |
| **第三方依赖** | 3个厂商API | 0个 | 1个 (矽策) |
| **硬件调试** | ✅ 简单 | ⚠️ 需配置模块 | ⚠️ 中等 |
| **协议文档** | API文档 | 官方PDF完善 | 官方PDF+API |

> 💡 **重大变化**: 修正柯力D2008（仪表）为实际成品秤后，方案B成本大幅降低，成为**性价比最优方案**。

##### 综合评分 (5分制)

| 维度 | 权重 | 方案A | 方案B | 方案C |
|------|------|-------|-------|-------|
| 硬件成本 | 30% | 2分 | 5分 | 4分 |
| 开发效率 | 25% | 3分 | 2分 | 5分 |
| 数据自主 | 20% | 2分 | 5分 | 4分 |
| 长期维护 | 15% | 2分 | 4分 | 4分 |
| 风险可控 | 10% | 3分 | 3分 | 4分 |
| **加权总分** | 100% | **2.35分** | **3.85分** | **4.25分** |

##### 推荐结论

**✅ 推荐方案B (纯传统秤+WiFi模块)**

理由:
1. **成本最低** - 硬件总计仅¥56,100，比方案A节省¥174,400
2. **品牌可靠** - 大华、友声、耀华均为国内知名成品秤品牌
3. **协议通用** - 均采用标准RS232 ASCII协议，一套代码兼容
4. **维护自主** - 不依赖第三方云平台，数据完全自主
5. **扩展灵活** - 可随时更换秤品牌，不受厂商绑定

**若追求开箱即用**: 选择方案A或购买内置WiFi物联网秤（见附录章节）
**若要部分免适配**: 选择方案C，微型秤用矽策物联网版本

---

#### 2.5 最终选品清单

> ⚠️ **重要说明**: 以下选品均为**成品电子秤**（秤台+传感器+显示器一体化），非单独的显示仪表。

| 用途 | 品牌/型号 | 量程 | 内置无线 | 需WiFi模块 | 单价 | 数量 | 小计 |
|------|----------|------|----------|-----------|------|------|------|
| **微型桌面秤** | 大华 ACS-30Ab | 15/30kg | ❌ 否 | ✅ 是 | ¥300 | 20台 | ¥6,000 |
| **小型台秤** | 友声 TCS-150kg | 30-150kg | ❌ 否 | ✅ 是 | ¥600 | 20台 | ¥12,000 |
| **中型磅秤** | 耀华 A12E 1吨 (1×1米) | 1000kg | ❌ 否 | ✅ 是 | ¥1,500 | 10台 | ¥15,000 |
| **大型地磅** | 耀华 A12E 3吨 (1.2×1.5米) | 3000kg | ❌ 否 | ✅ 是 | ¥2,200 | 5台 | ¥11,000 |
| **秤小计** | | | | | | **55台** | **¥44,000** |

**WiFi模块需求**: 全部秤需要 = 55台 × ¥220 = ¥12,100

---

#### 2.6 开发复杂度对比

| 秤类型 | 开放程度 | 开发方式 | 复杂度 | 预估工时 |
|--------|---------|---------|--------|---------|
| **大华 ACS系列** | ✅ 官方文档 | 解析ASCII协议 | ⭐⭐ 低 | 2-3天 |
| **友声 TCS系列** | ✅ 官方文档 | 解析ASCII协议 | ⭐⭐ 低 | 2-3天 |
| **耀华 A12E** | ✅ 官方文档 | 解析ASCII协议 | ⭐⭐ 低 | 3-5天 |
| **矽策 XC709S** | ✅ 有API文档 | 调用厂商API | ⭐⭐ 低 | 2-3天 |

---

#### 2.7 协议对接 (一套代码通用)

| 项目 | 大华 ACS | 友声 TCS | 耀华 A12E |
|------|----------|----------|-----------|
| **协议** | RS232 ASCII | RS232 ASCII | RS232 ASCII |
| **波特率** | 9600 | 9600 | 9600 |
| **数据帧** | 12字节 | 12字节 | 12字节 |
| **数据格式** | `+001240 kg S\r\n` | `+001240 kg S\r\n` | `+001240 kg S\r\n` |
| **文档** | 售后提供 | 售后提供 | [耀华官网](http://www.yhchs.com/) |

> 💡 **统一协议优势**: 以上品牌均采用标准ASCII称重协议，一套解析代码可兼容所有秤

**微型桌面秤应用场景**：
- 小型海鲜（虾仁、鱼片、贝类）
- 调料包、小包装产品
- 原料抽样质检
- 精确配料称重

### 三、无线传输模块 ✅

**方案**: 给**无内置WiFi的电子秤**加装"串口转WiFi模块"

| 模块 | 品牌/型号 | 接口 | 协议 | 单价 | 数量 | 小计 |
|------|----------|------|------|------|------|------|
| **串口转WiFi** | 微雪 RS232-TO-WIFI-ETH-B | RS232→WiFi | MQTT/Modbus | ¥220 | 35个 | ¥7,700 |

**需要WiFi模块的秤**:
- 小型台秤 (柯力 D2008): 20台 ✅
- 中型磅秤 (柯力 D2008-SS): 10台 ✅
- 大型地磅 (亚津 SCS-HT): 5台 ✅
- **合计**: 35台

**不需要WiFi模块的秤**:
- 微型桌面秤 (矽策 XC709S): 20台 ❌ (已内置双WiFi)

**模块特点**:
- 工业级金属外壳，支持壁挂/导轨安装
- 支持MQTT/Modbus协议，与边缘网关无缝对接
- 6~36V宽电压供电，适合工厂环境

### 三-B、网络传输方案设计 ⭐ (重要)

#### 传输方式对比分析

| 维度 | WiFi | 有线以太网 | 4G/5G |
|------|------|-----------|-------|
| **单点成本** | ¥220 (WiFi模块) | ¥50-100 (网卡) + 布线成本 | ¥150-300 (模块) + ¥30-50/月流量 |
| **安装难度** | ⭐⭐ 低 | ⭐⭐⭐⭐ 高 (需布线) | ⭐⭐ 低 |
| **灵活性** | ✅ 高 (设备可移动) | ❌ 低 (固定位置) | ✅ 最高 |
| **带宽** | 100-300Mbps | 100-1000Mbps | 10-100Mbps |
| **延迟** | 5-20ms | 1-5ms | 20-100ms |
| **稳定性 (理想)** | ⭐⭐⭐ 中 | ⭐⭐⭐⭐⭐ 最高 | ⭐⭐⭐ 中 |
| **抗干扰** | ⚠️ 易受干扰 | ✅ 不受干扰 | ⚠️ 信号覆盖问题 |
| **长期成本** | 低 (无月费) | 低 | 高 (月费累积) |

#### 工厂WiFi不稳定的主要原因

1. **信号干扰**: 金属设备、冷库、电机等干扰2.4GHz信号
2. **覆盖死角**: AP数量不足，车间角落信号弱
3. **设备密集**: 多设备竞争带宽
4. **网络规划不当**: 家用级路由器用于工业环境

#### 推荐方案：工业级WiFi + 本地缓冲 + 自动重连

**核心设计原则**: 网络可以断，数据不能丢

```
┌─────────────────────────────────────────────────────────────────────┐
│                    工业级WiFi网络设计                                 │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                 工厂车间网络拓扑                               │    │
│  │                                                              │    │
│  │   [工业AP-1]        [工业AP-2]        [工业AP-3]             │    │
│  │       │                 │                 │                  │    │
│  │   ┌───┴───┐         ┌───┴───┐         ┌───┴───┐             │    │
│  │   │秤1-10 │         │秤11-20│         │秤21-30│             │    │
│  │   │       │         │       │         │       │             │    │
│  │   │ 信号  │         │ 信号  │         │ 信号  │             │    │
│  │   │ 漫游  │ ──────→ │ 漫游  │ ──────→ │ 漫游  │             │    │
│  │   └───────┘         └───────┘         └───────┘             │    │
│  │                                                              │    │
│  └────────────────────────┬─────────────────────────────────────┘    │
│                           │ 有线骨干                                  │
│                           v                                          │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │              边缘网关 (工业PC)                                 │    │
│  │  • 本地数据缓冲 (断网时存储)                                   │    │
│  │  • 自动重连机制 (指数退避)                                     │    │
│  │  • 数据压缩 + 批量上传                                        │    │
│  └────────────────────────┬─────────────────────────────────────┘    │
│                           │ 有线/专线                                 │
│                           v                                          │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                    云端服务器                                  │    │
│  └─────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
```

#### 工业级AP选型 (非家用路由器)

| 品牌 | 型号 | 特点 | 单价 | 推荐 |
|------|------|------|------|------|
| **TP-Link企业** | TL-AP1907GI-PoE | 双频1900M，吸顶式，PoE供电 | ¥600 | 🌟 性价比 |
| **华为** | AirEngine 5760-10 | 工业级，-40~70℃，IP67 | ¥2,500 | 极端环境 |
| **锐捷** | RG-AP730-L | 企业级，支持无线漫游 | ¥1,200 | 稳定性 |

#### WiFi覆盖规划原则

```
WiFi覆盖设计:
├── 每个AP覆盖半径: 15-20米 (室内)
├── AP部署密度: 每300-500㎡ 1个AP
├── 信道规划: 2.4GHz (1/6/11)、5GHz (36/44/52/60)
├── 避免同频干扰: 相邻AP使用不同信道
├── 信号强度要求: ≥-65dBm (保证稳定连接)
└── 5GHz优先: 减少2.4GHz干扰
```

#### 关键稳定性设计

| 设计点 | 实现方式 | 解决的问题 |
|--------|---------|-----------|
| **本地缓冲** | 边缘网关存储断网数据 | 网络断开不丢数据 |
| **指数退避重连** | 1s→2s→4s→8s→...→60s | 避免重连风暴 |
| **5GHz优先** | 工业AP配置5GHz优先 | 减少2.4GHz干扰 |
| **信道规划** | 相邻AP使用不同信道 | 避免同频干扰 |
| **边缘网关冗余** | 2台热备 | 单点故障不影响采集 |
| **数据压缩** | JSON→Protobuf | 减少带宽占用 |
| **批量上传** | 每5秒聚合一次 | 减少网络请求 |

#### 边缘网关本地缓冲代码设计

```java
// 边缘网关: 断网不丢数据
public class LocalBufferManager {
    private static final int MAX_BUFFER_SIZE = 10000;  // 最多缓存1万条
    private Queue<WeighingData> localBuffer = new LinkedBlockingQueue<>();

    // 数据采集 -> 先存本地
    public void onDataReceived(WeighingData data) {
        localBuffer.offer(data);
        tryUpload();
    }

    // 尝试上传，失败则等待重试
    private void tryUpload() {
        if (networkAvailable()) {
            while (!localBuffer.isEmpty()) {
                WeighingData data = localBuffer.poll();
                try {
                    mqttClient.publish(data);
                } catch (Exception e) {
                    localBuffer.offer(data);  // 失败放回队列
                    scheduleRetry();          // 指数退避重试
                    break;
                }
            }
        }
    }

    // 指数退避重连策略
    private int retryCount = 0;
    private static final int[] DELAYS = {1, 2, 4, 8, 16, 30, 60};  // 秒

    private void scheduleRetry() {
        int index = Math.min(retryCount++, DELAYS.length - 1);
        int delayMs = DELAYS[index] * 1000;
        scheduler.schedule(this::tryUpload, delayMs, TimeUnit.MILLISECONDS);
    }
}
```

#### 网络成本对比 (55台设备，3年)

| 方案 | 设备成本 | 安装成本 | 月费 | 3年总成本 |
|------|---------|---------|------|----------|
| **方案A: 纯WiFi** | ¥12,100 (模块) + ¥6,000 (AP×10) | ¥3,000 | ¥0 | **¥21,100** |
| **方案B: 有线以太网** | ¥5,500 (网卡) | ¥30,000 (布线) | ¥0 | **¥35,500** |
| **方案C: 纯4G** | ¥16,500 (模块) | ¥2,000 | ¥1,650/月 | **¥77,900** |
| **方案D: WiFi + 4G备份** | ¥28,600 | ¥3,000 | ¥500/月 (少量4G) | **¥49,600** |

#### 推荐网络方案：WiFi为主 + 边缘缓冲 + 有线骨干

| 组件 | 选型 | 数量 | 单价 | 小计 |
|------|------|------|------|------|
| 工业级AP | TP-Link TL-AP1907GI | 10个 | ¥600 | ¥6,000 |
| 千兆交换机 | TP-Link TL-SG1024DT | 2个 | ¥500 | ¥1,000 |
| WiFi模块 | 微雪 RS232-TO-WIFI | 35个 | ¥220 | ¥7,700 |
| **网络设备总计** | | | | **¥14,700** |

**为什么不用4G**:
1. 55台设备 × ¥30/月 = ¥1,650/月，3年 = ¥59,400
2. 4G延迟高 (20-100ms)，不适合实时监控
3. 信号覆盖在工厂内部可能不如WiFi

**为什么不用有线**:
1. 布线成本高 (估计¥30,000+)
2. 设备位置固定，灵活性差
3. 食品厂潮湿环境，有线维护麻烦

### 四、硬件成本汇总 (已更新)

> ⚠️ **已修正**: 原方案误选柯力仪表（非成品秤），现已更换为大华、友声、耀华成品秤

| 类别 | 明细 | 金额 |
|------|------|------|
| 电子秤 (55台) | 大华20+友声20+耀华15 | ¥44,000 |
| 串口WiFi模块 (55个) | 微雪 RS232-TO-WIFI | ¥12,100 |
| **工业级AP (10个)** | TP-Link TL-AP1907GI | **¥6,000** |
| **千兆交换机 (2个)** | TP-Link TL-SG1024DT | **¥1,000** |
| 海康摄像头 (预估20台) | 含安装调试 | ¥40,000 |
| 边缘网关工控机 (2台) | 工业PC热备 | ¥6,000 |
| 网络布线/配件 | 网线、机柜等 | ¥3,000 |
| **硬件总计** | | **¥112,100** |

> 💰 **成本节省**: 较原方案节省 ¥84,100 (原¥196,200 → 新¥112,100)

### 五、秤类型与用途对照

| 秤类型 | 量程 | 典型用途 |
|--------|------|---------|
| **微型桌面秤** | 1-30kg | 虾仁、鱼片、调料包、小包装、配料 |
| **小型台秤** | 30-150kg | 整条鱼、肉块、中等海鲜筐 |
| **中型磅秤** | 300-500kg | 大箱产品、半成品筐 |
| **大型地磅** | 1T | 原料托盘、成品托盘、整车称重 |

---

## 开发可行性验证 ✅

### 可以先开发再买硬件

| 阶段 | 工具 | 说明 |
|------|------|------|
| **1. 虚拟串口开发** | VSPD + 串口调试助手 | 模拟电子秤数据，完成全部开发 |
| **2. 样机验证** | 购买1台小型秤 (¥1,500) | 验证协议解析正确性 |
| **3. 批量部署** | 批量采购 | 验证通过后再批量购买 |

### 协议格式 (开发参考)

```
耀华/柯力通用数据帧 (ASCII):
+001240 kg S\r\n
│ │      │  └─ S=稳定, U=不稳定
│ │      └──── 单位
│ └─────────── 重量值 (6位ASCII)
└───────────── 符号 (+/-)

Java解析示例:
public WeighingData parse(byte[] raw) {
    String data = new String(raw, StandardCharsets.US_ASCII);
    char sign = data.charAt(0);
    String weightStr = data.substring(1, 7).trim();
    boolean stable = data.contains("S");
    BigDecimal weight = new BigDecimal(weightStr);
    if (sign == '-') weight = weight.negate();
    return new WeighingData(weight, "kg", stable);
}
```

---

## 架构选择

### 推荐方案: 混合微服务架构

**理由**:
1. 50+设备规模需要独立数据采集层处理高并发
2. AI视觉分析计算密集，需独立部署
3. 边缘网关支持私有云/混合部署灵活性
4. 与现有Spring Boot系统紧密集成

```
┌─────────────────────────────────────────────────────────────┐
│                    工厂内网/边缘层                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 海康摄像头    │  │ 凯丰电子秤   │  │ 其他IoT设备  │      │
│  │ (RTSP/SDK)   │  │ (RS232)      │  │ (MQTT)       │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
│         └────────────┬────────────────────────┘             │
│                      v                                      │
│  ┌───────────────────────────────────────────────────────┐ │
│  │               边缘网关服务 (新建)                       │ │
│  │  • 海康SDK适配器  • 串口采集器  • 本地缓冲队列         │ │
│  └────────────────────────┬──────────────────────────────┘ │
└───────────────────────────┼─────────────────────────────────┘
                            │ MQTT/HTTP
                            v
┌───────────────────────────────────────────────────────────────┐
│                      云端/数据中心                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │            Redis Stream 消息队列                         │ │
│  └─────────────────────────────────────────────────────────┘ │
│         │                    │                    │          │
│         v                    v                    v          │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐   │
│  │ 数据采集服务  │    │ AI视觉服务   │    │ 现有后端     │   │
│  │ (新建)       │    │ (新建)       │    │ (扩展)       │   │
│  │              │    │              │    │              │   │
│  │ • 称重处理   │    │ • Qwen VL   │    │ • 业务协调   │   │
│  │ • 入库记录   │    │ • 工人识别  │    │ • API网关    │   │
│  │ • 数据聚合   │    │ • 姿势分析  │    │ • WebSocket  │   │
│  │              │    │ • OCR标签   │    │              │   │
│  └──────────────┘    └──────────────┘    └──────────────┘   │
│                              │                               │
│                              v                               │
│  ┌─────────────────────────────────────────────────────────┐│
│  │                    MySQL + Redis                        ││
│  └─────────────────────────────────────────────────────────┘│
└───────────────────────────────────────────────────────────────┘
```

---

## 实施内容

### 1. 新增数据库表 (6张)

| 表名 | 用途 | 关键字段 |
|------|------|---------|
| `hardware_device_config` | 硬件设备配置 | equipment_id, protocol_type, connection_config |
| `weighing_records` | 称重数据 | weight, quality_result, operator_id, batch_id |
| `worker_identification_records` | 工人识别 | camera_id, user_id, confidence, method |
| `posture_analysis_records` | 姿势分析 | activity_score, efficiency_indicator, safety_alert |
| `label_inspection_records` | 标签质检 | inspection_result, ocr_text, clarity_score |
| `edge_gateways` | 边缘网关 | gateway_name, status, capabilities |

### 2. 新增API端点 (25+个)

```
# 硬件设备管理
POST/GET/PUT/DELETE /api/mobile/{factoryId}/hardware-devices

# 称重数据
POST   /api/mobile/{factoryId}/weighing/records          # 接收称重
GET    /api/mobile/{factoryId}/weighing/statistics       # 统计
POST   /api/mobile/{factoryId}/weighing/batch-inbound    # 批量入库

# 工人识别
POST   /api/mobile/{factoryId}/worker-identification     # 接收识别
POST   /api/mobile/{factoryId}/worker-identification/{id}/correct

# 姿势分析
POST   /api/mobile/{factoryId}/posture-analysis          # 接收分析
GET    /api/mobile/{factoryId}/posture-analysis/efficiency

# 标签质检
POST   /api/mobile/{factoryId}/label-inspection          # 接收质检
PUT    /api/mobile/{factoryId}/label-inspection/{id}/handle

# 边缘网关
POST   /api/mobile/{factoryId}/edge-gateways/{id}/heartbeat
```

### 3. 扩展现有实体

| 实体 | 新增字段 | 用途 |
|------|---------|------|
| FactoryEquipment | category, has_hardware_config | 区分IoT设备类型 |
| QualityInspection | inspection_source, weighing_record_id | 自动质检来源 |
| TimeClockRecord | clock_method, identification_record_id | AI识别打卡 |
| MaterialBatch | inbound_source, weighing_record_ids | 自动入库来源 |

### 4. 新建独立服务

#### 边缘网关服务 (edge-gateway)
- 技术: Java 11 + jSerialComm + artemis-http-client
- 职责: 设备采集、协议转换、本地缓冲、数据上传
- 部署: 工厂内网工业PC

#### AI视觉服务 (vision-ai-service)
- 技术: Python + FastAPI + Qwen VL
- 职责: 工人识别、姿势分析、OCR质检、产品计数
- 部署: 云端GPU实例或本地GPU服务器

---

## 关键文件

### 需扩展的现有文件
- `backend-java/src/main/java/com/cretas/aims/entity/FactoryEquipment.java`
- `backend-java/src/main/java/com/cretas/aims/entity/QualityInspection.java`
- `backend-java/src/main/java/com/cretas/aims/entity/TimeClockRecord.java`
- `backend-java/src/main/java/com/cretas/aims/websocket/EquipmentMonitoringHandler.java`
- `backend-java/src/main/java/com/cretas/aims/service/CameraService.java`

### 新建文件目录结构
```
backend-java/src/main/java/com/cretas/aims/
├── entity/hardware/
│   ├── HardwareDeviceConfig.java
│   ├── WeighingRecord.java
│   ├── WorkerIdentificationRecord.java
│   ├── PostureAnalysisRecord.java
│   ├── LabelInspectionRecord.java
│   └── EdgeGateway.java
├── controller/
│   ├── HardwareDeviceController.java
│   ├── WeighingController.java
│   ├── WorkerIdentificationController.java
│   └── LabelInspectionController.java
└── service/
    ├── HardwareDeviceService.java
    ├── WeighingService.java
    └── VisionAnalysisService.java

edge-gateway/  (新项目)
├── src/main/java/com/cretas/edge/
│   ├── collector/HikvisionCollector.java
│   ├── collector/SerialScaleCollector.java
│   └── protocol/KaifengScaleProtocol.java

vision-ai-service/  (新项目)
├── app/services/
│   ├── qwen_vl_service.py
│   ├── worker_recognition.py
│   └── label_ocr.py
```

---

## 业务流程设计

### 智能称重自动入库流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    完整业务流程                                   │
│                                                                  │
│  1️⃣ 工人放置产品到电子秤                                         │
│      ↓                                                          │
│  2️⃣ 摄像头AI识别产品类型 (Qwen VL)                               │
│      → 识别结果: "带鱼段 PT-F001-001"                            │
│      ↓                                                          │
│  3️⃣ 电子秤读取重量 (WiFi无线传输，稳定后采集)                     │
│      → 重量: 25.0kg                                             │
│      ↓                                                          │
│  4️⃣ 系统自动计算 (软件端计数)                                    │
│      → 查询 ProductType.unitWeight: 0.5kg/个                    │
│      → 计算数量: 25.0 / 0.5 = 50个                              │
│      ↓                                                          │
│  5️⃣ 自动生成入库记录                                            │
│      → MaterialBatch: {                                         │
│           productTypeId: "PT-F001-001",                         │
│           weight: 25.0,                                         │
│           quantity: 50,                                         │
│           inboundSource: "AUTO_WEIGHING"                        │
│         }                                                       │
│      ↓                                                          │
│  6️⃣ 可选触发: 打印标签 / 质检流程 / 告警                         │
└─────────────────────────────────────────────────────────────────┘
```

### 工人效率识别流程

```
摄像头 → 人脸识别 → 匹配User → 关联工位 → 记录工作时长 → 计算效率
```

### OCR标签质检流程

```
摄像头 → OCR识别 → 提取批号/日期 → 校验规则 → 合格/告警
```

---

## 物联网平台方案选择

### 自建 vs 第三方对比

| 维度 | 自建平台 | 第三方平台 |
|------|---------|-----------|
| **初期成本** | 高 (开发人力+服务器) | 低 (按设备收费) |
| **长期成本** | 低 (无订阅费) | 高 (持续订阅) |
| **数据控制** | ✅ 完全自主 | ⚠️ 数据在第三方 |
| **定制能力** | ✅ 无限制 | ⚠️ 受平台限制 |
| **开发周期** | 2-3周 | 即开即用 |
| **维护成本** | 需自己维护 | 厂商维护 |
| **适合场景** | 50+设备、长期运营、数据敏感 | 快速验证、小规模 |

**推荐**: ✅ **自建物联网平台**

理由:
1. 食品溯源数据敏感，不适合放第三方
2. 50+设备规模，长期运营值得自建
3. 现有 Spring Boot + Redis 基础设施可复用
4. 无持续订阅费用

---

### 自建物联网平台架构

```
┌──────────────────────────────────────────────────────────────┐
│                       自建物联网平台                          │
│                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ 边缘网关     │  │ 边缘网关     │  │ 边缘网关     │          │
│  │ (工厂1)     │  │ (工厂2)     │  │ (工厂N)     │          │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘          │
│         └─────────────┬──────────────────┘                   │
│                       │ MQTT                                 │
│                       v                                      │
│  ┌────────────────────────────────────────────────────────┐ │
│  │                    EMQX (开源MQTT Broker)               │ │
│  │                    部署: Docker 容器                     │ │
│  └────────────────────────────┬───────────────────────────┘ │
│                               │                              │
│                               v                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              现有 Spring Boot 后端扩展                   │ │
│  │  • IoT设备管理模块 (注册/上线/离线/配置)                 │ │
│  │  • MQTT订阅模块 (实时接收设备数据)                       │ │
│  │  • 数据处理模块 (解析/存储/聚合)                         │ │
│  │  • 告警规则引擎 (设备离线/异常告警)                      │ │
│  │  • WebSocket推送 (实时数据到前端)                        │ │
│  └────────────────────────────────────────────────────────┘ │
│                               │                              │
│                               v                              │
│  ┌─────────────────┐  ┌─────────────────┐                   │
│  │ MySQL (现有)    │  │ Redis (现有)     │                   │
│  │ • 设备配置      │  │ • 实时状态缓存   │                   │
│  │ • 历史数据      │  │ • 消息队列       │                   │
│  └─────────────────┘  └─────────────────┘                   │
└──────────────────────────────────────────────────────────────┘
```

---

## 现有后端架构分析与整合方案 ✅

### 已有基础设施 (可直接复用)

通过代码分析，现有后端已具备完善的硬件管理基础：

| 模块 | 文件 | 功能 | IoT整合方式 |
|------|------|------|------------|
| **设备管理** | `EquipmentController.java` | CRUD、启停、维护、OEE计算 | 扩展字段支持IoT设备类型 |
| **实时监控WebSocket** | `EquipmentMonitoringHandler.java` | 心跳(60s)、告警广播、状态推送 | **直接复用**，添加MQTT数据源 |
| **设备告警** | `EquipmentAlertsController.java` | 告警CRUD、统计、确认/解决 | **直接复用**，扩展告警类型 |
| **告警调度器** | `EquipmentMonitoringScheduler.java` | 30秒监控、30分钟冷却 | 扩展支持IoT设备离线检测 |
| **摄像头SDK** | `CameraServiceImpl.java` | 海康威视图像采集 | **已就绪**，可对接AI视觉 |
| **推送通知** | `DeviceController.java` | Expo Push Token管理 | **直接复用**，告警推送 |
| **考勤定位** | `TimeClockController.java` | GPS打卡、工时计算 | 可扩展工人识别打卡 |

### 需新增模块

| 功能 | 现状 | 新增内容 |
|------|------|---------|
| **MQTT通信** | ❌ 未实现 | MqttConfig + MqttSubscriber |
| **串口通信** | ❌ 未实现 | 边缘网关项目处理 |
| **称重数据采集** | ❌ 未实现 | WeighingController + WeighingService |
| **IoT设备注册** | ⚠️ 部分有 | 复用DeviceRegistration，扩展字段 |

### 整合架构图 (利用现有基础)

```
┌─────────────────────────────────────────────────────────────────────┐
│                          现有后端 (扩展)                             │
│                                                                      │
│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐   │
│  │ EquipmentController│ │EquipmentAlerts │   │ CameraController │   │
│  │   (现有 ✅)       │   │   (现有 ✅)     │   │   (现有 ✅)      │   │
│  │ + IoT设备类型扩展 │   │ + IoT告警类型   │   │ + AI视觉对接    │   │
│  └─────────────────┘   └─────────────────┘   └─────────────────┘   │
│           │                     │                     │            │
│           ├─────────────────────┼─────────────────────┤            │
│           v                     v                     v            │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │          EquipmentMonitoringHandler (现有 WebSocket)         │   │
│  │          + 接收MQTT数据并推送前端 (扩展)                       │   │
│  └────────────────────────────────┬────────────────────────────┘   │
│                                   │                                 │
│  ┌────────────────────────────────┴────────────────────────────┐   │
│  │                    新增: MqttSubscriber                       │   │
│  │                    订阅: cretas/{factoryId}/device/#          │   │
│  └────────────────────────────────┬────────────────────────────┘   │
│                                   │                                 │
│  ┌────────────────────────────────┴────────────────────────────┐   │
│  │                    EMQX (新增Docker容器)                      │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                   ↑                                 │
└───────────────────────────────────┼─────────────────────────────────┘
                                    │ MQTT
┌───────────────────────────────────┼─────────────────────────────────┐
│                          边缘网关 (新项目)                           │
│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐   │
│  │ 矽策秤WiFi API   │   │ 柯力秤RS232解析 │   │ 海康摄像头SDK   │   │
│  └─────────────────┘   └─────────────────┘   └─────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### 具体整合策略

#### 1. 扩展 FactoryEquipment 实体

```java
// 现有字段保持不变，新增IoT相关字段
@Entity
public class FactoryEquipment {
    // ... 现有字段 ...

    // 新增字段
    @Column(name = "iot_device_code")
    private String iotDeviceCode;           // IoT设备编码

    @Column(name = "device_category")
    @Enumerated(EnumType.STRING)
    private DeviceCategory category;        // TRADITIONAL / IOT_SCALE / IOT_CAMERA

    @Column(name = "mqtt_topic")
    private String mqttTopic;               // MQTT订阅主题

    @Column(name = "last_data_received")
    private LocalDateTime lastDataReceived; // 最后数据接收时间
}
```

#### 2. 复用 EquipmentMonitoringHandler

```java
// 现有WebSocket Handler，添加MQTT数据推送能力
@Component
public class EquipmentMonitoringHandler {
    // 现有方法保持不变

    // 新增: 接收MQTT数据后推送到前端
    public void pushIoTData(String factoryId, IoTDeviceData data) {
        // 复用现有的 broadcastToFactory 方法
        broadcastToFactory(factoryId, new EquipmentStatusMessage(
            data.getDeviceId(),
            "IOT_DATA",
            data.toJson()
        ));
    }
}
```

#### 3. 复用 EquipmentAlertsController

```java
// 现有告警控制器，扩展告警类型枚举
public enum AlertType {
    // 现有类型
    MAINTENANCE_DUE, WARRANTY_EXPIRING, ABNORMAL_STATUS,

    // 新增IoT告警类型
    IOT_DEVICE_OFFLINE,      // 设备离线
    IOT_DATA_ANOMALY,        // 数据异常
    IOT_WEIGHT_THRESHOLD,    // 称重超限
    IOT_CONNECTION_ERROR     // 连接错误
}
```

#### 4. 扩展 CameraService 对接AI

```java
// 现有CameraService已有海康SDK集成，扩展AI分析能力
@Service
public class CameraServiceImpl {
    // 现有方法保持不变

    // 新增: 图像AI分析
    public ProductRecognitionResult recognizeProduct(byte[] imageData) {
        // 调用vision-ai-service进行产品识别
        return visionClient.recognize(imageData);
    }

    // 新增: 工人识别
    public WorkerIdentificationResult identifyWorker(byte[] imageData) {
        return visionClient.identifyWorker(imageData);
    }
}
```

### 减少重复开发 - 复用清单

| 需求 | 新建 vs 复用 | 说明 |
|------|-------------|------|
| 设备CRUD | ✅ **复用** EquipmentController | 扩展字段即可 |
| 实时推送 | ✅ **复用** EquipmentMonitoringHandler | 添加MQTT数据源 |
| 告警管理 | ✅ **复用** EquipmentAlertsController | 扩展告警类型 |
| 告警调度 | ✅ **复用** EquipmentMonitoringScheduler | 扩展检测逻辑 |
| 推送通知 | ✅ **复用** DeviceController | 直接使用 |
| 摄像头采集 | ✅ **复用** CameraService | 对接AI服务 |
| MQTT订阅 | 🆕 **新建** MqttSubscriber | 新增模块 |
| 称重数据处理 | 🆕 **新建** WeighingService | 新增模块 |
| 边缘网关 | 🆕 **新建** edge-gateway项目 | 独立项目 |

### 开发工时优化 (利用现有基础)

| 模块 | 原估算 | 优化后 | 节省 |
|------|--------|--------|------|
| 设备管理 | 2天 | 0.5天 (仅扩展字段) | 1.5天 |
| WebSocket推送 | 1天 | 0.3天 (添加方法) | 0.7天 |
| 告警系统 | 1.5天 | 0.3天 (扩展枚举) | 1.2天 |
| 推送通知 | 0.5天 | 0天 (直接复用) | 0.5天 |
| 摄像头对接 | 1天 | 0.5天 (添加AI调用) | 0.5天 |
| **小计** | 6天 | 1.6天 | **4.4天** |

### 自建平台所需开源组件

| 组件 | 推荐方案 | 用途 | 许可证 | 成本 |
|------|---------|------|--------|------|
| **MQTT Broker** | EMQX 开源版 | 设备消息通道，支持百万连接 | Apache 2.0 | 免费 |
| **MQTT客户端** | Eclipse Paho (Java) | Spring Boot 订阅MQTT | EPL | 免费 |
| **时序数据库** | TDengine 或 InfluxDB | 存储高频称重数据 (可选) | AGPL/MIT | 免费 |
| **规则引擎** | Drools (已在项目中) | 告警规则、业务规则 | Apache 2.0 | 免费 |
| **消息队列** | Redis Stream (已有) | 消息缓冲、异步处理 | BSD | 免费 |

---

### 自建平台开发计划

#### 新增数据库表

```sql
-- IoT设备注册表
CREATE TABLE iot_devices (
    id VARCHAR(36) PRIMARY KEY,
    device_code VARCHAR(50) UNIQUE NOT NULL,     -- 设备编码
    device_type ENUM('SCALE', 'CAMERA', 'GATEWAY') NOT NULL,
    factory_id VARCHAR(50) NOT NULL,
    equipment_id BIGINT,                          -- 关联工厂设备
    protocol_type VARCHAR(20),                    -- MQTT/HTTP/RS232
    connection_config JSON,                       -- 连接配置
    status ENUM('ONLINE', 'OFFLINE', 'ERROR') DEFAULT 'OFFLINE',
    last_heartbeat DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (factory_id) REFERENCES factories(factory_id)
);

-- 设备数据采集表 (高频数据)
CREATE TABLE iot_device_data (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    device_id VARCHAR(36) NOT NULL,
    data_type VARCHAR(20) NOT NULL,               -- WEIGHT/TEMPERATURE/IMAGE
    data_value JSON NOT NULL,                     -- {"weight": 25.5, "unit": "kg", "stable": true}
    collected_at DATETIME NOT NULL,
    processed BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_device_time (device_id, collected_at),
    INDEX idx_unprocessed (processed, created_at)
);

-- 设备告警表
CREATE TABLE iot_device_alerts (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    device_id VARCHAR(36) NOT NULL,
    alert_type VARCHAR(30) NOT NULL,              -- OFFLINE/ERROR/THRESHOLD
    alert_level ENUM('INFO', 'WARNING', 'CRITICAL') NOT NULL,
    message VARCHAR(500),
    acknowledged BOOLEAN DEFAULT FALSE,
    acknowledged_by BIGINT,
    acknowledged_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_device_alerts (device_id, created_at)
);
```

#### 新增后端模块 (优化后)

| 模块 | 文件路径 | 功能 | 工时 | 备注 |
|------|---------|------|------|------|
| **MQTT配置** | `config/MqttConfig.java` | EMQX连接配置 | 0.5天 | 新增 |
| **MQTT订阅** | `service/mqtt/MqttSubscriber.java` | 订阅设备主题 | 1天 | 新增 |
| **设备扩展** | `entity/FactoryEquipment.java` | 添加IoT字段 | 0.5天 | **复用扩展** |
| **数据处理** | `service/iot/IoTDataProcessor.java` | 解析/存储/触发业务 | 2天 | 新增 |
| **告警扩展** | `EquipmentMonitoringScheduler.java` | IoT设备离线检测 | 0.3天 | **复用扩展** |
| **称重服务** | `service/WeighingService.java` | 称重数据处理+入库 | 1.5天 | 新增 |
| **WebSocket扩展** | `websocket/EquipmentMonitoringHandler.java` | MQTT数据推送 | 0.3天 | **复用扩展** |
| **后端总计** | | | **6.1天** | 节省2.9天 |

#### MQTT主题设计

```
# 设备上行数据
cretas/{factoryId}/device/{deviceId}/data      # 称重数据/温度等
cretas/{factoryId}/device/{deviceId}/status    # 设备状态
cretas/{factoryId}/device/{deviceId}/heartbeat # 心跳

# 平台下行指令
cretas/{factoryId}/device/{deviceId}/command   # 配置/重启等指令

# 示例消息格式
{
  "deviceId": "SCALE-001",
  "type": "WEIGHT",
  "timestamp": "2026-01-03T10:30:00Z",
  "data": {
    "weight": 25.5,
    "unit": "kg",
    "stable": true,
    "operatorId": 22
  }
}
```

#### Maven依赖

```xml
<!-- MQTT客户端 -->
<dependency>
    <groupId>org.eclipse.paho</groupId>
    <artifactId>org.eclipse.paho.client.mqttv3</artifactId>
    <version>1.2.5</version>
</dependency>

<!-- Spring Integration MQTT -->
<dependency>
    <groupId>org.springframework.integration</groupId>
    <artifactId>spring-integration-mqtt</artifactId>
</dependency>
```

---

### 边缘网关MQTT上报

边缘网关采集到秤数据后，通过MQTT上报:

```java
// 边缘网关代码示例
public class ScaleDataUploader {
    private MqttClient mqttClient;

    public void uploadWeighingData(String factoryId, String deviceId, WeighingData data) {
        String topic = String.format("cretas/%s/device/%s/data", factoryId, deviceId);
        String payload = objectMapper.writeValueAsString(data);
        mqttClient.publish(topic, new MqttMessage(payload.getBytes()));
    }
}
```

---

### 第三方物联网云平台 (备选参考)

如未来需要快速扩展或混合部署，可参考以下第三方平台:

| 平台 | 开放API | SDK语言 | 定价 | 特点 |
|------|---------|---------|------|------|
| [ThingsCloud](https://www.thingscloud.xyz/) | ✅ REST API | JS/多语言 | 免费起步 | 零代码App生成，数据可视化 |
| [有人云](http://cloud.usr.cn/) | ✅ HTTP/JS/Java SDK | 多语言 | 按设备收费 | 工业级，支持多种网关 |
| [机智云](https://www.gizwits.com/) | ✅ 完整SDK | 多语言 | 商业授权 | AIoT综合方案 |
| [阿里云IoT](https://help.aliyun.com/zh/iot/) | ✅ Link SDK | C/Java/Python | 按量计费 | 企业级，大规模部署 |

---

## 参考资料

### 电子秤协议与开发
- [柯力D2008说明书PDF](http://www.kelichina.com/uploads/soft/20231205/1-231205205524B7.pdf)
- [柯力D2008串口开发](https://blog.csdn.net/waxyy002/article/details/137327779)
- [耀华XK3190串口开发](https://blog.csdn.net/fenghaibo8149/article/details/116190159)
- [托利多PS60串口通信开发](https://blog.csdn.net/weixin_44455060/article/details/115401440)
- [顶尖OS2电子秤协议](https://www.cnblogs.com/yizhuqing/p/17988086)

### 硬件模块
- [海康威视开放平台](https://open.hikvision.com/)
- [微雪串口转WiFi模块](https://www.waveshare.net/shop/RS232-485-TO-WIFI-ETH-B.htm)
- [虚拟串口VSPD教程](https://blog.csdn.net/qq_41854911/article/details/119299489)

### 物联网秤厂商
- [亚津衡器物联网方案](https://www.maihengqi.com/wlwzndzczn.html)
- [柯力传感官网](https://www.kelichina.com/)
- [巨天仪器JDT-WN系列](http://www.szahsdzkj.com/Article-447160.html)
- [捷俊通无人值守系统](https://www.jiejuntong.com/)
- [磅师傅地磅系统](https://www.shweight.com/)

### 物联网云平台
- [ThingsCloud](https://www.thingscloud.xyz/)
- [有人云](http://cloud.usr.cn/)
- [机智云](https://www.gizwits.com/)
- [阿里云物联网平台](https://help.aliyun.com/zh/iot/)

---

## 项目总结

### 完整开发工时表 (利用现有架构优化后)

| 阶段 | 任务 | 工时 | 备注 |
|------|------|------|------|
| **Phase 1: 基础设施** | EMQX Docker部署 | 0.5天 | 脚本化部署 |
| | MQTT配置 + 订阅模块 | 1.5天 | 新增 |
| | 数据库迁移脚本 | 0.5天 | 新表+扩展字段 |
| **Phase 2: 后端扩展** | FactoryEquipment扩展 | 0.5天 | 复用 |
| | WeighingService | 1.5天 | 新增 |
| | IoTDataProcessor | 2天 | 新增 |
| | 告警/WebSocket扩展 | 0.6天 | 复用 |
| **Phase 3: 边缘网关** | 项目框架搭建 | 0.5天 | 新项目 |
| | 矽策API对接 | 1天 | HTTP |
| | 大华/友声/耀华串口协议 | 2天 | RS232 ASCII |
| | MQTT上报模块 | 1天 | |
| **Phase 4: AI视觉** | 项目框架搭建 | 0.5天 | Python |
| | Qwen VL集成 | 1.5天 | |
| | 产品识别/工人识别 | 2天 | |
| | CameraService对接 | 0.5天 | 复用扩展 |
| **Phase 5: 测试验证** | 虚拟串口测试 | 1天 | VSPD |
| | 集成测试 | 1.5天 | |
| **总计** | | **18.6天** | ≈4周 |

### 成本汇总 (已更新)

| 类别 | 明细 | 金额 |
|------|------|------|
| **硬件** | 电子秤55台(¥44,000) + WiFi模块55个(¥12,100) + 摄像头20台 + 边缘网关2台 + 工业AP10个 + 交换机2个 | ¥112,100 |
| **软件** | EMQX开源 + Redis + MySQL (现有) | ¥0 |
| **开发** | 18.6天 × ¥2,000/天 (按市场价估算) | ¥37,200 |
| **总计** | | **¥149,300** |

> 💰 **成本对比**: 修正选品后，总成本从¥233,400降至¥149,300，节省¥84,100 (36%)

### 关键成功因素

1. ✅ **现有架构复用率高** - 设备管理/告警/WebSocket/摄像头SDK全部可复用
2. ✅ **EMQX开源可控** - 无第三方平台订阅费，数据自主
3. ✅ **边缘网关独立** - 断网时本地缓冲，网络恢复后上传 (关键稳定性设计)
4. ✅ **工业级WiFi设计** - 5GHz优先+信道规划+指数退避重连，确保网络稳定
5. ✅ **可先开发后采购** - 虚拟串口验证，降低风险
6. ✅ **模块化设计** - 边缘网关/AI服务可独立部署和扩展

### 风险与对策

| 风险 | 概率 | 影响 | 对策 |
|------|------|------|------|
| 秤协议兼容性问题 | 中 | 高 | 先购买样机验证 |
| WiFi信号干扰/断网 | 中 | 中 | 工业级AP+5GHz优先+边缘缓冲+指数退避重连 |
| WiFi覆盖死角 | 低 | 中 | AP部署密度规划 (每300-500㎡ 1个) |
| AI识别准确率低 | 低 | 高 | Qwen VL可微调，预留人工复核 |
| EMQX性能瓶颈 | 低 | 中 | 开源版支持百万连接，足够使用 |
| 网络丢数据 | 低 | 高 | 边缘网关本地缓冲最多存储12小时数据 |

---

## 下一步行动 (优先级排序)

### 立即可开始 (无需硬件) ✅ 已完成 (2026-01-04)
1. ✅ 部署EMQX Docker容器 - 完成配置和部署脚本
2. ✅ 创建数据库迁移脚本 (IoT表 + 扩展字段) - `V2026_01_04_10__scale_protocol_tables.sql`
3. ✅ 开发MqttConfig + MqttSubscriber - 边缘网关MQTT模块
4. ✅ 扩展FactoryEquipment实体 - 添加scaleProtocolId、scaleBrandModelId等字段
5. ✅ 搭建边缘网关项目框架 - edge-gateway项目已创建

### 样机验证阶段
6. ⬜ 购买1台友声TCS-150kg小型台秤 (¥600)
7. ⬜ 购买1个微雪WiFi模块 (¥220)
8. ⬜ 开发并验证RS232 ASCII串口协议解析
9. ⬜ 端到端测试：秤→边缘网关→MQTT→后端→前端

### 批量部署阶段
10. ⬜ 批量采购硬件
11. ⬜ 部署边缘网关到工厂
12. ⬜ 配置WiFi网络和MQTT主题
13. ⬜ 员工培训和上线

---

## 并行工作建议

### Subagent 并行 ✅
可同时启动3个agent:
1. 后端实体+数据库迁移脚本
2. 边缘网关服务框架
3. API端点和服务层

### 多Chat窗口并行 ✅
- 窗口1: 后端Java代码
- 窗口2: 边缘网关服务 (独立项目)
- 窗口3: AI视觉服务 (Python)

**注意**: 共享的DTO需先确定避免冲突

---

## 秤协议自动适配架构 ✅ 已完成 (2026-01-04)

### 设计目标

**核心问题**: 不同品牌/型号的电子秤使用不同的协议和接口，如何实现"一套代码适配所有秤"？

**解决方案**: 利用现有的 Drools 规则引擎 + 动态表单 + AI 意图系统，构建配置驱动的协议适配层。

### 已完成的实现

#### 1. 数据库表和实体

| 文件 | 说明 |
|------|------|
| `V2026_01_04_10__scale_protocol_tables.sql` | 协议配置表、品牌型号表、测试用例表 |
| `V2026_01_04_11__scale_initial_data.sql` | 内置协议数据 (柯力D2008、耀华XK3190、矽策XC709S等) |
| `ScaleProtocolConfig.java` | 协议配置实体 (支持RS232/RS485/HTTP/MQTT/Modbus) |
| `ScaleBrandModel.java` | 品牌型号实体 (支持推荐评分) |
| `ScaleProtocolTestCase.java` | 测试用例实体 (验证协议解析正确性) |

#### 2. 核心服务

| 文件 | 功能 |
|------|------|
| `ScaleProtocolAdapterService.java` | 协议适配服务接口 |
| `ScaleProtocolAdapterServiceImpl.java` | 协议解析、自动识别、测试验证 |
| `ScaleFrameParser.java` | 帧解析器接口 (支持多种协议格式) |
| `AsciiFixedFrameParser.java` | ASCII定长帧解析器 (柯力/耀华通用) |

#### 3. 虚拟秤模拟器 (无硬件开发)

| 文件 | 功能 |
|------|------|
| `VirtualScaleSimulator.java` | 虚拟秤模拟器服务 (模拟称重过程) |
| `VirtualScaleConfig.java` | 模拟器配置 (量程、精度、波动) |
| `ScaleSimulatorController.java` | REST API (启动/停止/发送数据) |

**模拟器能力**:
- 支持柯力D2008、微型秤、地磅等预设配置
- 模拟完整称重过程 (波动→稳定)
- 批量称重数据队列
- 多模拟器并行运行
- 生成测试数据帧 (HEX/ASCII)

#### 4. AI 意图集成

| 文件 | 功能 |
|------|------|
| `ScaleIntentHandler.java` | 秤配置AI意图处理器 |
| AI意图支持 | 添加秤型号、协议自动识别、AI生成配置、秤故障排查 |

#### 5. 动态表单

| 文件 | 功能 |
|------|------|
| `scaleConfiguration.schema.ts` | Formily 动态表单 Schema |
| 支持联动 | 品牌→协议→连接参数级联选择 |

### 支持的协议类型

| 连接类型 | 协议格式 | 示例品牌 | 对接方式 |
|----------|---------|---------|---------|
| **RS232 串口** | ASCII 定长帧 | 柯力、耀华 | 边缘网关 jSerialComm |
| **RS485 总线** | Modbus RTU | 工业秤 | 边缘网关 + Modbus4j |
| **HTTP API** | JSON REST | 矽策 XC709S | 后端直接调用 |
| **MQTT** | JSON 消息 | 物联网秤 | EMQX 订阅 |
| **TCP Socket** | 自定义帧 | 部分工业秤 | Netty 客户端 |

### API 端点

```
# 协议管理
GET    /api/mobile/{factoryId}/scale-protocols              # 获取可用协议列表
GET    /api/mobile/{factoryId}/scale-protocols/{id}         # 获取协议详情
POST   /api/mobile/{factoryId}/scale-protocols              # 创建协议配置
PUT    /api/mobile/{factoryId}/scale-protocols/{id}         # 更新协议配置

# 品牌型号
GET    /api/mobile/{factoryId}/scale-brand-models           # 获取所有品牌型号
GET    /api/mobile/{factoryId}/scale-brand-models/recommended # 获取推荐型号

# 数据解析
POST   /api/mobile/{factoryId}/scale-protocols/parse        # 解析原始数据
POST   /api/mobile/{factoryId}/scale-protocols/auto-detect  # 协议自动识别

# 测试验证
POST   /api/mobile/{factoryId}/scale-protocols/test-cases/{id}/run # 运行测试用例
POST   /api/mobile/{factoryId}/scale-protocols/{id}/dry-run # 模拟解析

# 虚拟秤模拟器
POST   /api/mobile/{factoryId}/scale-simulator/start        # 启动模拟器
POST   /api/mobile/{factoryId}/scale-simulator/start/keli-d2008 # 快速启动柯力D2008
POST   /api/mobile/{factoryId}/scale-simulator/start/micro-scale # 快速启动微型秤
POST   /api/mobile/{factoryId}/scale-simulator/{id}/stop    # 停止模拟器
GET    /api/mobile/{factoryId}/scale-simulator/list         # 获取活跃模拟器
POST   /api/mobile/{factoryId}/scale-simulator/{id}/send    # 发送称重数据
POST   /api/mobile/{factoryId}/scale-simulator/{id}/simulate-weighing # 模拟称重过程
GET    /api/mobile/{factoryId}/scale-simulator/{id}/data    # 获取接收数据
```

### 下一步: IoT基础设施 ✅ 已完成 (2026-01-04)

完成秤协议自动适配后，IoT基础设施开发已完成:
1. ✅ 部署EMQX Docker容器 - Docker Compose配置完成
2. ✅ 创建数据库迁移脚本 (IoT表 + 扩展字段) - 包含scale_protocol_configs、scale_brand_models、scale_protocol_test_cases表
3. ✅ 开发MqttConfig + MqttSubscriber - 边缘网关MQTT通信模块
4. ✅ 扩展FactoryEquipment实体 - 添加IoT设备关联字段
5. ✅ 搭建边缘网关项目框架 - edge-gateway独立Java项目

### 虚拟秤模拟器 ✅ 已完成 (2026-01-04)

| 文件 | 功能 |
|------|------|
| `VirtualScaleSimulator.java` | 虚拟秤模拟器接口 |
| `VirtualScaleSimulatorImpl.java` | 实现类 (ConcurrentHashMap多实例管理) |
| `VirtualScaleConfig.java` | 模拟器配置DTO |
| `SimulatorStatus.java` | 模拟器状态DTO |
| `ScaleSimulatorController.java` | REST API控制器 |

**技术特性**:
- 支持4种帧类型: ASCII_FIXED, ASCII_VARIABLE, HEX_FIXED, MODBUS_RTU
- 校验和计算: XOR, SUM, Modbus CRC16
- 线程安全: ConcurrentHashMap + ScheduledExecutorService
- 预设配置: 柯力D2008(150kg/0.02kg)、微型秤(30kg/0.01kg)、地磅(2000kg/0.5kg)

### ScaleIntentHandler ✅ 已完成 (2026-01-04)

| 意图代码 | 功能 | 关键词 |
|---------|------|--------|
| `SCALE_ADD_MODEL` | 添加秤型号 | 添加秤、配置秤、大华、友声、耀华、矽策 |
| `SCALE_PROTOCOL_DETECT` | 协议自动识别 | 识别协议、数据格式 |
| `SCALE_CONFIG_GENERATE` | AI生成配置 | 生成配置、自动配置 |
| `SCALE_TROUBLESHOOT` | 秤故障排查 | 秤故障、连不上 |

### 下一步: 样机验证与批量部署

---

## 附录：内置WiFi物联网成品秤选品 (免适配方案)

> 💡 **适用场景**: 不想自己做串口协议适配，希望直接购买内置WiFi/4G模块、厂家提供云平台和API接口的成品秤

### 微型智能溯源秤 (1-30kg)

| 品牌/型号 | 连接方式 | 参考价格 | 特点 | 推荐 |
|----------|---------|----------|------|------|
| **[矽策 XC709S](http://www.xiceelec.com/product/product28.html)** | WiFi内置 | ¥1,500-2,500 | 智慧农贸溯源秤，15/30kg双量程，ARM-M4核心，4000条PLU，8000交易记录 | 🌟 首选 |
| **矽策 XC719** | WiFi内置 | ¥2,000-3,000 | 升级版，更大屏幕，更多功能 | 高端 |

### 小型智能台秤 (30-150kg)

| 品牌/型号 | 连接方式 | 参考价格 | 特点 | 推荐 |
|----------|---------|----------|------|------|
| **[巨天 JDT-WN-Q20S](https://www.gkzhan.com/st150083/)** | 4G/WiFi | ¥2,000-4,000 | 7寸触摸屏，自动生成称重记录，USB/RS232/RS485/网口全接口 | 🌟 首选 |
| **[亚津 DS12P](https://www.maihengqi.com/wlwzndzczn.html)** | GPRS/WiFi | ¥3,000-5,000 | 10.2寸液晶，配套"衡管家"云平台，支持在线升级 | 专业级 |

### 中大型智能地磅 (300kg-3吨)

| 品牌/型号 | 连接方式 | 参考价格 | 特点 | 推荐 |
|----------|---------|----------|------|------|
| **亚津 物联网台秤** | GPRS/4G | ¥5,000-15,000 | 配套衡管家云平台，数据实时上传 | 🌟 性价比 |
| **[捷俊通 无人值守地磅](https://www.jiejuntong.com/)** | 4G/有线 | ¥50,000+ | 车牌识别+自动称重+云平台，适合物流园区 | 企业级 |

### 物联网秤云平台对比

| 厂商 | 云平台 | 年费 | API开放 | 特点 |
|------|--------|------|---------|------|
| **矽策** | 矽策云 | 需询价 | ✅ 有 | 农贸市场溯源专用，支持电子支付 |
| **亚津** | 衡管家 | 需询价 | ✅ 有 | 工业称重数据管理，在线升级 |
| **巨天** | 定制对接 | 按项目 | ✅ 有 | 可对接ERP/MES系统 |

### 两种方案成本对比

| 对比项 | 方案A：传统秤+WiFi模块 | 方案B：内置WiFi物联网秤 |
|--------|------------------------|------------------------|
| **单价** | ¥300-2,200 + ¥220模块 | ¥1,500-15,000 |
| **开发成本** | 需开发串口协议解析 (2-5天) | 厂家提供API，开发量小 (1天) |
| **稳定性** | 中等（模块可能断连） | 高（一体化设计） |
| **云平台** | 自建 | 厂家提供 |
| **维护** | 自己维护 | 厂家支持 |
| **适合场景** | 预算有限、有开发能力 | 快速上线、人力有限 |

> ⚠️ **注意**: 物联网成品秤价格普遍较高，且需联系厂家询价。建议先试用1-2台测试API对接难度，再决定批量采购。

### 采购建议

1. **首选传统秤方案** - 成本低、协议标准、完全可控
2. **若需免适配** - 微型秤选矽策XC709S，台秤选巨天
3. **先样机后批量** - 任何方案都建议先购买1-2台验证
