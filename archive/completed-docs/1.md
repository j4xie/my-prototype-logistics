SmartBI 数据清理与测试计划                                                                                                                                   │
│                                                                                                                                                              │
│ 核心问题发现 🔴                                                                                                                                              │
│                                                                                                                                                              │
│ 问题根源：数据流断裂                                                                                                                                         │
│                                                                                                                                                              │
│ Excel上传流程:                                                                                                                                               │
│   Excel → Python服务 → smart_bi_dynamic_data (PostgreSQL JSONB)                                                                                              │
│                         ↑                                                                                                                                    │
│                         数据存在这里！但没有被Dashboard使用                                                                                                  │
│                                                                                                                                                              │
│ Dashboard显示流程:                                                                                                                                           │
│   Dashboard → SalesAnalysisService → SmartBiSalesData (固定schema表)                                                                                         │
│                                      ↑                                                                                                                       │
│                                      这个表是空的！所以图表为空                                                                                              │
│                                                                                                                                                              │
│ Java后端的Dashboard API从 SmartBiSalesData 固定表读取数据，但这个表是空的！                                                                                  │
│ Excel上传的数据存储在 smart_bi_dynamic_data (JSONB)，两个数据源没有打通。                                                                                    │
│                                                                                                                                                              │
│ 关键代码位置                                                                                                                                                 │
│                                                                                                                                                              │
│ 1. Dashboard数据生成 (问题所在):                                                                                                                             │
│   - SalesAnalysisServiceImpl.getSalesOverview() 从 SmartBiSalesData 读取                                                                                     │
│   - 如果表为空，返回 buildEmptyDashboard() → 前端显示空白                                                                                                    │
│ 2. Excel数据存储 (正确但未使用):                                                                                                                             │
│   - Python服务解析后存入 smart_bi_dynamic_data (JSONB)                                                                                                       │
│   - 这些数据没有被Dashboard API使用                                                                                                                          │
│ 3. 前端图表过滤:                                                                                                                                             │
│   - chartHasData() 检查 series[].data 是否为空                                                                                                               │
│   - 空数据的图表会被过滤掉，显示空白                                                                                                                         │
│                                                                                                                                                              │
│ ---                                                                                                                                                          │
│ 数据库架构                                                                                                                                                   │
│                                                                                                                                                              │
│ 系统只使用PostgreSQL，不使用MySQL！                                                                                                                          │
│                                                                                                                                                              │
│ 两套表结构 (问题根源)                                                                                                                                        │
│ ┌──────────────┬───────────────────────────┬───────────────┬───────────┐                                                                                     │
│ │    表类型    │           表名            │     用途      │   状态    │                                                                                     │
│ ├──────────────┼───────────────────────────┼───────────────┼───────────┤                                                                                     │
│ │ 固定Schema表 │ smart_bi_sales_data       │ Dashboard读取 │ ⚠️ 空的   │                                                                                     │
│ ├──────────────┼───────────────────────────┼───────────────┼───────────┤                                                                                     │
│ │ 固定Schema表 │ smart_bi_finance_data     │ 财务分析      │ ⚠️ 空的   │                                                                                     │
│ ├──────────────┼───────────────────────────┼───────────────┼───────────┤                                                                                     │
│ │ 动态JSONB表  │ smart_bi_dynamic_data     │ Excel数据存储 │ ✅ 有数据 │                                                                                     │
│ ├──────────────┼───────────────────────────┼───────────────┼───────────┤                                                                                     │
│ │ 动态JSONB表  │ smart_bi_pg_excel_uploads │ 上传记录      │ ✅ 有数据 │                                                                                     │
│ └──────────────┴───────────────────────────┴───────────────┴───────────┘                                                                                     │
│ ---                                                                                                                                                          │
│ Test.xlsx 文件结构                                                                                                                                           │
│                                                                                                                                                              │
│ 文件: smartbi/Test.xlsx (884KB, 11 sheets)                                                                                                                   │
│ ┌───────┬───────────────────────┬──────┬──────┬───────────┐                                                                                                  │
│ │ Sheet │         名称          │ 行数 │ 列数 │   类型    │                                                                                                  │
│ ├───────┼───────────────────────┼──────┼──────┼───────────┤                                                                                                  │
│ │ 0     │ 索引                  │ 25   │ 3    │ 目录/索引 │                                                                                                  │
│ ├───────┼───────────────────────┼──────┼──────┼───────────┤                                                                                                  │
│ │ 1     │ 收入及净利简表        │ 24   │ 44   │ 汇总表    │                                                                                                  │
│ ├───────┼───────────────────────┼──────┼──────┼───────────┤                                                                                                  │
│ │ 2     │ 2025年销售1中心利润表 │ 270  │ 59   │ 利润表    │                                                                                                  │
│ ├───────┼───────────────────────┼──────┼──────┼───────────┤                                                                                                  │
│ │ 3     │ 2025年中心利润表      │ 267  │ 33   │ 利润表    │                                                                                                  │
│ ├───────┼───────────────────────┼──────┼──────┼───────────┤                                                                                                  │
│ │ 4     │ 2025年江苏分部利润表  │ 286  │ 117  │ 利润表    │                                                                                                  │
│ ├───────┼───────────────────────┼──────┼──────┼───────────┤                                                                                                  │
│ │ 5     │ 2025年浙江分部利润表  │ 269  │ 33   │ 利润表    │                                                                                                  │
│ ├───────┼───────────────────────┼──────┼──────┼───────────┤                                                                                                  │
│ │ 6     │ 2025年上海分部利润表  │ 269  │ 33   │ 利润表    │                                                                                                  │
│ ├───────┼───────────────────────┼──────┼──────┼───────────┤                                                                                                  │
│ │ 7     │ 2025年赣皖区域利润表  │ 269  │ 33   │ 利润表    │                                                                                                  │
│ ├───────┼───────────────────────┼──────┼──────┼───────────┤                                                                                                  │
│ │ 8     │ 2025年安徽省区利润表  │ 269  │ 33   │ 利润表    │                                                                                                  │
│ ├───────┼───────────────────────┼──────┼──────┼───────────┤                                                                                                  │
│ │ 9     │ 2025年江西省区利润表  │ 269  │ 33   │ 利润表    │                                                                                                  │
│ ├───────┼───────────────────────┼──────┼──────┼───────────┤                                                                                                  │
│ │ 10    │ 24年返利明细          │ 59   │ 6    │ 明细表    │                                                                                                  │
│ └───────┴───────────────────────┴──────┴──────┴───────────┘                                                                                                  │
│ ---                                                                                                                                                          │
│ Excel上传后生成的内容                                                                                                                                        │
│                                                                                                                                                              │
│ Python服务 (端口8083) 处理流程:                                                                                                                              │
│                                                                                                                                                              │
│ Excel上传 → ExcelParser解析 → DataFeatureAnalyzer分析 →                                                                                                      │
│ FieldMappingService映射 → UnifiedAnalyzer统一分析 →                                                                                                          │
│ ChartRecommender推荐图表 → InsightService生成洞察                                                                                                            │
│                                                                                                                                                              │
│ 生成的数据类型:                                                                                                                                              │
│ 1. KPI卡片: 营业收入、净利润、毛利率等关键指标                                                                                                               │
│ 2. 图表配置: 支持18种图表类型 (line, bar, pie, waterfall等)                                                                                                  │
│ 3. AI洞察: 趋势分析、异常检测、建议                                                                                                                          │
│ 4. 预测结果: 时间序列预测                                                                                                                                    │
│                                                                                                                                                              │
│ 4. 前后端API匹配情况 ✅                                                                                                                                      │
│                                                                                                                                                              │
│ 前端API路径 (web-admin/src/api/smartbi.ts)                                                                                                                   │
│                                                                                                                                                              │
│ /{factoryId}/smart-bi/upload-and-analyze      → POST Excel上传分析                                                                                           │
│ /{factoryId}/smart-bi/uploads                 → GET 历史列表                                                                                                 │
│ /{factoryId}/smart-bi/uploads/{uploadId}/data → GET 表格数据                                                                                                 │
│ /{factoryId}/smart-bi/uploads/{uploadId}/fields → GET 字段定义                                                                                               │
│ /{factoryId}/smart-bi/analysis/dynamic        → GET 动态分析                                                                                                 │
│ /{factoryId}/smart-bi/backfill/fields/{uploadId} → POST 字段回填                                                                                             │
│                                                                                                                                                              │
│ 后端Controller路由                                                                                                                                           │
│                                                                                                                                                              │
│ @RequestMapping("/api/mobile/{factoryId}/smart-bi")                                                                                                          │
│ public class SmartBIController { ... }                                                                                                                       │
│                                                                                                                                                              │
│ 验证结果: 前端API路径与后端Controller路由完全匹配 ✅                                                                                                         │
│                                                                                                                                                              │
│ 数据流说明                                                                                                                                                   │
│                                                                                                                                                              │
│ 1. 前端调用 Java后端 (/api/mobile/{factoryId}/smart-bi/*)                                                                                                    │
│ 2. Java后端调用 Python服务 (http://localhost:8083/api/*)                                                                                                     │
│ 3. 数据存储到 PostgreSQL (SmartBI专用数据源)                                                                                                                 │
│                                                                                                                                                              │
│ 5. 图表渲染问题                                                                                                                                              │
│                                                                                                                                                              │
│ 前端支持3种图表配置格式:                                                                                                                                     │
│ 1. DynamicChartConfig - 新格式 (推荐)                                                                                                                        │
│ 2. DashboardChartConfig - 仪表板格式                                                                                                                         │
│ 3. LegacyChartConfig - 旧格式                                                                                                                                │
│                                                                                                                                                              │
│ 核心渲染组件: DynamicChartRenderer.vue                                                                                                                       │
│ - 自动检测配置格式                                                                                                                                           │
│ - 基于ECharts渲染                                                                                                                                            │
│ - 支持resize自适应                                                                                                                                           │
│                                                                                                                                                              │
│ ---                                                                                                                                                          │
│ 系统动态性分析 🔍                                                                                                                                            │
│                                                                                                                                                              │
│ 动态部分 ✅                                                                                                                                                  │
│ ┌────────────────┬──────────────────────────┐                                                                                                                │
│ │      组件      │           说明           │                                                                                                                │
│ ├────────────────┼──────────────────────────┤                                                                                                                │
│ │ Python字段检测 │ LLM驱动，真正动态        │                                                                                                                │
│ ├────────────────┼──────────────────────────┤                                                                                                                │
│ │ 前端组件       │ 零硬编码，完全动态渲染   │                                                                                                                │
│ ├────────────────┼──────────────────────────┤                                                                                                                │
│ │ Excel上传      │ 自动检测表头，无必需字段 │                                                                                                                │
│ └────────────────┴──────────────────────────┘                                                                                                                │
│ 半动态 ⚠️                                                                                                                                                    │
│ ┌──────────────────┬─────────────────────────────────────┐                                                                                                   │
│ │       组件       │                说明                 │                                                                                                   │
│ ├──────────────────┼─────────────────────────────────────┤                                                                                                   │
│ │ Java字段映射字典 │ 25+硬编码同义词，但可通过数据库覆盖 │                                                                                                   │
│ ├──────────────────┼─────────────────────────────────────┤                                                                                                   │
│ │ 数据类型映射     │ 有硬编码但支持热加载                │                                                                                                   │
│ └──────────────────┴─────────────────────────────────────┘                                                                                                   │
│ 硬编码问题 ❌ (关键!)                                                                                                                                        │
│ ┌─────────────────────────────┬────────────────────────────────────────────────────┐                                                                         │
│ │            组件             │                        问题                        │                                                                         │
│ ├─────────────────────────────┼────────────────────────────────────────────────────┤                                                                         │
│ │ MetricCalculatorServiceImpl │ 15+指标硬编码需要的字段名("amount", "cost"等)      │                                                                         │
│ ├─────────────────────────────┼────────────────────────────────────────────────────┤                                                                         │
│ │ SalesAnalysisServiceImpl    │ 期望特定字段如"salesperson_name", "monthly_target" │                                                                         │
│ ├─────────────────────────────┼────────────────────────────────────────────────────┤                                                                         │
│ │ 静默失败                    │ 字段不匹配时返回0或null，无警告                    │                                                                         │
│ └─────────────────────────────┴────────────────────────────────────────────────────┘                                                                         │
│ 结论                                                                                                                                                         │
│                                                                                                                                                              │
│ 系统不是完全动态的！ 如果Excel列名与预期字段名不匹配，即使数据流通了，指标也会静默失败。                                                                     │
│                                                                                                                                                              │
│ 硬编码问题的解决方案 🔧                                                                                                                                      │
│                                                                                                                                                              │
│ 问题: MetricCalculatorServiceImpl 硬编码了字段名：                                                                                                           │
│ METRIC_REQUIRED_FIELDS.put(SALES_AMOUNT, Arrays.asList("amount"));                                                                                           │
│ METRIC_REQUIRED_FIELDS.put(GROSS_PROFIT, Arrays.asList("amount", "cost"));                                                                                   │
│                                                                                                                                                              │
│ 解决方案: 通过 SmartBiPgFieldDefinition 动态解析字段名                                                                                                       │
│                                                                                                                                                              │
│ // 修改 MetricCalculatorServiceImpl                                                                                                                          │
│ // 不再硬编码 "amount"，而是查询字段定义找到实际列名                                                                                                         │
│                                                                                                                                                              │
│ public BigDecimal calculateSalesAmount(String factoryId, Long uploadId, List<Map<String, Object>> data) {                                                    │
│     // 1. 查询字段定义                                                                                                                                       │
│     List<SmartBiPgFieldDefinition> fields = fieldDefRepository.findByUploadId(uploadId);                                                                     │
│                                                                                                                                                              │
│     // 2. 找到语义类型为 "AMOUNT" 或 "amount" 的字段                                                                                                         │
│     String actualAmountField = fields.stream()                                                                                                               │
│         .filter(f -> "AMOUNT".equalsIgnoreCase(f.getSemanticType())                                                                                          │
│                   || "amount".equalsIgnoreCase(f.getStandardName()))                                                                                         │
│         .map(SmartBiPgFieldDefinition::getOriginalName)  // 获取Excel原始列名                                                                                │
│         .findFirst()                                                                                                                                         │
│         .orElse(null);                                                                                                                                       │
│                                                                                                                                                              │
│     if (actualAmountField == null) {                                                                                                                         │
│         log.warn("未找到金额字段，无法计算销售额");                                                                                                          │
│         return BigDecimal.ZERO;                                                                                                                              │
│     }                                                                                                                                                        │
│                                                                                                                                                              │
│     // 3. 使用实际列名计算                                                                                                                                   │
│     return data.stream()                                                                                                                                     │
│         .map(row -> extractBigDecimal(row, actualAmountField))                                                                                               │
│         .reduce(BigDecimal.ZERO, BigDecimal::add);                                                                                                           │
│ }                                                                                                                                                            │
│                                                                                                                                                              │
│ 关键修改文件:                                                                                                                                                │
│ - MetricCalculatorServiceImpl.java - 添加动态字段解析                                                                                                        │
│ - SalesAnalysisServiceImpl.java - 添加动态字段解析                                                                                                           │
│                                                                                                                                                              │
│ 这样修改后:                                                                                                                                                  │
│ - 不再硬依赖 "amount", "cost" 等固定字段名                                                                                                                   │
│ - 通过Python服务在上传时检测的语义类型找到实际列名                                                                                                           │
│ - 支持任意Excel列名，只要语义类型正确识别                                                                                                                    │
│                                                                                                                                                              │
│ ---                                                                                                                                                          │
│ 导出文件(CSV/MD/JSON)使用情况                                                                                                                                │
│                                                                                                                                                              │
│ 生成的文件类型:                                                                                                                                              │
│ - JSON: 验证流程使用                                                                                                                                         │
│ - Markdown: LLM输入使用（限50行）                                                                                                                            │
│ - CSV: 用户导出用                                                                                                                                            │
│                                                                                                                                                              │
│ 使用情况:                                                                                                                                                    │
│ - ✅ Python服务内部使用（验证、LLM分析）                                                                                                                     │
│ - ❌ Java后端不读取这些文件                                                                                                                                  │
│ - ❌ 前端不调用导出API                                                                                                                                       │
│                                                                                                                                                              │
│ 结论: 这是正确的架构设计（内存对象驱动，而非文件驱动）。导出文件是可选的调试/外部导出接口，不影响主流程。                                                    │
│                                                                                                                                                              │
│ ---                                                                                                                                                          │
│ 前端图表空白的多个原因                                                                                                                                       │
│                                                                                                                                                              │
│ 原因1: 数据断裂 (已确认)                                                                                                                                     │
│                                                                                                                                                              │
│ Dashboard从空的SmartBiSalesData读取，而数据在smart_bi_dynamic_data                                                                                           │
│                                                                                                                                                              │
│ 原因2: 字段名不匹配                                                                                                                                          │
│                                                                                                                                                              │
│ 即使修复数据断裂，如果Excel列名不是"amount"、"cost"等预期名称，指标计算会失败                                                                                │
│                                                                                                                                                              │
│ 原因3: 图表配置格式混淆                                                                                                                                      │
│                                                                                                                                                              │
│ 前端支持3种图表格式，格式判断有优先级，可能导致错误解析                                                                                                      │
│                                                                                                                                                              │
│ 原因4: chartHasData()过滤严格                                                                                                                                │
│                                                                                                                                                              │
│ series[].data为空或null时，图表被过滤掉                                                                                                                      │
│                                                                                                                                                              │
│ 原因5: 其他可能                                                                                                                                              │
│                                                                                                                                                              │
│ - API路径/factoryId问题                                                                                                                                      │
│ - camelCase vs snake_case不匹配                                                                                                                              │
│ - Token过期/CORS问题                                                                                                                                         │
│                                                                                                                                                              │
│ ---                                                                                                                                                          │
│ 解决方案                                                                                                                                                     │
│                                                                                                                                                              │
│ 方案A: 修改Dashboard服务读取动态数据 (推荐)                                                                                                                  │
│                                                                                                                                                              │
│ 修改 SalesAnalysisServiceImpl 从 smart_bi_dynamic_data 读取数据：                                                                                            │
│                                                                                                                                                              │
│ 修改文件:                                                                                                                                                    │
│ - SalesAnalysisServiceImpl.java - 修改 getSalesOverview() 方法                                                                                               │
│                                                                                                                                                              │
│ 同时需要解决字段名映射:                                                                                                                                      │
│ - 使用 SmartBiPgFieldDefinition 中存储的字段元数据                                                                                                           │
│ - 通过 semanticType 或 standardName 找到实际的JSONB字段名                                                                                                    │
│ - 添加字段别名映射表                                                                                                                                         │
│                                                                                                                                                              │
│ 方案B: Excel上传后同步到固定表                                                                                                                               │
│                                                                                                                                                              │
│ 在Excel上传后，将数据同步到 SmartBiSalesData 等固定表：                                                                                                      │
│                                                                                                                                                              │
│ // 在 ExcelDynamicParserService 或 SmartBIService 中                                                                                                         │
│ // 将 smart_bi_dynamic_data 的数据转换并插入到 smart_bi_sales_data                                                                                           │
│                                                                                                                                                              │
│ 方案C: 直接用Python服务生成Dashboard数据                                                                                                                     │
│                                                                                                                                                              │
│ 让Java后端调用Python服务生成Dashboard数据，而不是自己计算。                                                                                                  │
│                                                                                                                                                              │
│ ---                                                                                                                                                          │
│ 图表分类策略                                                                                                                                                 │
│ ┌──────────────┬─────────────┐                                                                                                                               │
│ │   数据类型   │  推荐图表   │                                                                                                                               │
│ ├──────────────┼─────────────┤                                                                                                                               │
│ │ 时间序列趋势 │ line, area  │                                                                                                                               │
│ ├──────────────┼─────────────┤                                                                                                                               │
│ │ 分类对比     │ bar, column │                                                                                                                               │
│ ├──────────────┼─────────────┤                                                                                                                               │
│ │ 占比分析     │ pie, donut  │                                                                                                                               │
│ ├──────────────┼─────────────┤                                                                                                                               │
│ │ 利润分解     │ waterfall   │                                                                                                                               │
│ ├──────────────┼─────────────┤                                                                                                                               │
│ │ 多维度对比   │ radar       │                                                                                                                               │
│ ├──────────────┼─────────────┤                                                                                                                               │
│ │ KPI展示      │ gauge       │                                                                                                                               │
│ └──────────────┴─────────────┘                                                                                                                               │
│ ---                                                                                                                                                          │
│ 用户确认的选项 ✅                                                                                                                                            │
│                                                                                                                                                              │
│ - 清理范围: 清理全部数据 (从头开始)                                                                                                                          │
│ - PostgreSQL: 已启用                                                                                                                                         │
│ - 图表数量: 全部11个Sheet都生成图表                                                                                                                          │
│                                                                                                                                                              │
│ ---                                                                                                                                                          │
│ 执行计划 (详细步骤)                                                                                                                                          │
│                                                                                                                                                              │
│ Step 0: 修复数据流断裂问题 (核心修复)                                                                                                                        │
│                                                                                                                                                              │
│ 目标数据流:                                                                                                                                                  │
│ Excel上传 → smart_bi_dynamic_data (JSONB)                                                                                                                    │
│                     ↓                                                                                                                                        │
│ Dashboard API → SalesAnalysisServiceImpl (修改后)                                                                                                            │
│                     ↓                                                                                                                                        │
│              检查 dynamic_data (优先) → 转换为Dashboard格式                                                                                                  │
│              回退到 SmartBiSalesData (兼容)                                                                                                                  │
│                                                                                                                                                              │
│ 修改文件: SalesAnalysisServiceImpl.java                                                                                                                      │
│                                                                                                                                                              │
│ 修改内容:                                                                                                                                                    │
│                                                                                                                                                              │
│ 1. 添加新依赖 (构造函数注入):                                                                                                                                │
│   - SmartBiDynamicDataRepository - JSONB查询                                                                                                                 │
│   - SmartBiPgExcelUploadRepository - 获取最新上传                                                                                                            │
│   - SmartBiPgFieldDefinitionRepository - 字段元数据                                                                                                          │
│ 2. 添加字段别名映射:                                                                                                                                         │
│ Map<String, List<String>> FIELD_ALIASES = Map.ofEntries(                                                                                                     │
│     Map.entry("amount", List.of("金额", "销售额", "营业收入", "收入")),                                                                                      │
│     Map.entry("cost", List.of("成本", "cost")),                                                                                                              │
│     Map.entry("profit", List.of("利润", "净利润", "毛利")),                                                                                                  │
│     Map.entry("department", List.of("部门", "分部")),                                                                                                        │
│     ...                                                                                                                                                      │
│ );                                                                                                                                                           │
│ 3. 添加辅助方法:                                                                                                                                             │
│   - getLatestUploadId() - 获取最近成功上传的ID                                                                                                               │
│   - findDynamicFieldName() - 从字段定义或别名查找实际JSONB字段名                                                                                             │
│   - convertDynamicToSalesData() - 将JSONB数据转换为SmartBiSalesData格式                                                                                      │
│   - extractBigDecimal/String/Date() - 数据提取工具方法                                                                                                       │
│ 4. 修改 getSalesOverview() 方法:                                                                                                                             │
│ // 优先从动态数据读取                                                                                                                                        │
│ Optional<Long> latestUploadId = getLatestUploadId(factoryId);                                                                                                │
│ if (latestUploadId.isPresent()) {                                                                                                                            │
│     List<SmartBiDynamicData> dynamicData = dynamicDataRepository                                                                                             │
│         .findByFactoryIdAndUploadId(factoryId, uploadId);                                                                                                    │
│     if (!dynamicData.isEmpty()) {                                                                                                                            │
│         salesData = convertDynamicToSalesData(factoryId, uploadId, dynamicData);                                                                             │
│     }                                                                                                                                                        │
│ }                                                                                                                                                            │
│ // 回退到旧表                                                                                                                                                │
│ if (salesData.isEmpty()) {                                                                                                                                   │
│     salesData = salesDataRepository.findByFactoryIdAndOrderDateBetween(...);                                                                                 │
│ }                                                                                                                                                            │
│ 5. 关键: 字段名动态解析:                                                                                                                                     │
│ // 通过字段定义查找实际JSONB字段名                                                                                                                           │
│ private Optional<String> findDynamicFieldName(Long uploadId, String semanticField) {                                                                         │
│     List<SmartBiPgFieldDefinition> fields = fieldDefRepository.findByUploadId(uploadId);                                                                     │
│     for (SmartBiPgFieldDefinition field : fields) {                                                                                                          │
│         // 匹配 semanticType 或 standardName                                                                                                                 │
│         if (semanticField.equalsIgnoreCase(field.getSemanticType()) ||                                                                                       │
│             semanticField.equalsIgnoreCase(field.getStandardName())) {                                                                                       │
│             return Optional.of(field.getOriginalName()); // 返回Excel原始列名                                                                                │
│         }                                                                                                                                                    │
│     }                                                                                                                                                        │
│     // 回退到别名匹配                                                                                                                                        │
│     return matchByAlias(fields, semanticField);                                                                                                              │
│ }                                                                                                                                                            │
│                                                                                                                                                              │
│ 5. 这解决了字段名不匹配问题：                                                                                                                                │
│   - Python服务在上传时已检测字段类型，存入smart_bi_pg_field_definitions                                                                                      │
│   - Java服务读取时通过语义类型找到实际列名                                                                                                                   │
│   - 不再硬依赖"amount"、"cost"等固定字段名                                                                                                                   │
│                                                                                                                                                              │
│ ---                                                                                                                                                          │
│ Step 1: 清理PostgreSQL SmartBI数据                                                                                                                           │
│                                                                                                                                                              │
│ -- 连接到PostgreSQL数据库                                                                                                                                    │
│ -- 数据库: smartbi_db (或主数据库，取决于配置)                                                                                                               │
│                                                                                                                                                              │
│ -- 1. 清理动态数据 (最大的表)                                                                                                                                │
│ TRUNCATE TABLE smart_bi_dynamic_data CASCADE;                                                                                                                │
│                                                                                                                                                              │
│ -- 2. 清理字段定义                                                                                                                                           │
│ TRUNCATE TABLE smart_bi_pg_field_definitions CASCADE;                                                                                                        │
│                                                                                                                                                              │
│ -- 3. 清理分析结果缓存                                                                                                                                       │
│ TRUNCATE TABLE smart_bi_pg_analysis_results CASCADE;                                                                                                         │
│                                                                                                                                                              │
│ -- 4. 清理上传记录                                                                                                                                           │
│ TRUNCATE TABLE smart_bi_pg_excel_uploads CASCADE;                                                                                                            │
│                                                                                                                                                              │
│ -- 5. 验证清理结果                                                                                                                                           │
│ SELECT 'smart_bi_dynamic_data' as table_name, COUNT(*) as count FROM smart_bi_dynamic_data                                                                   │
│ UNION ALL                                                                                                                                                    │
│ SELECT 'smart_bi_pg_excel_uploads', COUNT(*) FROM smart_bi_pg_excel_uploads                                                                                  │
│ UNION ALL                                                                                                                                                    │
│ SELECT 'smart_bi_pg_field_definitions', COUNT(*) FROM smart_bi_pg_field_definitions                                                                          │
│ UNION ALL                                                                                                                                                    │
│ SELECT 'smart_bi_pg_analysis_results', COUNT(*) FROM smart_bi_pg_analysis_results;                                                                           │
│                                                                                                                                                              │
│ 注意: 如果主数据源也有SmartBI表（非pg前缀的），也需要清理：                                                                                                  │
│ -- 检查是否存在这些表                                                                                                                                        │
│ SELECT table_name FROM information_schema.tables                                                                                                             │
│ WHERE table_name LIKE 'smart_bi_%' AND table_schema = 'public';                                                                                              │
│                                                                                                                                                              │
│ Step 3: 上传Test.xlsx (Python服务)                                                                                                                           │
│                                                                                                                                                              │
│ 调用 Python SmartBI API (端口 8083):                                                                                                                         │
│                                                                                                                                                              │
│ # 方法1: 使用curl上传                                                                                                                                        │
│ curl -X POST "http://localhost:8083/api/excel/auto-parse" \                                                                                                  │
│   -F "file=@smartbi/Test.xlsx" \                                                                                                                             │
│   -F "factory_id=F001" \                                                                                                                                     │
│   -F "persist=true"                                                                                                                                          │
│                                                                                                                                                              │
│ 或使用Python脚本:                                                                                                                                            │
│ import httpx                                                                                                                                                 │
│                                                                                                                                                              │
│ with open("smartbi/Test.xlsx", "rb") as f:                                                                                                                   │
│     response = httpx.post(                                                                                                                                   │
│         "http://localhost:8083/api/excel/auto-parse",                                                                                                        │
│         files={"file": f},                                                                                                                                   │
│         data={"factory_id": "F001", "persist": "true"}                                                                                                       │
│     )                                                                                                                                                        │
│     print(response.json())                                                                                                                                   │
│                                                                                                                                                              │
│ Step 4: 为每个Sheet生成图表配置                                                                                                                              │
│                                                                                                                                                              │
│ 调用 /api/chart/recommend/llm 为每个Sheet生成图表:                                                                                                           │
│                                                                                                                                                              │
│ sheets = [                                                                                                                                                   │
│     "索引", "收入及净利简表",                                                                                                                                │
│     "2025年销售1中心利润表", "2025年中心利润表",                                                                                                             │
│     "2025年江苏分部利润表", "2025年浙江分部利润表",                                                                                                          │
│     "2025年上海分部利润表", "2025年赣皖区域利润表",                                                                                                          │
│     "2025年安徽省区利润表", "2025年江西省区利润表",                                                                                                          │
│     "24年返利明细"                                                                                                                                           │
│ ]                                                                                                                                                            │
│                                                                                                                                                              │
│ for sheet in sheets:                                                                                                                                         │
│     response = httpx.post(                                                                                                                                   │
│         "http://localhost:8083/api/chart/recommend/llm",                                                                                                     │
│         json={"upload_id": upload_id, "sheet_name": sheet}                                                                                                   │
│     )                                                                                                                                                        │
│                                                                                                                                                              │
│ Step 5: 验证前端展示                                                                                                                                         │
│                                                                                                                                                              │
│ 1. 启动前端开发服务器:                                                                                                                                       │
│ cd web-admin && npm run dev                                                                                                                                  │
│ 2. 访问SmartBI仪表板:                                                                                                                                        │
│   - URL: http://localhost:3000/smart-bi/dashboard                                                                                                            │
│   - 登录账号: factory_admin1 / 123456                                                                                                                        │
│ 3. 检查项:                                                                                                                                                   │
│   - KPI卡片显示正确数据                                                                                                                                      │
│   - 图表正常渲染                                                                                                                                             │
│   - AI洞察显示                                                                                                                                               │
│   - 下钻功能可用                                                                                                                                             │
│                                                                                                                                                              │
│ ---                                                                                                                                                          │
│ 关键文件路径                                                                                                                                                 │
│                                                                                                                                                              │
│ 需要修改的文件                                                                                                                                               │
│ ┌─────────────────────────────────────────────────────────────────────┬──────────────────────────┐                                                           │
│ │                                文件                                 │         修改内容         │                                                           │
│ ├─────────────────────────────────────────────────────────────────────┼──────────────────────────┤                                                           │
│ │ backend/java/.../service/smartbi/impl/SalesAnalysisServiceImpl.java │ 主要修改：从动态数据读取 │                                                           │
│ └─────────────────────────────────────────────────────────────────────┴──────────────────────────┘                                                           │
│ 需要参考的文件                                                                                                                                               │
│ ┌──────────────────────────────────────────────────────────────────────────────────────┬───────────────┐                                                     │
│ │                                         文件                                         │     用途      │                                                     │
│ ├──────────────────────────────────────────────────────────────────────────────────────┼───────────────┤                                                     │
│ │ backend/java/.../repository/smartbi/postgres/SmartBiDynamicDataRepository.java       │ JSONB查询方法 │                                                     │
│ ├──────────────────────────────────────────────────────────────────────────────────────┼───────────────┤                                                     │
│ │ backend/java/.../repository/smartbi/postgres/SmartBiPgExcelUploadRepository.java     │ 获取最新上传  │                                                     │
│ ├──────────────────────────────────────────────────────────────────────────────────────┼───────────────┤                                                     │
│ │ backend/java/.../repository/smartbi/postgres/SmartBiPgFieldDefinitionRepository.java │ 字段元数据    │                                                     │
│ ├──────────────────────────────────────────────────────────────────────────────────────┼───────────────┤                                                     │
│ │ backend/java/.../entity/smartbi/postgres/SmartBiDynamicData.java                     │ JSONB实体结构 │                                                     │
│ └──────────────────────────────────────────────────────────────────────────────────────┴───────────────┘                                                     │
│ 前端 (无需修改，仅验证)                                                                                                                                      │
│                                                                                                                                                              │
│ - 仪表板: web-admin/src/views/smartbi/Dashboard.vue                                                                                                          │
│ - 图表渲染: web-admin/src/components/smartbi/DynamicChartRenderer.vue                                                                                        │
│                                                                                                                                                              │
│ ---                                                                                                                                                          │
│ 验证方法                                                                                                                                                     │
│                                                                                                                                                              │
│ 1. 修复后API测试                                                                                                                                             │
│                                                                                                                                                              │
│ # 测试Dashboard API                                                                                                                                          │
│ curl -X GET "http://localhost:10010/api/mobile/F001/smart-bi/dashboard/executive?period=month" \                                                             │
│   -H "Authorization: Bearer {token}"                                                                                                                         │
│                                                                                                                                                              │
│ # 预期结果: kpiCards数组非空，charts对象有图表配置                                                                                                           │
│                                                                                                                                                              │
│ 2. 检查数据库数据                                                                                                                                            │
│                                                                                                                                                              │
│ -- 检查是否有上传记录                                                                                                                                        │
│ SELECT id, file_name, upload_status, row_count                                                                                                               │
│ FROM smart_bi_pg_excel_uploads WHERE factory_id = 'F001';                                                                                                    │
│                                                                                                                                                              │
│ -- 检查动态数据                                                                                                                                              │
│ SELECT COUNT(*) FROM smart_bi_dynamic_data WHERE factory_id = 'F001';                                                                                        │
│                                                                                                                                                              │
│ 3. 前端验证                                                                                                                                                  │
│                                                                                                                                                              │
│ - 登录: factory_admin1 / 123456                                                                                                                              │
│ - 访问: http://localhost:3000/smart-bi/dashboard                                                                                                             │
│ - 检查项:                                                                                                                                                    │
│   - KPI卡片显示数值 (非空)                                                                                                                                   │
│   - 图表正常渲染 (非空白)                                                                                                                                    │
│   - AI洞察显示                                                                                                                                               │
│   - 排行榜有数据                                                                                                                                             │
│                                                                                                                                                              │
│ 4. 日志检查                                                                                                                                                  │
│                                                                                                                                                              │
│ # 在服务器日志中查看                                                                                                                                         │
│ tail -f /www/wwwroot/cretas/cretas-backend.log | grep "dynamic data"                                                                                         │
│                                                                                                                                                              │
│ # 预期看到: "Using dynamic data: X rows from uploadId=Y"                                                                                                     │
│                                                                                                                                                              │
│ ---                                                                                                                                                          │
│ 预期结果                                                                                                                                                     │
│ ┌───────────────┬────────────────────────────┐                                                                                                               │
│ │    检查项     │          预期结果          │                                                                                                               │
│ ├───────────────┼────────────────────────────┤                                                                                                               │
│ │ Excel上传记录 │ 11条 (每Sheet一条)         │                                                                                                               │
│ ├───────────────┼────────────────────────────┤                                                                                                               │
│ │ 动态数据行    │ 约2000+行                  │                                                                                                               │
│ ├───────────────┼────────────────────────────┤                                                                                                               │
│ │ 图表配置      │ 每个利润表3-4个图表        │                                                                                                               │
│ ├───────────────┼────────────────────────────┤                                                                                                               │
│ │ KPI卡片       │ 营业收入、净利润、毛利率等 │                                                                                                               │
│ ├───────────────┼────────────────────────────┤                                                                                                               │
│ │ AI洞察        │ 趋势分析、异常检测         │                                                                                                               │
│ └───────────────┴────────────────────────────┘                                                                                                               │
│ ---                                                                                                                                                          │
│ 并行工作建议                                                                                                                                                 │
│                                                                                                                                                              │
│ Subagent并行: ✅ 适合                                                                                                                                        │
│                                                                                                                                                              │
│ - 多个Sheet的图表生成可以并行                                                                                                                                │
│ - Python服务调用可以并行                                                                                                                                     │
│                                                                                                                                                              │
│ 多Chat窗口并行: ⚠️ 谨慎                                                                                                                                      │
│                                                                                                                                                              │
│ - 后端和前端修复可以并行                                                                                                                                     │
│ - 但需避免同时修改相同文件     