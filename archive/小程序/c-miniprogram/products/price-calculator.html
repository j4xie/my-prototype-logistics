<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ä»·æ ¼è®¡ç®—å™¨ - æº¯æºå•†åŸ</title>

  <!-- CSS -->
  <link rel="stylesheet" href="../../assets/css/variables.css">
  <link rel="stylesheet" href="../../assets/css/common.css">
  <link rel="stylesheet" href="../../assets/css/mobile.css">

  <style>
    .mobile-content {
      padding-bottom: 80px;
    }

    /* äº§å“ä¿¡æ¯å¡ç‰‡ */
    .product-card {
      background: var(--bg-white);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
    }

    .product-header {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .product-image {
      width: 80px;
      height: 80px;
      border-radius: var(--radius-md);
      object-fit: cover;
    }

    .product-info {
      flex: 1;
    }

    .product-name {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
    }

    .product-base-price {
      font-size: var(--font-size-sm);
      color: var(--text-tertiary);
    }

    /* æ•°é‡é€‰æ‹©å™¨ */
    .quantity-section {
      background: var(--bg-white);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
    }

    .section-title {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
    }

    .quantity-selector {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-lg);
      padding: var(--spacing-lg);
      background: var(--bg-gray);
      border-radius: var(--radius-md);
    }

    .qty-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--bg-white);
      border: 1px solid var(--border-color);
      font-size: var(--font-size-xl);
      color: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .qty-btn:active {
      transform: scale(0.95);
      background: var(--primary-color);
      color: var(--text-inverse);
    }

    .qty-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .qty-input {
      width: 120px;
      padding: var(--spacing-md);
      border: 2px solid var(--primary-color);
      border-radius: var(--radius-md);
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      text-align: center;
      color: var(--primary-color);
      outline: none;
    }

    /* ä»·æ ¼æ˜¾ç¤º */
    .price-display {
      background: var(--primary-gradient);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-md);
      text-align: center;
      color: var(--text-inverse);
    }

    .price-label {
      font-size: var(--font-size-sm);
      opacity: 0.9;
      margin-bottom: var(--spacing-xs);
    }

    .price-value {
      font-size: var(--font-size-4xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--spacing-sm);
    }

    .price-unit {
      font-size: var(--font-size-base);
      opacity: 0.8;
    }

    .discount-badge {
      display: inline-block;
      padding: var(--spacing-xs) var(--spacing-md);
      background: var(--ecommerce-vip);
      color: #000;
      border-radius: var(--radius-pill);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-bold);
      margin-top: var(--spacing-sm);
    }

    /* é˜¶æ¢¯ä»·æ ¼è¡¨ */
    .tier-table {
      background: var(--bg-white);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
    }

    .tier-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .tier-item {
      padding: var(--spacing-md);
      background: var(--bg-gray);
      border-radius: var(--radius-md);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all var(--transition-base);
    }

    .tier-item.active {
      background: rgba(102, 126, 234, 0.1);
      border: 2px solid var(--primary-color);
    }

    .tier-qty {
      font-size: var(--font-size-base);
      color: var(--text-secondary);
    }

    .tier-item.active .tier-qty {
      color: var(--primary-color);
      font-weight: var(--font-weight-semibold);
    }

    .tier-price {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
      color: var(--error-color);
    }

    .tier-save {
      font-size: var(--font-size-xs);
      color: var(--success-color);
      margin-left: var(--spacing-sm);
    }

    /* åº•éƒ¨æ“ä½œæ  */
    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 430px;
      background: var(--bg-white);
      padding: var(--spacing-md) var(--spacing-lg);
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: var(--spacing-md);
      z-index: var(--z-index-sticky);
      box-sizing: border-box;
    }

    .action-btn {
      flex: 1;
      padding: var(--spacing-md);
      border-radius: var(--radius-pill);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      border: none;
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .btn-cart {
      background: var(--bg-white);
      border: 1px solid var(--primary-color);
      color: var(--primary-color);
    }

    .btn-buy {
      background: var(--primary-gradient);
      color: var(--text-inverse);
    }

    .action-btn:active {
      transform: scale(0.98);
    }
  </style>
</head>
<body>
  <div class="mobile-container">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="mobile-header">
      <div class="mobile-header-back" onclick="window.history.back()">â†</div>
      <div class="mobile-header-title">ä»·æ ¼è®¡ç®—å™¨</div>
      <div class="mobile-header-action" onclick="Utils.showToast('åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­', 'info')">
        ğŸ“¤
      </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="mobile-content">
      <!-- äº§å“ä¿¡æ¯ -->
      <div class="product-card">
        <div class="product-header">
          <img
            id="productImage"
            src="https://images.unsplash.com/photo-1544551763-46a013bb70d5?w=200"
            alt="äº§å“å›¾ç‰‡"
            class="product-image"
          >
          <div class="product-info">
            <div class="product-name" id="productName">é€Ÿå†»é±¼æ’</div>
            <div class="product-base-price">
              åŸºç¡€ä»·ï¼šÂ¥<span id="basePrice">28.00</span> / ä»¶
            </div>
          </div>
        </div>
      </div>

      <!-- ä»·æ ¼æ˜¾ç¤º -->
      <div class="price-display">
        <div class="price-label">æ€»ä»·</div>
        <div class="price-value">
          Â¥<span id="totalPrice">28.00</span>
        </div>
        <div class="price-unit">
          å•ä»· Â¥<span id="unitPrice">28.00</span> Ã— <span id="displayQty">1</span> ä»¶
        </div>
        <div id="discountInfo" style="display: none;">
          <span class="discount-badge">
            å·²çœ Â¥<span id="savedAmount">0</span>
          </span>
        </div>
      </div>

      <!-- æ•°é‡é€‰æ‹© -->
      <div class="quantity-section">
        <div class="section-title">é€‰æ‹©é‡‡è´­æ•°é‡</div>
        <div class="quantity-selector">
          <button class="qty-btn" id="decreaseBtn" onclick="decreaseQty()">âˆ’</button>
          <input
            type="number"
            class="qty-input"
            id="qtyInput"
            value="1"
            min="1"
            onchange="updatePrice()"
          >
          <button class="qty-btn" onclick="increaseQty()">+</button>
        </div>
      </div>

      <!-- é˜¶æ¢¯ä»·æ ¼è¡¨ -->
      <div class="tier-table">
        <div class="section-title">ğŸ“Š é˜¶æ¢¯ä¼˜æƒ ä»·æ ¼</div>
        <div class="tier-list" id="tierList">
          <!-- é˜¶æ¢¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>

      <!-- æç¤ºä¿¡æ¯ -->
      <div style="padding: var(--spacing-lg); background: rgba(24, 144, 255, 0.1); border-radius: var(--radius-md); margin: 0 var(--spacing-lg) var(--spacing-lg);">
        <div style="font-size: var(--font-size-sm); color: var(--info-color); line-height: 1.6;">
          ğŸ’¡ <strong>æ¸©é¦¨æç¤º</strong><br>
          â€¢ é‡‡è´­æ•°é‡è¶Šå¤šï¼Œå•ä»·è¶Šä¼˜æƒ <br>
          â€¢ æ”¯æŒæ··åˆé‡‡è´­ï¼Œæ»¡è¶³é˜¶æ¢¯æ¡ä»¶å³å¯äº«å—ä¼˜æƒ <br>
          â€¢ ä»·æ ¼å·²å«ç¨ï¼Œå…¨å›½åŒ…é‚®
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <div class="bottom-bar">
      <button class="action-btn btn-cart" onclick="addToCart()">
        åŠ å…¥è´­ç‰©è½¦
      </button>
      <button class="action-btn btn-buy" onclick="buyNow()">
        ç«‹å³è´­ä¹°
      </button>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="../../assets/js/mockData.js"></script>
  <script src="../../assets/js/utils.js"></script>

  <script>
    // ==================== å…¨å±€çŠ¶æ€ ====================
    let currentProduct = null;
    let currentQty = 1;

    // ==================== åˆå§‹åŒ– ====================
    document.addEventListener('DOMContentLoaded', () => {
      loadProduct();
      renderTiers();
      updatePrice();
    });

    // ==================== åŠ è½½äº§å“ä¿¡æ¯ ====================
    function loadProduct() {
      const urlParams = new URLSearchParams(window.location.search);
      const productId = urlParams.get('id') || 1;

      currentProduct = MockDB.products.find(p => p.id == productId);

      if (currentProduct) {
        document.getElementById('productName').textContent = currentProduct.name;
        document.getElementById('productImage').src = currentProduct.images[0];
        document.getElementById('basePrice').textContent = currentProduct.price.base.toFixed(2);
      }
    }

    // ==================== æ¸²æŸ“é˜¶æ¢¯ä»·æ ¼è¡¨ ====================
    function renderTiers() {
      if (!currentProduct) return;

      const tierList = document.getElementById('tierList');
      const tiers = currentProduct.price.tiers || [];

      // æ·»åŠ åŸºç¡€ä»·æ ¼
      const allTiers = [
        { minQty: 1, price: currentProduct.price.base, isBase: true },
        ...tiers
      ];

      tierList.innerHTML = allTiers.map((tier, index) => {
        const savings = index > 0
          ? ((currentProduct.price.base - tier.price) * 100 / currentProduct.price.base).toFixed(0)
          : 0;

        const nextTier = allTiers[index + 1];
        const qtyRange = nextTier
          ? `${tier.minQty} - ${nextTier.minQty - 1}`
          : `${tier.minQty}+`;

        return `
          <div class="tier-item" data-min-qty="${tier.minQty}">
            <div class="tier-qty">
              ${tier.isBase ? 'åŸºç¡€ä»·' : `æ‰¹é‡ä¼˜æƒ `} (${qtyRange} ä»¶)
            </div>
            <div>
              <span class="tier-price">Â¥${tier.price.toFixed(2)}</span>
              ${savings > 0 ? `<span class="tier-save">çœ${savings}%</span>` : ''}
            </div>
          </div>
        `;
      }).join('');

      highlightActiveTier();
    }

    // ==================== é«˜äº®å½“å‰é˜¶æ¢¯ ====================
    function highlightActiveTier() {
      const tierItems = document.querySelectorAll('.tier-item');
      tierItems.forEach(item => {
        item.classList.remove('active');
        const minQty = parseInt(item.dataset.minQty);
        if (currentQty >= minQty) {
          // æ‰¾åˆ°æœ€å¤§çš„æ»¡è¶³æ¡ä»¶çš„é˜¶æ¢¯
          let isActive = true;
          tierItems.forEach(otherItem => {
            const otherMinQty = parseInt(otherItem.dataset.minQty);
            if (otherMinQty > minQty && currentQty >= otherMinQty) {
              isActive = false;
            }
          });
          if (isActive) {
            item.classList.add('active');
          }
        }
      });
    }

    // ==================== å¢åŠ æ•°é‡ ====================
    function increaseQty() {
      currentQty++;
      document.getElementById('qtyInput').value = currentQty;
      updatePrice();
    }

    // ==================== å‡å°‘æ•°é‡ ====================
    function decreaseQty() {
      if (currentQty > 1) {
        currentQty--;
        document.getElementById('qtyInput').value = currentQty;
        updatePrice();
      }
    }

    // ==================== æ›´æ–°ä»·æ ¼ ====================
    function updatePrice() {
      const input = document.getElementById('qtyInput');
      currentQty = parseInt(input.value) || 1;

      if (currentQty < 1) {
        currentQty = 1;
        input.value = 1;
      }

      // æ›´æ–°å‡å°‘æŒ‰é’®çŠ¶æ€
      document.getElementById('decreaseBtn').disabled = currentQty <= 1;

      // è®¡ç®—å•ä»·ï¼ˆæ ¹æ®é˜¶æ¢¯ï¼‰
      let unitPrice = currentProduct.price.base;
      const tiers = currentProduct.price.tiers || [];

      for (const tier of tiers.sort((a, b) => b.minQty - a.minQty)) {
        if (currentQty >= tier.minQty) {
          unitPrice = tier.price;
          break;
        }
      }

      // è®¡ç®—æ€»ä»·å’Œä¼˜æƒ 
      const totalPrice = unitPrice * currentQty;
      const originalPrice = currentProduct.price.base * currentQty;
      const savedAmount = originalPrice - totalPrice;

      // æ›´æ–°æ˜¾ç¤º
      document.getElementById('unitPrice').textContent = unitPrice.toFixed(2);
      document.getElementById('totalPrice').textContent = totalPrice.toFixed(2);
      document.getElementById('displayQty').textContent = currentQty;

      // æ˜¾ç¤ºä¼˜æƒ ä¿¡æ¯
      const discountInfo = document.getElementById('discountInfo');
      if (savedAmount > 0) {
        discountInfo.style.display = 'block';
        document.getElementById('savedAmount').textContent = savedAmount.toFixed(2);
      } else {
        discountInfo.style.display = 'none';
      }

      // é«˜äº®å½“å‰é˜¶æ¢¯
      highlightActiveTier();
    }

    // ==================== åŠ å…¥è´­ç‰©è½¦ ====================
    function addToCart() {
      Utils.showToast(`å·²æ·»åŠ  ${currentQty} ä»¶åˆ°è´­ç‰©è½¦`, 'success');
    }

    // ==================== ç«‹å³è´­ä¹° ====================
    function buyNow() {
      const unitPrice = parseFloat(document.getElementById('unitPrice').textContent);
      const totalPrice = parseFloat(document.getElementById('totalPrice').textContent);

      // è·³è½¬åˆ°ç»“ç®—é¡µé¢
      window.location.href = `../orders/checkout.html?productId=${currentProduct.id}&qty=${currentQty}&unitPrice=${unitPrice}&totalPrice=${totalPrice}`;
    }
  </script>
</body>
</html>
