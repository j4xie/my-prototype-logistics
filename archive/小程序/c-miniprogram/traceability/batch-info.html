<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ‰¹æ¬¡æº¯æºä¿¡æ¯ - æº¯æºå•†åŸ</title>

  <!-- CSS -->
  <link rel="stylesheet" href="../../assets/css/variables.css">
  <link rel="stylesheet" href="../../assets/css/common.css">
  <link rel="stylesheet" href="../../assets/css/mobile.css">

  <style>
    /* æ‰¹æ¬¡å¤´éƒ¨ */
    .batch-header {
      background: var(--primary-gradient);
      color: var(--text-inverse);
      padding: var(--spacing-2xl) var(--spacing-lg);
      text-align: center;
    }

    .batch-id {
      font-size: var(--font-size-sm);
      opacity: 0.9;
      margin-bottom: var(--spacing-sm);
      font-family: monospace;
    }

    .batch-product-name {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--spacing-md);
    }

    .batch-meta {
      display: flex;
      justify-content: center;
      gap: var(--spacing-lg);
      font-size: var(--font-size-sm);
      opacity: 0.9;
    }

    .batch-meta-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    /* çŠ¶æ€å¾½ç«  */
    .status-badge {
      display: inline-block;
      padding: var(--spacing-xs) var(--spacing-md);
      border-radius: var(--radius-pill);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      margin-top: var(--spacing-md);
    }

    .status-badge.completed {
      background: rgba(46, 213, 115, 0.2);
      color: var(--ecommerce-safe);
    }

    /* æ—¶é—´çº¿ */
    .timeline-section {
      background: var(--bg-white);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
    }

    .timeline-container {
      position: relative;
      padding: var(--spacing-md) 0;
    }

    .timeline-line {
      position: absolute;
      left: 20px;
      top: 30px;
      bottom: 30px;
      width: 2px;
      background: linear-gradient(180deg, var(--ecommerce-safe) 0%, var(--primary-color) 100%);
    }

    .timeline-item {
      position: relative;
      padding-left: 50px;
      margin-bottom: var(--spacing-2xl);
      cursor: pointer;
    }

    .timeline-item:last-child {
      margin-bottom: 0;
    }

    .timeline-dot {
      position: absolute;
      left: 12px;
      top: 0;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--ecommerce-safe);
      border: 3px solid var(--bg-white);
      box-shadow: 0 0 0 2px var(--ecommerce-safe);
      transition: all var(--transition-base);
    }

    .timeline-item.active .timeline-dot {
      width: 22px;
      height: 22px;
      left: 10px;
      top: -2px;
    }

    .timeline-item.pending .timeline-dot {
      background: var(--bg-gray);
      box-shadow: 0 0 0 2px var(--bg-gray);
    }

    .timeline-content {
      background: var(--bg-gray);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      transition: all var(--transition-base);
    }

    .timeline-item.active .timeline-content,
    .timeline-item:active .timeline-content {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.05) 100%);
      border: 1px solid rgba(102, 126, 234, 0.2);
    }

    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-sm);
    }

    .timeline-title {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
    }

    .timeline-icon {
      font-size: var(--font-size-xl);
    }

    .timeline-time {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
      margin-bottom: var(--spacing-xs);
    }

    .timeline-desc {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .timeline-details {
      margin-top: var(--spacing-md);
      padding-top: var(--spacing-md);
      border-top: 1px solid var(--border-color);
      display: none;
    }

    .timeline-item.expanded .timeline-details {
      display: block;
    }

    .detail-row {
      display: flex;
      padding: var(--spacing-xs) 0;
    }

    .detail-label {
      width: 80px;
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
    }

    .detail-value {
      flex: 1;
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
    }

    /* åŸæ–™ä¿¡æ¯ */
    .materials-section {
      background: var(--bg-white);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
    }

    .material-card {
      background: var(--bg-gray);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .material-card:last-child {
      margin-bottom: 0;
    }

    .material-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-sm);
    }

    .material-name {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
    }

    .material-badge {
      padding: 2px var(--spacing-xs);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
      background: rgba(46, 213, 115, 0.1);
      color: var(--ecommerce-safe);
    }

    .material-info {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      line-height: 1.6;
    }

    /* è´¨æ£€æŠ¥å‘Š */
    .quality-section {
      background: var(--bg-white);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
    }

    .quality-card {
      background: linear-gradient(135deg, rgba(46, 213, 115, 0.05) 0%, rgba(46, 213, 115, 0.02) 100%);
      border: 1px solid rgba(46, 213, 115, 0.2);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .quality-card:last-child {
      margin-bottom: 0;
    }

    .quality-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .quality-title {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
    }

    .quality-result {
      padding: var(--spacing-xs) var(--spacing-md);
      border-radius: var(--radius-pill);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      background: var(--ecommerce-safe);
      color: var(--text-inverse);
    }

    .quality-items {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-md);
    }

    .quality-item {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    .quality-item-label {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
    }

    .quality-item-value {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
    }

    /* è®¤è¯ä¿¡æ¯ */
    .cert-section {
      background: var(--bg-white);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
    }

    .cert-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--spacing-md);
    }

    .cert-item {
      text-align: center;
      padding: var(--spacing-md);
      background: var(--bg-gray);
      border-radius: var(--radius-md);
    }

    .cert-icon {
      font-size: var(--font-size-3xl);
      margin-bottom: var(--spacing-xs);
    }

    .cert-label {
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
    }

    /* åˆ†äº«æŒ‰é’® */
    .share-section {
      background: var(--bg-white);
      padding: var(--spacing-lg);
      margin-bottom: calc(var(--mobile-tabbar-height) + var(--spacing-md));
    }

    .share-btn-large {
      width: 100%;
      padding: var(--spacing-lg);
      background: var(--primary-gradient);
      color: var(--text-inverse);
      border: none;
      border-radius: var(--radius-pill);
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      cursor: pointer;
      box-shadow: var(--shadow-md);
      transition: all var(--transition-base);
    }

    .share-btn-large:active {
      transform: scale(0.98);
      box-shadow: var(--shadow-sm);
    }

    /* ç°åœºå®æ‹ */
    .evidence-section {
      background: var(--bg-white);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
    }
    
    .video-player-placeholder {
      width: 100%;
      height: 200px;
      background: #000;
      border-radius: var(--radius-md);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      overflow: hidden;
      background-image: url('https://images.unsplash.com/photo-1565514020176-892eb1036e62?w=800');
      background-size: cover;
      background-position: center;
    }
    
    .video-player-placeholder::before {
       content: '';
       position: absolute;
       top: 0; left: 0; right: 0; bottom: 0;
       background: rgba(0,0,0,0.4);
    }
    
    .play-icon {
      width: 50px;
      height: 50px;
      background: rgba(255,255,255,0.8);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: var(--primary-color);
      z-index: 2;
    }
    
    .video-overlay {
      position: absolute;
      bottom: 10px;
      left: 10px;
      color: white;
      font-size: 12px;
      z-index: 2;
    }
    
    .evidence-gallery {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    
    .evidence-img {
      width: 100%;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="mobile-container">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="mobile-header">
      <div class="mobile-header-back" onclick="window.history.back()">â†</div>
      <div class="mobile-header-title">æ‰¹æ¬¡æº¯æº</div>
      <div class="mobile-header-action" onclick="handleShare()">ğŸ“¤</div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="mobile-content">
      <!-- æ‰¹æ¬¡å¤´éƒ¨ -->
      <div class="batch-header" id="batchHeader">
        <div class="batch-id">æ‰¹æ¬¡å·: <span id="displayBatchId">åŠ è½½ä¸­...</span></div>
        <h1 class="batch-product-name" id="productName">åŠ è½½ä¸­...</h1>
        <div class="batch-meta">
          <div class="batch-meta-item">
            <span>ğŸ“…</span>
            <span id="productionDate">2025-01-05</span>
          </div>
          <div class="batch-meta-item">
            <span>ğŸ“¦</span>
            <span id="quantity">500kg</span>
          </div>
        </div>
        <div class="status-badge completed" id="statusBadge">âœ“ å·²å®Œæˆ</div>
      </div>
      
      <!-- ç°åœºå®æ‹ (æ–°å¢) -->
      <div class="evidence-section">
        <h2 class="section-title">ğŸ“¹ ç°åœºå®æ‹</h2>
        <!-- æ¨¡æ‹Ÿè§†é¢‘æ’­æ”¾å™¨ -->
        <div class="video-player-placeholder" onclick="playVideo()">
           <div class="play-icon">â–¶</div>
           <div class="video-overlay">ç”Ÿäº§è¿‡ç¨‹ç›‘æ§å®å½• (2025-01-05 10:30)</div>
        </div>
        
        <h3 class="section-title" style="margin-top: 20px; font-size: 14px; border: none; margin-bottom: 10px;">ğŸ“¸ å…³é”®èŠ‚ç‚¹å­˜è¯</h3>
        <div class="evidence-gallery">
           <img src="https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=200" class="evidence-img" onclick="Utils.showToast('æŸ¥çœ‹å¤§å›¾: åŸæ–™æ£€éªŒ', 'info')">
           <img src="https://images.unsplash.com/photo-1581092160562-40aa08e78837?w=200" class="evidence-img" onclick="Utils.showToast('æŸ¥çœ‹å¤§å›¾: åŠ å·¥ç”Ÿäº§', 'info')">
           <img src="https://images.unsplash.com/photo-1581092335397-9583eb92d232?w=200" class="evidence-img" onclick="Utils.showToast('æŸ¥çœ‹å¤§å›¾: æˆå“åŒ…è£…', 'info')">
        </div>
      </div>

      <!-- æ—¶é—´çº¿ -->
      <div class="timeline-section">
        <h2 class="section-title">ğŸ“ ç”Ÿäº§æ—¶é—´çº¿</h2>
        <div class="timeline-container" id="timelineContainer">
          <!-- æ—¶é—´çº¿å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>

      <!-- åŸæ–™ä¿¡æ¯ -->
      <div class="materials-section">
        <h2 class="section-title">ğŸŒ¾ åŸæ–™æº¯æº</h2>
        <div id="materialsContainer">
          <!-- åŸæ–™å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>

      <!-- è´¨æ£€æŠ¥å‘Š -->
      <div class="quality-section">
        <h2 class="section-title">ğŸ”¬ è´¨æ£€æŠ¥å‘Š</h2>
        <div id="qualityContainer">
          <!-- è´¨æ£€æŠ¥å‘Šå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>

      <!-- è®¤è¯ä¿¡æ¯ -->
      <div class="cert-section">
        <h2 class="section-title">âœ“ å®‰å…¨è®¤è¯</h2>
        <div class="cert-grid">
          <div class="cert-item">
            <div class="cert-icon">âœ“</div>
            <div class="cert-label">ISOè®¤è¯</div>
          </div>
          <div class="cert-item">
            <div class="cert-icon">âœ“</div>
            <div class="cert-label">HACCP</div>
          </div>
          <div class="cert-item">
            <div class="cert-icon">âœ“</div>
            <div class="cert-label">FDAè®¤è¯</div>
          </div>
        </div>
      </div>

      <!-- åˆ†äº«æŒ‰é’® -->
      <div class="share-section">
        <button class="share-btn-large" onclick="handleShare()">
          <span>ğŸ“¤</span>
          <span>åˆ†äº«æº¯æºä¿¡æ¯</span>
        </button>
      </div>
    </div>

    <!-- åº•éƒ¨Tabå¯¼èˆª -->
    <div class="mobile-tabbar">
      <div class="tabbar-item" onclick="navigateTo('../home/home.html')">
        <div class="tabbar-icon">ğŸ </div>
        <div class="tabbar-label">é¦–é¡µ</div>
      </div>
      <div class="tabbar-item" onclick="navigateTo('../products/list.html')">
        <div class="tabbar-icon">ğŸ“¦</div>
        <div class="tabbar-label">äº§å“</div>
      </div>
      <div class="tabbar-item" onclick="navigateTo('../orders/list.html')">
        <div class="tabbar-icon">ğŸ§¾</div>
        <div class="tabbar-label">è®¢å•</div>
      </div>
      <div class="tabbar-item" onclick="navigateTo('../profile/index.html')">
        <div class="tabbar-icon">ğŸ‘¤</div>
        <div class="tabbar-label">æˆ‘çš„</div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="../../assets/js/mockData.js"></script>
  <script src="../../assets/js/mockAPI.js"></script>
  <script src="../../assets/js/utils.js"></script>

  <script>
    // ==================== å…¨å±€çŠ¶æ€ ====================
    let currentBatch = null;

    // ==================== åˆå§‹åŒ– ====================
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const batchId = urlParams.get('batchId') || 'FAC001-20250105-001';
      loadBatchInfo(batchId);
    });

    // ==================== åŠ è½½æ‰¹æ¬¡ä¿¡æ¯ ====================
    async function loadBatchInfo(batchId) {
      try {
        const result = await MockAPI.request('traceability.batch', {
          batchId: batchId,
          skipError: true
        });

        currentBatch = result.data;

        renderBatchHeader();
        renderTimeline();
        renderMaterials();
        renderQualityReports();

      } catch (error) {
        console.error('åŠ è½½æ‰¹æ¬¡ä¿¡æ¯å¤±è´¥:', error);
        Utils.showToast('åŠ è½½æ‰¹æ¬¡ä¿¡æ¯å¤±è´¥', 'error');
      }
    }

    // ==================== æ¸²æŸ“æ‰¹æ¬¡å¤´éƒ¨ ====================
    function renderBatchHeader() {
      document.getElementById('displayBatchId').textContent = currentBatch.batchId;
      document.getElementById('productName').textContent = currentBatch.productName;
      document.getElementById('productionDate').textContent =
        Utils.formatDate(new Date(currentBatch.productionDate), 'YYYY-MM-DD');
      document.getElementById('quantity').textContent = `${currentBatch.quantity}${currentBatch.unit || ''}`;

      // çŠ¶æ€å¾½ç« 
      const statusBadge = document.getElementById('statusBadge');
      if (currentBatch.status === 'completed') {
        statusBadge.className = 'status-badge completed';
        statusBadge.textContent = 'âœ“ å·²å®Œæˆ';
      }
    }

    // ==================== æ¸²æŸ“æ—¶é—´çº¿ ====================
    function renderTimeline() {
      const timelineContainer = document.getElementById('timelineContainer');

      const timelineHtml = currentBatch.timeline.map((item, index) => {
        const isCompleted = item.status === 'completed';
        const isPending = item.status === 'pending';
        const statusClass = isPending ? 'pending' : (isCompleted ? 'active' : '');

        return `
          <div class="timeline-item ${statusClass}" onclick="toggleTimelineItem(${index})">
            <div class="timeline-dot"></div>
            <div class="timeline-content">
              <div class="timeline-header">
                <div class="timeline-title">${item.stage}</div>
                <div class="timeline-icon">${item.icon || 'ğŸ“'}</div>
              </div>
              <div class="timeline-time">${Utils.formatDate(new Date(item.timestamp), 'YYYY-MM-DD HH:mm')}</div>
              <div class="timeline-desc">${item.description || ''}</div>
              ${item.details ? `
                <div class="timeline-details">
                  ${Object.entries(item.details).map(([key, value]) => `
                    <div class="detail-row">
                      <div class="detail-label">${key}</div>
                      <div class="detail-value">${value}</div>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');

      timelineContainer.innerHTML = `
        <div class="timeline-line"></div>
        ${timelineHtml}
      `;
    }

    // ==================== åˆ‡æ¢æ—¶é—´çº¿é¡¹å±•å¼€/æŠ˜å  ====================
    function toggleTimelineItem(index) {
      const timelineItems = document.querySelectorAll('.timeline-item');
      const item = timelineItems[index];

      if (item.classList.contains('expanded')) {
        item.classList.remove('expanded');
      } else {
        // æŠ˜å å…¶ä»–é¡¹
        timelineItems.forEach(i => i.classList.remove('expanded'));
        // å±•å¼€å½“å‰é¡¹
        item.classList.add('expanded');
      }
    }

    // ==================== æ¸²æŸ“åŸæ–™ä¿¡æ¯ ====================
    function renderMaterials() {
      const materialsContainer = document.getElementById('materialsContainer');

      // Use rawMaterials to match mock data structure
      const materials = currentBatch.rawMaterials || currentBatch.materials || [];

      const materialsHtml = materials.map(material => `
        <div class="material-card">
          <div class="material-header">
            <div class="material-name">${material.name}</div>
            <div class="material-badge">âœ“ å·²éªŒè¯</div>
          </div>
          <div class="material-info">
            <div>ä¾›åº”å•†: ${material.supplier}</div>
            <div>äº§åœ°: ${material.origin || '-'}</div>
            <div>æ‰¹æ¬¡å·: ${material.batchId}</div>
            <div>ç”Ÿäº§æ—¥æœŸ: ${material.productionDate || '-'}</div>
            <div>è¿‡æœŸæ—¶é—´: ${material.expiryDate || '-'}</div>
            <div>æ•°é‡: ${material.quantity}${material.unit || 'kg'}</div>
          </div>
        </div>
      `).join('');

      materialsContainer.innerHTML = materialsHtml || '<div style="text-align:center; padding: 20px; color: #999;">æš‚æ— åŸæ–™ä¿¡æ¯</div>';
    }

    // ==================== æ¸²æŸ“è´¨æ£€æŠ¥å‘Š ====================
    function renderQualityReports() {
      const qualityContainer = document.getElementById('qualityContainer');

      const qualityHtml = currentBatch.qualityReports.map(report => `
        <div class="quality-card">
          <div class="quality-header">
            <div class="quality-title">${report.stage}</div>
            <div class="quality-result">${report.result}</div>
          </div>
          <div class="quality-items">
            ${Object.entries(report.tests).map(([key, value]) => `
              <div class="quality-item">
                <div class="quality-item-label">${key}</div>
                <div class="quality-item-value">${value}</div>
              </div>
            `).join('')}
          </div>
          ${report.certificateImage ? `
            <div style="margin-top: 15px; border-top: 1px solid rgba(46, 213, 115, 0.2); padding-top: 10px;">
               <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ğŸ“œ è¯ä¹¦/æŠ¥å‘Šæ–‡ä»¶</div>
               <img src="${report.certificateImage}" style="width: 100px; height: 140px; object-fit: cover; border: 1px solid #eee; border-radius: 4px; cursor: pointer;" onclick="Utils.showToast('æŸ¥çœ‹è¯ä¹¦å¤§å›¾', 'info')">
            </div>
          ` : ''}
        </div>
      `).join('');

      qualityContainer.innerHTML = qualityHtml;
    }

    // ==================== åˆ†äº« ====================
    function handleShare() {
      const shareText = `æˆ‘åœ¨æº¯æºå•†åŸç³»ç»ŸæŸ¥çœ‹äº†ã€${currentBatch.productName}ã€‘çš„å®Œæ•´æº¯æºä¿¡æ¯\n\næ‰¹æ¬¡å·: ${currentBatch.batchId}\nç”Ÿäº§æ—¥æœŸ: ${Utils.formatDate(new Date(currentBatch.productionDate), 'YYYY-MM-DD')}\næ•°é‡: ${currentBatch.quantity}${currentBatch.unit}\n\nå…¨ç¨‹å¯è¿½æº¯ï¼Œå“è´¨æœ‰ä¿éšœï¼`;

      // æ¨¡æ‹Ÿåˆ†äº«
      Utils.confirm(shareText, 'åˆ†äº«æº¯æºä¿¡æ¯').then(confirmed => {
        if (confirmed) {
          Utils.showToast('åˆ†äº«æˆåŠŸ', 'success');
        }
      });
    }

    // ==================== å¯¼èˆªå‡½æ•° ====================
    function navigateTo(path) {
      window.location.href = path;
    }
    
    function playVideo() {
      Utils.showToast('æ­£åœ¨åŠ è½½ç›‘æ§è§†é¢‘...', 'info');
      // å®é™…å¼€å‘ä¸­è¿™é‡Œä¼šå¼¹å‡ºä¸€ä¸ªè§†é¢‘æ’­æ”¾æ¨¡æ€æ¡†æˆ–è·³è½¬åˆ°è§†é¢‘æ’­æ”¾é¡µ
    }
  </script>
</body>
</html>
