<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>登录 - 中国牛产业数智云平台</title>
  <link rel="stylesheet" href="../../assets/css/variables.css">
  <link rel="stylesheet" href="../../assets/css/common.css">
  <link rel="stylesheet" href="../../assets/css/mobile.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* 顶部装饰 */
    .header-decoration {
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      flex-direction: column;
      padding-top: 40px;
    }

    .logo {
      width: 72px;
      height: 72px;
      background: white;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      margin-bottom: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .app-name {
      font-size: 18px;
      font-weight: 600;
      opacity: 0.95;
    }

    /* 登录卡片 */
    .login-card {
      flex: 1;
      background: white;
      border-radius: 24px 24px 0 0;
      margin-top: 20px;
      padding: 32px 24px;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
    }

    .login-title {
      font-size: 24px;
      font-weight: 600;
      color: #212121;
      margin-bottom: 8px;
    }

    .login-subtitle {
      font-size: 14px;
      color: #757575;
      margin-bottom: 32px;
    }

    /* 登录方式切换 */
    .login-tabs {
      display: flex;
      margin-bottom: 24px;
      border-bottom: 1px solid #E0E0E0;
    }

    .login-tab {
      flex: 1;
      padding: 12px 0;
      text-align: center;
      font-size: 15px;
      color: #757575;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
    }

    .login-tab.active {
      color: #2E7D32;
      border-bottom-color: #2E7D32;
      font-weight: 500;
    }

    /* 表单样式 */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      color: #424242;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .input-wrapper {
      position: relative;
    }

    .form-input {
      width: 100%;
      height: 48px;
      padding: 0 16px;
      border: 1px solid #E0E0E0;
      border-radius: 8px;
      font-size: 16px;
      color: #212121;
      background: #FAFAFA;
      transition: all 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: #2E7D32;
      background: white;
      box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
    }

    .form-input.error {
      border-color: #D32F2F;
    }

    .form-input::placeholder {
      color: #BDBDBD;
    }

    /* 带按钮的输入框 */
    .input-with-btn {
      display: flex;
      gap: 12px;
    }

    .input-with-btn .form-input {
      flex: 1;
    }

    .sms-btn {
      width: 110px;
      height: 48px;
      background: #E8F5E9;
      color: #2E7D32;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s;
    }

    .sms-btn:hover {
      background: #C8E6C9;
    }

    .sms-btn:disabled {
      background: #F5F5F5;
      color: #9E9E9E;
      cursor: not-allowed;
    }

    /* 密码显示切换 */
    .password-toggle {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #9E9E9E;
      cursor: pointer;
      font-size: 18px;
    }

    .form-input[type="password"]+.password-toggle::before {
      content: "\F0208";
      font-family: "Material Design Icons";
    }

    .form-input[type="text"]+.password-toggle::before {
      content: "\F0209";
      font-family: "Material Design Icons";
    }

    /* 错误提示 */
    .error-message {
      color: #D32F2F;
      font-size: 12px;
      margin-top: 6px;
      display: none;
    }

    .form-group.has-error .error-message {
      display: block;
    }

    .form-group.has-error .form-input {
      border-color: #D32F2F;
    }

    /* 记住登录 & 忘记密码 */
    .form-options {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .remember-me {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #616161;
      cursor: pointer;
    }

    .remember-me input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #2E7D32;
    }

    .forgot-password {
      font-size: 14px;
      color: #2E7D32;
      text-decoration: none;
    }

    /* 登录按钮 */
    .login-btn {
      width: 100%;
      height: 50px;
      background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(46, 125, 50, 0.4);
    }

    .login-btn:active {
      transform: translateY(0);
    }

    .login-btn:disabled {
      background: #BDBDBD;
      box-shadow: none;
      cursor: not-allowed;
    }

    /* 分隔线 */
    .divider {
      display: flex;
      align-items: center;
      margin: 28px 0;
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #E0E0E0;
    }

    .divider span {
      padding: 0 16px;
      font-size: 13px;
      color: #9E9E9E;
    }

    /* 其他登录方式 */
    .other-login {
      display: flex;
      justify-content: center;
      gap: 32px;
      margin-bottom: 24px;
    }

    .other-login-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .other-login-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #F5F5F5;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: all 0.3s;
    }

    .other-login-icon:hover {
      background: #E0E0E0;
      transform: scale(1.05);
    }

    .other-login-item span {
      font-size: 12px;
      color: #757575;
    }

    /* 注册链接 */
    .register-link {
      text-align: center;
      font-size: 14px;
      color: #757575;
    }

    .register-link a {
      color: #2E7D32;
      text-decoration: none;
      font-weight: 500;
    }

    /* 表单面板切换 */
    .login-form-panel {
      display: none;
    }

    .login-form-panel.active {
      display: block;
    }

    /* Toast 提示 */
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.75);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      display: none;
    }

    .toast.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.9);
      }

      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    /* Loading 状态 */
    .login-btn.loading {
      pointer-events: none;
    }

    .login-btn.loading::after {
      content: '';
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid white;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* 返回按钮 */
    .back-btn {
      position: absolute;
      top: 16px;
      left: 16px;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      text-decoration: none;
      backdrop-filter: blur(4px);
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  </style>
</head>

<body>
  <!-- 返回按钮 -->
  <a href="../../index.html" class="back-btn"><i class="mdi mdi-arrow-left"></i></a>

  <!-- 顶部装饰 -->
  <div class="header-decoration">
    <div class="logo" style="color: #2E7D32;"><i class="mdi mdi-cow"></i></div>
    <div class="app-name">中国牛产业数智云平台</div>
  </div>

  <!-- 登录卡片 -->
  <div class="login-card">
    <h1 class="login-title">欢迎登录</h1>
    <p class="login-subtitle">连接牛产业全链条，助力企业高效发展</p>

    <!-- 登录方式切换 -->
    <div class="login-tabs">
      <div class="login-tab active" data-tab="password">账号密码</div>
      <div class="login-tab" data-tab="sms">短信验证码</div>
    </div>

    <!-- 密码登录表单 -->
    <form id="passwordForm" class="login-form-panel active">
      <div class="form-group">
        <label class="form-label">手机号</label>
        <input type="tel" class="form-input" name="phone" placeholder="请输入手机号" maxlength="11" data-label="手机号" required>
        <div class="error-message">请输入正确的手机号</div>
      </div>

      <div class="form-group">
        <label class="form-label">密码</label>
        <div class="input-wrapper">
          <input type="password" class="form-input" name="password" placeholder="请输入密码" data-label="密码" required>
          <span class="password-toggle" onclick="togglePassword(this)"></span>
        </div>
        <div class="error-message">请输入密码</div>
      </div>

      <div class="form-options">
        <label class="remember-me">
          <input type="checkbox" name="remember" checked>
          <span>7天内免登录</span>
        </label>
        <a href="#" class="forgot-password">忘记密码？</a>
      </div>

      <button type="submit" class="login-btn">登 录</button>
    </form>

    <!-- 验证码登录表单 -->
    <form id="smsForm" class="login-form-panel">
      <div class="form-group">
        <label class="form-label">手机号</label>
        <input type="tel" class="form-input" name="phone" placeholder="请输入手机号" maxlength="11" data-label="手机号" required>
        <div class="error-message">请输入正确的手机号</div>
      </div>

      <div class="form-group">
        <label class="form-label">验证码</label>
        <div class="input-with-btn">
          <input type="text" class="form-input" name="smsCode" placeholder="请输入验证码" maxlength="6" data-label="验证码"
            required>
          <button type="button" class="sms-btn" onclick="sendSmsCode(this)">获取验证码</button>
        </div>
        <div class="error-message">请输入验证码</div>
      </div>

      <div class="form-options">
        <label class="remember-me">
          <input type="checkbox" name="remember" checked>
          <span>7天内免登录</span>
        </label>
        <a href="#" class="forgot-password">忘记密码？</a>
      </div>

      <button type="submit" class="login-btn">登 录</button>
    </form>

    <!-- 分隔线 -->
    <div class="divider">
      <span>其他方式</span>
    </div>

    <!-- 其他登录方式 -->
    <div class="other-login">
      <div class="other-login-item" onclick="wechatLogin()">
        <div class="other-login-icon" style="background: #07C160; color: white;">
          <i class="mdi mdi-wechat"></i>
        </div>
        <span>微信</span>
      </div>
    </div>

    <!-- 注册链接 -->
    <p class="register-link">
      还没有账号？<a href="register.html">立即入驻</a>
    </p>
  </div>

  <!-- Toast 提示 -->
  <div class="toast" id="toast"></div>

  <!-- JS 引入 -->
  <script src="../../assets/js/utils.js"></script>
  <script src="../../assets/js/formValidator.js"></script>
  <script src="../../assets/js/stateManager.js"></script>
  <script src="../../assets/js/dictionaries.js"></script>
  <script src="../../assets/js/mockData.js"></script>

  <script>
    // ==================== 页面初始化 ====================
    document.addEventListener('DOMContentLoaded', function () {
      initLoginTabs();
      initFormSubmit();
      checkAutoLogin();
    });

    // ==================== Tab切换 ====================
    function initLoginTabs() {
      const tabs = document.querySelectorAll('.login-tab');
      const forms = document.querySelectorAll('.login-form-panel');

      tabs.forEach(tab => {
        tab.addEventListener('click', function () {
          const targetTab = this.dataset.tab;

          // 切换Tab激活状态
          tabs.forEach(t => t.classList.remove('active'));
          this.classList.add('active');

          // 切换表单面板
          forms.forEach(form => {
            form.classList.remove('active');
            if (form.id === targetTab + 'Form') {
              form.classList.add('active');
            }
          });
        });
      });
    }

    // ==================== 表单提交 ====================
    function initFormSubmit() {
      // 密码登录
      document.getElementById('passwordForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        await handlePasswordLogin(this);
      });

      // 验证码登录
      document.getElementById('smsForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        await handleSmsLogin(this);
      });
    }

    // 密码登录处理
    async function handlePasswordLogin(form) {
      const phone = form.phone.value.trim();
      const password = form.password.value;
      const remember = form.remember.checked;

      // 验证手机号
      if (!validatePhone(phone)) {
        showFormError(form.phone, '请输入正确的手机号');
        return;
      }

      // 验证密码
      if (!password) {
        showFormError(form.password, '请输入密码');
        return;
      }

      // 显示loading
      const btn = form.querySelector('.login-btn');
      btn.classList.add('loading');
      btn.textContent = '登录中';

      // 模拟登录请求
      await Utils.sleep(1500);

      // 查找用户（模拟验证）
      const user = MockData.USERS.find(u => u.phone === phone);

      if (user) {
        // 登录成功
        handleLoginSuccess(user, remember);
      } else {
        // 模拟：任意手机号+密码123456可登录
        if (password === '123456') {
          const mockUser = {
            id: 'USER_NEW',
            phone: phone,
            name: '新用户',
            enterpriseId: null,
            role: 'user'
          };
          handleLoginSuccess(mockUser, remember);
        } else {
          showToast('手机号或密码错误');
          btn.classList.remove('loading');
          btn.textContent = '登 录';
        }
      }
    }

    // 验证码登录处理
    async function handleSmsLogin(form) {
      const phone = form.phone.value.trim();
      const smsCode = form.smsCode.value.trim();
      const remember = form.remember.checked;

      // 验证手机号
      if (!validatePhone(phone)) {
        showFormError(form.phone, '请输入正确的手机号');
        return;
      }

      // 验证验证码
      if (!smsCode || smsCode.length !== 6) {
        showFormError(form.smsCode, '请输入6位验证码');
        return;
      }

      // 显示loading
      const btn = form.querySelector('.login-btn');
      btn.classList.add('loading');
      btn.textContent = '登录中';

      // 模拟登录请求
      await Utils.sleep(1500);

      // 模拟验证码验证（任意6位数字均可）
      if (/^\d{6}$/.test(smsCode)) {
        const user = MockData.USERS.find(u => u.phone === phone) || {
          id: 'USER_NEW',
          phone: phone,
          name: '新用户',
          enterpriseId: null,
          role: 'user'
        };
        handleLoginSuccess(user, remember);
      } else {
        showToast('验证码错误');
        btn.classList.remove('loading');
        btn.textContent = '登 录';
      }
    }

    // 登录成功处理
    function handleLoginSuccess(user, remember) {
      // 保存登录状态
      globalState.set('user', user);
      globalState.set('auth.isLoggedIn', true);
      globalState.set('auth.accessToken', 'mock_token_' + Date.now());

      if (remember) {
        globalState.set('auth.rememberUntil', Date.now() + 7 * 24 * 60 * 60 * 1000);
      }

      showToast('登录成功');

      // 跳转到首页
      setTimeout(() => {
        window.location.href = '../home/home.html';
      }, 1000);
    }

    // ==================== 发送验证码 ====================
    function sendSmsCode(btn) {
      const form = btn.closest('form');
      const phone = form.phone.value.trim();

      if (!validatePhone(phone)) {
        showFormError(form.phone, '请输入正确的手机号');
        return;
      }

      // 倒计时
      let seconds = 60;
      btn.disabled = true;
      btn.textContent = seconds + 's后重发';

      const timer = setInterval(() => {
        seconds--;
        if (seconds <= 0) {
          clearInterval(timer);
          btn.disabled = false;
          btn.textContent = '获取验证码';
        } else {
          btn.textContent = seconds + 's后重发';
        }
      }, 1000);

      showToast('验证码已发送');
    }

    // ==================== 密码显示切换 ====================
    function togglePassword(toggle) {
      const input = toggle.previousElementSibling;
      if (input.type === 'password') {
        input.type = 'text';
      } else {
        input.type = 'password';
      }
    }

    // ==================== 微信登录 ====================
    function wechatLogin() {
      showToast('微信登录功能开发中...');
    }

    // ==================== 自动登录检查 ====================
    function checkAutoLogin() {
      const rememberUntil = globalState.get('auth.rememberUntil');
      const isLoggedIn = globalState.get('auth.isLoggedIn');

      if (isLoggedIn && rememberUntil && Date.now() < rememberUntil) {
        showToast('自动登录中...');
        setTimeout(() => {
          window.location.href = '../home/home.html';
        }, 1000);
      }
    }

    // ==================== 工具函数 ====================
    function validatePhone(phone) {
      return /^1[3-9]\d{9}$/.test(phone);
    }

    function showFormError(input, message) {
      const formGroup = input.closest('.form-group');
      formGroup.classList.add('has-error');
      formGroup.querySelector('.error-message').textContent = message;

      // 聚焦到错误字段
      input.focus();

      // 3秒后清除错误
      setTimeout(() => {
        formGroup.classList.remove('has-error');
      }, 3000);
    }

    function showToast(message, duration = 2000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    // 输入时清除错误状态
    document.querySelectorAll('.form-input').forEach(input => {
      input.addEventListener('input', function () {
        this.closest('.form-group').classList.remove('has-error');
      });
    });
  </script>
</body>

</html>