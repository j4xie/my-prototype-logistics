<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>扫码溯源 - 中国牛产业数智云平台</title>
  <link rel="stylesheet" href="../../assets/css/variables.css">
  <link rel="stylesheet" href="../../assets/css/common.css">
  <link rel="stylesheet" href="../../assets/css/mobile.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background: #000;
      min-height: 100vh;
    }

    /* 顶部Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      padding: 16px;
      padding-top: 48px;
      background: transparent;
      max-width: 428px;
      margin: 0 auto;
    }

    .back-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      text-decoration: none;
      backdrop-filter: blur(4px);
    }

    .header-title {
      flex: 1;
      text-align: center;
      font-size: 17px;
      font-weight: 600;
      color: white;
      margin-right: 36px;
    }

    /* 扫描区域 */
    .scan-area {
      position: relative;
      height: 65vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, #1a1a1a 0%, #000 100%);
    }

    .camera-preview {
      width: 260px;
      height: 260px;
      position: relative;
    }

    /* 扫描框 */
    .scan-frame {
      width: 100%;
      height: 100%;
      position: relative;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      overflow: hidden;
    }

    /* 四个角 */
    .scan-corner {
      position: absolute;
      width: 24px;
      height: 24px;
      border: 3px solid #2E7D32;
    }

    .scan-corner.top-left {
      top: -2px;
      left: -2px;
      border-right: none;
      border-bottom: none;
      border-radius: 8px 0 0 0;
    }

    .scan-corner.top-right {
      top: -2px;
      right: -2px;
      border-left: none;
      border-bottom: none;
      border-radius: 0 8px 0 0;
    }

    .scan-corner.bottom-left {
      bottom: -2px;
      left: -2px;
      border-right: none;
      border-top: none;
      border-radius: 0 0 0 8px;
    }

    .scan-corner.bottom-right {
      bottom: -2px;
      right: -2px;
      border-left: none;
      border-top: none;
      border-radius: 0 0 8px 0;
    }

    /* 扫描线动画 */
    .scan-line {
      position: absolute;
      left: 10%;
      right: 10%;
      height: 2px;
      background: linear-gradient(90deg, transparent 0%, #2E7D32 50%, transparent 100%);
      box-shadow: 0 0 10px rgba(46, 125, 50, 0.8);
      animation: scanMove 2s ease-in-out infinite;
    }

    @keyframes scanMove {
      0% {
        top: 10%;
        opacity: 0;
      }

      10% {
        opacity: 1;
      }

      90% {
        opacity: 1;
      }

      100% {
        top: 90%;
        opacity: 0;
      }
    }

    /* 模拟相机背景 */
    .camera-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: rgba(255, 255, 255, 0.4);
    }

    .camera-placeholder span {
      font-size: 48px;
    }

    .camera-placeholder p {
      font-size: 13px;
    }

    .scan-tip {
      position: absolute;
      bottom: -48px;
      left: 0;
      right: 0;
      text-align: center;
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
    }

    /* 操作按钮区 */
    .action-bar {
      position: absolute;
      bottom: 40px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 60px;
    }

    .action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
    }

    .action-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      backdrop-filter: blur(4px);
      transition: all 0.3s;
    }

    .action-btn:active .action-icon {
      background: rgba(255, 255, 255, 0.25);
      transform: scale(0.95);
    }

    .action-label {
      font-size: 12px;
    }

    /* 底部面板 */
    .bottom-panel {
      background: white;
      border-radius: 24px 24px 0 0;
      min-height: 35vh;
      padding: 24px 20px;
    }

    .panel-handle {
      width: 36px;
      height: 4px;
      background: #E0E0E0;
      border-radius: 2px;
      margin: 0 auto 20px;
    }

    /* 手动输入区 */
    .manual-input-section {
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: #212121;
      margin-bottom: 12px;
    }

    .input-group {
      display: flex;
      gap: 12px;
    }

    .input-wrapper {
      flex: 1;
      position: relative;
    }

    .input-wrapper input {
      width: 100%;
      height: 48px;
      border: 1px solid #E0E0E0;
      border-radius: 12px;
      padding: 0 16px;
      font-size: 15px;
      color: #212121;
      transition: all 0.3s;
    }

    .input-wrapper input:focus {
      outline: none;
      border-color: #2E7D32;
      box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
    }

    .input-wrapper input::placeholder {
      color: #BDBDBD;
    }

    .search-btn {
      height: 48px;
      padding: 0 24px;
      background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }

    .search-btn:active {
      transform: scale(0.98);
    }

    .input-hint {
      font-size: 12px;
      color: #9E9E9E;
      margin-top: 8px;
    }

    /* 历史记录 */
    .history-section {
      margin-top: 24px;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .clear-btn {
      font-size: 13px;
      color: #9E9E9E;
      background: none;
      border: none;
      cursor: pointer;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .history-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #F5F5F5;
      border-radius: 12px;
      text-decoration: none;
      color: inherit;
      transition: all 0.3s;
    }

    .history-item:active {
      background: #EEEEEE;
    }

    .history-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: #E8F5E9;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .history-info {
      flex: 1;
    }

    .history-code {
      font-size: 14px;
      font-weight: 500;
      color: #212121;
    }

    .history-meta {
      font-size: 12px;
      color: #9E9E9E;
      margin-top: 2px;
    }

    .history-arrow {
      color: #BDBDBD;
      font-size: 16px;
    }

    .empty-history {
      text-align: center;
      padding: 24px;
      color: #9E9E9E;
    }

    .empty-history span {
      font-size: 32px;
      display: block;
      margin-bottom: 8px;
    }

    /* 示例码提示 */
    .demo-hint {
      margin-top: 16px;
      padding: 12px 16px;
      background: #FFF8E1;
      border-radius: 12px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .demo-hint-icon {
      font-size: 16px;
    }

    .demo-hint-text {
      flex: 1;
      font-size: 13px;
      color: #F57C00;
      line-height: 1.5;
    }

    .demo-code {
      font-weight: 600;
      color: #E65100;
      cursor: pointer;
      text-decoration: underline;
    }

    /* Toast提示 */
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 14px;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .toast.show {
      opacity: 1;
      visibility: visible;
    }
  </style>
</head>

<body>
  <!-- 顶部Header -->
  <header class="header">
    <a href="javascript:history.back()" class="back-btn"><i class="mdi mdi-arrow-left"></i></a>
    <h1 class="header-title">扫码溯源</h1>
  </header>

  <!-- 扫描区域 -->
  <div class="scan-area">
    <div class="camera-preview">
      <div class="scan-frame">
        <div class="camera-placeholder">
          <span><i class="mdi mdi-camera"></i></span>
          <p>点击下方按钮启用相机</p>
        </div>
        <div class="scan-line"></div>
        <div class="scan-corner top-left"></div>
        <div class="scan-corner top-right"></div>
        <div class="scan-corner bottom-left"></div>
        <div class="scan-corner bottom-right"></div>
      </div>
      <div class="scan-tip">将二维码/条形码放入框内，即可自动扫描</div>
    </div>

    <!-- 操作按钮 -->
    <div class="action-bar">
      <a href="javascript:void(0)" class="action-btn" onclick="toggleFlash()">
        <div class="action-icon" id="flashIcon"><i class="mdi mdi-flashlight"></i></div>
        <span class="action-label">闪光灯</span>
      </a>
      <a href="javascript:void(0)" class="action-btn" onclick="openAlbum()">
        <div class="action-icon"><i class="mdi mdi-image"></i></div>
        <span class="action-label">相册</span>
      </a>
    </div>
  </div>

  <!-- 底部面板 -->
  <div class="bottom-panel">
    <div class="panel-handle"></div>

    <!-- 手动输入 -->
    <div class="manual-input-section">
      <h3 class="section-title">手动输入</h3>
      <div class="input-group">
        <div class="input-wrapper">
          <input type="text" id="traceInput" placeholder="输入溯源码或耳标号">
        </div>
        <button class="search-btn" onclick="searchTrace()">查询</button>
      </div>
      <p class="input-hint">支持输入溯源码（TRACE开头）或动物耳标号（CN开头）</p>

      <!-- 示例码提示 -->
      <div class="demo-hint">
        <span class="demo-hint-icon"><i class="mdi mdi-lightbulb-outline"></i></span>
        <div class="demo-hint-text">
          演示模式：可使用示例码
          <span class="demo-code" onclick="fillDemoCode('TRACE20240615001')">TRACE20240615001</span>
          或耳标号
          <span class="demo-code" onclick="fillDemoCode('CN156150100001')">CN156150100001</span>
          进行体验
        </div>
      </div>
    </div>

    <!-- 历史记录 -->
    <div class="history-section">
      <div class="history-header">
        <h3 class="section-title">扫描历史</h3>
        <button class="clear-btn" onclick="clearHistory()">清空</button>
      </div>
      <div class="history-list" id="historyList">
        <!-- 动态生成 -->
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- JS -->
  <script src="../../assets/js/utils.js"></script>
  <script src="../../assets/js/stateManager.js"></script>
  <script src="../../assets/js/mockData.js"></script>

  <script>
    // ==================== 初始化 ====================
    document.addEventListener('DOMContentLoaded', function () {
      loadHistory();
      initInputEvents();
    });

    // ==================== 扫码相关 ====================
    let flashOn = false;

    function toggleFlash() {
      flashOn = !flashOn;
      const icon = document.getElementById('flashIcon');
      if (flashOn) {
        icon.style.background = 'rgba(255, 200, 0, 0.3)';
        showToast('闪光灯已开启');
      } else {
        icon.style.background = 'rgba(255, 255, 255, 0.15)';
        showToast('闪光灯已关闭');
      }
    }

    function openAlbum() {
      showToast('请选择包含二维码的图片');
      // 在实际应用中，这里会打开相册选择器
      // 演示模式：模拟选择了一张带二维码的图片
      setTimeout(() => {
        const demoCode = 'TRACE20240610002';
        showToast('识别成功！');
        setTimeout(() => {
          navigateToResult(demoCode);
        }, 500);
      }, 1000);
    }

    // ==================== 手动输入 ====================
    function initInputEvents() {
      const input = document.getElementById('traceInput');

      // 回车触发查询
      input.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          searchTrace();
        }
      });
    }

    function searchTrace() {
      const input = document.getElementById('traceInput');
      const code = input.value.trim().toUpperCase();

      if (!code) {
        showToast('请输入溯源码或耳标号');
        return;
      }

      // 验证格式
      if (!code.startsWith('TRACE') && !code.startsWith('CN')) {
        showToast('格式不正确，请检查输入');
        return;
      }

      // 查询数据
      let record = null;
      if (code.startsWith('TRACE')) {
        record = MockData.getTraceByCode(code);
      } else if (code.startsWith('CN')) {
        record = MockData.getTraceByEarTag(code);
      }

      if (!record) {
        showToast('未找到溯源信息');
        return;
      }

      // 保存到历史
      saveToHistory(record);

      // 跳转到结果页
      navigateToResult(record.traceId);
    }

    function fillDemoCode(code) {
      const input = document.getElementById('traceInput');
      input.value = code;
      input.focus();
    }

    // ==================== 历史记录 ====================
    function loadHistory() {
      const history = globalState.get('traceHistory') || [];
      renderHistory(history);
    }

    function renderHistory(history) {
      const container = document.getElementById('historyList');

      if (history.length === 0) {
        container.innerHTML = `
          <div class="empty-history">
            <span><i class="mdi mdi-clipboard-text-outline"></i></span>
            <p>暂无扫描历史</p>
          </div>
        `;
        return;
      }

      container.innerHTML = history.map(item => `
        <a href="result.html?id=${item.traceId}" class="history-item">
          <div class="history-icon"><i class="mdi mdi-cow"></i></div>
          <div class="history-info">
            <div class="history-code">${item.earTag}</div>
            <div class="history-meta">${item.breed} · ${formatTime(item.scanTime)}</div>
          </div>
          <span class="history-arrow"><i class="mdi mdi-chevron-right"></i></span>
        </a>
      `).join('');
    }

    function saveToHistory(record) {
      let history = globalState.get('traceHistory') || [];

      // 检查是否已存在
      const existIndex = history.findIndex(h => h.traceId === record.traceId);
      if (existIndex > -1) {
        history.splice(existIndex, 1);
      }

      // 添加到开头
      history.unshift({
        traceId: record.traceId,
        earTag: record.earTag,
        breed: record.breed,
        scanTime: new Date().toISOString()
      });

      // 最多保留10条
      if (history.length > 10) {
        history = history.slice(0, 10);
      }

      globalState.set('traceHistory', history);
      renderHistory(history);
    }

    function clearHistory() {
      if (confirm('确定要清空扫描历史吗？')) {
        globalState.set('traceHistory', []);
        renderHistory([]);
        showToast('历史已清空');
      }
    }

    // ==================== 页面跳转 ====================
    function navigateToResult(traceId) {
      window.location.href = `result.html?id=${traceId}`;
    }

    // ==================== 工具函数 ====================
    function formatTime(isoString) {
      const date = new Date(isoString);
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) return '刚刚';
      if (diff < 3600000) return Math.floor(diff / 60000) + '分钟前';
      if (diff < 86400000) return Math.floor(diff / 3600000) + '小时前';

      const month = date.getMonth() + 1;
      const day = date.getDate();
      return `${month}月${day}日`;
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2000);
    }
  </script>
</body>

</html>