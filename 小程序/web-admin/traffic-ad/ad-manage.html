<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¹¿å‘Šç®¡ç† - ç™½å©çºªç®¡ç†åå°</title>
  <link rel="stylesheet" href="../../assets/css/variables.css?v=ad_update_1">
  <link rel="stylesheet" href="../../assets/css/common.css?v=ad_update_1">
  <link rel="stylesheet" href="../../assets/css/desktop.css?v=ad_update_1">
  <style>
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
    }
    .page-title {
      font-size: 24px;
      font-weight: 600;
      color: #1a1a1a;
      margin: 0;
    }
    .page-subtitle {
      color: #666;
      font-size: 14px;
      margin-top: 8px;
    }
    .slot-info {
      display: flex;
      gap: 16px;
      margin-top: 12px;
    }
    .slot-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      background: #f5f5f5;
      border-radius: 4px;
      font-size: 13px;
      color: #666;
    }
    .header-actions {
      display: flex;
      gap: 12px;
    }
    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #D4AF37, #B8960C);
      color: #fff;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
    }
    .btn-secondary {
      background: #f5f5f5;
      color: #333;
      border: 1px solid #e0e0e0;
    }
    .btn-secondary:hover {
      background: #e8e8e8;
    }
    .btn-link {
      background: transparent;
      color: #D4AF37;
      padding: 6px 12px;
    }
    .btn-link:hover {
      text-decoration: underline;
    }
    .btn-danger {
      background: transparent;
      color: #ff4d4f;
      padding: 6px 12px;
    }
    .btn-danger:hover {
      background: #fff2f0;
    }

    /* ç­›é€‰æ  */
    .filter-bar {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      padding: 16px 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .filter-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .filter-label {
      font-size: 14px;
      color: #666;
    }
    .filter-select {
      padding: 8px 16px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      background: #fff;
      cursor: pointer;
      min-width: 120px;
    }

    /* å¹¿å‘Šåˆ—è¡¨ */
    .ads-table-container {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      overflow: hidden;
    }
    .ads-table {
      width: 100%;
      border-collapse: collapse;
    }
    .ads-table th,
    .ads-table td {
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }
    .ads-table th {
      background: #fafafa;
      font-weight: 600;
      color: #666;
      font-size: 13px;
    }
    .ads-table tbody tr:hover {
      background: #fafafa;
    }
    .ad-preview {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .ad-thumb {
      width: 80px;
      height: 50px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #f0f0f0;
    }
    .ad-info h4 {
      font-size: 14px;
      font-weight: 500;
      color: #1a1a1a;
      margin: 0 0 4px 0;
    }
    .ad-info p {
      font-size: 12px;
      color: #999;
      margin: 0;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-active {
      background: #e6f7e6;
      color: #52c41a;
    }
    .status-inactive {
      background: #fff2e8;
      color: #fa8c16;
    }
    .status-expired {
      background: #f5f5f5;
      color: #999;
    }
    .date-range {
      font-size: 13px;
      color: #666;
    }
    .stats-cell {
      text-align: center;
    }
    .stats-value {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
    }
    .stats-label {
      font-size: 11px;
      color: #999;
    }
    .actions-cell {
      display: flex;
      gap: 8px;
    }

    /* ç©ºçŠ¶æ€ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    .empty-text {
      font-size: 16px;
      margin-bottom: 20px;
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #f0f0f0;
      border-top-color: #D4AF37;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="desktop-container">
    <div class="desktop-sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">ğŸ¢ ç™½å©çºªç®¡ç†åå°</div>
      </div>
      <nav class="sidebar-nav">
        <a href="../dashboard/overview.html" class="nav-item">
          <span class="icon">ğŸ“Š</span>
          <span class="text">æ§åˆ¶å°</span>
        </a>
        
        <div class="nav-group">
          <div class="nav-group-title" onclick="toggleSidebarGroup(this)">
            <div class="title-wrap">
                <span class="icon">ğŸ“¦</span>
                <span class="text">å•†å“ä¸è®¢å•</span>
            </div>
            <span class="arrow">â–¼</span>
          </div>
          <div class="nav-sub-menu">
            <a href="../product-management/list.html" class="nav-sub-item">å•†å“ç®¡ç†</a>
            <a href="../orders/list.html" class="nav-sub-item">è®¢å•ç®¡ç†</a>
            <a href="../traceability/batch-list.html" class="nav-sub-item">æº¯æºç®¡ç†</a>
          </div>
        </div>

        <div class="nav-group expanded">
          <div class="nav-group-title" onclick="toggleSidebarGroup(this)">
            <div class="title-wrap">
                <span class="icon">ğŸª</span>
                <span class="text">è¿è¥ä¸å†…å®¹</span>
            </div>
            <span class="arrow">â–¼</span>
          </div>
          <div class="nav-sub-menu">
            <a href="../merchant/list.html" class="nav-sub-item">å•†æˆ·ç®¡ç†</a>
            <a href="../user-management/list.html" class="nav-sub-item">ç”¨æˆ·ç®¡ç†</a>
            <a href="../content-control/review-queue.html" class="nav-sub-item">å†…å®¹å®¡æ ¸</a>
            <a href="../traffic-ad/ad-slots.html" class="nav-sub-item active">å¹¿å‘ŠæŠ•æ”¾</a>
          </div>
        </div>

        <div class="nav-group">
          <div class="nav-group-title" onclick="toggleSidebarGroup(this)">
            <div class="title-wrap">
                <span class="icon">ğŸ¤–</span>
                <span class="text">AIä¸è®¾ç½®</span>
            </div>
            <span class="arrow">â–¼</span>
          </div>
          <div class="nav-sub-menu">
            <a href="../ai-knowledge/knowledge-base.html" class="nav-sub-item">AIçŸ¥è¯†åº“</a>
            <a href="../analytics/traffic-stats.html" class="nav-sub-item">æ•°æ®åˆ†æ</a>
          </div>
        </div>
      </nav>
    </div>

    <div class="desktop-main">
      <div class="desktop-header">
        <div class="header-left">
          <div class="breadcrumb">
            <a href="../dashboard/overview.html">é¦–é¡µ</a> / 
            <a href="ad-slots.html">å¹¿å‘Šä½ç®¡ç†</a> / 
            <span id="breadcrumbSlotName">å¹¿å‘Šç®¡ç†</span>
          </div>
        </div>
      </div>
      
      <div class="desktop-content">
        <div class="page-header">
          <div>
            <h1 class="page-title" id="pageTitle">å¹¿å‘Šç®¡ç†</h1>
            <p class="page-subtitle" id="pageSubtitle">ç®¡ç†è¯¥å¹¿å‘Šä½çš„æ‰€æœ‰å¹¿å‘Šå†…å®¹</p>
            <div class="slot-info" id="slotInfo"></div>
          </div>
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="goBack()">â† è¿”å›</button>
            <button class="btn btn-primary" onclick="createAd()">+ æ·»åŠ å¹¿å‘Š</button>
          </div>
        </div>

        <!-- ç­›é€‰æ  -->
        <div class="filter-bar">
          <div class="filter-item">
            <span class="filter-label">çŠ¶æ€ï¼š</span>
            <select class="filter-select" id="statusFilter" onchange="filterAds()">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="active">æŠ•æ”¾ä¸­</option>
              <option value="inactive">å·²æš‚åœ</option>
              <option value="expired">å·²è¿‡æœŸ</option>
            </select>
          </div>
        </div>
        
        <!-- å¹¿å‘Šåˆ—è¡¨ -->
        <div class="ads-table-container">
          <table class="ads-table">
            <thead>
              <tr>
                <th>å¹¿å‘Šå†…å®¹</th>
                <th>æŠ•æ”¾å•†å®¶</th>
                <th>è·³è½¬å•†å“</th>
                <th>æŠ•æ”¾å‘¨æœŸ</th>
                <th>çŠ¶æ€</th>
                <th style="text-align: center;">æ›å…‰é‡</th>
                <th style="text-align: center;">ç‚¹å‡»é‡</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="adsTableBody">
              <tr>
                <td colspan="8">
                  <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>åŠ è½½ä¸­...</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <script src="../../assets/js/mockData.js?v=ad_update_1"></script>
  <script src="../../assets/js/mockAPI.js?v=ad_update_1"></script>
  <script src="../../assets/js/utils.js?v=ad_update_1"></script>

  <script>
    // è·å–URLå‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    const slotId = urlParams.get('slotId');

    let currentSlot = null;
    let allAds = [];

    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      if (!slotId) {
        Utils.showToast('ç¼ºå°‘å¹¿å‘Šä½IDå‚æ•°', 'error');
        setTimeout(() => goBack(), 1500);
        return;
      }
      loadSlotInfo();
      loadAds();
    });

    // åŠ è½½å¹¿å‘Šä½ä¿¡æ¯
    async function loadSlotInfo() {
      try {
        const result = await MockAPI.request('admin.adSlots.detail', { slotId });
        currentSlot = result.data;
        
        document.getElementById('pageTitle').textContent = `${currentSlot.name} - å¹¿å‘Šç®¡ç†`;
        document.getElementById('breadcrumbSlotName').textContent = currentSlot.name;
        document.getElementById('slotInfo').innerHTML = `
          <span class="slot-tag">ğŸ“ å°ºå¯¸: ${currentSlot.size}</span>
          <span class="slot-tag">ğŸ“ ä½ç½®: ${currentSlot.position}</span>
          <span class="slot-tag">ğŸ“Š æœ€å¤§å¹¿å‘Šæ•°: ${currentSlot.maxAds}</span>
        `;
      } catch (error) {
        console.error('åŠ è½½å¹¿å‘Šä½ä¿¡æ¯å¤±è´¥:', error);
      }
    }

    // åŠ è½½å¹¿å‘Šåˆ—è¡¨
    async function loadAds() {
      try {
        const result = await MockAPI.request('admin.ads.list', { slotId });
        allAds = result.data.items || [];
        renderAds(allAds);
      } catch (error) {
        console.error('åŠ è½½å¹¿å‘Šåˆ—è¡¨å¤±è´¥:', error);
        document.getElementById('adsTableBody').innerHTML = `
          <tr>
            <td colspan="8">
              <div class="loading">
                <p style="color: #ff4d4f;">åŠ è½½å¤±è´¥: ${error.message}</p>
                <button class="btn btn-primary" onclick="loadAds()" style="margin-top: 16px;">é‡è¯•</button>
              </div>
            </td>
          </tr>
        `;
      }
    }

    // ç­›é€‰å¹¿å‘Š
    function filterAds() {
      const status = document.getElementById('statusFilter').value;
      const filtered = status ? allAds.filter(ad => ad.status === status) : allAds;
      renderAds(filtered);
    }

    // æ¸²æŸ“å¹¿å‘Šåˆ—è¡¨
    function renderAds(ads) {
      const tbody = document.getElementById('adsTableBody');
      
      if (!ads || ads.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8">
              <div class="empty-state">
                <div class="empty-icon">ğŸ“­</div>
                <p class="empty-text">è¯¥å¹¿å‘Šä½æš‚æ— å¹¿å‘Š</p>
                <button class="btn btn-primary" onclick="createAd()">+ æ·»åŠ ç¬¬ä¸€ä¸ªå¹¿å‘Š</button>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = ads.map(ad => `
        <tr>
          <td>
            <div class="ad-preview">
              <img src="${ad.image}" alt="å¹¿å‘Šå›¾ç‰‡" class="ad-thumb" onerror="this.src='https://via.placeholder.com/80x50?text=No+Image'">
              <div class="ad-info">
                <h4>å¹¿å‘Š #${ad.id}</h4>
                <p>åˆ›å»ºäº ${formatDate(ad.createTime)}</p>
              </div>
            </div>
          </td>
          <td>${ad.merchantName || '-'}</td>
          <td>${ad.productName || '-'}</td>
          <td>
            <div class="date-range">
              ${ad.startTime} è‡³<br>${ad.endTime}
            </div>
          </td>
          <td>
            <span class="status-badge status-${ad.status}">${getStatusText(ad.status)}</span>
          </td>
          <td class="stats-cell">
            <div class="stats-value">${formatNumber(ad.impressions || 0)}</div>
            <div class="stats-label">æ›å…‰</div>
          </td>
          <td class="stats-cell">
            <div class="stats-value">${formatNumber(ad.clicks || 0)}</div>
            <div class="stats-label">ç‚¹å‡»</div>
          </td>
          <td>
            <div class="actions-cell">
              <button class="btn btn-link" onclick="editAd(${ad.id})">ç¼–è¾‘</button>
              <button class="btn btn-link" onclick="toggleAdStatus(${ad.id}, '${ad.status}')">
                ${ad.status === 'active' ? 'æš‚åœ' : 'å¯ç”¨'}
              </button>
              <button class="btn btn-danger" onclick="deleteAd(${ad.id})">åˆ é™¤</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // è·å–çŠ¶æ€æ–‡æœ¬
    function getStatusText(status) {
      const map = {
        'active': 'æŠ•æ”¾ä¸­',
        'inactive': 'å·²æš‚åœ',
        'expired': 'å·²è¿‡æœŸ'
      };
      return map[status] || status;
    }

    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }

    // æ ¼å¼åŒ–æ•°å­—
    function formatNumber(num) {
      if (num >= 10000) {
        return (num / 10000).toFixed(1) + 'ä¸‡';
      }
      return num.toLocaleString();
    }

    // è¿”å›ä¸Šä¸€é¡µ
    function goBack() {
      window.location.href = 'ad-slots.html';
    }

    // åˆ›å»ºå¹¿å‘Š
    function createAd() {
      window.location.href = `ad-edit.html?slotId=${slotId}`;
    }

    // ç¼–è¾‘å¹¿å‘Š
    function editAd(adId) {
      window.location.href = `ad-edit.html?slotId=${slotId}&adId=${adId}`;
    }

    // åˆ‡æ¢å¹¿å‘ŠçŠ¶æ€
    async function toggleAdStatus(adId, currentStatus) {
      const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
      const actionText = newStatus === 'active' ? 'å¯ç”¨' : 'æš‚åœ';
      
      if (!confirm(`ç¡®å®šè¦${actionText}è¿™ä¸ªå¹¿å‘Šå—ï¼Ÿ`)) return;

      try {
        await MockAPI.request('admin.ads.update', { adId, status: newStatus });
        Utils.showToast(`å¹¿å‘Šå·²${actionText}`, 'success');
        loadAds();
      } catch (error) {
        Utils.showToast(`æ“ä½œå¤±è´¥: ${error.message}`, 'error');
      }
    }

    // åˆ é™¤å¹¿å‘Š
    async function deleteAd(adId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¹¿å‘Šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;

      try {
        await MockAPI.request('admin.ads.delete', { adId });
        Utils.showToast('å¹¿å‘Šå·²åˆ é™¤', 'success');
        loadAds();
      } catch (error) {
        Utils.showToast(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
      }
    }
  </script>
</body>
</html>































