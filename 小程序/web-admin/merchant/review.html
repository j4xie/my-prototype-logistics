<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å•†æˆ·å®¡æ ¸ - ç™½å©çºªé£Ÿå“æº¯æºç®¡ç†åå°</title>

  <!-- CSS -->
  <link rel="stylesheet" href="../../assets/css/variables.css">
  <link rel="stylesheet" href="../../assets/css/common.css">
  <link rel="stylesheet" href="../../assets/css/desktop.css">

  <style>
    /* å®¡æ ¸é˜Ÿåˆ— */
    .review-queue {
      background: var(--bg-white);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }

    .queue-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-md);
      border-bottom: 1px solid var(--border-color);
    }

    .queue-title {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
    }

    .queue-tabs {
      display: flex;
      gap: var(--spacing-sm);
    }

    .queue-tab {
      padding: var(--spacing-sm) var(--spacing-lg);
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .queue-tab.active {
      background: var(--primary-color);
      color: var(--text-inverse);
    }

    .queue-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: var(--spacing-md);
    }

    .queue-item {
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .queue-item:hover {
      border-color: var(--primary-color);
      box-shadow: var(--shadow-sm);
    }

    .queue-item.active {
      border-color: var(--primary-color);
      background: rgba(102, 126, 234, 0.05);
    }

    .queue-item-name {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--spacing-xs);
    }

    .queue-item-time {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
    }

    /* å•†æˆ·è¯¦æƒ… */
    .merchant-details {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: var(--spacing-lg);
    }

    .details-card {
      background: var(--bg-white);
      border-radius: var(--radius-lg);
      padding: var(--spacing-2xl);
      box-shadow: var(--shadow-sm);
    }

    .details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-2xl);
      padding-bottom: var(--spacing-md);
      border-bottom: 1px solid var(--border-color);
    }

    .details-title {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
    }

    .details-section {
      margin-bottom: var(--spacing-2xl);
    }

    .details-section:last-child {
      margin-bottom: 0;
    }

    .details-section-title {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
    }

    .details-row {
      display: flex;
      padding: var(--spacing-md) 0;
      border-bottom: 1px solid var(--border-color);
    }

    .details-row:last-child {
      border-bottom: none;
    }

    .details-label {
      width: 120px;
      font-size: var(--font-size-sm);
      color: var(--text-tertiary);
      flex-shrink: 0;
    }

    .details-value {
      flex: 1;
      font-size: var(--font-size-sm);
      color: var(--text-primary);
    }

    /* è¯ä»¶å›¾ç‰‡ */
    .license-image {
      width: 100%;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .license-image:hover {
      box-shadow: var(--shadow-md);
    }

    /* å®¡æ ¸è¡¨å• */
    .review-form {
      background: var(--bg-white);
      border-radius: var(--radius-lg);
      padding: var(--spacing-2xl);
      box-shadow: var(--shadow-sm);
    }

    .form-group {
      margin-bottom: var(--spacing-lg);
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }

    .form-label.required::after {
      content: ' *';
      color: var(--error-color);
    }

    .form-control {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      transition: border-color var(--transition-base);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    .decision-buttons {
      display: flex;
      gap: var(--spacing-md);
    }

    .btn-approve {
      flex: 1;
      padding: var(--spacing-lg);
      background: var(--success-color);
      color: var(--text-inverse);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .btn-approve:hover {
      background: #47a519;
    }

    .btn-reject {
      flex: 1;
      padding: var(--spacing-lg);
      background: var(--error-color);
      color: var(--text-inverse);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .btn-reject:hover {
      background: #d9222c;
    }

    /* å†å²è®°å½• */
    .history-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .history-item {
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--border-color);
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--spacing-xs);
    }

    .history-result {
      font-weight: var(--font-weight-semibold);
    }

    .history-result.approved {
      color: var(--success-color);
    }

    .history-result.rejected {
      color: var(--error-color);
    }

    .history-time {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
    }

    .history-comment {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <!-- æ¡Œé¢ç«¯å®¹å™¨ -->
  <div class="desktop-container">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="desktop-header">
      <div class="desktop-header-left">
        <div class="desktop-logo">ğŸ± ç™½å©çºªé£Ÿå“æº¯æº</div>
      </div>
      <div class="desktop-header-center">
        <div class="desktop-search">
          <input type="text" placeholder="æœç´¢å•†æˆ·ã€äº§å“ã€è®¢å•..." class="desktop-search-input">
          <button class="desktop-search-btn"></button>
        </div>
      </div>
      <div class="desktop-header-right">
        <div class="desktop-header-icon">
          <span>ğŸ””</span>
          <span class="desktop-header-badge">5</span>
        </div>
        <div class="desktop-header-icon">
          <span>âœ‰ï¸</span>
          <span class="desktop-header-badge">12</span>
        </div>
        <div class="desktop-user-menu">
          <div class="desktop-user-avatar"></div>
          <div class="desktop-user-info">
            <div class="desktop-user-name">ç®¡ç†å‘˜</div>
            <div class="desktop-user-role">è¶…çº§ç®¡ç†å‘˜</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¾§è¾¹æ  -->
    <div class="desktop-sidebar">
      <div class="desktop-menu">
        <div class="desktop-menu-item" onclick="navigateTo('../dashboard/overview.html')">
          <span class="desktop-menu-icon"></span>
          <span class="desktop-menu-label">æ€»è§ˆ</span>
        </div>
        <div class="desktop-menu-item active">
          <span class="desktop-menu-icon">ğŸ¢</span>
          <span class="desktop-menu-label">å•†æˆ·ç®¡ç†</span>
        </div>
        <div class="desktop-menu-item" onclick="navigateTo('../product-management/list.html')">
          <span class="desktop-menu-icon"></span>
          <span class="desktop-menu-label">äº§å“ç®¡ç†</span>
        </div>
        <div class="desktop-menu-item" onclick="navigateTo('../content-control/review-queue.html')">
          <span class="desktop-menu-icon"></span>
          <span class="desktop-menu-label">å†…å®¹æ§åˆ¶</span>
        </div>
        <div class="desktop-menu-item">
          <span class="desktop-menu-icon">ğŸ“¢</span>
          <span class="desktop-menu-label">æµé‡å¹¿å‘Š</span>
        </div>
        <div class="desktop-menu-item" onclick="navigateTo('../ai-knowledge/knowledge-base.html')">
          <span class="desktop-menu-icon"></span>
          <span class="desktop-menu-label">AIçŸ¥è¯†åº“</span>
        </div>
        <div class="desktop-menu-item">
          <span class="desktop-menu-icon">ğŸ“ˆ</span>
          <span class="desktop-menu-label">åˆ†æ</span>
        </div>
        <div class="desktop-menu-item">
          <span class="desktop-menu-icon"></span>
          <span class="desktop-menu-label">è®¾ç½®</span>
        </div>
      </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="desktop-main">
      <div class="desktop-content">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="desktop-page-header">
          <div>
            <h1 class="desktop-page-title">å•†æˆ·å®¡æ ¸</h1>
            <p class="desktop-page-subtitle">å®¡æ ¸å¾…å…¥é©»å•†æˆ·</p>
          </div>
          <div class="desktop-page-actions">
            <button class="btn btn-default" onclick="navigateTo('list.html')">â† è¿”å›åˆ—è¡¨</button>
          </div>
        </div>

        <!-- å®¡æ ¸é˜Ÿåˆ— -->
        <div class="review-queue">
          <div class="queue-header">
            <div class="queue-title">å®¡æ ¸é˜Ÿåˆ— (5)</div>
            <div class="queue-tabs">
              <button class="queue-tab active">å¾…å®¡æ ¸</button>
              <button class="queue-tab">å·²é€šè¿‡</button>
              <button class="queue-tab">å·²æ‹’ç»</button>
            </div>
          </div>
          <div class="queue-list" id="queueList">
            <!-- é˜Ÿåˆ—é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>

        <!-- å•†æˆ·è¯¦æƒ…å’Œå®¡æ ¸è¡¨å• -->
        <div class="merchant-details">
          <!-- å•†æˆ·è¯¦æƒ… -->
          <div class="details-card">
            <div class="details-header">
              <div class="details-title">å•†æˆ·è¯¦ç»†ä¿¡æ¯</div>
            </div>

            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="details-section">
              <div class="details-section-title">åŸºæœ¬ä¿¡æ¯</div>
              <div class="details-row">
                <div class="details-label">å…¬å¸åç§°</div>
                <div class="details-value" id="companyName">ä¸Šæµ·é¤é¥®æœ‰é™å…¬å¸</div>
              </div>
              <div class="details-row">
                <div class="details-label">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç </div>
                <div class="details-value" id="creditCode">91310000XXXXXXXXXX</div>
              </div>
              <div class="details-row">
                <div class="details-label">æ³•å®šä»£è¡¨äºº</div>
                <div class="details-value" id="legalPerson">å¼ ä¸‰</div>
              </div>
              <div class="details-row">
                <div class="details-label">å…¬å¸åœ°å€</div>
                <div class="details-value" id="address">ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒºé™†å®¶å˜´ç¯è·¯1000å·</div>
              </div>
            </div>

            <!-- è”ç³»ä¿¡æ¯ -->
            <div class="details-section">
              <div class="details-section-title">è”ç³»ä¿¡æ¯</div>
              <div class="details-row">
                <div class="details-label">è”ç³»äºº</div>
                <div class="details-value" id="contact">æå››</div>
              </div>
              <div class="details-row">
                <div class="details-label">è”ç³»ç”µè¯</div>
                <div class="details-value" id="phone">138****1234</div>
              </div>
              <div class="details-row">
                <div class="details-label">ç”µå­é‚®ç®±</div>
                <div class="details-value" id="email">lisi@example.com</div>
              </div>
            </div>

            <!-- è¥ä¸šæ‰§ç…§ -->
            <div class="details-section">
              <div class="details-section-title">è¥ä¸šæ‰§ç…§</div>
              <img
                src="https://via.placeholder.com/500x300/667eea/ffffff?text=è¥ä¸šæ‰§ç…§"
                alt="è¥ä¸šæ‰§ç…§"
                class="license-image"
                onclick="viewImage(this.src)"
              >
            </div>
          </div>

          <!-- å®¡æ ¸è¡¨å• -->
          <div>
            <div class="review-form">
              <div class="details-header">
                <div class="details-title">å®¡æ ¸æ“ä½œ</div>
              </div>

              <form id="reviewForm">
                <div class="form-group">
                  <label class="form-label required">å®¡æ ¸ç»“æœ</label>
                  <select class="form-control" id="reviewDecision" required>
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="approved">é€šè¿‡</option>
                    <option value="rejected">æ‹’ç»</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label required">å®¡æ ¸æ„è§</label>
                  <textarea
                    class="form-control form-textarea"
                    id="reviewComment"
                    placeholder="è¯·å¡«å†™å®¡æ ¸æ„è§..."
                    required
                  ></textarea>
                </div>

                <div class="decision-buttons">
                  <button type="button" class="btn-approve" onclick="submitReview('approved')">
                    âœ“ å®¡æ ¸é€šè¿‡
                  </button>
                  <button type="button" class="btn-reject" onclick="submitReview('rejected')">
                    âœ• å®¡æ ¸æ‹’ç»
                  </button>
                </div>
              </form>
            </div>

            <!-- å†å²å®¡æ ¸è®°å½• -->
            <div class="review-form" style="margin-top: var(--spacing-lg);">
              <div class="details-header">
                <div class="details-title">å†å²å®¡æ ¸è®°å½•</div>
              </div>
              <div class="history-list" id="historyList">
                <div class="history-item">
                  <div class="history-header">
                    <span class="history-result approved">å®¡æ ¸é€šè¿‡</span>
                    <span class="history-time">2024-12-01 10:30</span>
                  </div>
                  <div class="history-comment">å•†æˆ·èµ„æ–™å®Œæ•´ï¼Œå®¡æ ¸é€šè¿‡</div>
                </div>
                <div class="history-item">
                  <div class="history-header">
                    <span class="history-result rejected">å®¡æ ¸æ‹’ç»</span>
                    <span class="history-time">2024-11-28 15:20</span>
                  </div>
                  <div class="history-comment">è¥ä¸šæ‰§ç…§ç…§ç‰‡ä¸æ¸…æ™°ï¼Œè¯·é‡æ–°ä¸Šä¼ </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="../../assets/js/mockData.js"></script>
  <script src="../../assets/js/mockAPI.js"></script>
  <script src="../../assets/js/utils.js"></script>

  <script>
    // ==================== å…¨å±€çŠ¶æ€ ====================
    let pendingMerchants = [];
    let currentMerchantId = null;

    // ==================== åˆå§‹åŒ– ====================
    document.addEventListener('DOMContentLoaded', () => {
      loadPendingMerchants();
    });

    // ==================== åŠ è½½å¾…å®¡æ ¸å•†æˆ· ====================
    async function loadPendingMerchants() {
      try {
        const result = await MockAPI.request('admin.merchants.list', {
          status: 'pending',
          skipError: true
        });

        pendingMerchants = result.data.filter(m => m.reviewStatus === 'pending');
        renderQueueList();

        // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
        if (pendingMerchants.length > 0) {
          selectMerchant(pendingMerchants[0].id);
        }

      } catch (error) {
        console.error('åŠ è½½å¾…å®¡æ ¸å•†æˆ·å¤±è´¥:', error);
        Utils.showToast('åŠ è½½æ•°æ®å¤±è´¥', 'error');
      }
    }

    // ==================== æ¸²æŸ“é˜Ÿåˆ—åˆ—è¡¨ ====================
    function renderQueueList() {
      const queueList = document.getElementById('queueList');

      if (pendingMerchants.length === 0) {
        queueList.innerHTML = '<div style="text-align: center; padding: var(--spacing-2xl); color: var(--text-tertiary);">æš‚æ— å¾…å®¡æ ¸å•†æˆ·</div>';
        return;
      }

      queueList.innerHTML = pendingMerchants.map(merchant => {
        const isActive = merchant.id === currentMerchantId;
        return `
          <div class="queue-item ${isActive ? 'active' : ''}" onclick="selectMerchant(${merchant.id})">
            <div class="queue-item-name">${merchant.name}</div>
            <div class="queue-item-time">${Utils.formatDate(new Date(merchant.registerTime), 'YYYY-MM-DD HH:mm')}</div>
          </div>
        `;
      }).join('');
    }

    // ==================== é€‰æ‹©å•†æˆ· ====================
    function selectMerchant(id) {
      currentMerchantId = id;
      const merchant = pendingMerchants.find(m => m.id === id);

      if (!merchant) return;

      // æ›´æ–°é˜Ÿåˆ—åˆ—è¡¨é«˜äº®
      renderQueueList();

      // æ›´æ–°å•†æˆ·è¯¦æƒ…
      document.getElementById('companyName').textContent = merchant.name;
      document.getElementById('creditCode').textContent = merchant.creditCode || '91310000XXXXXXXXXX';
      document.getElementById('legalPerson').textContent = merchant.legalPerson || 'å¼ ä¸‰';
      document.getElementById('address').textContent = merchant.address || 'ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒºé™†å®¶å˜´ç¯è·¯1000å·';
      document.getElementById('contact').textContent = merchant.contact;
      document.getElementById('phone').textContent = merchant.phone;
      document.getElementById('email').textContent = merchant.email || 'contact@example.com';

      // é‡ç½®è¡¨å•
      document.getElementById('reviewForm').reset();
    }

    // ==================== æäº¤å®¡æ ¸ ====================
    async function submitReview(decision) {
      const comment = document.getElementById('reviewComment').value.trim();

      if (!comment) {
        Utils.showToast('è¯·å¡«å†™å®¡æ ¸æ„è§', 'warning');
        return;
      }

      const merchant = pendingMerchants.find(m => m.id === currentMerchantId);
      const confirmText = decision === 'approved'
        ? `ç¡®è®¤å®¡æ ¸é€šè¿‡å•†æˆ· "${merchant.name}"ï¼Ÿ`
        : `ç¡®è®¤æ‹’ç»å•†æˆ· "${merchant.name}"ï¼Ÿ`;

      const confirmed = await Utils.confirm(confirmText, 'ç¡®è®¤å®¡æ ¸');

      if (confirmed) {
        const hideLoading = Utils.showLoading('æäº¤å®¡æ ¸ä¸­...');

        try {
          await Utils.sleep(1000);

          // æ›´æ–°å•†æˆ·çŠ¶æ€
          merchant.reviewStatus = decision === 'approved' ? 'active' : 'rejected';
          merchant.reviewComment = comment;
          merchant.reviewTime = new Date().toISOString();

          // ä»å¾…å®¡æ ¸åˆ—è¡¨ç§»é™¤
          pendingMerchants = pendingMerchants.filter(m => m.id !== currentMerchantId);

          hideLoading();
          Utils.showToast('å®¡æ ¸æäº¤æˆåŠŸ', 'success');

          // åˆ·æ–°åˆ—è¡¨
          renderQueueList();

          // é€‰æ‹©ä¸‹ä¸€ä¸ªå•†æˆ·
          if (pendingMerchants.length > 0) {
            selectMerchant(pendingMerchants[0].id);
          } else {
            Utils.showToast('æ‰€æœ‰å•†æˆ·å·²å®¡æ ¸å®Œæ¯•', 'success');
            setTimeout(() => {
              navigateTo('list.html');
            }, 2000);
          }

        } catch (error) {
          hideLoading();
          Utils.showToast('å®¡æ ¸æäº¤å¤±è´¥', 'error');
        }
      }
    }

    // ==================== æŸ¥çœ‹å›¾ç‰‡ ====================
    function viewImage(src) {
      window.open(src, '_blank');
    }

    // ==================== å¯¼èˆªå‡½æ•° ====================
    function navigateTo(path) {
      window.location.href = path;
    }
  </script>
</body>
</html>
