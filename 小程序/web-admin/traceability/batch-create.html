<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–°å»º/ç¼–è¾‘æ‰¹æ¬¡ - ç™½å©çºªé£Ÿå“æº¯æºç®¡ç†åå°</title>
  <link rel="stylesheet" href="../../assets/css/variables.css">
  <link rel="stylesheet" href="../../assets/css/common.css">
  <link rel="stylesheet" href="../../assets/css/desktop.css?v=1765970920">
  <style>
      .form-section {
          background: white;
          padding: 24px;
          border-radius: 8px;
          margin-bottom: 20px;
      }
      .section-title {
          font-size: 18px;
          font-weight: bold;
          margin-bottom: 20px;
          padding-bottom: 10px;
          border-bottom: 1px solid #eee;
      }
      .form-row {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 20px;
          margin-bottom: 15px;
      }
      .form-group label {
          display: block;
          margin-bottom: 5px;
          color: #666;
      }
      .form-control {
          width: 100%;
          padding: 8px;
          border: 1px solid #ddd;
          border-radius: 4px;
      }
      
      /* Dynamic Lists */
      .dynamic-list-item {
          background: #f9f9f9;
          padding: 15px;
          border: 1px solid #eee;
          border-radius: 4px;
          margin-bottom: 10px;
          position: relative;
      }
      .remove-btn {
          position: absolute;
          top: 10px;
          right: 10px;
          color: #ff4d4f;
          cursor: pointer;
          background: none;
          border: none;
      }
      .add-btn {
          width: 100%;
          padding: 10px;
          border: 1px dashed #1890ff;
          color: #1890ff;
          background: #f0f7ff;
          cursor: pointer;
          border-radius: 4px;
      }
  </style>
</head>
<body>
  <div class="desktop-container">
            <div class="desktop-sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">ğŸ¢ ç™½å©çºªç®¡ç†åå°</div>
      </div>
      <nav class="sidebar-nav">
        <a href="../dashboard/overview.html" class="nav-item">
          <span class="icon">ğŸ“Š</span>
          <span class="text">æ§åˆ¶å°</span>
        </a>
        
        <div class="nav-group">
          <div class="nav-group-title" onclick="toggleSidebarGroup(this)">
            <div class="title-wrap">
                <span class="icon">ğŸ“¦</span>
                <span class="text">å•†å“ä¸è®¢å•</span>
            </div>
            <span class="arrow">â–¼</span>
          </div>
          <div class="nav-sub-menu">
            <a href="../product-management/list.html" class="nav-sub-item">å•†å“ç®¡ç†</a>
            <a href="../orders/list.html" class="nav-sub-item">è®¢å•ç®¡ç†</a>
            <a href="../traceability/batch-list.html" class="nav-sub-item">æº¯æºç®¡ç†</a>
          </div>
        </div>

        <div class="nav-group">
          <div class="nav-group-title" onclick="toggleSidebarGroup(this)">
            <div class="title-wrap">
                <span class="icon">ğŸª</span>
                <span class="text">è¿è¥ä¸å†…å®¹</span>
            </div>
            <span class="arrow">â–¼</span>
          </div>
          <div class="nav-sub-menu">
            <a href="../merchant/list.html" class="nav-sub-item">å•†æˆ·ç®¡ç†</a>
            <a href="../user-management/list.html" class="nav-sub-item">ç”¨æˆ·ç®¡ç†</a>
            <a href="../content-control/review-queue.html" class="nav-sub-item">å†…å®¹å®¡æ ¸</a>
            <a href="../traffic-ad/ad-slots.html" class="nav-sub-item">å¹¿å‘ŠæŠ•æ”¾</a>
          </div>
        </div>

        <div class="nav-group">
          <div class="nav-group-title" onclick="toggleSidebarGroup(this)">
            <div class="title-wrap">
                <span class="icon">ğŸ¤–</span>
                <span class="text">AIä¸è®¾ç½®</span>
            </div>
            <span class="arrow">â–¼</span>
          </div>
          <div class="nav-sub-menu">
            <a href="../ai-knowledge/knowledge-base.html" class="nav-sub-item">AIçŸ¥è¯†åº“</a>
            <a href="../analytics/traffic-stats.html" class="nav-sub-item">æ•°æ®åˆ†æ</a>
          </div>
        </div>
      </nav>
    </div>

    <div class="desktop-main">
      <div class="desktop-header">
        <div class="header-title" id="pageTitle">æ–°å»ºæ‰¹æ¬¡</div>
        <div class="header-actions">
           <button class="btn btn-default" onclick="history.back()">å–æ¶ˆ</button>
           <button class="btn btn-primary" onclick="saveBatch()">ä¿å­˜</button>
        </div>
      </div>

      <div class="desktop-content">
          <form id="batchForm">
            <!-- Basic Info -->
            <div class="form-section">
                <div class="section-title">åŸºæœ¬ä¿¡æ¯</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>å…³è”äº§å“</label>
                        <select class="form-control" id="productId" onchange="updateProductName()">
                            <option value="">è¯·é€‰æ‹©äº§å“</option>
                        </select>
                        <input type="hidden" id="productName">
                    </div>
                    <div class="form-group">
                        <label>æ‰¹æ¬¡å· (è‡ªåŠ¨ç”Ÿæˆ)</label>
                        <input type="text" class="form-control" id="batchNumber" placeholder="ä¾‹å¦‚: BATCH-20250101-001">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ç”Ÿäº§æ—¥æœŸ</label>
                        <input type="date" class="form-control" id="productionDate">
                    </div>
                    <div class="form-group">
                        <label>è¿‡æœŸæ—¥æœŸ</label>
                        <input type="date" class="form-control" id="expiryDate">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ç”Ÿäº§æ•°é‡</label>
                        <input type="number" class="form-control" id="quantity">
                    </div>
                    <div class="form-group">
                        <label>å•ä½</label>
                        <input type="text" class="form-control" id="unit" placeholder="ä¾‹å¦‚: ç®±, kg">
                    </div>
                </div>
            </div>

            <!-- Timeline -->
            <div class="form-section">
                <div class="section-title">ç”Ÿäº§æ—¶é—´çº¿</div>
                <div id="timelineList"></div>
                <button type="button" class="add-btn" onclick="addTimelineItem()">+ æ·»åŠ èŠ‚ç‚¹</button>
            </div>

            <!-- Raw Materials -->
            <div class="form-section">
                <div class="section-title">åŸæ–™ä¿¡æ¯</div>
                <div id="materialList"></div>
                <button type="button" class="add-btn" onclick="addMaterialItem()">+ æ·»åŠ åŸæ–™</button>
            </div>

            <!-- Quality Reports -->
            <div class="form-section">
                <div class="section-title">è´¨æ£€æŠ¥å‘Š</div>
                <div id="reportList"></div>
                <button type="button" class="add-btn" onclick="addReportItem()">+ æ·»åŠ æŠ¥å‘Š</button>
            </div>
          </form>
      </div>
    </div>
  </div>

  <script src="../../assets/js/mockData.js?v=1765970807"></script>
  <script src="../../assets/js/utils.js?v=1765970711"></script>
  <script>
    let currentBatch = null;

    document.addEventListener('DOMContentLoaded', () => {
        // Load Products
        const productSelect = document.getElementById('productId');
        MockDB.products.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.name;
            productSelect.appendChild(opt);
        });

        // Check for edit mode
        const params = new URLSearchParams(window.location.search);
        const batchNumber = params.get('batchNumber');
        
        if (batchNumber) {
            document.getElementById('pageTitle').textContent = 'ç¼–è¾‘æ‰¹æ¬¡';
            currentBatch = MockDB.batches.find(b => b.batchNumber === batchNumber);
            if (currentBatch) {
                fillForm(currentBatch);
            }
        } else {
            // New Batch Defaults
            document.getElementById('batchNumber').value = 'BATCH-' + new Date().toISOString().slice(0,10).replace(/-/g,'') + '-' + Math.floor(Math.random()*1000);
        }
    });

    function updateProductName() {
        const select = document.getElementById('productId');
        const text = select.options[select.selectedIndex].text;
        document.getElementById('productName').value = text;
    }

    function fillForm(data) {
        document.getElementById('productId').value = data.productId;
        document.getElementById('productName').value = data.productName;
        document.getElementById('batchNumber').value = data.batchNumber;
        document.getElementById('productionDate').value = data.productionDate;
        document.getElementById('expiryDate').value = data.expiryDate;
        document.getElementById('quantity').value = data.quantity;
        document.getElementById('unit').value = data.unit;

        // Fill dynamic lists
        if (data.timeline) data.timeline.forEach(item => addTimelineItem(item));
        if (data.rawMaterials) data.rawMaterials.forEach(item => addMaterialItem(item));
        if (data.qualityReports) data.qualityReports.forEach(item => addReportItem(item));
    }

    // Dynamic List Helpers
    function createRemoveBtn(parent) {
        return `<button type="button" class="remove-btn" onclick="this.closest('.dynamic-list-item').remove()">åˆ é™¤</button>`;
    }

    function addTimelineItem(data = {}) {
        const div = document.createElement('div');
        div.className = 'dynamic-list-item';
        div.innerHTML = `
            ${createRemoveBtn()}
            <div class="form-row">
                <div class="form-group"><label>èŠ‚ç‚¹åç§°</label><input type="text" class="form-control item-stage" value="${data.stage || ''}"></div>
                <div class="form-group"><label>æ—¶é—´</label><input type="datetime-local" class="form-control item-time" value="${data.timestamp || ''}"></div>
            </div>
            <div class="form-group"><label>æè¿°</label><input type="text" class="form-control item-desc" value="${data.description || ''}"></div>
        `;
        document.getElementById('timelineList').appendChild(div);
    }

    function addMaterialItem(data = {}) {
        const div = document.createElement('div');
        div.className = 'dynamic-list-item';
        div.innerHTML = `
            ${createRemoveBtn()}
            <div class="form-row">
                <div class="form-group"><label>åŸæ–™åç§°</label><input type="text" class="form-control mat-name" value="${data.name || ''}"></div>
                <div class="form-group"><label>ä¾›åº”å•†</label><input type="text" class="form-control mat-supplier" value="${data.supplier || ''}"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>äº§åœ°</label><input type="text" class="form-control mat-origin" value="${data.origin || ''}"></div>
                <div class="form-group"><label>æ‰¹æ¬¡å·</label><input type="text" class="form-control mat-batch" value="${data.batchId || ''}"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>ç”Ÿäº§æ—¥æœŸ</label><input type="date" class="form-control mat-prod" value="${data.productionDate || ''}"></div>
                <div class="form-group"><label>è¿‡æœŸæ—¥æœŸ</label><input type="date" class="form-control mat-exp" value="${data.expiryDate || ''}"></div>
            </div>
        `;
        document.getElementById('materialList').appendChild(div);
    }

    function addReportItem(data = {}) {
        const div = document.createElement('div');
        div.className = 'dynamic-list-item';
        div.innerHTML = `
            ${createRemoveBtn()}
            <div class="form-row">
                <div class="form-group"><label>æŠ¥å‘Šåç§°</label><input type="text" class="form-control rep-stage" value="${data.stage || ''}"></div>
                <div class="form-group"><label>ç»“æœ</label><input type="text" class="form-control rep-result" value="${data.result || ''}"></div>
            </div>
            <div class="form-group"><label>è¯ä¹¦å›¾ç‰‡URL</label><input type="text" class="form-control rep-img" value="${data.certificateImage || ''}"></div>
        `;
        document.getElementById('reportList').appendChild(div);
    }

    function saveBatch() {
        // Collect Data
        const batch = {
            productId: document.getElementById('productId').value,
            productName: document.getElementById('productName').value,
            batchNumber: document.getElementById('batchNumber').value,
            productionDate: document.getElementById('productionDate').value,
            expiryDate: document.getElementById('expiryDate').value,
            quantity: document.getElementById('quantity').value,
            unit: document.getElementById('unit').value,
            status: 'completed', // Mock status
            timeline: [],
            rawMaterials: [],
            qualityReports: []
        };

        // Collect Timeline
        document.querySelectorAll('#timelineList .dynamic-list-item').forEach(el => {
            batch.timeline.push({
                stage: el.querySelector('.item-stage').value,
                timestamp: el.querySelector('.item-time').value,
                description: el.querySelector('.item-desc').value,
                status: 'completed'
            });
        });

        // Collect Materials
        document.querySelectorAll('#materialList .dynamic-list-item').forEach(el => {
            batch.rawMaterials.push({
                name: el.querySelector('.mat-name').value,
                supplier: el.querySelector('.mat-supplier').value,
                origin: el.querySelector('.mat-origin').value,
                batchId: el.querySelector('.mat-batch').value,
                productionDate: el.querySelector('.mat-prod').value,
                expiryDate: el.querySelector('.mat-exp').value
            });
        });

        // Collect Reports
        document.querySelectorAll('#reportList .dynamic-list-item').forEach(el => {
            batch.qualityReports.push({
                stage: el.querySelector('.rep-stage').value,
                result: el.querySelector('.rep-result').value,
                certificateImage: el.querySelector('.rep-img').value,
                tests: {} // Mock
            });
        });

        console.log('Saved Batch:', batch);
        
        // Mock Save to DB
        const idx = MockDB.batches.findIndex(b => b.batchNumber === batch.batchNumber);
        if (idx >= 0) {
            MockDB.batches[idx] = batch;
        } else {
            MockDB.batches.push(batch);
        }

        Utils.showToast('ä¿å­˜æˆåŠŸ', 'success');
        setTimeout(() => window.location.href = 'batch-list.html', 1000);
    }
  </script>
</body>
</html>











