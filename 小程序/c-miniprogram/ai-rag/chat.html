<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AIæ™ºèƒ½é—®ç­” - æº¯æºå•†åŸ</title>

  <!-- CSS -->
  <link rel="stylesheet" href="../../assets/css/variables.css">
  <link rel="stylesheet" href="../../assets/css/common.css">
  <link rel="stylesheet" href="../../assets/css/mobile.css">

  <style>
    .mobile-content {
      padding: 0;
      padding-bottom: 70px;
    }

    /* èŠå¤©åŒºåŸŸ */
    .chat-container {
      padding: var(--spacing-lg);
      min-height: calc(100vh - var(--mobile-header-height) - var(--mobile-tabbar-height) - 70px);
    }

    /* æ¬¢è¿ä¿¡æ¯ */
    .welcome-section {
      text-align: center;
      padding: var(--spacing-3xl) var(--spacing-lg);
    }

    .welcome-icon {
      font-size: var(--font-size-5xl);
      margin-bottom: var(--spacing-md);
    }

    .welcome-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }

    .welcome-subtitle {
      font-size: var(--font-size-sm);
      color: var(--text-tertiary);
      margin-bottom: var(--spacing-2xl);
    }

    /* å¿«æ·é—®é¢˜ */
    .quick-questions {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .quick-question-btn {
      padding: var(--spacing-md) var(--spacing-lg);
      background: var(--bg-white);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      text-align: left;
      cursor: pointer;
      transition: all var(--transition-base);
      box-shadow: var(--shadow-sm);
    }

    .quick-question-btn:active {
      background: var(--bg-gray);
      transform: scale(0.98);
    }

    /* æ¶ˆæ¯åˆ—è¡¨ */
    .messages-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
      padding-bottom: var(--spacing-lg);
    }

    /* æ¶ˆæ¯æ°”æ³¡ */
    .message {
      display: flex;
      gap: var(--spacing-sm);
      animation: messageSlideIn 0.3s ease;
    }

    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary-gradient);
      color: var(--text-inverse);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-lg);
      flex-shrink: 0;
    }

    .message.user .message-avatar {
      background: var(--bg-gray);
    }

    .message-content {
      max-width: 70%;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    .message-bubble {
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      background: var(--bg-white);
      box-shadow: var(--shadow-sm);
      line-height: 1.6;
      font-size: var(--font-size-base);
      color: var(--text-primary);
    }

    .message.user .message-bubble {
      background: var(--primary-gradient);
      color: var(--text-inverse);
      border-radius: var(--radius-md) var(--radius-md) 0 var(--radius-md);
    }

    .message.ai .message-bubble {
      border-radius: var(--radius-md) var(--radius-md) var(--radius-md) 0;
    }

    .message-time {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
      align-self: flex-end;
      padding: 0 var(--spacing-xs);
    }

    .message.user .message-time {
      align-self: flex-start;
    }

    /* æ¶ˆæ¯æ¥æº */
    .message-sources {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-xs);
      margin-top: var(--spacing-xs);
    }

    .source-tag {
      padding: 2px var(--spacing-xs);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
      background: rgba(102, 126, 234, 0.1);
      color: var(--primary-color);
    }

    /* è¾“å…¥ä¸­åŠ¨ç”» */
    .typing-indicator {
      display: flex;
      gap: var(--spacing-xs);
      padding: var(--spacing-md);
      background: var(--bg-white);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      width: fit-content;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-tertiary);
      animation: typingAnimation 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typingAnimation {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.5;
      }
      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }

    /* è¾“å…¥åŒºåŸŸ */
    .input-area {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 430px;
      background: var(--bg-white);
      border-top: 1px solid var(--border-color);
      padding: var(--spacing-md) var(--spacing-lg);
      z-index: var(--z-index-sticky);
      box-sizing: border-box;
    }

    .input-wrapper {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
    }

    .voice-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-gray);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-xl);
      cursor: pointer;
      transition: all var(--transition-base);
      flex-shrink: 0;
    }

    .voice-btn:active {
      background: var(--bg-hover);
      transform: scale(0.95);
    }

    .input-field {
      flex: 1;
      padding: var(--spacing-sm) var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-pill);
      font-size: var(--font-size-base);
      outline: none;
      transition: border-color var(--transition-base);
      max-height: 100px;
      overflow-y: auto;
    }

    .input-field:focus {
      border-color: var(--primary-color);
    }

    .send-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-gradient);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-xl);
      color: var(--text-inverse);
      cursor: pointer;
      transition: all var(--transition-base);
      flex-shrink: 0;
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .send-btn:active:not(:disabled) {
      transform: scale(0.95);
    }
  </style>
</head>
<body>
  <div class="mobile-container">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="mobile-header">
      <div class="mobile-header-back" onclick="window.history.back()">â†</div>
      <div class="mobile-header-title">AIæ™ºèƒ½é—®ç­”</div>
      <div class="mobile-header-action" onclick="clearChat()">ğŸ—‘ï¸</div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="mobile-content">
      <div class="chat-container" id="chatContainer">
        <!-- æ¬¢è¿åŒºåŸŸ -->
        <div class="welcome-section" id="welcomeSection">
          <div class="welcome-icon"></div>
          <div class="welcome-title">AIæ™ºèƒ½åŠ©æ‰‹</div>
          <div class="welcome-subtitle">æˆ‘å¯ä»¥å¸®æ‚¨è§£ç­”å…³äºäº§å“æº¯æºã€è´¨æ£€ã€è®¢è´­ç­‰é—®é¢˜</div>

          <!-- å¿«æ·é—®é¢˜ -->
          <div class="quick-questions">
            <button class="quick-question-btn" onclick="askQuestion('å¦‚ä½•æŸ¥çœ‹äº§å“çš„æº¯æºä¿¡æ¯ï¼Ÿ')">
              å¦‚ä½•æŸ¥çœ‹äº§å“çš„æº¯æºä¿¡æ¯ï¼Ÿ
            </button>
            <button class="quick-question-btn" onclick="askQuestion('é˜¶æ¢¯ä»·æ ¼æ˜¯å¦‚ä½•è®¡ç®—çš„ï¼Ÿ')">
              é˜¶æ¢¯ä»·æ ¼æ˜¯å¦‚ä½•è®¡ç®—çš„ï¼Ÿ
            </button>
            <button class="quick-question-btn" onclick="askQuestion('äº§å“çš„è´¨æ£€æ ‡å‡†æ˜¯ä»€ä¹ˆï¼Ÿ')">
              äº§å“çš„è´¨æ£€æ ‡å‡†æ˜¯ä»€ä¹ˆï¼Ÿ
            </button>
            <button class="quick-question-btn" onclick="askQuestion('å¦‚ä½•ä¸‹å•è´­ä¹°äº§å“ï¼Ÿ')">
              å¦‚ä½•ä¸‹å•è´­ä¹°äº§å“ï¼Ÿ
            </button>
          </div>
        </div>

        <!-- æ¶ˆæ¯åˆ—è¡¨ -->
        <div class="messages-list" id="messagesList" style="display: none;">
          <!-- æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="input-area">
      <div class="input-wrapper">
        <button class="voice-btn" onclick="Utils.showToast('è¯­éŸ³è¾“å…¥åŠŸèƒ½å¼€å‘ä¸­', 'info')">
          ğŸ¤
        </button>
        <input
          type="text"
          class="input-field"
          id="messageInput"
          placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..."
          onkeypress="handleKeyPress(event)"
        >
        <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
          â¤
        </button>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="../../assets/js/mockData.js"></script>
  <script src="../../assets/js/mockAPI.js"></script>
  <script src="../../assets/js/utils.js"></script>

  <script>
    // ==================== å…¨å±€çŠ¶æ€ ====================
    let messages = [];
    let isAITyping = false;
    let isHumanMode = false;

    // ==================== åˆå§‹åŒ– ====================
    document.addEventListener('DOMContentLoaded', () => {
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      
      // æ£€æŸ¥æ˜¯å¦ä¸ºäººå·¥å®¢æœ/ä¾›åº”å•†æ¨¡å¼
      const type = Utils.getUrlParam('type');
      if (type === 'supplier') {
        isHumanMode = true;
        initSupplierMode();
      }

      // ç›‘å¬è¾“å…¥å˜åŒ–ï¼Œå¯ç”¨/ç¦ç”¨å‘é€æŒ‰é’®
      messageInput.addEventListener('input', () => {
        sendBtn.disabled = !messageInput.value.trim();
      });
    });

    function initSupplierMode() {
      // ä¿®æ”¹æ ‡é¢˜
      document.querySelector('.mobile-header-title').textContent = 'è”ç³»ä¾›åº”å•†';
      
      // ä¿®æ”¹æ¬¢è¿è¯­
      document.querySelector('.welcome-title').textContent = 'ä¾›åº”å•†ä¸“å±å®¢æœ';
      document.querySelector('.welcome-subtitle').textContent = 'æ‚¨å¥½ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚è¯·é—®æœ‰ä»€ä¹ˆå…³äºäº§å“çš„é—®é¢˜ï¼Ÿ';
      
      // éšè—AIå¿«æ·é—®é¢˜
      document.querySelector('.quick-questions').style.display = 'none';
      
      // è‡ªåŠ¨å‘é€ä¸€æ¡æ¬¢è¿æ¶ˆæ¯
      setTimeout(() => {
        addMessage('ai', 'æ‚¨å¥½ï¼æˆ‘æ˜¯B&Fä¾›åº”é“¾çš„ä¸“å±å®¢æœä»£è¡¨ã€‚æ”¶åˆ°æ‚¨çš„å’¨è¯¢éœ€æ±‚ï¼Œè¯·é—®å…·ä½“æ˜¯å¯¹å“ªæ¬¾äº§å“æ„Ÿå…´è¶£ï¼Ÿ');
      }, 500);
      
      // éšè—é»˜è®¤æ¬¢è¿é¡µï¼Œç›´æ¥æ˜¾ç¤ºæ¶ˆæ¯åˆ—è¡¨
      document.getElementById('welcomeSection').style.display = 'none';
      document.getElementById('messagesList').style.display = 'flex';
    }

    // ==================== å‘é€æ¶ˆæ¯ ====================
    async function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      const text = messageInput.value.trim();

      if (!text) return;

      // æ¸…ç©ºè¾“å…¥æ¡†
      messageInput.value = '';
      document.getElementById('sendBtn').disabled = true;

      // å‘é€ç”¨æˆ·æ¶ˆæ¯
      await askQuestion(text);
    }

    // ==================== å¿«æ·é—®é¢˜ ====================
    async function askQuestion(question) {
      if (isAITyping) {
        Utils.showToast(isHumanMode ? 'å®¢æœæ­£åœ¨è¾“å…¥...' : 'AIæ­£åœ¨å›å¤ä¸­ï¼Œè¯·ç¨å€™', 'info');
        return;
      }

      // éšè—æ¬¢è¿åŒºåŸŸ
      document.getElementById('welcomeSection').style.display = 'none';
      document.getElementById('messagesList').style.display = 'flex';

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      addMessage('user', question);

      // æ»šåŠ¨åˆ°åº•éƒ¨
      scrollToBottom();

      // æ˜¾ç¤ºè¾“å…¥ä¸­...
      isAITyping = true;
      showTypingIndicator();

      if (isHumanMode) {
        // æ¨¡æ‹Ÿäººå·¥å®¢æœå›å¤
        setTimeout(() => {
           removeTypingIndicator();
           const reply = getHumanReply(question);
           addMessage('ai', reply);
           scrollToBottom();
           isAITyping = false;
        }, 1500);
        return;
      }

      try {
        // è°ƒç”¨AI API
        const result = await MockAPI.request('ai.chat', {
          question,
          userId: 1,
          skipError: true
        });

        // ç§»é™¤è¾“å…¥ä¸­æŒ‡ç¤ºå™¨
        removeTypingIndicator();

        // æ·»åŠ AIå›å¤
        addMessage('ai', result.answer, result.sources);

        // æ»šåŠ¨åˆ°åº•éƒ¨
        scrollToBottom();

      } catch (error) {
        removeTypingIndicator();
        Utils.showToast('AIå›å¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
      } finally {
        isAITyping = false;
      }
    }

    function getHumanReply(question) {
      const q = question.toLowerCase();
      if (q.includes('ä»·') || q.includes('é’±') || q.includes('å¤šå°‘')) {
        return 'å…³äºä»·æ ¼é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®æ‚¨çš„å…·ä½“é‡‡è´­é‡æ¥æ ¸ç®—ã€‚ç›®å‰æˆ‘ä»¬é’ˆå¯¹æ–°å®¢æˆ·æœ‰ä¼˜æƒ æ”¿ç­–ï¼Œè¯·é—®æ‚¨é¢„è®¡çš„æœˆé‡‡è´­é‡å¤§æ¦‚æ˜¯å¤šå°‘ï¼Ÿ';
      }
      if (q.includes('è´§') || q.includes('åº“å­˜') || q.includes('æœ‰å—')) {
        return 'ç›®å‰è¿™æ¬¾äº§å“åº“å­˜å……è¶³ï¼Œç°è´§ç›´å‘ã€‚å¦‚æœæ‚¨éœ€è¦å¤§æ‰¹é‡è®¢è´­ï¼ˆè¶…è¿‡1000ä»¶ï¼‰ï¼Œæˆ‘ä»¬å»ºè®®æ‚¨æå‰3å¤©é¢„è®¢ä»¥ç¡®ä¿äº¤æœŸã€‚';
      }
      if (q.includes('æ ·') || q.includes('å¯„') || q.includes('çœ‹')) {
        return 'æˆ‘ä»¬å¯ä»¥æä¾›æ ·å“å¯„é€æœåŠ¡ï¼Œä»¥ç¡®ä¿æ‚¨å¯¹å“è´¨æ»¡æ„ã€‚è¯·æ‚¨æä¾›ä¸€ä¸‹è¯¦ç»†æ”¶è´§åœ°å€å’Œè”ç³»äººï¼Œæˆ‘ä»¬å®‰æ’é¡ºä¸°å†·é“¾å¯„é€ã€‚';
      }
      if (q.includes('å¥½') || q.includes('è°¢') || q.includes('ok')) {
        return 'ä¸å®¢æ°”ï¼ŒæœŸå¾…ä¸æ‚¨çš„åˆä½œï¼å¦‚æœ‰å…¶ä»–é—®é¢˜éšæ—¶è”ç³»ã€‚';
      }
      return 'æ”¶åˆ°æ‚¨çš„æ¶ˆæ¯ã€‚æˆ‘å·²ç»è®°å½•ä¸‹æ‚¨çš„éœ€æ±‚ï¼Œå¹¶åé¦ˆç»™äº§å“ç»ç†ã€‚ç¨åï¼ˆçº¦10åˆ†é’Ÿå†…ï¼‰ä¼šæœ‰ä¸“äººè‡´ç”µæ‚¨ 139****8096 è¿›è¡Œè¯¦ç»†å¯¹æ¥ï¼Œè¯·ä¿æŒç”µè¯ç•…é€šã€‚';
    }

    // ==================== æ·»åŠ æ¶ˆæ¯ ====================
    function addMessage(sender, text, sources = []) {
      const message = {
        id: Date.now(),
        sender,
        text,
        sources,
        timestamp: new Date()
      };

      messages.push(message);
      renderMessages();
    }

    // ==================== æ¸²æŸ“æ¶ˆæ¯ ====================
    function renderMessages() {
      const messagesList = document.getElementById('messagesList');

      messagesList.innerHTML = messages.map(msg => {
        const isUser = msg.sender === 'user';
        const avatar = isUser ? '' : '';
        const timeStr = Utils.formatDate(msg.timestamp, 'HH:mm');

        return `
          <div class="message ${isUser ? 'user' : 'ai'}">
            <div class="message-avatar">${avatar}</div>
            <div class="message-content">
              <div class="message-bubble">${msg.text}</div>
              ${!isUser && msg.sources && msg.sources.length > 0 ? `
                <div class="message-sources">
                  ${msg.sources.map(source => `
                    <span class="source-tag">ğŸ“š ${source}</span>
                  `).join('')}
                </div>
              ` : ''}
              <div class="message-time">${timeStr}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ==================== æ˜¾ç¤ºè¾“å…¥ä¸­æŒ‡ç¤ºå™¨ ====================
    function showTypingIndicator() {
      const messagesList = document.getElementById('messagesList');

      const typingHtml = `
        <div class="message ai" id="typingIndicator">
          <div class="message-avatar"></div>
          <div class="message-content">
            <div class="typing-indicator">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </div>
        </div>
      `;

      messagesList.insertAdjacentHTML('beforeend', typingHtml);
      scrollToBottom();
    }

    // ==================== ç§»é™¤è¾“å…¥ä¸­æŒ‡ç¤ºå™¨ ====================
    function removeTypingIndicator() {
      const indicator = document.getElementById('typingIndicator');
      if (indicator) {
        indicator.remove();
      }
    }

    // ==================== æ»šåŠ¨åˆ°åº•éƒ¨ ====================
    function scrollToBottom() {
      setTimeout(() => {
        window.scrollTo({
          top: document.body.scrollHeight,
          behavior: 'smooth'
        });
      }, 100);
    }

    // ==================== æ¸…ç©ºèŠå¤© ====================
    function clearChat() {
      Utils.confirm('ç¡®è®¤æ¸…ç©ºèŠå¤©è®°å½•ï¼Ÿ', 'æ¸…ç©ºèŠå¤©').then(confirmed => {
        if (confirmed) {
          messages = [];
          document.getElementById('welcomeSection').style.display = 'block';
          document.getElementById('messagesList').style.display = 'none';
          Utils.showToast('èŠå¤©è®°å½•å·²æ¸…ç©º', 'success');
        }
      });
    }

    // ==================== æŒ‰Enterå‘é€ ====================
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    // ==================== å¯¼èˆªå‡½æ•° ====================
    function navigateTo(path) {
      window.location.href = path;
    }
  </script>
</body>
</html>
