<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æœç´¢ - æº¯æºå•†åŸ</title>

  <!-- CSS -->
  <link rel="stylesheet" href="../../assets/css/variables.css">
  <link rel="stylesheet" href="../../assets/css/common.css">
  <link rel="stylesheet" href="../../assets/css/mobile.css">

  <style>
    /* æœç´¢æ  */
    .search-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--bg-white);
      padding: var(--spacing-md) var(--spacing-lg);
      border-bottom: 1px solid var(--border-color);
      z-index: var(--z-index-sticky);
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
    }

    .search-back-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-xl);
      cursor: pointer;
      flex-shrink: 0;
    }

    .search-input-wrapper {
      flex: 1;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: var(--spacing-sm) var(--spacing-md) var(--spacing-sm) 40px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-pill);
      font-size: var(--font-size-base);
      outline: none;
      background: var(--bg-gray);
    }

    .search-icon {
      position: absolute;
      left: var(--spacing-md);
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-tertiary);
      font-size: var(--font-size-lg);
    }

    .clear-btn {
      position: absolute;
      right: var(--spacing-md);
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      background: var(--text-tertiary);
      color: var(--text-inverse);
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-xs);
      cursor: pointer;
    }

    .search-input:not(:placeholder-shown) ~ .clear-btn {
      display: flex;
    }

    .search-btn {
      padding: var(--spacing-sm) var(--spacing-lg);
      background: var(--primary-gradient);
      color: var(--text-inverse);
      border: none;
      border-radius: var(--radius-pill);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      cursor: pointer;
      flex-shrink: 0;
    }

    /* å†…å®¹åŒºåŸŸ */
    .mobile-content {
      padding-top: 68px;
    }

    /* æœç´¢å»ºè®® */
    .search-suggestions {
      background: var(--bg-white);
      padding: var(--spacing-lg);
    }

    .suggestion-title {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .clear-history-btn {
      font-size: var(--font-size-sm);
      color: var(--text-tertiary);
      cursor: pointer;
    }

    .suggestion-tags {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
    }

    .suggestion-tag {
      padding: var(--spacing-xs) var(--spacing-md);
      background: var(--bg-gray);
      border-radius: var(--radius-pill);
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .suggestion-tag:active {
      background: rgba(102, 126, 234, 0.1);
      color: var(--primary-color);
    }

    .suggestion-tag.hot {
      background: rgba(245, 34, 45, 0.1);
      color: var(--error-color);
    }

    /* ç­›é€‰æ  */
    .filter-bar {
      background: var(--bg-white);
      padding: var(--spacing-md) var(--spacing-lg);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: var(--spacing-md);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .filter-bar::-webkit-scrollbar {
      display: none;
    }

    .filter-item {
      padding: var(--spacing-xs) var(--spacing-md);
      background: var(--bg-gray);
      border-radius: var(--radius-pill);
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      white-space: nowrap;
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .filter-item.active {
      background: var(--primary-gradient);
      color: var(--text-inverse);
    }

    /* æœç´¢ç»“æœ */
    .search-results {
      padding: var(--spacing-lg);
    }

    .result-header {
      font-size: var(--font-size-sm);
      color: var(--text-tertiary);
      margin-bottom: var(--spacing-md);
    }

    .result-count {
      color: var(--primary-color);
      font-weight: var(--font-weight-medium);
    }

    /* äº§å“åˆ—è¡¨ */
    .product-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    /* äº§å“å¡ç‰‡ï¼ˆæ¨ªå‘å¸ƒå±€ï¼‰ */
    .product-card-h {
      background: var(--bg-white);
      border-radius: var(--radius-md);
      overflow: hidden;
      display: flex;
      gap: var(--spacing-md);
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .product-card-h:active {
      transform: scale(0.98);
    }

    .product-image-h {
      width: 120px;
      height: 120px;
      object-fit: cover;
      flex-shrink: 0;
    }

    .product-info-h {
      flex: 1;
      padding: var(--spacing-sm) var(--spacing-sm) var(--spacing-sm) 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .product-name-h {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .product-desc-h {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
      margin-bottom: var(--spacing-sm);
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .product-footer-h {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .product-price-h {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
      color: var(--error-color);
    }

    .product-sales-h {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
    }

    /* ç©ºçŠ¶æ€ */
    .empty-result {
      text-align: center;
      padding: var(--spacing-3xl) var(--spacing-lg);
    }

    .empty-icon {
      font-size: var(--font-size-5xl);
      margin-bottom: var(--spacing-md);
    }

    .empty-title {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-medium);
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }

    .empty-text {
      font-size: var(--font-size-sm);
      color: var(--text-tertiary);
    }

    /* åŠ è½½æ›´å¤š */
    .load-more {
      text-align: center;
      padding: var(--spacing-lg);
      font-size: var(--font-size-sm);
      color: var(--text-tertiary);
    }
  </style>
</head>
<body>
  <div class="mobile-container">
    <!-- æœç´¢æ  -->
    <div class="search-header">
      <div class="search-back-btn" onclick="window.history.back()">â†</div>
      <div class="search-input-wrapper">
        <span class="search-icon"></span>
        <input
          type="text"
          class="search-input"
          id="searchInput"
          placeholder="æœç´¢äº§å“åç§°æˆ–åˆ†ç±»"
          oninput="handleInput()"
          onkeypress="handleKeyPress(event)"
        >
        <div class="clear-btn" onclick="clearInput()">Ã—</div>
      </div>
      <button class="search-btn" onclick="performSearch()">æœç´¢</button>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="mobile-content">
      <!-- æœç´¢å»ºè®®ï¼ˆæœªæœç´¢æ—¶æ˜¾ç¤ºï¼‰ -->
      <div id="suggestionsSection" class="search-suggestions">
        <!-- æœç´¢å†å² -->
        <div id="historySection" style="margin-bottom: var(--spacing-lg);">
          <div class="suggestion-title">
            æœç´¢å†å²
            <span class="clear-history-btn" onclick="clearHistory()">æ¸…ç©º</span>
          </div>
          <div class="suggestion-tags" id="historyTags">
            <!-- å†å²æ ‡ç­¾å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>

        <!-- çƒ­é—¨æœç´¢ -->
        <div>
          <div class="suggestion-title">
            ğŸ”¥ çƒ­é—¨æœç´¢
          </div>
          <div class="suggestion-tags">
            <div class="suggestion-tag hot" onclick="searchKeyword('é€Ÿå†»é±¼æ’')">é€Ÿå†»é±¼æ’</div>
            <div class="suggestion-tag hot" onclick="searchKeyword('æœ‰æœºè”¬èœ')">æœ‰æœºè”¬èœ</div>
            <div class="suggestion-tag hot" onclick="searchKeyword('ä¼˜è´¨å¤§ç±³')">ä¼˜è´¨å¤§ç±³</div>
            <div class="suggestion-tag" onclick="searchKeyword('æµ·é²œæ°´äº§')">æµ·é²œæ°´äº§</div>
            <div class="suggestion-tag" onclick="searchKeyword('è‚‰ç±»ç¦½è›‹')">è‚‰ç±»ç¦½è›‹</div>
            <div class="suggestion-tag" onclick="searchKeyword('ç²®æ²¹ç±³é¢')">ç²®æ²¹ç±³é¢</div>
          </div>
        </div>
      </div>

      <!-- æœç´¢ç»“æœï¼ˆæœç´¢åæ˜¾ç¤ºï¼‰ -->
      <div id="resultsSection" style="display: none;">
        <!-- ç­›é€‰æ  -->
        <div class="filter-bar">
          <div class="filter-item active" data-filter="all" onclick="selectFilter('all')">
            å…¨éƒ¨
          </div>
          <div class="filter-item" data-filter="seafood" onclick="selectFilter('seafood')">
            æµ·é²œæ°´äº§
          </div>
          <div class="filter-item" data-filter="meat" onclick="selectFilter('meat')">
            è‚‰ç±»ç¦½è›‹
          </div>
          <div class="filter-item" data-filter="vegetable" onclick="selectFilter('vegetable')">
            è”¬èœæœè”¬
          </div>
          <div class="filter-item" data-filter="grain" onclick="selectFilter('grain')">
            ç²®æ²¹ç±³é¢
          </div>
        </div>

        <!-- ç»“æœåˆ—è¡¨ -->
        <div class="search-results">
          <div class="result-header" id="resultHeader">
            æ‰¾åˆ° <span class="result-count" id="resultCount">0</span> ä¸ªç›¸å…³äº§å“
          </div>

          <div class="product-list" id="productList">
            <!-- äº§å“å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </div>

          <!-- åŠ è½½æ›´å¤š -->
          <div class="load-more" id="loadMore" style="display: none;">
            ä¸Šæ‹‰åŠ è½½æ›´å¤š...
          </div>

          <!-- ç©ºçŠ¶æ€ -->
          <div class="empty-result" id="emptyResult" style="display: none;">
            <div class="empty-icon"></div>
            <div class="empty-title">æœªæ‰¾åˆ°ç›¸å…³äº§å“</div>
            <div class="empty-text">è¯•è¯•å…¶ä»–æœç´¢è¯å§</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="../../assets/js/mockData.js"></script>
  <script src="../../assets/js/mockAPI.js"></script>
  <script src="../../assets/js/utils.js"></script>

  <script>
    // ==================== å…¨å±€çŠ¶æ€ ====================
    let searchHistory = [];
    let currentKeyword = '';
    let currentFilter = 'all';
    let searchResults = [];

    // ==================== åˆå§‹åŒ– ====================
    document.addEventListener('DOMContentLoaded', () => {
      loadSearchHistory();
      renderHistory();

      // ä»URLå‚æ•°è·å–æœç´¢å…³é”®è¯
      const urlParams = new URLSearchParams(window.location.search);
      const keyword = urlParams.get('q');
      if (keyword) {
        document.getElementById('searchInput').value = keyword;
        performSearch();
      }
    });

    // ==================== åŠ è½½æœç´¢å†å² ====================
    function loadSearchHistory() {
      const saved = localStorage.getItem('searchHistory');
      if (saved) {
        try {
          searchHistory = JSON.parse(saved);
        } catch (e) {
          searchHistory = [];
        }
      }
    }

    // ==================== ä¿å­˜æœç´¢å†å² ====================
    function saveSearchHistory() {
      localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
    }

    // ==================== æ¸²æŸ“æœç´¢å†å² ====================
    function renderHistory() {
      const historyTags = document.getElementById('historyTags');
      const historySection = document.getElementById('historySection');

      if (searchHistory.length === 0) {
        historySection.style.display = 'none';
        return;
      }

      historySection.style.display = 'block';
      historyTags.innerHTML = searchHistory
        .slice(0, 10)
        .map(keyword => `
          <div class="suggestion-tag" onclick="searchKeyword('${keyword}')">
            ${keyword}
          </div>
        `).join('');
    }

    // ==================== æ¸…ç©ºæœç´¢å†å² ====================
    function clearHistory() {
      searchHistory = [];
      saveSearchHistory();
      renderHistory();
      Utils.showToast('å·²æ¸…ç©ºæœç´¢å†å²', 'success');
    }

    // ==================== è¾“å…¥å¤„ç† ====================
    function handleInput() {
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å®æ—¶æœç´¢å»ºè®®
    }

    // ==================== æŒ‰é”®å¤„ç† ====================
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        performSearch();
      }
    }

    // ==================== æ¸…ç©ºè¾“å…¥ ====================
    function clearInput() {
      document.getElementById('searchInput').value = '';
      document.getElementById('searchInput').focus();
    }

    // ==================== æœç´¢å…³é”®è¯ ====================
    function searchKeyword(keyword) {
      document.getElementById('searchInput').value = keyword;
      performSearch();
    }

    // ==================== æ‰§è¡Œæœç´¢ ====================
    async function performSearch() {
      const keyword = document.getElementById('searchInput').value.trim();

      if (!keyword) {
        Utils.showToast('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'error');
        return;
      }

      currentKeyword = keyword;

      // ä¿å­˜åˆ°æœç´¢å†å²
      if (!searchHistory.includes(keyword)) {
        searchHistory.unshift(keyword);
        if (searchHistory.length > 20) {
          searchHistory = searchHistory.slice(0, 20);
        }
        saveSearchHistory();
      }

      // åˆ‡æ¢UI
      document.getElementById('suggestionsSection').style.display = 'none';
      document.getElementById('resultsSection').style.display = 'block';

      // æ‰§è¡Œæœç´¢
      try {
        const result = await MockAPI.request('products.search', {
          keyword: currentKeyword,
          category: currentFilter === 'all' ? null : currentFilter
        });

        searchResults = result.data || [];
        renderResults();

      } catch (error) {
        console.error('æœç´¢å¤±è´¥:', error);
        Utils.showToast('æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }

    // ==================== é€‰æ‹©ç­›é€‰ ====================
    function selectFilter(filter) {
      currentFilter = filter;

      // æ›´æ–°UI
      document.querySelectorAll('.filter-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-filter="${filter}"]`).classList.add('active');

      // é‡æ–°æœç´¢
      performSearch();
    }

    // ==================== æ¸²æŸ“æœç´¢ç»“æœ ====================
    function renderResults() {
      const productList = document.getElementById('productList');
      const resultCount = document.getElementById('resultCount');
      const emptyResult = document.getElementById('emptyResult');

      resultCount.textContent = searchResults.length;

      if (searchResults.length === 0) {
        productList.style.display = 'none';
        emptyResult.style.display = 'block';
        return;
      }

      productList.style.display = 'flex';
      emptyResult.style.display = 'none';

      productList.innerHTML = searchResults.map(product => `
        <div class="product-card-h" onclick="navigateToProduct(${product.id})">
          <img
            src="${product.images[0]}"
            alt="${product.name}"
            class="product-image-h"
          >
          <div class="product-info-h">
            <div>
              <div class="product-name-h">${highlightKeyword(product.name, currentKeyword)}</div>
              <div class="product-desc-h">${product.description || 'ä¼˜è´¨äº§å“ï¼Œå€¼å¾—ä¿¡èµ–'}</div>
            </div>
            <div class="product-footer-h">
              <div class="product-price-h">Â¥${product.price.base}</div>
              <div class="product-sales-h">å·²å”® ${Math.floor(Math.random() * 1000)}+</div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // ==================== é«˜äº®å…³é”®è¯ ====================
    function highlightKeyword(text, keyword) {
      if (!keyword) return text;

      const regex = new RegExp(`(${keyword})`, 'gi');
      return text.replace(regex, '<span style="color: var(--primary-color); font-weight: var(--font-weight-bold);">$1</span>');
    }

    // ==================== å¯¼èˆªåˆ°äº§å“è¯¦æƒ… ====================
    function navigateToProduct(productId) {
      window.location.href = `../products/detail.html?id=${productId}`;
    }
  </script>
</body>
</html>
