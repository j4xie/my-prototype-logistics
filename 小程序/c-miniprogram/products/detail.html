<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>äº§å“è¯¦æƒ… - æº¯æºå•†åŸ</title>

  <!-- CSS -->
  <link rel="stylesheet" href="../../assets/css/variables.css">
  <link rel="stylesheet" href="../../assets/css/common.css">
  <link rel="stylesheet" href="../../assets/css/mobile.css">

  <style>
    .mobile-content {
      padding-bottom: 70px; /* ä¸ºåº•éƒ¨æ“ä½œæ ç•™ç©ºé—´ */
    }

    /* å›¾ç‰‡è½®æ’­ */
    .product-carousel {
      position: relative;
      width: 100%;
      height: 375px;
      background: var(--bg-white);
    }

    .carousel-images {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .carousel-images::-webkit-scrollbar {
      display: none;
    }

    .carousel-image {
      flex-shrink: 0;
      width: 100%;
      height: 375px;
      object-fit: cover;
      scroll-snap-align: start;
    }

    .carousel-indicators {
      position: absolute;
      bottom: var(--spacing-md);
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: var(--spacing-xs);
    }

    .carousel-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      transition: all var(--transition-base);
    }

    .carousel-dot.active {
      width: 16px;
      border-radius: 3px;
      background: var(--bg-white);
    }

    .share-btn {
      position: absolute;
      top: var(--spacing-lg);
      right: var(--spacing-lg);
      width: 40px;
      height: 40px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-xl);
      cursor: pointer;
    }

    /* äº§å“ä¿¡æ¯ */
    .product-info-section {
      background: var(--bg-white);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
    }

    .product-header {
      margin-bottom: var(--spacing-md);
    }

    .product-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
      line-height: 1.4;
    }

    .product-subtitle {
      font-size: var(--font-size-sm);
      color: var(--text-tertiary);
      margin-bottom: var(--spacing-md);
    }

    .product-tags-row {
      display: flex;
      gap: var(--spacing-xs);
      flex-wrap: wrap;
    }

    .tag {
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
      background: var(--bg-gray);
      color: var(--text-secondary);
    }

    .tag.tag-trace {
      background: rgba(46, 213, 115, 0.1);
      color: var(--ecommerce-safe);
      font-weight: var(--font-weight-semibold);
    }

    .tag.tag-hot {
      background: rgba(255, 107, 107, 0.1);
      color: var(--ecommerce-hot);
    }

    /* ä»·æ ¼åŒºåŸŸ */
    .price-section {
      background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
      padding: var(--spacing-lg);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
    }

    .price-header {
      display: flex;
      align-items: baseline;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
    }

    .price-current {
      font-size: var(--font-size-3xl);
      font-weight: var(--font-weight-bold);
      color: var(--ecommerce-accent);
    }

    .price-unit {
      font-size: var(--font-size-base);
      color: var(--text-tertiary);
    }

    .price-label {
      font-size: var(--font-size-sm);
      color: var(--text-tertiary);
      margin-bottom: var(--spacing-sm);
    }

    /* é˜¶æ¢¯ä»·æ ¼è¡¨ */
    .tier-pricing-table {
      background: var(--bg-white);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .tier-row {
      display: flex;
      justify-content: space-between;
      padding: var(--spacing-sm) var(--spacing-md);
      border-bottom: 1px solid var(--border-color);
    }

    .tier-row:last-child {
      border-bottom: none;
    }

    .tier-row.header {
      background: var(--bg-gray);
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-size-sm);
    }

    .tier-qty {
      color: var(--text-secondary);
    }

    .tier-price {
      color: var(--ecommerce-accent);
      font-weight: var(--font-weight-semibold);
    }

    /* ä¾›è´§å•†ä¿¡æ¯ */
    .supplier-section {
      background: var(--bg-white);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
    }

    .supplier-card {
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .supplier-card:active {
      transform: scale(0.98);
      background: var(--bg-gray);
    }

    .supplier-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .supplier-logo {
      width: 50px;
      height: 50px;
      background: var(--primary-gradient);
      color: var(--text-inverse);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
      flex-shrink: 0;
    }

    .supplier-info {
      flex: 1;
    }

    .supplier-name {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
    }

    .supplier-meta {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
    }

    .supplier-arrow {
      font-size: var(--font-size-xl);
      color: var(--text-tertiary);
    }

    .supplier-stats {
      display: flex;
      gap: var(--spacing-lg);
      padding-top: var(--spacing-md);
      border-top: 1px solid var(--border-color);
    }

    .supplier-stats .stat-item {
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
    }

    /* æº¯æºåŒºåŸŸ */
    .traceability-section {
      background: var(--bg-white);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
    }

    .section-title {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .trace-timeline {
      position: relative;
      padding-left: var(--spacing-lg);
    }

    .trace-timeline::before {
      content: '';
      position: absolute;
      left: 6px;
      top: 8px;
      bottom: 8px;
      width: 2px;
      background: var(--border-color);
    }

    .trace-item {
      position: relative;
      padding-bottom: var(--spacing-lg);
    }

    .trace-item:last-child {
      padding-bottom: 0;
    }

    .trace-dot {
      position: absolute;
      left: -12px;
      top: 4px;
      width: 14px;
      height: 14px;
      background: var(--ecommerce-safe);
      border: 3px solid var(--bg-white);
      border-radius: 50%;
      box-shadow: 0 0 0 2px var(--ecommerce-safe);
    }

    .trace-content {
      padding-left: var(--spacing-md);
    }

    .trace-time {
      font-size: var(--font-size-xs);
      color: var(--text-tertiary);
      margin-bottom: var(--spacing-xs);
    }

    .trace-title {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
    }

    .trace-desc {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }

    .trace-footer {
      margin-top: var(--spacing-lg);
      text-align: center;
    }

    .trace-detail-btn {
      padding: var(--spacing-sm) var(--spacing-2xl);
      background: var(--bg-white);
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
      border-radius: var(--radius-pill);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .trace-detail-btn:active {
      transform: scale(0.98);
      background: var(--primary-light);
    }

    /* äº§å“è§„æ ¼ */
    .specs-section {
      background: var(--bg-white);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
    }

    .spec-item {
      display: flex;
      padding: var(--spacing-md) 0;
      border-bottom: 1px solid var(--border-color);
    }

    .spec-item:last-child {
      border-bottom: none;
    }

    .spec-label {
      width: 100px;
      color: var(--text-tertiary);
      font-size: var(--font-size-sm);
    }

    .spec-value {
      flex: 1;
      color: var(--text-primary);
      font-size: var(--font-size-sm);
    }

    /* ç›¸å…³æ¨è */
    .related-section {
      background: var(--bg-white);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
    }

    .related-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-md);
    }

    .related-card {
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      overflow: hidden;
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .related-card:active {
      transform: scale(0.98);
    }

    .related-image {
      width: 100%;
      height: 120px;
      object-fit: cover;
      background: var(--gray-100);
    }

    .related-info {
      padding: var(--spacing-sm);
    }

    .related-name {
      font-size: var(--font-size-sm);
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .related-price {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-bold);
      color: var(--ecommerce-accent);
    }

    /* åº•éƒ¨æ“ä½œæ  */
    .bottom-action-bar {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 430px;
      background: var(--bg-white);
      border-top: 1px solid var(--border-color);
      padding: var(--spacing-md) var(--spacing-lg);
      display: flex;
      gap: var(--spacing-md);
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
      z-index: var(--z-index-sticky);
      box-sizing: border-box;
      align-items: center;
    }

    .action-icon-btn {
      flex: 1;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: var(--spacing-md);
      background: var(--bg-white);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-pill);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .action-icon-btn .icon {
      font-size: 18px;
    }

    .action-icon-btn:active {
      background: var(--bg-gray);
      transform: scale(0.98);
    }

    .action-cart-btn {
      flex: 1;
      padding: var(--spacing-md);
      background: var(--primary-gradient);
      color: var(--text-inverse);
      border: none;
      border-radius: var(--radius-pill);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .action-cart-btn:active {
      transform: scale(0.98);
      opacity: 0.9;
    }
    
    /* æµ®åŠ¨æŒ‰é’® */
    .fab-ai {
      position: fixed;
      bottom: 100px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: var(--bg-dark);
      color: var(--primary-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 1000;
      cursor: pointer;
      border: 1px solid var(--primary-color);
    }
    
    .fab-cart {
      position: fixed;
      bottom: 100px;
      left: 20px;
      width: 50px;
      height: 50px;
      background: white;
      color: var(--bg-dark);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 1000;
      cursor: pointer;
      display: none; /* åˆå§‹éšè— */
      border: 1px solid #eee;
    }
    
    @media (min-width: 430px) {
      .fab-ai {
        right: auto;
        left: 50%;
        margin-left: 145px;
      }
      .fab-cart {
        left: 50%;
        margin-left: -195px; /* -(215 - 20) */
      }
    }

    /* æ•°é‡é€‰æ‹©å™¨æ¨¡æ€æ¡† */
    .qty-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: var(--z-index-modal);
      align-items: flex-end;
      justify-content: center; /* æ°´å¹³å±…ä¸­ */
    }

    .qty-modal.show {
      display: flex;
    }

    .qty-modal-content {
      background: var(--bg-white);
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
      padding: var(--spacing-2xl) var(--spacing-lg);
      width: 100%;
      max-width: 430px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
      animation: slideUp 0.3s ease;
      box-sizing: border-box; /* ç¡®ä¿paddingä¸æ’‘å¤§å®½åº¦ */
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }

    .qty-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-xl);
    }

    .qty-title {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
    }

    .qty-close {
      font-size: var(--font-size-xl);
      color: var(--text-tertiary);
      cursor: pointer;
    }

    .qty-selector {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-lg);
      margin: var(--spacing-2xl) 0;
    }

    .qty-btn {
      width: 40px;
      height: 40px;
      border: 1px solid var(--border-color);
      border-radius: 50%;
      background: var(--bg-white);
      font-size: var(--font-size-xl);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .qty-btn:active {
      background: var(--bg-gray);
    }

    .qty-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .qty-input {
      width: 80px;
      height: 40px;
      text-align: center;
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
    }

    .qty-price-info {
      background: var(--bg-gray);
      padding: var(--spacing-lg);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-xl);
    }

    .qty-total-label {
      font-size: var(--font-size-sm);
      color: var(--text-tertiary);
      margin-bottom: var(--spacing-xs);
    }

    .qty-total-price {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--ecommerce-accent);
    }

    .qty-tier-hint {
      font-size: var(--font-size-xs);
      color: var(--primary-color);
      margin-top: var(--spacing-xs);
    }

    .qty-confirm-btn {
      width: 100%;
      padding: var(--spacing-lg);
      background: var(--primary-gradient);
      color: var(--text-inverse);
      border: none;
      border-radius: var(--radius-pill);
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="mobile-container">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="mobile-header">
      <div class="mobile-header-back" onclick="window.history.back()">â†</div>
      <div class="mobile-header-title">äº§å“è¯¦æƒ…</div>
      <div class="mobile-header-action" onclick="navigateTo('list.html')">ğŸ“‹</div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="mobile-content">
      <!-- å›¾ç‰‡è½®æ’­ -->
      <div class="product-carousel">
        <div class="carousel-images" id="carouselImages">
          <!-- å›¾ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="carousel-indicators" id="carouselIndicators">
          <!-- æŒ‡ç¤ºå™¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="share-btn" onclick="handleShare()">ğŸ“¤</div>
      </div>

      <!-- äº§å“ä¿¡æ¯ -->
      <div class="product-info-section">
        <div class="product-header">
          <h1 class="product-title" id="productTitle">åŠ è½½ä¸­...</h1>
          <p class="product-subtitle" id="productSubtitle"></p>
          <div class="product-tags-row" id="productTags">
            <!-- æ ‡ç­¾å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>

        <!-- ä»·æ ¼åŒºåŸŸ -->
        <div class="price-section">
          <div class="price-header">
            <span class="price-current" id="currentPrice">Â¥0</span>
            <span class="price-unit" id="priceUnit">/kg</span>
          </div>
          <div class="price-label">é˜¶æ¢¯ä»·æ ¼ (æ•°é‡è¶Šå¤šè¶Šä¼˜æƒ )</div>
          <div class="tier-pricing-table" id="tierPricingTable">
            <!-- é˜¶æ¢¯ä»·æ ¼è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>

        <!-- å¹¿å‘ŠåŒºåŸŸ -->
        <div id="detailAdContainer" style="margin-bottom: 16px; display: none;">
          <!-- åŠ¨æ€ç”Ÿæˆå¹¿å‘Š -->
        </div>
      </div>

      <!-- ä¾›è´§å•†ä¿¡æ¯ -->
      <div class="supplier-section">
        <h2 class="section-title">
          <span>ä¾›è´§å•†ä¿¡æ¯</span>
        </h2>
        <div class="supplier-card" onclick="navigateToMerchant()">
          <div class="supplier-header">
            <div class="supplier-logo">å·¥</div>
            <div class="supplier-info">
              <div class="supplier-name">ç™½å©çºªé£Ÿå“æœ‰é™å…¬å¸</div>
              <div class="supplier-meta">ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒº Â· 5å¹´ç»è¥</div>
            </div>
            <div class="supplier-arrow">â†’</div>
          </div>
          <div class="supplier-stats">
            <span class="stat-item">äº§å“: 12</span>
            <span class="stat-item">è¯„åˆ†: 4.8</span>
            <span class="stat-item">å¥½è¯„ç‡: 98%</span>
          </div>
        </div>
      </div>

      <!-- æº¯æºä¿¡æ¯ -->
      <div class="traceability-section" id="traceabilitySection">
        <h2 class="section-title">
          <span>äº§å“æº¯æºä¿¡æ¯</span>
        </h2>
        <div class="trace-timeline">
          <div class="trace-item">
            <div class="trace-dot"></div>
            <div class="trace-content">
              <div class="trace-time">2025-01-15 14:30</div>
              <div class="trace-title">è´¨æ£€åˆæ ¼</div>
              <div class="trace-desc">æ‰¹æ¬¡å·: BATCH-20250115-001 Â· æ£€éªŒå‘˜: å¼ ä¸‰</div>
            </div>
          </div>
          <div class="trace-item">
            <div class="trace-dot"></div>
            <div class="trace-content">
              <div class="trace-time">2025-01-15 10:00</div>
              <div class="trace-title">åŠ å·¥å®Œæˆ</div>
              <div class="trace-desc">åŠ å·¥è½¦é—´: AåŒº3å·çº¿ Â· æ“ä½œå‘˜: æå››</div>
            </div>
          </div>
          <div class="trace-item">
            <div class="trace-dot"></div>
            <div class="trace-content">
              <div class="trace-time">2025-01-15 08:00</div>
              <div class="trace-title">åŸæ–™å…¥åº“</div>
              <div class="trace-desc">ä¾›åº”å•†: æµ·é²œæ‰¹å‘å¸‚åœº Â· é‡é‡: 500kg</div>
            </div>
          </div>
        </div>
        <div class="trace-footer">
          <button class="trace-detail-btn" onclick="navigateToTraceDetail()">æŸ¥çœ‹å®Œæ•´æº¯æº</button>
        </div>
      </div>

      <!-- äº§å“è§„æ ¼ -->
      <div class="specs-section">
        <h2 class="section-title">äº§å“è§„æ ¼</h2>
        <div id="specsContainer">
          <!-- è§„æ ¼ä¿¡æ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>

      <!-- ç›¸å…³æ¨è -->
      <div class="related-section">
        <h2 class="section-title">ğŸ”¥ ç›¸å…³æ¨è</h2>
        <div class="related-grid" id="relatedGrid">
          <!-- æ¨èäº§å“å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <div class="bottom-action-bar">
      <div class="action-icon-btn" onclick="contactSupplier()">
         <span class="icon">ğŸ§</span>
         <span>è”ç³»ä¾›åº”å•†</span>
      </div>
      <button class="action-cart-btn" onclick="showQtyModal('cart')">ğŸ›’ åŠ å…¥è´­ç‰©è½¦</button>
    </div>
    
    <!-- æµ®åŠ¨æŒ‰é’® -->
    <div class="fab-ai" onclick="openAI()">ğŸ¤–</div>
    <div class="fab-cart" id="fabCart" onclick="navigateToCart()">ğŸ›’</div>
  </div>

  <!-- æ•°é‡é€‰æ‹©å™¨æ¨¡æ€æ¡† -->
  <div class="qty-modal" id="qtyModal">
    <div class="qty-modal-content">
      <div class="qty-header">
        <div class="qty-title">é€‰æ‹©æ•°é‡</div>
        <div class="qty-close" onclick="closeQtyModal()">âœ•</div>
      </div>

      <div class="qty-selector">
        <button class="qty-btn" id="qtyDecBtn" onclick="adjustQty(-1)">-</button>
        <input type="number" class="qty-input" id="qtyInput" value="1" min="1" readonly>
        <button class="qty-btn" onclick="adjustQty(1)">+</button>
      </div>

      <div class="qty-price-info">
        <div class="qty-total-label">æ€»ä»·</div>
        <div class="qty-total-price" id="qtyTotalPrice">Â¥0</div>
        <div class="qty-tier-hint" id="qtyTierHint"></div>
      </div>

      <button class="qty-confirm-btn" id="qtyConfirmBtn" onclick="confirmQty()">ç¡®è®¤</button>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="../../assets/js/mockData.js?v=20251217"></script>
  <script src="../../assets/js/mockAPI.js?v=20251217"></script>
  <script src="../../assets/js/utils.js?v=20251217"></script>

  <script>
    // ==================== å…¨å±€çŠ¶æ€ ====================
    let currentProduct = null;
    let currentQty = 1;
    let qtyModalAction = 'cart'; // 'cart' or 'buy'

    // ==================== åˆå§‹åŒ– ====================
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const productId = parseInt(urlParams.get('id')) || 1;
      loadProductDetail(productId);
      loadDetailAds();
    });

    // ==================== åŠ è½½å¹¿å‘Š ====================
    async function loadDetailAds() {
      console.log('[AD] å¼€å§‹åŠ è½½è¯¦æƒ…é¡µå¹¿å‘Š...');
      try {
        const result = await MockAPI.request('ads.list', { position: 'detail_bottom' });
        console.log('[AD] APIè¿”å›ç»“æœ:', result);
        const ads = result.data || [];
        console.log('[AD] æœ‰æ•ˆå¹¿å‘Šæ•°é‡:', ads.length);
        
        if (ads.length > 0) {
          const container = document.getElementById('detailAdContainer');
          // éšæœºå±•ç¤ºä¸€ä¸ª
          const ad = ads[0]; 
          console.log('[AD] å±•ç¤ºå¹¿å‘Š:', ad);
          container.style.display = 'block';
          container.innerHTML = `
            <div onclick="handleAdClick(${ad.id}, ${ad.productId})" style="width: 100%; height: 90px; border-radius: 8px; overflow: hidden; position: relative; cursor: pointer;">
              <img src="${ad.image}" style="width: 100%; height: 100%; object-fit: cover;">
              <div style="position: absolute; bottom: 0; right: 0; background: rgba(0,0,0,0.3); color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px 0 0 0;">å¹¿å‘Š</div>
            </div>
          `;
        } else {
          console.log('[AD] æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆå¹¿å‘Š');
        }
      } catch (error) {
        console.error('[AD] åŠ è½½è¯¦æƒ…å¹¿å‘Šå¤±è´¥:', error);
      }
    }

    async function handleAdClick(adId, productId) {
        try {
            await MockAPI.request('ads.click', { adId });
        } catch (e) {
            console.error('è®°å½•ç‚¹å‡»å¤±è´¥', e);
        }
        if (productId && productId !== currentProduct.id) {
            window.location.href = `detail.html?id=${productId}`;
        }
    }

    // ==================== åŠ è½½äº§å“è¯¦æƒ… ====================
    async function loadProductDetail(productId) {
      try {
        const result = await MockAPI.request('products.detail', { productId: productId, skipError: true });
        currentProduct = result.data;

        renderProductInfo();
        renderCarousel();
        renderTierPricing();
        renderSpecs();
        loadRelatedProducts();

      } catch (error) {
        console.error('åŠ è½½äº§å“è¯¦æƒ…å¤±è´¥:', error);
        Utils.showToast('åŠ è½½äº§å“è¯¦æƒ…å¤±è´¥', 'error');
      }
    }

    // ==================== æ¸²æŸ“äº§å“ä¿¡æ¯ ====================
    function renderProductInfo() {
      document.getElementById('productTitle').textContent = currentProduct.name;
      document.getElementById('productSubtitle').textContent = currentProduct.description || '';
      document.getElementById('currentPrice').textContent = `Â¥${currentProduct.price.base}`;
      document.getElementById('priceUnit').textContent = `/${currentProduct.price.unit}`;

      // æ¸²æŸ“æ ‡ç­¾
      const tagsHtml = currentProduct.tags.map(tag => {
        const tagClass = tag === 'å¯æº¯æº' ? 'tag-trace' : (tag === 'çƒ­é”€' ? 'tag-hot' : '');
        return `<span class="tag ${tagClass}">${tag}</span>`;
      }).join('');
      document.getElementById('productTags').innerHTML = tagsHtml;

      // æ˜¾ç¤ºæº¯æºåŒºåŸŸ
      if (currentProduct.traceability?.hasBatch) {
        document.getElementById('traceabilitySection').style.display = 'block';
      }
    }

    // ==================== æ¸²æŸ“å›¾ç‰‡è½®æ’­ ====================
    function renderCarousel() {
      const carouselImages = document.getElementById('carouselImages');
      const carouselIndicators = document.getElementById('carouselIndicators');

      // æ¸²æŸ“å›¾ç‰‡
      carouselImages.innerHTML = currentProduct.images.map(img => `
        <img src="${img}" alt="${currentProduct.name}" class="carousel-image">
      `).join('');

      // æ¸²æŸ“æŒ‡ç¤ºå™¨
      carouselIndicators.innerHTML = currentProduct.images.map((_, idx) => `
        <span class="carousel-dot ${idx === 0 ? 'active' : ''}" data-index="${idx}"></span>
      `).join('');

      // ç›‘å¬æ»šåŠ¨æ›´æ–°æŒ‡ç¤ºå™¨
      carouselImages.addEventListener('scroll', updateCarouselIndicators);
    }

    function updateCarouselIndicators() {
      const carouselImages = document.getElementById('carouselImages');
      const scrollLeft = carouselImages.scrollLeft;
      const imageWidth = carouselImages.offsetWidth;
      const currentIndex = Math.round(scrollLeft / imageWidth);

      const dots = document.querySelectorAll('.carousel-dot');
      dots.forEach((dot, idx) => {
        dot.classList.toggle('active', idx === currentIndex);
      });
    }

    // ==================== æ¸²æŸ“é˜¶æ¢¯ä»·æ ¼ ====================
    function renderTierPricing() {
      const tierPricingTable = document.getElementById('tierPricingTable');

      if (!currentProduct.price.tiers || currentProduct.price.tiers.length === 0) {
        tierPricingTable.innerHTML = '<div class="tier-row">æš‚æ— é˜¶æ¢¯ä»·æ ¼</div>';
        return;
      }

      let html = `
        <div class="tier-row header">
          <span>èµ·è®¢é‡</span>
          <span>å•ä»·</span>
        </div>
      `;

      html += currentProduct.price.tiers.map(tier => `
        <div class="tier-row">
          <span class="tier-qty">â‰¥ ${tier.minQty}${currentProduct.price.unit}</span>
          <span class="tier-price">Â¥${tier.price}/${currentProduct.price.unit}</span>
        </div>
      `).join('');

      tierPricingTable.innerHTML = html;
    }

    // ==================== æ¸²æŸ“äº§å“è§„æ ¼ ====================
    function renderSpecs() {
      const specsContainer = document.getElementById('specsContainer');

      const specs = [
        { label: 'äº§å“åˆ†ç±»', value: currentProduct.category },
        { label: 'äº§åœ°', value: 'ä¸­å›½' },
        { label: 'ä¿è´¨æœŸ', value: '12ä¸ªæœˆ' },
        { label: 'å‚¨å­˜æ¡ä»¶', value: '-18â„ƒå†·å†»ä¿å­˜' },
        { label: 'åŒ…è£…è§„æ ¼', value: `1${currentProduct.price.unit}/è¢‹` }
      ];

      specsContainer.innerHTML = specs.map(spec => `
        <div class="spec-item">
          <div class="spec-label">${spec.label}</div>
          <div class="spec-value">${spec.value}</div>
        </div>
      `).join('');
    }

    // ==================== åŠ è½½ç›¸å…³æ¨è ====================
    async function loadRelatedProducts() {
      try {
        const result = await MockAPI.request('products.list', {
          category: currentProduct.category,
          page: 1,
          pageSize: 4,
          skipError: true
        });

        const relatedProducts = result.data.filter(p => p.id !== currentProduct.id).slice(0, 4);
        const relatedGrid = document.getElementById('relatedGrid');

        relatedGrid.innerHTML = relatedProducts.map(product => `
          <div class="related-card" onclick="navigateToProduct(${product.id})">
            <img src="${product.images[0]}" alt="${product.name}" class="related-image">
            <div class="related-info">
              <div class="related-name">${product.name}</div>
              <div class="related-price">Â¥${product.price.base}</div>
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('åŠ è½½ç›¸å…³äº§å“å¤±è´¥:', error);
      }
    }

    // ==================== æ•°é‡é€‰æ‹©å™¨ ====================
    function showQtyModal(action) {
      qtyModalAction = action;
      currentQty = 1;
      document.getElementById('qtyInput').value = 1;
      updateQtyPrice();
      document.getElementById('qtyModal').classList.add('show');

      // æ›´æ–°æŒ‰é’®æ–‡æœ¬
      const confirmBtn = document.getElementById('qtyConfirmBtn');
      confirmBtn.textContent = action === 'cart' ? 'åŠ å…¥è´­ç‰©è½¦' : 'ç«‹å³è´­ä¹°';
    }

    function closeQtyModal() {
      document.getElementById('qtyModal').classList.remove('show');
    }

    function adjustQty(delta) {
      currentQty = Math.max(1, currentQty + delta);
      document.getElementById('qtyInput').value = currentQty;
      updateQtyPrice();
    }

    function updateQtyPrice() {
      // è®¡ç®—å½“å‰ä»·æ ¼ï¼ˆè€ƒè™‘é˜¶æ¢¯ä»·æ ¼ï¼‰
      let unitPrice = currentProduct.price.base;

      if (currentProduct.price.tiers && currentProduct.price.tiers.length > 0) {
        for (const tier of currentProduct.price.tiers.sort((a, b) => b.minQty - a.minQty)) {
          if (currentQty >= tier.minQty) {
            unitPrice = tier.price;
            break;
          }
        }
      }

      const totalPrice = (unitPrice * currentQty).toFixed(2);
      document.getElementById('qtyTotalPrice').textContent = `Â¥${totalPrice}`;

      // æ˜¾ç¤ºä¸‹ä¸€é˜¶æ¢¯æç¤º
      if (currentProduct.price.tiers && currentProduct.price.tiers.length > 0) {
        const nextTier = currentProduct.price.tiers.find(t => t.minQty > currentQty);
        if (nextTier) {
          const diff = nextTier.minQty - currentQty;
          document.getElementById('qtyTierHint').textContent =
            `å†è´­ä¹°${diff}${currentProduct.price.unit}å¯äº«Â¥${nextTier.price}ä¼˜æƒ ä»·`;
        } else {
          document.getElementById('qtyTierHint').textContent = 'å·²äº«æœ€ä½ä»·';
        }
      }
    }

    function confirmQty() {
      const action = qtyModalAction === 'cart' ? 'åŠ å…¥è´­ç‰©è½¦' : 'è´­ä¹°';
      Utils.showToast(`å·²${action} ${currentQty}${currentProduct.price.unit} ${currentProduct.name}`, 'success');
      closeQtyModal();

      if (qtyModalAction === 'cart') {
        // æ˜¾ç¤ºè´­ç‰©è½¦æµ®åŠ¨æŒ‰é’®
        document.getElementById('fabCart').style.display = 'flex';
      }
    }
    
    function contactSupplier() {
       Utils.showToast('æ­£åœ¨è¿æ¥ä¾›åº”å•†...', 'info');
       setTimeout(() => {
         window.location.href = `../ai-rag/chat.html?type=supplier&productId=${currentProduct.id}`;
       }, 1000);
    }
    
    function openAI() {
       window.location.href = '../ai-rag/chat.html';
    }
    
    function navigateToCart() {
       // è·³è½¬åˆ°è´­ç‰©è½¦é¡µé¢ (å‡è®¾åœ¨orders/cart.htmlï¼Œå¦‚æœæ²¡æœ‰åˆ™è·³åˆ°list pageæ¨¡æ‹Ÿ)
       // ç”±äºæ²¡æœ‰ cart.htmlï¼Œè·³åˆ° orders/checkout.html æ¨¡æ‹Ÿç»“ç®—
       window.location.href = '../orders/checkout.html';
    }

    // ==================== åˆ†äº« ====================
    function handleShare() {
      Utils.showToast('åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­', 'info');
      // å®é™…åº”è°ƒç”¨å¾®ä¿¡åˆ†äº«API
    }

    // ==================== å¯¼èˆªå‡½æ•° ====================
    function navigateTo(path) {
      window.location.href = path;
    }

    function navigateToProduct(productId) {
      window.location.href = `detail.html?id=${productId}`;
    }

    function navigateToTrace() {
      if (currentProduct.traceability?.latestBatchId) {
        window.location.href = `../traceability/batch-info.html?batchId=${currentProduct.traceability.latestBatchId}`;
      } else {
        window.location.href = '../traceability/scan.html';
      }
    }

    function navigateToMerchant() {
      // å¯¼èˆªåˆ°å•†å®¶è¯¦æƒ…é¡µ
      const merchantId = 'CRETAS_2024_001'; // å®é™…åº”ä»äº§å“æ•°æ®ä¸­è·å–
      window.location.href = `../merchant/detail.html?id=${merchantId}`;
    }

    function navigateToTraceDetail() {
      // å¯¼èˆªåˆ°å®Œæ•´æº¯æºä¿¡æ¯é¡µ
      window.location.href = '../traceability/batch-info.html';
    }

    // ==================== ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡† ====================
    document.getElementById('qtyModal').addEventListener('click', (e) => {
      if (e.target.id === 'qtyModal') {
        closeQtyModal();
      }
    });
  </script>
</body>
</html>
