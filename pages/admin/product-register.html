<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>产品注册 - 食品溯源系统</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background-color: #1890FF;
      color: white;
      padding: 15px 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
    }
    
    .header-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-size: 20px;
      font-weight: bold;
    }
    
    .back-button {
      background: none;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    
    .content {
      margin-top: 80px;
      padding-bottom: 20px;
    }
    
    .card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
      display: flex;
      align-items: center;
      padding-bottom: 15px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .card-title .icon {
      margin-right: 8px;
    }
    
    .form-row {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }
    
    .form-required {
      color: #FF4D4F;
      margin-left: 4px;
    }
    
    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    .form-input:focus {
      border-color: #1890FF;
      outline: none;
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
    }
    
    .form-input.error {
      border-color: #FF4D4F;
    }
    
    .form-help {
      font-size: 14px;
      color: #666;
      margin-top: 4px;
    }
    
    .form-error {
      font-size: 14px;
      color: #FF4D4F;
      margin-top: 4px;
    }
    
    .form-inline {
      display: flex;
      gap: 15px;
    }
    
    .form-col {
      flex: 1;
    }
    
    textarea.form-input {
      resize: vertical;
      min-height: 100px;
    }
    
    .form-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      font-size: 16px;
      background-color: white;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 8.5L1.5 4h9z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 30px;
    }
    
    .form-select:focus {
      border-color: #1890FF;
      outline: none;
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
    }
    
    .image-upload {
      position: relative;
      width: 100%;
      height: 200px;
      border: 2px dashed #d9d9d9;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .image-upload:hover {
      border-color: #1890FF;
    }
    
    .image-upload input {
      position: absolute;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    
    .upload-icon {
      font-size: 32px;
      color: #999;
      margin-bottom: 8px;
    }
    
    .upload-text {
      color: #666;
      font-size: 14px;
    }
    
    .preview-container {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .preview-image {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #d9d9d9;
    }
    
    .button-row {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }
    
    .button {
      padding: 12px 20px;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.3s;
    }
    
    .button-primary {
      background-color: #1890FF;
      color: white;
    }
    
    .button-primary:hover {
      background-color: #40a9ff;
    }
    
    .button-default {
      background-color: white;
      border: 1px solid #d9d9d9;
      color: #333;
    }
    
    .button-default:hover {
      border-color: #1890FF;
      color: #1890FF;
    }
    
    .button-icon {
      margin-right: 8px;
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 500;
      margin: 30px 0 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1890FF;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    
    .loading-text {
      font-size: 16px;
      color: #333;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .form-inline {
        flex-direction: column;
        gap: 20px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-container">
      <button class="back-button" id="backButton">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        <span style="margin-left: 5px;">返回</span>
      </button>
      <div class="logo">食品溯源系统 - 管理后台</div>
      <div id="userInfo"></div>
    </div>
  </header>

  <div class="content">
    <div class="container">
      <div class="card">
        <div class="card-title">
          <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="8.5" cy="7" r="4"></circle>
            <line x1="20" y1="8" x2="20" y2="14"></line>
            <line x1="23" y1="11" x2="17" y2="11"></line>
          </svg>
          产品注册
        </div>
        
        <form id="productForm">
          <!-- 基本信息 -->
          <div class="section-title">基本信息</div>
          
          <div class="form-row">
            <label class="form-label">产品名称<span class="form-required">*</span></label>
            <input type="text" class="form-input" name="productName" required>
          </div>
          
          <div class="form-inline">
            <div class="form-col">
              <div class="form-row">
                <label class="form-label">产品批次号<span class="form-required">*</span></label>
                <input type="text" class="form-input" name="batchNumber" required>
                <div class="form-help">请输入生产批次号或唯一识别码</div>
              </div>
            </div>
            <div class="form-col">
              <div class="form-row">
                <label class="form-label">品类<span class="form-required">*</span></label>
                <select class="form-select" name="category" required>
                  <option value="">请选择产品品类</option>
                  <option value="meat">肉类</option>
                  <option value="vegetable">蔬菜</option>
                  <option value="fruit">水果</option>
                  <option value="dairy">乳制品</option>
                  <option value="grain">粮食</option>
                  <option value="seafood">海鲜</option>
                  <option value="drink">饮料</option>
                  <option value="other">其他</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="form-inline">
            <div class="form-col">
              <div class="form-row">
                <label class="form-label">生产日期<span class="form-required">*</span></label>
                <input type="date" class="form-input" name="productionDate" required>
              </div>
            </div>
            <div class="form-col">
              <div class="form-row">
                <label class="form-label">保质期至<span class="form-required">*</span></label>
                <input type="date" class="form-input" name="expiryDate" required>
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <label class="form-label">产品描述</label>
            <textarea class="form-input" name="description" rows="3"></textarea>
          </div>
          
          <!-- 生产信息 -->
          <div class="section-title">生产信息</div>
          
          <div class="form-row">
            <label class="form-label">生产商<span class="form-required">*</span></label>
            <input type="text" class="form-input" name="manufacturer" required>
          </div>
          
          <div class="form-inline">
            <div class="form-col">
              <div class="form-row">
                <label class="form-label">产地<span class="form-required">*</span></label>
                <input type="text" class="form-input" name="origin" required>
              </div>
            </div>
            <div class="form-col">
              <div class="form-row">
                <label class="form-label">执行标准</label>
                <input type="text" class="form-input" name="standards" placeholder="例如：GB/T 22000-2006">
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <label class="form-label">生产地点<span class="form-required">*</span></label>
            <input type="text" class="form-input" name="productionLocation" required placeholder="请输入详细地址">
          </div>
          
          <div class="form-inline">
            <div class="form-col">
              <div class="form-row">
                <label class="form-label">经度</label>
                <input type="number" step="any" class="form-input" name="longitude" placeholder="例如：116.397428">
              </div>
            </div>
            <div class="form-col">
              <div class="form-row">
                <label class="form-label">纬度</label>
                <input type="number" step="any" class="form-input" name="latitude" placeholder="例如：39.90923">
              </div>
            </div>
          </div>
          
          <!-- 认证信息 -->
          <div class="section-title">认证信息</div>
          
          <div class="form-inline">
            <div class="form-col">
              <div class="form-row">
                <label class="form-label">证书类型</label>
                <select class="form-select" name="certificateType">
                  <option value="">请选择证书类型</option>
                  <option value="organic">有机认证</option>
                  <option value="green">绿色食品</option>
                  <option value="hazard">危害分析与关键控制点体系认证</option>
                  <option value="iso">ISO22000认证</option>
                  <option value="other">其他认证</option>
                </select>
              </div>
            </div>
            <div class="form-col">
              <div class="form-row">
                <label class="form-label">证书编号</label>
                <input type="text" class="form-input" name="certificateNo">
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <label class="form-label">检验报告</label>
            <input type="text" class="form-input" name="inspectionReport" placeholder="检验报告编号或描述">
          </div>
          
          <!-- 产品图片 -->
          <div class="section-title">产品图片</div>
          
          <div class="form-row">
            <label class="form-label">上传产品图片</label>
            <div class="image-upload" id="imageUpload">
              <input type="file" accept="image/*" id="productImage" multiple>
              <div class="upload-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
              </div>
              <div class="upload-text">点击或拖拽图片到此处</div>
              <div class="upload-help">支持JPG, PNG格式</div>
            </div>
            <div id="previewContainer" class="preview-container"></div>
          </div>
          
          <!-- 按钮区域 -->
          <div class="button-row">
            <button type="button" class="button button-default" id="resetButton">
              <svg class="button-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                <path d="M3 3v5h5"></path>
              </svg>
              重置表单
            </button>
            <button type="submit" class="button button-primary" id="submitButton">
              <svg class="button-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
              </svg>
              注册产品
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- 加载中遮罩 -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <div id="loadingText" class="loading-text">正在注册产品...</div>
  </div>

  <!-- 脚本 -->
  <script src="../../components/trace-core.js"></script>
  <script src="../../components/trace-ui.js"></script>
  <script src="../../components/trace-nav.js"></script>
  <script src="../../components/trace-blockchain.js"></script>
  <script src="../../components/config-manager.js"></script>
  
  <script>
    // 页面初始化
    document.addEventListener('DOMContentLoaded', async function() {
      // 初始化配置管理器
      window.configManager.init();
      
      // 初始化核心组件
      await window.traceCore.init();
      
      // 初始化UI组件
      if (window.traceUI) {
        window.traceUI.init();
      }
      
      // 初始化导航组件
      if (window.traceNav) {
        window.traceNav.init();
      }
      
      // 初始化区块链组件
      if (window.traceBlockchain) {
        await window.traceBlockchain.init({
          enabled: true,
          provider: 'ethereum'
        });
      }
      
      // 设置事件监听
      setupEventListeners();
      
      // 检查用户权限
      checkPermission();
    });
    
    // 检查用户权限
    function checkPermission() {
      // 检查是否登录及是否有权限
      if (!window.traceCore.hasPermission('product_register')) {
        window.traceUI.showToast('您没有产品注册的权限', 'error');
        setTimeout(() => {
          window.location.href = '../auth/login.html';
        }, 2000);
      }
    }
    
    // 设置事件监听
    function setupEventListeners() {
      // 返回按钮
      document.getElementById('backButton').addEventListener('click', function() {
        window.history.back();
      });
      
      // 重置按钮
      document.getElementById('resetButton').addEventListener('click', function() {
        document.getElementById('productForm').reset();
        document.getElementById('previewContainer').innerHTML = '';
      });
      
      // 表单提交
      document.getElementById('productForm').addEventListener('submit', function(e) {
        e.preventDefault();
        registerProduct();
      });
      
      // 图片上传预览
      document.getElementById('productImage').addEventListener('change', handleImageUpload);
    }
    
    // 处理图片上传
    function handleImageUpload(event) {
      const files = event.target.files;
      const previewContainer = document.getElementById('previewContainer');
      
      // 清空预览
      previewContainer.innerHTML = '';
      
      // 限制上传数量
      const maxFiles = 5;
      const filesToProcess = files.length > maxFiles ? maxFiles : files.length;
      
      if (files.length > maxFiles) {
        window.traceUI.showToast(`最多只能上传${maxFiles}张图片`, 'warning');
      }
      
      // 处理每个文件
      for (let i = 0; i < filesToProcess; i++) {
        const file = files[i];
        
        // 检查文件类型
        if (!file.type.match('image.*')) {
          continue;
        }
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
          const img = document.createElement('img');
          img.classList.add('preview-image');
          img.src = e.target.result;
          previewContainer.appendChild(img);
        };
        
        reader.readAsDataURL(file);
      }
    }
    
    // 注册产品
    async function registerProduct() {
      // 显示加载中
      showLoading('正在注册产品...');
      
      try {
        // 收集表单数据
        const formData = new FormData(document.getElementById('productForm'));
        const productData = {};
        
        // 转换FormData为对象
        for (const [key, value] of formData.entries()) {
          productData[key] = value;
        }
        
        // 添加必要字段
        productData.id = generateProductId(productData.batchNumber);
        productData.timestamp = Date.now();
        
        // 处理图片
        const imageFiles = document.getElementById('productImage').files;
        if (imageFiles.length > 0) {
          // 在实际项目中，这里会上传图片到服务器并获取URL
          // 现在仅模拟一个URL
          productData.imageUrl = 'https://example.com/images/products/' + productData.id + '.jpg';
        }
        
        // 检查区块链是否连接
        if (!window.traceBlockchain || !window.traceBlockchain.getConnectionStatus().connected) {
          throw new Error('区块链未连接，无法注册产品');
        }
        
        // 添加初始追溯记录
        productData.traceRecords = [{
          recordType: 'production',
          location: productData.productionLocation,
          latitude: productData.latitude,
          longitude: productData.longitude,
          timestamp: productData.timestamp,
          description: `产品生产于${productData.productionLocation}`,
          operators: [window.traceCore.getSystemStatus().user.username]
        }];
        
        // 注册到区块链
        const result = await window.traceBlockchain.registerProduct(productData.id, productData);
        
        // 隐藏加载中
        hideLoading();
        
        if (result && result.success) {
          // 注册成功
          window.traceUI.showToast('产品注册成功', 'success');
          
          // 显示成功信息
          window.traceUI.showConfirm({
            title: '产品注册成功',
            content: `产品ID: ${productData.id}<br>产品名称: ${productData.productName}<br>批次号: ${productData.batchNumber}`,
            confirmText: '继续注册',
            cancelText: '返回列表',
            onConfirm: () => {
              // 重置表单
              document.getElementById('productForm').reset();
              document.getElementById('previewContainer').innerHTML = '';
            },
            onCancel: () => {
              window.location.href = 'product-list.html';
            }
          });
        } else {
          throw new Error('产品注册失败');
        }
      } catch (error) {
        console.error('产品注册出错:', error);
        hideLoading();
        window.traceUI.showToast(`产品注册失败: ${error.message}`, 'error');
      }
    }
    
    // 生成产品ID
    function generateProductId(batchNumber) {
      // 生成 UUID v4 格式的ID
      const template = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx';
      const id = template.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
      
      // 结合批次号生成ID
      return `TRACE-${batchNumber}-${id.substring(0, 8)}`;
    }
    
    // 显示加载中
    function showLoading(text) {
      document.getElementById('loadingText').textContent = text || '加载中...';
      document.getElementById('loadingOverlay').style.display = 'flex';
    }
    
    // 隐藏加载中
    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }
  </script>

  <!-- 自动按钮升级脚本 (自动注入) -->
  <script src="/components/autoload-button-upgrade.js"></script>
  </body>
</html> 