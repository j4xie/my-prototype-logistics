<!DOCTYPE html><html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>二维码数据采集 - 养殖管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../../assets/styles.css">
    <style>
        /* 设计系统变量 */
        :root {
            /* 主色调变量 */
            --primary-color: #1677FF;
            --primary-hover: #4096FF;
            --primary-active: #0958D9;
            
            /* 状态色变量 */
            --success-color: #52C41A;
            --success-hover: #73D13D;
            --warning-color: #FA8C16;
            --warning-hover: #FFA940;
            --error-color: #FF4D4F;
            --error-hover: #FF7875;
            
            /* 文本颜色变量 */
            --text-primary: rgba(0, 0, 0, 0.85);
            --text-secondary: rgba(0, 0, 0, 0.65);
            --text-disabled: rgba(0, 0, 0, 0.45);
            
            /* 背景色变量 */
            --bg-layout: #F0F2F5;
            --bg-container: #FFFFFF;
            
            /* 边框变量 */
            --border-color: #f0f0f0;
            --border-radius-base: 8px;
            
            /* 阴影变量 */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            
            /* 间距变量 */
            --spacing-md: 16px;
            
            /* 组件尺寸 */
            --nav-height: 64px;
            --bottom-tab-height: 60px;
            --safe-area-bottom: env(safe-area-inset-bottom, 0);
        }

        /* 页面容器 */
        .page-container {
            max-width: 390px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            background-color: var(--bg-layout);
        }
        
        /* 顶部导航 */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background-color: var(--primary-color);
            color: white;
            z-index: 999;
            box-shadow: var(--shadow-sm);
        }
        
        .top-nav-container {
            max-width: 390px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--spacing-md);
        }
        
        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .icon-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* 主内容区 */
        .content-container {
            padding-top: calc(var(--nav-height) + var(--spacing-md));
            padding-bottom: calc(var(--bottom-tab-height) + var(--safe-area-bottom) + var(--spacing-md));
        }
        
        .content-area {
            max-width: 390px;
            margin: 0 auto;
            padding: 0 var(--spacing-md);
        }
        
        /* 卡片样式 */
        .card {
            background-color: var(--bg-container);
            border-radius: var(--border-radius-base);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-md);
            overflow: hidden;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            color: var(--text-primary);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        /* 状态标签 */
        .status-tag {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-tag.success {
            background-color: #f6ffed;
            color: var(--success-color);
        }
        
        .status-tag.warning {
            background-color: #fff7e6;
            color: var(--warning-color);
        }
        
        .status-tag.danger {
            background-color: #fff1f0;
            color: var(--error-color);
        }
        
        /* 按钮样式 */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius-base);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        .btn-primary:active {
            background-color: var(--primary-active);
        }
        
        .btn-secondary {
            background-color: white;
            color: var(--text-primary);
            border: 1px solid #d9d9d9;
        }
        
        .btn-secondary:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        /* 扫码区域样式 */
        .scan-container {
            position: relative;
            width: 100%;
            background-color: #000;
            border-radius: var(--border-radius-base);
            overflow: hidden;
            height: 280px;
        }
        
        .scanner-ui {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            pointer-events: none;
        }
        
        .scan-area {
            width: 200px;
            height: 200px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            position: relative;
        }
        
        .scan-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--primary-color);
            box-shadow: 0 0 8px 2px rgba(22, 119, 255, 0.8);
            animation: scan-animation 2s linear infinite;
        }
        
        .scan-corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border-color: var(--primary-color);
            border-width: 4px;
            border-style: solid;
        }
        
        .corner-top-left {
            top: -2px;
            left: -2px;
            border-right: none;
            border-bottom: none;
            border-top-left-radius: 8px;
        }
        
        .corner-top-right {
            top: -2px;
            right: -2px;
            border-left: none;
            border-bottom: none;
            border-top-right-radius: 8px;
        }
        
        .corner-bottom-left {
            bottom: -2px;
            left: -2px;
            border-right: none;
            border-top: none;
            border-bottom-left-radius: 8px;
        }
        
        .corner-bottom-right {
            bottom: -2px;
            right: -2px;
            border-left: none;
            border-top: none;
            border-bottom-right-radius: 8px;
        }
        
        @keyframes scan-animation {
            0% {
                top: 0;
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                top: calc(100% - 2px);
                opacity: 1;
            }
        }
        
        .scan-hint {
            color: white;
            margin-top: 16px;
            font-size: 14px;
            text-align: center;
            text-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
        }
        
        .scan-controls {
            position: absolute;
            bottom: 16px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            pointer-events: auto;
        }
        
        .scan-controls .control-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.3s;
        }
        
        .scan-controls .control-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .scan-controls .control-btn.active {
            background-color: var(--primary-color);
        }
        
        /* 响应式调整 */
        @media (max-width: 390px) {
            .page-container,
            .top-nav-container,
            .content-area {
                max-width: 100%;
            }
        }
        
        /* Toast消息样式 */
        .toast-message {
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 9999;
        }
        
        /* 按钮视觉反馈样式 */
        .trace-button-hover:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            opacity: 0.9;
        }
        
        .trace-button-focus:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        
        .trace-button-active:active {
            transform: scale(0.97);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="page-container">
        <!-- 顶部导航 -->
        <header class="top-nav">
            <div class="top-nav-container">
                <div class="flex items-center">
                    <a href="data-collection-center.html" class="icon-btn mr-3 hover:bg-blue-700 focus:ring focus:outline-none active:bg-blue-800 transition duration-150 ease-in-out" id="backBtn" aria-label="返回到数据采集中心" tabindex="0">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <h1 class="text-lg font-medium">二维码数据采集</h1>
                </div>
                <div class="flex items-center">
                    <div id="network-status" class="mr-2 text-sm">
                        <span class="status-tag success" id="online-status">
                            <i class="fas fa-wifi mr-1"></i>在线
                        </span>
                        <span class="status-tag danger hidden" id="offline-status">
                            <i class="fas fa-exclamation-triangle mr-1"></i>离线
                        </span>
                    </div>
                    <button class="icon-btn trace-button-hover trace-button-focus trace-button-active hover:bg-blue-700 focus:ring focus:outline-none active:bg-blue-800 transition duration-150 ease-in-out" id="btn-pages-farming-qrcode-collection-html-1743910820558-5665" aria-label="帮助" tabindex="0">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- 主内容区 -->
        <main class="content-container">
            <div class="content-area">
                <!-- 扫码区域 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-qrcode text-blue-500 mr-2"></i>
                            <span>扫码采集</span>
                        </div>
                        <div class="flex items-center">
                            <button class="text-blue-500 text-sm trace-button-hover trace-button-focus trace-button-active hover:bg-blue-700 focus:ring focus:outline-none active:bg-blue-800 transition duration-150 ease-in-out" id="btn-pages-farming-qrcode-collection-html-1743910820558-9549" aria-label="切换摄像头" tabindex="0">
                                <i class="fas fa-sync-alt mr-1"></i>
                                <span>切换摄像头</span>
                            </button>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="scan-container mb-3">
                            <video id="scanner" autoplay="" muted="" playsinline=""></video>
                            
                            <div class="scanner-ui">
                                <div class="scan-area">
                                    <div class="scan-corner corner-top-left"></div>
                                    <div class="scan-corner corner-top-right"></div>
                                    <div class="scan-corner corner-bottom-left"></div>
                                    <div class="scan-corner corner-bottom-right"></div>
                                </div>
                                <div class="scan-hint">请将二维码置于扫描框内</div>
                                
                                <div class="scan-controls">
                                    <button class="control-btn trace-button-hover trace-button-focus trace-button-active hover:bg-blue-700 focus:ring focus:outline-none active:bg-blue-800 transition duration-150 ease-in-out" id="btn-pages-farming-qrcode-collection-html-1743910820558-5518" aria-label="打开闪光灯" tabindex="0">
                                        <i class="fas fa-bolt"></i>
                                    </button>
                                    <button class="control-btn trace-button-hover trace-button-focus trace-button-active hover:bg-blue-700 focus:ring focus:outline-none active:bg-blue-800 transition duration-150 ease-in-out" id="btn-pages-farming-qrcode-collection-html-1743910820558-3284" aria-label="拍照" tabindex="0">
                                        <i class="fas fa-camera"></i>
                                    </button>
                                    <button class="control-btn trace-button-hover trace-button-focus trace-button-active hover:bg-blue-700 focus:ring focus:outline-none active:bg-blue-800 transition duration-150 ease-in-out" id="btn-pages-farming-qrcode-collection-html-1743910820559-1969" aria-label="上传图片" tabindex="0">
                                        <i class="fas fa-image"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 扫码说明 -->
                        <div class="text-sm text-gray-500 mb-4">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                                <span>支持畜禽耳标二维码、饲料包装二维码和设备标签二维码</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                                <span>扫码后系统会自动识别二维码类型并记录相应数据</span>
                            </div>
                        </div>
                        
                        <!-- 手动输入选项 -->
                        <div class="flex justify-center">
                            <button class="btn btn-secondary trace-button-hover trace-button-focus trace-button-active hover:bg-blue-700 focus:ring focus:outline-none active:bg-blue-800 transition duration-150 ease-in-out" id="btn-pages-farming-qrcode-collection-html-1743910820559-7168" aria-label="手动输入编码" tabindex="0">
                                <i class="fas fa-keyboard mr-2"></i>手动输入编码
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 扫描记录历史 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-history text-green-500 mr-2"></i>
                            <span>扫描记录</span>
                        </div>
                        <button id="btn-pages-farming-qrcode-collection-html-1743910820559-191" class="text-blue-500 text-sm trace-button-hover trace-button-focus trace-button-active hover:bg-blue-700 focus:ring focus:outline-none active:bg-blue-800 transition duration-150 ease-in-out" aria-label="清空历史" tabindex="0">
                            <i class="fas fa-trash-alt mr-1"></i>
                            <span>清空历史</span>
                        </button>
                    </div>
                    <div id="scan-history" class="divide-y">
                        <!-- 空状态提示 -->
                        <div class="p-8 text-center text-gray-500" id="empty-history">
                            <i class="fas fa-inbox text-gray-300 text-4xl mb-3"></i>
                            <p>暂无扫描记录</p>
                        </div>
                        
                        <!-- 示例记录 (将由JavaScript动态生成) -->
                        <!-- <div class="p-4">
                            <div class="flex justify-between mb-2">
                                <div class="font-medium">耳标: A2-32156789</div>
                                <div class="text-sm text-gray-500">刚刚</div>
                            </div>
                            <div class="text-gray-600 text-sm mb-2">类型: 猪只标识</div>
                            <div class="flex justify-between items-center">
                                <div class="text-sm">
                                    <span class="status-tag success">已保存</span>
                                </div>
                                <button class="text-blue-500 text-sm flex items-center">
                                    <i class="fas fa-edit mr-1"></i>录入信息
                                </button>
                            </div>
                        </div> -->
                    </div>
                </div>
                
                <!-- 批量上传按钮 -->
                <div class="flex justify-center mb-4">
                    <button class="btn btn-primary trace-button-hover trace-button-focus trace-button-active hover:bg-blue-700 focus:ring focus:outline-none active:bg-blue-800 transition duration-150 ease-in-out" id="btn-pages-farming-qrcode-collection-html-1743910820559-7190" aria-label="批量上传数据" tabindex="0">
                        <i class="fas fa-cloud-upload-alt mr-2"></i>批量上传数据
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- 手动输入模态框 -->
    <div class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 hidden" id="manualInputModal">
        <div class="bg-white rounded-lg w-full max-w-md mx-4 shadow-xl">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-medium">手动输入编码</h3>
                <button class="text-gray-500 trace-button-hover trace-button-focus trace-button-active hover:bg-blue-700 focus:ring focus:outline-none active:bg-blue-800 transition duration-150 ease-in-out" id="btn-pages-farming-qrcode-collection-html-1743910820559-6665" aria-label="times" tabindex="0">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="manualEntryForm">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="code-type">
                            编码类型
                        </label>
                        <select id="code-type" class="w-full p-2 border border-gray-300 rounded-md trace-button-focus trace-button-active">
                            <option value="earTag">畜禽耳标</option>
                            <option value="feed">饲料包装</option>
                            <option value="device">设备标签</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="code-value">
                            编码值
                        </label>
                        <input type="text" id="code-value" class="w-full p-2 border border-gray-300 rounded-md trace-button-focus trace-button-active" placeholder="请输入完整编码值">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-medium mb-2" for="code-note">
                            备注 (可选)
                        </label>
                        <textarea id="code-note" class="w-full p-2 border border-gray-300 rounded-md trace-button-focus trace-button-active" rows="2" placeholder="输入相关说明..."></textarea>
                    </div>
                    <div class="modal-footer">
                        <button id="btn-pages-farming-qrcode-collection-html-1743910820559-6104" type="button" class="btn btn-secondary trace-button-hover trace-button-focus trace-button-active hover:bg-blue-700 focus:ring focus:outline-none active:bg-blue-800 transition duration-150 ease-in-out" aria-label="取消" tabindex="0">取消</button>
                        <button id="btn-pages-farming-qrcode-collection-html-1743910820559-3825" type="submit" class="btn btn-primary trace-button-hover trace-button-focus trace-button-active hover:bg-blue-700 focus:ring focus:outline-none active:bg-blue-800 transition duration-150 ease-in-out" aria-label="保存" tabindex="0">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 扫描结果模态框 -->
    <div class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 hidden" id="scanResultModal">
        <div class="bg-white rounded-lg w-full max-w-md mx-4 shadow-xl">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-medium">扫描结果</h3>
                <button id="btn-pages-farming-qrcode-collection-html-1743910820559-2825" class="text-gray-500 trace-button-hover trace-button-focus trace-button-active hover:bg-blue-700 focus:ring focus:outline-none active:bg-blue-800 transition duration-150 ease-in-out" aria-label="关闭" tabindex="0">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <div class="text-center mb-4">
                    <span class="inline-block bg-green-100 text-green-800 text-xl rounded-full p-3 mb-2">
                        <i class="fas fa-check"></i>
                    </span>
                    <h4 class="text-lg font-medium">扫描成功</h4>
                </div>
                
                <div class="border border-gray-200 rounded-lg p-3 mb-4 bg-gray-50">
                    <div class="mb-2">
                        <span class="text-gray-500 text-sm">编码类型:</span>
                        <span class="font-medium ml-1" id="result-type">耳标</span>
                    </div>
                    <div class="mb-2">
                        <span class="text-gray-500 text-sm">编码值:</span>
                        <span class="font-medium ml-1" id="result-value">A2-32156789</span>
                    </div>
                    <div>
                        <span class="text-gray-500 text-sm">扫描时间:</span>
                        <span class="text-sm ml-1" id="result-time">2023-04-05 15:23</span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="result-note">
                        添加备注 (可选)
                    </label>
                    <textarea id="result-note" class="w-full p-2 border border-gray-300 rounded-md trace-button-focus trace-button-active" rows="2" placeholder="输入相关说明..."></textarea>
                </div>
                
                <div class="flex justify-end gap-2 mt-4">
                    <button id="btn-pages-farming-qrcode-collection-html-1743910820559-3624" class="btn btn-secondary trace-button-hover trace-button-focus trace-button-active hover:bg-blue-700 focus:ring focus:outline-none active:bg-blue-800 transition duration-150 ease-in-out" aria-label="重新扫描" tabindex="0">
                        <i class="fas fa-redo mr-1"></i>
                        <span>重新扫描</span>
                    </button>
                    <button id="btn-pages-farming-qrcode-collection-html-1743910820559-1971" class="btn btn-primary trace-button-hover trace-button-focus trace-button-active hover:bg-blue-700 focus:ring focus:outline-none active:bg-blue-800 transition duration-150 ease-in-out" aria-label="保存结果" tabindex="0">
                        <i class="fas fa-check mr-1"></i>
                        <span>保存结果</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 引入jsQR库用于二维码扫描 -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <!-- 页面脚本 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM元素
            const video = document.getElementById('scanner');
            const scanContainer = document.querySelector('.scan-container');
            const manualInputBtn = document.getElementById('manualInputBtn');
            const switchCameraBtn = document.getElementById('switchCameraBtn');
            const toggleFlashBtn = document.getElementById('toggleFlashBtn');
            const capturePhotoBtn = document.getElementById('capturePhotoBtn');
            const uploadQrBtn = document.getElementById('uploadQrBtn');
            const scanHistory = document.getElementById('scan-history');
            const emptyHistory = document.getElementById('empty-history');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            const batchUploadBtn = document.getElementById('batchUploadBtn');
            
            // 模态框元素
            const manualInputModal = document.getElementById('manualInputModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const cancelModalBtn = document.getElementById('cancelModalBtn');
            const manualEntryForm = document.getElementById('manualEntryForm');
            
            const scanResultModal = document.getElementById('scanResultModal');
            const closeScanResultBtn = document.getElementById('closeScanResultBtn');
            const scanAgainBtn = document.getElementById('scanAgainBtn');
            const saveResultBtn = document.getElementById('saveResultBtn');
            const resultType = document.getElementById('result-type');
            const resultValue = document.getElementById('result-value');
            const resultTime = document.getElementById('result-time');
            
            // 网络状态监控
            updateNetworkStatus(navigator.onLine);
            window.addEventListener('online', () => updateNetworkStatus(true));
            window.addEventListener('offline', () => updateNetworkStatus(false));
            
            // 更新网络状态显示
            function updateNetworkStatus(isOnline) {
                const onlineStatus = document.getElementById('online-status');
                const offlineStatus = document.getElementById('offline-status');
                
                if (isOnline) {
                    onlineStatus.classList.remove('hidden');
                    offlineStatus.classList.add('hidden');
                } else {
                    onlineStatus.classList.add('hidden');
                    offlineStatus.classList.remove('hidden');
                }
            }
            
            // 扫描变量
            let scanner;
            let stream;
            let canvasElement;
            let canvas;
            let scanning = false;
            let currentCamera = 'environment'; // 'environment' 或 'user'
            let flashAvailable = false;
            let flashOn = false;
            
            // 初始化摄像头
            initCamera();
            
            // 初始化扫描历史记录
            initScanHistory();
            
            // 帮助按钮点击事件
            document.getElementById('helpBtn').addEventListener('click', function() {
                showToast('扫描二维码以快速采集养殖数据');
            });
            
            // 返回按钮点击事件
            document.getElementById('backBtn').addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = 'data-collection-center.html';
            });
            
            // 手动输入按钮点击事件
            manualInputBtn.addEventListener('click', function() {
                manualInputModal.classList.remove('hidden');
            });
            
            // 关闭模态框按钮事件
            closeModalBtn.addEventListener('click', function() {
                manualInputModal.classList.add('hidden');
            });
            
            // 取消按钮事件
            cancelModalBtn.addEventListener('click', function() {
                manualInputModal.classList.add('hidden');
            });
            
            // 切换摄像头按钮事件
            switchCameraBtn.addEventListener('click', function() {
                currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
                if (stream) {
                    stopCamera();
                }
                initCamera();
                showToast('切换' + (currentCamera === 'environment' ? '后置' : '前置') + '摄像头');
            });
            
            // 闪光灯按钮事件
            toggleFlashBtn.addEventListener('click', function() {
                toggleFlash();
            });
            
            // 拍照按钮事件
            capturePhotoBtn.addEventListener('click', function() {
                capturePhotoForScan();
            });
            
            // 上传图片按钮事件
            uploadQrBtn.addEventListener('click', function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            processUploadedImage(event.target.result);
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            });
            
            // 清空历史按钮事件
            clearHistoryBtn.addEventListener('click', function() {
                if (confirm('确定要清空所有扫描记录吗？')) {
                    localStorage.removeItem('qrScanHistory');
                    scanHistory.innerHTML = '';
                    scanHistory.appendChild(emptyHistory);
                    emptyHistory.classList.remove('hidden');
                    showToast('扫描记录已清空');
                }
            });
            
            // 批量上传按钮事件
            batchUploadBtn.addEventListener('click', function() {
                const history = getScanHistory();
                const pendingItems = history.filter(item => !item.uploaded);
                
                if (pendingItems.length === 0) {
                    showToast('没有待上传的数据');
                    return;
                }
                
                uploadScanData(pendingItems);
            });
            
            // 表单提交事件
            manualEntryForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const codeType = document.getElementById('code-type').value;
                const codeValue = document.getElementById('code-value').value;
                const codeNote = document.getElementById('code-note').value;
                
                if (!codeValue) {
                    showToast('请输入编码值');
                    return;
                }
                
                // 创建记录
                const record = {
                    id: Date.now().toString(),
                    type: getTypeLabel(codeType),
                    value: codeValue,
                    rawType: codeType,
                    note: codeNote,
                    timestamp: new Date().toISOString(),
                    uploaded: false
                };
                
                // 保存记录并更新UI
                saveScanRecord(record);
                
                // 关闭模态框
                manualInputModal.classList.add('hidden');
                
                // 清空表单
                document.getElementById('code-value').value = '';
                document.getElementById('code-note').value = '';
                
                showToast('编码已保存');
            });
            
            // 扫描结果模态框事件
            closeScanResultBtn.addEventListener('click', function() {
                scanResultModal.classList.add('hidden');
                resumeScanning();
            });
            
            // 继续扫描按钮事件
            scanAgainBtn.addEventListener('click', function() {
                scanResultModal.classList.add('hidden');
                resumeScanning();
            });
            
            // 保存结果按钮事件
            saveResultBtn.addEventListener('click', function() {
                // 获取备注
                const note = document.getElementById('result-note').value;
                
                // 创建记录对象
                const record = {
                    id: Date.now().toString(),
                    type: resultType.textContent,
                    value: resultValue.textContent,
                    rawType: getTypeValue(resultType.textContent),
                    note: note,
                    timestamp: new Date().toISOString(),
                    uploaded: false
                };
                
                // 保存记录并更新UI
                saveScanRecord(record);
                
                // 关闭模态框并继续扫描
                scanResultModal.classList.add('hidden');
                resumeScanning();
                
                showToast('扫描结果已保存');
            });
            
            // 初始化摄像头
            function initCamera() {
                canvasElement = document.createElement('canvas');
                canvas = canvasElement.getContext('2d');
                
                // 请求摄像头访问权限
                const constraints = {
                    video: {
                        facingMode: { ideal: currentCamera },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(function(mediaStream) {
                        stream = mediaStream;
                        video.srcObject = stream;
                        
                        // 检查闪光灯是否可用
                        const track = stream.getVideoTracks()[0];
                        const capabilities = track.getCapabilities();
                        flashAvailable = capabilities.torch || false;
                        toggleFlashBtn.style.display = flashAvailable ? 'flex' : 'none';
                        
                        video.onloadedmetadata = function() {
                            video.play();
                            requestAnimationFrame(tick);
                            scanning = true;
                        };
                    })
                    .catch(function(err) {
                        console.error('无法访问摄像头:', err);
                        showToast('无法访问摄像头，请检查权限设置');
                    });
            }
            
            // 停止摄像头
            function stopCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                    scanning = false;
                }
            }
            
            // 扫描帧处理
            function tick() {
                if (!scanning) return;
                
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvasElement.height = video.videoHeight;
                    canvasElement.width = video.videoWidth;
                    canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                    const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                    
                    // 使用jsQR库进行扫描
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (code) {
                        console.log('找到二维码:', code.data);
                        
                        // 暂停扫描
                        scanning = false;
                        
                        // 处理扫描结果
                        processScanResult(code.data);
                    }
                }
                
                // 继续请求下一帧
                if (scanning) {
                    requestAnimationFrame(tick);
                }
            }
            
            // 重新开始扫描
            function resumeScanning() {
                scanning = true;
                requestAnimationFrame(tick);
            }
            
            // 处理扫描结果
            function processScanResult(data) {
                // 解析二维码数据
                const result = parseQrData(data);
                
                // 播放扫描成功声音
                playBeepSound();
                
                // 设置结果模态框
                resultType.textContent = result.type;
                resultValue.textContent = result.value;
                
                const now = new Date();
                resultTime.textContent = now.toLocaleString('zh-CN');
                
                // 清空备注
                document.getElementById('result-note').value = '';
                
                // 显示结果模态框
                scanResultModal.classList.remove('hidden');
            }
            
            // 解析二维码数据
            function parseQrData(data) {
                // 通过二维码数据特征识别类型
                // 这里是简化实现，实际项目需要根据具体业务需求进行定制
                
                // 耳标格式: 'TAG:A2-XXXXX' 或者 'A2-XXXXX'
                if (data.startsWith('TAG:') || /^[A-Z]\d-\d+$/.test(data)) {
                    const value = data.startsWith('TAG:') ? data.substring(4) : data;
                    return {
                        type: '耳标',
                        value: value
                    };
                }
                
                // 饲料包装格式: 'FEED:XXX-XXX-XXX' 或者 'XXX-XXX-XXX(F)'
                if (data.startsWith('FEED:') || data.includes('(F)')) {
                    const value = data.startsWith('FEED:') ? data.substring(5) : data;
                    return {
                        type: '饲料包装',
                        value: value
                    };
                }
                
                // 设备标签格式: 'DEV:XXXX' 或者 'DEV-XXXX'
                if (data.startsWith('DEV:') || data.startsWith('DEV-')) {
                    const value = data.startsWith('DEV:') ? data.substring(4) : data.substring(4);
                    return {
                        type: '设备标签',
                        value: value
                    };
                }
                
                // 默认视为其他类型
                return {
                    type: '未识别类型',
                    value: data
                };
            }
            
            // 播放扫描成功声音
            function playBeepSound() {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.value = 1500;
                gainNode.gain.value = 0.5;
                
                oscillator.start();
                
                setTimeout(function() {
                    oscillator.stop();
                }, 100);
            }
            
            // 切换闪光灯
            function toggleFlash() {
                if (!flashAvailable) return;
                
                const track = stream.getVideoTracks()[0];
                
                try {
                    flashOn = !flashOn;
                    track.applyConstraints({
                        advanced: [{ torch: flashOn }]
                    });
                    
                    toggleFlashBtn.classList.toggle('active', flashOn);
                    showToast(flashOn ? '闪光灯已开启' : '闪光灯已关闭');
                } catch (err) {
                    console.error('无法控制闪光灯:', err);
                    showToast('设备可能不支持闪光灯控制');
                }
            }
            
            // 拍照并扫描二维码
            function capturePhotoForScan() {
                if (!stream) return;
                
                // 暂停扫描
                scanning = false;
                
                // 创建canvas并绘制当前视频帧
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // 获取图像数据
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // 扫描二维码
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                
                if (code) {
                    console.log('照片中找到二维码:', code.data);
                    processScanResult(code.data);
                } else {
                    showToast('未在照片中找到二维码');
                    resumeScanning();
                }
            }
            
            // 处理上传的图片
            function processUploadedImage(dataUrl) {
                const img = new Image();
                img.onload = function() {
                    // 创建canvas并绘制图片
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    // 获取图像数据
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // 扫描二维码
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (code) {
                        console.log('上传图片中找到二维码:', code.data);
                        processScanResult(code.data);
                    } else {
                        showToast('未在图片中找到二维码');
                        resumeScanning();
                    }
                };
                img.src = dataUrl;
            }
            
            // 初始化扫描历史记录
            function initScanHistory() {
                const history = getScanHistory();
                
                if (history.length === 0) {
                    return;
                }
                
                // 隐藏空状态
                emptyHistory.classList.add('hidden');
                
                // 添加历史记录到UI
                history.forEach(record => {
                    addRecordToUI(record);
                });
            }
            
            // 获取扫描历史记录
            function getScanHistory() {
                const historyJson = localStorage.getItem('qrScanHistory');
                return historyJson ? JSON.parse(historyJson) : [];
            }
            
            // 保存扫描记录
            function saveScanRecord(record) {
                const history = getScanHistory();
                history.unshift(record); // 添加到数组开头
                
                // 限制记录数量，最多保存30条
                if (history.length > 30) {
                    history.length = 30;
                }
                
                // 保存到本地存储
                localStorage.setItem('qrScanHistory', JSON.stringify(history));
                
                // 隐藏空状态
                emptyHistory.classList.add('hidden');
                
                // 添加到UI
                addRecordToUI(record, true);
            }
            
            // 添加记录到UI
            function addRecordToUI(record, isNew = false) {
                const recordElement = document.createElement('div');
                recordElement.className = 'p-4' + (isNew ? ' bg-blue-50' : '');
                recordElement.id = 'record-' + record.id;
                
                const timestamp = new Date(record.timestamp);
                const timeStr = formatTimestamp(timestamp);
                
                recordElement.innerHTML = `
                    <div class="flex justify-between mb-2">
                        <div class="font-medium">${record.type}: ${record.value}</div>
                        <div class="text-sm text-gray-500">${timeStr}</div>
                    </div>
                    <div class="text-gray-600 text-sm mb-2">${record.note ? '备注: ' + record.note : ''}</div>
                    <div class="flex justify-between items-center">
                        <div class="text-sm">
                            <span class="status-tag ${record.uploaded ? 'success' : 'warning'}">${record.uploaded ? '已上传' : '待上传'}</span>
                        </div>
                        <button class="text-blue-500 text-sm flex items-center edit-record-btn" data-id="${record.id}">
                            <i class="fas fa-edit mr-1"></i>编辑
                        </button>
                    </div>
                `;
                
                // 如果是新记录，添加到列表开头
                if (isNew) {
                    scanHistory.insertBefore(recordElement, scanHistory.firstChild);
                    
                    // 添加动画效果
                    setTimeout(() => {
                        recordElement.classList.remove('bg-blue-50');
                    }, 2000);
                } else {
                    scanHistory.appendChild(recordElement);
                }
                
                // 添加编辑按钮事件
                recordElement.querySelector('.edit-record-btn').addEventListener('click', function() {
                    // 实现编辑功能
                    const recordId = this.getAttribute('data-id');
                    editRecord(recordId);
                });
            }
            
            // 编辑记录功能
            function editRecord(recordId) {
                const history = getScanHistory();
                const record = history.find(item => item.id === recordId);
                
                if (!record) return;
                
                // 在实际项目中，这里应该弹出编辑模态框
                // 简单起见，这里只是显示一个提示
                showToast('编辑功能开发中');
            }
            
            // 上传扫描数据
            function uploadScanData(items) {
                // 显示上传中状态
                showToast('正在上传数据...');
                
                // 模拟API请求延迟
                setTimeout(() => {
                    // 模拟成功率90%
                    const success = Math.random() < 0.9;
                    
                    if (success) {
                        // 更新记录状态
                        const history = getScanHistory();
                        
                        items.forEach(item => {
                            const index = history.findIndex(h => h.id === item.id);
                            if (index !== -1) {
                                history[index].uploaded = true;
                                
                                // 更新UI
                                const recordElement = document.getElementById('record-' + item.id);
                                if (recordElement) {
                                    const statusTag = recordElement.querySelector('.status-tag');
                                    statusTag.textContent = '已上传';
                                    statusTag.classList.remove('warning');
                                    statusTag.classList.add('success');
                                }
                            }
                        });
                        
                        // 保存更新后的历史记录
                        localStorage.setItem('qrScanHistory', JSON.stringify(history));
                        
                        showToast(`成功上传 ${items.length} 条数据`);
                    } else {
                        showToast('上传失败，请稍后重试');
                    }
                }, 1500);
            }
            
            // 格式化时间戳
            function formatTimestamp(timestamp) {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                // 今天
                if (timestamp >= today) {
                    return timestamp.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                }
                // 昨天
                else if (timestamp >= yesterday) {
                    return '昨天 ' + timestamp.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                }
                // 更早
                else {
                    return timestamp.toLocaleDateString('zh-CN');
                }
            }
            
            // 类型标签映射
            function getTypeLabel(typeValue) {
                const typeMap = {
                    'earTag': '耳标',
                    'feed': '饲料包装',
                    'device': '设备标签',
                    'other': '其他'
                };
                
                return typeMap[typeValue] || '未知类型';
            }
            
            // 类型值映射（反向）
            function getTypeValue(typeLabel) {
                const typeMap = {
                    '耳标': 'earTag',
                    '饲料包装': 'feed',
                    '设备标签': 'device',
                    '未识别类型': 'other',
                    '其他': 'other'
                };
                
                return typeMap[typeLabel] || 'other';
            }
            
            // 显示Toast消息
            function showToast(message) {
                // 移除现有的toast
                const existingToast = document.querySelector('.toast-message');
                if (existingToast) {
                    existingToast.remove();
                }
                
                // 创建新的toast
                const toast = document.createElement('div');
                toast.className = 'toast-message fixed top-16 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg text-sm z-50 opacity-0 transition-opacity duration-300';
                toast.innerText = message;
                document.body.appendChild(toast);
                
                // 显示toast
                setTimeout(() => {
                    toast.classList.replace('opacity-0', 'opacity-90');
                }, 100);
                
                // 3秒后隐藏toast
                setTimeout(() => {
                    toast.classList.replace('opacity-90', 'opacity-0');
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }, 3000);
            }
        });
    </script>

 </body></html>