# 三星Galaxy设备调试指南

本指南帮助排查三星设备上的显示和数据问题。

---

## 问题症状

### 已知问题
1. **文字显示为空白** - 管理页面只显示图标，没有中文文字
2. **数据全是0** - 首页统计数据显示 `0.0 kg`, `0/1`, `0/0`
3. **用户信息不完整** - 显示"未知鱼色"等奇怪标签

---

## 修复步骤

### 步骤1：重新打包APK（必须执行）

在执行以下修复后，必须重新打包APK：

```bash
cd frontend/CretasFoodTrace

# 清理缓存（重要！）
rm -rf android/app/build
rm -rf .expo
npx expo start --clear

# 重新生成Android项目
npx expo prebuild --clean --platform android

# 打包生产APK
cd android
./gradlew clean
./gradlew assembleRelease

# APK位置
# android/app/build/outputs/apk/release/app-release.apk
```

### 步骤2：安装新APK

**重要**：先卸载旧版本，再安装新版本

```bash
# 方法1：通过adb安装（推荐）
adb install -r android/app/build/outputs/apk/release/app-release.apk

# 方法2：手动安装
# 1. 卸载旧版本
# 2. 传输APK到手机
# 3. 安装新APK
```

---

## 问题排查

### 排查1：网络连接测试

**目的**：确认三星设备能否访问后端服务器

#### 方法A：浏览器测试（最简单）

在三星手机的浏览器（Chrome/Samsung Browser）中打开：

```
http://139.196.165.140:10010/api/mobile/health
```

**预期结果**：
- ✅ **正常**：显示JSON数据，如 `{"status":"UP"}`
- ❌ **异常**：显示"无法访问"、"连接超时"

**如果无法访问**，可能原因：
1. 手机网络问题（尝试切换WiFi/4G）
2. 服务器防火墙阻止（需要联系服务器管理员）
3. 公司网络限制（尝试使用手机流量）

#### 方法B：Ping测试

```bash
# 在三星设备上安装终端模拟器（如Termux）
ping 139.196.165.140
```

### 排查2：查看Logcat日志

**目的**：查看应用运行时的错误信息

#### 步骤1：连接设备到电脑

```bash
# 确认设备已连接
adb devices

# 应该显示类似：
# List of devices attached
# R5CR80XXXXX    device
```

#### 步骤2：查看实时日志

```bash
# 方法1：查看所有错误
adb logcat *:E

# 方法2：筛选关键信息（推荐）
adb logcat | grep -E "API|Network|Font|Error|cretas"

# 方法3：保存到文件
adb logcat > samsung_debug.log
```

#### 步骤3：分析日志

**查找以下关键错误**：

**网络相关**：
```
E/NetworkError: Failed to fetch
E/AxiosError: timeout of 30000ms exceeded
E/CORS: Access-Control-Allow-Origin
```
→ **解决**：检查网络连接，执行"网络连接测试"

**字体相关**：
```
W/RNPaper: Font not found
E/ReactNativeJS: fontFamily not loaded
```
→ **解决**：已通过修改 `app.json` 解决

**API相关**：
```
E/API: 401 Unauthorized
E/API: 500 Internal Server Error
```
→ **解决**：检查登录Token，尝试重新登录

### 排查3：环境变量检查

**目的**：确认APK使用正确的API地址

#### 查看应用日志

在Logcat中搜索：
```bash
adb logcat | grep "API Config"
```

**应该看到**：
```
[API Config] Using API URL from environment: http://139.196.165.140:10010
```

**如果看到**：
```
[API Config] Using default API URL: http://139.196.165.140:10010
```
→ 也是正常的（fallback到默认值）

**如果看到localhost或10.0.2.2**：
```
[API Config] Using API URL: http://localhost:10010
```
→ **错误！**需要重新打包APK

---

## 常见问题FAQ

### Q1: 重新打包后还是看不到文字？

**可能原因**：
1. 没有清理缓存（执行 `npx expo start --clear`）
2. 没有卸载旧版本APK（必须先卸载）
3. 三星设备字体渲染问题（系统级别）

**解决方法**：
```bash
# 完全清理重新打包
cd frontend/CretasFoodTrace
rm -rf android
rm -rf .expo
npx expo prebuild --clean --platform android
cd android
./gradlew clean assembleRelease
```

### Q2: 数据还是全是0？

**排查步骤**：
1. ✅ 浏览器能访问 `http://139.196.165.140:10010/api/mobile/health`
2. ✅ Logcat没有网络错误
3. ✅ 能正常登录

**如果以上都正常**，查看具体API请求：
```bash
adb logcat | grep -E "axios|fetch|API"
```

查找失败的请求，如：
```
E/axios: GET http://139.196.165.140:10010/api/mobile/CRETAS_2024_001/dashboard/stats
Response: 401 Unauthorized
```

→ Token失败，需要重新登录

### Q3: 如何验证修复是否生效？

**检查清单**：

1. **环境变量修复验证**：
   ```bash
   # 查看Logcat日志
   adb logcat | grep "API Config"
   # 应该显示正确的API地址
   ```

2. **字体修复验证**：
   - 管理页面能看到中文文字（不只是图标）
   - 所有页面文字正常显示

3. **网络修复验证**：
   ```bash
   # 查看网络请求
   adb logcat | grep -E "axios.*success|API.*200"
   # 应该看到成功的请求
   ```

4. **数据加载验证**：
   - 首页统计数据不是全0
   - 能看到实际的批次、产量等数据

### Q4: 仍然无法解决？

**收集以下信息**：

1. **设备信息**：
   ```bash
   adb shell getprop ro.build.version.release  # Android版本
   adb shell getprop ro.product.model          # 设备型号
   ```

2. **完整日志**：
   ```bash
   adb logcat > full_log.txt
   # 运行应用30秒，重现问题
   # Ctrl+C停止
   ```

3. **网络测试结果**：
   - 浏览器能否访问API
   - Ping测试结果

4. **截图**：
   - 问题页面截图
   - Logcat错误截图

---

## 技术细节

### 修复内容说明

#### 1. 环境变量读取修复

**修改前** (`config.ts`):
```typescript
const envUrl = process.env.REACT_APP_API_URL;  // ❌ 读取失败
```

**修改后**:
```typescript
import { REACT_APP_API_URL } from '@env';      // ✅ 正确读取
const envUrl = REACT_APP_API_URL;
```

#### 2. Android网络配置

**修改内容** (`app.json`):
```json
{
  "android": {
    "usesCleartextTraffic": true,  // 允许HTTP请求
    "versionCode": 2               // 版本号升级
  }
}
```

**作用**：
- `usesCleartextTraffic: true` - Android 9+默认禁止HTTP，必须启用
- `versionCode: 2` - 新APK可以覆盖旧版本

---

## 联系支持

如果以上步骤都无法解决问题，请提供：

1. 设备型号和Android版本
2. 完整的Logcat日志（`adb logcat > log.txt`）
3. 网络测试截图（浏览器访问API）
4. 问题页面截图

---

**最后更新**: 2024-11-27
**适用版本**: v1.0.0+
