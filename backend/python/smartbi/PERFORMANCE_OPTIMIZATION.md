# SmartBI æ€§èƒ½ä¼˜åŒ–è®¡åˆ’

**åˆ›å»ºæ—¥æœŸ**: 2026-01-27
**æœ€åæ›´æ–°**: 2026-01-27
**çŠ¶æ€**: å¾…ä¼˜åŒ–

---

## 1. æ€§èƒ½æµ‹è¯•åŸºå‡†

### æµ‹è¯•ç¯å¢ƒ
- **æµ‹è¯•æ–‡ä»¶**: Test.xlsx (884KB, 11 sheets)
- **æµ‹è¯•æ—¶é—´**: 2026-01-27
- **æµ‹è¯•é…ç½®**: depth=standard, max_charts=3, max_insights=3

### å½“å‰æ€§èƒ½åŸºå‡† (æ— ç¼“å­˜, æ¯ sheet å¹³å‡)

| é˜¶æ®µ | è€—æ—¶ | å æ¯” | ä¼˜å…ˆçº§ |
|------|------|------|--------|
| insight_generation | 34.8s | 50.5% | P0 |
| chart_recommendation | 16.9s | 24.5% | P0 |
| field_detection | 7.8s | 11.3% | P1 |
| scenario_detection | 7.4s | 10.7% | P1 |
| raw_export | 2.2s | 3.2% | P2 |
| data_cleaning | 17ms | <0.1% | - |
| cache_save | 21ms | <0.1% | - |
| build_dataframe | 2ms | <0.1% | - |

**æ€»è®¡**: ~69ç§’/sheet (æ— ç¼“å­˜)
**ç¼“å­˜å‘½ä¸­**: 3-5ms/sheet

---

## 2. å·²è¯†åˆ«çš„æ€§èƒ½é—®é¢˜

### 2.1 P0: LLM è°ƒç”¨ç“¶é¢ˆ

#### é—®é¢˜: insight_generation è€—æ—¶è¿‡é•¿ (34.8s)
- **æ ¹å› **: å•æ¬¡ LLM è°ƒç”¨å¤„ç†å¤§é‡æ•°æ®ï¼Œç”Ÿæˆå¤šä¸ªæ´å¯Ÿ
- **è¡¨ç°**: å æ€»æ—¶é—´ 50%+
- **å½±å“**: ä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒ

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```
æ–¹æ¡ˆ A: ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹ (qwen-turbo)
æ–¹æ¡ˆ B: å‡å°‘å‘é€ç»™ LLM çš„æ•°æ®é‡
æ–¹æ¡ˆ C: åˆ†æ‰¹ç”Ÿæˆæ´å¯Ÿï¼Œé¦–æ‰¹å¿«é€Ÿè¿”å›
æ–¹æ¡ˆ D: é¢„è®¡ç®—ç»Ÿè®¡ç‰¹å¾ï¼Œå‡å°‘ LLM æ¨ç†è´Ÿæ‹…
```

#### é—®é¢˜: chart_recommendation è€—æ—¶è¿‡é•¿ (16.9s)
- **æ ¹å› **: LLM éœ€è¦åˆ†ææ•°æ®ç»“æ„å¹¶æ¨èæœ€ä½³å›¾è¡¨
- **è¡¨ç°**: å æ€»æ—¶é—´ 24%
- **å½±å“**: é˜»å¡åˆ†æç»“æœè¿”å›

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```
æ–¹æ¡ˆ A: åŸºäº field æ£€æµ‹ç»“æœçš„è§„åˆ™å¿«é€Ÿæ¨è + LLM å¢å¼º
æ–¹æ¡ˆ B: ç¼“å­˜ç›¸ä¼¼ç»“æ„çš„æ¨èç»“æœ
æ–¹æ¡ˆ C: ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹
```

### 2.2 P1: LLM æ£€æµ‹ä¸²è¡Œæ‰§è¡Œ

#### é—®é¢˜: field_detection å’Œ scenario_detection ä¸²è¡Œ
- **å½“å‰**: 7.8s + 7.4s = 15.2s (ä¸²è¡Œ)
- **ç†è®º**: max(7.8s, 7.4s) â‰ˆ 8s (å¹¶è¡Œ)
- **æ½œåœ¨èŠ‚çœ**: ~7s

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
# å½“å‰ (æµ‹è¯•è„šæœ¬ä¸­ä¸²è¡Œ)
fields = await field_detector.detect(...)
scenario = await scenario_detector.detect(...)

# ä¼˜åŒ–å (å¹¶è¡Œ)
fields, scenario = await asyncio.gather(
    field_detector.detect(...),
    scenario_detector.detect(...)
)
```

#### é—®é¢˜: Phase 3 åˆ†ææœªçœŸæ­£å¹¶è¡Œ
- **å½“å‰**: metric + chart + insight å®é™…ä¸²è¡Œæ‰§è¡Œ
- **ç†è®ºèŠ‚çœ**: å¯èŠ‚çœ ~30s (å–æœ€æ…¢çš„è€Œéç´¯åŠ )

### 2.3 P2: æ•°æ®å¤„ç†é—®é¢˜

#### é—®é¢˜: DataFrame é‡å¤åˆ—å
- **è¡¨ç°**: `DataFrame columns are not unique, some columns will be omitted`
- **æ ¹å› **: Excel åˆå¹¶å•å…ƒæ ¼å¯¼è‡´å¤šåˆ—åŒå
- **å½±å“**: to_dict() ä¸¢å¤±æ•°æ®ï¼Œç±»å‹åˆ¤æ–­é”™è¯¯

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
# åœ¨ build_dataframe é˜¶æ®µå¤„ç†é‡å¤åˆ—å
def deduplicate_columns(df):
    cols = []
    seen = {}
    for c in df.columns:
        if c in seen:
            seen[c] += 1
            cols.append(f"{c}_{seen[c]}")
        else:
            seen[c] = 0
            cols.append(c)
    df.columns = cols
    return df
```

#### é—®é¢˜: å…¬å¼è®¡ç®—ç±»å‹ä¸åŒ¹é…
- **è¡¨ç°**: `unsupported operand type(s) for +: 'float' and 'str'`
- **æ ¹å› **: åˆ—åŒ…å«æ··åˆç±»å‹ (æ•°å­— + æ–‡æœ¬)
- **å½±å“**: æŒ‡æ ‡è®¡ç®—å¤±è´¥

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
# åœ¨è®¡ç®—å‰è¿›è¡Œç±»å‹è½¬æ¢
def safe_numeric_operation(series):
    return pd.to_numeric(series, errors='coerce')
```

#### é—®é¢˜: LLM JSON è§£æå¤±è´¥
- **è¡¨ç°**: `Expecting ',' delimiter` æˆ– `'NoneType' object is not iterable`
- **æ ¹å› **: LLM è¾“å‡ºæ ¼å¼ä¸ç¨³å®š
- **å½±å“**: å¶å‘æ€§å¤±è´¥

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
# å¢å¼º JSON è§£æå®¹é”™
def parse_llm_json(response):
    # 1. å°è¯•æ ‡å‡†è§£æ
    # 2. å°è¯•ä¿®å¤å¸¸è§é”™è¯¯ (ç¼ºå°‘é€—å·, å¤šä½™é€—å·)
    # 3. å°è¯•æ­£åˆ™æå– JSON å—
    # 4. é™çº§è¿”å›ç©ºç»“æœ
```

---

## 3. ä¼˜åŒ–è·¯çº¿å›¾

### Phase 1: å¿«é€Ÿä¼˜åŒ– (1-2å¤©)
- [ ] field_detection + scenario_detection å¹¶è¡Œæ‰§è¡Œ
- [ ] chart + insight çœŸæ­£å¹¶è¡Œæ‰§è¡Œ
- [ ] é¢„æœŸæ•ˆæœ: 69s â†’ 40s (-42%)

### Phase 2: æ¨¡å‹ä¼˜åŒ– (2-3å¤©)
- [ ] insight_generation ä½¿ç”¨ qwen-turbo
- [ ] å‡å°‘å‘é€ç»™ LLM çš„æ•°æ®é‡ (é‡‡æ ·)
- [ ] é¢„æœŸæ•ˆæœ: 40s â†’ 25s (-37%)

### Phase 3: æ•°æ®å¤„ç†ä¼˜åŒ– (1-2å¤©)
- [ ] é‡å¤åˆ—åå»é‡
- [ ] ç±»å‹å®‰å…¨çš„æ•°å€¼è®¡ç®—
- [ ] LLM JSON è§£æå®¹é”™
- [ ] é¢„æœŸæ•ˆæœ: å‡å°‘é”™è¯¯ç‡

### Phase 4: é«˜çº§ä¼˜åŒ– (å¯é€‰)
- [ ] æµå¼è¿”å›é¦–æ‰¹ç»“æœ
- [ ] ç»“æ„ç›¸ä¼¼æ€§ç¼“å­˜
- [ ] æ‰¹é‡ sheet æ™ºèƒ½è°ƒåº¦

---

## 4. æµ‹è¯•è®°å½•

### 2026-01-27 æµ‹è¯• #2: å®Œæ•´ 11 sheets æµ‹è¯•

**é…ç½®**: Test.xlsx, 11 sheets, depth=standard

**æ€»ä½“ç»Ÿè®¡**:
- **æ€»æ—¶é—´**: 644.3ç§’ (10.7åˆ†é’Ÿ)
- **æˆåŠŸç‡**: 11/11 (100%)
- **å¹³å‡æ¯ sheet**: 58.6ç§’

**é˜¶æ®µæ€§èƒ½æ±‡æ€»**:

| é˜¶æ®µ | å¹³å‡è€—æ—¶ | æœ€å° | æœ€å¤§ | æ€»è®¡ |
|------|---------|------|------|------|
| insight_generation | 36.3s | 33.8s | 37.7s | 399.1s |
| chart_recommendation | 9.4s | 0ms | 18.5s | 102.9s |
| field_detection | 5.7s | 0.06s | 10.3s | 62.4s |
| scenario_detection | 5.1s | 0ms | 7.7s | 55.8s |
| raw_export | 2.1s | 1.5s | 2.5s | 22.9s |

**å„ Sheet è¯¦æƒ…**:

| Sheet | åç§° | æ€»æ—¶é—´ | field | scenario | chart | insight |
|-------|------|--------|-------|----------|-------|---------|
| 0 | ç´¢å¼• | 65.4s | 6.3s | 7.0s | 15.9s | 34.7s |
| 1 | æ”¶å…¥åŠå‡€åˆ©ç®€è¡¨ | 68.9s | 6.8s | 7.2s | 18.2s | 34.8s |
| 2 | 2025å¹´é”€å”®1ä¸­å¿ƒåˆ©æ¶¦è¡¨ | 71.3s | 9.1s | 6.1s | 16.4s | 37.6s |
| 3 | 2025å¹´ä¸­å¿ƒåˆ©æ¶¦è¡¨ | 52.3s | 9.5s | 6.5s | 0ms* | 34.4s |
| 4 | 2025å¹´æ±Ÿè‹åˆ†éƒ¨åˆ©æ¶¦è¡¨ | 75.9s | 10.3s | 7.1s | 18.5s | 37.7s |
| 5 | 2025å¹´æµ™æ±Ÿåˆ†éƒ¨åˆ©æ¶¦è¡¨ | 64.4s | 0.06s* | 7.5s | 17.0s | 37.6s |
| 6 | 2025å¹´ä¸Šæµ·åˆ†éƒ¨åˆ©æ¶¦è¡¨ | 39.6s | 0.06s* | 0ms* | 0ms* | 37.2s |
| 7 | 2025å¹´èµ£çš–åŒºåŸŸåˆ©æ¶¦è¡¨ | 46.7s | 0.06s* | 6.7s | 0ms* | 37.5s |
| 8 | 2025å¹´å®‰å¾½çœåŒºåˆ©æ¶¦è¡¨ | 49.6s | 9.9s | 0ms* | 0ms* | 37.4s |
| 9 | 2025å¹´æ±Ÿè¥¿çœåŒºåˆ©æ¶¦è¡¨ | 38.9s | 0.06s* | 0ms* | 0ms* | 36.5s |
| 10 | 24å¹´è¿”åˆ©æ˜ç»† | 71.3s | 10.2s | 7.7s | 17.0s | 33.8s |

*æ³¨: 0ms æˆ–æçŸ­æ—¶é—´è¡¨ç¤ºç¼“å­˜å‘½ä¸­*

**å…³é”®å‘ç°**:
1. **ç¼“å­˜ç”Ÿæ•ˆ**: Sheet 5-9 ç»“æ„ç›¸ä¼¼ï¼Œfield/scenario/chart æœ‰ç¼“å­˜å‘½ä¸­
2. **insight æ— ç¼“å­˜**: insight_generation æ¯æ¬¡éƒ½éœ€è¦ 33-38ç§’
3. **æœ€æ…¢ sheet**: Sheet 4 (75.9s) - å¤§è¡¨ + æ— ç¼“å­˜
4. **æœ€å¿« sheet**: Sheet 9 (38.9s) - å®Œå…¨å‘½ä¸­ç¼“å­˜

---

### 2026-01-27 æµ‹è¯• #1: åˆå§‹ 3 sheets æµ‹è¯•

**é…ç½®**: 3 sheets, depth=standard

| Sheet | æ€»æ—¶é—´ | field | scenario | chart | insight |
|-------|--------|-------|----------|-------|---------|
| ç´¢å¼• | 68.8s | 7.1s | 6.9s | 14.9s | 37.5s |
| æ”¶å…¥åŠå‡€åˆ©ç®€è¡¨ | 69.8s | 6.8s | 8.0s | 18.0s | 34.7s |
| 2025å¹´é”€å”®1ä¸­å¿ƒåˆ©æ¶¦è¡¨ | 69.2s | 9.5s | 7.4s | 17.7s | 32.2s |

**ç»“è®º**: insight_generation æ˜¯æœ€å¤§ç“¶é¢ˆ

---

### 2026-01-27 æµ‹è¯• #3: å¤æ‚åœºæ™¯æµ‹è¯•

**é…ç½®**: test_complex_scenarios.xlsx, 10 sheets, depth=standard

**æ€»ä½“ç»Ÿè®¡**:
- **æ€»æ—¶é—´**: 801.5ç§’ (13.4åˆ†é’Ÿ)
- **æˆåŠŸç‡**: 10/10 (100%)
- **å¹³å‡æ¯ sheet**: 80.1ç§’

**é˜¶æ®µæ€§èƒ½æ±‡æ€»**:

| é˜¶æ®µ | å¹³å‡è€—æ—¶ | æœ€å° | æœ€å¤§ | æ€»è®¡ |
|------|---------|------|------|------|
| insight_generation | 36.2s | 30.7s | 37.7s | 361.5s |
| chart_recommendation | 16.2s | 14.2s | 21.0s | 162.2s |
| field_detection | 13.2s | 6.0s | 37.6s | 132.3s |
| metric_calculation | 7.8s | 0.003s | 36.3s | 77.7s |
| scenario_detection | 6.5s | 5.2s | 10.4s | 64.6s |
| raw_export | 0.29s | 0.24s | 0.33s | 2.9s |

**å„åœºæ™¯è¯¦æƒ…**:

| Sheet | åç§° | æ€»æ—¶é—´ | field | scenario | metric | chart | insight | ç‰¹ç‚¹ |
|-------|------|--------|-------|----------|--------|-------|---------|------|
| 0 | åˆ©æ¶¦è¡¨_åˆå¹¶è¡¨å¤´ | 67.8s | 6.7s | 6.3s | 0.03s | 17.1s | 37.4s | åˆå¹¶å•å…ƒæ ¼ |
| 1 | é”€å”®æ˜ç»†_500è¡Œ | 71.9s | 11.9s | 6.0s | 0.01s | 16.1s | 37.5s | å¤§æ•°æ®é‡ |
| 2 | é¢„ç®—å¯¹æ¯”_å¤šå±‚è¡¨å¤´ | 64.9s | 6.0s | 5.7s | 0.03s | 15.6s | 37.3s | å¤šå±‚è¡¨å¤´ |
| 3 | æ—¶é—´åºåˆ—_æ—¥æ•°æ® | **98.5s** | 9.3s | 5.5s | **30.9s** | 14.8s | 37.7s | 365å¤©æ•°æ® |
| 4 | æ··åˆç±»å‹_å¤æ‚ | 64.6s | 7.9s | 6.1s | 0.01s | 15.1s | 35.2s | ç±»å‹æ··åˆ |
| 5 | ç¨€ç–æ•°æ®_70%ç©º | **127.5s** | **27.7s** | 7.8s | **36.3s** | 17.5s | 37.7s | ğŸ”´ æœ€æ…¢ |
| 6 | è¶…å®½è¡¨_120åˆ— | **110.5s** | **37.6s** | 10.4s | 10.4s | 21.0s | 30.7s | 120åˆ— |
| 7 | åµŒå¥—åˆ†ç»„_3çº§ | 68.6s | 9.0s | 6.4s | 0.003s | 15.5s | 37.4s | å¤šçº§åˆ†ç±» |
| 8 | ä¸­è‹±æ–‡_Bilingual | **60.2s** | 7.3s | 5.2s | 0.004s | 14.2s | 33.2s | âœ… æœ€å¿« |
| 9 | ç‰¹æ®Šå­—ç¬¦_Formula | 67.2s | 8.8s | 5.4s | 0.003s | 15.4s | 37.3s | ç‰¹æ®Šå­—ç¬¦ |

**å…³é”®å‘ç°**:

1. **ç¨€ç–æ•°æ®æœ€æ…¢** (127.5s)
   - field_detection: 27.7s (æ£€æµ‹20åˆ—ç©ºå€¼)
   - metric_calculation: 36.3s (å¤„ç†å¤§é‡ç©ºå€¼)

2. **è¶…å®½è¡¨æ¬¡æ…¢** (110.5s)
   - field_detection: 37.6s (æ£€æµ‹120åˆ—)

3. **æ—¶é—´åºåˆ—æ•°æ®** (98.5s)
   - metric_calculation: 30.9s (è®¡ç®—365å¤©ç»Ÿè®¡)

4. **insight_generation æ’å®šç“¶é¢ˆ** (30-38s)
   - ä¸æ•°æ®å¤æ‚åº¦æ— å…³ï¼Œå§‹ç»ˆæ˜¯æœ€å¤§ç“¶é¢ˆ

5. **å‘ç°çš„ Bug**:
   - `'FieldInfo' object is not callable` - metric_calculator groupby é”™è¯¯
   - `Column * not found` - COUNT(*) å…¬å¼ä¸æ”¯æŒ
   - `JSON decode error` - LLM è¿”å›æ ¼å¼ä¸ç¨³å®š

---

## 5. é™„å½•

### A. æµ‹è¯•å‘½ä»¤

```bash
# è¿è¡Œæ€§èƒ½æµ‹è¯•
cd smartbi
python tests/test_e2e_performance_monitor.py --sheets 5 --depth standard

# æ¸…é™¤ç¼“å­˜åæµ‹è¯•
python tests/test_e2e_performance_monitor.py --sheets 3 --depth standard
```

### B. æ€§èƒ½æŠ¥å‘Šä½ç½®

```
smartbi/tests/perf_report_YYYYMMDD_HHMMSS.json
```

### C. ç›¸å…³æ–‡ä»¶

- `tests/test_e2e_performance_monitor.py` - æ€§èƒ½æµ‹è¯•è„šæœ¬
- `services/unified_analyzer.py` - ä¸»åˆ†æå…¥å£
- `services/insight_generator.py` - æ´å¯Ÿç”Ÿæˆ (P0)
- `services/chart_recommender.py` - å›¾è¡¨æ¨è (P0)
- `services/field_detector_llm.py` - å­—æ®µæ£€æµ‹ (P1)
- `services/scenario_detector.py` - åœºæ™¯æ£€æµ‹ (P1)
