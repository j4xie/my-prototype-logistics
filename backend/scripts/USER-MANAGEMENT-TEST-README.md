# 白垩纪食品溯源系统 - 用户管理和白名单系统完整测试

## 测试概述

本测试脚本 `user-management-comprehensive-test.js` 专门用于测试白垩纪食品溯源系统的用户管理功能和白名单系统，涵盖8个用户角色的权限管理、注册流程、登录验证、设备绑定等核心功能。

## 测试范围

### 核心功能测试

1. **registerPhaseOne (手机号验证)**
   - 白名单手机号验证
   - 不在白名单的手机号处理
   - 工厂存在性验证
   - 已注册手机号处理
   - 过期白名单处理

2. **registerPhaseTwo (完成注册)**
   - 成功完成注册流程
   - 临时令牌验证
   - 重复用户名/邮箱检查
   - 手机号与令牌匹配验证
   - 数据完整性检查

3. **unifiedLogin (统一登录)**
   - 平台管理员登录
   - 8个工厂用户角色登录测试
   - 权限系统验证
   - 未激活用户阻止
   - 错误密码处理

4. **getUserProfile (获取用户资料)**
   - 当前用户信息获取
   - 工厂信息包含性检查
   - 数据格式验证

5. **updateUserProfile (更新用户资料)**
   - 密码修改功能
   - 旧密码验证
   - 错误处理测试

6. **whitelistManagement (白名单管理)**
   - 白名单状态检查
   - 不在白名单的处理
   - 状态变更测试
   - 过期处理机制

7. **rolePermissions (角色权限)**
   - 8角色权限继承验证
   - 部门权限访问控制
   - 功能权限验证

8. **deviceBinding (设备绑定)**
   - 设备绑定流程
   - 设备登录验证
   - 无效令牌处理
   - 设备ID匹配验证

### 8角色权限系统测试

系统支持以下8个用户角色，每个角色都有详细的权限测试：

#### 平台级角色
- **system_developer**: 系统开发者，拥有所有权限
- **platform_super_admin**: 平台超级管理员，平台管理权限
- **platform_operator**: 平台操作员，有限平台权限

#### 工厂级角色
- **factory_super_admin**: 工厂超级管理员，工厂内最高权限
- **permission_admin**: 权限管理员，用户和权限管理
- **department_admin**: 部门管理员，部门范围管理权限
- **operator**: 普通操作员，基础操作权限
- **viewer**: 查看者，只读权限
- **unactivated**: 待激活用户，无权限

## 运行方式

### 基础环境测试
```bash
# 首先运行基础测试确保环境正常
node scripts/test-user-management-basic.js
```

### 完整测试
```bash
# 运行完整用户管理测试
node scripts/user-management-comprehensive-test.js
```

### 期望输出示例
```
🔍 白垩纪食品溯源系统 - 用户管理和白名单系统完整测试
📊 测试范围: authController.js 用户管理功能和白名单系统
🕒 测试开始时间: 2024-01-08 15:30:00

🏭 设置用户管理测试数据
[15:30:01] 🔍 用户管理测试: 创建测试工厂
[15:30:02] ✅ 通过: 创建测试工厂 (1250ms)
...

📈 总体统计:
   总计测试: 45
   通过: 43
   失败: 2
   成功率: 95.6%
   总耗时: 120.5秒
```

## 测试数据管理

### 自动创建的测试数据
- 测试工厂 (主工厂 + 副工厂)
- 平台管理员账户
- 8角色的测试用户
- 白名单记录
- 设备绑定记录

### 数据清理
测试脚本会自动清理所有创建的测试数据，包括：
- 用户会话记录
- 测试用户账户
- 白名单记录
- 平台管理员账户
- 测试工厂
- 临时令牌

## 成功标准

### 测试通过条件
- 总成功率 ≥ 85%
- 功能覆盖度 ≥ 6/8 个核心功能
- 所有8个角色权限验证通过
- 跨工厂访问控制正常

### 关键验证点
1. **权限隔离**: 不同角色只能访问其权限范围内的功能
2. **工厂隔离**: 用户只能访问自己工厂的数据
3. **白名单机制**: 只有白名单内的手机号可以注册
4. **设备安全**: 设备绑定和登录机制正常
5. **数据完整性**: 用户注册和登录过程中数据正确存储

## 故障排查

### 常见错误及解决方案

1. **数据库连接失败**
   ```bash
   # 检查数据库服务状态
   npm run check
   ```

2. **Prisma相关错误**
   ```bash
   # 重新生成客户端
   npx prisma generate
   ```

3. **工厂ID生成器错误**
   - 确保 `src/utils/factory-id-generator.js` 存在
   - 检查相关依赖是否正确安装

4. **权限测试失败**
   - 检查 `src/config/permissions.js` 配置
   - 验证角色枚举是否与数据库一致

### 环境要求
- Node.js >= 16.x
- MySQL/PostgreSQL 数据库
- Prisma 客户端已生成
- 所有依赖包已安装

## 测试结果解读

### 成功率等级
- **90%+**: 优秀 - 用户管理系统功能完整
- **80-89%**: 良好 - 基本功能正常，需要小幅改进
- **70-79%**: 一般 - 存在问题，需要修复
- **<70%**: 需要重点检查和修复

### 功能模块评估
每个功能模块都有独立的成功率统计：
- registerPhaseOne: 手机号验证流程
- registerPhaseTwo: 用户注册完成
- unifiedLogin: 统一登录系统
- getUserProfile: 用户资料获取
- updateUserProfile: 用户资料更新
- whitelistManagement: 白名单管理
- rolePermissions: 角色权限系统
- deviceBinding: 设备绑定功能

## 集成测试建议

建议在以下场景运行此测试：
1. 新功能开发完成后
2. 权限系统修改后
3. 数据库架构变更后
4. 部署前的回归测试
5. 定期的系统健康检查

## 扩展和定制

测试脚本采用模块化设计，可以轻松扩展：
- 添加新的角色测试
- 扩展权限验证逻辑
- 增加性能测试指标
- 集成安全测试用例