package com.cretas.aims.rules.intent;

import com.cretas.aims.dto.intent.IntentValidationFact;
import com.cretas.aims.dto.intent.ValidationResult;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.util.List;

global ValidationResult validationResult;

/**
 * 意图级规则 - 业务时间段、操作频率、权限验证
 *
 * 应用场景：
 * - 在 IntentExecutorServiceImpl.validateWithDrools() 中调用
 * - 在 Handler.handle() 执行之前进行拦截
 *
 * @author Cretas Team
 * @version 1.0.0
 * @since 2026-01-06
 */

// ==================== 规则1: 业务时间段限制 ====================

rule "禁止非工作时间修改生产数据"
    salience 100  // 高优先级，优先检查
    when
        $fact: IntentValidationFact(
            intentCategory == "DATA_OPERATION" ||
            intentCategory == "PRODUCTION" ||
            intentCategory == "QUALITY",
            operation == "UPDATE" || operation == "DELETE",
            currentTime: timestamp
        )
        eval(isNonWorkingHour(currentTime))
    then
        validationResult.addViolation(
            "非工作时间限制",
            "非工作时间(8:00-20:00)禁止修改生产相关数据",
            "HIGH"
        );
        validationResult.addRecommendation("建议在工作时间(8:00-20:00)操作");
        validationResult.addRecommendation("紧急情况请联系值班经理审批");
        validationResult.setValid(false);
end

// ==================== 规则2: 操作频率限制 ====================

rule "同一用户5分钟内最多修改3次"
    salience 90
    when
        $fact: IntentValidationFact(
            operation == "UPDATE" || operation == "DELETE",
            recentOperationCount > 3
        )
    then
        validationResult.addViolation(
            "操作频率超限",
            "您在5分钟内已执行" + $fact.getRecentOperationCount() + "次修改操作，超过限制(3次)",
            "MEDIUM"
        );
        validationResult.addRecommendation("请稍后再试，或联系管理员提升操作限额");
        validationResult.setValid(false);
end

// ==================== 规则3: 跨工厂操作权限 ====================

rule "跨工厂数据操作需要super_admin"
    salience 85
    when
        $fact: IntentValidationFact(
            targetFactoryId != null,
            targetFactoryId != currentFactoryId,
            userRole != "super_admin"
        )
    then
        validationResult.addViolation(
            "权限不足",
            "跨工厂数据操作需要super_admin权限，当前角色: " + $fact.getUserRole(),
            "HIGH"
        );
        validationResult.addRecommendation("请联系平台管理员获取权限");
        validationResult.setValid(false);
end

// ==================== 规则4: 敏感操作二次确认 ====================

rule "删除操作必须显式确认"
    salience 80
    when
        $fact: IntentValidationFact(
            operation == "DELETE",
            forceExecute == false
        )
    then
        validationResult.addViolation(
            "需要二次确认",
            "删除操作需要显式确认，请设置 forceExecute=true",
            "MEDIUM"
        );
        validationResult.addRecommendation("确认后请在请求中添加 forceExecute: true");
        validationResult.setValid(false);
end

// ==================== 规则5: 批量操作数量限制 ====================

rule "单次批量操作不超过100条"
    salience 75
    when
        $fact: IntentValidationFact(
            operation == "BATCH_UPDATE" || operation == "BATCH_DELETE",
            batchSize > 100
        )
    then
        validationResult.addViolation(
            "批量操作超限",
            "单次批量操作不能超过100条记录，当前: " + $fact.getBatchSize() + "条",
            "MEDIUM"
        );
        validationResult.addRecommendation("请分批处理，或联系管理员");
        validationResult.setValid(false);
end

// ==================== 规则6: 允许查询操作（无限制） ====================

rule "允许查询操作"
    salience 50
    when
        $fact: IntentValidationFact(
            operation == "QUERY" || operation == "VIEW"
        )
    then
        // 查询操作默认允许，无需校验
        validationResult.setValid(true);
end

// ==================== 规则7: 表单助手操作（低敏感度） ====================

rule "允许表单助手操作"
    salience 50
    when
        $fact: IntentValidationFact(
            intentCategory == "FORM_ASSISTANT"
        )
    then
        // 表单助手操作仅修改模板，不直接改数据，低风险
        validationResult.setValid(true);
end

// ==================== 辅助函数 ====================

function boolean isNonWorkingHour(LocalDateTime time) {
    LocalTime localTime = time.toLocalTime();
    int hour = localTime.getHour();
    return hour < 8 || hour > 20;
}
