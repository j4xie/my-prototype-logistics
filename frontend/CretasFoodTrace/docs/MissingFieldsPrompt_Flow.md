# MissingFieldsPrompt 交互流程图

## 完整流程

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户操作                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. 用户在表单中点击 AI 助手按钮                                   │
│     - 文本输入: "帮我创建一个带鱼批次，温度零下20度"                 │
│     - 或语音输入                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. AIAssistantButton 调用 parseWithAI(userInput)                │
│     → formAssistantApiClient.parseFormInput()                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. 后端 AI 服务处理                                               │
│     ✓ 解析字段: { materialType: "带鱼", temperature: -20 }       │
│     ✓ 检测缺失必填字段: ["quantity", "supplierId"]               │
│     ✓ 生成追问: ["请问数量是多少？", "请选择供应商"]               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. 前端接收响应 FormParseResponse                                │
│     {                                                            │
│       success: true,                                             │
│       fieldValues: { materialType: "带鱼", temperature: -20 },  │
│       confidence: 0.95,                                          │
│       missingRequiredFields: ["quantity", "supplierId"],        │
│       suggestedQuestions: [                                      │
│         "请问数量是多少？",                                        │
│         "请选择供应商"                                            │
│       ],                                                         │
│       followUpQuestion: "还需要补充数量和供应商信息"              │
│     }                                                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. useFormAIAssistant Hook 处理                                  │
│     ✓ 填充已解析字段到表单                                         │
│     ✓ 检测到 needsFollowUp = true                                │
│     ✓ 触发 onMissingFields 回调                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. AIAssistantButton 接收回调                                    │
│     setCurrentMissingFields(["quantity", "supplierId"])         │
│     setCurrentSuggestedQuestions([...])                         │
│     setIsMissingFieldsPromptVisible(true)                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  7. 显示 MissingFieldsPrompt 弹窗                                 │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ [Robot Icon] 还需要补充数量和供应商信息          [X 关闭]   │ │
│  ├────────────────────────────────────────────────────────────┤ │
│  │  请补充以下 2 个必填字段                                    │ │
│  │                                                              │ │
│  │  ┌──────────────────────────────────────────────────────┐  │ │
│  │  │ quantity (必填)                                       │  │ │
│  │  │ 请问数量是多少？                                      │  │ │
│  │  │ [          输入框          ] [麦克风图标]             │  │ │
│  │  └──────────────────────────────────────────────────────┘  │ │
│  │                                                              │ │
│  │  ┌──────────────────────────────────────────────────────┐  │ │
│  │  │ supplierId (必填)                                     │  │ │
│  │  │ 请选择供应商                                          │  │ │
│  │  │ [          输入框          ] [麦克风图标]             │  │ │
│  │  └──────────────────────────────────────────────────────┘  │ │
│  │                                                              │ │
│  │  [i] 您可以直接输入，或点击麦克风图标使用语音               │ │
│  │                                                              │ │
│  │                                    [跳过]  [继续]           │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  8. 用户补充信息                                                   │
│     选项A: 文本输入 "500公斤，张三水产"                            │
│     选项B: 语音输入（每个字段独立录音）                            │
│     选项C: 点击"跳过"（手动填写）                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  9. 用户点击"继续"                                                 │
│     onSubmit({ quantity: "500公斤", supplierId: "张三水产" })    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  10. AIAssistantButton.handleMissingFieldsSubmit()               │
│      ✓ 将答案转为自然语言: "quantity: 500公斤，supplierId: 张三水产" │
│      ✓ 再次调用 parseWithAI(answerText)                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  11. AI 二次解析补充信息                                           │
│      { quantity: 500, supplierId: "supplier_123" }              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  12. 填充到表单 + 关闭弹窗                                         │
│      ✓ formRef.current.setValues({ ...currentValues, ...new }) │
│      ✓ setIsMissingFieldsPromptVisible(false)                  │
│      ✓ showSnackbar("补充信息已成功填充", "success")             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  13. 表单完整填充完毕                                              │
│      {                                                           │
│        materialType: "带鱼",                                     │
│        temperature: -20,                                         │
│        quantity: 500,                                            │
│        supplierId: "supplier_123"                               │
│      }                                                           │
│      用户可点击"提交"                                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 组件交互关系

```
┌──────────────────────────────────────────────────────────────────┐
│                        DynamicForm                                │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                  FormProvider (Formily)                     │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │  │
│  │  │ TextInput    │  │ NumberInput  │  │ SelectInput  │     │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘     │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │               AIAssistantButton (FAB)                       │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                 │  │
│  │  │  文本输入 │  │  语音输入 │  │ OCR 扫描 │                 │  │
│  │  └──────────┘  └──────────┘  └──────────┘                 │  │
│  │                                                              │  │
│  │  Uses: useFormAIAssistant Hook                              │  │
│  │  ┌────────────────────────────────────────────────────────┐ │  │
│  │  │ ✓ parseWithAI()                                         │ │  │
│  │  │ ✓ parseWithOCR()                                        │ │  │
│  │  │ ✓ onMissingFields callback                              │ │  │
│  │  └────────────────────────────────────────────────────────┘ │  │
│  └────────────────────────────────────────────────────────────┘  │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │             MissingFieldsPrompt Modal                       │  │
│  │  ┌──────────────────────────────────────────────────────┐  │  │
│  │  │ Field 1: [Text Input] [Mic]                          │  │  │
│  │  │ Field 2: [Text Input] [Mic]                          │  │  │
│  │  │ ...                                                   │  │  │
│  │  │                            [跳过] [继续]              │  │  │
│  │  └──────────────────────────────────────────────────────┘  │  │
│  └────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────┘
```

---

## 状态管理

### AIAssistantButton 状态

```typescript
// 追问弹窗状态
const [isMissingFieldsPromptVisible, setIsMissingFieldsPromptVisible] = useState(false);
const [currentMissingFields, setCurrentMissingFields] = useState<string[]>([]);
const [currentSuggestedQuestions, setCurrentSuggestedQuestions] = useState<string[]>([]);
const [currentFollowUpQuestion, setCurrentFollowUpQuestion] = useState<string | undefined>();
const [isProcessingFollowUp, setIsProcessingFollowUp] = useState(false);
```

### MissingFieldsPrompt 内部状态

```typescript
// 用户输入的答案
const [answers, setAnswers] = useState<Record<string, string>>({});

// 语音输入状态
const [recordingFieldIndex, setRecordingFieldIndex] = useState<number | null>(null);
const [isRecording, setIsRecording] = useState(false);
```

---

## API 数据流

### 请求: parseFormInput

```json
{
  "userInput": "帮我创建一个带鱼批次，温度零下20度",
  "entityType": "MATERIAL_BATCH",
  "formFields": [
    { "name": "materialType", "title": "物料类型", "type": "string", "required": true },
    { "name": "quantity", "title": "数量", "type": "number", "required": true },
    { "name": "temperature", "title": "温度", "type": "number", "required": false },
    { "name": "supplierId", "title": "供应商", "type": "string", "required": true }
  ]
}
```

### 响应: FormParseResponse (缺失字段)

```json
{
  "success": true,
  "fieldValues": {
    "materialType": "带鱼",
    "temperature": -20
  },
  "confidence": 0.95,
  "message": "部分字段已识别，需要补充必填信息",
  "missingRequiredFields": ["quantity", "supplierId"],
  "suggestedQuestions": [
    "请问这批带鱼的数量是多少？",
    "请选择供应商"
  ],
  "followUpQuestion": "还需要补充数量和供应商信息"
}
```

### 二次请求: parseFormInput (补充信息)

```json
{
  "userInput": "quantity: 500公斤，supplierId: 张三水产",
  "entityType": "MATERIAL_BATCH",
  "formFields": [...],
  "context": {
    "currentValues": {
      "materialType": "带鱼",
      "temperature": -20
    }
  }
}
```

### 二次响应: FormParseResponse (完整)

```json
{
  "success": true,
  "fieldValues": {
    "quantity": 500,
    "supplierId": "supplier_123"
  },
  "confidence": 0.92,
  "message": "所有必填字段已识别",
  "missingRequiredFields": []
}
```

---

## 错误处理

### 语音识别失败

```
用户点击麦克风 → 录音失败
↓
显示 Snackbar: "录音启动失败，请检查权限"
↓
用户可选择：
  1. 重新录音
  2. 使用文本输入
  3. 跳过字段
```

### AI 解析失败

```
用户提交补充信息 → AI 无法解析
↓
保持弹窗打开 + 显示错误提示
↓
用户可选择：
  1. 重新输入（更清晰的描述）
  2. 跳过（手动填写）
```

### 网络错误

```
API 请求失败 (网络问题)
↓
关闭弹窗 + 显示 Snackbar: "AI 服务暂时不可用"
↓
用户回到表单手动填写
```

---

## 性能优化

1. **防抖**: 用户输入时避免频繁调用 AI
2. **缓存**: 记录已识别字段，避免重复解析
3. **懒加载**: 语音服务按需初始化
4. **取消请求**: 用户关闭弹窗时取消未完成的 AI 请求

---

**说明**: 此流程图展示了从用户输入到最终表单填充的完整交互过程，包含所有分支情况和错误处理逻辑。
