# Android APK 构建问题说明

## 当前状态

✅ **已完成**：
- Java 17 已安装并配置
- Android SDK 已配置
- Gradle 构建环境已就绪
- 项目依赖已安装

❌ **遇到问题**：
- `expo-barcode-scanner` 模块编译失败
- 错误原因：Kotlin 编译错误，缺少接口定义

## 问题分析

`expo-barcode-scanner@13.0.1` 模块在编译时出现大量 Kotlin 错误：
- Unresolved reference 'barcodescanner'
- Unresolved reference 'BarCodeScannerSettings'
- Unresolved reference 'BarCodeScannerResult'
- 等等...

这可能是由于：
1. Expo SDK 53 与 expo-barcode-scanner 13.0.1 版本不兼容
2. 代码生成步骤缺失
3. 依赖版本冲突

## 解决方案

### 方案1：更新依赖（推荐）

```bash
cd frontend/CretasFoodTrace
npm update expo-barcode-scanner
# 或
npm install expo-barcode-scanner@latest
```

### 方案2：如果项目未使用，暂时移除

检查项目代码中是否使用了 barcode-scanner：
```bash
grep -r "expo-barcode-scanner" src/
```

如果没有使用，可以：
```bash
npm uninstall expo-barcode-scanner
```

然后重新构建。

### 方案3：使用 EAS 云端构建（最简单）

云端构建环境可能已经解决了这些依赖问题：
```bash
npm install -g eas-cli
eas login
eas build:configure
eas build --platform android --profile preview
```

### 方案4：修复代码生成

可能需要运行代码生成：
```bash
cd frontend/CretasFoodTrace
npx expo prebuild --clean --platform android
```

**注意**：需要先停止 Gradle 守护进程：
```bash
cd android
.\gradlew.bat --stop
cd ..
```

## 下一步操作建议

1. **快速方案**：使用 EAS 云端构建（方案3）
2. **长期方案**：更新或移除 expo-barcode-scanner（方案1或2）

## 当前构建命令

如果修复了问题，使用以下命令构建：

```bash
cd C:\Users\Steve\my-prototype-logistics\frontend\CretasFoodTrace\android

# 设置环境变量
$env:JAVA_HOME = "C:\Program Files\Java\jdk-17"
$env:Path = "$env:JAVA_HOME\bin;$env:Path"
$env:ANDROID_HOME = "$env:LOCALAPPDATA\Android\Sdk"

# 构建 Debug APK
.\gradlew.bat assembleDebug

# 或构建 Release APK
.\gradlew.bat assembleRelease
```

APK 输出位置：
- Debug: `android/app/build/outputs/apk/debug/app-debug.apk`
- Release: `android/app/build/outputs/apk/release/app-release.apk`


