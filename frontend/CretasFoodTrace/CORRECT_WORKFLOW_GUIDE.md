# 正确的业务流程和操作指南

## ⚠️ 重要说明

本文档修正了之前的理解错误，基于实际的权限配置和业务逻辑，提供正确的操作流程。

---

## 🏭 完整业务流程链条

```
商家订单 → 生产计划 → 原料采购 → 原料入库 → 原料领用 →
加工生产 → 成品入库 → 成品出库 → 配送交付

角色分工:
├─ 管理员: 制定生产计划、监控进度
├─ 采购部: 采购原料（目前系统未实现）
├─ 仓库部: 原料入库/出库、成品入库/出库（需要新增角色）
├─ 加工部操作员: 执行加工、记录数据 ⭐
├─ 质检部: 质量检验
└─ 物流部: 配送发货
```

---

## 👥 角色和权限说明

### 1️⃣ 工厂超级管理员（factory_super_admin）

**用户名**: `super_admin` | **密码**: `123456`

**权限范围**: 工厂全部功能

**核心职责**:
- ✅ 制定生产计划
- ✅ 配置基础数据（原料类型、产品类型、转换率、商家）
- ✅ 用户管理和权限分配
- ✅ 监控生产进度和数据分析
- ✅ 系统配置和维护

---

### 2️⃣ 部门管理员（department_admin）

**用户名**: `dept_admin` | **密码**: `123456`

**权限范围**: 本部门数据和人员

**核心职责**:
- ✅ 制定本部门生产计划
- ✅ 管理本部门操作员
- ✅ 审核本部门加工批次
- ✅ 查看本部门数据报表

---

### 3️⃣ 加工部操作员（operator）⭐ 重点角色

**用户名**: `operator1` / `operator2` | **密码**: `123456`

**权限范围**:
- ✅ `processing_batch_create` - 创建加工批次
- ✅ `processing_batch_view_own` - 查看自己的批次
- ✅ `quality_inspection_submit` - 提交质检记录
- ✅ `work_record_submit` - 提交工作记录
- ✅ `view_department_data` - 查看部门数据
- ❌ **没有原料入库权限**

**核心职责**:
- ✅ 执行加工任务
- ✅ 记录加工数据（实际用料、实际产量）
- ✅ 提交质检记录
- ✅ 查看自己的工作记录
- ❌ **不负责原料入库/出库**

---

### 4️⃣ 仓库管理员（warehouse_admin）⚠️ 需要新增

**状态**: 当前系统未实现，建议增加

**建议权限**:
- 原料入库/出库
- 成品入库/出库
- 库存盘点
- 库存查询

**核心职责**:
- 原料验收入库
- 原料领用出库（配发给加工部）
- 成品验收入库
- 成品出库发货

---

## 📋 正确的业务场景和操作流程

### 场景A: 管理员制定生产计划

**角色**: factory_super_admin / department_admin
**目标**: 根据商家订单制定生产计划

#### 完整操作步骤

```
背景:
海鲜批发商A下单要500kg鲈鱼片

第1步: 登录系统
账号: super_admin
密码: 123456

第2步: 进入生产计划管理
导航: 底部Tab → "管理" → "生产计划管理"

第3步: 创建新生产计划
点击右下角 "+" 按钮

┌─────────────────────────────────┐
│ 新建生产计划                     │
├─────────────────────────────────┤
│ 产品类型 *                      │
│ ┌─────────────────────────────┐ │
│ │ 选择产品类型 ▼              │ │ ← 选择"鲈鱼片"
│ └─────────────────────────────┘ │
│                                 │
│ 商家 *                          │
│ ┌─────────────────────────────┐ │
│ │ 选择商家 ▼                  │ │ ← 选择"海鲜批发商A"
│ └─────────────────────────────┘ │
│                                 │
│ 计划产量 (kg) *                 │
│ ┌─────────────────────────────┐ │
│ │ 500                         │ │ ← 输入计划产量
│ └─────────────────────────────┘ │
│                                 │
│ 💡 预计原料用量                 │
│ ┌─────────────────────────────┐ │
│ │ 鲈鱼: 1000 kg (自动计算)    │ │ ← 系统自动计算
│ └─────────────────────────────┘ │
│                                 │
│ 备注                            │
│ ┌─────────────────────────────┐ │
│ │ 批发商A订单，优先处理        │ │
│ └─────────────────────────────┘ │
│                                 │
│ [取消]  [创建计划]              │
└─────────────────────────────────┘

第4步: 系统自动处理
✅ 生成批次号: #2025001
✅ 计算原料需求: 1000kg鲈鱼（基于50%转换率）
✅ 检查库存: 当前库存1200kg，充足 ✓
✅ 计划状态: 待生产

第5步: 计划下发
- 计划自动分配给加工部
- 操作员可以在系统中看到待加工任务
```

#### 🎯 MaterialTypeSelector在这里的使用

**使用场景1: 选择产品类型时**
```
如果"鲈鱼片"不在产品类型列表中:

1. 点击"产品类型"选择器
2. 滚动到底部
3. 点击 "➕ 找不到？点击添加新产品类型"
4. 填写:
   - 产品名称: 鲈鱼片
   - 分类: 鱼类加工品
   - 产品代码: YP001
5. 保存 → 自动选中
```

**使用场景2: 配置转换率时**
```
如果需要配置新的原料-产品转换率:

导航: 设置 → 转换率管理 → 新增

┌─────────────────────────────┐
│ 原料类型: 鲈鱼 ▼            │ ← MaterialTypeSelector
│ 产品类型: 鲈鱼片 ▼          │
│ 转换率: 50 %                │
│ 损耗率: 5 %                 │
│ [保存]                      │
└─────────────────────────────┘

如果"鲈鱼"不在列表 → 快速添加
```

---

### 场景B: 操作员执行加工任务 ⭐ 核心流程

**角色**: operator1 (加工部操作员)
**目标**: 执行加工批次，记录实际数据

#### 完整操作步骤

```
背景:
早上8:00，操作员上班，查看今日生产任务

第1步: 登录系统
账号: operator1
密码: 123456

第2步: 查看生产计划
导航: 底部Tab → "加工" → "生产计划"

看到待加工计划:
┌─────────────────────────────┐
│ 📋 今日生产任务              │
├─────────────────────────────┤
│ 批次 #2025001               │
│ 产品: 鲈鱼片                │
│ 计划产量: 500 kg            │
│ 预计原料: 1000 kg 鲈鱼      │
│ 状态: 待生产 🟡             │
│                             │
│ [开始加工]                  │
└─────────────────────────────┘

第3步: 开始加工
点击"开始加工" → 系统自动:
- 记录开始时间: 08:00
- 状态变更: 生产中 🟢

第4步: 执行实际加工（线下操作）
- 从仓库领取原料
- 进行切割、分拣、包装
- 记录实际用料和产量

第5步: 填写加工记录
加工完成后（例如12:00），填写实际数据:

┌─────────────────────────────────┐
│ 加工批次 #2025001               │
├─────────────────────────────────┤
│ 产品类型: 鲈鱼片 (已设定)       │
│ 计划产量: 500 kg                │
│                                 │
│ ━━━ 实际使用原料 ━━━            │
│                                 │
│ 原料1:                          │
│ ┌─────────────────────────────┐ │
│ │ 选择原料类型 ▼              │ │ ← 🎯 MaterialTypeSelector
│ └─────────────────────────────┘ │
│ 用量: [____] kg                 │
│                                 │
│ [+ 添加更多原料]                │
│                                 │
│ ━━━ 实际产量 ━━━                │
│ 实际产量: [____] kg             │
│                                 │
│ ━━━ 质检结果 ━━━                │
│ 质量等级: [合格 ▼]              │
│                                 │
│ 加工时长: 4小时 (自动计算)       │
│                                 │
│ 备注:                           │
│ ┌─────────────────────────────┐ │
│ │ 原料新鲜，成品质量好         │ │
│ └─────────────────────────────┘ │
│                                 │
│ [取消]  [提交记录]              │
└─────────────────────────────────┘

第6步: 🎯 使用 MaterialTypeSelector 的关键时刻

情况A: 选择标准原料
┌─────────────────────────────┐
│ 选择原料类型         [取消] │
├─────────────────────────────┤
│ 🔍 搜索原料...              │
├─────────────────────────────┤
│ • 鲈鱼 (淡水鱼)          ✓  │ ← 直接选择
│ • 带鱼 (海水鱼)             │
│ • 黄花鱼 (海水鱼)           │
└─────────────────────────────┘

选择后填写用量: 1050 kg

情况B: 需要更细分的原料类型
┌─────────────────────────────┐
│ 选择原料类型         [取消] │
├─────────────────────────────┤
│ 🔍 搜索: 大鲈鱼             │ ← 搜索后未找到
├─────────────────────────────┤
│ 未找到匹配的原料类型        │
│                             │
│ ↓ 滚动到底部 ↓             │
├─────────────────────────────┤
│ ➕ 找不到？点击添加新原料    │ ← 点击这里
│    类型                     │
└─────────────────────────────┘

展开快捷添加表单:
┌─────────────────────────────┐
│ 添加新原料                  │
├─────────────────────────────┤
│ 原料名称 *                  │
│ ┌─────────────────────────┐ │
│ │ 大鲈鱼                  │ │ ← 输入细分名称
│ └─────────────────────────┘ │
│                             │
│ 分类                        │
│ [鱼类] [虾蟹] [贝类]        │ ← 选择鱼类
│ [头足] [其他]               │
│                             │
│ [取消]  [保存]              │
└─────────────────────────────┘

保存后:
✅ "大鲈鱼"自动被选中
✅ 继续填写用量: 600 kg

可以继续添加第二种原料:
点击 [+ 添加更多原料] → 再选择"小鲈鱼" 450kg

第7步: 填写完整数据示例
实际使用原料:
- 大鲈鱼: 600 kg
- 小鲈鱼: 450 kg
- 合计: 1050 kg

实际产量: 485 kg
质量等级: A级
加工时长: 4小时 (08:00 - 12:00)

第8步: 提交记录
点击"提交记录" → 系统自动:
- ✅ 更新批次状态: 已完成
- ✅ 记录实际数据
- ✅ 计算成本（后续功能）
- ✅ 通知质检部门
- ✅ 通知仓库成品入库

第9步: 完成
可以继续处理下一个批次
```

#### 🎯 MaterialTypeSelector 的核心价值

**在这个场景中的作用**:
1. **标准化记录**: 快速选择常用原料类型
2. **细分类型**: 根据实际情况添加更详细的原料分类
3. **数据准确**: 确保原料记录的规范性和可追溯性
4. **提高效率**: 不需要每次都联系管理员添加新类型

**实际业务例子**:
```
场景: 今天的鲈鱼特别大，想区分记录

传统方式:
❌ 联系管理员
❌ 等待管理员添加"大鲈鱼"类型
❌ 刷新系统
❌ 再继续填写
⏰ 耗时: 10-30分钟

使用MaterialTypeSelector:
✅ 点击添加
✅ 输入"大鲈鱼"
✅ 选择分类
✅ 保存并自动选中
✅ 继续填写
⏰ 耗时: 30秒

效率提升: 20-60倍！
```

---

### 场景C: 查看和监控（管理员）

**角色**: factory_super_admin
**目标**: 监控生产进度和数据分析

```
第1步: 查看生产进度
导航: 管理 → 生产计划管理

看到:
┌─────────────────────────────┐
│ 📊 生产计划总览              │
├─────────────────────────────┤
│ 待生产: 3个                 │
│ 生产中: 2个                 │
│ 已完成: 15个                │
│ 已出货: 12个                │
└─────────────────────────────┘

第2步: 查看详细数据
点击某个批次:

┌─────────────────────────────┐
│ 批次 #2025001 详情          │
├─────────────────────────────┤
│ 产品: 鲈鱼片                │
│ 状态: 已完成 ✅             │
│                             │
│ 计划产量: 500 kg            │
│ 实际产量: 485 kg (-3%)      │
│                             │
│ 计划原料: 1000 kg           │
│ 实际原料: 1050 kg (+5%)     │
│   ├─ 大鲈鱼: 600 kg         │ ← 操作员添加的细分类型
│   └─ 小鲈鱼: 450 kg         │
│                             │
│ 加工时长: 4小时             │
│ 操作员: operator1           │
│ 质量等级: A级               │
│                             │
│ [导出报表] [打印]           │
└─────────────────────────────┘

第3步: 数据分析
导航: 管理 → 数据分析

可以看到:
- 原料使用趋势（大鲈鱼 vs 小鲈鱼）
- 转换率分析
- 成本核算
- 操作员效率统计
```

---

## 📊 MaterialTypeSelector 完整使用场景总结

### ✅ 正确的使用场景

| 场景 | 角色 | 位置 | 目的 |
|------|------|------|------|
| 制定生产计划 | 管理员 | 生产计划创建 | 选择所需原料类型 |
| 配置转换率 | 管理员 | 转换率管理 | 设置原料-产品转换关系 |
| 记录加工数据 | 操作员 | 加工批次录入 | 选择实际使用的原料 ⭐ |
| 库存管理 | 仓库管理员 | 原料入库/出库 | 选择原料进行操作 |
| 数据查询 | 所有角色 | 报表和统计 | 筛选特定原料类型 |

### ❌ 不适用的场景

| 错误场景 | 原因 |
|----------|------|
| ❌ 操作员做"原料入库" | 操作员没有原料入库权限 |
| ❌ 直接创建加工批次时选原料 | 应该在填写实际用料时选择 |
| ❌ 用于采购订单 | 采购是另外的业务流程 |

---

## 🔑 关键理解要点

### 1. 角色职责清晰

```
管理员: 计划和配置
  ↓
操作员: 执行和记录 ⭐
  ↓
仓库: 入库和出库（待实现）
  ↓
质检: 检验和确认
```

### 2. MaterialTypeSelector 的本质

**不是**: 原料入库的工具
**而是**: 原料类型选择和快速扩展的工具

**核心价值**:
- 在任何需要选择原料类型的地方
- 如果类型不够用
- 可以立即扩展
- 不中断当前工作流程

### 3. 数据流转

```
管理员设置基础原料类型（例如：鲈鱼、带鱼）
          ↓
操作员在实际工作中发现需要细分（例如：大鲈鱼、小鲈鱼）
          ↓
使用MaterialTypeSelector快速添加
          ↓
系统自动记录，供后续使用
          ↓
其他操作员也可以使用这些细分类型
```

---

## 🎯 最佳实践建议

### 对管理员

1. **预设常用类型**:
   - 定期检查操作员添加的类型
   - 将常用的细分类型提升为标准类型
   - 统一命名规范

2. **定期审查**:
   - 每周检查新增的原料类型
   - 合并重复或相似的类型
   - 优化分类结构

3. **数据分析**:
   - 分析哪些原料类型使用频率高
   - 调整采购策略
   - 优化库存管理

### 对操作员

1. **先搜索后添加**:
   - 添加新类型前先搜索
   - 避免创建重复类型

2. **规范命名**:
   - 使用清晰、简洁的名称
   - 遵循现有的命名规则
   - 例如: "大鲈鱼" 而不是 "今天的大鲈鱼"

3. **正确分类**:
   - 选择准确的分类
   - 如果不确定，选择"其他"
   - 后续管理员会重新分类

### 对系统设计

1. **权限控制**: 所有角色都可以创建原料类型（降低门槛）
2. **审核机制**: 管理员定期审核和优化（保证质量）
3. **数据追踪**: 记录谁创建了什么类型（可追溯）

---

## 📞 常见问题

### Q1: 操作员可以删除原料类型吗？
**A**: 不可以。只有管理员可以通过后台（Prisma Studio）删除。

### Q2: 为什么操作员可以创建原料类型？
**A**: 因为实际生产中，原料的细分类型是动态的。允许操作员创建可以：
- 提高数据准确性（详细记录）
- 减少等待时间（不需要找管理员）
- 保持工作流程连续性

### Q3: 如果创建了错误的类型怎么办？
**A**:
- 继续完成当前工作
- 下次不要选择那个类型
- 联系管理员删除

### Q4: 仓库管理员角色什么时候能用？
**A**: 目前系统未实现，建议在权限配置中增加 `warehouse_admin` 角色。

---

**文档版本**: v2.0（修正版）
**更新日期**: 2025-10-06
**修正内容**:
- ✅ 更正操作员权限理解
- ✅ 明确各角色职责边界
- ✅ 补充完整业务流程
- ✅ 准确描述 MaterialTypeSelector 使用场景
