# 白垩纪食品溯源系统 (Cretas Food Traceability System)

**项目名称**: 白垩纪食品溯源系统（Cretas）
**文档版本**: v3.0 + 项目整理优化（2025-11-21）
**创建日期**: 2025-10-08
**最后更新**: 2025-11-21（项目文件整理完成）
**项目状态**: Phase 1-2 ✅ | Phase 3 核心完成 ✅ | Phase 4 优化中 🔨
**总体完成度**: 82-85%

## 🎯 快速导航

**🚀 新开发者必读** (按顺序)：
1. [QUICK_START.md](./QUICK_START.md) - 5分钟快速开始
2. [PROJECT_STRUCTURE_GUIDE.md](./PROJECT_STRUCTURE_GUIDE.md) - 项目结构完整指南 ⭐ 推荐阅读
3. [CLAUDE.md](./CLAUDE.md) - 开发指南和代码规范

**📚 查找文档**：
- 📖 [ROOT_CLEANUP_SUMMARY.md](./ROOT_CLEANUP_SUMMARY.md) - 根目录整理说明
- 📖 [backend-java/BACKEND_CLEANUP_SUMMARY.md](./backend-java/BACKEND_CLEANUP_SUMMARY.md) - 后端整理说明
- 📖 [功能与文件映射 v3.0](./docs/prd/PRD-功能与文件映射-v3.0.md) - API端点映射
- 📖 [业务流程与界面设计 v5.0](./docs/prd/PRD-完整业务流程与界面设计-v5.0.md) - 完整业务流程
- 📖 [权限速查表](./docs/prd/角色权限和页面访问速查表.md) - 快速查权限

---

## 📊 项目概览

### 核心信息

| 项目 | 白垩纪食品溯源系统 (Cretas) |
|------|---------------------------|
| **类型** | 食品加工行业生产管理与成本优化平台 |
| **技术栈** | React Native + Spring Boot + MySQL + Python AI |
| **平台** | iOS 13.0+ / Android 8.0+ |
| **后端** | Spring Boot 2.7.15 + Java 11 |
| **AI** | DeepSeek LLM 成本分析 |
| **部署** | 阿里云 (139.196.165.140:10010) |

### 核心功能

✅ **原材料FIFO管理** - 避免浪费，新鲜/冻货智能区分
✅ **智能生产计划** - 自动预估原料，库存实时检查
✅ **精准成本分析** - 原料+人工+设备+消耗品全链路追踪
✅ **AI优化建议** - DeepSeek智能分析，机器学习效率预测
✅ **员工打卡系统** - GPS+生物识别，工时自动统计
✅ **权限管理** - 8角色体系，RBAC权限控制

### 开发阶段

| 阶段 | 状态 | 说明 |
|------|------|------|
| **Phase 1-2** | ✅ 完成 | 前端75个页面 + 后端核心API |
| **Phase 3** | ✅ 完成 | Spring Boot 397个API端点实现 (99%) |
| **Phase 4** | 🔨 优化中 | 集成测试 + 生产部署 + 性能优化 |
| **Phase 5** | 📅 计划中 | 高级功能 (生物识别、物流追踪等) |

### 项目统计

- 📱 **前端**: 75个页面 (React Native + Expo)
- 🔧 **后端**: 397个API端点 (99%完成)
- 🤖 **AI分析**: DeepSeek成本分析 (95%完成)
- 💾 **数据库**: MySQL + 25个实体类
- 📚 **文档**: 10个核心PRD + 80+个归档文档
- 🚀 **部署**: 服务器运行中 (139.196.165.140:10010)

---

## 🚀 快速开始

### 环境要求

| 组件 | 版本 |
|------|------|
| Node.js | 18.0+ LTS |
| Java | 11+ |
| MySQL | 8.0+ |
| Python | 3.10+ (仅AI) |
| iOS | 13.0+ |
| Android | 8.0+ (API 26+) |

### 启动系统

```bash
# 方式1: 一键启动 (推荐)
bash scripts/start-complete-system.sh

# 方式2: macOS启动
bash scripts/start-system-macos.sh

# 方式3: 手动启动各组件
# Terminal 1: 后端
cd backend-java && ./run-local.sh

# Terminal 2: 前端
cd frontend/CretasFoodTrace && npm start

# Terminal 3: AI服务 (可选)
cd backend-java/backend-ai-chat && python main.py
```

### 默认端口

- **前端**: 3010 (Expo)
- **后端**: 10010 (Spring Boot)
- **MySQL**: 3306
- **AI服务**: 8000 (Python)

### 测试账号

| 字段 | 值 |
|------|-----|
| 用户名 | admin |
| 密码 | Admin@123456 |
| 角色 | platform_admin |

---

## 📚 详细文档

> ⭐ 详细的产品需求、业务流程、API文档等请查看以下文件：

- 📖 **[业务流程 v5.0](./docs/prd/PRD-完整业务流程与界面设计-v5.0.md)** - 完整业务流程 + 界面设计
- 📖 **[功能与文件映射 v3.0](./docs/prd/PRD-功能与文件映射-v3.0.md)** - 功能实现 + API端点映射
- 📖 **[权限速查表](./docs/prd/角色权限和页面访问速查表.md)** - 角色权限对照表
- 📖 **[导航架构](./docs/prd/导航架构实现指南.md)** - 页面导航实现
- 📖 **[AI功能指南](./docs/prd/AI-DETAILED-FUNCTIONALITY-GUIDE.md)** - AI分析深度功能说明

---

## 1. 产品概述

### 1.1 产品定位

白垩纪食品溯源系统是一个面向食品加工行业的**端到端**生产管理与成本控制平台，通过智能化的原材料管理、生产计划执行、实时成本分析和AI优化建议,帮助工厂降低生产成本、提高生产效率。

### 1.2 核心价值主张

```
┌─────────────────────────────────────────────┐
│           核心价值 (4大支柱)                  │
├─────────────────────────────────────────────┤
│                                             │
│  📦 原材料FIFO管理                           │
│  └─ 避免浪费，新鲜/冻货智能区分               │
│                                             │
│  📋 智能生产计划                             │
│  └─ 自动预估原料，库存实时检查                │
│                                             │
│  💰 精准成本分析                             │
│  └─ 原料+人工+设备+消耗品全链路追踪           │
│                                             │
│  🤖 AI优化建议                               │
│  └─ DeepSeek智能分析，机器学习效率预测        │
│                                             │
└─────────────────────────────────────────────┘
```

### 1.3 关键指标 (KPI)

| 指标类型 | 指标名称 | 目标值 | 说明 |
|---------|---------|--------|------|
| **成本控制** | 单位成本降低 | 15-30% | 通过优化人员、设备、消耗品 |
| **效率提升** | 生产效率提升 | 20-40% | 通过员工培训和流程优化 |
| **浪费减少** | 原料浪费率 | <2% | 通过FIFO和到期预警 |
| **转换率提升** | 实际vs预期转换率 | ≥98% | 通过工艺改进 |
| **AI成本** | 月度AI分析成本 | <¥30 | DeepSeek API成本控制 |

---

## 2. 业务背景与案例

### 2.1 典型业务场景

**参与方**：
- **工厂A**：白垩纪水产加工厂
- **供应商B**：优质肉类供应商
- **餐馆C**：海鲜餐厅连锁店

**业务需求**：
- 餐馆C需要1200g精制猪肉
- 供应商B提供2000g新鲜猪肉原料
- 工厂A预期转换率60%（2000g → 1200g）
- 生产周期7天

### 2.2 业务痛点

```
┌─────────────────────────────────────────────┐
│           当前痛点 vs 解决方案                │
├─────────────────────────────────────────────┤
│                                             │
│ ❌ 痛点1: 原料浪费严重                        │
│    新鲜原料到期未使用，损失5-10%              │
│    └─ ✅ 解决: FIFO自动推荐，到期预警         │
│                                             │
│ ❌ 痛点2: 生产计划靠经验                      │
│    原料预估不准，经常多采购或缺货              │
│    └─ ✅ 解决: 智能预估，基于转换率自动计算    │
│                                             │
│ ❌ 痛点3: 成本不透明                         │
│    只知道总成本，不知道哪里超支                │
│    └─ ✅ 解决: 4维成本分解（原料/人工/设备/其他）│
│                                             │
│ ❌ 痛点4: 员工效率无法量化                    │
│    不知道谁干得好，谁需要培训                  │
│    └─ ✅ 解决: 机器学习效率分析，个人评分      │
│                                             │
│ ❌ 痛点5: 优化靠拍脑袋                        │
│    成本超支了不知道怎么改进                    │
│    └─ ✅ 解决: AI智能建议，3-5条可落地方案     │
│                                             │
└─────────────────────────────────────────────┘
```

---

## 3. 用户角色体系

### 3.1 角色层级架构图

```
                    ┌─────────────────────┐
                    │  平台层 (Platform)   │
                    │  platform_admin     │
                    │  • 管理所有工厂      │
                    │  • 跨工厂数据分析    │
                    │  • 只读权限          │
                    └──────────┬──────────┘
                               │
                ┌──────────────┴──────────────┐
                │                             │
    ┌───────────▼──────────┐      ┌──────────▼───────────┐
    │  工厂层 (Factory)     │      │  工厂层 (Factory)     │
    │  super_admin         │      │  super_admin         │
    │  • 工厂所有权限       │      │  • 工厂所有权限       │
    │  • 需要打卡          │      │  • 需要打卡          │
    └───────────┬──────────┘      └──────────┬───────────┘
                │                             │
    ┌───────────┼──────────┐      ┌──────────┼───────────┐
    │           │          │      │          │           │
┌───▼──┐   ┌───▼──┐   ┌──▼───┐ ┌▼─────┐ ┌──▼────┐ ┌───▼───┐
│dept  │   │dept  │   │dept  │ │dept  │ │dept   │ │dept   │
│admin │   │admin │   │admin │ │admin │ │admin  │ │admin  │
│加工部 │   │仓储部 │   │质检部 │ │养殖部 │ │物流部 │ │销售部 │
└───┬──┘   └───┬──┘   └──┬───┘ └┬─────┘ └──┬────┘ └───┬───┘
    │          │          │      │          │          │
┌───▼──────────▼──────────▼──────▼──────────▼──────────▼───┐
│                    operator (操作员)                       │
│                    • 打卡                                  │
│                    • 工作报告                              │
│                    • 查看本人数据                          │
└────────────────────────────────────────────────────────────┘
```

### 3.2 角色权限矩阵

| 功能模块 | platform_admin | super_admin | dept_admin | operator |
|---------|---------------|-------------|-----------|----------|
| **登录认证** | ✅ 不打卡 | ✅ 需打卡 | ✅ 需打卡 | ✅ 需打卡 |
| **原材料入库** | 👁️ 所有工厂只读 | ✅ 增删改查 | ❌ 无权限 | ❌ 无权限 |
| **生产计划管理** | 👁️ 所有工厂只读 | ✅ 增删改查 | ✅ 本部门增删改查 | 👁️ 查看任务 |
| **每日产量记录** | ❌ 不可操作 | ✅ 记录 | ✅ 本部门记录 | ❌ 无权限 |
| **成本分析** | 👁️ 所有工厂+AI | ✅ 本工厂+AI | ✅ 本部门+AI | ❌ 无权限 |
| **AI优化建议** | ✅ 可调用 | ✅ 可调用 | ✅ 可调用 | ❌ 无权限 |
| **库存管理** | 👁️ 所有工厂只读 | ✅ 增删改查 | 👁️ 相关库存只读 | ❌ 无权限 |
| **员工工时统计** | 👁️ 所有工厂 | ✅ 本工厂所有 | 👁️ 本部门所有 | 👁️ 仅本人 |
| **效率分析** | 👁️ 所有工厂 | ✅ 本工厂所有 | ✅ 本部门所有 | 👁️ 仅本人 |
| **系统配置** | ✅ 平台级 | ✅ 工厂级 | ❌ 无权限 | ❌ 无权限 |
| **转换率配置** | ❌ 不可修改 | ✅ 可配置 | ❌ 无权限 | ❌ 无权限 |
| **数据导出** | ✅ 所有数据 | ✅ 本工厂数据 | ✅ 本部门数据 | ❌ 无权限 |

**图例**：✅ 完全权限 | 👁️ 只读 | ❌ 无权限

---

## 4. 核心功能模块

### 4.1 模块关系图

```
┌─────────────────────────────────────────────────────────────┐
│                    白垩纪食品溯源系统                          │
│                      核心模块关系图                            │
└─────────────────────────────────────────────────────────────┘

        ┌──────────────────────────────────────┐
        │     ① 原材料入库模块                  │
        │  • 供应商送货                         │
        │  • 质检验收                           │
        │  • 入库登记（15个字段）                │
        │  • FIFO标记                          │
        │  • 新鲜/冻货区分                      │
        └────────────┬─────────────────────────┘
                     │ 生成库存数据
                     ▼
        ┌──────────────────────────────────────┐
        │     ② 生产计划模块                    │
        │  • 创建计划                           │
        │  • 智能预估原料（基于转换率）           │
        │  • 实时检查库存                        │
        │  • FIFO自动推荐批次                   │
        │  • 状态流转管理                        │
        └────────────┬─────────────────────────┘
                     │ 开始生产
                     ▼
        ┌──────────────────────────────────────┐
        │     ③ 生产执行与认证模块               │
        │  • 员工打卡（GPS+生物识别）            │
        │  • 每日产量记录                        │
        │  • 原料消耗扣减（实时更新库存）         │
        │  • 工时自动统计                        │
        │  • 转换率实时计算                      │
        └────────────┬─────────────────────────┘
                     │ 完成生产
                     ▼
        ┌──────────────────────────────────────┐
        │     ④ 成本分析模块                    │
        │  • 原料成本（基于消耗）                │
        │  • 人工成本（基于工时）                │
        │  • 设备成本（折旧+维修+消耗品+能耗）   │
        │  • 其他成本                           │
        │  • 单位成本计算                        │
        └────────────┬─────────────────────────┘
                     │ 触发AI分析
                     ▼
        ┌──────────────────────────────────────┐
        │     ⑤ AI智能分析模块                  │
        │  • DeepSeek LLM分析                  │
        │  • 转换率评估                         │
        │  • 人工效率分析                        │
        │  • 设备成本优化                        │
        │  • 个人效率ML预测                     │
        │  • 5条优化建议                        │
        └────────────┬─────────────────────────┘
                     │ 反馈优化
                     ▼
        ┌──────────────────────────────────────┐
        │     ⑥ 管理配置模块                    │
        │  • 原材料类型管理                      │
        │  • 产品类型管理                        │
        │  • 转换率配置（可基于AI建议更新）       │
        │  • AI参数配置                         │
        │  • 生产线配置                         │
        │  • 设备管理                           │
        └──────────────────────────────────────┘

        ┌──────────────────────────────────────┐
        │     ⑦ 库存管理模块（贯穿全流程）        │
        │  • FIFO优先级管理                     │
        │  • 新鲜/冻货转换                       │
        │  • 到期预警                           │
        │  • 实时库存查询                        │
        └──────────────────────────────────────┘
```

### 4.2 原材料入库模块

**功能目标**：确保原材料准确入库，避免浪费，支持FIFO先进先出管理

**入库表单设计**（15个关键字段）：

```
┌───────────────────────────────────────────────────┐
│  📦 原材料入库                              [×关闭] │
├───────────────────────────────────────────────────┤
│                                                   │
│  基本信息                                          │
│  ┌─────────────────────────────────────────────┐  │
│  │ 供应商 *     [选择供应商 ▼]                  │  │
│  │ 原料类型 *   [选择原料类型 ▼]                │  │
│  │ 入库批次号   RAW_20251008_001 (自动生成)    │  │
│  │ 入库日期     2025-10-08 08:00 (自动)        │  │
│  └─────────────────────────────────────────────┘  │
│                                                   │
│  数量信息                                          │
│  ┌─────────────────────────────────────────────┐  │
│  │ 入库重量 *   [2000] g                        │  │
│  │ 单价 *       [25] 元/kg                      │  │
│  │ 总金额       50.00元 (自动计算)              │  │
│  └─────────────────────────────────────────────┘  │
│                                                   │
│  储存信息                                          │
│  ┌─────────────────────────────────────────────┐  │
│  │ 储存类型 *   ⦿ 新鲜  ○ 冻货                  │  │
│  │ 储存温度 *   [0-4°C]                         │  │
│  │ 储存位置 *   [选择仓位 ▼] 冷藏区A-01         │  │
│  │ 保质期 *     [7] 天                          │  │
│  │ 到期日期     2025-10-15 (自动计算)           │  │
│  └─────────────────────────────────────────────┘  │
│                                                   │
│  质检信息                                          │
│  ┌─────────────────────────────────────────────┐  │
│  │ 质检员 *     [选择质检员 ▼] 李四             │  │
│  │ 质检状态 *   ⦿ 合格 ○ 不合格 ○ 待检         │  │
│  │ 新鲜度评分   ⭐⭐⭐⭐⭐ (9.5/10)              │  │
│  │ 质检备注     [肉质新鲜，无异味，色泽良好]     │  │
│  │ 质检照片     [📷 上传照片] (已上传3张)        │  │
│  └─────────────────────────────────────────────┘  │
│                                                   │
│  其他信息                                          │
│  ┌─────────────────────────────────────────────┐  │
│  │ 供应商批次号 [SUP_B_20251008_A]              │  │
│  │ 运输方式     [冷链物流]                      │  │
│  │ 验收人       张三 (当前登录用户)             │  │
│  │ 备注         [供应商准时送达]                │  │
│  └─────────────────────────────────────────────┘  │
│                                                   │
│              [取消]  [保存草稿]  [提交入库]         │
└───────────────────────────────────────────────────┘

* 表示必填项
```

**核心功能**：
- ✅ 15字段完整入库信息
- ✅ 质检验收（合格/不合格判定）
- ✅ FIFO自动标记（新鲜优先、先入先出）
- ✅ 库存实时更新
- ✅ 到期预警机制（3天/1天/当天预警）
- ✅ 新鲜/冻货转换

### 4.3 生产计划模块

**功能目标**：创建生产计划，智能预估原料需求，管理生产全流程

**智能预估流程**：
```
用户输入目标产量: 1200g
    ↓
系统读取转换率配置: 60%
    ↓
自动计算预计消耗: 1200g ÷ 60% = 2000g
    ↓
实时查询库存: 新鲜猪肉 2000g ✅
    ↓
FIFO推荐批次: RAW_20251008_001 (最早入库)
    ↓
显示预计成本:
  • 原料: ¥50
  • 人工: ¥13,125
  • 设备: ¥2,000
  • 总计: ¥15,175
```

**状态流转图**：
```
pending (待生产)
    ↓ [开始生产]
in_progress (生产中)
    ↓ [每日记录产量]
    ↓ [Day 7 完成生产]
completed (已完成)
    ↓ [触发成本计算]
    ↓ [触发AI分析]
```

**核心功能**：
- ✅ 智能预估原料消耗
- ✅ 实时库存充足性检查
- ✅ FIFO自动推荐批次
- ✅ 库存不足预警（降低产量/采购/替代）
- ✅ 每日产量记录
- ✅ 转换率实时监控（±5%触发AI）
- ✅ 状态流转管理

### 4.4 成本分析模块

**功能目标**：精准计算生产成本，分析成本构成，发现优化空间

**成本构成（4维分解）**：

```
总成本: ¥16,096.20
    │
    ├─ 原料成本: ¥50.00 (0.3%)
    │   └─ 2000g × ¥25/kg = ¥50
    │
    ├─ 人工成本: ¥13,125.00 (81.5%) ⚠️ 过高
    │   ├─ 员工A: 70h × ¥37.5 = ¥2,625
    │   ├─ 员工B: 70h × ¥37.5 = ¥2,625
    │   ├─ 员工C: 70h × ¥37.5 = ¥2,625
    │   ├─ 员工D: 70h × ¥37.5 = ¥2,625
    │   └─ 员工E: 68.25h × ¥37.5 = ¥2,559.37
    │
    ├─ 设备成本: ¥2,421.20 (15.0%)
    │   ├─ 折旧: ¥383.60
    │   ├─ 维修: ¥350.00 ⚠️ 偏高
    │   ├─ 消耗品: ¥1,206.00 ⚠️ 偏高
    │   │   ├─ 刀片: ¥300
    │   │   ├─ 砧板: ¥500
    │   │   ├─ 手套: ¥175
    │   │   ├─ 口罩: ¥70
    │   │   ├─ 工作服清洗: ¥100
    │   │   └─ 包装袋: ¥61
    │   └─ 能耗: ¥481.60
    │
    └─ 其他成本: ¥500.00 (3.1%)
        ├─ 质检费用: ¥200
        └─ 管理费用: ¥300
```

**核心功能**：
- ✅ 4维成本精准计算
- ✅ 成本构成饼图展示
- ✅ 成本明细可展开查看
- ✅ 实际vs预期对比
- ✅ 历史成本对比
- ✅ 超支预警机制

### 4.5 AI智能分析模块

**功能目标**：调用DeepSeek AI，提供成本优化建议和效率改进方案

**分析维度（5个）**：

```
🤖 AI分析报告

1️⃣ 转换率分析 ✅ 优秀
   • 实际61% vs 预期60%
   • 评价：工艺控制良好
   • 建议：更新系统配置为61%

2️⃣ 人工成本分析 ⚠️ 需优化
   • 占比81.5%（行业65-70%）
   • 小时产量3.49g/h（行业5-6g/h）
   • 建议：
     - 减少1人（节省¥2,625）
     - 员工培训（提升15%效率）
     - 优化流程

3️⃣ 设备成本分析 ⚠️ 略高
   • 维修频繁（¥350）
   • 消耗品超支（¥1,206）
   • 建议：
     - 预防性维护
     - 砧板10→6个（节省¥200）
     - 采购优质刀片

4️⃣ 原料成本分析 ✅ 优秀
   • 利用率100%，零浪费
   • FIFO执行完美

5️⃣ 个人效率分析 📊 ML
   • 员工C: 118% (最优)
   • 员工E: 85% (需培训)
   • 建议：C带教E

优化建议汇总 🔥
  立即实施（预计节省¥5,044，31.3%）
  1. 减少人员 5→4人
  2. 优化砧板 10→6个
  3. 更换优质刀片
  4. 预防性维护
  5. 员工培训
```

**核心功能**：
- ✅ DeepSeek API集成
- ✅ 5维深度分析
- ✅ 3-5条可落地建议
- ✅ 预估节省金额
- ✅ 成本控制（月度¥30）
- ✅ 缓存机制（5分钟）
- ✅ 降级策略（规则引擎）
- ✅ ML效率预测（≥10批次）

---

## 5. 界面设计与交互流程

### 5.1 系统导航架构

```
白垩纪食品溯源系统
│
├─ 登录/注册
│  ├─ 登录页 (用户名+密码 / 生物识别)
│  └─ 忘记密码
│
├─ 首页 (根据角色显示不同内容)
│  ├─ platform_admin: 所有工厂概览
│  ├─ super_admin: 本工厂概览 + 快捷操作
│  ├─ dept_admin: 本部门概览 + 快捷操作
│  └─ operator: 今日任务 + 打卡入口
│
├─ Tab 1: 打卡 ⏰ (operator必用, 其他角色也需要)
│  ├─ 上班打卡
│  ├─ 下班打卡
│  ├─ 打卡历史
│  └─ 工时统计
│
├─ Tab 2: 生产 🏭 (dept_admin+, operator只读)
│  ├─ 生产计划列表
│  │  ├─ 筛选（状态/日期）
│  │  ├─ 搜索
│  │  └─ 创建计划 → 创建表单 → 提交
│  │
│  ├─ 生产计划详情
│  │  ├─ 基本信息
│  │  ├─ 原料消耗情况
│  │  ├─ 生产进度
│  │  ├─ 每日产量记录
│  │  ├─ 成本分析入口 → 跳转成本分析
│  │  └─ 操作按钮
│  │     ├─ 开始生产 → 确认弹窗 → 执行
│  │     ├─ 记录今日产量 → 表单 → 提交
│  │     └─ 完成生产 → 确认表单 → 触发成本计算
│  │
│  └─ 每日产量记录列表
│
├─ Tab 3: 成本 💰 (dept_admin+)
│  ├─ 成本分析列表
│  │  ├─ 按批次查看
│  │  └─ 按日期筛选
│  │
│  ├─ 成本分析详情
│  │  ├─ 成本总览
│  │  ├─ 成本饼图
│  │  ├─ 成本明细（可展开）
│  │  ├─ 历史对比
│  │  └─ AI智能分析入口 → 跳转AI分析
│  │
│  └─ AI分析报告
│     ├─ 综合评价
│     ├─ 详细分析（5个维度）
│     ├─ 优化建议（分优先级）
│     └─ 导出/分享
│
├─ Tab 4: 库存 📦 (super_admin+)
│  ├─ 库存概览
│  │  ├─ 按原料类型汇总
│  │  ├─ 到期预警列表
│  │  └─ FIFO优先级排序
│  │
│  ├─ 原材料入库 → 入库表单 → 提交 → 更新库存
│  │
│  ├─ 入库历史
│  │  ├─ 按日期筛选
│  │  ├─ 按供应商筛选
│  │  └─ 批次详情 → 查看使用情况
│  │
│  └─ 库存调整
│     ├─ 新鲜转冻货
│     ├─ 盘点
│     └─ 报废处理
│
├─ Tab 5: 管理 ⚙️ (super_admin)
│  ├─ 系统配置
│  │  ├─ 原材料类型管理 → 列表 → 新增/编辑
│  │  ├─ 产品类型管理 → 列表 → 新增/编辑
│  │  ├─ 转换率配置 → 配置界面 → 保存
│  │  ├─ AI参数配置 → 配置界面 → 保存
│  │  ├─ 供应商管理 → 列表 → 新增/编辑
│  │  ├─ 商家管理 → 列表 → 新增/编辑
│  │  ├─ 生产线配置 → 列表 → 新增/编辑
│  │  ├─ 设备管理 → 列表 → 新增/编辑/维修记录
│  │  └─ 仓位管理 → 列表 → 新增/编辑
│  │
│  ├─ 员工管理
│  │  ├─ 员工列表
│  │  ├─ 新增员工
│  │  ├─ 编辑员工信息
│  │  └─ 员工效率分析 → 查看ML分析结果
│  │
│  └─ 数据报表
│     ├─ 生产报表
│     ├─ 成本报表
│     ├─ 工时报表
│     └─ 导出功能
│
└─ 个人中心 👤 (所有角色)
   ├─ 个人信息
   ├─ 修改密码
   ├─ 生物识别设置
   ├─ 我的工时（operator）
   ├─ 我的效率评分（operator）
   └─ 退出登录
```

### 5.2 核心界面跳转流程

#### 生产计划完整流程

```
首页 → 生产Tab → [+创建计划]
    ↓
填写计划表单
  • 产品类型: 精制猪肉
  • 目标产量: 1200g
    ↓
系统智能计算
  • 预计消耗: 2000g (基于60%转换率)
  • 库存检查: 2000g ✅ 充足
  • FIFO推荐: RAW_20251008_001
    ↓
完善信息 → [提交创建]
    ↓
创建成功 → 自动跳转计划详情
    ↓
状态: pending
操作: [开始生产] [编辑] [删除]
    ↓
点击 [开始生产] → 确认弹窗 → [确认]
    ↓
状态变更: pending → in_progress
自动刷新详情页
    ↓
操作: [记录今日产量] [暂停] [完成]
    ↓
每天点击 [记录今日产量]
  • 填写消耗和产出
  • 系统计算转换率
  • 实时更新库存和进度
    ↓
Day 7 点击 [完成生产]
  • 填写确认表单
  • [确认完成]
    ↓
状态变更: in_progress → completed
触发成本计算
触发AI分析
    ↓
显示: [查看成本分析] [AI智能分析]
    ↓
点击 [AI智能分析] → 跳转AI报告
  • 5维分析
  • 优化建议
  • [采纳建议] [导出报告]
```

---

## 6. 业务流程图

### 6.1 端到端业务流程（7天完整周期）

```
┌─────────────────────────────────────────────────────────┐
│            端到端业务流程（工厂A案例）                     │
└─────────────────────────────────────────────────────────┘

Day 1: 原材料入库
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  供应商B送货 (2000g新鲜猪肉)
    ↓
  质检员验收 (新鲜度9.5分 ✅)
    ↓
  super_admin入库
    • 15字段完整填写
    • 储存类型: 新鲜
    • 保质期: 7天
    • 到期: 2025-10-15
    ↓
  系统处理
    • 生成批次号: RAW_20251008_001
    • 库存更新: +2000g
    • FIFO标记: 优先级1
    ↓
  入库完成 ✅

Day 1: 创建生产计划
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  接到餐馆C订单 (1200g精制猪肉)
    ↓
  super_admin创建计划
    • 产品: 精制猪肉
    • 目标: 1200g
    ↓
  系统智能计算
    • 转换率: 60%
    • 预计消耗: 2000g
    • 库存: 2000g ✅
    • FIFO推荐: RAW_20251008_001
    • 预计成本: ¥15,175
    ↓
  创建成功
    • 计划号: PROD_20251008_001
    • 状态: pending
    • 库存预留: 2000g

Day 2: 开始生产
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  5名员工打卡上班 (08:00)
    ↓
  dept_admin开始生产
    • 确认人员: 5人 ✅
    • 确认原料: 2000g ✅
    • 点击[开始生产]
    ↓
  系统更新
    • 状态: in_progress
    • 开始时间: 08:00
    ↓
  生产进行中...
    ↓
  记录今日产量 (17:30)
    • 消耗: 300g
    • 产出: 175g
    • 转换率: 58.3% ⚠️ 略低
    ↓
  系统处理
    • 库存扣减: -300g
    • 累计产量: 175g
    • 进度: 14.6%
    • 转换率预警: 首日略低
    ↓
  员工下班打卡 (18:00)
    • 工时统计: 5人 × 10小时

Day 3-8: 循环生产 (6天)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  每日:
    • 员工打卡上班
    • 生产加工
    • 记录产量
    • 库存扣减
    • 员工下班打卡
    ↓
  Day 2: 280g→170g (60.7%) ✅
  Day 3: 290g→180g (62.1%) ✅
  Day 4: 270g→165g (61.1%) ✅
  Day 5: 285g→175g (61.4%) ✅
  Day 6: 300g→185g (61.7%) ✅
  Day 7: 275g→170g (61.8%) ✅
    ↓
  7天汇总:
    • 消耗: 2000g
    • 产出: 1220g ✅ 超目标20g
    • 转换率: 61.0% ✅ 优于60%
    • 工时: 350小时

Day 8: 完成生产
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  dept_admin完成生产
    • 最终产量: 1220g
    • 质检: 合格 ✅
    • 点击[确认完成]
    ↓
  系统处理
    • 状态: completed
    • 完成时间: 2025-10-15 18:00
    • 数据锁定
    ↓
  触发成本计算
    • 原料: ¥50 (0.3%)
    • 人工: ¥13,125 (81.5%) ⚠️
    • 设备: ¥2,421 (15.0%)
    • 其他: ¥500 (3.1%)
    • 总计: ¥16,096.20
    • 单位: ¥13.19/kg
    • 超支: +¥921 (+4.3%)
    ↓
  触发AI分析

Day 9: AI分析与优化
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  super_admin查看成本
    • 发现人工成本过高
    • 点击[AI智能分析]
    ↓
  DeepSeek分析 (5-10秒)
    • 5维深度分析
    • 生成优化建议
    ↓
  AI报告展示
    • 转换率61%优秀 ✅
    • 人工效率偏低 ⚠️
    • 设备维修频繁 ⚠️
    • 消耗品超支 ⚠️
    • 个人效率分析
    ↓
  优化建议
    • 立即实施5项
    • 预计节省¥5,044 (31.3%)
    • 优化后成本: ¥9.06/kg
    ↓
  采纳建议
    • 更新转换率: 61%
    • 调整人员: 5→4人
    • 优化设备配置
    • 建立维护计划
    • 安排员工培训

Day 10: 成品交付
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  打包配送
    • 产品: 1220g精制猪肉
    • 质量: 优等品 ✅
    • 冷链物流
    ↓
  送达餐馆C
    • 验收: 1220g ✅
    • 超额: +20g (赠送)
    • 满意度: ⭐⭐⭐⭐⭐
    ↓
  建立长期合作 ✅

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
关键成果:
  ✅ FIFO完美执行，0浪费
  ✅ 转换率61%优于预期
  ✅ 超额完成20g
  ⚠️ 成本超支4.3%
  🤖 AI发现5个优化点
  📈 预计节省31.3%成本
  🎯 客户满意，建立合作
```

---

## 7. 异常场景处理

### 7.1 库存不足场景

```
触发: 创建计划时预估消耗 > 可用库存

示例:
  目标产量: 1500g
  预估消耗: 2500g (1500g ÷ 60%)
  可用库存: 2000g
  缺口: 500g ⚠️
    ↓
系统弹窗:
  ┌─────────────────────────────┐
  │ ⚠️ 库存不足警告              │
  │                             │
  │ 预计消耗：2500g              │
  │ 可用库存：2000g              │
  │ 缺口：500g                  │
  │                             │
  │ 建议操作：                   │
  │ 1️⃣ 降低目标产量至1200g       │
  │ 2️⃣ 发起采购申请500g          │
  │ 3️⃣ 使用冻货批次(如有)         │
  │                             │
  │ [返回修改] [强制创建]        │
  └─────────────────────────────┘
```

### 7.2 转换率异常场景

```
触发: |实际转换率 - 预期转换率| ≥ 5%

示例:
  Day 1记录
    消耗: 300g
    产出: 150g
    转换率: 50% (预期60%)
    偏差: -10% 🔴
    ↓
系统预警:
  ┌─────────────────────────────┐
  │ 🔴 转换率异常预警             │
  │                             │
  │ 预期转换率: 60%              │
  │ 实际转换率: 50%              │
  │ 偏差: -10% 严重偏低          │
  │                             │
  │ 可能原因:                    │
  │ • 原料质量问题               │
  │ • 员工操作不熟练             │
  │ • 设备故障                  │
  │ • 质检标准过严               │
  │                             │
  │ [调用AI分析] [忽略继续]      │
  └─────────────────────────────┘
    ↓
AI分析诊断:
  • 原料含水量偏高60% (正常55-58%)
  • 员工首日操作不熟练
  • 质检标准偏严格
  • 建议: 更换供应商、加强培训
  • 预计Day 2-3改善至58%
```

### 7.3 原料到期场景

```
触发: 距离到期 ≤ 3天

示例:
  批次: RAW_20251008_001
  剩余: 150g
  到期: 今日 (2025-10-15)
    ↓
系统预警:
  ┌─────────────────────────────┐
  │ 🔴 原料到期预警              │
  │                             │
  │ 批次: RAW_20251008_001      │
  │ 剩余: 150g新鲜猪肉           │
  │ 到期: 今日                  │
  │                             │
  │ 处理方案:                    │
  │ 1️⃣ 创建小批次计划(预计90g)   │
  │ 2️⃣ 转为冻货(延长30天)        │
  │ 3️⃣ 申请报废                 │
  │                             │
  │ [立即处理] [稍后提醒]        │
  └─────────────────────────────┘
```

### 7.4 异常优先级

```
P0 (紧急，5分钟响应)
  • 质检严重不合格
  • 设备重大故障
  • 系统数据丢失

P1 (高，4小时处理)
  • 转换率异常≥10%
  • 成本超支≥10%
  • 原料当日到期
  • 生产中断>4小时

P2 (中，24小时处理)
  • 转换率偏差5-10%
  • 成本超支5-10%
  • 原料3天内到期
  • 设备维修频繁

P3 (低，一周处理)
  • 转换率偏差2-5%
  • 成本超支<5%
  • 个别员工迟到
```

---

## 8. 数据流转逻辑

### 8.1 核心数据流

```
1. 原材料入库 → 库存更新
   ┌────────────────┐
   │ 入库表单(15字段)│
   └────────┬───────┘
            ▼
   ┌────────────────┐
   │ raw_material_  │
   │ receipts表     │
   │ • batchNumber  │
   │ • quantity     │
   │ • fifoTimestamp│
   └────────┬───────┘
            ▼
   ┌────────────────┐
   │ inventory表    │
   │ • +quantity    │
   │ • fifoPriority │
   └────────────────┘

2. 创建计划 → 智能预估
   ┌────────────────┐
   │ 目标产量1200g   │
   └────────┬───────┘
            ▼
   ┌────────────────┐
   │读取转换率60%    │
   └────────┬───────┘
            ▼
   ┌────────────────┐
   │预估消耗2000g    │
   └────────┬───────┘
            ▼
   ┌────────────────┐
   │查询库存2000g✅  │
   └────────┬───────┘
            ▼
   ┌────────────────┐
   │FIFO推荐批次     │
   └────────┬───────┘
            ▼
   ┌────────────────┐
   │production_plans│
   │ • planNumber   │
   │ • status       │
   │ • estimated... │
   └────────────────┘

3. 打卡 → 工时 → 成本
   ┌────────────────┐
   │员工上班打卡     │
   └────────┬───────┘
            ▼
   ┌────────────────┐
   │employee_clock_ │
   │records表       │
   │ • clockIn      │
   │ • gpsLocation  │
   └────────┬───────┘
            ▼
   ┌────────────────┐
   │work_sessions表 │
   │ • duration     │
   │ • planId       │
   └────────┬───────┘
            ▼
   ┌────────────────┐
   │成本计算        │
   │工时×时薪       │
   └────────────────┘

4. 每日记录 → 库存扣减
   ┌────────────────┐
   │记录产量表单     │
   │ • 消耗300g     │
   │ • 产出175g     │
   └────────┬───────┘
            ▼
   ┌────────────────┐
   │计算转换率58.3%  │
   └────────┬───────┘
            ▼
   ┌────────────────┐
   │库存扣减-300g    │
   └────────┬───────┘
            ▼
   ┌────────────────┐
   │累计产量+175g    │
   │进度14.6%       │
   └────────────────┘

5. 完成 → 成本 → AI
   ┌────────────────┐
   │完成生产确认     │
   └────────┬───────┘
            ▼
   ┌────────────────┐
   │触发成本计算     │
   │ • 原料¥50      │
   │ • 人工¥13,125  │
   │ • 设备¥2,421   │
   │ • 其他¥500     │
   └────────┬───────┘
            ▼
   ┌────────────────┐
   │cost_analysis表 │
   │ • totalCost    │
   │ • costPerKg    │
   │ • deviation    │
   └────────┬───────┘
            ▼
   ┌────────────────┐
   │触发AI分析       │
   │DeepSeek API    │
   └────────┬───────┘
            ▼
   ┌────────────────┐
   │ai_analysis_    │
   │results表       │
   │ • analysis     │
   │ • recommend... │
   └────────────────┘
```

### 8.2 核心数据表

```
1. raw_material_receipts (原材料入库)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   id, batchNumber, factoryId
   supplierI, materialTypeId
   quantity, unitPrice, totalAmount
   storageType, storageLocation
   shelfLife, expiryDate
   qualityStatus, qualityScore
   qualityPhotos (JSON)
   inspectorId, receivedBy
   fifoTimestamp, receivedAt

2. inventory (库存)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   id, factoryId, materialTypeId
   batchNumber
   totalQuantity, reservedQuantity
   availableQuantity (= total - reserved)
   storageType, expiryDate
   fifoPriority (越小越优先)
   lastUpdated

3. production_plans (生产计划)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   id, planNumber, planName
   factoryId, status
   productTypeId, targetQuantity
   actualQuantity, qualityGrade
   merchantId, orderNumber
   rawMaterialInfo (JSON)
     ├─ conversionRate
     ├─ estimatedConsumption
     └─ selectedBatches
   staffing (JSON)
   estimatedCosts (JSON)
   cumulativeOutput, progress

4. daily_production_records (每日记录)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   id, planId, recordDate
   dayNumber, rawConsumed
   productOutput, conversionRate
   targetRate, deviation
   qualityStatus, photos
   recordedBy, recordedAt

5. employee_clock_records (打卡)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   id, employeeId, factoryId
   clockType (clock_in/clock_out)
   clockTime, gpsLocation
   distance, status
   workType, productionLine
   photo, approvedBy

6. work_sessions (工作会话)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   id, employeeId, planId
   clockInId, clockOutId
   startTime, endTime
   duration (hours)
   workType, productionLine

7. cost_analysis (成本分析)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   id, planId
   rawMaterialCost, laborCost
   equipmentCost, equipmentDetails (JSON)
     ├─ depreciation
     ├─ maintenance
     ├─ consumables
     └─ energy
   otherCost, totalCost
   costPerKg, estimatedCost
   deviation, deviationPercent

8. ai_analysis_results (AI分析)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   id, planId, analysisType
   model, analysisText
   recommendations (JSON Array)
   confidence, apiCost
   tokens, fromCache
   usedFallback, createdAt

9. ai_usage_log (AI使用日志)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   id, planId, service
   cost, tokens, timestamp

10. conversion_rates (转换率配置)
    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    id, productTypeId, materialTypeId
    storageType, conversionRate
    historicalAvg, historicalMax
    historicalMin, stdDeviation
    aiRecommended, isActive
    updatedBy, updatedAt
```

---

## 9. 非功能性需求

### 9.1 性能要求

| 指标 | 目标值 | 说明 |
|-----|-------|------|
| **App启动** | <3秒 | 冷启动到可交互 |
| **API响应** | <500ms | P95响应时间 |
| **页面切换** | <300ms | Tab/页面跳转 |
| **AI分析** | <10秒 | DeepSeek API响应 |
| **并发用户** | 100+ | 单工厂峰值 |
| **内存占用** | <200MB | 稳态运行 |
| **APK大小** | <50MB | 安装包 |

### 9.2 安全要求

```
身份认证
  • 密码加密: bcrypt (12轮)
  • Token过期: 24小时 (AccessToken)
  • 生物识别: 指纹/Face ID
  • GPS验证: 打卡位置

权限控制
  • RBAC模型: 基于角色
  • 最小权限原则
  • 数据隔离: 工厂/部门/个人
  • 每请求验证

数据安全
  • 传输: HTTPS强制
  • 存储: 敏感数据AES-256
  • 防护: SQL注入/XSS/CSRF
  • 备份: 每日增量，每周全量
```

### 9.3 兼容性要求

| 平台 | 版本要求 |
|-----|---------|
| **iOS** | 13.0+ |
| **Android** | 8.0+ (API 26+) |
| **Node.js** | 18.0+ LTS |
| **MySQL** | 8.0+ |
| **Redis** | 6.0+ (可选) |

---

## 10. 验收标准

### 10.1 功能验收清单

```
原材料入库模块 ✅
  □ 15字段完整性验证
  □ 质检流程正确
  □ FIFO自动标记
  □ 库存实时更新
  □ 到期预警机制
  □ 新鲜/冻货转换

生产计划模块 ✅
  □ 智能预估准确
  □ 库存充足性检查
  □ FIFO自动推荐
  □ 状态流转正确
  □ 每日记录完整
  □ 转换率预警

员工打卡模块 ✅
  □ GPS验证(500m)
  □ 生物识别支持
  □ 异常打卡处理
  □ 工时自动统计
  □ 补打卡审批

成本分析模块 ✅
  □ 4维成本精准计算
  □ 成本构成可视化
  □ 实际vs预期对比
  □ 明细可展开查看
  □ 超支预警

AI分析模块 ✅
  □ DeepSeek API集成
  □ 5维深度分析
  □ 3-5条可落地建议
  □ 成本控制¥30/月
  □ 降级策略可用
  □ ML效率预测(≥10批次)

管理配置模块 ✅
  □ 原料/产品类型管理
  □ 转换率配置(AI推荐)
  □ AI参数配置
  □ 供应商/商家管理
  □ 生产线/设备管理

权限控制 ✅
  □ 4角色权限正确
  □ 数据隔离完整
  □ 打卡要求符合
  □ 跨工厂只读(平台)

性能验收 ✅
  □ 启动<3秒
  □ API<500ms
  □ 页面切换<300ms
  □ 内存<200MB
  □ 并发100+用户
```

### 10.2 验收通过标准

```
✅ 功能验收通过率 ≥95%
✅ 性能指标全部达标
✅ 无P0/P1级别bug
✅ P2级别bug <5个
✅ 用户满意度 ≥85%
✅ 代码覆盖率 ≥70%
```

---

## 📄 附录

### 附录A：术语表

| 术语 | 说明 |
|------|------|
| FIFO | First In First Out，先进先出库存管理原则 |
| 转换率 | 原料转换为成品的比率，如60%表示2000g原料产出1200g成品 |
| GPS | 全球定位系统，用于打卡位置验证 |
| JWT | JSON Web Token，用户认证令牌 |
| DeepSeek | 国产大语言模型，用于智能成本分析 |
| ML | Machine Learning，机器学习 |
| RBAC | Role-Based Access Control，基于角色的访问控制 |
| SOP | Standard Operating Procedure，标准操作流程 |
| ROI | Return On Investment，投资回报率 |

### 附录B：优先级定义

| 级别 | 名称 | 响应时间 | 示例 |
|------|------|---------|------|
| P0 | 紧急 | 5分钟 | 质检严重不合格、系统数据丢失 |
| P1 | 高 | 4小时 | 转换率异常≥10%、成本超支≥10% |
| P2 | 中 | 24小时 | 转换率偏差5-10%、设备维修频繁 |
| P3 | 低 | 1周 | 转换率偏差2-5%、个别员工迟到 |

---

## 📋 文档变更记录

| 版本 | 日期 | 修改人 | 修改内容 |
|------|------|--------|---------|
| v3.0 | 2025-10-08 | AI助手 | 完整PRD创建，包含业务案例、界面流程、数据流转、异常处理 |
| v2.0 | 2025-01-05 | 项目组 | 添加AI分析和机器学习模块 |
| v1.0 | 2024-12-01 | 项目组 | 初始版本 |

---

**文档结束**

*本PRD文档基于实际业务需求整理，涵盖原材料入库、生产计划、员工打卡、成本分析、AI智能优化等完整业务流程，包含详细的界面设计、数据流转、异常处理和验收标准。*

*如有疑问请联系产品负责人*
