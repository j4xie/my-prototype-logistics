# 白垩纪食品溯源系统 - 后端功能详解

## 📋 系统架构概述

**白垩纪食品溯源系统后端**是一个企业级的多租户食品全链路追溯管理平台，采用现代化的Node.js技术栈，支持从原料采购到最终销售的完整业务流程管理。

### 🏗️ 技术架构
- **框架**: Express.js (ES模块) + Prisma ORM + MySQL
- **认证**: JWT多层令牌系统 (AccessToken + RefreshToken + TempToken + DeviceToken)
- **安全**: bcrypt密码加密 + Helmet安全头 + CORS跨域控制
- **日志**: Winston分级日志系统
- **中间件**: 多层权限验证、错误处理、数据验证
- **存储**: MySQL主数据库 + 本地文件存储

---

## 🔐 认证权限系统详解

### 1. 统一认证控制器 (authController.js)

#### **智能统一登录系统**
**核心逻辑**: `unifiedLogin()` 函数实现智能用户类型识别
```javascript
// 工作流程:
1. 接收用户名和密码
2. 优先尝试平台管理员登录 (PlatformAdmin表)
3. 如果失败，尝试工厂用户登录 (User表)
4. 根据用户类型生成对应的权限结构
5. 返回统一格式的认证响应
```

**权限生成逻辑**:
- **平台用户**: 拥有跨工厂访问权限，支持3层角色 (system_developer, platform_super_admin, platform_operator)
- **工厂用户**: 仅能访问所属工厂数据，支持5层角色 (factory_super_admin, permission_admin, department_admin, operator, viewer)

#### **两阶段注册系统**
**Phase 1 - 手机验证**: `mobileRegisterPhaseOne()`
```javascript
工作流程:
1. 验证手机号格式
2. 检查白名单状态 (UserWhitelist表)
3. 生成手机验证码 (模拟SMS)
4. 创建临时令牌 (TempToken表)
5. 返回临时令牌用于第二阶段
```

**Phase 2 - 完整注册**: `mobileRegisterPhaseTwo()`
```javascript
工作流程:
1. 验证临时令牌有效性
2. 验证用户名唯一性
3. 加密存储密码 (bcrypt)
4. 创建用户记录 (User表)
5. 标记白名单为已注册状态
6. 生成正式认证令牌
```

#### **设备绑定管理**
**设备绑定**: `bindDevice()` - 实现设备级安全控制
```javascript
安全机制:
1. 验证设备ID唯一性
2. 记录设备硬件信息 (型号、OS版本、平台)
3. 创建设备令牌 (DeviceToken)
4. 支持多设备绑定管理
5. 设备状态跟踪 (活跃/非活跃)
```

### 2. 移动端认证中间件 (mobileAuth.js)

#### **多层令牌验证**
```javascript
验证优先级:
1. 临时移动令牌 (mobile_token_*) - 用于开发测试
2. 标准JWT令牌验证
3. 平台管理员令牌验证
4. 工厂用户令牌验证
5. 设备绑定验证
```

#### **权限注入机制**
- 自动计算用户权限并注入到 `req.user` 或 `req.admin`
- 支持工厂上下文隔离 (Multi-tenant)
- 实时权限验证和角色映射

### 3. 权限配置系统 (permissions.js)

#### **7层角色权限体系**

**平台级权限** (3层):
- **system_developer**: 系统最高权限，包含调试和跨平台访问
- **platform_super_admin**: 平台管理权限，可管理所有工厂
- **platform_operator**: 平台操作员，只读访问权限

**工厂级权限** (5层):
- **factory_super_admin**: 工厂内最高权限
- **permission_admin**: 用户权限管理员
- **department_admin**: 部门级管理员
- **operator**: 操作员权限
- **viewer**: 只读访问权限

#### **权限计算算法**
```javascript
calculateUserPermissions(userType, roleCode, department):
1. 根据角色代码查找基础权限模板
2. 基于部门添加特定权限
3. 应用权限级别限制 (roleLevel)
4. 合并模块访问权限
5. 返回完整权限对象
```

---

## 👥 用户管理系统详解

### 1. 用户控制器 (userController.js)

#### **用户激活系统**
**核心逻辑**: `activateUser()` - 管理员激活用户并分配权限
```javascript
激活流程:
1. 验证目标用户存在且未激活
2. 权限验证 (只有super_admin可创建permission_admin)
3. 部门权限匹配验证
4. 更新用户状态为活跃
5. 分配角色和部门
6. 记录角色变更历史 (UserRoleHistory表)
```

#### **用户角色管理**
- **角色升级/降级**: 严格的权限继承检查
- **部门调动**: 跨部门权限验证
- **批量操作**: 支持批量用户状态更新
- **审计追踪**: 所有用户操作都有完整日志

### 2. 白名单管理 (whitelistController.js)

#### **邀请制注册系统**
```javascript
白名单工作流程:
1. 管理员添加手机号到白名单
2. 设置有效期限 (默认7天)
3. 用户注册时验证白名单状态
4. 注册成功后标记为已使用
5. 过期自动清理机制
```

#### **白名单状态管理**
- **PENDING**: 待注册状态
- **REGISTERED**: 已注册状态
- **EXPIRED**: 已过期状态

---

## 🏭 生产管理系统详解

### 1. 加工批次控制器 (processingController.js)

#### **批次生命周期管理**
**创建批次**: `createBatch()` - 智能批次编号生成
```javascript
批次创建流程:
1. 工厂ID上下文验证
2. 自动生成批次编号 (工厂+产品类型+日期+序号)
3. 原料信息记录 (JSON格式)
4. 生产线分配
5. 监督员指定
6. 目标产量设定
```

**批次状态流转**:
- **planning** → **in_progress** → **quality_check** → **completed** / **failed**

#### **批次数据查询**
- 支持多维度筛选 (状态、日期、产品类型、生产线)
- 分页查询优化
- 关联数据预加载 (质检记录、监督员信息)

### 2. 质检管理控制器 (qualityController.js)

#### **质检记录提交**
**核心逻辑**: `submitInspection()` - 全面的质检流程
```javascript
质检流程:
1. 验证批次存在和归属
2. 记录检验项目 (testItems JSON)
3. 综合结果评定 (pass/fail/conditional_pass)
4. 质量评分 (0-100分)
5. 缺陷详情记录
6. 纠正措施建议
7. 现场照片上传
```

#### **质检类型支持**
- **raw_material**: 原料检验
- **process**: 过程检验  
- **final_product**: 成品检验

#### **质检数据分析**
- 质检通过率统计
- 缺陷类型分析
- 检验员绩效评估
- 趋势分析和预警

---

## 🔧 设备监控系统详解

### 1. 设备管理控制器 (equipmentController.js)

#### **实时设备监控**
**核心功能**: `getEquipmentMonitoring()` - 设备状态实时查询
```javascript
监控数据结构:
1. 设备基本信息 (编号、名称、类型、位置)
2. 实时监控数据 (温度、压力、转速等)
3. 状态评估 (normal/warning/error/maintenance)
4. 告警触发状态
5. 历史数据趋势
```

#### **设备分类管理**
- **按部门分类**: farming, processing, logistics, quality, management
- **按状态分类**: active, maintenance, inactive
- **按类型分类**: 自定义设备类型管理

### 2. 设备监控数据 (DeviceMonitoringData模型)

#### **数据采集机制**
```javascript
监控数据结构:
- timestamp: 数据采集时间戳
- metrics: JSON格式的指标数据
- status: 设备当前状态
- alertTriggered: 是否触发告警
- dataSource: 数据来源标识
```

---

## ⚠️ 智能告警系统详解

### 1. 告警控制器 (alertController.js)

#### **告警分类体系**
**告警类型**:
- **quality**: 质量相关告警
- **equipment**: 设备故障告警
- **production**: 生产异常告警
- **safety**: 安全事件告警

**严重级别**:
- **critical**: 紧急告警 (立即处理)
- **high**: 高级告警 (1小时内处理)
- **medium**: 中级告警 (4小时内处理)
- **low**: 低级告警 (24小时内处理)

#### **告警生命周期管理**
```javascript
告警状态流转:
new → acknowledged → in_progress → resolved → closed

处理流程:
1. 告警自动创建
2. 分配责任人 (assignedTo JSON数组)
3. 确认接收 (acknowledged)
4. 开始处理 (in_progress)
5. 问题解决 (resolved)
6. 归档关闭 (closed)
```

#### **智能分配机制**
- 基于部门自动分配
- 基于专业技能匹配
- 工作负载均衡分配
- 升级机制 (超时自动升级)

---

## 📊 仪表板系统详解

### 1. 仪表板控制器 (dashboardController.js)

#### **生产概览数据**
**核心功能**: `getDashboardOverview()` - 实时生产状态监控
```javascript
统计维度:
1. 批次统计 (总数、活跃、完成)
2. 质检统计 (检验次数、通过率)
3. 设备统计 (总数、活跃设备)
4. 告警统计 (活跃告警数量)
5. 生产效率指标
6. 质量趋势分析
```

#### **时间周期支持**
- **today**: 当日数据
- **week**: 近7天数据
- **month**: 近30天数据
- **custom**: 自定义时间范围

#### **缓存优化机制**
- 使用 DashboardMetric 表缓存计算结果
- 5分钟缓存刷新周期
- 按工厂和指标类型分别缓存
- 自动过期清理机制

---

## 📋 报表生成系统详解

### 1. 报表控制器 (reportController.js)

#### **报表模板系统**
**模板分类**:
- **production**: 生产报表
- **quality**: 质量报表
- **equipment**: 设备报表
- **custom**: 自定义报表

#### **报表生成引擎**
**支持格式**:
- **Excel** (ExcelJS): 详细数据报表
- **PDF** (PDFKit): 正式文档报表
- **JSON**: API数据导出

#### **模板管理机制**
```javascript
模板类型:
1. 系统模板 (isSystem: true) - 全局可用
2. 工厂模板 (factoryId) - 工厂专用
3. 用户模板 (createdBy) - 个人定制

模板结构:
- template: JSON格式的报表结构定义
- parameters: 报表参数配置
- isActive: 模板状态控制
```

---

## 📱 移动端API系统详解

### 1. 移动端路由 (mobile.js)

#### **统一API接口**
**核心特性**:
- 统一响应格式
- 移动端优化 (文件大小限制、响应时间优化)
- 离线支持设计
- 设备信息记录

#### **文件上传优化**
```javascript
移动端上传特性:
1. 文件大小限制: 10MB
2. 支持格式: JPEG, PNG, WebP
3. 批量上传: 最多10个文件
4. 自动压缩优化
5. 移动网络适配
```

#### **DeepSeek AI分析集成**
**分析接口**: `/api/mobile/analysis/deepseek`
```javascript
AI分析流程:
1. 接收业务数据
2. 数据预处理和格式化
3. 调用DeepSeek API
4. 结果后处理和优化
5. 成本控制和缓存
6. 返回分析建议
```

#### **应用激活系统**
**激活流程**:
```javascript
1. 验证激活码格式和有效性
2. 检查设备信息完整性
3. 创建激活记录 (ActivationRecord表)
4. 设置应用有效期
5. 启用功能模块
```

---

## 🗄️ 数据模型详解

### 1. 核心业务模型

#### **Factory (工厂模型)**
```javascript
核心字段:
- id: 工厂唯一标识 (智能生成)
- name: 工厂名称
- industryCode: 行业编码
- regionCode: 地区编码
- factoryYear: 成立年份
- sequenceNumber: 序列号
- confidence: AI推断置信度
```

#### **User (用户模型)**
```javascript
核心字段:
- factoryId: 所属工厂
- username: 用户名 (工厂内唯一)
- roleCode: 角色代码 (5层权限)
- department: 部门 (5个业务部门)
- isActive: 激活状态
- lastLogin: 最后登录时间
```

#### **ProcessingBatch (加工批次模型)**
```javascript
核心字段:
- batchNumber: 批次编号 (自动生成)
- productType: 产品类型
- rawMaterials: 原料信息 (JSON)
- status: 批次状态 (5种状态)
- supervisorId: 监督员ID
- targetQuantity/actualQuantity: 目标/实际产量
```

### 2. 监控和日志模型

#### **SystemLog (系统日志模型)**
```javascript
日志级别:
- debug: 调试信息
- info: 一般信息
- warn: 警告信息
- error: 错误信息
- fatal: 致命错误

记录内容:
- level: 日志级别
- category: 日志分类
- message: 日志消息
- details: 详细信息 (JSON)
- userId/factoryId: 用户和工厂关联
```

#### **ApiAccessLog (API访问日志模型)**
```javascript
记录内容:
- method: HTTP方法
- path: 访问路径
- statusCode: 响应状态码
- responseTime: 响应时间
- requestBody/responseBody: 请求/响应内容
- ipAddress: 客户端IP
```

---

## 🔄 定时任务系统详解

### 1. 定时任务服务 (cronJobs.js)

#### **定时任务类型**
```javascript
任务调度:
1. 白名单过期清理 (每小时执行)
2. 会话过期清理 (每6小时执行)
3. 日志归档 (每日执行)
4. 缓存刷新 (每5分钟执行)
5. 设备状态检查 (每分钟执行)
6. 告警升级检查 (每10分钟执行)
```

---

## 🛡️ 安全机制详解

### 1. 多层安全防护

#### **认证安全**
- JWT令牌签名验证
- 令牌过期时间控制
- 刷新令牌轮转机制
- 设备绑定验证

#### **数据安全**
- bcrypt密码加密 (12轮加盐)
- 敏感数据脱敏
- SQL注入防护 (Prisma ORM)
- XSS攻击防护

#### **访问控制**
- 多层权限验证
- 工厂数据隔离
- API访问限频
- 操作审计日志

---

## 🎯 系统特色功能

### 1. 多租户架构
- 工厂级数据隔离
- 独立权限体系
- 个性化配置支持
- 跨工厂数据聚合 (平台级用户)

### 2. 智能化特性
- DeepSeek AI分析集成
- 智能告警分级
- 自动化工作流
- 预测性维护建议

### 3. 移动优化
- 离线数据支持
- 文件上传优化
- 网络适配机制
- 设备性能监控

### 4. 企业级特性
- 完整审计追踪
- 高可用性设计
- 性能监控优化
- 数据备份恢复

---

## 📈 性能优化策略

### 1. 数据库优化
- 索引策略优化
- 查询性能调优
- 连接池管理
- 分页查询优化

### 2. 缓存策略
- 仪表板数据缓存
- 权限计算缓存
- 静态资源缓存
- API响应缓存

### 3. 并发处理
- 异步数据处理
- 批量操作优化
- 事务管理
- 锁机制控制

---

## 🔍 监控和运维

### 1. 健康检查
- 服务状态监控
- 数据库连接检查
- 内存使用监控
- 响应时间统计

### 2. 日志管理
- 分级日志记录
- 日志轮转机制
- 错误监控告警
- 性能指标收集

### 3. 故障处理
- 自动重试机制
- 优雅降级策略
- 错误恢复流程
- 故障隔离机制

---

这个白垩纪食品溯源系统后端是一个功能完整、架构先进的企业级应用，涵盖了从用户管理到生产监控的全业务流程，具备投入生产环境使用的完整能力。每个模块都经过精心设计，确保了系统的安全性、可扩展性和高性能。