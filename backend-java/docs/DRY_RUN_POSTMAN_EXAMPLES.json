{
  "info": {
    "name": "规则引擎 Dry-Run API 测试集合",
    "description": "用于测试规则引擎 Dry-Run API 的 Postman 请求集合",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "1. 简单验证规则 - 数量检查",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{access_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/mobile/{{factory_id}}/rules/dry-run",
          "host": ["{{base_url}}"],
          "path": ["api", "mobile", "{{factory_id}}", "rules", "dry-run"]
        },
        "body": {
          "mode": "raw",
          "raw": "{\n  \"ruleContent\": \"package com.cretas.aims.rules;\\n\\nimport java.util.Map;\\nimport java.util.HashMap;\\nimport java.util.List;\\nimport java.util.ArrayList;\\n\\nglobal List results;\\nglobal Map simulatedChanges;\\n\\nrule \\\"Validate Material Batch Quantity\\\"\\n  salience 100\\n  when\\n    $data : Map(this[\\\"quantity\\\"] != null, this[\\\"quantity\\\"] instanceof Number)\\n    eval(((Number) $data.get(\\\"quantity\\\")).doubleValue() <= 0)\\n  then\\n    Map result = new HashMap();\\n    result.put(\\\"result\\\", \\\"DENY\\\");\\n    result.put(\\\"message\\\", \\\"数量必须大于 0\\\");\\n    results.add(result);\\nend\",\n  \"entityType\": \"MATERIAL_BATCH\",\n  \"hookPoint\": \"beforeCreate\",\n  \"testData\": {\n    \"quantity\": -5,\n    \"materialType\": \"面粉\",\n    \"supplierId\": \"S001\"\n  }\n}"
        }
      },
      "response": []
    },
    {
      "name": "2. 自动计算规则 - 保质期计算",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{access_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/mobile/{{factory_id}}/rules/dry-run",
          "host": ["{{base_url}}"],
          "path": ["api", "mobile", "{{factory_id}}", "rules", "dry-run"]
        },
        "body": {
          "mode": "raw",
          "raw": "{\n  \"ruleContent\": \"package com.cretas.aims.rules;\\n\\nimport java.util.Map;\\nimport java.util.HashMap;\\nimport java.util.List;\\nimport java.util.ArrayList;\\nimport java.time.LocalDate;\\n\\nglobal List results;\\nglobal Map simulatedChanges;\\n\\nrule \\\"Calculate Expiry Date\\\"\\n  salience 100\\n  when\\n    $data : Map(this[\\\"productionDate\\\"] != null, this[\\\"shelfLifeDays\\\"] != null)\\n  then\\n    String productionDateStr = (String) $data.get(\\\"productionDate\\\");\\n    Integer shelfLifeDays = ((Number) $data.get(\\\"shelfLifeDays\\\")).intValue();\\n    \\n    LocalDate productionDate = LocalDate.parse(productionDateStr);\\n    LocalDate expiryDate = productionDate.plusDays(shelfLifeDays);\\n    \\n    simulatedChanges.put(\\\"expiryDate\\\", expiryDate.toString());\\n    simulatedChanges.put(\\\"calculationMethod\\\", \\\"productionDate + shelfLifeDays\\\");\\n    \\n    Map result = new HashMap();\\n    result.put(\\\"result\\\", \\\"ALLOW\\\");\\n    result.put(\\\"message\\\", \\\"保质期已自动计算: \\\" + expiryDate);\\n    results.add(result);\\nend\",\n  \"entityType\": \"MATERIAL_BATCH\",\n  \"hookPoint\": \"beforeCreate\",\n  \"testData\": {\n    \"productionDate\": \"2025-01-01\",\n    \"shelfLifeDays\": 30,\n    \"materialType\": \"鸡蛋\"\n  }\n}"
        }
      },
      "response": []
    },
    {
      "name": "3. 多条件验证 - 质检完整性",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{access_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/mobile/{{factory_id}}/rules/dry-run",
          "host": ["{{base_url}}"],
          "path": ["api", "mobile", "{{factory_id}}", "rules", "dry-run"]
        },
        "body": {
          "mode": "raw",
          "raw": "{\n  \"ruleContent\": \"package com.cretas.aims.rules;\\n\\nimport java.util.Map;\\nimport java.util.HashMap;\\nimport java.util.List;\\nimport java.util.ArrayList;\\n\\nglobal List results;\\nglobal Map simulatedChanges;\\n\\nrule \\\"Validate Quality Check Completeness\\\"\\n  salience 100\\n  when\\n    $data : Map()\\n    eval(\\n      $data.get(\\\"sampleSize\\\") == null ||\\n      $data.get(\\\"inspector\\\") == null ||\\n      $data.get(\\\"inspectionDate\\\") == null\\n    )\\n  then\\n    Map result = new HashMap();\\n    result.put(\\\"result\\\", \\\"BLOCK\\\");\\n    result.put(\\\"block\\\", true);\\n    \\n    List missingFields = new ArrayList();\\n    if ($data.get(\\\"sampleSize\\\") == null) missingFields.add(\\\"sampleSize\\\");\\n    if ($data.get(\\\"inspector\\\") == null) missingFields.add(\\\"inspector\\\");\\n    if ($data.get(\\\"inspectionDate\\\") == null) missingFields.add(\\\"inspectionDate\\\");\\n    \\n    result.put(\\\"message\\\", \\\"质检记录不完整，缺少字段: \\\" + missingFields);\\n    result.put(\\\"missingFields\\\", missingFields);\\n    results.add(result);\\nend\",\n  \"entityType\": \"QUALITY_INSPECTION\",\n  \"hookPoint\": \"beforeSubmit\",\n  \"testData\": {\n    \"sampleSize\": 10,\n    \"inspectionDate\": \"2025-01-15\"\n  }\n}"
        }
      },
      "response": []
    },
    {
      "name": "4. 语法错误测试",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{access_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/mobile/{{factory_id}}/rules/dry-run",
          "host": ["{{base_url}}"],
          "path": ["api", "mobile", "{{factory_id}}", "rules", "dry-run"]
        },
        "body": {
          "mode": "raw",
          "raw": "{\n  \"ruleContent\": \"package com.cretas.aims.rules;\\n\\nrule \\\"Invalid Rule\\\"\\n  when\\n    $data : Map(\\n  then\\n    // 语法错误：when 部分未闭合\\nend\",\n  \"entityType\": \"MATERIAL_BATCH\",\n  \"testData\": {}\n}"
        }
      },
      "response": []
    },
    {
      "name": "5. 复杂业务规则 - 价格计算",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{access_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/mobile/{{factory_id}}/rules/dry-run",
          "host": ["{{base_url}}"],
          "path": ["api", "mobile", "{{factory_id}}", "rules", "dry-run"]
        },
        "body": {
          "mode": "raw",
          "raw": "{\n  \"ruleContent\": \"package com.cretas.aims.rules;\\n\\nimport java.util.Map;\\nimport java.util.HashMap;\\nimport java.util.List;\\nimport java.util.ArrayList;\\n\\nglobal List results;\\nglobal Map simulatedChanges;\\n\\nrule \\\"Calculate Batch Cost\\\"\\n  salience 100\\n  when\\n    $data : Map(\\n      this[\\\"quantity\\\"] != null,\\n      this[\\\"unitPrice\\\"] != null\\n    )\\n  then\\n    double quantity = ((Number) $data.get(\\\"quantity\\\")).doubleValue();\\n    double unitPrice = ((Number) $data.get(\\\"unitPrice\\\")).doubleValue();\\n    \\n    double totalCost = quantity * unitPrice;\\n    double tax = totalCost * 0.13; // 13% 增值税\\n    double finalCost = totalCost + tax;\\n    \\n    simulatedChanges.put(\\\"totalCost\\\", totalCost);\\n    simulatedChanges.put(\\\"tax\\\", tax);\\n    simulatedChanges.put(\\\"finalCost\\\", finalCost);\\n    \\n    Map result = new HashMap();\\n    result.put(\\\"result\\\", \\\"ALLOW\\\");\\n    result.put(\\\"message\\\", \\\"批次成本已计算\\\");\\n    result.put(\\\"totalCost\\\", totalCost);\\n    result.put(\\\"tax\\\", tax);\\n    result.put(\\\"finalCost\\\", finalCost);\\n    results.add(result);\\nend\",\n  \"entityType\": \"MATERIAL_BATCH\",\n  \"hookPoint\": \"beforeCreate\",\n  \"testData\": {\n    \"quantity\": 100,\n    \"unitPrice\": 50.0,\n    \"materialType\": \"小麦\"\n  }\n}"
        }
      },
      "response": []
    },
    {
      "name": "6. 多规则测试 - 级联验证",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{access_token}}"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/mobile/{{factory_id}}/rules/dry-run",
          "host": ["{{base_url}}"],
          "path": ["api", "mobile", "{{factory_id}}", "rules", "dry-run"]
        },
        "body": {
          "mode": "raw",
          "raw": "{\n  \"ruleContent\": \"package com.cretas.aims.rules;\\n\\nimport java.util.Map;\\nimport java.util.HashMap;\\nimport java.util.List;\\nimport java.util.ArrayList;\\n\\nglobal List results;\\nglobal Map simulatedChanges;\\n\\nrule \\\"Check Quantity\\\"\\n  salience 200\\n  when\\n    $data : Map(this[\\\"quantity\\\"] != null)\\n    eval(((Number) $data.get(\\\"quantity\\\")).doubleValue() <= 0)\\n  then\\n    Map result = new HashMap();\\n    result.put(\\\"result\\\", \\\"DENY\\\");\\n    result.put(\\\"message\\\", \\\"数量必须大于 0\\\");\\n    results.add(result);\\nend\\n\\nrule \\\"Check Price\\\"\\n  salience 150\\n  when\\n    $data : Map(this[\\\"unitPrice\\\"] != null)\\n    eval(((Number) $data.get(\\\"unitPrice\\\")).doubleValue() <= 0)\\n  then\\n    Map result = new HashMap();\\n    result.put(\\\"result\\\", \\\"DENY\\\");\\n    result.put(\\\"message\\\", \\\"单价必须大于 0\\\");\\n    results.add(result);\\nend\\n\\nrule \\\"All Valid\\\"\\n  salience 50\\n  when\\n    $data : Map(\\n      this[\\\"quantity\\\"] != null,\\n      this[\\\"unitPrice\\\"] != null\\n    )\\n    eval(\\n      ((Number) $data.get(\\\"quantity\\\")).doubleValue() > 0 &&\\n      ((Number) $data.get(\\\"unitPrice\\\")).doubleValue() > 0\\n    )\\n  then\\n    Map result = new HashMap();\\n    result.put(\\\"result\\\", \\\"ALLOW\\\");\\n    result.put(\\\"message\\\", \\\"所有验证通过\\\");\\n    results.add(result);\\nend\",\n  \"entityType\": \"MATERIAL_BATCH\",\n  \"hookPoint\": \"beforeCreate\",\n  \"testData\": {\n    \"quantity\": 100,\n    \"unitPrice\": 50.0\n  }\n}"
        }
      },
      "response": []
    }
  ],
  "variable": [
    {
      "key": "base_url",
      "value": "http://139.196.165.140:10010",
      "type": "string"
    },
    {
      "key": "factory_id",
      "value": "F001",
      "type": "string"
    },
    {
      "key": "access_token",
      "value": "",
      "type": "string"
    }
  ]
}
