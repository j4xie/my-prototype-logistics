package com.cretas.aims.controller;

import com.cretas.aims.entity.MaterialBatch;
import com.cretas.aims.entity.MaterialBatchAdjustment;
import com.cretas.aims.entity.ProductionPlanBatchUsage;
import com.cretas.aims.service.MaterialBatchService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * 原料批次管理控制器
 *
 * 路径: /api/mobile/{factoryId}/material-batches
 *
 * 功能：
 * 1-6: 基础CRUD（列表、创建、批量创建、详情、更新、删除）
 * 7-12: 材料操作（预留、释放、消耗、使用、调整、更新状态）
 * 13-15: 查询筛选（按材料类型、按状态、FIFO）
 * 16-18: 过期管理（即将过期、已过期、处理过期）
 * 19-22: 统计报表（使用历史、低库存、库存统计、库存价值、导出）
 *
 * @author Claude (AI Assistant)
 * @date 2025-11-18
 */
@RestController
@RequestMapping("/api/mobile/{factoryId}/material-batches")
public class MaterialBatchController {

    @Autowired
    private MaterialBatchService batchService;

    // ========== 1-6: 基础CRUD操作 ==========

    /**
     * 1. 获取原料批次列表（分页）
     * GET /api/mobile/{factoryId}/material-batches?page=0&size=10
     */
    @GetMapping
    public ResponseEntity<Map<String, Object>> getMaterialBatches(
            @PathVariable String factoryId,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size,
            @RequestParam(required = false) String status,
            @RequestParam(required = false) String materialTypeId) {

        try {
            Pageable pageable = PageRequest.of(page, size, Sort.by(Sort.Direction.DESC, "createdAt"));
            Page<MaterialBatch> batchPage;

            if (status != null) {
                MaterialBatch.BatchStatus batchStatus = MaterialBatch.BatchStatus.valueOf(status);
                batchPage = batchService.getBatchesByFactory(factoryId, pageable);
                // 前端筛选实现，或在Service添加带状态的分页方法
            } else if (materialTypeId != null) {
                batchPage = batchService.getBatchesByFactory(factoryId, pageable);
                // 前端筛选实现，或在Service添加带材料类型的分页方法
            } else {
                batchPage = batchService.getBatchesByFactory(factoryId, pageable);
            }

            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("code", 200);
            response.put("message", "获取批次列表成功");
            response.put("data", Map.of(
                    "batches", batchPage.getContent(),
                    "total", batchPage.getTotalElements(),
                    "page", batchPage.getNumber(),
                    "size", batchPage.getSize(),
                    "totalPages", batchPage.getTotalPages()
            ));

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of(
                    "success", false,
                    "code", 500,
                    "message", "获取批次列表失败: " + e.getMessage()
            ));
        }
    }

    /**
     * 2. 创建原料批次
     * POST /api/mobile/{factoryId}/material-batches
     */
    @PostMapping
    public ResponseEntity<Map<String, Object>> createBatch(
            @PathVariable String factoryId,
            @RequestBody Map<String, Object> request) {

        try {
            MaterialBatch batch = new MaterialBatch();
            batch.setFactoryId(factoryId);
            batch.setBatchNumber((String) request.get("batchNumber"));
            batch.setMaterialTypeId((String) request.get("materialTypeId"));
            batch.setInboundQuantity(new BigDecimal(request.get("inboundQuantity").toString()));
            batch.setUnitPrice(new BigDecimal(request.get("unitPrice").toString()));
            batch.setInboundDate(LocalDate.parse(request.get("inboundDate").toString()));

            if (request.containsKey("supplierId")) {
                batch.setSupplierId((String) request.get("supplierId"));
            }

            if (request.containsKey("expiryDate")) {
                batch.setExpiryDate(LocalDate.parse(request.get("expiryDate").toString()));
            }

            if (request.containsKey("productionDate")) {
                batch.setProductionDate(LocalDate.parse(request.get("productionDate").toString()));
            }

            if (request.containsKey("qualityGrade")) {
                batch.setQualityGrade((String) request.get("qualityGrade"));
            }

            if (request.containsKey("qualityReport")) {
                batch.setQualityReport(request.get("qualityReport").toString());
            }

            if (request.containsKey("storageLocation")) {
                batch.setStorageLocation((String) request.get("storageLocation"));
            }

            if (request.containsKey("notes")) {
                batch.setNotes((String) request.get("notes"));
            }

            Integer createdBy = (Integer) request.getOrDefault("createdBy", 1);
            MaterialBatch created = batchService.createBatch(batch, createdBy);

            return ResponseEntity.status(HttpStatus.CREATED).body(Map.of(
                    "success", true,
                    "code", 201,
                    "message", "原料批次创建成功",
                    "data", created
            ));

        } catch (Exception e) {
            log.error("创建批次失败", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of(
                    "success", false,
                    "code", 500,
                    "message", "创建批次失败: " + e.getMessage()
            ));
        }
    }

    /**
     * 3. 批量创建原料批次
     * POST /api/mobile/{factoryId}/material-batches/batch
     */
    @PostMapping("/batch")
    public ResponseEntity<Map<String, Object>> batchCreateBatches(
            @PathVariable String factoryId,
            @RequestBody Map<String, Object> request) {

        log.info("API调用: 批量创建原料批次 - factoryId={}", factoryId);

        try {
            @SuppressWarnings("unchecked")
            List<Map<String, Object>> batchDataList = (List<Map<String, Object>>) request.get("batches");
            Integer createdBy = (Integer) request.getOrDefault("createdBy", 1);

            List<MaterialBatch> batches = batchDataList.stream().map(data -> {
                MaterialBatch batch = new MaterialBatch();
                batch.setFactoryId(factoryId);
                batch.setBatchNumber((String) data.get("batchNumber"));
                batch.setMaterialTypeId((String) data.get("materialTypeId"));
                batch.setInboundQuantity(new BigDecimal(data.get("inboundQuantity").toString()));
                batch.setUnitPrice(new BigDecimal(data.get("unitPrice").toString()));
                batch.setInboundDate(LocalDate.parse(data.get("inboundDate").toString()));

                if (data.containsKey("supplierId")) {
                    batch.setSupplierId((String) data.get("supplierId"));
                }

                if (data.containsKey("expiryDate")) {
                    batch.setExpiryDate(LocalDate.parse(data.get("expiryDate").toString()));
                }

                if (data.containsKey("storageLocation")) {
                    batch.setStorageLocation((String) data.get("storageLocation"));
                }

                return batch;
            }).toList();

            List<MaterialBatch> created = batchService.batchCreateBatches(batches, createdBy);

            return ResponseEntity.status(HttpStatus.CREATED).body(Map.of(
                    "success", true,
                    "code", 201,
                    "message", "批量创建成功",
                    "data", Map.of(
                            "created", created,
                            "total", batchDataList.size(),
                            "success", created.size(),
                            "failed", batchDataList.size() - created.size()
                    )
            ));

        } catch (Exception e) {
            log.error("批量创建失败", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of(
                    "success", false,
                    "code", 500,
                    "message", "批量创建失败: " + e.getMessage()
            ));
        }
    }

    /**
     * 4. 获取原料批次详情
     * GET /api/mobile/{factoryId}/material-batches/{batchId}
     */
    @GetMapping("/{batchId}")
    public ResponseEntity<Map<String, Object>> getBatchById(
            @PathVariable String factoryId,
            @PathVariable String batchId) {

        log.info("API调用: 获取批次详情 - factoryId={}, batchId={}", factoryId, batchId);

        try {
            MaterialBatch batch = batchService.getBatchById(batchId);

            // 获取使用历史
            List<ProductionPlanBatchUsage> usageHistory = batchService.getBatchUsageHistory(batchId);

            // 获取调整记录
            List<MaterialBatchAdjustment> adjustments = batchService.getBatchAdjustments(batchId);

            Map<String, Object> data = new HashMap<>();
            data.put("batch", batch);
            data.put("usageHistory", usageHistory);
            data.put("adjustments", adjustments);
            data.put("availableQuantity", batch.getAvailableQuantity());
            data.put("isExpired", batch.isExpired());

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "获取批次详情成功",
                    "data", data
            ));

        } catch (Exception e) {
            log.error("获取批次详情失败", e);
            return ResponseEntity.status(HttpStatus.NOT_FOUND).body(Map.of(
                    "success", false,
                    "code", 404,
                    "message", "获取批次详情失败: " + e.getMessage()
            ));
        }
    }

    /**
     * 5. 更新原料批次
     * PUT /api/mobile/{factoryId}/material-batches/{batchId}
     */
    @PutMapping("/{batchId}")
    public ResponseEntity<Map<String, Object>> updateBatch(
            @PathVariable String factoryId,
            @PathVariable String batchId,
            @RequestBody Map<String, Object> updates) {

        log.info("API调用: 更新批次 - factoryId={}, batchId={}", factoryId, batchId);

        try {
            MaterialBatch updateData = new MaterialBatch();

            if (updates.containsKey("unitPrice")) {
                updateData.setUnitPrice(new BigDecimal(updates.get("unitPrice").toString()));
            }

            if (updates.containsKey("supplierId")) {
                updateData.setSupplierId((String) updates.get("supplierId"));
            }

            if (updates.containsKey("expiryDate")) {
                updateData.setExpiryDate(LocalDate.parse(updates.get("expiryDate").toString()));
            }

            if (updates.containsKey("productionDate")) {
                updateData.setProductionDate(LocalDate.parse(updates.get("productionDate").toString()));
            }

            if (updates.containsKey("qualityGrade")) {
                updateData.setQualityGrade((String) updates.get("qualityGrade"));
            }

            if (updates.containsKey("qualityReport")) {
                updateData.setQualityReport(updates.get("qualityReport").toString());
            }

            if (updates.containsKey("storageLocation")) {
                updateData.setStorageLocation((String) updates.get("storageLocation"));
            }

            if (updates.containsKey("notes")) {
                updateData.setNotes((String) updates.get("notes"));
            }

            MaterialBatch updated = batchService.updateBatch(batchId, updateData);

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "批次更新成功",
                    "data", updated
            ));

        } catch (Exception e) {
            log.error("更新批次失败", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of(
                    "success", false,
                    "code", 500,
                    "message", "更新批次失败: " + e.getMessage()
            ));
        }
    }

    /**
     * 6. 删除原料批次
     * DELETE /api/mobile/{factoryId}/material-batches/{batchId}
     */
    @DeleteMapping("/{batchId}")
    public ResponseEntity<Map<String, Object>> deleteBatch(
            @PathVariable String factoryId,
            @PathVariable String batchId) {

        log.info("API调用: 删除批次 - factoryId={}, batchId={}", factoryId, batchId);

        try {
            batchService.deleteBatch(batchId);

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "批次删除成功"
            ));

        } catch (Exception e) {
            log.error("删除批次失败", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of(
                    "success", false,
                    "code", 500,
                    "message", "删除批次失败: " + e.getMessage()
            ));
        }
    }

    // ========== 7-12: 材料操作 ==========

    /**
     * 7. 预留批次材料（创建生产计划时）
     * POST /api/mobile/{factoryId}/material-batches/{batchId}/reserve?quantity=100&productionPlanId=plan-001
     */
    @PostMapping("/{batchId}/reserve")
    public ResponseEntity<Map<String, Object>> reserveBatch(
            @PathVariable String factoryId,
            @PathVariable String batchId,
            @RequestParam BigDecimal quantity,
            @RequestParam String productionPlanId) {

        log.info("API调用: 预留批次材料 - batchId={}, quantity={}, planId={}",
                batchId, quantity, productionPlanId);

        try {
            batchService.reserveBatch(batchId, quantity, productionPlanId);

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "预留成功",
                    "data", Map.of(
                            "batchId", batchId,
                            "quantity", quantity,
                            "productionPlanId", productionPlanId
                    )
            ));

        } catch (Exception e) {
            log.error("预留失败", e);
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Map.of(
                    "success", false,
                    "code", 400,
                    "message", "预留失败: " + e.getMessage()
            ));
        }
    }

    /**
     * 8. 释放预留材料（取消生产计划时）
     * POST /api/mobile/{factoryId}/material-batches/{batchId}/release?quantity=100&productionPlanId=plan-001
     */
    @PostMapping("/{batchId}/release")
    public ResponseEntity<Map<String, Object>> releaseBatch(
            @PathVariable String factoryId,
            @PathVariable String batchId,
            @RequestParam BigDecimal quantity,
            @RequestParam String productionPlanId) {

        log.info("API调用: 释放预留材料 - batchId={}, quantity={}, planId={}",
                batchId, quantity, productionPlanId);

        try {
            batchService.releaseBatch(batchId, quantity, productionPlanId);

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "释放成功",
                    "data", Map.of(
                            "batchId", batchId,
                            "quantity", quantity,
                            "productionPlanId", productionPlanId
                    )
            ));

        } catch (Exception e) {
            log.error("释放失败", e);
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Map.of(
                    "success", false,
                    "code", 400,
                    "message", "释放失败: " + e.getMessage()
            ));
        }
    }

    /**
     * 9. 消耗批次材料（生产完成时）
     * POST /api/mobile/{factoryId}/material-batches/{batchId}/consume?quantity=100&productionPlanId=plan-001
     */
    @PostMapping("/{batchId}/consume")
    public ResponseEntity<Map<String, Object>> consumeBatch(
            @PathVariable String factoryId,
            @PathVariable String batchId,
            @RequestParam BigDecimal quantity,
            @RequestParam String productionPlanId) {

        log.info("API调用: 消耗批次材料 - batchId={}, quantity={}, planId={}",
                batchId, quantity, productionPlanId);

        try {
            batchService.consumeBatch(batchId, quantity, productionPlanId);

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "消耗成功",
                    "data", Map.of(
                            "batchId", batchId,
                            "quantity", quantity,
                            "productionPlanId", productionPlanId
                    )
            ));

        } catch (Exception e) {
            log.error("消耗失败", e);
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Map.of(
                    "success", false,
                    "code", 400,
                    "message", "消耗失败: " + e.getMessage()
            ));
        }
    }

    /**
     * 10. 直接使用批次材料（不通过预留）
     * POST /api/mobile/{factoryId}/material-batches/{batchId}/use?quantity=100&productionPlanId=plan-001
     */
    @PostMapping("/{batchId}/use")
    public ResponseEntity<Map<String, Object>> useBatch(
            @PathVariable String factoryId,
            @PathVariable String batchId,
            @RequestParam BigDecimal quantity,
            @RequestParam(required = false) String productionPlanId) {

        log.info("API调用: 直接使用批次材料 - batchId={}, quantity={}, planId={}",
                batchId, quantity, productionPlanId);

        try {
            batchService.useBatch(batchId, quantity, productionPlanId);

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "使用成功",
                    "data", Map.of(
                            "batchId", batchId,
                            "quantity", quantity
                    )
            ));

        } catch (Exception e) {
            log.error("使用失败", e);
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Map.of(
                    "success", false,
                    "code", 400,
                    "message", "使用失败: " + e.getMessage()
            ));
        }
    }

    /**
     * 11. 调整批次数量（库存盘点）
     * POST /api/mobile/{factoryId}/material-batches/{batchId}/adjust
     */
    @PostMapping("/{batchId}/adjust")
    public ResponseEntity<Map<String, Object>> adjustBatch(
            @PathVariable String factoryId,
            @PathVariable String batchId,
            @RequestBody Map<String, Object> request) {

        log.info("API调用: 调整批次数量 - batchId={}", batchId);

        try {
            BigDecimal adjustmentQuantity = new BigDecimal(request.get("adjustmentQuantity").toString());
            String adjustmentType = (String) request.getOrDefault("adjustmentType", "inventory_check");
            String reason = (String) request.get("reason");
            Integer adjustedBy = (Integer) request.getOrDefault("adjustedBy", 1);

            MaterialBatch updated = batchService.adjustBatch(
                    batchId, adjustmentQuantity, adjustmentType, reason, adjustedBy);

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "调整成功",
                    "data", updated
            ));

        } catch (Exception e) {
            log.error("调整失败", e);
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Map.of(
                    "success", false,
                    "code", 400,
                    "message", "调整失败: " + e.getMessage()
            ));
        }
    }

    /**
     * 12. 更新批次状态
     * PUT /api/mobile/{factoryId}/material-batches/{batchId}/status
     */
    @PutMapping("/{batchId}/status")
    public ResponseEntity<Map<String, Object>> updateBatchStatus(
            @PathVariable String factoryId,
            @PathVariable String batchId,
            @RequestBody Map<String, Object> request) {

        log.info("API调用: 更新批次状态 - batchId={}", batchId);

        try {
            String statusStr = (String) request.get("status");
            MaterialBatch.BatchStatus newStatus = MaterialBatch.BatchStatus.valueOf(statusStr);

            MaterialBatch updated = batchService.updateBatchStatus(batchId, newStatus);

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "状态更新成功",
                    "data", updated
            ));

        } catch (Exception e) {
            log.error("状态更新失败", e);
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Map.of(
                    "success", false,
                    "code", 400,
                    "message", "状态更新失败: " + e.getMessage()
            ));
        }
    }

    // ========== 13-15: 查询筛选 ==========

    /**
     * 13. 按材料类型获取批次
     * GET /api/mobile/{factoryId}/material-batches/material-type/{materialTypeId}
     */
    @GetMapping("/material-type/{materialTypeId}")
    public ResponseEntity<Map<String, Object>> getBatchesByMaterialType(
            @PathVariable String factoryId,
            @PathVariable String materialTypeId) {

        log.info("API调用: 按材料类型获取批次 - materialTypeId={}", materialTypeId);

        try {
            List<MaterialBatch> batches = batchService.getBatchesByMaterialType(factoryId, materialTypeId);

            // 计算总库存和可用数量
            BigDecimal totalQuantity = batchService.getInventoryQuantityByMaterialType(factoryId, materialTypeId);
            BigDecimal availableQuantity = batchService.getAvailableQuantityByMaterialType(factoryId, materialTypeId);

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "获取成功",
                    "data", Map.of(
                            "batches", batches,
                            "totalQuantity", totalQuantity,
                            "availableQuantity", availableQuantity,
                            "count", batches.size()
                    )
            ));

        } catch (Exception e) {
            log.error("获取失败", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of(
                    "success", false,
                    "code", 500,
                    "message", "获取失败: " + e.getMessage()
            ));
        }
    }

    /**
     * 14. 按状态获取批次
     * GET /api/mobile/{factoryId}/material-batches/status/{status}
     */
    @GetMapping("/status/{status}")
    public ResponseEntity<Map<String, Object>> getBatchesByStatus(
            @PathVariable String factoryId,
            @PathVariable String status) {

        log.info("API调用: 按状态获取批次 - status={}", status);

        try {
            MaterialBatch.BatchStatus batchStatus = MaterialBatch.BatchStatus.valueOf(status);
            List<MaterialBatch> batches = batchService.getBatchesByStatus(factoryId, batchStatus);

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "获取成功",
                    "data", Map.of(
                            "batches", batches,
                            "count", batches.size()
                    )
            ));

        } catch (Exception e) {
            log.error("获取失败", e);
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Map.of(
                    "success", false,
                    "code", 400,
                    "message", "获取失败: " + e.getMessage()
            ));
        }
    }

    /**
     * 15. 获取FIFO批次（先进先出）
     * GET /api/mobile/{factoryId}/material-batches/fifo/{materialTypeId}?quantity=1000
     */
    @GetMapping("/fifo/{materialTypeId}")
    public ResponseEntity<Map<String, Object>> getFifoBatches(
            @PathVariable String factoryId,
            @PathVariable String materialTypeId,
            @RequestParam BigDecimal quantity) {

        log.info("API调用: 获取FIFO批次 - materialTypeId={}, quantity={}", materialTypeId, quantity);

        try {
            List<Map<String, Object>> allocations = batchService.allocateFifoBatches(
                    factoryId, materialTypeId, quantity);

            // 计算总分配数量
            BigDecimal totalAllocated = allocations.stream()
                    .map(a -> (BigDecimal) a.get("quantity"))
                    .reduce(BigDecimal.ZERO, BigDecimal::add);

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "FIFO分配成功",
                    "data", Map.of(
                            "allocations", allocations,
                            "totalAllocated", totalAllocated,
                            "shortfall", quantity.subtract(totalAllocated),
                            "batchCount", allocations.size()
                    )
            ));

        } catch (Exception e) {
            log.error("FIFO分配失败", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of(
                    "success", false,
                    "code", 500,
                    "message", "FIFO分配失败: " + e.getMessage()
            ));
        }
    }

    // ========== 16-18: 过期管理 ==========

    /**
     * 16. 获取即将过期的批次
     * GET /api/mobile/{factoryId}/material-batches/expiring?days=7
     */
    @GetMapping("/expiring")
    public ResponseEntity<Map<String, Object>> getExpiringBatches(
            @PathVariable String factoryId,
            @RequestParam(defaultValue = "7") Integer days) {

        log.info("API调用: 获取即将过期批次 - days={}", days);

        try {
            List<MaterialBatch> batches = batchService.getExpiringBatches(factoryId, days);

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "获取成功",
                    "data", Map.of(
                            "batches", batches,
                            "count", batches.size(),
                            "days", days
                    )
            ));

        } catch (Exception e) {
            log.error("获取失败", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of(
                    "success", false,
                    "code", 500,
                    "message", "获取失败: " + e.getMessage()
            ));
        }
    }

    /**
     * 17. 获取已过期的批次
     * GET /api/mobile/{factoryId}/material-batches/expired
     */
    @GetMapping("/expired")
    public ResponseEntity<Map<String, Object>> getExpiredBatches(
            @PathVariable String factoryId) {

        log.info("API调用: 获取已过期批次");

        try {
            List<MaterialBatch> batches = batchService.getExpiredBatches(factoryId);

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "获取成功",
                    "data", Map.of(
                            "batches", batches,
                            "count", batches.size()
                    )
            ));

        } catch (Exception e) {
            log.error("获取失败", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of(
                    "success", false,
                    "code", 500,
                    "message", "获取失败: " + e.getMessage()
            ));
        }
    }

    /**
     * 18. 处理过期批次
     * POST /api/mobile/{factoryId}/material-batches/handle-expired
     */
    @PostMapping("/handle-expired")
    public ResponseEntity<Map<String, Object>> handleExpiredBatches(
            @PathVariable String factoryId) {

        log.info("API调用: 处理过期批次");

        try {
            int count = batchService.handleExpiredBatches(factoryId);

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "处理完成",
                    "data", Map.of(
                            "processedCount", count
                    )
            ));

        } catch (Exception e) {
            log.error("处理失败", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of(
                    "success", false,
                    "code", 500,
                    "message", "处理失败: " + e.getMessage()
            ));
        }
    }

    // ========== 19-22: 统计报表 ==========

    /**
     * 19. 获取批次使用历史
     * GET /api/mobile/{factoryId}/material-batches/{batchId}/usage-history
     */
    @GetMapping("/{batchId}/usage-history")
    public ResponseEntity<Map<String, Object>> getBatchUsageHistory(
            @PathVariable String factoryId,
            @PathVariable String batchId) {

        log.info("API调用: 获取批次使用历史 - batchId={}", batchId);

        try {
            List<ProductionPlanBatchUsage> usageHistory = batchService.getBatchUsageHistory(batchId);
            List<MaterialBatchAdjustment> adjustments = batchService.getBatchAdjustments(batchId);

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "获取成功",
                    "data", Map.of(
                            "usageHistory", usageHistory,
                            "adjustments", adjustments,
                            "usageCount", usageHistory.size(),
                            "adjustmentCount", adjustments.size()
                    )
            ));

        } catch (Exception e) {
            log.error("获取失败", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of(
                    "success", false,
                    "code", 500,
                    "message", "获取失败: " + e.getMessage()
            ));
        }
    }

    /**
     * 20. 获取低库存批次
     * GET /api/mobile/{factoryId}/material-batches/low-stock?threshold=100
     */
    @GetMapping("/low-stock")
    public ResponseEntity<Map<String, Object>> getLowStockBatches(
            @PathVariable String factoryId,
            @RequestParam(required = false) BigDecimal threshold) {

        log.info("API调用: 获取低库存批次 - threshold={}", threshold);

        try {
            List<MaterialBatch> batches = threshold != null ?
                    batchService.getLowStockBatches(factoryId, threshold) :
                    batchService.getLowStockBatches(factoryId);

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "获取成功",
                    "data", Map.of(
                            "batches", batches,
                            "count", batches.size(),
                            "threshold", threshold != null ? threshold : 100
                    )
            ));

        } catch (Exception e) {
            log.error("获取失败", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of(
                    "success", false,
                    "code", 500,
                    "message", "获取失败: " + e.getMessage()
            ));
        }
    }

    /**
     * 21. 获取库存统计
     * GET /api/mobile/{factoryId}/material-batches/inventory/statistics
     */
    @GetMapping("/inventory/statistics")
    public ResponseEntity<Map<String, Object>> getInventoryStatistics(
            @PathVariable String factoryId) {

        log.info("API调用: 获取库存统计");

        try {
            List<Map<String, Object>> statistics = batchService.getInventoryStatistics(factoryId);

            BigDecimal totalQuantity = batchService.getTotalInventoryQuantity(factoryId);
            BigDecimal totalValue = batchService.getTotalInventoryValue(factoryId);

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "获取成功",
                    "data", Map.of(
                            "byMaterialType", statistics,
                            "totalQuantity", totalQuantity,
                            "totalValue", totalValue
                    )
            ));

        } catch (Exception e) {
            log.error("获取失败", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of(
                    "success", false,
                    "code", 500,
                    "message", "获取失败: " + e.getMessage()
            ));
        }
    }

    /**
     * 22. 获取库存价值
     * GET /api/mobile/{factoryId}/material-batches/inventory/valuation
     */
    @GetMapping("/inventory/valuation")
    public ResponseEntity<Map<String, Object>> getInventoryValuation(
            @PathVariable String factoryId) {

        log.info("API调用: 获取库存价值");

        try {
            Map<String, Object> valuation = batchService.getInventoryValuation(factoryId);

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "获取成功",
                    "data", valuation
            ));

        } catch (Exception e) {
            log.error("获取失败", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of(
                    "success", false,
                    "code", 500,
                    "message", "获取失败: " + e.getMessage()
            ));
        }
    }

    /**
     * 23. 导出库存报表（可选实现）
     * GET /api/mobile/{factoryId}/material-batches/export?format=csv
     */
    @GetMapping("/export")
    public ResponseEntity<Map<String, Object>> exportInventory(
            @PathVariable String factoryId,
            @RequestParam(defaultValue = "csv") String format) {

        log.info("API调用: 导出库存报表 - format={}", format);

        try {
            // TODO: 实现CSV/Excel导出
            // 当前返回JSON数据，前端可自行生成CSV

            List<MaterialBatch> batches = batchService.getBatchesByFactory(
                    factoryId, PageRequest.of(0, 10000)).getContent();

            return ResponseEntity.ok(Map.of(
                    "success", true,
                    "code", 200,
                    "message", "导出数据准备完成",
                    "data", batches
            ));

        } catch (Exception e) {
            log.error("导出失败", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(Map.of(
                    "success", false,
                    "code", 500,
                    "message", "导出失败: " + e.getMessage()
            ));
        }
    }
}
