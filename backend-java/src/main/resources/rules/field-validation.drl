package com.cretas.aims.rules.field;

import com.cretas.aims.dto.intent.FieldUpdateFact;
import com.cretas.aims.dto.intent.ValidationResult;
import java.math.BigDecimal;

global ValidationResult validationResult;

/**
 * 字段级规则 - 数据范围、格式、依赖完整性验证
 *
 * 应用场景：
 * - 在 FormIntentHandler.execute() 字段创建时调用
 * - 在 DataOperationIntentHandler.executeDataOperation() 字段更新时调用
 *
 * @author Cretas Team
 * @version 1.0.0
 * @since 2026-01-06
 */

// ==================== 温度字段规则 ====================

rule "温度值必须在安全范围内"
    salience 100
    when
        $fact: FieldUpdateFact(
            fieldName == "storageTemperature" ||
            fieldName == "temperature" ||
            fieldName == "processingTemperature",
            newValue != null
        )
        eval(isTemperatureOutOfRange($fact.getNewValue()))
    then
        validationResult.addViolation(
            "温度范围错误",
            "储存温度必须在-30°C到30°C之间，当前值: " + $fact.getNewValue(),
            "HIGH"
        );
        validationResult.addRecommendation("请检查温度值是否正确");
        validationResult.setValid(false);
end

rule "温度变化不能超过10度"
    salience 95
    when
        $fact: FieldUpdateFact(
            fieldName == "storageTemperature" || fieldName == "temperature",
            oldValue != null,
            newValue != null
        )
        eval(isTemperatureChangeTooLarge($fact.getOldValue(), $fact.getNewValue()))
    then
        validationResult.addViolation(
            "温度变化过大",
            "温度一次调整不能超过10度，当前: " +
            formatTemperatureChange($fact.getOldValue(), $fact.getNewValue()),
            "MEDIUM"
        );
        validationResult.addRecommendation("请分批调整温度，每次不超过10度");
        validationResult.setValid(false);
end

// ==================== 数量字段规则 ====================

rule "数量必须为正数"
    salience 100
    when
        $fact: FieldUpdateFact(
            fieldName == "quantity" ||
            fieldName == "plannedQuantity" ||
            fieldName == "actualQuantity" ||
            fieldName == "remainingQuantity",
            newValue != null
        )
        eval(isNegativeOrZero($fact.getNewValue()))
    then
        validationResult.addViolation(
            "数量值非法",
            "数量字段必须为正数，当前值: " + $fact.getNewValue(),
            "HIGH"
        );
        validationResult.addRecommendation("请输入大于0的数量");
        validationResult.setValid(false);
end

rule "数量减少不能超过当前库存"
    salience 90
    when
        $fact: FieldUpdateFact(
            fieldName == "remainingQuantity",
            oldValue != null,
            newValue != null,
            entityType == "MATERIAL_BATCH" || entityType == "PRODUCTION_BATCH"
        )
        eval(isQuantityReductionTooLarge($fact.getOldValue(), $fact.getNewValue()))
    then
        validationResult.addViolation(
            "数量减少异常",
            "库存减少量(" + calculateReduction($fact.getOldValue(), $fact.getNewValue()) +
            ")超过当前库存(" + $fact.getOldValue() + ")",
            "HIGH"
        );
        validationResult.addRecommendation("请检查是否有未记录的出库操作");
        validationResult.setValid(false);
end

// ==================== 批次号规则 ====================

rule "批次号不能为空"
    salience 100
    when
        $fact: FieldUpdateFact(
            fieldName == "batchNumber",
            newValue == null || newValue.toString().trim().isEmpty()
        )
    then
        validationResult.addViolation(
            "批次号为空",
            "批次号是必填字段，不能为空",
            "HIGH"
        );
        validationResult.addRecommendation("请提供有效的批次号");
        validationResult.setValid(false);
end

rule "批次号格式必须合法"
    salience 95
    when
        $fact: FieldUpdateFact(
            fieldName == "batchNumber",
            newValue != null
        )
        eval(!matchesBatchNumberPattern($fact.getNewValue().toString()))
    then
        validationResult.addViolation(
            "批次号格式错误",
            "批次号必须符合格式: MB-{工厂ID}-{序号} 或 BATCH-{日期}-{序号}",
            "MEDIUM"
        );
        validationResult.addRecommendation("示例: MB-F001-001 或 BATCH-20260106-001");
        validationResult.setValid(false);
end

// ==================== 状态字段规则 ====================

rule "状态值必须在允许范围内"
    salience 100
    when
        $fact: FieldUpdateFact(
            fieldName == "status",
            newValue != null
        )
        eval(!isValidStatus($fact.getEntityType(), $fact.getNewValue().toString()))
    then
        validationResult.addViolation(
            "状态值非法",
            "实体类型 " + $fact.getEntityType() + " 不支持状态: " + $fact.getNewValue(),
            "HIGH"
        );
        validationResult.addRecommendation("请从允许的状态列表中选择");
        validationResult.setValid(false);
end

// ==================== 日期字段规则 ====================

rule "日期不能早于当前日期（未来日期）"
    salience 90
    when
        $fact: FieldUpdateFact(
            fieldName == "plannedDate" ||
            fieldName == "deliveryDate" ||
            fieldName == "expiryDate",
            newValue != null
        )
        eval(isDateInPast($fact.getNewValue()))
    then
        validationResult.addViolation(
            "日期设置错误",
            "计划日期/交付日期不能早于当前日期",
            "MEDIUM"
        );
        validationResult.addRecommendation("请选择未来的日期");
        validationResult.setValid(false);
end

// ==================== 关联字段依赖规则 ====================

rule "修改产品类型时检查是否有关联批次"
    salience 85
    when
        $fact: FieldUpdateFact(
            entityType == "PRODUCT_TYPE",
            fieldName == "productTypeId" || fieldName == "isActive",
            hasRelatedBatches == true
        )
    then
        validationResult.addViolation(
            "存在关联数据",
            "该产品类型下有关联的生产批次，无法修改核心字段",
            "HIGH"
        );
        validationResult.addRecommendation("请先处理关联的批次记录");
        validationResult.setValid(false);
end

// ==================== 辅助函数 ====================

function boolean isTemperatureOutOfRange(Object value) {
    if (value == null) return false;
    double temp = convertToDouble(value);
    return temp < -30.0 || temp > 30.0;
}

function boolean isTemperatureChangeTooLarge(Object oldValue, Object newValue) {
    if (oldValue == null || newValue == null) return false;
    double oldTemp = convertToDouble(oldValue);
    double newTemp = convertToDouble(newValue);
    return Math.abs(newTemp - oldTemp) > 10.0;
}

function String formatTemperatureChange(Object oldValue, Object newValue) {
    double oldTemp = convertToDouble(oldValue);
    double newTemp = convertToDouble(newValue);
    double change = newTemp - oldTemp;
    return String.format("%.1f°C → %.1f°C (变化%.1f°C)", oldTemp, newTemp, change);
}

function boolean isNegativeOrZero(Object value) {
    if (value == null) return false;
    double num = convertToDouble(value);
    return num <= 0;
}

function boolean isQuantityReductionTooLarge(Object oldValue, Object newValue) {
    if (oldValue == null || newValue == null) return false;
    double oldQty = convertToDouble(oldValue);
    double newQty = convertToDouble(newValue);
    return newQty < oldQty && (oldQty - newQty) > oldQty;
}

function double calculateReduction(Object oldValue, Object newValue) {
    double oldQty = convertToDouble(oldValue);
    double newQty = convertToDouble(newValue);
    return oldQty - newQty;
}

function boolean matchesBatchNumberPattern(String batchNumber) {
    if (batchNumber == null || batchNumber.isEmpty()) return false;
    // MB-F001-001 或 BATCH-20260106-001
    return batchNumber.matches("^(MB|BATCH)-[A-Z0-9]+-\\d+$");
}

function boolean isValidStatus(String entityType, String status) {
    if (entityType == null || status == null) return false;

    switch (entityType) {
        case "MATERIAL_BATCH":
            return status.matches("^(IN_STOCK|IN_USE|CONSUMED|EXPIRED)$");
        case "PRODUCTION_BATCH":
            return status.matches("^(PLANNED|IN_PROGRESS|COMPLETED|CANCELLED)$");
        case "PRODUCTION_PLAN":
            return status.matches("^(DRAFT|APPROVED|IN_PROGRESS|COMPLETED|CANCELLED)$");
        default:
            return true; // 未知类型，不校验
    }
}

function boolean isDateInPast(Object value) {
    // 简化实现：在实际项目中应转换为LocalDate/LocalDateTime比较
    // 这里假设传入的是字符串格式的日期或LocalDate对象
    return false; // 占位实现
}

function double convertToDouble(Object value) {
    if (value instanceof Number) {
        return ((Number) value).doubleValue();
    }
    if (value instanceof String) {
        try {
            return Double.parseDouble((String) value);
        } catch (NumberFormatException e) {
            return 0.0;
        }
    }
    return 0.0;
}
