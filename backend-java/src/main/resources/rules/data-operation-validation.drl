package com.cretas.aims.rules.operation;

import com.cretas.aims.dto.intent.DataOperationFact;
import com.cretas.aims.dto.intent.ValidationResult;
import java.util.List;
import java.util.Map;

global ValidationResult validationResult;

/**
 * 数据操作级规则 - 数据完整性、级联关系、事务边界验证
 *
 * 应用场景：
 * - 在 DataOperationIntentHandler.executeDataOperation() 执行前调用
 * - 在批量操作、跨实体修改时进行完整性检查
 *
 * @author Cretas Team
 * @version 1.0.0
 * @since 2026-01-06
 */

// ==================== 规则1: 级联删除检查 ====================

rule "删除产品类型前检查关联批次"
    salience 100
    when
        $fact: DataOperationFact(
            entityType == "PRODUCT_TYPE",
            operation == "DELETE",
            relatedBatchCount > 0
        )
    then
        validationResult.addViolation(
            "级联依赖冲突",
            "该产品类型下有 " + $fact.getRelatedBatchCount() + " 个关联的生产批次，无法删除",
            "HIGH"
        );
        validationResult.addRecommendation("请先删除或迁移关联的批次记录");
        validationResult.setValid(false);
end

rule "删除原材料类型前检查库存批次"
    salience 100
    when
        $fact: DataOperationFact(
            entityType == "RAW_MATERIAL_TYPE",
            operation == "DELETE",
            relatedMaterialBatchCount > 0
        )
    then
        validationResult.addViolation(
            "级联依赖冲突",
            "该原材料类型下有 " + $fact.getRelatedMaterialBatchCount() + " 个库存批次，无法删除",
            "HIGH"
        );
        validationResult.addRecommendation("请先清空该原材料的所有库存");
        validationResult.setValid(false);
end

rule "删除工序前检查生产计划引用"
    salience 100
    when
        $fact: DataOperationFact(
            entityType == "WORKSTATION",
            operation == "DELETE",
            relatedProductionPlanCount > 0
        )
    then
        validationResult.addViolation(
            "级联依赖冲突",
            "该工序被 " + $fact.getRelatedProductionPlanCount() + " 个生产计划引用，无法删除",
            "HIGH"
        );
        validationResult.addRecommendation("请先修改相关生产计划的工序配置");
        validationResult.setValid(false);
end

// ==================== 规则2: 跨实体一致性 ====================

rule "生产批次与原材料批次工厂必须一致"
    salience 95
    when
        $fact: DataOperationFact(
            entityType == "PRODUCTION_BATCH",
            operation == "CREATE" || operation == "UPDATE",
            targetFactoryId != null,
            materialBatchFactoryId != null,
            targetFactoryId != materialBatchFactoryId
        )
    then
        validationResult.addViolation(
            "跨工厂数据冲突",
            "生产批次与原材料批次必须属于同一工厂",
            "HIGH"
        );
        validationResult.addRecommendation("请选择当前工厂(" + $fact.getTargetFactoryId() + ")的原材料批次");
        validationResult.setValid(false);
end

rule "生产计划的产品类型必须存在"
    salience 95
    when
        $fact: DataOperationFact(
            entityType == "PRODUCTION_PLAN",
            operation == "CREATE" || operation == "UPDATE",
            productTypeExists == false
        )
    then
        validationResult.addViolation(
            "引用实体不存在",
            "指定的产品类型不存在或已被删除",
            "HIGH"
        );
        validationResult.addRecommendation("请检查产品类型ID是否正确");
        validationResult.setValid(false);
end

// ==================== 规则3: 状态转换合法性 ====================

rule "已完成的生产批次不能回退到进行中"
    salience 90
    when
        $fact: DataOperationFact(
            entityType == "PRODUCTION_BATCH",
            operation == "UPDATE",
            currentStatus == "COMPLETED",
            targetStatus == "IN_PROGRESS"
        )
    then
        validationResult.addViolation(
            "状态转换非法",
            "已完成的生产批次不能回退到进行中状态",
            "MEDIUM"
        );
        validationResult.addRecommendation("如需修改，请联系管理员审批");
        validationResult.setValid(false);
end

rule "已取消的生产计划不能重新启动"
    salience 90
    when
        $fact: DataOperationFact(
            entityType == "PRODUCTION_PLAN",
            operation == "UPDATE",
            currentStatus == "CANCELLED",
            targetStatus == "IN_PROGRESS" || targetStatus == "APPROVED"
        )
    then
        validationResult.addViolation(
            "状态转换非法",
            "已取消的生产计划不能重新启动，请创建新计划",
            "MEDIUM"
        );
        validationResult.setValid(false);
end

rule "已消耗的原材料批次不能修改数量"
    salience 90
    when
        $fact: DataOperationFact(
            entityType == "MATERIAL_BATCH",
            operation == "UPDATE",
            currentStatus == "CONSUMED",
            fieldsToUpdate containsKey "quantity"
        )
    then
        validationResult.addViolation(
            "状态冲突",
            "已消耗的原材料批次不能修改数量字段",
            "HIGH"
        );
        validationResult.addRecommendation("请创建调整记录而非直接修改");
        validationResult.setValid(false);
end

// ==================== 规则4: 批量操作数据完整性 ====================

rule "批量更新时字段值类型必须统一"
    salience 85
    when
        $fact: DataOperationFact(
            operation == "BATCH_UPDATE",
            batchSize > 1,
            hasInconsistentFieldTypes == true
        )
    then
        validationResult.addViolation(
            "批量操作数据不一致",
            "批量更新时，相同字段的值类型必须统一",
            "MEDIUM"
        );
        validationResult.addRecommendation("请检查批量数据中的字段类型是否一致");
        validationResult.setValid(false);
end

rule "批量删除时必须确认所有实体无关联"
    salience 85
    when
        $fact: DataOperationFact(
            operation == "BATCH_DELETE",
            hasEntitiesWithRelations == true
        )
    then
        validationResult.addViolation(
            "批量删除包含关联数据",
            "批量删除中有 " + $fact.getEntitiesWithRelationsCount() + " 条记录存在关联，无法删除",
            "HIGH"
        );
        validationResult.addRecommendation("请先解除关联关系，或从批量操作中排除这些记录");
        validationResult.setValid(false);
end

// ==================== 规则5: 事务边界与原子性 ====================

rule "库存扣减与批次创建必须原子执行"
    salience 80
    when
        $fact: DataOperationFact(
            entityType == "PRODUCTION_BATCH",
            operation == "CREATE",
            requiresMaterialConsumption == true,
            isAtomicTransaction == false
        )
    then
        validationResult.addViolation(
            "事务边界错误",
            "生产批次创建必须与原材料扣减在同一事务中执行",
            "HIGH"
        );
        validationResult.addRecommendation("请使用 @Transactional 确保事务完整性");
        validationResult.setValid(false);
end

rule "质检不合格自动触发不良品处理"
    salience 80
    when
        $fact: DataOperationFact(
            entityType == "QUALITY_CHECK_RECORD",
            operation == "UPDATE",
            targetStatus == "REJECTED",
            disposalRecordCreated == false
        )
    then
        validationResult.addViolation(
            "业务流程不完整",
            "质检不合格后必须创建不良品处理记录",
            "MEDIUM"
        );
        validationResult.addRecommendation("请同时创建不良品处理记录");
        validationResult.setValid(false);
end

// ==================== 规则6: 数据归档与历史保护 ====================

rule "已归档的数据不能修改"
    salience 75
    when
        $fact: DataOperationFact(
            isArchived == true,
            operation == "UPDATE" || operation == "DELETE"
        )
    then
        validationResult.addViolation(
            "归档数据保护",
            "已归档的数据不允许修改或删除",
            "HIGH"
        );
        validationResult.addRecommendation("如需修改，请先解除归档状态");
        validationResult.setValid(false);
end

rule "超过保留期的数据才能删除"
    salience 75
    when
        $fact: DataOperationFact(
            operation == "DELETE",
            retentionPeriodDays > 0,
            daysSinceCreation < retentionPeriodDays
        )
    then
        validationResult.addViolation(
            "数据保留期限制",
            "数据需保留 " + $fact.getRetentionPeriodDays() + " 天，当前仅 " +
            $fact.getDaysSinceCreation() + " 天，无法删除",
            "MEDIUM"
        );
        validationResult.addRecommendation("请等待保留期满或联系管理员");
        validationResult.setValid(false);
end

// ==================== 规则7: 允许纯查询和低风险操作 ====================

rule "允许只读查询操作"
    salience 50
    when
        $fact: DataOperationFact(
            operation == "QUERY" || operation == "VIEW" || operation == "EXPORT"
        )
    then
        // 只读操作默认允许
        validationResult.setValid(true);
end

rule "允许新建无关联的实体"
    salience 50
    when
        $fact: DataOperationFact(
            operation == "CREATE",
            hasNoExternalDependencies == true
        )
    then
        // 新建无依赖实体，低风险
        validationResult.setValid(true);
end

// ==================== 辅助函数 ====================

function boolean containsKey(Map<String, Object> map, String key) {
    return map != null && map.containsKey(key);
}
