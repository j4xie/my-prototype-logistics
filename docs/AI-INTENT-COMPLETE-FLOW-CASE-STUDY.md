# AI 意图识别系统 - 完整流程案例研究

## 概述

本文档通过一个真实案例，完整展示从用户输入到意图识别、多轮对话、自动学习的全流程。

---

## 🎯 案例场景

**用户输入**: `"我想看看仓库情况"` (模糊、低置信度输入)

**预期流程**:
1. 多层匹配失败 → LLM Fallback
2. LLM 生成澄清问题
3. 用户选择/回答 → 意图确定
4. 执行意图 → 返回数据
5. 自动学习 → 下次直接匹配

---

## 📊 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         用户输入: "我想看看仓库情况"                      │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        Layer 1: 精确匹配 (O(1))                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  HashMap<SHA256(input), IntentCode>                              │   │
│  │  已学习表达式: "我想查一下东西" → MATERIAL_BATCH_QUERY            │   │
│  │  结果: ❌ 未命中 (首次输入)                                       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        Layer 2: 正则匹配 (Pattern)                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Pattern: "^(查询|查看).*库存$"                                   │   │
│  │  结果: ❌ 未命中 ("我想看看仓库情况" 不匹配任何正则)              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        Layer 3: 关键词匹配 (加权评分)                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  输入分词: ["我", "想", "看看", "仓库", "情况"]                   │   │
│  │  关键词库: MATERIAL_BATCH_QUERY = ["原料", "库存", "材料", ...]   │   │
│  │  匹配结果: 无完全匹配关键词                                        │   │
│  │  关键词得分: 0                                                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    Layer 4: 语义匹配 (Embedding + Cosine)                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  模型: GTE-base-zh (768维向量)                                    │   │
│  │                                                                   │   │
│  │  1. 输入向量化:                                                   │   │
│  │     input_vec = embed("我想看看仓库情况") → [0.12, -0.34, ...]   │   │
│  │                                                                   │   │
│  │  2. 与所有意图描述计算余弦相似度:                                 │   │
│  │     MATERIAL_BATCH_QUERY: cosine(input, "查询原材料批次") = 0.72 │   │
│  │     PRODUCTION_QUERY:     cosine(input, "查询生产信息") = 0.68    │   │
│  │     EQUIPMENT_STATUS:     cosine(input, "查询设备状态") = 0.61    │   │
│  │                                                                   │   │
│  │  3. 融合评分 (Fusion):                                            │   │
│  │     confidence = 0.6 × semantic + 0.4 × keyword                   │   │
│  │               = 0.6 × 0.72 + 0.4 × 0 = 0.432                     │   │
│  │                                                                   │   │
│  │  结果: ⚠️ 置信度 0.432 < 阈值 0.6 → 不确定                       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    Layer 5: LLM Fallback (DashScope qwen-plus)           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  触发条件: confidence < 0.3 OR 多个意图置信度接近                 │   │
│  │                                                                   │   │
│  │  ┌─────────────────────────────────────────────────────────┐     │   │
│  │  │                    LLM Prompt                            │     │   │
│  │  │  System: 你是一个意图识别专家，用户输入模糊，需要生成    │     │   │
│  │  │          澄清问题帮助确定用户真实意图。                   │     │   │
│  │  │                                                          │     │   │
│  │  │  可选意图:                                               │     │   │
│  │  │  - MATERIAL_BATCH_QUERY: 查询原材料批次                  │     │   │
│  │  │  - PRODUCTION_QUERY: 查询生产信息                        │     │   │
│  │  │  - EQUIPMENT_STATUS: 查询设备状态                        │     │   │
│  │  │  ...                                                     │     │   │
│  │  │                                                          │     │   │
│  │  │  User: "我想看看仓库情况"                                │     │   │
│  │  └─────────────────────────────────────────────────────────┘     │   │
│  │                                                                   │   │
│  │  LLM Response:                                                    │   │
│  │  {                                                                │   │
│  │    "clarificationQuestion": "请问您想查看哪方面的仓库信息？",    │   │
│  │    "options": [                                                   │   │
│  │      {"label": "原材料库存", "value": "MATERIAL_BATCH_QUERY"},   │   │
│  │      {"label": "成品库存", "value": "PRODUCT_INVENTORY"},        │   │
│  │      {"label": "设备状态", "value": "EQUIPMENT_STATUS"},         │   │
│  │      {"label": "生产进度", "value": "PRODUCTION_QUERY"},         │   │
│  │      {"label": "其他", "value": "OTHER"}                         │   │
│  │    ]                                                              │   │
│  │  }                                                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       返回前端: NEED_CLARIFICATION                       │
│  {                                                                      │
│    "status": "NEED_CLARIFICATION",                                     │
│    "sessionId": "c6cd2b99-96f6-472c-98b6-339ab2e87d3e",               │
│    "clarificationQuestion": "请问您想查看哪方面的仓库信息？",          │
│    "options": [...],                                                    │
│    "metadata": { "currentRound": 1, "maxRounds": 5 }                   │
│  }                                                                      │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 多轮对话流程

### Round 1: 用户选择 "原材料库存"

```
┌─────────────────────────────────────────────────────────────────────────┐
│  用户回复: "查询原材料库存"                                             │
│  SessionId: c6cd2b99-96f6-472c-98b6-339ab2e87d3e                       │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       会话上下文加载                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ConversationService.continueConversation(sessionId, input)      │   │
│  │  - 加载历史: ["我想看看仓库情况"]                                 │   │
│  │  - 当前轮次: 2/5                                                  │   │
│  │  - 待确定意图: [MATERIAL_BATCH_QUERY, PRODUCTION_QUERY, ...]     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       意图匹配 (带上下文)                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  输入: "查询原材料库存"                                          │   │
│  │  关键词命中: ["查询", "原材料", "库存"] → MATERIAL_BATCH_QUERY   │   │
│  │  置信度: 0.95 (高于阈值)                                         │   │
│  │  意图确定: ✅ MATERIAL_BATCH_QUERY                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       参数检查                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  意图: MATERIAL_BATCH_QUERY                                      │   │
│  │  必需参数: [materialTypeId, batchNumber] (可选)                  │   │
│  │  已提供参数: 无                                                   │   │
│  │  结果: NEED_MORE_INFO (需要补充查询条件)                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  返回前端: NEED_MORE_INFO                                               │
│  {                                                                      │
│    "status": "NEED_MORE_INFO",                                         │
│    "intentRecognized": true,                                           │
│    "intentCode": "MATERIAL_BATCH_QUERY",                               │
│    "message": "请提供查询条件：材料类型、批次号等",                     │
│    "sessionId": "c6cd2b99-96f6-472c-98b6-339ab2e87d3e"                 │
│  }                                                                      │
└─────────────────────────────────────────────────────────────────────────┘
```

### Round 2: 用户提供参数

```
┌─────────────────────────────────────────────────────────────────────────┐
│  用户回复: "查看全部库存"                                               │
│  SessionId: c6cd2b99-96f6-472c-98b6-339ab2e87d3e                       │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       执行意图                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  IntentExecutor.execute(MATERIAL_BATCH_QUERY, {all: true})       │   │
│  │                                                                   │   │
│  │  1. 调用 MaterialBatchService.queryAll(factoryId)                │   │
│  │  2. 返回数据:                                                     │   │
│  │     [                                                             │   │
│  │       { batchNumber: "MB-001", quantity: 500, unit: "kg" },      │   │
│  │       { batchNumber: "MB-002", quantity: 300, unit: "kg" },      │   │
│  │       ...                                                         │   │
│  │     ]                                                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       会话完成 & 触发学习                                │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ExpressionLearningService.learnFromConversation(session)        │   │
│  │                                                                   │   │
│  │  学习内容:                                                        │   │
│  │  - 原始输入: "我想看看仓库情况"                                   │   │
│  │  - 确定意图: MATERIAL_BATCH_QUERY                                │   │
│  │  - 置信度: 0.95                                                   │   │
│  │                                                                   │   │
│  │  保存到 intent_learned_expressions 表:                           │   │
│  │  ┌─────────────────────────────────────────────────────────┐     │   │
│  │  │ id | intent_code          | expression         | hash   │     │   │
│  │  │ 1  | MATERIAL_BATCH_QUERY | 我想看看仓库情况   | a3f2.. │     │   │
│  │  └─────────────────────────────────────────────────────────┘     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  返回前端: COMPLETED                                                    │
│  {                                                                      │
│    "status": "COMPLETED",                                              │
│    "data": { "content": [...], "totalElements": 15 },                  │
│    "message": "查询成功，共找到15条原材料批次记录"                      │
│  }                                                                      │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📚 学习效果验证

### 学习前 vs 学习后

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           学习前 (首次输入)                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  输入: "我想看看仓库情况"                                        │   │
│  │  匹配路径: Layer1(❌) → Layer2(❌) → Layer3(❌) → Layer4(⚠️)     │   │
│  │           → Layer5(LLM) → NEED_CLARIFICATION                     │   │
│  │  耗时: ~2000ms (含LLM调用)                                       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘

                              学习完成后
                                  ▼

┌─────────────────────────────────────────────────────────────────────────┐
│                           学习后 (相同输入)                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  输入: "我想看看仓库情况"                                        │   │
│  │  匹配路径: Layer1(✅) → MATERIAL_BATCH_QUERY                     │   │
│  │  耗时: ~5ms (HashMap O(1) 查找)                                  │   │
│  │                                                                   │   │
│  │  匹配过程:                                                        │   │
│  │  1. hash = SHA256("我想看看仓库情况") = "a3f2..."                │   │
│  │  2. expressionMap.get("a3f2...") = "MATERIAL_BATCH_QUERY"       │   │
│  │  3. 直接返回意图，跳过所有后续层                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 🛠️ LangChain 风格 Tool Calling

### 数据操作意图示例

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    用户输入: "帮我创建一个新的原料批次"                  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       意图识别: MATERIAL_BATCH_CREATE                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  Handler: MaterialBatchCreateHandler                             │   │
│  │  Tool Definition (LangChain 风格):                               │   │
│  │  {                                                                │   │
│  │    "name": "create_material_batch",                              │   │
│  │    "description": "创建新的原材料批次记录",                       │   │
│  │    "parameters": {                                                │   │
│  │      "type": "object",                                           │   │
│  │      "properties": {                                             │   │
│  │        "materialTypeId": {"type": "string", "required": true},   │   │
│  │        "batchNumber": {"type": "string", "required": true},      │   │
│  │        "quantity": {"type": "number", "required": true},         │   │
│  │        "unit": {"type": "string", "default": "kg"},              │   │
│  │        "supplierName": {"type": "string"}                        │   │
│  │      }                                                           │   │
│  │    }                                                              │   │
│  │  }                                                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       LLM Tool Calling (带参数提取)                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  用户输入: "创建500公斤的带鱼原料，批次号MB-2024-001"            │   │
│  │                                                                   │   │
│  │  LLM 参数提取:                                                    │   │
│  │  {                                                                │   │
│  │    "tool": "create_material_batch",                              │   │
│  │    "arguments": {                                                 │   │
│  │      "materialTypeId": "RMT-F001-001",  // 带鱼                  │   │
│  │      "batchNumber": "MB-2024-001",                               │   │
│  │      "quantity": 500,                                            │   │
│  │      "unit": "kg"                                                │   │
│  │    }                                                              │   │
│  │  }                                                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       Tool 执行                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  MaterialBatchService.createBatch(factoryId, dto)                │   │
│  │                                                                   │   │
│  │  执行结果:                                                        │   │
│  │  {                                                                │   │
│  │    "id": "uuid-xxx",                                             │   │
│  │    "batchNumber": "MB-2024-001",                                 │   │
│  │    "materialType": "带鱼",                                       │   │
│  │    "quantity": 500,                                              │   │
│  │    "unit": "kg",                                                 │   │
│  │    "status": "PENDING",                                          │   │
│  │    "createdAt": "2026-01-06T22:30:00"                           │   │
│  │  }                                                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 🏭 平台晋升机制

### 从工厂级到平台级意图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         意图晋升流程                                     │
│                                                                         │
│  ┌───────────────┐                                                      │
│  │   工厂 F001   │                                                      │
│  │  意图: X      │──┐                                                   │
│  │  调用: 1000次 │  │                                                   │
│  │  成功率: 95%  │  │                                                   │
│  └───────────────┘  │                                                   │
│                     │                                                    │
│  ┌───────────────┐  │     ┌─────────────────────────────────────┐      │
│  │   工厂 F002   │  │────▶│        平台级意图晋升评估            │      │
│  │  意图: X      │  │     │                                     │      │
│  │  调用: 800次  │  │     │  条件:                              │      │
│  │  成功率: 92%  │  │     │  1. 多个工厂使用相似意图 (≥3)       │      │
│  └───────────────┘  │     │  2. 总调用次数 > 1000               │      │
│                     │     │  3. 平均成功率 > 90%                │      │
│  ┌───────────────┐  │     │  4. 关键词重叠度 > 70%              │      │
│  │   工厂 F003   │  │     │                                     │      │
│  │  意图: X      │──┘     │  评估结果: ✅ 符合晋升条件          │      │
│  │  调用: 600次  │        └─────────────────────────────────────┘      │
│  │  成功率: 94%  │                         │                            │
│  └───────────────┘                         ▼                            │
│                                                                         │
│                          ┌─────────────────────────────────────┐        │
│                          │         平台级意图库                 │        │
│                          │                                     │        │
│                          │  新增意图:                          │        │
│                          │  - code: PLATFORM_INTENT_X          │        │
│                          │  - keywords: [合并后的关键词]        │        │
│                          │  - handler: PlatformHandler         │        │
│                          │  - factories: [F001, F002, F003]    │        │
│                          └─────────────────────────────────────┘        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 📈 服务器日志示例

### 完整请求处理日志

```log
2026-01-06 22:30:45 - [Thread-1] DEBUG IntentMatcherService -
=== 意图匹配开始 ===
工厂: F001
输入: "我想看看仓库情况"

2026-01-06 22:30:45 - [Thread-1] DEBUG ExpressionLookupService -
精确匹配: hash=a3f2b1c4..., 结果=未命中

2026-01-06 22:30:45 - [Thread-1] DEBUG RegexMatcherService -
正则匹配: 检查 15 个模式, 结果=未命中

2026-01-06 22:30:45 - [Thread-1] DEBUG KeywordMatcherService -
关键词匹配: 分词=["我","想","看看","仓库","情况"], 命中=0

2026-01-06 22:30:46 - [Thread-1] DEBUG SemanticMatcherService -
语义匹配开始: 加载 94 个意图向量

2026-01-06 22:30:46 - [Thread-1] DEBUG EmbeddingService -
Embedding cache MISS for: '我想看看仓库情况'
生成向量: dim=768, time=45ms

2026-01-06 22:30:46 - [Thread-1] DEBUG SemanticMatcherService -
语义匹配结果:
  MATERIAL_BATCH_QUERY: 0.72
  PRODUCTION_QUERY: 0.68
  EQUIPMENT_STATUS: 0.61

2026-01-06 22:30:46 - [Thread-1] DEBUG FusionScoringService -
融合评分:
  MATERIAL_BATCH_QUERY: keyword=0, semantic=0.72, fusion=0.432

2026-01-06 22:30:46 - [Thread-1] INFO LlmFallbackService -
触发 LLM Fallback: 最高置信度 0.432 < 阈值 0.6

2026-01-06 22:30:47 - [Thread-1] DEBUG DashScopeClient -
LLM Request:
  model: qwen-plus
  temperature: 0.3
  max_tokens: 500

2026-01-06 22:30:48 - [Thread-1] DEBUG DashScopeClient -
LLM Response (1.2s):
  clarificationQuestion: "请问您想查看哪方面的仓库信息？"
  options: [5个选项]

2026-01-06 22:30:48 - [Thread-1] INFO ConversationService -
多轮对话已启动: sessionId=c6cd2b99-96f6-472c-98b6-339ab2e87d3e
当前轮次: 1/5
待确定意图: 5个

2026-01-06 22:30:48 - [Thread-1] INFO IntentMatcherService -
=== 意图匹配完成 ===
状态: NEED_CLARIFICATION
耗时: 3.2s
```

---

## 🔧 配置参考

### application.properties 关键配置

```properties
# 会话超时 (分钟)
cretas.ai.conversation.timeout-minutes=5

# LLM Fallback 置信度阈值
cretas.ai.intent.llm-fallback.confidence-threshold=0.3

# 语义匹配阈值
cretas.ai.intent.semantic.high-threshold=0.85
cretas.ai.intent.semantic.medium-threshold=0.72
cretas.ai.intent.semantic.low-threshold=0.60

# 融合评分权重
cretas.ai.intent.semantic.fusion-semantic-weight=0.6
cretas.ai.intent.semantic.fusion-keyword-weight=0.4

# 自动学习
cretas.ai.intent.auto-learn.enabled=true
cretas.ai.intent.auto-learn.confidence-threshold=0.85
```

---

## 📝 总结

| 阶段 | 技术 | 耗时 |
|------|------|------|
| 精确匹配 | HashMap O(1) | <1ms |
| 正则匹配 | Pattern | ~5ms |
| 关键词匹配 | 分词+加权 | ~10ms |
| 语义匹配 | GTE-base-zh | ~50ms |
| LLM Fallback | DashScope | ~1500ms |
| 学习后匹配 | HashMap | <1ms |

**核心价值**: 通过多层匹配 + 自动学习，系统能够从模糊输入逐步学习，最终实现毫秒级响应。

---

*文档生成时间: 2026-01-06*
