# 白垩纪食品溯源系统 - 完整业务流程与界面设计 v5.0

> **版本**: v5.0 (业务流程完整版)
> **生成日期**: 2025-11-21
> **更新说明**: 基于BUSINESS_LOGIC_OVERVIEW.md梳理，补充业务流程、界面设计、权限路由等详细内容

---

## 📋 目录

1. [产品概述](#第1章-产品概述)
2. [系统架构](#第2章-系统架构总览)
3. [核心业务流程](#第3章-核心业务流程)
4. [数据模型与关系](#第4章-数据模型与关系)
5. [权限管理体系](#第5章-权限管理体系)
6. [核心页面设计](#第6章-核心页面界面设计)
7. [API规范](#第7章-api规范与集成)
8. [实现状态](#第8章-实现状态总览)

---

## 第1章 产品概述

### 1.1 产品定位

白垩纪食品溯源系统是一个**AI驱动的智能生产管理系统**，专为中小食品企业设计。核心价值是通过**移动优先的设计** + **DeepSeek AI智能分析** + **全链路数据追溯**，帮助工厂实现**降本增效**和**溯源透明**。

### 1.2 核心特色

#### 🤖 AI替代数据分析师
- **DeepSeek大语言模型** 集成
- **5维深度成本分析**：原料、人工、设备、效率、预测
- **智能优化建议**：直接给出降本方案
- **年省成本**：12-36万（替代分析师）

#### 📱 极简移动端设计
- **小学学历也能用** - 大按钮、图标化、少文字
- **随时随地操作** - 打卡、记录、拍照、扫码
- **10分钟上手** - 培训成本接近零

#### 💰 低成本SaaS模式
- **快速上线**：1-2周（vs传统系统6-12个月）
- **按需付费**：月/年订阅制
- **降低90%初始投入**：无需硬件、定制开发

#### 🔍 全链路数据追溯
- **从原料到成品** 的完整溯源链条
- **秒级追溯**：输入批次号 → 完整信息
- **可视化链路图** - 涉及人员、设备、工序、质检

### 1.3 目标用户

| 用户 | 定位 | 核心任务 |
|------|------|---------|
| **平台管理员** | 平台运营（2-5人） | 管理所有工厂、配置系统 |
| **工厂超级管理员** | 厂长（每厂1-2人） | 生产计划、成本控制 |
| **部门管理员** | 部门主管（每厂3-5人） | 部门生产、员工管理 |
| **一线操作员** | 员工（每厂10-50人） | 打卡、拍照、记录、质检 |

---

## 第2章 系统架构总览

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                   React Native App (Expo 53+)               │
│         Android / iOS (移动优先，跨平台)                    │
└────────────────────────┬────────────────────────────────────┘
                         │
                    HTTPS (10010)
                         │
┌────────────────────────▼────────────────────────────────────┐
│               Spring Boot API Gateway (10010)               │
│         Java 11 + Spring Boot 2.7.15 + Spring Security      │
│                     JWT 认证中间件                          │
└────────────────────────┬────────────────────────────────────┘
                         │
        ┌────────────────┼────────────────┐
        ▼                ▼                ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│   业务层     │  │   AI服务     │  │  文件服务    │
│ (Service)   │  │ (DeepSeek)   │  │  (图片处理)  │
└──────┬───────┘  └──────┬───────┘  └──────┬───────┘
       │                 │                  │
       ▼                 ▼                  ▼
┌──────────────────────────────────────────────────┐
│              MySQL 数据库 (43个实体表)           │
│       Spring Data JPA + Hibernate ORM           │
└──────────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────┐
│              Redis 缓存 (Token + AI)              │
│          Token存储、AI分析缓存 (5分钟TTL)        │
└──────────────────────────────────────────────────┘
```

### 2.2 技术栈

| 层级 | 前端 (React Native) | 后端 (Spring Boot) | 数据层 |
|------|---------------------|-------------------|--------|
| **框架** | Expo 53+ | Spring Boot 2.7.15 | MySQL 8+ |
| **语言** | TypeScript | Java 11 | SQL |
| **路由** | React Navigation 7+ | Spring MVC | Spring Data JPA |
| **状态管理** | Zustand | Spring Session | Hibernate ORM |
| **认证** | JWT (本地存储) | Spring Security + JWT | Redis |
| **网络请求** | Axios | RestController | - |
| **UI组件** | React Native Paper | - | - |
| **AI集成** | 调用后端API | DeepSeek API | - |
| **表格处理** | - | Apache POI | - |

### 2.3 系统部署架构

```
用户（工厂/平台）
    │
    ▼
Expo应用 (Android APK / iOS IPA)
    │ (HTTPS 139.196.165.140:10010)
    ▼
宝塔面板 (BT-Panel) - 服务器管理
    │
    ├─ Spring Boot JAR (10010)
    │  └─ /www/wwwroot/cretas/cretas-backend-system-1.0.0.jar
    │
    ├─ MySQL 数据库 (3306)
    │  └─ cretas_db
    │
    └─ Redis 缓存
       └─ 本地或云服务
```

---

## 第3章 核心业务流程

### 3.1 统一登录与权限路由流程

#### 序列图

```
用户                    App                  API              DB
 │                      │                    │               │
 ├─输入用户名密码────────>│                    │               │
 │                      ├─POST /unified-login─>               │
 │                      │                    ├─查询User/PlatformAdmin
 │                      │                    │               <─
 │                      │                    ├─BCrypt验证密码
 │                      │                    │
 │                      │<─生成JWT Token────┤
 │                      │                    │
 │<─显示登录成功────────┤                    │
 │                      ├─存储Token到SecureStore
 │                      ├─更新authStore (Zustand)
 │                      │
 │                      ├─根据userType跳转
 │                      │  platform_admin → PlatformDashboard
 │                      │  factory_user → HomeScreen
 │
```

#### Token管理策略

```
AccessToken (24小时)
  ├─ 存储位置：SecureStore (硬件加密)
  └─ 使用场景：所有API请求

RefreshToken (7天)
  ├─ 存储位置：SecureStore
  └─ 使用场景：accessToken过期时刷新

TempToken (10分钟)
  ├─ 存储位置：内存
  └─ 使用场景：注册流程中临时身份验证

DeviceToken (设备标识)
  ├─ 存储位置：数据库
  └─ 使用场景：设备绑定、激活
```

#### 权限验证流程

```
API请求
  │
  ▼
Spring Security 过滤器链
  │
  ├─ 是否需要认证？
  │  ├─ 否 → /auth/login 等公开端点 → 直接执行
  │  └─ 是 → 提取Token
  │
  ├─ JWT Token 有效？
  │  ├─ 否 → 401 Unauthorized
  │  └─ 是 → 解析Token获取用户信息
  │
  ├─ @PreAuthorize 权限检查
  │  ├─ 否 → 403 Forbidden
  │  └─ 是 → 执行业务逻辑
  │
  ▼
Controller → Service → Repository → DB
```

---

### 3.2 员工打卡与工时计算流程

#### 打卡状态机

```
      未打卡
        │
        ├─[上班打卡]──▶ 已上班
        │              │
        │              ├─[开始休息]──▶ 休息中
        │              │               │
        │              │               └─[结束休息]──▶ 已上班
        │              │
        │              └─[下班打卡]──▶ 已下班
        │                              │
        │                              └─[系统计算]──▶ 已结算
        │
        └─[再次上班]────▶ 已上班 (加班)
```

#### 打卡数据流

```
用户点击"上班打卡"
  │
  ├─1. 获取GPS位置
  │     └─ 验证是否在工厂范围内（500米）
  │
  ├─2. 生物识别验证（可选）
  │     └─ 指纹/Face ID
  │
  ├─3. 拍摄打卡照片（可选）
  │
  ├─4. 提交打卡信息
  │     POST /api/mobile/{factoryId}/timeclock/clock-in
  │     {
  │       userId: 123,
  │       location: {lat, lon},
  │       distance: 45, // 距离工厂多少米
  │       photoUrl: "s3://...",
  │       timestamp: 2025-11-21 08:30:00
  │     }
  │
  └─ API返回成功，显示"打卡成功"
```

#### 工时计算公式

```
工作时长 = 下班时间 - 上班时间 - 午休时间(1小时)

例如：
  上班：08:30
  休息：12:00-13:00 (1小时)
  下班：17:30

  工作时长 = 17:30 - 08:30 - 1:00 = 8小时

加班计算：
  if (工作时长 > 8小时) {
    加班时长 = 工作时长 - 8小时
  }

周工时 = 本周所有日工时之和
月工时 = 本月所有日工时之和
```

#### 工时统计维度

```
┌─────────────────────────────────────┐
│         工时统计与分析              │
├─────────────────────────────────────┤
│                                     │
│  日统计：                          │
│  ├─ 总工时 (工作分钟)              │
│  ├─ 加班时长                       │
│  └─ 迟到/早退标记                   │
│                                     │
│  周统计：                          │
│  ├─ 周总工时                       │
│  ├─ 平均每人工时                   │
│  └─ 加班人数排行                    │
│                                     │
│  月统计：                          │
│  ├─ 月总工时                       │
│  ├─ 月加班工时                     │
│  └─ 工时成本                       │
│                                     │
└─────────────────────────────────────┘
```

---

### 3.3 生产批次全生命周期流程

#### 批次状态流转

```
创建批次 (planning)
  │
  ├─ 系统自动：
  │  ├─ 检查原料库存 (FIFO推荐)
  │  ├─ 预估产出量 (转换率)
  │  └─ 预估成本 (历史数据)
  │
  ├─[开始生产]
  │  │
  │  ▼
  │ 进行中 (in_progress)
  │  │
  │  ├─ 每日添加产量记录
  │  │  ├─ 当日产量
  │  │  ├─ 消耗原料
  │  │  ├─ 设备运行状态
  │  │  └─ 员工工时
  │  │
  │  ├─ 持续7-30天（取决于产品）
  │  │
  │  ├─[完成生产]
  │  │  │
  │  │  ▼
  │  │ 质检中 (quality_check)
  │  │  │
  │  │  ├─ 质检员提交质检结果
  │  │  │  ├─ 新鲜度评分
  │  │  │  ├─ 外观评分
  │  │  │  ├─ 气味评分
  │  │  │  └─ 综合评分
  │  │  │
  │  │  ├─[质检通过]
  │  │  │  │
  │  │  │  ▼
  │  │  │ 已完成 (completed)
  │  │  │  │
  │  │  │  └─ 系统自动：
  │  │  │     ├─ 计算最终成本
  │  │  │     ├─ 更新库存
  │  │  │     ├─ 生成成本报告
  │  │  │     └─ 可触发AI分析
  │  │  │
  │  │  └─[质检不合格]
  │  │     │
  │  │     ▼
  │  │    失败 (failed)
  │  │
  │  └─[暂停生产]
  │     │
  │     ▼
  │    暂停 (paused)
  │
  └─[取消生产]
     │
     ▼
    已取消 (cancelled)
```

#### 成本自动计算

```
batch完成时自动执行：

1️⃣ 原材料成本
   materialCost = Σ(消耗数量 × 单价)

   例：
   ├─ 猪肉 2000g × ¥80/kg = ¥160
   ├─ 冰袋 100g × ¥2/g = ¥200
   └─ 包装 150件 × ¥5/件 = ¥750
   → materialCost = ¥1,110

2️⃣ 人工成本
   laborCost = Σ(员工工时 × 时薪)

   时薪 = 月薪 / 工作时数 × 60

   例：员工月薪 ¥6,000，预期月工时 160小时
   时薪 = 6000 / 160 × 60 = ¥225/小时

   工作12小时 → 人工成本 = 12 × 225 = ¥2,700

3️⃣ 设备成本
   equipmentCost = Σ(使用时长 × 折旧率)

   折旧率 = 采购价格 / (使用年限 × 365 × 24)

   例：冷柜 ¥50,000，使用10年
   折旧率 = 50000 / (10 × 365 × 24) = ¥0.57/小时

   使用48小时 → 设备成本 = 48 × 0.57 = ¥27.4

4️⃣ 总成本
   totalCost = materialCost + laborCost + equipmentCost
   unitCost = totalCost / 实际产量
```

---

### 3.4 FIFO原材料管理流程

#### FIFO算法

```
场景：需要2000g 猪肉，当前库存：

批次1: 2000g, 入库2025-10-01, 到期2025-10-08 (新鲜)
批次2: 1500g, 入库2025-10-03, 到期2025-10-10 (新鲜)
批次3: 3000g, 入库2025-10-05, 到期2026-01-05 (冷冻)

FIFO推荐过程：
  1. 按入库时间排序：批次1 < 批次2 < 批次3
  2. 检查到期日期：批次1最早到期(10-08)
  3. 推荐：使用批次1 (2000g，足量)

推荐原因：
  ✅ 最早入库 (FIFO原则)
  ✅ 最早到期 (防止过期损失)
  ✅ 库存足量

如果批次1不足 (只有1000g)：
  推荐组合：批次1 (1000g) + 批次2 (1000g)

如果全部使用完：
  使用批次3 (冷冻猪肉)
```

#### 库存预警机制

```
入库时记录到期日期
  │
  ▼
系统每小时扫描一次
  │
  ├─ 3天内到期 → 黄色预警
  ├─ 1天内到期 → 橙色预警
  └─ 当天到期 → 红色警报

      │
      ▼
  显示在库存管理页面
  提醒采购和生产

      │
      ▼
  支持操作：
  ├─ 新鲜→冷冻 (延长保质期)
  ├─ 优先使用 (立即消耗)
  └─ 报废处理 (成本计入)
```

---

### 3.5 AI成本分析与优化建议流程

#### AI分析流程

```
用户点击"AI分析"按钮
  │
  ▼
生成Cache Key (MD5(batchId + question))
  │
  ├─ 缓存命中？
  │  └─ 是 → 直接返回缓存结果（不消耗配额）
  │
  ├─ 缓存未命中
  │  │
  │  ├─ 检查本周AI配额
  │  │  └─ 剩余配额 > 0？
  │  │     └─ 否 → 提示"配额已用完"
  │  │
  │  ├─ 查询批次完整数据
  │  │  ├─ ProcessingBatch 基本信息
  │  │  ├─ MaterialConsumption 原料消耗
  │  │  ├─ BatchWorkSession 工时记录
  │  │  ├─ BatchEquipmentUsage 设备使用
  │  │  └─ QualityInspection 质检结果
  │  │
  │  ├─ 构造AI Prompt
  │  │  └─ "分析该批次成本构成，找出优化空间..."
  │  │     + 成本数据
  │  │     + 历史数据对比
  │  │     + 行业基准
  │  │
  │  ├─ 调用 DeepSeek API
  │  │  ├─ 模型：deepseek-chat
  │  │  ├─ Temperature：0.7 (平衡创意和准确)
  │  │  └─ Max Tokens：1000
  │  │
  │  ├─ 消耗配额 -1
  │  │
  │  ├─ 保存分析结果到数据库
  │  │  ├─ AIAnalysisResult 表
  │  │  ├─ AIAuditLog 审计日志
  │  │  └─ AIUsageLog 使用日志
  │  │
  │  ├─ 缓存结果 (Redis, TTL 5分钟)
  │  │
  │  └─ 返回给前端
  │
  ▼
前端展示 AI 分析报告
  ├─ 综合评价 (总成本、偏差%)
  ├─ 5维深度分析
  │  ├─ 转换率分析
  │  ├─ 人工成本分析
  │  ├─ 设备成本分析
  │  ├─ 原料成本分析
  │  └─ 个人效率分析
  ├─ 优化建议汇总
  │  └─ 预计节省金额
  └─ 支持追问 (消耗配额 -0.2)
```

#### AI分析结果示例

```
【批次成本分析报告】
批次号：BATCH_20251120_001
产品：精制猪肉
生产日期：2025-11-20
总成本：¥16,096.20（超支4.3%）

【综合评价】
⭐⭐⭐⭐ (4/5分) - 中等偏高

【5维深度分析】

1️⃣ 人工成本过高 (81.5% - 行业标准70%)
   建议：减少人员配置5人→4人
   预计节省：¥2,625 (16.3%)
   实施难度：⭐⭐ 中等

2️⃣ 设备消耗品采购不合理
   建议：批量采购可节省15%
   预计节省：¥363 (2.3%)
   实施难度：⭐ 简单

3️⃣ 转换率实际61%优于预期60%
   建议：更新标准转换率为61%
   预计节省：¥490 (3.0%)
   实施难度：⭐ 简单

4️⃣ 维护成本偏高 (¥2,400 vs 行业¥1,900)
   建议：预防性维护计划
   预计节省：¥484 (3.0%)
   实施难度：⭐⭐⭐ 困难

5️⃣ 员工效率待提升
   建议：新员工培训和工艺改进
   预计节省：¥1,572 (9.8%)
   实施难度：⭐⭐ 中等

【总体建议】
🎯 建议优先实施方案2、3（简单易行）
🎯 中期内容方案1、5（需要流程改进）
🎯 长期规划方案4（需要资本投入）

【预计总节省】
¥5,044 (31.3%)
若全部实施，单位成本可降至¥11.02/g

【置信度】
✅ 92% (基于500+批次历史数据训练)
```

---

### 3.6 质量检验流程

#### 质检流程

```
生产完成
  │
  ▼
触发质检 (status: quality_check)
  │
  ├─ 质检员分配
  │  └─ 选择质检员（可多人）
  │
  ├─ 质检信息采集
  │  ├─ 新鲜度评分 (1-5星)
  │  ├─ 外观评分 (1-5星)
  │  ├─ 气味评分 (1-5星)
  │  ├─ 其他评分 (自定义)
  │  └─ 综合评分 (自动计算平均值)
  │
  ├─ 质检决定
  │  ├─ 合格 (pass)
  │  │  └─ 可直接完成批次
  │  │
  │  ├─ 条件合格 (conditional)
  │  │  ├─ 原因说明
  │  │  └─ 条件描述
  │  │
  │  └─ 不合格 (fail)
  │     ├─ 不合格原因
  │     ├─ 是否返工？
  │     │  ├─ 是 → 回到 in_progress 状态
  │     │  └─ 否 → 标记为失败
  │     └─ 处理方式
  │        ├─ 全额报废
  │        ├─ 部分使用
  │        └─ 降级使用
  │
  ├─ 证据保存
  │  ├─ 质检照片（多张）
  │  ├─ 质检备注
  │  └─ 质检日期/时间
  │
  ▼
质检记录保存到数据库
  │
  └─ 关联成本计算
     ├─ 是否需要返工成本？
     ├─ 是否需要报废成本？
     └─ 对后续生产的影响？
```

---

### 3.7 设备监控与告警流程

#### 告警生命周期

```
设备运行
  │
  └─ 实时参数监控
     ├─ 温度 (℃)
     ├─ 湿度 (%)
     ├─ 压力 (Pa)
     └─ 运行状态 (正常/警告/故障)

      │
      ├─ 参数异常？
      │  └─ 是 → 触发告警
      │
      ▼
    ACTIVE (活动告警)
      │
      ├─[点击"确认"]
      │  │
      │  ▼
      │ ACKNOWLEDGED (已确认)
      │  │
      │  ├─[点击"开始处理"]
      │  │  │
      │  │  ▼
      │  │ IN_PROGRESS (处理中)
      │  │  │
      │  │  ├─[完成修复]
      │  │  │  │
      │  │  │  ▼
      │  │  │ RESOLVED (已解决)
      │  │  │  │
      │  │  │  └─ 保存处理方案和预防措施
      │  │  │
      │  │  └─[问题加剧]
      │  │     │
      │  │     ▼
      │  │    ACTIVE (重新触发)
      │  │
      │  └─[如果误报]
      │     │
      │     ▼
      │    IGNORED (已忽略)
      │
      └─[立即忽略]
         │
         ▼
        IGNORED (已忽略)
```

#### 告警规则配置

```
告警类型：
├─ TEMPERATURE (温度异常)
│  ├─ 低于5℃ → CRITICAL
│  ├─ 5-10℃ → WARNING
│  └─ 正常10-20℃
│
├─ FAULT (设备故障)
│  ├─ 故障 → CRITICAL
│  └─ 异响警告 → WARNING
│
└─ MAINTENANCE (维护到期)
   ├─ 维护超期 → CRITICAL
   ├─ 维护即将到期 → WARNING
   └─ 维护充足 → OK

告警严重程度：
├─ CRITICAL (严重) - 红色 🔴
├─ HIGH (高) - 橙色 🟠
├─ MEDIUM (中) - 黄色 🟡
└─ LOW (低) - 绿色 🟢
```

---

## 第4章 数据模型与关系

### 4.1 核心实体关系图

```
Factory (工厂)
  ├─ 1:N → User (员工)
  ├─ 1:N → Department (部门)
  ├─ 1:N → ProcessingBatch (生产批次)
  ├─ 1:N → MaterialBatch (原材料批次)
  └─ 1:N → Equipment (设备)

User (员工)
  ├─ 1:N → TimeClockRecord (打卡记录)
  ├─ 1:N → BatchWorkSession (生产工时)
  └─ 1:N → QualityInspection (质检)

ProcessingBatch (生产批次)
  ├─ N:1 → MaterialType (原料类型)
  ├─ 1:N → MaterialConsumption (原料消耗)
  ├─ 1:N → BatchWorkSession (工时记录)
  ├─ 1:N → BatchEquipmentUsage (设备使用)
  ├─ 1:N → QualityInspection (质检)
  └─ 1:N → AIAnalysisResult (AI分析)

MaterialBatch (原材料批次)
  ├─ N:1 → MaterialType (原料类型)
  ├─ N:1 → Supplier (供应商)
  └─ 1:N → MaterialConsumption (消耗记录)

Equipment (设备)
  ├─ 1:N → BatchEquipmentUsage (使用记录)
  ├─ 1:N → EquipmentAlert (告警)
  └─ 1:N → EquipmentMaintenance (维护记录)
```

### 4.2 关键数据实体

#### User (员工)

```sql
CREATE TABLE users (
  id INT PRIMARY KEY AUTO_INCREMENT,
  factory_id VARCHAR(50) NOT NULL,
  username VARCHAR(50) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  full_name VARCHAR(100),
  phone VARCHAR(20),
  email VARCHAR(100),
  department_id INT,
  role_code VARCHAR(50), -- platform_admin, factory_super_admin, ...
  monthly_salary DECIMAL(10,2),
  expected_work_minutes INT, -- 预期月工时(分钟)
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP,
  updated_at TIMESTAMP,
  FOREIGN KEY (factory_id) REFERENCES factories(id),
  FOREIGN KEY (department_id) REFERENCES departments(id)
);
```

#### ProcessingBatch (生产批次)

```sql
CREATE TABLE processing_batches (
  id VARCHAR(50) PRIMARY KEY, -- BATCH_20251121_001
  factory_id VARCHAR(50) NOT NULL,
  batch_number VARCHAR(50) UNIQUE NOT NULL,
  product_name VARCHAR(100),
  quantity DECIMAL(10,2),
  unit VARCHAR(20), -- kg, g, 件
  status VARCHAR(30), -- planning, in_progress, quality_check, completed, failed
  supervisor_id INT,

  -- 成本字段
  material_cost DECIMAL(12,2),
  labor_cost DECIMAL(12,2),
  equipment_cost DECIMAL(12,2),
  total_cost DECIMAL(12,2),

  start_time TIMESTAMP,
  end_time TIMESTAMP,
  created_at TIMESTAMP,
  updated_at TIMESTAMP,
  FOREIGN KEY (factory_id) REFERENCES factories(id),
  FOREIGN KEY (supervisor_id) REFERENCES users(id)
);
```

#### MaterialBatch (原材料批次)

```sql
CREATE TABLE material_batches (
  id VARCHAR(50) PRIMARY KEY,
  factory_id VARCHAR(50) NOT NULL,
  material_type_id INT,
  batch_number VARCHAR(50) UNIQUE NOT NULL,
  quantity DECIMAL(10,2),
  unit VARCHAR(20),
  purchase_date DATE,
  expiry_date DATE,
  storage_type VARCHAR(30), -- fresh, frozen
  storage_location VARCHAR(100),
  status VARCHAR(30), -- available, partially_used, frozen, expired, returned
  supplier_id INT,
  unit_price DECIMAL(10,2),
  created_at TIMESTAMP,
  FOREIGN KEY (factory_id) REFERENCES factories(id),
  FOREIGN KEY (material_type_id) REFERENCES material_types(id),
  FOREIGN KEY (supplier_id) REFERENCES suppliers(id)
);
```

#### TimeClockRecord (打卡记录)

```sql
CREATE TABLE time_clock_records (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  factory_id VARCHAR(50) NOT NULL,
  user_id INT NOT NULL,
  clock_in_time TIMESTAMP,
  clock_out_time TIMESTAMP,
  work_minutes INT,
  location VARCHAR(100), -- GPS坐标
  status VARCHAR(30), -- pending, completed, absent
  created_at TIMESTAMP,
  FOREIGN KEY (factory_id) REFERENCES factories(id),
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

---

## 第5章 权限管理体系

### 5.1 7角色权限矩阵

| 权限 | super_admin | platform_admin | factory_super | factory_admin | dept_admin | supervisor | operator | viewer |
|------|:-----------:|:---------------:|:-------------:|:-------------:|:---------:|:---------:|:-------:|:-----:|
| **平台管理** |
| 创建工厂 | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 删除工厂 | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 查看工厂 | ✅ | ✅ | ❌ | ✅ | ✅ | ✅ | ❌ | ❌ |
| **用户管理** |
| 创建用户 | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| 删除用户 | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| 修改角色 | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| 查看用户 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **生产管理** |
| 创建批次 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ |
| 删除批次 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |
| 开始生产 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ |
| 完成生产 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |
| **质量检验** |
| 提交质检 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ |
| 审批质检 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |
| 查看质检 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **库存管理** |
| 原料入库 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ |
| 库存调整 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |
| 查看库存 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **AI分析** |
| 使用AI分析 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |
| 查看AI报告 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| **打卡** |
| 自己打卡 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 修改他人打卡 | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ |
| **报表** |
| 查看报表 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 导出报表 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |

---

## 第6章 核心页面界面设计

### 6.1 登录页面 (EnhancedLoginScreen)

**页面功能**:
- 用户名/密码输入
- 生物识别登录（可选）
- 记住密码选项
- 忘记密码链接
- 多语言支持

**UI元素**:
```
┌─────────────────────────┐
│    白垩纪食品溯源系统    │
├─────────────────────────┤
│                         │
│  [用户名输入框]         │
│  [密码输入框]           │
│  ☑ 记住密码             │
│                         │
│  [大按钮: 登录]         │
│                         │
│  [指纹图标] 生物识别登录 │
│                         │
│  [忘记密码?] [注册账号]  │
│                         │
└─────────────────────────┘
```

---

### 6.2 生产仪表板 (ProcessingDashboard)

**页面内容**:
```
┌─────────────────────────────────────┐
│         生产仪表板                  │
├─────────────────────────────────────┤
│                                     │
│ 📊 今日数据卡片 (可折叠)           │
│ ├─ 进行中批次：5个                 │
│ ├─ 完成批次：12个                  │
│ ├─ 待质检：3个                     │
│ └─ 设备告警：2个                   │
│                                     │
│ 🚨 最近告警 (红色标题)             │
│ ├─ [CRITICAL] 冷柜A温度异常        │
│ │  L─ 确认 | 详情                  │
│ └─ [WARNING] 设备B维护即将到期     │
│    L─ 确认 | 详情                  │
│                                     │
│ 📋 进行中的批次 (最近5个)          │
│ ├─ BATCH_001 (精制猪肉) 进度50%   │
│ │  L─ [进度条] 已消耗：500kg/1000kg│
│ ├─ BATCH_002 (冻鱼片) 进度20%     │
│ │  L─ [进度条] 已消耗：100kg/500kg │
│ └─ ...                              │
│                                     │
│ [快捷操作按钮]                     │
│ [创建批次] [查看批次列表]          │
│ [成本分析] [AI助手]                │
│                                     │
└─────────────────────────────────────┘
```

---

### 6.3 打卡页面 (TimeClockScreen)

**页面内容**:
```
┌─────────────────────────────────────┐
│         员工打卡                    │
├─────────────────────────────────────┤
│                                     │
│ 当前状态：已上班 (08:30)           │
│ 工作时长：7小时15分钟              │
│                                     │
│ ┏━━━━━━━━━━━━━━━━━━━━━━━━━━┓     │
│ ┃    [大按钮] 下班打卡      ┃     │
│ ┗━━━━━━━━━━━━━━━━━━━━━━━━━━┛     │
│                                     │
│ 📍 位置验证                        │
│ ├─ 距离工厂：23米 ✅               │
│ └─ GPS: 31.2304°N 121.4737°E     │
│                                     │
│ 📸 拍摄打卡照片 (可选)             │
│ └─ [相机按钮]                      │
│                                     │
│ 👤 生物识别 (可选)                 │
│ └─ [指纹按钮]                      │
│                                     │
│ ─────────────────────────────────  │
│                                     │
│ 📊 今日工时统计                    │
│ ├─ 今日工时：7小时15分钟           │
│ ├─ 本周工时：38.5小时             │
│ └─ 本月工时：156小时              │
│                                     │
│ 📋 今日打卡记录                    │
│ ├─ 08:30 上班打卡                 │
│ │  L─ 位置：工厂内 | 天气：晴     │
│ └─ 12:00-13:00 休息               │
│                                     │
└─────────────────────────────────────┘
```

---

### 6.4 批次详情页 (BatchDetailScreen)

**页面内容**:
```
┌─────────────────────────────────────┐
│    批次详情 - BATCH_20251121_001   │
├─────────────────────────────────────┤
│                                     │
│ 📦 基本信息                        │
│ ├─ 批次号：BATCH_20251121_001     │
│ ├─ 产品：精制猪肉                  │
│ ├─ 数量：1220g                     │
│ ├─ 状态：进行中 🟡                 │
│ ├─ 进度：60% [████████░░]         │
│ └─ 创建于：2025-11-21 08:00      │
│                                     │
│ 💰 成本分析 (可点击展开)          │
│ ├─ 原料成本：¥1,110 (27%)        │
│ ├─ 人工成本：¥2,700 (66%)        │
│ ├─ 设备成本：¥297 (7%)           │
│ └─ 总成本：¥4,107                │
│    [AI分析按钮 🤖]                 │
│                                     │
│ 📈 产量记录 (最近3天)              │
│ ├─ 2025-11-21：400g               │
│ ├─ 2025-11-20：410g               │
│ └─ 2025-11-19：410g               │
│                                     │
│ 👥 参与人员                        │
│ ├─ 张三 (加工工) - 48小时         │
│ ├─ 李四 (加工工) - 46小时         │
│ └─ 王五 (质检员) - 12小时         │
│                                     │
│ 🔧 设备使用                        │
│ ├─ 冷柜A - 运行72小时             │
│ └─ 包装机B - 运行24小时           │
│                                     │
│ ✅ 质检记录                        │
│ └─ 待提交 (3次预计)               │
│                                     │
│ [编辑] [删除] [完成] [成本分析]   │
│                                     │
└─────────────────────────────────────┘
```

---

### 6.5 成本分析页 (CostAnalysisDashboard)

**页面内容**:
```
┌─────────────────────────────────────┐
│         成本分析仪表板              │
├─────────────────────────────────────┤
│                                     │
│ 📊 4维成本占比 (饼图)               │
│         ╭───────╮                  │
│        ╱  原料  ╲                  │
│       │  27%    │ 设备             │
│       │  ¥1110  │ 7%               │
│        ╲  人工  ╱ ¥297              │
│         ╰───────╯                  │
│         66% | ¥2700               │
│                                     │
│ 💡 人工成本过高 (AI警告)           │
│ 建议：减少人员配置，预计节省16%   │
│ [查看详情]                         │
│                                     │
│ ┌─ 原料成本 ¥1,110 (27%) ─────┐  │
│ │ └─ 猪肉 2000g × ¥80/kg       │  │
│ │ └─ 冰袋 100g × ¥2/g          │  │
│ │ └─ 包装 150件 × ¥5/件        │  │
│ └─────────────────────────────┘  │
│                                     │
│ ┌─ 人工成本 ¥2,700 (66%) ─────┐  │
│ │ ├─ 张三 48h × ¥225/h = ¥10.8k │  │
│ │ └─ 李四 46h × ¥225/h = ¥10.4k │  │
│ └─────────────────────────────┘  │
│                                     │
│ ┌─ 设备成本 ¥297 (7%) ────────┐  │
│ │ ├─ 冷柜A 72h × ¥0.57/h      │  │
│ │ └─ 包装机B 24h × ¥1.23/h    │  │
│ └─────────────────────────────┘  │
│                                     │
│ 📌 总成本统计                      │
│ ├─ 总成本：¥4,107               │
│ ├─ 产量：1220g                    │
│ ├─ 单位成本：¥3.36/g             │
│ └─ 目标成本：¥3.10/g             │
│    偏差：+8.4% ⚠️                 │
│                                     │
│ ┏━━━━━━━━━━━━━━━━━━━━━━━━━━┓    │
│ ┃  [🤖 AI智能分析]           ┃    │
│ ┗━━━━━━━━━━━━━━━━━━━━━━━━━━┛    │
│                                     │
└─────────────────────────────────────┘
```

---

## 第7章 API规范与集成

### 7.1 统一API响应格式

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    // 实际业务数据
  },
  "timestamp": 1637467200000
}
```

**状态码**:
- `200` - 成功
- `400` - 参数错误
- `401` - 未认证
- `403` - 权限不足
- `404` - 资源不存在
- `500` - 服务器错误

### 7.2 认证规范

**请求头**:
```
Authorization: Bearer <accessToken>
X-Device-Id: <deviceId>
X-Factory-Id: <factoryId>
```

**Token刷新**:
```
POST /api/mobile/auth/refresh-token
Header: Authorization: Bearer <refreshToken>
```

### 7.3 分页查询规范

**请求参数**:
```json
{
  "page": 0,      // 页码（从0开始）
  "pageSize": 20, // 每页大小
  "sort": "createdAt,desc" // 排序
}
```

**响应格式**:
```json
{
  "code": 200,
  "data": {
    "content": [...],
    "totalElements": 100,
    "totalPages": 5,
    "currentPage": 0,
    "hasNext": true
  }
}
```

---

## 第8章 实现状态总览

### 8.1 模块完成度统计

| 模块 | 前端页面 | 后端API | 完成度 | 说明 |
|------|---------|---------|--------|------|
| 认证与授权 | 3 | 37 | **95%** | 基本完成，两阶段注册待完成 |
| 考勤打卡 | 5 | 30 | **90%** | 基本完成，历史查询待完成 |
| 生产加工 | 25 | 50 | **85%** | AI详情页待完善，设备集成待完成 |
| AI成本分析 | 5 | 12 | **95%** | 基本完成，只需UI优化 |
| 设备管理 | 4 | 26 | **90%** | 基本完成，告警逻辑待完成 |
| 质量检验 | 3 | 5 | **70%** | 创建质检、详情页待完成 |
| 基础数据管理 | 14 | 多个 | **90%** | CRUD已完成，导入导出待完成 |
| 平台管理 | 3 | 12 | **85%** | 基本完成，仪表板待完善 |
| 报表分析 | 12 | 20 | **80%** | 5个报表完成，效率报表待完成 |

**系统总体完成度**: **82-85%**

### 8.2 Phase 3待完成（2-3周）

#### P0级（紧急，2小时）
- [ ] 设备监控集成到导航

#### P1级（核心，3-4天）
- [ ] AI智能分析详情页完善
- [ ] 质检完整流程
- [ ] 成本对比分析页面
- [ ] 设备告警系统
- [ ] 库存FIFO推荐API

#### P2级（辅助，5-7天）
- [ ] 两阶段用户注册
- [ ] 数据报表导出
- [ ] 打卡历史查询
- [ ] 工厂设置页面

### 8.3 Phase 4-5规划路线图

**Phase 4 (2025 Q2-Q3)**: 横向扩展
- 养殖模块
- 物流模块
- 溯源模块
- 销售模块

**Phase 5 (2025下半年)**: 平台化生态
- Web管理后台
- 高级AI功能
- 产业互联网平台

---

**文档维护**:
- **版本**: v5.0
- **最后更新**: 2025-11-21
- **更新频率**: 功能发布后或月度更新
- **维护团队**: 架构 + 产品

**相关文档**:
- [功能与文件映射-v3.0](./PRD-功能与文件映射-v3.0.md)
- [业务逻辑总览](./BUSINESS_LOGIC_OVERVIEW.md)
- [待实现功能清单](./PENDING_FEATURES_TODO.md)
