# ç™½å©çºªé£Ÿå“æº¯æºç³»ç»Ÿ - åŠŸèƒ½ä¸æ–‡ä»¶æ˜ å°„ v3.0 æ–°äººè¯¦è§£

> **ç‰ˆæœ¬**: v3.0-æ–°äººè¯¦è§£
> **ç±»å‹**: é’ˆå¯¹æ–°äººçš„è¯¦ç»†ä¸šåŠ¡å’ŒæŠ€æœ¯æŒ‡å—
> **ç”Ÿæˆæ—¥æœŸ**: 2025-11-21
> **æ ¸å¿ƒç‰¹è‰²**: åŒ…å«å®Œæ•´çš„ä¸šåŠ¡æµç¨‹ã€äº¤å‰åŠŸèƒ½è¯´æ˜ã€å®ç°ç»†èŠ‚å’ŒFAQ
> **é€‚ç”¨å¯¹è±¡**: æ–°åŠ å…¥é¡¹ç›®çš„å·¥ç¨‹å¸ˆ

---

## ğŸ“‘ æ–‡æ¡£ç›®å½•

### ç¬¬0ç«  æ ¸å¿ƒä¸šåŠ¡æµç¨‹ä¸æ¶æ„
- [0.1 å®Œæ•´ç”Ÿäº§æ‰¹æ¬¡ä¸šåŠ¡çº¿](#01-å®Œæ•´ç”Ÿäº§æ‰¹æ¬¡ä¸šåŠ¡çº¿)
- [0.2 æ—¶é—´è¿½è¸ªä¸æˆæœ¬è®¡ç®—ä¸šåŠ¡çº¿](#02-æ—¶é—´è¿½è¸ªä¸æˆæœ¬è®¡ç®—ä¸šåŠ¡çº¿)
- [0.3 åº“å­˜ä¸ææ–™ç®¡ç†ä¸šåŠ¡çº¿](#03-åº“å­˜ä¸ææ–™ç®¡ç†ä¸šåŠ¡çº¿)
- [0.4 å…³é”®æ•°æ®æµå›¾](#04-å…³é”®æ•°æ®æµå›¾)

### åŠŸèƒ½æ¨¡å—è¯¦è§£ (1-11)
1. [è®¤è¯ä¸æƒé™æ¨¡å—](#1-è®¤è¯ä¸æƒé™æ¨¡å—)
2. [è€ƒå‹¤ç®¡ç†æ¨¡å—](#2-è€ƒå‹¤ç®¡ç†æ¨¡å—)
3. [ç”Ÿäº§åŠ å·¥æ¨¡å—](#3-ç”Ÿäº§åŠ å·¥æ¨¡å—)
4. [AIæ™ºèƒ½åˆ†ææ¨¡å—](#4-aiæ™ºèƒ½åˆ†ææ¨¡å—)
5. [è®¾å¤‡ç®¡ç†æ¨¡å—](#5-è®¾å¤‡ç®¡ç†æ¨¡å—)
6. [åº“å­˜ç®¡ç†æ¨¡å—](#6-åº“å­˜ç®¡ç†æ¨¡å—)
7. [è´¨é‡æ£€éªŒæ¨¡å—](#7-è´¨é‡æ£€éªŒæ¨¡å—)
8. [åŸºç¡€æ•°æ®ç®¡ç†æ¨¡å—](#8-åŸºç¡€æ•°æ®ç®¡ç†æ¨¡å—)
9. [å¹³å°ç®¡ç†æ¨¡å—](#9-å¹³å°ç®¡ç†æ¨¡å—)
10. [æŠ¥è¡¨åˆ†ææ¨¡å—](#10-æŠ¥è¡¨åˆ†ææ¨¡å—)
11. [æ•°æ®å¯¼å…¥å¯¼å‡º](#11-æ•°æ®å¯¼å…¥å¯¼å‡º)

### äº¤å‰åŠŸèƒ½è¯¦è§£
- [X.1 æˆæœ¬è‡ªåŠ¨è®¡ç®—ï¼ˆ4ä¸ªæ¨¡å—åä½œï¼‰](#x1-æˆæœ¬è‡ªåŠ¨è®¡ç®—4ä¸ªæ¨¡å—åä½œ)
- [X.2 FIFOåº“å­˜æ¨èï¼ˆåº“å­˜â†’ç”Ÿäº§ï¼‰](#x2-fifoåº“å­˜æ¨èåº“å­˜ç”Ÿäº§)
- [X.3 æ—¶é—´æˆæœ¬ä¸€ä½“åŒ–ï¼ˆè€ƒå‹¤â†’ç”Ÿäº§â†’æˆæœ¬ï¼‰](#x3-æ—¶é—´æˆæœ¬ä¸€ä½“åŒ–è€ƒå‹¤ç”Ÿäº§æˆæœ¬)
- [X.4 è®¾å¤‡æŠ˜æ—§é›†æˆï¼ˆè®¾å¤‡â†’æˆæœ¬è®¡ç®—ï¼‰](#x4-è®¾å¤‡æŠ˜æ—§é›†æˆè®¾å¤‡æˆæœ¬è®¡ç®—)
- [X.5 AIåˆ†æè§¦å‘é“¾ï¼ˆå®Œæˆâ†’åˆ†æâ†’æŠ¥å‘Šï¼‰](#x5-aiåˆ†æè§¦å‘é“¾å®Œæˆåˆ†ææŠ¥å‘Š)

### é™„å½•
- [ç³»ç»Ÿç»Ÿè®¡æ•°æ®](#ç³»ç»Ÿç»Ÿè®¡æ•°æ®)
- [å¸¸è§é—®é¢˜è§£ç­”](#å¸¸è§é—®é¢˜è§£ç­”)

---

## ç¬¬0ç«  æ ¸å¿ƒä¸šåŠ¡æµç¨‹ä¸æ¶æ„

æœ¬ç« ä»‹ç»ç³»ç»Ÿçš„3æ¡ä¸»è¦ä¸šåŠ¡çº¿ï¼Œæ¯æ¡ä¸šåŠ¡çº¿ä»£è¡¨ä¸€ä¸ªå®Œæ•´çš„å·¥ä½œæµç¨‹ã€‚ç†è§£è¿™äº›ä¸šåŠ¡çº¿æ˜¯ç†è§£æ•´ä¸ªç³»ç»Ÿçš„åŸºç¡€ã€‚

### 0.1 å®Œæ•´ç”Ÿäº§æ‰¹æ¬¡ä¸šåŠ¡çº¿

#### åœºæ™¯æè¿°
ä¸€ä¸ªé£Ÿå“å·¥å‚ç”Ÿäº§ç•ªèŒ„é…±ã€‚ä»åŸææ–™é‡‡è´­åˆ°æˆå“äº¤ä»˜çš„å®Œæ•´è¿‡ç¨‹æ¶‰åŠå¤šä¸ªæ¨¡å—çš„åä½œã€‚

#### æµç¨‹æ­¥éª¤

**ç¬¬1æ­¥: ç‰©æ–™å‡†å¤‡ (åº“å­˜æ¨¡å— â†’ ç”Ÿäº§æ¨¡å—)**
```
åº“å­˜ç®¡ç†å‘˜ç™»å½•ç³»ç»Ÿ
  â†“
æŸ¥çœ‹å¯ç”¨ç‰©æ–™æ‰¹æ¬¡
  â†“
ç³»ç»Ÿæ ¹æ®FIFOè§„åˆ™æ¨èæœ€æ—©è¿‡æœŸæ—¥æœŸçš„ç•ªèŒ„æ‰¹æ¬¡ (MAT-20251015-001)
  â†“
ç¡®è®¤ä½¿ç”¨è¯¥ç‰©æ–™
  â†“
åº“å­˜ç³»ç»Ÿè‡ªåŠ¨æ‰£å‡è¯¥æ‰¹æ¬¡åº“å­˜ (1000kg â†’ 950kg)
```

**å…³é”®æ•°æ®**:
- ç‰©æ–™æ‰¹æ¬¡: `MAT-20251015-001` (ç•ªèŒ„, 2025-12-15è¿‡æœŸ)
- ç”¨é‡: 50kg
- åº“å­˜å‰©ä½™: 950kg

**æ¶‰åŠæ–‡ä»¶**:
- å‰ç«¯: `MaterialInventoryScreen.tsx`, `MaterialBatchListScreen.tsx`
- åç«¯: `MaterialBatchRepository.java`, `MaterialConsumptionService.java`
- æ•°æ®åº“: `material_batches`, `material_consumption_records`

---

**ç¬¬2æ­¥: åˆ›å»ºç”Ÿäº§æ‰¹æ¬¡ (ç”Ÿäº§æ¨¡å—)**
```
ç”Ÿäº§ä¸»ç®¡ç™»å½•ç³»ç»Ÿ
  â†“
åˆ›å»ºæ–°ç”Ÿäº§æ‰¹æ¬¡ (BATCH-20251121-001)
  â†“
è®¾ç½®åŸºæœ¬ä¿¡æ¯:
  - äº§å“ç±»å‹: ç•ªèŒ„é…±
  - è®¡åˆ’äº§é‡: 500kg
  - é¢„è®¡å‘¨æœŸ: 8å°æ—¶
  - æŒ‡æ´¾ä¸»ç®¡: å¼ ä¸‰
  â†“
ç³»ç»Ÿä¿å­˜åˆ° production_batches è¡¨
```

**å…³é”®æ•°æ®ç»“æ„**:
```java
// ProductionBatch å®ä½“
{
  id: 1,
  batchNumber: "BATCH-20251121-001",
  productTypeId: "PROD-001",
  factoryId: "CRETAS_2024_001",
  status: "IN_PROGRESS",      // ç”Ÿäº§ä¸­
  plannedQuantity: 500,
  actualQuantity: 0,          // å°šæœªå®Œæˆ
  startTime: 2025-11-21 08:00,
  endTime: null,              // å°šæœªç»“æŸ
  supervisorId: 1,
  createdAt: 2025-11-21 08:00,
  updatedAt: 2025-11-21 08:00
}
```

**æ¶‰åŠæ–‡ä»¶**:
- å‰ç«¯: `CreateProductionBatchScreen.tsx`, `ProductionDashboard.tsx`
- åç«¯: `ProcessingController.java`, `ProcessingServiceImpl.java`
- æ•°æ®åº“: `production_batches` è¡¨

---

**ç¬¬3æ­¥: å‘˜å·¥æ‰“å¡ä¸å·¥ä½œè®°å½• (è€ƒå‹¤æ¨¡å—)**
```
å·¥äººæå››ä¸Šç­
  â†“
æ‰“å¼€è€ƒå‹¤é¡µé¢,ç‚¹å‡»"ä¸Šç­æ‰“å¡"
  â†“
ç³»ç»Ÿè®°å½•:
  - æ‰“å¡æ—¶é—´: 2025-11-21 08:00
  - æ‰“å¡åœ°ç‚¹: å·¥å‚GPSåæ ‡
  - å‘˜å·¥ID: 4
  â†“
æå››è¢«è‡ªåŠ¨åˆ†é…åˆ°æ‰¹æ¬¡ BATCH-20251121-001 (ç³»ç»ŸåŸºäºå²—ä½å’Œå½“å‰ä»»åŠ¡)
  â†“
å¼€å§‹å·¥ä½œæ—¶é—´è·Ÿè¸ª
```

**å…³é”®æ•°æ®æµ**:
- æ‰“å¡è®°å½• â†’ `time_clock_records` è¡¨
- è‡ªåŠ¨åˆ›å»ºå·¥ä½œä¼šè¯ â†’ `batch_work_sessions` è¡¨
- å…³è”åˆ°ç”Ÿäº§æ‰¹æ¬¡

```sql
-- time_clock_records è¡¨è®°å½•
INSERT INTO time_clock_records (
  user_id, factory_id, clock_in_time,
  clock_in_location, status, created_at
) VALUES (
  4, 'CRETAS_2024_001', '2025-11-21 08:00:00',
  '31.2304,121.4737', 'CLOCKED_IN', NOW()
);

-- batch_work_sessions è¡¨è‡ªåŠ¨åˆ›å»º
INSERT INTO batch_work_sessions (
  batch_id, user_id, start_time, end_time, status
) VALUES (
  1, 4, '2025-11-21 08:00:00', NULL, 'IN_PROGRESS'
);
```

**æ¶‰åŠæ–‡ä»¶**:
- å‰ç«¯: `AttendanceScreen.tsx`, `TimeClockScreen.tsx`
- åç«¯: `AttendanceController.java`, `TimeclockService.java`
- æ•°æ®åº“: `time_clock_records`, `batch_work_sessions`

---

**ç¬¬4æ­¥: è®¾å¤‡ä½¿ç”¨ä¸æŠ˜æ—§è®°å½• (è®¾å¤‡æ¨¡å—)**
```
ç•ªèŒ„é…±ç”Ÿäº§éœ€è¦ä½¿ç”¨ä¸¤å°è®¾å¤‡:
  1. æ…æ‹Œæœº (EQP-001)
  2. çŒè£…æœº (EQP-002)

æ“ä½œå‘˜é€šè¿‡è®¾å¤‡ç®¡ç†ç•Œé¢:
  â†“
è¾“å…¥è®¾å¤‡ID: EQP-001
  â†“
ç‚¹å‡»"å¼€å§‹å·¥ä½œ"
  â†“
ç³»ç»Ÿè®°å½•:
  - è®¾å¤‡å¯åŠ¨æ—¶é—´: 2025-11-21 08:30
  - å…³è”æ‰¹æ¬¡: BATCH-20251121-001
  - è®¾å¤‡çŠ¶æ€: è¿è¡Œä¸­
```

**è®¾å¤‡æˆæœ¬è®¡ç®—**:
```
æ…æ‹ŒæœºæœˆæŠ˜æ—§: 15,000å…ƒ
æ—¥æŠ˜æ—§: 15,000 / 30 = 500å…ƒ
å·¥ä½œæ—¶é—´: 8å°æ—¶
å°æ—¶æŠ˜æ—§: 500 / 24 = 20.83å…ƒ

æœ¬æ¬¡ä½¿ç”¨æˆæœ¬ = 20.83 Ã— 8 = 166.64å…ƒ
```

**æ¶‰åŠæ–‡ä»¶**:
- å‰ç«¯: `EquipmentManagementScreen.tsx`, `EquipmentOperationScreen.tsx`
- åç«¯: `EquipmentController.java`, `EquipmentService.java`
- æ•°æ®åº“: `equipment_usage_records`, `equipment_depreciation`

---

**ç¬¬5æ­¥: è´¨é‡æ£€éªŒ (è´¨é‡æ£€éªŒæ¨¡å—)**
```
ç”Ÿäº§å®Œæˆå,è´¨æ£€å‘˜æ£€æŸ¥äº§å“
  â†“
æ‰“å¼€è´¨æ£€ç•Œé¢
  â†“
è¾“å…¥æ£€éªŒæ•°æ®:
  - å¤–è§‚: åˆæ ¼
  - å£å‘³: åˆæ ¼
  - æˆåˆ†å«é‡: åˆæ ¼
  - å¾®ç”Ÿç‰©æ£€æµ‹: é€šè¿‡
  â†“
æäº¤è´¨æ£€è®°å½•
  â†“
æ‰¹æ¬¡çŠ¶æ€å˜æ›´ä¸º: QUALITY_CHECKED
```

**è´¨æ£€è®°å½•ä¿å­˜**:
```java
{
  batchId: 1,
  inspectorId: 5,
  inspectionDate: 2025-11-21 16:00,
  appearance: "PASSED",
  taste: "PASSED",
  composition: "PASSED",
  microbiology: "PASSED",
  overallResult: "PASSED",
  notes: "ç¬¦åˆä¼ä¸šæ ‡å‡†"
}
```

**æ¶‰åŠæ–‡ä»¶**:
- å‰ç«¯: `QualityInspectionScreen.tsx`, `CreateQualityRecordScreen.tsx`
- åç«¯: `QualityController.java`, `QualityInspectionService.java`
- æ•°æ®åº“: `quality_inspections` è¡¨

---

**ç¬¬6æ­¥: å‘˜å·¥ä¸‹ç­æ‰“å¡ä¸è‡ªåŠ¨æˆæœ¬è®¡ç®— (è€ƒå‹¤æ¨¡å— + æˆæœ¬è®¡ç®—)**
```
æå››ä¸‹ç­
  â†“
æ‰“å¼€è€ƒå‹¤é¡µé¢,ç‚¹å‡»"ä¸‹ç­æ‰“å¡"
  â†“
ç³»ç»Ÿè®°å½•:
  - æ‰“å¡æ—¶é—´: 2025-11-21 16:00
  - å·¥ä½œæ—¶é•¿: 8å°æ—¶
  â†“
ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—:
  - å·¥èµ„æˆæœ¬: å‘˜å·¥æ—¥è–ª Ã— (8å°æ—¶ / 24å°æ—¶)
  - æ”¶é›†è¯¥å‘˜å·¥åœ¨è¯¥æ‰¹æ¬¡çš„æ‰€æœ‰å·¥ä½œæ—¶é—´
  â†“
è§¦å‘æ‰¹æ¬¡æˆæœ¬æ±‡æ€»è®¡ç®—
```

**è‡ªåŠ¨æˆæœ¬è®¡ç®—æµç¨‹**:
```
å½“æ£€æµ‹åˆ°"ç”Ÿäº§æ‰¹æ¬¡BATCH-20251121-001å·²å®Œæˆ"æ—¶:

1. è®¡ç®—äººå·¥æˆæœ¬:
   - æ”¶é›†æ‰€æœ‰batch_work_sessions
   - æå››: 8å°æ—¶ Ã— æ—¥è–ª / 24 = Xå…ƒ
   - å…¶ä»–å·¥äºº: ... (ç±»ä¼¼è®¡ç®—)
   - äººå·¥æˆæœ¬å°è®¡: Yå…ƒ

2. è®¡ç®—è®¾å¤‡æˆæœ¬:
   - æ”¶é›†æ‰€æœ‰equipment_usage_records
   - æ…æ‹Œæœº: 8å°æ—¶ Ã— æŠ˜æ—§ = 166.64å…ƒ
   - çŒè£…æœº: 8å°æ—¶ Ã— æŠ˜æ—§ = 125.30å…ƒ
   - è®¾å¤‡æˆæœ¬å°è®¡: Zå…ƒ

3. è®¡ç®—åŸææ–™æˆæœ¬:
   - ç”¨æ: 50kgç•ªèŒ„ Ã— å•ä»· = Må…ƒ
   - è¾…æ–™: ... = Nå…ƒ
   - ææ–™æˆæœ¬å°è®¡: Oå…ƒ

4. è®¡ç®—æ€»æˆæœ¬:
   æ€»æˆæœ¬ = äººå·¥æˆæœ¬Y + è®¾å¤‡æˆæœ¬Z + ææ–™æˆæœ¬O
         = X + 291.94 + M
```

**æ¶‰åŠæ–‡ä»¶**:
- å‰ç«¯: `TimeClockScreen.tsx`, `ProcessingDashboard.tsx`
- åç«¯: `ProcessingServiceImpl.java` (calculateBatchCostæ–¹æ³•)
- æ•°æ®åº“: `batch_cost_analysis` è¡¨

---

**ç¬¬7æ­¥: AIæ™ºèƒ½åˆ†æä¸ä¼˜åŒ–å»ºè®® (AIåˆ†ææ¨¡å—)**
```
ç³»ç»Ÿå®Œæˆæˆæœ¬è®¡ç®—å,è‡ªåŠ¨è§¦å‘AIåˆ†æ
  â†“
AIåˆ†æå¼•æ“(DeepSeek LLM)åˆ†ææ‰¹æ¬¡æ•°æ®:

è¾“å…¥æç¤ºè¯:
"è¿™æ˜¯ä¸€ä¸ªç•ªèŒ„é…±ç”Ÿäº§æ‰¹æ¬¡çš„å®Œæ•´æ•°æ®:
- äº§é‡: 500kg
- äººå·¥æˆæœ¬: 1200å…ƒ
- è®¾å¤‡æˆæœ¬: 291.94å…ƒ
- åŸææ–™æˆæœ¬: 5000å…ƒ
- æ€»æˆæœ¬: 6491.94å…ƒ
- äººå·¥å æ¯”: 18.5%
- è®¾å¤‡å æ¯”: 4.5%
- åŸææ–™å æ¯”: 77%

è¯·åˆ†æ:
1. è¿™ä¸ªæ‰¹æ¬¡çš„æˆæœ¬æ˜¯å¦åˆç†?
2. æœ‰å“ªäº›ä¼˜åŒ–çš„æœºä¼š?
3. å¦‚ä½•é™ä½äººå·¥æˆæœ¬?
4. è®¾å¤‡æŠ˜æ—§æ˜¯å¦è¿‡é«˜?"

  â†“
AIè¿”å›åˆ†æç»“æœ:
"ä»æ•°æ®çœ‹,è¯¥æ‰¹æ¬¡æˆæœ¬è¾ƒä¸ºåˆç†,ä½†æœ‰ä»¥ä¸‹ä¼˜åŒ–ç‚¹:
1. åŸææ–™æˆæœ¬å æ¯”77%,å»ºè®®ä¸ä¾›åº”å•†è°ˆåˆ¤é™ä½å•ä»·
2. äººå·¥æˆæœ¬18.5%è¾ƒä½,è¯´æ˜ç”Ÿäº§æ•ˆç‡ä¸é”™
3. å»ºè®®ä¸‹æ¬¡é‡‡è´­æ—¶é€‰æ‹©æ•£ç§°ç•ªèŒ„è€Œéç›’è£…,å¯èŠ‚çœåŒ…è£…æˆæœ¬..."

  â†“
åˆ†æç»“æœä¿å­˜åˆ°æ•°æ®åº“
  â†“
é€šçŸ¥ç›¸å…³äººå‘˜æŸ¥çœ‹ä¼˜åŒ–å»ºè®®
```

**æ¶‰åŠæ–‡ä»¶**:
- å‰ç«¯: `DeepSeekAnalysisScreen.tsx`, `TimeRangeCostAnalysisScreen.tsx`
- åç«¯: `AIController.java`, `AIEnterpriseService.java`
- Python AIæœåŠ¡: `backend-java/backend-ai-chat/ai_service.py`
- æ•°æ®åº“: `ai_analysis_results` è¡¨

---

#### æ€»ç»“: ç”Ÿäº§æ‰¹æ¬¡ä¸šåŠ¡çº¿æ¶‰åŠçš„æ¨¡å—

| æ­¥éª¤ | ä¸»æ¨¡å— | è¾…åŠ©æ¨¡å— | å…³é”®åŠ¨ä½œ | è¾“å‡º |
|------|--------|---------|---------|------|
| 1 | åº“å­˜ç®¡ç† | - | æŸ¥è¯¢å¯ç”¨ç‰©æ–™,FIFOæ¨è | ç‰©æ–™æ‰¹æ¬¡ID |
| 2 | ç”Ÿäº§åŠ å·¥ | - | åˆ›å»ºæ‰¹æ¬¡,è®°å½•è®¡åˆ’ | æ‰¹æ¬¡å· |
| 3 | è€ƒå‹¤ç®¡ç† | ç”Ÿäº§åŠ å·¥ | æ‰“å¡,åˆ›å»ºå·¥ä½œä¼šè¯ | æ—¶é—´è®°å½• |
| 4 | è®¾å¤‡ç®¡ç† | ç”Ÿäº§åŠ å·¥ | è®¾å¤‡å¯åŠ¨,è®°å½•ä½¿ç”¨ | è®¾å¤‡ä½¿ç”¨è®°å½• |
| 5 | è´¨é‡æ£€éªŒ | ç”Ÿäº§åŠ å·¥ | æ£€éªŒ,è®°å½•ç»“æœ | è´¨æ£€æŠ¥å‘Š |
| 6 | è€ƒå‹¤ç®¡ç† | æˆæœ¬è®¡ç®— | æ‰“å¡,è§¦å‘æˆæœ¬è®¡ç®— | æˆæœ¬æ˜ç»† |
| 7 | AIåˆ†æ | ç”Ÿäº§åŠ å·¥ | è‡ªåŠ¨åˆ†æ,ç”Ÿæˆå»ºè®® | ä¼˜åŒ–æ–¹æ¡ˆ |

---

### 0.2 æ—¶é—´è¿½è¸ªä¸æˆæœ¬è®¡ç®—ä¸šåŠ¡çº¿

#### åœºæ™¯æè¿°
ç³»ç»Ÿé€šè¿‡ç²¾ç»†çš„æ—¶é—´è¿½è¸ª,è‡ªåŠ¨è®¡ç®—æ¯ä¸ªå‘˜å·¥å¯¹æ¯ä¸ªæ‰¹æ¬¡çš„æˆæœ¬è´¡çŒ®ã€‚

#### å®Œæ•´æµç¨‹

```
å‘˜å·¥ä¸Šç­ (08:00)
  â†“
ç³»ç»Ÿåˆ›å»º time_clock_record å’Œ batch_work_session
  â†“
  â”œâ”€ time_clock_records: {user_id: 4, clock_in: 08:00}
  â””â”€ batch_work_sessions: {batch_id: 1, user_id: 4, start: 08:00}

  â†“
å‘˜å·¥å·¥ä½œ (08:00-16:00)
  â†“
  åœ¨æ­¤æœŸé—´,ç³»ç»Ÿè®°å½•:
  â”œâ”€ ä¸­æ–­æ—¶é—´(å¦‚æœæœ‰) â†’ break_records
  â””â”€ è½¬ç§»åˆ°å…¶ä»–æ‰¹æ¬¡(å¦‚æœæœ‰) â†’ batch_work_sessions æ›´æ–°

  â†“
å‘˜å·¥ä¸‹ç­ (16:00)
  â†“
ç³»ç»Ÿæ›´æ–° time_clock_record å’Œ batch_work_session
  â†“
  â”œâ”€ time_clock_records: {clock_out: 16:00, total_hours: 8}
  â””â”€ batch_work_sessions: {end: 16:00, duration: 8 hours}

  â†“
è‡ªåŠ¨æˆæœ¬è®¡ç®—:
  â”œâ”€ å‘˜å·¥åŸºæœ¬æ—¥è–ª: 300å…ƒ
  â”œâ”€ å®é™…å·¥ä½œæ—¶é—´: 8å°æ—¶ (æ‰£é™¤ä¼‘æ¯)
  â”œâ”€ æ—¶é—´æ¯”ä¾‹æˆæœ¬: 300 Ã— (8/24) = 100å…ƒ
  â””â”€ åˆ†é…åˆ°æ‰¹æ¬¡BATCH-20251121-001: 100å…ƒ
```

#### å¤æ‚åœºæ™¯: å¤šæ‰¹æ¬¡å·¥ä½œ

```
08:00 å‘˜å·¥ä¸Šç­,åˆ†é…åˆ°æ‰¹æ¬¡A
  â†“
12:00 è½¬ç§»åˆ°æ‰¹æ¬¡B (ç”±äºæ‰¹æ¬¡Aæš‚æ—¶åœå·¥)
  â†“
14:00 è½¬ç§»å›æ‰¹æ¬¡A
  â†“
16:00 ä¸‹ç­

ç»“æœ:
- æ‰¹æ¬¡A å·¥ä½œæ—¶é—´: (08:00-12:00) + (14:00-16:00) = 6å°æ—¶
- æ‰¹æ¬¡B å·¥ä½œæ—¶é—´: (12:00-14:00) = 2å°æ—¶
- æ€»å·¥ä½œæ—¶é—´: 8å°æ—¶

æˆæœ¬åˆ†é…:
- æ‰¹æ¬¡A äººå·¥æˆæœ¬: 300 Ã— (6/24) = 75å…ƒ
- æ‰¹æ¬¡B äººå·¥æˆæœ¬: 300 Ã— (2/24) = 25å…ƒ
- éªŒè¯: 75 + 25 = 100å…ƒ âœ“
```

#### å…³é”®è¡¨ç»“æ„

```sql
-- æ—¶é—´æ‰“å¡è®°å½•
CREATE TABLE time_clock_records (
  id BIGINT PRIMARY KEY,
  user_id BIGINT,
  factory_id VARCHAR(50),
  clock_in_time TIMESTAMP,
  clock_out_time TIMESTAMP,
  clock_in_location VARCHAR(100),
  clock_out_location VARCHAR(100),
  total_hours DECIMAL(5,2),
  status ENUM('CLOCKED_IN', 'CLOCKED_OUT', 'BREAK'),
  created_at TIMESTAMP
);

-- æ‰¹æ¬¡å·¥ä½œä¼šè¯
CREATE TABLE batch_work_sessions (
  id BIGINT PRIMARY KEY,
  batch_id BIGINT,
  user_id BIGINT,
  factory_id VARCHAR(50),
  start_time TIMESTAMP,
  end_time TIMESTAMP,
  duration_hours DECIMAL(5,2),
  labor_cost DECIMAL(12,2),  -- è‡ªåŠ¨è®¡ç®—
  status ENUM('IN_PROGRESS', 'COMPLETED'),
  created_at TIMESTAMP
);
```

---

### 0.3 åº“å­˜ä¸ææ–™ç®¡ç†ä¸šåŠ¡çº¿

#### åœºæ™¯æè¿°
ç³»ç»Ÿé€šè¿‡FIFO(å…ˆè¿›å…ˆå‡º)ç­–ç•¥è‡ªåŠ¨æ¨èç‰©æ–™ä½¿ç”¨,ç¡®ä¿æ²¡æœ‰è¿‡æœŸç‰©æ–™ã€‚

#### FIFOæ¨èæµç¨‹

```
ç¬¬1æ­¥: æŸ¥è¯¢éœ€è¦çš„ç‰©æ–™ç±»å‹
  â†“
ç¬¬2æ­¥: ä»åº“å­˜ä¸­æŸ¥è¯¢è¯¥ç‰©æ–™çš„æ‰€æœ‰æ‰¹æ¬¡
  â†“
  ç»“æœ: [
    {batchId: 1, expiryDate: 2025-12-01, quantity: 500kg},   â† æœ€æ—©è¿‡æœŸ
    {batchId: 2, expiryDate: 2025-12-15, quantity: 1000kg},
    {batchId: 3, expiryDate: 2026-01-10, quantity: 800kg}
  ]

ç¬¬3æ­¥: ç³»ç»ŸæŒ‰expiryDateæ’åº (å‡åº)
  â†“
ç¬¬4æ­¥: æ£€æŸ¥ç¬¬ä¸€æ‰¹(æœ€æ—©è¿‡æœŸ)çš„åº“å­˜
  â†“
  batchId:1 æœ‰ 500kg å¯ç”¨

ç¬¬5æ­¥: å±•ç¤ºæ¨èç»™ç”¨æˆ·
  â†“
  "æ¨èä½¿ç”¨æ‰¹æ¬¡1 (2025-12-01è¿‡æœŸ), åº“å­˜500kg"

ç¬¬6æ­¥: ç”¨æˆ·ç¡®è®¤ä½¿ç”¨
  â†“
ç¬¬7æ­¥: ç³»ç»Ÿè®°å½•æ¶ˆè€—
  â†“
  material_consumption_records è¡¨ä¸­æ–°å¢ä¸€æ¡:
  {
    material_batch_id: 1,
    quantity_consumed: 50,  // ç”¨äº†50kg
    consumption_date: 2025-11-21,
    batch_id: BATCH-20251121-001,
    created_by: 3
  }

ç¬¬8æ­¥: æ›´æ–°åº“å­˜
  â†“
  material_batches è¡¨:
  {
    id: 1,
    quantity: 500 - 50 = 450,
    updated_at: 2025-11-21
  }

ç¬¬9æ­¥: å¦‚æœåº“å­˜å˜ä¸º0,æ ‡è®°ä¸ºå·²ç”¨å®Œ
  â†“
  status = 'CONSUMED'
```

#### å…³é”®è¡¨å…³ç³»

```
material_batches (ç‰©æ–™æ‰¹æ¬¡è¡¨)
â”œâ”€ id: ç‰©æ–™æ‰¹æ¬¡ID
â”œâ”€ material_type_id: ç‰©æ–™ç±»å‹ (ç•ªèŒ„ã€ç›ã€ç³–ç­‰)
â”œâ”€ quantity: å½“å‰åº“å­˜
â”œâ”€ expiry_date: è¿‡æœŸæ—¥æœŸ â† FIFOçš„å…³é”®æ’åºå­—æ®µ
â”œâ”€ supplier_id: ä¾›åº”å•†
â””â”€ status: AVAILABLE / CONSUMED / EXPIRED

material_consumption_records (æ¶ˆè€—è®°å½•è¡¨)
â”œâ”€ id: æ¶ˆè€—è®°å½•ID
â”œâ”€ material_batch_id: FK â†’ material_batches
â”œâ”€ batch_id: FK â†’ production_batches (å…³è”å“ªä¸ªç”Ÿäº§æ‰¹æ¬¡)
â”œâ”€ quantity_consumed: æ¶ˆè€—æ•°é‡
â”œâ”€ consumption_date: æ¶ˆè€—æ—¥æœŸ
â””â”€ cost_per_unit: å•ä½æˆæœ¬ (åç»­è®¡ç®—æ€»æˆæœ¬)

production_batches
â”œâ”€ id: ç”Ÿäº§æ‰¹æ¬¡ID
â””â”€ åŒ…å«å…³è”çš„æ‰€æœ‰ç‰©æ–™æ¶ˆè€—è®°å½•
```

#### æˆæœ¬è®¡ç®—é›†æˆ

```
å½“è®¡ç®—æ‰¹æ¬¡æˆæœ¬æ—¶:

1. æŸ¥è¯¢è¯¥æ‰¹æ¬¡çš„æ‰€æœ‰ material_consumption_records
2. å¯¹æ¯æ¡æ¶ˆè€—è®°å½•:
   cost = quantity_consumed Ã— cost_per_unit
3. æ±‡æ€»æ‰€æœ‰ç‰©æ–™æˆæœ¬
4. å¾—åˆ°æ‰¹æ¬¡çš„æ€»ç‰©æ–™æˆæœ¬

ç¤ºä¾‹:
æ‰¹æ¬¡BATCH-20251121-001 çš„ç‰©æ–™æ¶ˆè€—:
  - ç•ªèŒ„ 50kg Ã— 10å…ƒ/kg = 500å…ƒ
  - ç› 2kg Ã— 5å…ƒ/kg = 10å…ƒ
  - ç³– 3kg Ã— 8å…ƒ/kg = 24å…ƒ
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  æ€»ç‰©æ–™æˆæœ¬ = 534å…ƒ
```

---

### 0.4 å…³é”®æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å®Œæ•´çš„æ‰¹æ¬¡æˆæœ¬è®¡ç®—ä¸AIåˆ†ææ•°æ®æµ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1ï¸âƒ£ æ•°æ®æ”¶é›†é˜¶æ®µ
   â”œâ”€ è€ƒå‹¤æ¨¡å—: time_clock_records, batch_work_sessions
   â”œâ”€ åº“å­˜æ¨¡å—: material_consumption_records
   â”œâ”€ è®¾å¤‡æ¨¡å—: equipment_usage_records
   â”œâ”€ è´¨æ£€æ¨¡å—: quality_inspections
   â””â”€ ç”Ÿäº§æ¨¡å—: production_batches

      â†“ (å½“ç”Ÿäº§æ‰¹æ¬¡æ ‡è®°ä¸ºCOMPLETEDæ—¶)

2ï¸âƒ£ æˆæœ¬è®¡ç®—é˜¶æ®µ
   ProcessingServiceImpl.calculateBatchCost()
   â”œâ”€ äººå·¥æˆæœ¬ = Î£(batch_work_sessions.duration Ã— hourly_rate)
   â”œâ”€ è®¾å¤‡æˆæœ¬ = Î£(equipment_usage_records.duration Ã— depreciation_rate)
   â”œâ”€ ç‰©æ–™æˆæœ¬ = Î£(material_consumption_records.quantity Ã— unit_cost)
   â””â”€ æ€»æˆæœ¬ = äººå·¥ + è®¾å¤‡ + ç‰©æ–™

      â†“ ä¿å­˜åˆ° batch_cost_analysis è¡¨

3ï¸âƒ£ AIåˆ†æè§¦å‘é˜¶æ®µ
   å½“æ‰¹æ¬¡å®Œæˆ && æˆæœ¬è®¡ç®—å®Œæˆ
   â”œâ”€ è°ƒç”¨ AIEnterpriseService.analyzeTimeRangeCost()
   â”œâ”€ æ„é€ æç¤ºè¯: formatTimeRangePrompt()
   â”œâ”€ è°ƒç”¨DeepSeek LLM (Python FastAPI port 8085)
   â””â”€ æ£€æŸ¥ç¼“å­˜(7å¤©): ç›¸åŒæ•°æ®èŒƒå›´çš„åˆ†æç»“æœå¯å¤ç”¨

      â†“ ä¿å­˜åˆ†æç»“æœåˆ° ai_analysis_results è¡¨

4ï¸âƒ£ ç»“æœå±•ç¤ºé˜¶æ®µ
   å‰ç«¯è°ƒç”¨ aiApiClient.analyzeTimeRangeCost()
   â”œâ”€ è·å–æˆæœ¬æ•°æ®
   â”œâ”€ è·å–AIåˆ†æç»“æœ
   â”œâ”€ åœ¨ TimeRangeCostAnalysisScreen å±•ç¤º
   â””â”€ ç”¨æˆ·å¯å¯¼å‡ºæˆ–åˆ†äº«

æ•°æ®åº“è¡¨ä¾èµ–å…³ç³»:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ production_batches   â”‚
â”‚ (æ ¸å¿ƒä¸šåŠ¡å¯¹è±¡)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 1:N
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“             â†“          â†“          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚batch_work   â”‚ â”‚equipment_    â”‚ â”‚material_     â”‚ â”‚quality_      â”‚
â”‚_sessions    â”‚ â”‚usage_records â”‚ â”‚consumption   â”‚ â”‚inspections   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                 â”‚                â”‚                â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚batch_cost_       â”‚
      â”‚analysis          â”‚ (æˆæœ¬æ±‡æ€»)
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ai_analysis_      â”‚
      â”‚results           â”‚ (AIä¼˜åŒ–å»ºè®®)
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. è®¤è¯ä¸æƒé™æ¨¡å—

### æ¨¡å—æè¿°
è®¤è¯ä¸æƒé™ç³»ç»Ÿæ˜¯æ•´ä¸ªå¹³å°çš„åŸºç¡€,æä¾›:
- ç»Ÿä¸€ç™»å½•å…¥å£ (åŒºåˆ†å¹³å°ç®¡ç†å‘˜å’Œå·¥å‚ç”¨æˆ·)
- å¤šè§’è‰²æƒé™ç®¡ç† (7ç§è§’è‰²)
- Tokenç®¡ç†å’Œè‡ªåŠ¨åˆ·æ–°
- è®¾å¤‡ç»‘å®šå’Œæ¿€æ´»

### 1.1 ç»Ÿä¸€ç™»å½•

**ä¸šåŠ¡åœºæ™¯**:
å·¥å‚é‡Œçš„å‘˜å·¥å’Œå¹³å°ç®¡ç†å‘˜ä½¿ç”¨åŒä¸€å¥—APP,ä½†ç™»å½•åè¿›å…¥ä¸åŒçš„ç•Œé¢å’ŒåŠŸèƒ½ã€‚ç³»ç»Ÿéœ€è¦è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·ç±»å‹ã€‚

**åŠŸèƒ½æµç¨‹**:
```
ç”¨æˆ·è¾“å…¥ç”¨æˆ·å/å¯†ç  â†’ å‘é€ç™»å½•è¯·æ±‚ â†’ ç³»ç»ŸæŸ¥è¯¢ç”¨æˆ·è¡¨ â†’
è‡ªåŠ¨åˆ¤æ–­è§’è‰²ç±»å‹ â†’ è¿”å›ä¸åŒçš„èœå•å’Œæƒé™ â†’ è·¯ç”±åˆ°å¯¹åº”é¦–é¡µ
```

**å‰ç«¯å®ç°**:
| æ–‡ä»¶ | è¯´æ˜ | å…³é”®ä»£ç  |
|------|------|---------|
| `src/screens/auth/EnhancedLoginScreen.tsx` | ç™»å½•UI (ç»Ÿä¸€å…¥å£) | ~400è¡Œ |
| `src/services/auth/authService.ts` | è®¤è¯é€»è¾‘ | ~250è¡Œ |
| `src/services/api/apiClient.ts` | APIå®¢æˆ·ç«¯ | è¯·æ±‚æ‹¦æˆªå™¨ |
| `src/store/authStore.ts` | è®¤è¯çŠ¶æ€ (Zustand) | ç”¨æˆ·ä¿¡æ¯ã€Token |

**åç«¯å®ç°**:
| æ–‡ä»¶ | è¯´æ˜ | è¡Œæ•° |
|------|------|------|
| `controller/MobileController.java` | ç™»å½•API | 603è¡Œ |
| `service/AuthService.java` | ä¸šåŠ¡é€»è¾‘ | ~200è¡Œ |
| `security/JwtTokenProvider.java` | Tokenç®¡ç† | ~150è¡Œ |

**APIç«¯ç‚¹**:
```
POST /api/mobile/auth/unified-login
```

**è¯·æ±‚ä½“**:
```json
{
  "username": "admin",
  "password": "Admin@123456",
  "deviceId": "UUID-xxx-xxx",
  "deviceInfo": {
    "model": "iPhone 13",
    "os": "iOS 16.0"
  }
}
```

**æˆåŠŸå“åº” (å¹³å°ç®¡ç†å‘˜)**:
```json
{
  "code": 200,
  "data": {
    "user": {
      "id": 1,
      "username": "admin",
      "roleCode": "platform_admin",
      "fullName": "ç³»ç»Ÿç®¡ç†å‘˜",
      "factoryId": null,
      "permissions": ["manage_factories", "manage_users", "view_reports"]
    },
    "tokens": {
      "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "expiresIn": 86400
    },
    "userType": "platform",
    "nextScreen": "PlatformDashboard"
  }
}
```

**æˆåŠŸå“åº” (å·¥å‚ç”¨æˆ·)**:
```json
{
  "code": 200,
  "data": {
    "user": {
      "id": 10,
      "username": "factory_admin",
      "roleCode": "factory_admin",
      "fullName": "å·¥å‚ç®¡ç†å‘˜",
      "factoryId": "CRETAS_2024_001",
      "permissions": ["create_batch", "manage_staff", "view_costs"]
    },
    "tokens": {
      "accessToken": "...",
      "refreshToken": "...",
      "expiresIn": 86400
    },
    "userType": "factory",
    "nextScreen": "FactoryDashboard"
  }
}
```

**æ•°æ®åº“è¡¨**:
- `users` - æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯
- `user_roles` - ç”¨æˆ·è§’è‰²å…³ç³»
- `permissions` - æƒé™å®šä¹‰
- `user_sessions` - ä¼šè¯è®°å½•

**è®¤è¯æµç¨‹å›¾**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¾“å…¥ç”¨æˆ·å  â”‚
â”‚ è¾“å…¥å¯†ç     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /auth/login     â”‚
â”‚ (å‘é€ç”¨æˆ·å+å¯†ç )    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç«¯éªŒè¯:                            â”‚
â”‚ 1. æŸ¥è¯¢usersè¡¨                       â”‚
â”‚ 2. éªŒè¯å¯†ç (BCrypt)                  â”‚
â”‚ 3. æŸ¥è¯¢ç”¨æˆ·çš„è§’è‰²å’Œæƒé™             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ ç™»å½•å¤±è´¥? â”€â”€â†’ è¿”å› 401 Unauthorized
       â”‚
       â†“ ç™»å½•æˆåŠŸ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”ŸæˆToken:                          â”‚
â”‚ 1. AccessToken (24å°æ—¶æœ‰æ•ˆ)        â”‚
â”‚ 2. RefreshToken (7å¤©æœ‰æ•ˆ)          â”‚
â”‚ 3. DeviceToken (ç»‘å®šè®¾å¤‡)          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ä¿å­˜Token:                       â”‚
â”‚ 1. AccessToken â†’ SecureStore        â”‚
â”‚ 2. RefreshToken â†’ SecureStore       â”‚
â”‚ 3. æ›´æ–°authStore (Zustand)          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è·¯ç”±åˆ¤æ–­:                            â”‚
â”‚ if (roleCode === 'platform_admin')   â”‚
â”‚   â†’ è·³è½¬PlatformDashboard           â”‚
â”‚ else if (factoryId)                  â”‚
â”‚   â†’ è·³è½¬FactoryDashboard            â”‚
â”‚ else                                  â”‚
â”‚   â†’ è·³è½¬WorkerDashboard             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 1.2 æƒé™ä½“ç³» (7ç§è§’è‰²)

**è§’è‰²å®šä¹‰**:

| è§’è‰²ä»£ç  | è§’è‰²å | é€‚ç”¨è€… | å…³é”®æƒé™ |
|---------|--------|--------|---------|
| `platform_admin` | å¹³å°ç®¡ç†å‘˜ | å…¬å¸æŠ€æœ¯äººå‘˜ | ç®¡ç†æ‰€æœ‰å·¥å‚ã€ç”¨æˆ·ã€é…ç½®ç³»ç»Ÿ |
| `factory_super_admin` | å·¥å‚è¶…çº§ç®¡ç†å‘˜ | å·¥å‚å‚é•¿ | å·¥å‚çš„æ‰€æœ‰æƒé™ |
| `factory_admin` | å·¥å‚ç®¡ç†å‘˜ | å·¥å‚å‰¯å‚é•¿ | æ—¥å¸¸è¿è¥ã€äººå‘˜ç®¡ç†ã€æˆæœ¬åˆ†æ |
| `department_admin` | éƒ¨é—¨ä¸»ä»» | è½¦é—´ä¸»ä»» | éƒ¨é—¨çš„å·¥äººç®¡ç†ã€æ‰¹æ¬¡å®¡æ ¸ |
| `supervisor` | ç­ç»„é•¿ | ç­ç»„é•¿ | å·¥äººæ‰“å¡å®¡æ ¸ã€æ‰¹æ¬¡æŒ‡æ´¾ |
| `operator` | æ“ä½œå‘˜ | æ™®é€šå·¥äºº | æ‰“å¡ã€å‚ä¸ç”Ÿäº§ |
| `viewer` | æŸ¥çœ‹è€… | è®¿å®¢ã€ç¨½æŸ¥å‘˜ | åªè¯»æƒé™,æŸ¥çœ‹æŠ¥è¡¨ |

**æƒé™çŸ©é˜µ** (éƒ¨åˆ†ç¤ºä¾‹):

| åŠŸèƒ½ | platform_admin | factory_super | factory_admin | dept_admin | supervisor | operator | viewer |
|------|---|---|---|---|---|---|---|
| ç®¡ç†å·¥å‚ | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ |
| ç®¡ç†å‘˜å·¥ | âœ… | âœ… | âœ… | âœ… | âŒ | âŒ | âŒ |
| åˆ›å»ºæ‰¹æ¬¡ | âŒ | âœ… | âœ… | âœ… | âŒ | âŒ | âŒ |
| å‘˜å·¥æ‰“å¡ | âŒ | âœ… | âœ… | âœ… | âœ… | âœ… | âŒ |
| æŸ¥çœ‹æˆæœ¬ | âœ… | âœ… | âœ… | âœ… | âŒ | âŒ | âœ… (åªè¯») |
| AIåˆ†æ | âœ… | âœ… | âœ… | âŒ | âŒ | âŒ | âŒ |

**å‰ç«¯æƒé™å®ˆå«ç¤ºä¾‹**:
```typescript
// PermissionGuard.tsx - ä¿æŠ¤é¡µé¢
<PermissionGuard requiredRoles={['factory_admin', 'factory_super_admin']}>
  <CostAnalysisScreen />
</PermissionGuard>

// æˆ–ä½¿ç”¨Hook
const canViewCosts = usePermission(['factory_admin', 'factory_super_admin']);
if (!canViewCosts) {
  return <AccessDeniedScreen />;
}
```

**åç«¯æƒé™éªŒè¯**:
```java
@PreAuthorize("hasAnyRole('FACTORY_ADMIN', 'FACTORY_SUPER_ADMIN')")
@GetMapping("/batches/costs")
public ResponseEntity<?> getBatchCosts() {
  // ...
}
```

---

### 1.3 Tokenç®¡ç†ä¸è‡ªåŠ¨åˆ·æ–°

**Tokenç±»å‹**:

| Tokenç±»å‹ | æœ‰æ•ˆæœŸ | ç”¨é€” | å­˜å‚¨ä½ç½® |
|----------|--------|------|---------|
| AccessToken | 24å°æ—¶ | æ¯æ¬¡APIè¯·æ±‚ | SecureStore |
| RefreshToken | 7å¤© | åˆ·æ–°AccessToken | SecureStore |
| TempToken | 10åˆ†é’Ÿ | ä¸´æ—¶æ“ä½œ(å¦‚ä¿®æ”¹å¯†ç ) | å†…å­˜ |
| DeviceToken | é•¿æœŸ | è®¾å¤‡ç»‘å®š | SecureStore |

**è‡ªåŠ¨åˆ·æ–°æµç¨‹**:
```
ç”¨æˆ·å‘é€APIè¯·æ±‚
  â†“
  AccessToken æœ‰æ•ˆ? âœ…
  â”œâ”€ YES â†’ ç»§ç»­è¯·æ±‚,è¿”å›200
  â””â”€ NO (401 Unauthorized)
       â†“
    æ£€æŸ¥ RefreshToken
      â”œâ”€ RefreshToken æœ‰æ•ˆ? âœ…
      â”‚  YES â†’
      â”‚    â”œâ”€ è°ƒç”¨ POST /api/auth/refresh
      â”‚    â”œâ”€ è·å–æ–° AccessToken
      â”‚    â”œâ”€ ä¿å­˜åˆ° SecureStore
      â”‚    â”œâ”€ é‡æ–°å‘é€åŸè¯·æ±‚
      â”‚    â””â”€ è¿”å›200
      â”‚
      â””â”€ RefreshToken è¿‡æœŸæˆ–ä¸å­˜åœ¨? âŒ
         â”œâ”€ è·³è½¬ç™»å½•é¡µé¢
         â””â”€ æ¸…é™¤æœ¬åœ°æ•°æ®
```

**å®ç°ä»£ç ** (Axiosæ‹¦æˆªå™¨):
```typescript
// apiClient.ts
apiClient.interceptors.response.use(
  (response) => response,
  async (error) => {
    const originalRequest = error.config;

    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true;

      try {
        const refreshToken = await SecureStore.getItemAsync('refreshToken');
        const response = await apiClient.post('/auth/refresh',
          { deviceId: DeviceInfo.deviceId },
          { headers: { 'Authorization': `Bearer ${refreshToken}` } }
        );

        const { accessToken } = response.data.data;
        await SecureStore.setItemAsync('accessToken', accessToken);

        originalRequest.headers['Authorization'] = `Bearer ${accessToken}`;
        return apiClient(originalRequest);
      } catch (refreshError) {
        // Tokenæ— æ³•åˆ·æ–°,é‡æ–°ç™»å½•
        authStore.logout();
        navigation.reset({ index: 0, routes: [{ name: 'Login' }] });
      }
    }
    return Promise.reject(error);
  }
);
```

---

## 2. è€ƒå‹¤ç®¡ç†æ¨¡å—

### æ¨¡å—æè¿°
è€ƒå‹¤ç®¡ç†æ¨¡å—å®ç°å‘˜å·¥çš„å·¥ä½œæ—¶é—´è¿½è¸ª,åŒ…æ‹¬ä¸Šç­æ‰“å¡ã€ä¸‹ç­æ‰“å¡ã€ä¸­é€”ä¼‘æ¯ç­‰ã€‚è¿™æ˜¯**æ—¶é—´æˆæœ¬è®¡ç®—**çš„æ•°æ®æ¥æºã€‚

### 2.1 æ‰“å¡åŠŸèƒ½

**ä¸šåŠ¡åœºæ™¯**:
å‘˜å·¥è¿›å‚å’Œç¦»å‚éƒ½è¦æ‰“å¡,ç³»ç»Ÿè‡ªåŠ¨è®°å½•ä½ç½®å’Œæ—¶é—´,ç”¨äºåç»­çš„æˆæœ¬è®¡ç®—å’Œå·¥èµ„ç»Ÿè®¡ã€‚

**æ‰“å¡æµç¨‹**:
```
å‘˜å·¥æ‰“å¼€APP â†’ è¿›å…¥"è€ƒå‹¤"é¡µé¢ â†’ ç‚¹å‡»"ä¸Šç­æ‰“å¡"æŒ‰é’®
  â†“
ç³»ç»Ÿè¯»å–å½“å‰æ—¶é—´å’ŒGPSä½ç½®
  â†“
å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡† (æ˜¾ç¤ºæ—¶é—´ã€åœ°ç‚¹ã€å¤©æ°”ç­‰)
  â†“
ç”¨æˆ·ç¡®è®¤ â†’ å‘é€æ‰“å¡è¯·æ±‚
  â†“
API POST /api/mobile/{factoryId}/attendance/clock-in
  â†“
åç«¯ä¿å­˜åˆ° time_clock_records è¡¨
  â†“
è‡ªåŠ¨åˆ›å»ºå…³è”çš„ batch_work_session (å¦‚æœæœ‰è¿›è¡Œä¸­çš„æ‰¹æ¬¡)
  â†“
è¿”å›æˆåŠŸæç¤º "ä»Šæ—¥ä¸Šç­æ‰“å¡æˆåŠŸ,å·²å½•å…¥ç³»ç»Ÿ"
```

**å‰ç«¯æ–‡ä»¶**:
- `src/screens/attendance/TimeClockScreen.tsx` - æ‰“å¡UI
- `src/screens/attendance/AttendanceStatisticsScreen.tsx` - æ‰“å¡ç»Ÿè®¡
- `src/services/api/attendanceApiClient.ts` - APIè°ƒç”¨

**åç«¯æ–‡ä»¶**:
- `controller/AttendanceController.java` - æ‰“å¡API
- `service/impl/TimeclockServiceImpl.java` - æ‰“å¡é€»è¾‘
- `entity/TimeClockRecord.java` - æ‰“å¡æ•°æ®æ¨¡å‹

**æ•°æ®åº“è¡¨**:
```sql
CREATE TABLE time_clock_records (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  factory_id VARCHAR(50) NOT NULL,
  clock_in_time TIMESTAMP,
  clock_out_time TIMESTAMP,
  clock_in_location VARCHAR(100),      -- GPSåæ ‡ "31.2304,121.4737"
  clock_out_location VARCHAR(100),
  total_hours DECIMAL(5,2),             -- è‡ªåŠ¨è®¡ç®—
  status ENUM('CLOCKED_IN', 'CLOCKED_OUT'),
  remarks VARCHAR(200),
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

**APIç«¯ç‚¹**:
```
# ä¸Šç­æ‰“å¡
POST /api/mobile/{factoryId}/attendance/clock-in
è¯·æ±‚ä½“:
{
  "location": "31.2304,121.4737",
  "deviceId": "device-uuid"
}

å“åº”:
{
  "code": 200,
  "data": {
    "clockInTime": "2025-11-21T08:00:00",
    "batchId": 1,                    // å¦‚æœæœ‰è¿›è¡Œä¸­çš„æ‰¹æ¬¡
    "batchNumber": "BATCH-20251121-001",
    "message": "æ‰“å¡æˆåŠŸ,å·²å…³è”åˆ°ç”Ÿäº§æ‰¹æ¬¡"
  }
}

# ä¸‹ç­æ‰“å¡
POST /api/mobile/{factoryId}/attendance/clock-out
è¯·æ±‚ä½“:
{
  "location": "31.2304,121.4737"
}

å“åº”:
{
  "code": 200,
  "data": {
    "clockOutTime": "2025-11-21T16:00:00",
    "totalHours": 8,
    "workSessions": [
      {
        "batchNumber": "BATCH-20251121-001",
        "duration": 8,
        "laborCost": 100
      }
    ],
    "totalDailyCost": 100
  }
}
```

---

### 2.2 å·¥ä½œä¼šè¯ç®¡ç†

**æ¦‚å¿µ**:
ä¸€ä¸ª"å·¥ä½œä¼šè¯"(work session) æ˜¯å‘˜å·¥åœ¨æŸä¸ªç”Ÿäº§æ‰¹æ¬¡ä¸Šçš„ä¸€æ®µè¿ç»­å·¥ä½œæ—¶é—´ã€‚å½“å‘˜å·¥æ‰“å¡æ—¶,ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºæˆ–æ›´æ–°å·¥ä½œä¼šè¯ã€‚

**å·¥ä½œä¼šè¯ç”Ÿå‘½å‘¨æœŸ**:
```
08:00 å‘˜å·¥ä¸Šç­æ‰“å¡
  â†“
ç³»ç»ŸæŸ¥è¯¢: å½“å‰æœ‰è¿›è¡Œä¸­çš„æ‰¹æ¬¡å—?
  â”œâ”€ æœ‰: åˆ›å»º batch_work_session
  â”‚      {batch_id: 1, user_id: 4, start_time: 08:00, status: IN_PROGRESS}
  â””â”€ æ— : ç­‰å¾…åç»­åˆ†é…

  â†“
12:00 ç³»ç»Ÿæˆ–ç®¡ç†å‘˜å°†å‘˜å·¥è½¬ç§»åˆ°å…¶ä»–æ‰¹æ¬¡
  â”œâ”€ æ›´æ–°session1: end_time = 12:00, status = COMPLETED
  â”œâ”€ è®¡ç®—: duration = 4å°æ—¶, labor_cost = (æ—¥è–ª / 24) Ã— 4
  â””â”€ åˆ›å»ºsession2: batch_id = 2, start_time = 12:00

  â†“
16:00 å‘˜å·¥ä¸‹ç­æ‰“å¡
  â”œâ”€ æ›´æ–°session2: end_time = 16:00, status = COMPLETED
  â”œâ”€ è®¡ç®—: duration = 4å°æ—¶, labor_cost = (æ—¥è–ª / 24) Ã— 4
  â””â”€ è§¦å‘æ‰¹æ¬¡æˆæœ¬è®¡ç®—
```

**å…³é”®è¡¨**:
```sql
CREATE TABLE batch_work_sessions (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  batch_id BIGINT NOT NULL,
  user_id BIGINT NOT NULL,
  factory_id VARCHAR(50) NOT NULL,
  start_time TIMESTAMP NOT NULL,
  end_time TIMESTAMP,
  duration_hours DECIMAL(5,2),        -- (end_time - start_time) / 3600
  labor_cost DECIMAL(12,2),            -- è‡ªåŠ¨è®¡ç®—: (daily_salary / 24) Ã— duration_hours
  status ENUM('IN_PROGRESS', 'COMPLETED'),
  created_at TIMESTAMP,
  updated_at TIMESTAMP,

  FOREIGN KEY (batch_id) REFERENCES production_batches(id),
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

---

## 3. ç”Ÿäº§åŠ å·¥æ¨¡å—

### æ¨¡å—æè¿°
ç”Ÿäº§åŠ å·¥æ¨¡å—æ˜¯æ•´ä¸ªç³»ç»Ÿçš„**æ ¸å¿ƒä¸šåŠ¡é©±åŠ¨å™¨**ã€‚å®ƒ:
1. ç®¡ç†ç”Ÿäº§æ‰¹æ¬¡çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
2. åè°ƒå…¶ä»–æ¨¡å—(è€ƒå‹¤ã€åº“å­˜ã€è®¾å¤‡ã€è´¨æ£€)çš„æ•°æ®
3. è§¦å‘æˆæœ¬è®¡ç®—å’ŒAIåˆ†æ

### 3.1 ç”Ÿäº§æ‰¹æ¬¡ç®¡ç†

**æ‰¹æ¬¡ç”Ÿå‘½å‘¨æœŸ**:
```
åˆ›å»º (CREATED)
  â†“ (è®¾ç½®è®¡åˆ’å’Œèµ„æº)
è¿›è¡Œä¸­ (IN_PROGRESS)
  â†“ (æ‰€æœ‰å·¥ä½œå®Œæˆ)
è´¨æ£€ä¸­ (QUALITY_CHECKING)
  â†“ (è´¨æ£€é€šè¿‡)
å·²å®Œæˆ (COMPLETED) â†’ è§¦å‘æˆæœ¬è®¡ç®— + AIåˆ†æ
  â†“
å·²äº¤ä»˜ (DELIVERED)
```

**å…³é”®è¡¨**:
```sql
CREATE TABLE production_batches (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  batch_number VARCHAR(50) NOT NULL UNIQUE,  -- BATCH-20251121-001
  product_type_id VARCHAR(50),
  factory_id VARCHAR(50) NOT NULL,
  status ENUM('CREATED', 'IN_PROGRESS', 'QUALITY_CHECKING', 'COMPLETED', 'DELIVERED'),

  -- è®¡åˆ’ä¿¡æ¯
  planned_quantity DECIMAL(12,2),
  unit VARCHAR(20),  -- kg, L, ä¸ª ç­‰
  start_date TIMESTAMP,
  end_date TIMESTAMP,

  -- å®é™…å®Œæˆä¿¡æ¯
  actual_quantity DECIMAL(12,2),
  actual_start TIMESTAMP,
  actual_end TIMESTAMP,

  -- èµ„æºä¿¡æ¯
  supervisor_id BIGINT,
  location VARCHAR(100),

  -- æˆæœ¬ä¿¡æ¯
  total_cost DECIMAL(12,2),              -- è‡ªåŠ¨è®¡ç®—
  labor_cost DECIMAL(12,2),
  equipment_cost DECIMAL(12,2),
  material_cost DECIMAL(12,2),

  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

**åˆ›å»ºæ‰¹æ¬¡API**:
```
POST /api/mobile/{factoryId}/processing/batches

è¯·æ±‚ä½“:
{
  "productTypeId": "PROD-001",
  "batchNumber": "BATCH-20251121-001",
  "plannedQuantity": 500,
  "unit": "kg",
  "supervisorId": 1,
  "location": "ç”Ÿäº§çº¿A"
}

å“åº”:
{
  "code": 200,
  "data": {
    "id": 1,
    "batchNumber": "BATCH-20251121-001",
    "status": "IN_PROGRESS",
    "createdAt": "2025-11-21T08:00:00"
  }
}
```

---

### 3.2 æ‰¹æ¬¡æˆæœ¬è‡ªåŠ¨è®¡ç®—

**è§¦å‘æ¡ä»¶**:
å½“æ‰¹æ¬¡æ ‡è®°ä¸º `COMPLETED` æˆ– `DELIVERED` æ—¶,ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—æˆæœ¬ã€‚

**æˆæœ¬è®¡ç®—ç®—æ³•** (åç«¯ProcessingServiceImpl):

```java
public BigDecimal calculateBatchCost(Long batchId) {
  // 1. è·å–ç”Ÿäº§æ‰¹æ¬¡ä¿¡æ¯
  ProductionBatch batch = productionBatchRepository.findById(batchId);

  // 2. è®¡ç®—äººå·¥æˆæœ¬
  List<BatchWorkSession> sessions = batchWorkSessionRepository
    .findByBatchId(batchId);
  BigDecimal laborCost = BigDecimal.ZERO;
  for (BatchWorkSession session : sessions) {
    BigDecimal hourlyRate = getHourlyRate(session.getUserId());
    BigDecimal hours = BigDecimal.valueOf(session.getDurationHours());
    laborCost = laborCost.add(hourlyRate.multiply(hours));
  }

  // 3. è®¡ç®—è®¾å¤‡æˆæœ¬
  List<EquipmentUsageRecord> usages = equipmentUsageRepository
    .findByBatchId(batchId);
  BigDecimal equipmentCost = BigDecimal.ZERO;
  for (EquipmentUsageRecord usage : usages) {
    Equipment equipment = equipmentRepository.findById(usage.getEquipmentId());
    BigDecimal depreciation = equipment.getDailyDepreciation()
      .divide(BigDecimal.valueOf(24), 2, RoundingMode.HALF_UP);
    BigDecimal hours = BigDecimal.valueOf(usage.getDurationHours());
    equipmentCost = equipmentCost.add(depreciation.multiply(hours));
  }

  // 4. è®¡ç®—ç‰©æ–™æˆæœ¬
  List<MaterialConsumptionRecord> materials = materialConsumptionRepository
    .findByBatchId(batchId);
  BigDecimal materialCost = BigDecimal.ZERO;
  for (MaterialConsumptionRecord material : materials) {
    BigDecimal quantity = BigDecimal.valueOf(material.getQuantityConsumed());
    BigDecimal unitCost = material.getUnitCost();
    materialCost = materialCost.add(quantity.multiply(unitCost));
  }

  // 5. æ±‡æ€»æˆæœ¬
  BigDecimal totalCost = laborCost
    .add(equipmentCost)
    .add(materialCost);

  // 6. ä¿å­˜åˆ°æ•°æ®åº“
  batch.setLaborCost(laborCost);
  batch.setEquipmentCost(equipmentCost);
  batch.setMaterialCost(materialCost);
  batch.setTotalCost(totalCost);
  productionBatchRepository.save(batch);

  // 7. è§¦å‘AIåˆ†æ (å¼‚æ­¥)
  aiService.analyzeCompletedBatch(batchId);

  return totalCost;
}
```

**å‰ç«¯æˆæœ¬å±•ç¤º** (TimeRangeCostAnalysisScreen.tsx):
```typescript
const fetchCostAnalysis = async () => {
  // 1. è·å–æ—¶é—´èŒƒå›´å†…çš„æ‰€æœ‰æ‰¹æ¬¡æˆæœ¬
  const response = await processingApiClient.getTimeRangeCostAnalysis({
    factoryId,
    startDate: '2025-11-01',
    endDate: '2025-11-30',
    pageSize: 10
  });

  const { batches, summary } = response.data;

  // 2. å±•ç¤ºæ±‡æ€»
  // æ€»æˆæœ¬: 10,500å…ƒ
  // äººå·¥å æ¯”: 35%
  // è®¾å¤‡å æ¯”: 15%
  // ç‰©æ–™å æ¯”: 50%

  // 3. è·å–AIåˆ†æ
  const aiAnalysis = await aiApiClient.analyzeTimeRangeCost({
    startDate: '2025-11-01',
    endDate: '2025-11-30'
  });

  // 4. å±•ç¤ºä¼˜åŒ–å»ºè®®
  // "æ ¹æ®åˆ†æ,è¿‡å»30å¤©ç‰©æ–™æˆæœ¬å æ¯”æœ€å¤§(50%),å»ºè®®..."
};
```

---

## 4. AIæ™ºèƒ½åˆ†ææ¨¡å—

### æ¨¡å—æè¿°
AIæ¨¡å—é›†æˆDeepSeekå¤§è¯­è¨€æ¨¡å‹,å¯¹ç”Ÿäº§æ•°æ®è¿›è¡Œæ·±åº¦åˆ†æ,æä¾›æˆæœ¬ä¼˜åŒ–å»ºè®®ã€‚

### 4.1 æˆæœ¬åˆ†æä¸ä¼˜åŒ–å»ºè®®

**è§¦å‘æ¡ä»¶**:
- å½“ç”Ÿäº§æ‰¹æ¬¡å®Œæˆä¸”æˆæœ¬è®¡ç®—å®Œæˆæ—¶,è‡ªåŠ¨è§¦å‘
- æˆ–ç”¨æˆ·ä¸»åŠ¨åœ¨UIä¸­è¯·æ±‚åˆ†æ

**å®Œæ•´æµç¨‹**:
```
1ï¸âƒ£ ç”¨æˆ·æ‰“å¼€ TimeRangeCostAnalysisScreen
   â†“
2ï¸âƒ£ å‰ç«¯å‘é€è¯·æ±‚:
   POST /api/mobile/{factoryId}/ai/analyze-cost
   {
     "startDate": "2025-11-01",
     "endDate": "2025-11-30",
     "analysisType": "detailed"
   }

   â†“
3ï¸âƒ£ åç«¯å¤„ç† (AIController):
   a) æ£€æŸ¥ç¼“å­˜: ç›¸åŒæ—¥æœŸèŒƒå›´çš„åˆ†ææ˜¯å¦å­˜åœ¨?
      - YES (ä¸”<7å¤©) â†’ ç›´æ¥è¿”å›ç¼“å­˜ç»“æœ
      - NO â†’ ç»§ç»­

   b) æ”¶é›†æ•°æ®:
      - æŸ¥è¯¢æ—¥æœŸèŒƒå›´å†…çš„æ‰€æœ‰æ‰¹æ¬¡
      - è®¡ç®—å„ç±»å‹æˆæœ¬å æ¯”
      - è·å–äº§é‡ã€æ•ˆç‡ç­‰æŒ‡æ ‡

   c) æ„é€ æç¤ºè¯ (formatTimeRangePrompt):
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ æˆ‘æ˜¯ä¸€å®¶é£Ÿå“å·¥å‚çš„æˆæœ¬åˆ†æå¸ˆã€‚     â”‚
      â”‚ è¯·åˆ†æè¿‡å»30å¤©çš„ç”Ÿäº§æˆæœ¬æ•°æ®:       â”‚
      â”‚                                      â”‚
      â”‚ æ€»æˆæœ¬: 10,500å…ƒ                    â”‚
      â”‚ æ€»äº§é‡: 2,000kg                     â”‚
      â”‚ å•ä½æˆæœ¬: 5.25å…ƒ/kg                â”‚
      â”‚                                      â”‚
      â”‚ æˆæœ¬æ„æˆ:                            â”‚
      â”‚ - äººå·¥æˆæœ¬: 3,675å…ƒ (35%)           â”‚
      â”‚ - è®¾å¤‡æˆæœ¬: 1,575å…ƒ (15%)           â”‚
      â”‚ - ç‰©æ–™æˆæœ¬: 5,250å…ƒ (50%)           â”‚
      â”‚                                      â”‚
      â”‚ å…³é”®æŒ‡æ ‡:                            â”‚
      â”‚ - å¹³å‡æ•ˆç‡: 92%                     â”‚
      â”‚ - åºŸå“ç‡: 2%                        â”‚
      â”‚ - å¹³å‡æ‰¹æ¬¡å‘¨æœŸ: 8å°æ—¶              â”‚
      â”‚                                      â”‚
      â”‚ è¯·åˆ†æ:                              â”‚
      â”‚ 1. è¿™äº›æˆæœ¬åœ¨è¡Œä¸šä¸­æ˜¯å¦åˆç†?      â”‚
      â”‚ 2. æœ€å¤§çš„æˆæœ¬ä¼˜åŒ–ç©ºé—´åœ¨å“ªé‡Œ?      â”‚
      â”‚ 3. å…·ä½“çš„é™æœ¬æ–¹æ¡ˆæ˜¯ä»€ä¹ˆ?          â”‚
      â”‚ 4. é¢„æœŸèƒ½èŠ‚çœå¤šå°‘æˆæœ¬?             â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   d) è°ƒç”¨DeepSeek LLM (Python FastAPI):
      POST http://localhost:8085/ai/analyze
      {
        "prompt": "...ä¸Šé¢çš„æç¤ºè¯...",
        "model": "deepseek-chat",
        "temperature": 0.7,
        "max_tokens": 2000
      }

   e) è§£æLLMå“åº”:
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ ## æˆæœ¬åˆ†æç»“æœ                     â”‚
      â”‚                                      â”‚
      â”‚ ### 1. æˆæœ¬åˆç†æ€§è¯„ä¼°                â”‚
      â”‚ å•ä½æˆæœ¬5.25å…ƒ/kgä½äºè¡Œä¸šå¹³å‡å€¼... â”‚
      â”‚                                      â”‚
      â”‚ ### 2. ä¸»è¦ä¼˜åŒ–ç©ºé—´                  â”‚
      â”‚ ç‰©æ–™é‡‡è´­(50%) > äººå·¥(35%) > è®¾å¤‡... â”‚
      â”‚                                      â”‚
      â”‚ ### 3. å…·ä½“é™æœ¬æ–¹æ¡ˆ                  â”‚
      â”‚ a) ç‰©æ–™é‡‡è´­ç«¯:                      â”‚
      â”‚    - ä¸ä¾›åº”å•†è°ˆåˆ¤å¤§å®—ä¼˜æƒ           â”‚
      â”‚    - é¢„æœŸé™å¹…: 8-10%               â”‚
      â”‚                                      â”‚
      â”‚ b) äººå·¥ç«¯:                          â”‚
      â”‚    - ä¼˜åŒ–ç”Ÿäº§æµç¨‹,å‡å°‘æ—¶é—´æµªè´¹    â”‚
      â”‚    - é¢„æœŸé™å¹…: 5-8%               â”‚
      â”‚                                      â”‚
      â”‚ ### 4. é¢„æœŸæ•ˆç›Š                      â”‚
      â”‚ å¹´åº¦å¯èŠ‚çœ: 42,000 - 52,500å…ƒ      â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   f) ä¿å­˜åˆ†æç»“æœåˆ° ai_analysis_results è¡¨:
      {
        "analysisId": "UUID",
        "factoryId": "CRETAS_2024_001",
        "analysisType": "cost_analysis",
        "dateRange": "2025-11-01 to 2025-11-30",
        "input": "...æç¤ºè¯...",
        "output": "...LLMå“åº”...",
        "costImpact": "42000-52500",
        "confidence": "high",
        "createdAt": "2025-11-21T16:00:00",
        "cacheExpiresAt": "2025-11-28T16:00:00"  // 7å¤©ç¼“å­˜
      }

   â†“
4ï¸âƒ£ è¿”å›å‰ç«¯:
   {
     "code": 200,
     "data": {
       "analysis": "...ä¸Šé¢çš„LLMå“åº”...",
       "summary": {
         "mainOptimization": "ç‰©æ–™é‡‡è´­æˆæœ¬ä¼˜åŒ–",
         "expectedSavings": "42000-52500",
         "implementationDifficulty": "medium"
       },
       "cacheInfo": {
         "isCached": false,
         "expiresAt": "2025-11-28T16:00:00"
       }
     }
   }

   â†“
5ï¸âƒ£ å‰ç«¯å±•ç¤º:
   - å±•ç¤ºAIåˆ†æç»“æœ
   - é«˜äº®å…³é”®æ•°å­—
   - æä¾›"å¯¼å‡º"ã€"åˆ†äº«"ã€"è¯¦ç»†é˜…è¯»"ç­‰æ“ä½œ
```

**å…³é”®æ–‡ä»¶**:
- å‰ç«¯: `src/screens/processing/DeepSeekAnalysisScreen.tsx`
- åç«¯: `controller/AIController.java`, `service/AIEnterpriseService.java`
- Python: `backend-java/backend-ai-chat/ai_service.py`

**æ•°æ®åº“**:
```sql
CREATE TABLE ai_analysis_results (
  id VARCHAR(50) PRIMARY KEY,
  factory_id VARCHAR(50) NOT NULL,
  analysis_type VARCHAR(50),  -- cost_analysis, efficiency_analysis, etc
  date_range_start DATE,
  date_range_end DATE,

  -- åˆ†æè¾“å…¥è¾“å‡º
  prompt_input LONGTEXT,
  analysis_output LONGTEXT,

  -- ä¼˜åŒ–æ•ˆæœ
  cost_impact VARCHAR(50),           -- "42000-52500"
  confidence_level VARCHAR(20),      -- high, medium, low

  -- ç¼“å­˜ç®¡ç†
  created_at TIMESTAMP,
  cache_expires_at TIMESTAMP,        -- 7å¤©ç¼“å­˜

  UNIQUE KEY unique_analysis (factory_id, analysis_type, date_range_start, date_range_end)
);
```

---

## 5. è®¾å¤‡ç®¡ç†æ¨¡å—

### æ¨¡å—æè¿°
è®¾å¤‡ç®¡ç†æ¨¡å—è®°å½•è®¾å¤‡çš„ä½¿ç”¨æƒ…å†µå’Œæˆæœ¬è®¡ç®—,æ˜¯**è®¾å¤‡æˆæœ¬**çš„æ•°æ®æ¥æºã€‚

### 5.1 è®¾å¤‡ä½¿ç”¨è®°å½•

**ä¸šåŠ¡æµç¨‹**:
```
æ“ä½œå‘˜æ‰“å¼€è®¾å¤‡ç®¡ç†é¡µé¢
  â†“
è¾“å…¥è®¾å¤‡ID (EQP-001 æ…æ‹Œæœº)
  â†“
ç‚¹å‡»"å¼€å§‹å·¥ä½œ" æŒ‰é’®
  â†“
ç³»ç»Ÿå¼¹å‡ºå¯¹è¯æ¡†:
  - ç¡®è®¤è®¾å¤‡ä¿¡æ¯
  - ç¡®è®¤å¼€å§‹æ—¶é—´ (è‡ªåŠ¨å¡«å……å½“å‰æ—¶é—´)
  - å…³è”ç”Ÿäº§æ‰¹æ¬¡
  â†“
ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤"
  â†“
API POST /api/mobile/{factoryId}/equipment/{equipmentId}/start
è¯·æ±‚ä½“:
{
  "batchId": 1,
  "startTime": "2025-11-21T08:30:00"
}

å“åº”:
{
  "code": 200,
  "data": {
    "usageRecordId": 100,
    "equipmentId": "EQP-001",
    "status": "RUNNING",
    "startTime": "2025-11-21T08:30:00"
  }
}

  â†“
è®¾å¤‡è¿è¡Œä¸­...
  â†“
è®¾å¤‡å·¥ä½œå®Œæˆ
  â†“
æ“ä½œå‘˜ç‚¹å‡»"åœæ­¢å·¥ä½œ"
  â†“
API POST /api/mobile/{factoryId}/equipment/{equipmentId}/stop
è¯·æ±‚ä½“:
{
  "usageRecordId": 100,
  "endTime": "2025-11-21T16:30:00",
  "notes": "å®Œæˆç•ªèŒ„é…±çŒè£…"
}

å“åº”:
{
  "code": 200,
  "data": {
    "usageRecordId": 100,
    "duration": 8,          // å°æ—¶
    "cost": 166.64,        // æŠ˜æ—§æˆæœ¬
    "status": "COMPLETED"
  }
}
```

**å…³é”®è¡¨**:
```sql
CREATE TABLE equipment_usage_records (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  equipment_id VARCHAR(50) NOT NULL,
  factory_id VARCHAR(50) NOT NULL,
  batch_id BIGINT,                  -- å…³è”ç”Ÿäº§æ‰¹æ¬¡

  start_time TIMESTAMP NOT NULL,
  end_time TIMESTAMP,
  duration_hours DECIMAL(5,2),      -- è‡ªåŠ¨è®¡ç®—

  operator_id BIGINT,
  notes VARCHAR(200),

  -- æˆæœ¬è®¡ç®—
  hourly_depreciation DECIMAL(12,2),
  equipment_cost DECIMAL(12,2),     -- duration Ã— hourly_depreciation

  status ENUM('RUNNING', 'COMPLETED'),
  created_at TIMESTAMP
);

CREATE TABLE equipment_depreciation (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  equipment_id VARCHAR(50) NOT NULL,

  -- æŠ˜æ—§ä¿¡æ¯
  purchase_date DATE,
  purchase_price DECIMAL(12,2),
  useful_life_years INT,            -- ä½¿ç”¨å¹´é™

  -- è®¡ç®—å­—æ®µ
  monthly_depreciation DECIMAL(12,2),   -- æ¯æœˆæŠ˜æ—§ = è´­å…¥ä»· / (12 Ã— useful_life)
  daily_depreciation DECIMAL(12,2),     -- æ¯æ—¥æŠ˜æ—§ = æœˆæŠ˜æ—§ / 30
  hourly_depreciation DECIMAL(12,2),    -- æ¯å°æ—¶æŠ˜æ—§ = æ—¥æŠ˜æ—§ / 24

  updated_at TIMESTAMP
);
```

---

## 6. åº“å­˜ç®¡ç†æ¨¡å—

### æ¨¡å—æè¿°
åº“å­˜ç®¡ç†æ¨¡å—å®ç°FIFO(å…ˆè¿›å…ˆå‡º)åº“å­˜æ¨è,ç¡®ä¿å…ˆåˆ°æœŸçš„ç‰©æ–™ä¼˜å…ˆä½¿ç”¨ã€‚

### 6.1 FIFOåº“å­˜æ¨è

**ä¸šåŠ¡æµç¨‹**:
```
ç”Ÿäº§ä¸»ç®¡å‡†å¤‡å¼€å§‹ç”Ÿäº§
  â†“
æ‰“å¼€åº“å­˜ç•Œé¢
  â†“
é€‰æ‹©éœ€è¦çš„ç‰©æ–™ç±»å‹ (ç•ªèŒ„)
  â†“
ç³»ç»ŸæŸ¥è¯¢è¯¥ç‰©æ–™çš„æ‰€æœ‰æ‰¹æ¬¡:
  ç»“æœ: [
    {id: 1, expiryDate: 2025-12-01, quantity: 500},   â† æœ€æ—©è¿‡æœŸ
    {id: 2, expiryDate: 2025-12-15, quantity: 1000},
    {id: 3, expiryDate: 2026-01-10, quantity: 800}
  ]

  â†“
ç³»ç»ŸæŒ‰è¿‡æœŸæ—¥æœŸæ’åº

  â†“
ç³»ç»Ÿæ¨è: "æ¨èä½¿ç”¨æ‰¹æ¬¡1(2025-12-01è¿‡æœŸ),å½“å‰åº“å­˜500kg"

  â†“
ç”¨æˆ·è¾“å…¥éœ€è¦çš„æ•°é‡: 50kg

  â†“
ç‚¹å‡»"ç¡®è®¤ä½¿ç”¨"

  â†“
API POST /api/mobile/{factoryId}/material-batches/consume
è¯·æ±‚ä½“:
{
  "materialBatchId": 1,
  "quantityConsumed": 50,
  "batchId": 1,          // ç”Ÿäº§æ‰¹æ¬¡
  "consumedBy": 3        // æ“ä½œè€…
}

å“åº”:
{
  "code": 200,
  "data": {
    "consumptionRecordId": 500,
    "materialBatchId": 1,
    "quantityConsumed": 50,
    "remainingQuantity": 450,
    "unitCost": 10,
    "totalCost": 500
  }
}

  â†“
ç³»ç»Ÿè‡ªåŠ¨:
  1. åˆ›å»º material_consumption_records è®°å½•
  2. æ›´æ–° material_batches çš„åº“å­˜ (500 â†’ 450)
  3. å¦‚æœåº“å­˜ä¸º0,æ ‡è®°ä¸º CONSUMED
```

**å…³é”®è¡¨**:
```sql
CREATE TABLE material_batches (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  material_type_id VARCHAR(50) NOT NULL,
  factory_id VARCHAR(50) NOT NULL,

  -- åº“å­˜ä¿¡æ¯
  quantity DECIMAL(12,2) NOT NULL,
  unit VARCHAR(20),  -- kg, L, ä¸ª

  -- FIFOå…³é”®å­—æ®µ
  expiry_date DATE NOT NULL,         -- â† æ’åºå­—æ®µ
  purchase_date DATE,

  -- æˆæœ¬ä¿¡æ¯
  supplier_id BIGINT,
  unit_cost DECIMAL(12,2),
  total_cost DECIMAL(12,2),          -- quantity Ã— unit_cost

  -- çŠ¶æ€
  status ENUM('AVAILABLE', 'CONSUMED', 'EXPIRED'),

  created_at TIMESTAMP,
  updated_at TIMESTAMP,

  -- ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
  INDEX idx_material_expiry (material_type_id, expiry_date)
);

CREATE TABLE material_consumption_records (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  material_batch_id BIGINT NOT NULL,
  batch_id BIGINT NOT NULL,         -- ç”Ÿäº§æ‰¹æ¬¡
  factory_id VARCHAR(50) NOT NULL,

  quantity_consumed DECIMAL(12,2),
  unit_cost DECIMAL(12,2),
  cost DECIMAL(12,2),               -- quantity Ã— unit_cost

  consumed_by BIGINT,               -- è°æ“ä½œçš„
  consumption_date TIMESTAMP,
  created_at TIMESTAMP,

  FOREIGN KEY (material_batch_id) REFERENCES material_batches(id),
  FOREIGN KEY (batch_id) REFERENCES production_batches(id)
);
```

---

## 7. è´¨é‡æ£€éªŒæ¨¡å—

### æ¨¡å—æè¿°
è´¨é‡æ£€éªŒæ¨¡å—è®°å½•äº§å“çš„è´¨æ£€ä¿¡æ¯,åŒ…æ‹¬å¤–è§‚ã€å£å‘³ã€æˆåˆ†ç­‰å¤šç»´åº¦çš„æ£€éªŒæ•°æ®ã€‚

### 7.1 è´¨æ£€è®°å½•

**æ£€éªŒé¡¹ç›®**:
- å¤–è§‚: é¢œè‰²ã€å½¢çŠ¶ã€åŒ…è£…ç­‰
- å£å‘³: å’¸æ·¡åº¦ã€ç”œåº¦ç­‰
- æˆåˆ†: è¥å…»æˆåˆ†æ˜¯å¦ç¬¦åˆæ ‡å‡†
- å¾®ç”Ÿç‰©: èŒè½æ•°ã€è‡´ç—…èŒæ£€æµ‹
- å…¶ä»–: ç¡¬åº¦ã€å¼¹æ€§ç­‰

**æ£€éªŒæµç¨‹**:
```
ç”Ÿäº§æ‰¹æ¬¡å®Œæˆ
  â†“
è´¨æ£€å‘˜æ‰“å¼€è´¨æ£€ç•Œé¢
  â†“
æ‰«æ/è¾“å…¥æ‰¹æ¬¡å·: BATCH-20251121-001
  â†“
ç³»ç»Ÿæ˜¾ç¤ºè¯¥æ‰¹æ¬¡çš„ç”Ÿäº§ä¿¡æ¯

  â†“
è´¨æ£€å‘˜é€é¡¹æ£€éªŒ:
  1. å¤–è§‚æ£€éªŒ â†’ "åˆæ ¼" / "ä¸åˆæ ¼"
  2. å£å‘³æ£€éªŒ â†’ "åˆæ ¼" / "ä¸åˆæ ¼"
  3. æˆåˆ†æ£€éªŒ â†’ "åˆæ ¼" / "ä¸åˆæ ¼"
  4. å¾®ç”Ÿç‰©æ£€éªŒ â†’ "åˆæ ¼" / "ä¸åˆæ ¼"

  â†“
è´¨æ£€å‘˜å¯æ·»åŠ å¤‡æ³¨: "ç¬¦åˆä¼ä¸šæ ‡å‡†"

  â†“
ç‚¹å‡»"æäº¤æ£€éªŒæŠ¥å‘Š"

  â†“
API POST /api/mobile/{factoryId}/quality/inspections
è¯·æ±‚ä½“:
{
  "batchId": 1,
  "inspectorId": 5,
  "inspectionDate": "2025-11-21",
  "items": [
    {
      "itemName": "å¤–è§‚",
      "result": "PASSED",
      "notes": "é¢œè‰²å‡åŒ€"
    },
    {
      "itemName": "å£å‘³",
      "result": "PASSED",
      "notes": "å£æ„Ÿå¥½"
    },
    {
      "itemName": "æˆåˆ†",
      "result": "PASSED",
      "notes": ""
    },
    {
      "itemName": "å¾®ç”Ÿç‰©",
      "result": "PASSED",
      "notes": "èŒè½æ•°<100/g"
    }
  ],
  "overallResult": "PASSED",
  "notes": "ç¬¦åˆä¼ä¸šæ ‡å‡†"
}

å“åº”:
{
  "code": 200,
  "data": {
    "inspectionId": 1000,
    "batchId": 1,
    "overallResult": "PASSED",
    "createdAt": "2025-11-21T16:00:00"
  }
}
```

---

## X.1 æˆæœ¬è‡ªåŠ¨è®¡ç®— (4ä¸ªæ¨¡å—åä½œ)

### åœºæ™¯: ä¸€ä¸ªç•ªèŒ„é…±æ‰¹æ¬¡çš„å®Œæ•´æˆæœ¬è®¡ç®—

**æ¶‰åŠæ¨¡å—**: è€ƒå‹¤(äººå·¥) + è®¾å¤‡(æŠ˜æ—§) + åº“å­˜(ç‰©æ–™) + ç”Ÿäº§(æ±‡æ€»)

**å®Œæ•´åœºæ™¯**:
```
2025-11-21,å·¥å‚ç”Ÿäº§ä¸€æ‰¹ç•ªèŒ„é…±

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤1: æ•°æ®æ”¶é›† (æ•´ä¸ªå·¥ä½œæ—¥)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“ è€ƒå‹¤æ¨¡å—è®°å½•:
  08:00 æå››ä¸Šç­ â†’ time_clock_records
  12:00 æå››ä¸­é€”ä¼‘æ¯30åˆ†é’Ÿ
  16:00 æå››ä¸‹ç­ â†’ æ€»å·¥ä½œæ—¶é—´ 7.5å°æ—¶

ğŸ“ åº“å­˜æ¨¡å—è®°å½•:
  ä½¿ç”¨ç‰©æ–™: ç•ªèŒ„ 50kg (å•ä»·10å…ƒ/kg) = 500å…ƒ

ğŸ“ è®¾å¤‡æ¨¡å—è®°å½•:
  08:30-16:30 æ…æ‹Œæœºè¿è¡Œ (æ—¶é—´8å°æ—¶,æŠ˜æ—§ 20.83å…ƒ/å°æ—¶)
  = 166.64å…ƒ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤2: æˆæœ¬æ±‡æ€»è®¡ç®— (å½“æ‰¹æ¬¡æ ‡è®°ä¸ºCOMPLETED)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åç«¯è°ƒç”¨: ProcessingServiceImpl.calculateBatchCost(batchId=1)

1ï¸âƒ£ äººå·¥æˆæœ¬è®¡ç®—:
   - æŸ¥è¯¢è¯¥æ‰¹æ¬¡çš„æ‰€æœ‰batch_work_sessions
   - æå››: 7.5å°æ—¶ Ã— (æ—¥è–ª300å…ƒ/24å°æ—¶) = 93.75å…ƒ
   - å…¶ä»–å·¥äºº: (æ— )
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   å°è®¡: 93.75å…ƒ

2ï¸âƒ£ è®¾å¤‡æˆæœ¬è®¡ç®—:
   - æŸ¥è¯¢è¯¥æ‰¹æ¬¡çš„æ‰€æœ‰equipment_usage_records
   - æ…æ‹Œæœº: 8å°æ—¶ Ã— 20.83å…ƒ/å°æ—¶ = 166.64å…ƒ
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   å°è®¡: 166.64å…ƒ

3ï¸âƒ£ ç‰©æ–™æˆæœ¬è®¡ç®—:
   - æŸ¥è¯¢è¯¥æ‰¹æ¬¡çš„æ‰€æœ‰material_consumption_records
   - ç•ªèŒ„: 50kg Ã— 10å…ƒ/kg = 500å…ƒ
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   å°è®¡: 500å…ƒ

4ï¸âƒ£ æ€»æˆæœ¬:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ äººå·¥æˆæœ¬:  93.75å…ƒ    â”‚
   â”‚ è®¾å¤‡æˆæœ¬: 166.64å…ƒ    â”‚
   â”‚ ç‰©æ–™æˆæœ¬: 500.00å…ƒ    â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ æ€»æˆæœ¬:  760.39å…ƒ    â”‚
   â”‚ äº§é‡: 500kg          â”‚
   â”‚ å•ä½æˆæœ¬: 1.52å…ƒ/kg  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

5ï¸âƒ£ ä¿å­˜åˆ°æ•°æ®åº“:
   UPDATE production_batches
   SET labor_cost = 93.75,
       equipment_cost = 166.64,
       material_cost = 500.00,
       total_cost = 760.39,
       status = 'COMPLETED'
   WHERE id = 1;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤3: è§¦å‘AIåˆ†æ (å¼‚æ­¥)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å½“æˆæœ¬è®¡ç®—å®Œæˆå,è‡ªåŠ¨è°ƒç”¨:
AIEnterpriseService.analyzeCompletedBatch(batchId=1)
  â†“
æ”¶é›†è¯¥æ‰¹æ¬¡åŠæœ€è¿‘Nä¸ªæ‰¹æ¬¡çš„æˆæœ¬æ•°æ®
  â†“
è°ƒç”¨DeepSeek LLMè¿›è¡Œåˆ†æ
  â†“
ä¿å­˜åˆ†æç»“æœåˆ°ai_analysis_resultsè¡¨
```

### è·¨æ¨¡å—æ•°æ®å…³ç³»å›¾

```
time_clock_records
â”‚ user_id, clock_in/out, duration
â”‚
â””â”€â†’ batch_work_sessions
    â”‚ user_id, batch_id, duration_hours
    â”‚
    â””â”€â†’ production_batches â† æ±‡æ€»ä¸­å¿ƒ
        â”‚
        â”œâ”€ labor_cost = Î£(batch_work_sessions)
        â”‚
        â”œâ”€ equipment_usage_records
        â”‚  â”‚ equipment_id, batch_id, duration
        â”‚  â”‚
        â”‚  â””â”€ equipment_depreciation
        â”‚     (hourly_rate)
        â”‚
        â”œâ”€ material_consumption_records
        â”‚  â”‚ material_batch_id, batch_id, quantity
        â”‚  â”‚
        â”‚  â””â”€ material_batches
        â”‚     (unit_cost)
        â”‚
        â””â”€ total_cost = labor + equipment + material
```

---

## X.2 FIFOåº“å­˜æ¨è (åº“å­˜â†’ç”Ÿäº§)

### æµç¨‹

```
ç”Ÿäº§ä¸»ç®¡åœ¨ç”Ÿäº§åŠ å·¥æ¨¡å—ä¸­åˆ›å»ºæ–°æ‰¹æ¬¡
  â†“
éœ€è¦ä½¿ç”¨ç•ªèŒ„è¿™ç§ç‰©æ–™
  â†“
è°ƒç”¨åº“å­˜æœåŠ¡: MaterialBatchService.recommendBatch(materialTypeId)
  â†“
åº“å­˜æœåŠ¡æ‰§è¡Œ:
  1. æŸ¥è¯¢ material_batches è¡¨
     WHERE material_type_id = 'ç•ªèŒ„'
     AND status = 'AVAILABLE'
     AND expiry_date > TODAY()

  2. æŒ‰ expiry_date ASC æ’åº

  3. è¿”å›ç¬¬ä¸€æ¡ (æœ€æ—©è¿‡æœŸçš„)
     â†’ {id: 1, quantity: 500, expiryDate: 2025-12-01}

  â†“
ç”Ÿäº§æ¨¡å—æ˜¾ç¤ºæ¨èç»“æœç»™ç”¨æˆ·
  â†“
ç”¨æˆ·ç¡®è®¤ä½¿ç”¨
  â†“
è§¦å‘æ¶ˆè€—è®°å½•:
  1. åˆ›å»º material_consumption_record
  2. æ‰£å‡ material_batches.quantity
  3. å¦‚æœquantity=0,æ ‡è®°ä¸º CONSUMED
```

**ä»£ç ç¤ºä¾‹** (MaterialBatchService.java):

```java
public MaterialBatch recommendBatchForConsumption(
    String factoryId,
    String materialTypeId) {

  // FIFOæ¨è: æŒ‰è¿‡æœŸæ—¥æœŸå‡åº,å–ç¬¬ä¸€æ¡
  List<MaterialBatch> batches = materialBatchRepository
    .findByFactoryIdAndMaterialTypeIdAndStatusAndExpiryDateAfter(
        factoryId,
        materialTypeId,
        MaterialBatchStatus.AVAILABLE,
        LocalDate.now()
    )
    .stream()
    .sorted(Comparator.comparing(MaterialBatch::getExpiryDate))
    .collect(Collectors.toList());

  if (batches.isEmpty()) {
    throw new MaterialUnavailableException(
      "No available material: " + materialTypeId);
  }

  return batches.get(0);  // è¿”å›æœ€æ—©è¿‡æœŸçš„
}
```

---

## X.3 æ—¶é—´æˆæœ¬ä¸€ä½“åŒ– (è€ƒå‹¤â†’ç”Ÿäº§â†’æˆæœ¬)

### å®Œæ•´æ•°æ®é“¾

```
æ—¶é—´æ‰“å¡
  time_clock_records
  {user_id: 4, clock_in: 08:00, clock_out: 16:00}

      â†“

å·¥ä½œä¼šè¯
  batch_work_sessions
  {batch_id: 1, user_id: 4, duration_hours: 8}

      â†“

æˆæœ¬è®¡ç®—
  hourly_rate = daily_salary / 24
  labor_cost = duration_hours Ã— hourly_rate
            = 8 Ã— (300/24)
            = 100å…ƒ

      â†“

æ‰¹æ¬¡æˆæœ¬
  production_batches.labor_cost += 100å…ƒ

      â†“

æ€»æˆæœ¬æ±‡æ€»
  total_cost = labor_cost + equipment_cost + material_cost
```

---

## X.4 è®¾å¤‡æŠ˜æ—§é›†æˆ (è®¾å¤‡â†’æˆæœ¬è®¡ç®—)

### æŠ˜æ—§è®¡ç®—å…¬å¼

```
è´­å…¥ä»·: 120,000å…ƒ
ä½¿ç”¨å¹´é™: 10å¹´

æœˆæŠ˜æ—§ = 120,000 / (12 Ã— 10) = 1,000å…ƒ
æ—¥æŠ˜æ—§ = 1,000 / 30 = 33.33å…ƒ
å°æ—¶æŠ˜æ—§ = 33.33 / 24 = 1.39å…ƒ

å®é™…ä½¿ç”¨:
  è¿è¡Œ8å°æ—¶ â†’ æˆæœ¬ = 1.39 Ã— 8 = 11.12å…ƒ
```

**ä»£ç ** (EquipmentService.java):

```java
public BigDecimal calculateEquipmentCost(
    Equipment equipment,
    BigDecimal usageHours) {

  BigDecimal hourlyDepreciation = equipment.getHourlyDepreciation();
  // equipment.hourly_depreciation åœ¨åˆ›å»ºè®¾å¤‡æ—¶è‡ªåŠ¨è®¡ç®—

  return hourlyDepreciation.multiply(usageHours);
}
```

---

## X.5 AIåˆ†æè§¦å‘é“¾ (å®Œæˆâ†’åˆ†æâ†’æŠ¥å‘Š)

### è‡ªåŠ¨è§¦å‘æµç¨‹

```
batch.status = 'COMPLETED'
  â†“
æˆæœ¬è®¡ç®—å®Œæˆ
  â†“
æ£€æŸ¥: è¯¥æ‰¹æ¬¡çš„AIåˆ†æå·²å­˜åœ¨?
  â”œâ”€ YES â†’ è·³è¿‡
  â””â”€ NO â†’ ç»§ç»­

  â†“
è°ƒç”¨AIEnterpriseService.analyzeCompletedBatch(batchId)
  â†“
æ”¶é›†æ•°æ®:
  - è¯¥æ‰¹æ¬¡çš„æˆæœ¬ä¿¡æ¯
  - åŒå‘¨æœŸçš„å…¶ä»–æ‰¹æ¬¡ (ç”¨äºå¯¹æ¯”)
  - å‚çº§çš„å†å²æ•°æ® (ç”¨äºè¶‹åŠ¿åˆ†æ)

  â†“
æ„é€ æç¤ºè¯:
  "è¿™æ˜¯ä¸€ä¸ªç”Ÿäº§æ‰¹æ¬¡çš„å®Œæ•´æ•°æ®...è¯·åˆ†æ..."

  â†“
è°ƒç”¨DeepSeek LLM (æœ€å¤šç­‰å¾…30ç§’)

  â†“
è·å–LLMå“åº”

  â†“
ä¿å­˜åˆ°ai_analysis_resultsè¡¨
  (cache_expires_at = now + 7å¤©)

  â†“
å¯é€‰: å‘é€é€šçŸ¥ç»™ç›¸å…³äººå‘˜
  "æ‰¹æ¬¡BATCH-20251121-001çš„AIåˆ†æå·²å®Œæˆ,æœ‰ä¼˜åŒ–å»ºè®®"
```

---

## ç³»ç»Ÿç»Ÿè®¡æ•°æ®

| ç»´åº¦ | æ•°å€¼ |
|------|------|
| **å‰ç«¯é¡µé¢** | 75ä¸ª |
| **åç«¯Controllers** | 25ä¸ª |
| **å·²å®ç°API** | 397ä¸ª |
| **è§„åˆ’ä¸­API** | 180ä¸ª |
| **æ•°æ®å®ä½“** | 43ä¸ª |
| **ç³»ç»Ÿå®Œæˆåº¦** | 82-85% |

---

## å¸¸è§é—®é¢˜è§£ç­”

### Q1: ä¸ºä»€ä¹ˆæˆ‘çš„å‘˜å·¥æ‰“å¡åæ²¡æœ‰è‡ªåŠ¨å…³è”æ‰¹æ¬¡?
**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹:
1. æ˜¯å¦æœ‰è¿›è¡Œä¸­çš„ç”Ÿäº§æ‰¹æ¬¡ (status=IN_PROGRESS)?
2. è¯¥å‘˜å·¥æ˜¯å¦è¢«åˆ†é…åˆ°è¯¥æ‰¹æ¬¡?
3. æ‰“å¡æ—¶é—´æ˜¯å¦åœ¨æ‰¹æ¬¡çš„è®¡åˆ’æ—¶é—´èŒƒå›´å†…?
å¦‚æœä»¥ä¸Šéƒ½æ»¡è¶³,ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºbatch_work_sessionã€‚

### Q2: FIFOåº“å­˜æ¨èæ˜¯æ€æ ·çš„?
**A**: ç³»ç»ŸæŒ‰ç…§ç‰©æ–™æ‰¹æ¬¡çš„è¿‡æœŸæ—¥æœŸå‡åºæ’åˆ—,ä¼˜å…ˆæ¨èæœ€æ—©è¿‡æœŸçš„ã€‚è¿™æ ·å¯ä»¥é¿å…ç‰©æ–™è¿‡æœŸæµªè´¹ã€‚

### Q3: AIåˆ†æä½•æ—¶è‡ªåŠ¨è§¦å‘?
**A**: å½“ç”Ÿäº§æ‰¹æ¬¡æ ‡è®°ä¸ºCOMPLETEDæˆ–DELIVEREDä¸”æˆæœ¬è®¡ç®—å®Œæˆå,ç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨åå°è°ƒç”¨AIåˆ†ææœåŠ¡ã€‚

### Q4: æˆæœ¬è®¡ç®—ä¸­çš„äººå·¥æˆæœ¬æ˜¯æ€æ ·è®¡ç®—çš„?
**A**:
1. ç³»ç»Ÿè®°å½•å‘˜å·¥çš„å®é™…å·¥ä½œæ—¶é—´ (batch_work_sessions)
2. æ ¹æ®å‘˜å·¥çš„æ—¥è–ªè®¡ç®—å°æ—¶è´¹ç‡: æ—¥è–ª / 24
3. å°†å°æ—¶è´¹ç‡ Ã— å®é™…å·¥ä½œå°æ—¶æ•°
4. å¦‚æœå‘˜å·¥ä¸­é€”è½¬ç§»åˆ°å…¶ä»–æ‰¹æ¬¡,æˆæœ¬æŒ‰æ¯”ä¾‹åˆ†é…

### Q5: å¦‚æœè®¾å¤‡ä¸­é€”åœæœºè¯¥æ€ä¹ˆåŠ?
**A**: æ“ä½œå‘˜å¯ä»¥:
1. ç‚¹å‡»"æš‚åœ"(è¯¥åŠŸèƒ½å¯é€‰)
2. æˆ–å®Œæ•´ä½¿ç”¨å‘¨æœŸ,ç³»ç»Ÿä¼šæ ¹æ®å®é™…è¿è¡Œæ—¶é—´è®¡ç®—æˆæœ¬
3. åœ¨equipment_usage_recordsè¡¨ä¸­çš„noteså­—æ®µè¯´æ˜åœæœºåŸå› 

---

## æ–‡æ¡£æ›´æ–°æ—¥å¿—

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å†…å®¹ |
|------|------|---------|
| v3.0 | 2025-11-21 | æ–°äººè¯¦è§£ç‰ˆå‘å¸ƒ,åŒ…å«å®Œæ•´ä¸šåŠ¡æµç¨‹å’Œäº¤å‰åŠŸèƒ½è¯´æ˜ |

---

**æ–‡æ¡£å®Œæˆæ—¥æœŸ**: 2025-11-21
**ç»´æŠ¤è€…**: Claude Code
**ä¸‹ä¸€ç‰ˆæœ¬è®¡åˆ’**: v3.1 (å¢åŠ æ›´å¤šFAQå’Œæ•…éšœæ’æŸ¥æŒ‡å—)
