<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>白垩纪食品溯源系统 - 技术架构与系统设计 v1.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif;
            line-height: 1.8;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.95;
            margin-bottom: 5px;
        }

        .tagline {
            font-size: 1em;
            opacity: 0.85;
            font-style: italic;
        }

        .meta-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .meta-item {
            text-align: center;
        }

        .meta-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .meta-value {
            font-size: 1.1em;
            font-weight: 600;
        }

        .nav-bar {
            background: #f8f9fa;
            padding: 15px 40px;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-bar a {
            color: #667eea;
            text-decoration: none;
            margin-right: 20px;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-bar a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .content {
            padding: 40px;
        }

        section {
            margin-bottom: 50px;
        }

        h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
        }

        .section-number {
            display: inline-block;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            margin-right: 15px;
            font-size: 0.8em;
        }

        h3 {
            color: #495057;
            font-size: 1.5em;
            margin: 25px 0 15px 0;
            padding-left: 15px;
            border-left: 4px solid #667eea;
        }

        h4 {
            color: #6c757d;
            font-size: 1.2em;
            margin: 20px 0 10px 0;
            font-weight: 600;
        }

        .highlight-box {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }

        .tech-stack-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .tech-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-top: 4px solid;
        }

        .tech-card.frontend {
            border-top-color: #00bcd4;
        }

        .tech-card.backend {
            border-top-color: #4caf50;
        }

        .tech-card.database {
            border-top-color: #ff9800;
        }

        .tech-card.ai {
            border-top-color: #9c27b0;
        }

        .architecture-diagram {
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            padding: 30px;
            border-radius: 12px;
            margin: 30px 0;
            text-align: center;
            border: 2px solid #dee2e6;
        }

        .layer {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .layer-title {
            font-weight: 600;
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #667eea;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        table tbody tr:hover {
            background: #f8f9fa;
        }

        .code-block {
            background: #f4f4f4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            border-left: 4px solid #667eea;
            margin: 20px 0;
        }

        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .feature-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .feature-item h4 {
            color: #667eea;
            margin: 0 0 10px 0;
        }

        .warning-box {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #ff9800;
            margin: 20px 0;
        }

        .success-box {
            background: linear-gradient(135deg, #f0fff5 0%, #c8e6c9 100%);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4caf50;
            margin: 20px 0;
        }

        .info-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
            margin: 20px 0;
        }

        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }

        li {
            margin: 8px 0;
            line-height: 1.8;
        }

        @media (max-width: 768px) {
            .tech-stack-grid {
                grid-template-columns: 1fr;
            }

            .feature-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>🏗️ 白垩纪食品溯源系统</h1>
            <div class="subtitle">技术架构与系统设计文档</div>
            <div class="tagline">Technology Architecture & System Design Document</div>

            <div class="meta-info">
                <div class="meta-item">
                    <div class="meta-label">📄 文档版本</div>
                    <div class="meta-value">v1.0</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">📅 更新日期</div>
                    <div class="meta-value">2025-01-04</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">👨‍💻 适用阶段</div>
                    <div class="meta-value">技术实现阶段</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">📖 文档范围</div>
                    <div class="meta-value">第3-8章</div>
                </div>
            </div>
        </header>

        <!-- Navigation Bar -->
        <div class="nav-bar">
            <a href="./PRD-完整业务流程与界面设计-v4.0-产品概述优化.html">← 返回第1-2章（产品概述与市场分析）</a>
            <a href="#chapter-3">第3章：架构设计</a>
            <a href="#chapter-4">第4章：后端系统</a>
            <a href="#chapter-5">第5章：移动端</a>
            <a href="#chapter-6">第6章：数据流程</a>
            <a href="#chapter-7">第7章：部署运维</a>
            <a href="#chapter-8">第8章：安全合规</a>
        </div>

        <!-- Main Content -->
        <div class="content">
            <!-- 文档说明 -->
            <div class="info-box">
                <p style="font-size: 1.1em; margin-bottom: 10px;"><strong>📚 文档说明</strong></p>
                <p style="line-height: 2;">
                    本文档是<strong>白垩纪食品溯源系统PRD</strong>的技术部分，详细描述系统的架构设计、技术选型、实现方案和部署策略。<br>
                    如需了解产品定位和市场分析，请参阅 <a href="./PRD-完整业务流程与界面设计-v4.0-产品概述优化.html" style="color: #2196f3; font-weight: 600;">第1-2章：产品概述与市场分析</a>
                </p>
            </div>

            <!-- 第3章：系统架构设计 -->
            <section id="chapter-3">
                <h2><span class="section-number">3</span>系统架构设计</h2>

                <h3>3.1 整体架构概览</h3>

                <p style="font-size: 1.05em; line-height: 2; margin: 20px 0;">
                    白垩纪食品溯源系统采用<strong>现代化的三层架构</strong>，结合<strong>多租户SaaS模式</strong>，为中小食品企业提供轻量级、高性价比的数字化解决方案。
                </p>

                <div class="architecture-diagram">
                    <h4 style="margin-bottom: 20px; color: #667eea;">📊 系统架构图</h4>

                    <!-- 表示层 -->
                    <div class="layer" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                        <div class="layer-title">📱 表示层 (Presentation Layer)</div>
                        <div style="color: #555; font-size: 1.05em;">
                            <strong>React Native移动应用</strong><br>
                            • iOS/Android跨平台应用 (Expo 53+)<br>
                            • Material Design 3界面设计<br>
                            • 离线优先架构 + 本地数据缓存<br>
                            • 生物识别认证 + 设备绑定
                        </div>
                    </div>

                    <!-- 应用层 -->
                    <div class="layer" style="background: linear-gradient(135deg, #f0fff5 0%, #c8e6c9 100%);">
                        <div class="layer-title">⚙️ 应用层 (Application Layer)</div>
                        <div style="color: #555; font-size: 1.05em;">
                            <strong>Spring Boot (Java 11) API服务</strong><br>
                            • RESTful API设计 (/api/mobile/*)<br>
                            • JWT双令牌认证系统<br>
                            • 8级角色权限控制 (RBAC)<br>
                            • Spring Security安全框架<br>
                            • 多租户数据隔离<br><br>

                            <strong>Python AI分析服务（独立部署）</strong><br>
                            • DeepSeek LLM智能分析<br>
                            • 成本异常检测<br>
                            • 生产效率优化建议
                        </div>
                    </div>

                    <!-- 数据层 -->
                    <div class="layer" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);">
                        <div class="layer-title">🗄️ 数据层 (Data Layer)</div>
                        <div style="color: #555; font-size: 1.05em;">
                            <strong>MySQL 数据库</strong><br>
                            • 关系型数据库（开发和生产环境统一使用MySQL）<br>
                            • Spring Data JPA + Hibernate ORM框架<br>
                            • 主从复制和读写分离（生产环境）<br>
                            • 数据备份和灾难恢复<br>
                            • 性能优化：索引、查询优化、分库分表（未来规划）
                        </div>
                    </div>
                </div>

                <h4>🏢 多租户架构设计</h4>
                <div class="info-box">
                    <p style="font-size: 1.05em; line-height: 2;">
                        <strong>数据隔离策略</strong>：每个工厂（Factory）作为独立租户，通过 <code>factoryId</code> 进行数据隔离<br>
                        <strong>用户隔离</strong>：工厂用户只能访问所属工厂的数据<br>
                        <strong>平台管理员</strong>：拥有跨租户管理权限，可查看所有工厂数据<br>
                        <strong>性能优化</strong>：数据库索引优化，查询自动添加 <code>WHERE factoryId = ?</code> 条件
                    </p>
                </div>

                <h3>3.2 技术栈选型与理由</h3>

                <div class="tech-stack-grid">
                    <!-- 前端技术栈 -->
                    <div class="tech-card frontend">
                        <div style="font-size: 2em; margin-bottom: 10px;">📱</div>
                        <h4 style="color: #00bcd4; margin: 0 0 15px 0;">前端技术栈</h4>
                        <div style="color: #555; line-height: 2; font-size: 1.05em;">
                            <strong>React Native 0.79+</strong><br>
                            • 跨平台开发效率<br>
                            • 原生性能体验<br>
                            • 丰富的生态系统<br><br>

                            <strong>Expo 53+</strong><br>
                            • 快速迭代和部署<br>
                            • OTA热更新支持<br>
                            • 内置Camera、GPS等模块<br><br>

                            <strong>TypeScript</strong><br>
                            • 类型安全<br>
                            • 更好的IDE支持<br>
                            • 降低运行时错误
                        </div>
                    </div>

                    <!-- 后端技术栈 -->
                    <div class="tech-card backend">
                        <div style="font-size: 2em; margin-bottom: 10px;">⚙️</div>
                        <h4 style="color: #4caf50; margin: 0 0 15px 0;">后端技术栈</h4>
                        <div style="color: #555; line-height: 2; font-size: 1.05em;">
                            <strong>Spring Boot 2.7.15 (Java 11)</strong><br>
                            • 成熟的企业级框架<br>
                            • 完善的生态系统<br>
                            • 高性能、高并发<br><br>

                            <strong>Spring Data JPA + Hibernate</strong><br>
                            • 强大的ORM框架<br>
                            • Entity自动映射<br>
                            • Repository接口、分页查询<br><br>

                            <strong>Spring Security + JWT</strong><br>
                            • 安全框架集成<br>
                            • 双令牌刷新机制<br>
                            • 设备绑定支持<br><br>

                            <strong>Python AI服务（独立）</strong><br>
                            • Flask/FastAPI框架<br>
                            • DeepSeek SDK集成<br>
                            • HTTP API调用
                        </div>
                    </div>

                    <!-- 数据库 -->
                    <div class="tech-card database">
                        <div style="font-size: 2em; margin-bottom: 10px;">🗄️</div>
                        <h4 style="color: #ff9800; margin: 0 0 15px 0;">数据存储</h4>
                        <div style="color: #555; line-height: 2; font-size: 1.05em;">
                            <strong>MySQL 8.0</strong><br>
                            • 开发和生产环境统一<br>
                            • 稳定可靠、性能优秀<br>
                            • 主从复制（生产环境）<br>
                            • 读写分离<br><br>

                            <strong>Redis (缓存)</strong><br>
                            • 热点数据缓存<br>
                            • Session共享<br>
                            • 分布式锁<br><br>

                            <strong>Expo SecureStore</strong><br>
                            • 移动端加密存储<br>
                            • 敏感数据保护
                        </div>
                    </div>

                    <!-- AI集成 -->
                    <div class="tech-card ai">
                        <div style="font-size: 2em; margin-bottom: 10px;">🤖</div>
                        <h4 style="color: #9c27b0; margin: 0 0 15px 0;">AI智能分析</h4>
                        <div style="color: #555; line-height: 2; font-size: 1.05em;">
                            <strong>DeepSeek LLM</strong><br>
                            • 成本优化（<¥30/月/工厂）<br>
                            • 生产数据智能分析<br>
                            • 成本异常检测<br><br>

                            <strong>缓存策略</strong><br>
                            • 5分钟相似查询缓存<br>
                            • 降低API调用成本<br>
                            • 提升响应速度<br><br>

                            <strong>数据预处理</strong><br>
                            • 减少Token使用<br>
                            • 优化Prompt设计
                        </div>
                    </div>
                </div>

                <h4>🎯 技术选型核心理由</h4>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 25%;">技术</th>
                            <th style="width: 35%;">选择理由</th>
                            <th style="width: 40%;">替代方案对比</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>React Native</strong></td>
                            <td>跨平台、开发效率高、性能优秀、生态丰富</td>
                            <td>Flutter（学习成本高）、原生开发（成本2倍）</td>
                        </tr>
                        <tr>
                            <td><strong>Expo</strong></td>
                            <td>快速开发、OTA更新、降低部署复杂度</td>
                            <td>React Native CLI（配置复杂）</td>
                        </tr>
                        <tr>
                            <td><strong>Spring Boot</strong></td>
                            <td>企业级成熟框架、生态完善、高性能高并发</td>
                            <td>Node.js（生态不如Java成熟）、Python（性能较低）</td>
                        </tr>
                        <tr>
                            <td><strong>Spring Data JPA + Hibernate</strong></td>
                            <td>标准JPA规范、自动映射、Repository模式、Spring生态集成</td>
                            <td>MyBatis-Plus（需要更多配置）、MyBatis（功能较少）</td>
                        </tr>
                        <tr>
                            <td><strong>MySQL</strong></td>
                            <td>稳定可靠、性能优秀、运维成熟、社区支持好</td>
                            <td>PostgreSQL（运维复杂）、MongoDB（关系数据不适合）</td>
                        </tr>
                        <tr>
                            <td><strong>Python AI服务</strong></td>
                            <td>AI/ML生态最完善、DeepSeek SDK原生支持</td>
                            <td>Java AI库（生态不如Python）、直接调用API（不够灵活）</td>
                        </tr>
                        <tr>
                            <td><strong>DeepSeek</strong></td>
                            <td>成本极低、中文友好、API稳定</td>
                            <td>GPT-4（成本高10倍+）、Qwen（API限制多）</td>
                        </tr>
                    </tbody>
                </table>

                <h3>3.3 核心设计模式</h3>

                <div class="feature-list">
                    <!-- RBAC权限控制 -->
                    <div class="feature-item">
                        <h4>🔐 基于角色的访问控制 (RBAC)</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>8级角色体系：</strong><br>
                            • Platform: developer, platform_admin, platform_operator<br>
                            • Factory: factory_super_admin, permission_admin, department_admin, operator, viewer<br><br>

                            <strong>权限守卫中间件：</strong><br>
                            每个API端点自动验证用户角色和权限，确保数据安全
                        </p>
                    </div>

                    <!-- 智能路由 -->
                    <div class="feature-item">
                        <h4>🧭 智能路由系统</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>用户类型自动识别：</strong><br>
                            • 平台用户 → Platform Dashboard<br>
                            • 工厂用户 → Factory Dashboard<br>
                            • 未激活用户 → 激活引导页<br><br>

                            <strong>权限驱动导航：</strong><br>
                            根据用户角色动态生成导航栏和Tab可见性
                        </p>
                    </div>

                    <!-- 离线优先 -->
                    <div class="feature-item">
                        <h4>📶 离线优先架构</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>本地数据存储：</strong><br>
                            使用AsyncStorage存储关键业务数据<br><br>

                            <strong>智能同步：</strong><br>
                            网络恢复后自动上传本地数据<br><br>

                            <strong>冲突解决：</strong><br>
                            服务器时间戳优先策略
                        </p>
                    </div>

                    <!-- 设备绑定 -->
                    <div class="feature-item">
                        <h4>📱 设备绑定与激活</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>唯一设备ID：</strong><br>
                            基于硬件信息生成设备指纹<br><br>

                            <strong>激活码验证：</strong><br>
                            新设备需要激活码授权<br><br>

                            <strong>安全防护：</strong><br>
                            防止账号在未授权设备上登录
                        </p>
                    </div>
                </div>

                <h3>3.4 数据安全设计</h3>

                <h4>🔒 JWT双令牌认证系统</h4>

                <div class="info-box">
                    <p style="font-size: 1.05em; line-height: 2;">
                        <strong>四种令牌类型及其功能：</strong><br><br>

                        <strong>① AccessToken（访问令牌）</strong><br>
                        • 短期有效（1小时）<br>
                        • 用于所有API请求的身份验证<br>
                        • 过期后需要刷新<br><br>

                        <strong>② RefreshToken（刷新令牌）</strong><br>
                        • 长期有效（7天）<br>
                        • 用于获取新的AccessToken<br>
                        • 安全存储在设备本地<br><br>

                        <strong>③ DeviceToken（设备令牌）</strong><br>
                        • 绑定特定设备<br>
                        • 验证设备合法性<br>
                        • 防止账号在未授权设备登录<br><br>

                        <strong>④ TempToken（临时令牌）</strong><br>
                        • 用于注册流程的中间验证<br>
                        • 完成注册后失效
                    </p>
                </div>

                <h4 style="margin-top: 30px;">🔄 令牌刷新流程</h4>
                <div class="architecture-diagram" style="text-align: left;">
                    <div style="padding: 20px;">
                        <p style="font-size: 1.05em; line-height: 2.2; margin-bottom: 20px;">
                            <strong style="color: #667eea;">步骤1：AccessToken即将过期</strong><br>
                            → 移动端检测到AccessToken还有5分钟过期<br>
                            → 自动触发令牌刷新机制<br><br>

                            <strong style="color: #667eea;">步骤2：使用RefreshToken请求新令牌</strong><br>
                            → 移动端向服务器发送RefreshToken<br>
                            → 服务器验证RefreshToken的有效性和设备绑定<br>
                            → 验证通过后生成新的AccessToken<br><br>

                            <strong style="color: #667eea;">步骤3：RefreshToken续期策略</strong><br>
                            → 当RefreshToken剩余有效期少于2天时<br>
                            → 服务器在返回新AccessToken的同时，也返回新的RefreshToken<br>
                            → 实现无感知的长期登录状态<br><br>

                            <strong style="color: #667eea;">步骤4：安全防护机制</strong><br>
                            → 检测到任一令牌被盗用或异常使用<br>
                            → 服务器强制使所有该用户的令牌失效<br>
                            → 用户需要在所有设备上重新登录<br>
                            → 记录安全日志供审计
                        </p>
                    </div>
                </div>

                <h4>🔐 生物识别集成</h4>
                <div class="success-box">
                    <p style="font-size: 1.05em; line-height: 2;">
                        <strong>Expo LocalAuthentication模块：</strong><br>
                        • 支持指纹识别（Touch ID）<br>
                        • 支持面部识别（Face ID）<br>
                        • 用户可选择是否启用生物识别快捷登录<br>
                        • 生物识别失败后fallback到密码登录
                    </p>
                </div>

                <h4>🛡️ 数据加密策略</h4>
                <table>
                    <thead>
                        <tr>
                            <th>数据类型</th>
                            <th>加密方式</th>
                            <th>存储位置</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>用户密码</td>
                            <td>bcrypt哈希（salt rounds=10）</td>
                            <td>数据库（不可逆）</td>
                        </tr>
                        <tr>
                            <td>访问令牌</td>
                            <td>JWT签名（HS256）</td>
                            <td>Expo SecureStore（移动端）</td>
                        </tr>
                        <tr>
                            <td>设备ID</td>
                            <td>SHA256哈希</td>
                            <td>数据库</td>
                        </tr>
                        <tr>
                            <td>API传输</td>
                            <td>HTTPS/TLS 1.3</td>
                            <td>网络传输层</td>
                        </tr>
                        <tr>
                            <td>敏感配置</td>
                            <td>环境变量（.env）</td>
                            <td>服务器本地（不提交Git）</td>
                        </tr>
                    </tbody>
                </table>

                <div class="warning-box">
                    <p style="font-size: 1.05em; line-height: 2;">
                        <strong>⚠️ 安全最佳实践：</strong><br>
                        • 永不在客户端存储明文密码<br>
                        • API密钥和数据库凭证存储在环境变量中<br>
                        • 生产环境强制使用HTTPS<br>
                        • 定期轮换JWT密钥<br>
                        • 实施API速率限制，防止暴力破解
                    </p>
                </div>
            </section>

            <!-- 第4章：后端系统设计 -->
            <section id="chapter-4">
                <h2><span class="section-number">4</span>后端系统设计</h2>

                <p style="font-size: 1.05em; line-height: 2; margin: 20px 0;">
                    后端系统采用<strong>模块化设计理念</strong>，按照业务线划分为五大核心模块，每个模块独立负责特定的业务功能，通过统一的API网关对外提供服务。
                </p>

                <h3>4.1 API架构设计</h3>

                <h4>🌐 RESTful API设计原则</h4>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 20%;">设计原则</th>
                            <th style="width: 40%;">说明</th>
                            <th style="width: 40%;">示例场景</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>资源导向</strong></td>
                            <td>每个URL代表一种资源，使用名词而非动词</td>
                            <td>获取批次列表：<code>/api/mobile/{factoryId}/batches</code></td>
                        </tr>
                        <tr>
                            <td><strong>HTTP方法语义</strong></td>
                            <td>GET查询、POST创建、PUT更新、DELETE删除</td>
                            <td>创建批次：<code>POST /api/mobile/{factoryId}/batches</code></td>
                        </tr>
                        <tr>
                            <td><strong>统一响应格式</strong></td>
                            <td>所有API返回统一的JSON结构</td>
                            <td>成功：status=200, data={}；失败：status=400, error={}</td>
                        </tr>
                        <tr>
                            <td><strong>版本管理</strong></td>
                            <td>通过URL路径进行版本控制</td>
                            <td>当前版本：/api/mobile/v1/；未来：/api/mobile/v2/</td>
                        </tr>
                        <tr>
                            <td><strong>分页与过滤</strong></td>
                            <td>通过query参数实现数据分页和筛选</td>
                            <td>?page=1&limit=20&status=in_progress</td>
                        </tr>
                    </tbody>
                </table>

                <h4 style="margin-top: 30px;">📡 移动端专用API (/api/mobile/*)</h4>
                <div class="success-box">
                    <p style="font-size: 1.05em; line-height: 2;">
                        <strong>设计理念：</strong>移动端API与Web端API分离，针对移动场景优化<br><br>

                        <strong>优化策略：</strong><br>
                        • <strong>数据精简</strong>：返回移动端真正需要的字段，减少流量消耗<br>
                        • <strong>批量接口</strong>：提供批量查询接口，减少网络请求次数<br>
                        • <strong>离线支持</strong>：支持增量同步，移动端可离线操作后批量上传<br>
                        • <strong>响应速度</strong>：优化查询性能，目标响应时间<200ms<br>
                        • <strong>工厂隔离</strong>：所有API路径包含{factoryId}，自动实现多租户隔离
                    </p>
                </div>

                <h4 style="margin-top: 30px;">🔧 错误响应标准化</h4>
                <div class="architecture-diagram" style="text-align: left;">
                    <div style="padding: 20px;">
                        <p style="font-size: 1.05em; line-height: 2.2;">
                            <strong style="color: #667eea;">HTTP状态码分类：</strong><br><br>

                            <strong>2xx 成功</strong><br>
                            → 200 OK：请求成功，返回数据<br>
                            → 201 Created：资源创建成功<br>
                            → 204 No Content：操作成功但无返回数据（如删除）<br><br>

                            <strong>4xx 客户端错误</strong><br>
                            → 400 Bad Request：请求参数错误<br>
                            → 401 Unauthorized：未登录或令牌失效<br>
                            → 403 Forbidden：无权限访问<br>
                            → 404 Not Found：资源不存在<br>
                            → 429 Too Many Requests：请求频率超限<br><br>

                            <strong>5xx 服务器错误</strong><br>
                            → 500 Internal Server Error：服务器内部错误<br>
                            → 503 Service Unavailable：服务暂时不可用（维护中）<br><br>

                            <strong>错误信息结构：</strong><br>
                            → error.code：业务错误码（如：BATCH_NOT_FOUND）<br>
                            → error.message：用户友好的错误描述<br>
                            → error.details：详细错误信息（仅开发环境）
                        </p>
                    </div>
                </div>

                <h3>4.2 核心业务模块设计</h3>

                <p style="font-size: 1.05em; line-height: 2; margin: 20px 0;">
                    系统按照<strong>业务线</strong>划分为五大核心模块，每个模块对应APP中的实际使用场景和功能模块。
                </p>

                <h4>🔐 模块1：认证授权模块</h4>
                <div class="feature-list">
                    <div class="feature-item">
                        <h4>用户登录与注册</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>统一登录入口：</strong><br>
                            • 自动识别平台用户 vs 工厂用户<br>
                            • 平台用户：开发者、平台管理员<br>
                            • 工厂用户：工厂管理员、部门主管、操作员等<br><br>

                            <strong>两阶段注册流程：</strong><br>
                            • Phase 1：手机号验证 + 白名单检查<br>
                            • Phase 2：完善用户信息 + 工厂绑定<br>
                            • 新用户注册后状态为"未激活"，需管理员审核
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>设备管理与激活</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>设备绑定流程：</strong><br>
                            • 用户首次登录时记录设备ID<br>
                            • 设备ID基于硬件信息生成唯一标识<br>
                            • 管理员可查看和管理用户的设备列表<br><br>

                            <strong>激活码系统：</strong><br>
                            • 新设备登录需要激活码授权<br>
                            • 激活码分为试用版和正式版<br>
                            • 防止账号在未授权设备上使用
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>角色权限管理</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>8级角色体系：</strong><br>
                            • 平台层：developer, platform_admin, platform_operator<br>
                            • 工厂层：factory_super_admin, permission_admin, department_admin, operator, viewer<br><br>

                            <strong>权限验证机制：</strong><br>
                            • 每个API请求自动验证用户角色<br>
                            • 基于角色的数据访问控制（RBAC）<br>
                            • 跨工厂访问需要特殊权限
                        </p>
                    </div>
                </div>

                <h4 style="margin-top: 40px;">🏭 模块2：加工管理模块</h4>
                <div class="info-box">
                    <p style="font-size: 1.1em; margin-bottom: 15px;"><strong>核心业务线：生产加工全流程管理</strong></p>
                    <p style="font-size: 1.05em; line-height: 2;">
                        这是系统的<strong>核心模块</strong>，覆盖从原材料入库到成品出库的完整生产流程，包含5个子模块。
                    </p>
                </div>

                <div class="feature-list">
                    <div class="feature-item">
                        <h4>① 生产批次管理</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>批次生命周期：</strong><br>
                            计划中 → 准备中 → 生产中 → 已完成 → 已入库<br><br>

                            <strong>核心功能：</strong><br>
                            • 创建生产批次（关联产品类型、目标产量）<br>
                            • 原材料消耗记录（自动扣减库存）<br>
                            • 生产进度跟踪（实时更新完成数量）<br>
                            • 批次详情查询（溯源码、生产时间、负责人等）<br>
                            • AI成本分析（DeepSeek智能分析成本异常）
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>② 质量检验管理</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>质检流程：</strong><br>
                            待检验 → 检验中 → 合格/不合格<br><br>

                            <strong>核心功能：</strong><br>
                            • 创建质检任务（关联生产批次）<br>
                            • 质检项目配置（检测指标、合格标准）<br>
                            • 质检结果记录（拍照上传、数据填写）<br>
                            • 不合格品处理（返工、报废、降级）<br>
                            • 质检报告生成（PDF导出、溯源查询）
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>③ 原材料管理</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>原材料类型：</strong><br>
                            • 主料（直接投入生产的原材料）<br>
                            • 辅料（调味料、包装材料等）<br>
                            • 半成品（自产或外购的半成品）<br><br>

                            <strong>核心功能：</strong><br>
                            • 原材料入库（供应商、批次号、数量）<br>
                            • 库存管理（实时库存、安全库存预警）<br>
                            • 原材料消耗（关联生产批次自动扣减）<br>
                            • 供应商管理（供应商资质、采购记录）
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>④ 成本核算</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>成本构成：</strong><br>
                            • 原材料成本（自动计算原材料消耗）<br>
                            • 人工成本（关联员工工时记录）<br>
                            • 能源成本（设备能耗数据）<br>
                            • 其他成本（包装、运输等）<br><br>

                            <strong>核心功能：</strong><br>
                            • 批次成本自动计算<br>
                            • 成本对比分析（同类产品历史对比）<br>
                            • 成本异常检测（AI智能预警）<br>
                            • 成本报表导出（Excel、PDF）
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>⑤ 设备监控</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>设备状态：</strong><br>
                            运行中、空闲、维护中、故障<br><br>

                            <strong>核心功能：</strong><br>
                            • 设备台账管理（设备信息、购置日期）<br>
                            • 运行状态监控（实时状态、运行时长）<br>
                            • 维护保养记录（保养计划、保养记录）<br>
                            • 故障预警（异常检测、告警通知）<br>
                            • 设备利用率统计（使用率、停机分析）
                        </p>
                    </div>
                </div>

                <h4 style="margin-top: 40px;">👥 模块3：员工管理模块</h4>
                <div class="feature-list">
                    <div class="feature-item">
                        <h4>员工打卡考勤</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>打卡方式：</strong><br>
                            • GPS定位打卡（验证工厂地理围栏）<br>
                            • 拍照打卡（人脸识别防代打卡）<br>
                            • 班次管理（早班、中班、晚班）<br><br>

                            <strong>考勤规则：</strong><br>
                            • 迟到、早退自动识别<br>
                            • 异常考勤审批流程<br>
                            • 请假、调休管理
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>工时统计</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>工时计算：</strong><br>
                            • 基于打卡记录自动计算工时<br>
                            • 区分正常工时、加班工时<br>
                            • 支持手动调整（需审批）<br><br>

                            <strong>工时报表：</strong><br>
                            • 个人工时明细查询<br>
                            • 部门工时汇总统计<br>
                            • 工时成本核算（关联生产批次）
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>员工效率分析</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>效率指标：</strong><br>
                            • 人均产量（完成数量/工时）<br>
                            • 质检合格率（关联质检记录）<br>
                            • 设备操作效率（关联设备监控）<br><br>

                            <strong>绩效考核：</strong><br>
                            • 员工绩效排名<br>
                            • 异常效率预警<br>
                            • 培训需求分析
                        </p>
                    </div>
                </div>

                <h4 style="margin-top: 40px;">⚙️ 模块4：系统管理模块</h4>
                <div class="feature-list">
                    <div class="feature-item">
                        <h4>基础配置管理</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>产品类型配置：</strong><br>
                            • 产品分类管理<br>
                            • 产品属性定义（规格、单位等）<br>
                            • 生产工艺流程配置<br><br>

                            <strong>原材料类型配置：</strong><br>
                            • 原材料分类<br>
                            • 换算率配置（投入产出比）<br>
                            • 安全库存设置
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>用户与权限管理</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>用户管理：</strong><br>
                            • 用户列表查询<br>
                            • 用户信息编辑<br>
                            • 用户状态管理（激活/禁用）<br><br>

                            <strong>权限管理：</strong><br>
                            • 角色分配（支持多角色）<br>
                            • 权限审计日志<br>
                            • 白名单管理（注册前置审核）
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>供应商与客户管理</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>供应商管理：</strong><br>
                            • 供应商档案（资质、联系方式）<br>
                            • 供应商评级（质量、交期、价格）<br>
                            • 采购记录跟踪<br><br>

                            <strong>客户管理：</strong><br>
                            • 客户档案管理<br>
                            • 销售记录跟踪<br>
                            • 客户反馈管理
                        </p>
                    </div>
                </div>

                <h4 style="margin-top: 40px;">🌐 模块5：平台管理模块</h4>
                <div class="warning-box">
                    <p style="font-size: 1.05em; line-height: 2;">
                        <strong>平台级管理功能（仅限平台管理员）：</strong><br><br>

                        <strong>工厂管理：</strong><br>
                        • 工厂注册审核<br>
                        • 工厂信息管理<br>
                        • 工厂状态监控（活跃度、使用情况）<br>
                        • 工厂数据汇总统计<br><br>

                        <strong>AI配额管理：</strong><br>
                        • 为每个工厂分配DeepSeek API调用额度<br>
                        • 实时监控各工厂AI使用量<br>
                        • 超额预警和限流<br>
                        • 成本控制（总成本控制在预算内）<br><br>

                        <strong>系统监控：</strong><br>
                        • 全局API调用监控<br>
                        • 系统性能监控<br>
                        • 异常告警通知<br>
                        • 运营数据Dashboard
                    </p>
                </div>

                <h3>4.3 数据库设计理念</h3>

                <h4>🏗️ 核心设计原则</h4>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 25%;">设计原则</th>
                            <th style="width: 35%;">说明</th>
                            <th style="width: 40%;">应用场景</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>多租户隔离</strong></td>
                            <td>每个工厂的数据完全隔离，通过factoryId区分</td>
                            <td>工厂A的员工无法查看工厂B的生产数据</td>
                        </tr>
                        <tr>
                            <td><strong>软删除策略</strong></td>
                            <td>重要数据不物理删除，使用deletedAt字段标记</td>
                            <td>生产批次、质检记录等需要溯源的数据</td>
                        </tr>
                        <tr>
                            <td><strong>审计追踪</strong></td>
                            <td>记录创建人、创建时间、修改人、修改时间</td>
                            <td>所有业务表都包含createdBy, updatedBy字段</td>
                        </tr>
                        <tr>
                            <td><strong>关系规范化</strong></td>
                            <td>合理使用外键关系，避免数据冗余</td>
                            <td>批次关联产品类型、原材料类型等主数据</td>
                        </tr>
                        <tr>
                            <td><strong>索引优化</strong></td>
                            <td>为高频查询字段建立索引</td>
                            <td>factoryId、userId、batchId、status等字段</td>
                        </tr>
                        <tr>
                            <td><strong>JSON灵活字段</strong></td>
                            <td>使用JSON字段存储扩展配置</td>
                            <td>产品配置、质检项目配置等可变结构数据</td>
                        </tr>
                    </tbody>
                </table>

                <h4 style="margin-top: 30px;">🔗 核心实体关系</h4>
                <div class="architecture-diagram" style="text-align: left;">
                    <div style="padding: 20px;">
                        <p style="font-size: 1.05em; line-height: 2.2;">
                            <strong style="color: #667eea;">用户与工厂关系：</strong><br>
                            • Factory（工厂） 1 : N User（用户）<br>
                            • 一个工厂有多个用户，一个用户只属于一个工厂<br>
                            • 平台管理员不绑定工厂，通过PlatformAdmin表管理<br><br>

                            <strong style="color: #667eea;">生产批次核心关系：</strong><br>
                            • ProcessingBatch（生产批次） N : 1 ProductType（产品类型）<br>
                            • ProcessingBatch N : 1 User（负责人）<br>
                            • ProcessingBatch N : 1 Factory（所属工厂）<br>
                            • ProcessingBatch 1 : N MaterialConsumption（原材料消耗记录）<br>
                            • ProcessingBatch 1 : N QualityInspection（质检记录）<br><br>

                            <strong style="color: #667eea;">质检与批次关系：</strong><br>
                            • QualityInspection（质检记录） N : 1 ProcessingBatch（生产批次）<br>
                            • QualityInspection N : 1 User（质检员）<br>
                            • 一个批次可以有多次质检（首检、终检、抽检）<br><br>

                            <strong style="color: #667eea;">原材料与供应商关系：</strong><br>
                            • MaterialBatch（原材料批次） N : 1 RawMaterialType（原材料类型）<br>
                            • MaterialBatch N : 1 Supplier（供应商）<br>
                            • MaterialBatch N : 1 Factory（所属工厂）<br><br>

                            <strong style="color: #667eea;">员工与考勤关系：</strong><br>
                            • EmployeeWorkSession（考勤记录） N : 1 User（员工）<br>
                            • EmployeeWorkSession N : 1 Factory（所属工厂）<br>
                            • 考勤记录包含打卡时间、GPS位置、工时统计<br><br>

                            <strong style="color: #667eea;">角色权限关系：</strong><br>
                            • User（用户） N : 1 Role（角色枚举）<br>
                            • 角色采用枚举类型，不使用单独的角色表<br>
                            • 权限通过代码中的权限配置文件管理<br>
                            • UserRoleHistory表记录角色变更历史
                        </p>
                    </div>
                </div>

                <h4 style="margin-top: 30px;">💡 设计理念解析</h4>
                <div class="feature-list">
                    <div class="feature-item">
                        <h4>为什么采用多租户单库设计？</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>理由：</strong><br>
                            • 成本优化：共享数据库资源，降低服务器成本<br>
                            • 运维简单：统一部署、统一备份、统一升级<br>
                            • 数据聚合：便于平台级数据分析和统计<br><br>

                            <strong>隔离保障：</strong><br>
                            • 所有业务表强制包含factoryId字段<br>
                            • API层自动添加租户过滤条件<br>
                            • 数据库级别的Row Level Security（RLS）策略<br>
                            • 严格的权限验证机制
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>为什么使用软删除？</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>理由：</strong><br>
                            • 数据安全：防止误删除，可随时恢复<br>
                            • 审计需求：保留完整的数据变更历史<br>
                            • 溯源要求：食品溯源需要永久保存生产记录<br><br>

                            <strong>实现方式：</strong><br>
                            • 所有重要表添加deletedAt字段（默认NULL）<br>
                            • 查询时自动过滤deletedAt不为空的记录<br>
                            • 定期归档超过保留期的软删除数据
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>为什么使用JSON字段？</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>理由：</strong><br>
                            • 灵活性：不同工厂的配置需求不同<br>
                            • 可扩展：无需修改数据库结构就能添加新字段<br>
                            • 性能：PostgreSQL对JSON有原生支持和索引<br><br>

                            <strong>应用场景：</strong><br>
                            • 产品配置：不同产品的工艺参数差异大<br>
                            • 质检项目：质检指标因产品类型而异<br>
                            • 设备参数：不同设备的监控指标不同
                        </p>
                    </div>
                </div>

                <h3>4.4 第三方集成</h3>

                <h4>🤖 DeepSeek AI智能分析</h4>
                <div class="info-box">
                    <p style="font-size: 1.1em; margin-bottom: 15px;"><strong>成本优化的AI集成方案</strong></p>
                    <p style="font-size: 1.05em; line-height: 2;">
                        <strong>为什么选择DeepSeek：</strong><br>
                        • 成本极低：比GPT-4便宜10倍以上<br>
                        • 中文友好：针对中文场景优化，理解更准确<br>
                        • API稳定：国内访问速度快，无需科学上网<br>
                        • 能力足够：满足生产成本分析、异常检测等场景
                    </p>
                </div>

                <div class="feature-list">
                    <div class="feature-item">
                        <h4>AI成本分析功能</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>分析场景：</strong><br>
                            • 批次成本异常检测（与历史数据对比）<br>
                            • 原材料消耗合理性分析<br>
                            • 人工成本优化建议<br>
                            • 生产效率提升建议<br><br>

                            <strong>触发方式：</strong><br>
                            • 用户主动请求分析<br>
                            • 批次完成后自动分析<br>
                            • 成本异常自动预警
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>成本控制策略</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>目标：每个工厂每月AI成本<¥30</strong><br><br>

                            <strong>控制措施：</strong><br>
                            • 智能缓存：5分钟内相似查询返回缓存结果<br>
                            • 数据预处理：压缩提示词，减少Token消耗<br>
                            • 配额限制：每个工厂每月API调用次数上限<br>
                            • 分级策略：普通分析用小模型，深度分析用大模型<br><br>

                            <strong>监控告警：</strong><br>
                            • 实时监控每个工厂的API使用量<br>
                            • 达到80%配额时提醒用户<br>
                            • 超过配额暂停AI功能，提示升级
                        </p>
                    </div>
                </div>

                <h4 style="margin-top: 40px;">☕ Spring Boot主服务架构</h4>
                <div class="success-box">
                    <p style="font-size: 1.05em; line-height: 2;">
                        <strong>为什么选择Spring Boot作为主后端：</strong><br><br>

                        <strong>① 企业级成熟度：</strong><br>
                        • Spring Boot是成熟稳定的企业级框架<br>
                        • 完善的生态系统和社区支持<br>
                        • 适合中小食品企业的长期稳定运行需求<br><br>

                        <strong>② 技术优势：</strong><br>
                        • 高性能、高并发处理能力<br>
                        • Spring Security提供完善的安全机制<br>
                        • Spring Data JPA简化数据库操作<br>
                        • 易于集成第三方服务（如Python AI）<br><br>

                        <strong>③ 运维便利性：</strong><br>
                        • 打包成独立JAR文件，部署简单<br>
                        • 内置Tomcat，无需额外配置Web服务器<br>
                        • 支持Docker容器化部署<br>
                        • 日志、监控、健康检查完善<br><br>

                        <strong>当前部署配置：</strong><br>
                        • JAR文件：/www/wwwroot/cretas/cretas-backend-system-1.0.0.jar<br>
                        • 运行端口：10010<br>
                        • 管理方式：宝塔面板 + 启动脚本<br>
                        • JDK版本：Java 11<br>
                        • Spring Boot版本：2.7.15
                    </p>
                </div>

                <h4 style="margin-top: 40px;">🎛️ 宝塔面板API集成</h4>
                <div class="success-box">
                    <p style="font-size: 1.05em; line-height: 2;">
                        <strong>服务器管理自动化：</strong><br><br>

                        <strong>集成功能：</strong><br>
                        • 应用重启：远程重启Spring Boot应用<br>
                        • 健康检查：监控应用运行状态<br>
                        • 日志查看：远程查看应用日志<br>
                        • 数据库管理：备份、恢复数据库<br><br>

                        <strong>使用场景：</strong><br>
                        • 开发者通过APP管理服务器（无需登录服务器）<br>
                        • 自动化部署流程<br>
                        • 应用监控和告警<br><br>

                        <strong>安全措施：</strong><br>
                        • API密钥加密存储<br>
                        • 签名验证机制<br>
                        • 仅限开发者角色访问
                    </p>
                </div>
            </section>

            <!-- 第5章：移动端设计 -->
            <section id="chapter-5">
                <h2><span class="section-number">5</span>移动端设计</h2>

                <h3>5.1 移动优先设计原则</h3>

                <div class="info-box">
                    <p style="font-size: 1.1em; margin-bottom: 15px;"><strong>📱 为什么选择移动优先？</strong></p>
                    <p style="font-size: 1.05em; line-height: 2;">
                        食品加工企业的工作场景决定了必须采用移动优先策略：<br><br>
                        <strong>① 生产现场需求：</strong><br>
                        • 员工在车间现场操作，无法使用台式电脑<br>
                        • 需要随时记录原材料入库、生产进度、质检结果<br>
                        • 拍照上传质检照片、扫描溯源码等功能必须在手机完成<br><br>

                        <strong>② 实时性要求：</strong><br>
                        • 生产数据需要实时录入，不能等到下班后补录<br>
                        • 管理者需要随时查看生产进度和成本数据<br>
                        • 异常情况需要立即通知相关人员<br><br>

                        <strong>③ 成本考虑：</strong><br>
                        • 中小食品企业预算有限，手机比电脑成本低<br>
                        • 员工自带设备（BYOD）可降低企业采购成本<br>
                        • 移动应用的维护和更新比PC软件更便捷
                    </p>
                </div>

                <h4 style="margin-top: 30px;">核心设计原则</h4>
                <div class="feature-list">
                    <div class="feature-item">
                        <h4>① 离线优先设计</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>为什么需要离线功能：</strong><br>
                            • 生产车间可能网络信号不稳定<br>
                            • 冷库、仓库等区域WiFi覆盖不完全<br>
                            • 保证数据录入不中断，提升用户体验<br><br>

                            <strong>离线功能设计：</strong><br>
                            • 核心数据本地缓存（生产批次、原材料、产品类型）<br>
                            • 离线时数据先保存到本地数据库<br>
                            • 网络恢复后自动同步到服务器<br>
                            • 冲突检测与解决机制<br>
                            • 用户界面明确显示在线/离线状态
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>② 单手操作优化</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>场景考虑：</strong><br>
                            • 生产员工可能需要一手拿物料，一手操作手机<br>
                            • 关键按钮放在大拇指容易触及的区域<br>
                            • 避免需要双手操作的手势（如双指缩放）<br><br>

                            <strong>设计规范：</strong><br>
                            • 主操作按钮放在屏幕底部<br>
                            • 按钮尺寸>=48dp，符合Material Design 3规范<br>
                            • 常用功能集中在底部导航栏<br>
                            • 表单输入支持语音输入（减少打字）
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>③ 快速录入优化</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>目标：</strong>每条记录录入时间<30秒<br><br>

                            <strong>优化策略：</strong><br>
                            • 智能默认值：根据历史记录自动填充常用数据<br>
                            • 快捷选择：常用选项置顶，减少滚动<br>
                            • 扫码输入：支持扫描溯源码、原材料批次码<br>
                            • 拍照识别：拍照自动识别产品类型（AI辅助）<br>
                            • 语音输入：支持语音转文字（如备注信息）<br>
                            • 批量操作：支持批量复制上一条记录
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>④ 性能优化目标</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>启动性能：</strong><br>
                            • 冷启动时间 < 3秒<br>
                            • 热启动时间 < 1秒<br>
                            • 首屏渲染时间 < 2秒<br><br>

                            <strong>运行性能：</strong><br>
                            • 页面切换动画流畅（60fps）<br>
                            • 列表滚动不卡顿（虚拟列表技术）<br>
                            • 内存占用 < 200MB（稳定状态）<br>
                            • 安装包大小 < 50MB<br><br>

                            <strong>网络优化：</strong><br>
                            • 图片自动压缩上传（质量70%）<br>
                            • 请求合并（批量接口）<br>
                            • 智能缓存（5分钟内相同请求返回缓存）
                        </p>
                    </div>
                </div>

                <h3>5.2 技术架构与核心库</h3>

                <h4>📦 React Native核心技术栈</h4>
                <div class="architecture-diagram" style="padding: 30px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white;">
                            <h4 style="color: white; margin: 0 0 15px 0;">🎯 基础框架</h4>
                            <p style="line-height: 2; font-size: 1.05em;">
                                <strong>React Native 0.79+</strong><br>
                                • 跨平台UI框架<br>
                                • 原生性能体验<br><br>

                                <strong>Expo 53+</strong><br>
                                • 快速开发工具链<br>
                                • 丰富的原生模块<br>
                                • OTA热更新支持
                            </p>
                        </div>

                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; color: white;">
                            <h4 style="color: white; margin: 0 0 15px 0;">🧭 导航与状态</h4>
                            <p style="line-height: 2; font-size: 1.05em;">
                                <strong>React Navigation 7+</strong><br>
                                • 权限驱动的智能导航<br>
                                • 深度链接支持<br><br>

                                <strong>Zustand</strong><br>
                                • 轻量状态管理<br>
                                • 持久化存储<br>
                                • TypeScript友好
                            </p>
                        </div>

                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 12px; color: white;">
                            <h4 style="color: white; margin: 0 0 15px 0;">🔒 安全与存储</h4>
                            <p style="line-height: 2; font-size: 1.05em;">
                                <strong>Expo SecureStore</strong><br>
                                • 加密存储敏感数据<br>
                                • JWT令牌安全保存<br><br>

                                <strong>Expo LocalAuthentication</strong><br>
                                • 指纹/面容识别<br>
                                • 生物识别快速登录
                            </p>
                        </div>

                        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 12px; color: white;">
                            <h4 style="color: white; margin: 0 0 15px 0;">📸 设备功能</h4>
                            <p style="line-height: 2; font-size: 1.05em;">
                                <strong>Expo Camera</strong><br>
                                • 拍照上传质检照片<br>
                                • 扫描溯源码<br><br>

                                <strong>Expo Location</strong><br>
                                • GPS位置追踪<br>
                                • 打卡签到定位
                            </p>
                        </div>
                    </div>
                </div>

                <h3>5.3 权限与导航系统</h3>

                <h4>🔐 8级角色权限体系</h4>
                <div class="info-box">
                    <p style="font-size: 1.05em; line-height: 2;">
                        移动应用完整实现后端的8级角色系统，导航菜单根据用户角色动态生成。
                    </p>
                </div>

                <div class="feature-list">
                    <div class="feature-item">
                        <h4>平台级角色（3个）</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>① 系统开发者（developer）</strong><br>
                            <strong>权限范围：</strong>全系统最高权限<br>
                            <strong>可见功能：</strong><br>
                            • 所有工厂数据查看<br>
                            • 平台管理功能（工厂管理、AI配额管理）<br>
                            • 宝塔面板集成（服务器管理）<br>
                            • 系统配置和开发工具<br><br>

                            <strong>② 平台超级管理员（platform_admin）</strong><br>
                            <strong>权限范围：</strong>平台级管理权限<br>
                            <strong>可见功能：</strong><br>
                            • 工厂管理（创建、停用工厂）<br>
                            • AI配额管理（分配各工厂配额）<br>
                            • 平台数据报表<br>
                            • 用户白名单管理<br><br>

                            <strong>③ 平台运营人员（platform_operator）</strong><br>
                            <strong>权限范围：</strong>有限的平台操作权限<br>
                            <strong>可见功能：</strong><br>
                            • 查看工厂列表和基本信息<br>
                            • 处理用户注册申请<br>
                            • 查看平台使用统计<br>
                            • 无法修改工厂配置和敏感信息
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>工厂级角色（5个）</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>① 工厂超级管理员（factory_super_admin）</strong><br>
                            <strong>权限范围：</strong>所属工厂的全部权限<br>
                            <strong>可见功能：</strong><br>
                            • 生产管理全部功能<br>
                            • 用户管理（分配角色）<br>
                            • 工厂设置（配置产品、原材料、工艺参数）<br>
                            • 数据导出和报表<br><br>

                            <strong>② 权限管理员（permission_admin）</strong><br>
                            <strong>权限范围：</strong>用户和权限管理<br>
                            <strong>可见功能：</strong><br>
                            • 用户注册审批<br>
                            • 角色分配和权限调整<br>
                            • 查看用户操作日志<br>
                            • 无法修改生产数据和工厂配置<br><br>

                            <strong>③ 部门管理员（department_admin）</strong><br>
                            <strong>权限范围：</strong>所属部门的管理权限<br>
                            <strong>可见功能：</strong><br>
                            • 部门员工管理<br>
                            • 部门生产数据查看和编辑<br>
                            • 部门绩效报表<br>
                            • 无法查看其他部门数据<br><br>

                            <strong>④ 操作员（operator）</strong><br>
                            <strong>权限范围：</strong>日常操作权限<br>
                            <strong>可见功能：</strong><br>
                            • 生产批次录入和编辑<br>
                            • 原材料入库和消耗记录<br>
                            • 质检记录录入<br>
                            • 工时打卡<br>
                            • 查看自己负责的生产数据<br><br>

                            <strong>⑤ 查看者（viewer）</strong><br>
                            <strong>权限范围：</strong>只读权限<br>
                            <strong>可见功能：</strong><br>
                            • 查看生产数据和报表<br>
                            • 查看质检记录<br>
                            • 查看成本分析<br>
                            • 无法创建、编辑、删除任何数据
                        </p>
                    </div>
                </div>

                <h4 style="margin-top: 30px;">🧭 智能导航系统</h4>
                <div class="success-box">
                    <p style="font-size: 1.05em; line-height: 2;">
                        <strong>导航菜单动态生成流程：</strong><br><br>

                        <strong>步骤1：用户登录成功</strong><br>
                        → 后端返回用户信息（包含role、factoryId、permissions）<br>
                        → 前端保存到Zustand authStore<br><br>

                        <strong>步骤2：权限计算</strong><br>
                        → permissionStore根据用户role计算可见模块<br>
                        → 生成permissions对象（如canViewProcessing、canEditBatch等）<br><br>

                        <strong>步骤3：导航渲染</strong><br>
                        → 底部导航栏根据permissions显示/隐藏标签<br>
                        → 侧边菜单根据permissions过滤菜单项<br>
                        → 页面内按钮根据permissions启用/禁用<br><br>

                        <strong>步骤4：路由守卫</strong><br>
                        → 用户点击菜单时检查权限<br>
                        → 无权限时显示提示并阻止导航<br>
                        → 直接输入URL时也会被拦截<br><br>

                        <strong>示例：operator角色的导航</strong><br>
                        <strong>底部导航栏显示：</strong>首页、生产管理、打卡、我的<br>
                        <strong>隐藏：</strong>平台管理、工厂设置、用户管理<br>
                        <strong>生产管理菜单：</strong>显示"批次列表、创建批次、质检记录"<br>
                        <strong>隐藏：</strong>"成本分析、数据导出"（仅管理员可见）
                    </p>
                </div>

                <h3>5.4 核心功能模块</h3>

                <h4>🔑 认证模块</h4>
                <div class="feature-list">
                    <div class="feature-item">
                        <h4>多阶段注册流程</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>阶段1：手机号验证</strong><br>
                            → 用户输入手机号<br>
                            → 系统检查手机号是否在白名单中<br>
                            → 发送验证码（未来集成短信服务）<br>
                            → 验证成功后生成TempToken<br><br>

                            <strong>阶段2：完善资料</strong><br>
                            → 使用TempToken访问注册表单<br>
                            → 填写用户名、密码、姓名、部门等信息<br>
                            → 提交后创建账号（状态为"unactivated"）<br>
                            → 等待管理员审批<br><br>

                            <strong>阶段3：管理员审批</strong><br>
                            → 工厂管理员在"用户管理"页面查看待审批用户<br>
                            → 分配角色和权限<br>
                            → 激活账号<br>
                            → 用户收到通知，可正常登录
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>生物识别登录</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>首次启用流程：</strong><br>
                            → 用户首次登录成功后，系统提示"是否启用指纹登录？"<br>
                            → 用户同意后，使用Expo LocalAuthentication验证生物识别可用性<br>
                            → 验证成功后，将JWT Token加密保存到SecureStore<br>
                            → 下次打开APP直接显示生物识别弹窗<br><br>

                            <strong>后续登录流程：</strong><br>
                            → 打开APP → 检测到已保存的加密Token → 显示生物识别弹窗<br>
                            → 用户验证指纹/面容 → 解密Token → 自动登录<br>
                            → 失败3次后退回密码登录<br><br>

                            <strong>安全措施：</strong><br>
                            • Token使用AES-256加密存储<br>
                            • 生物识别失败会锁定设备（系统级安全）<br>
                            • 用户可随时在设置中关闭生物识别<br>
                            • 换设备后需要重新启用
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>设备绑定机制</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>绑定流程：</strong><br>
                            → 用户首次在新设备登录<br>
                            → 系统生成唯一DeviceId（基于设备硬件信息）<br>
                            → 后端记录用户-设备绑定关系<br>
                            → 颁发DeviceToken（与设备绑定）<br><br>

                            <strong>安全检查：</strong><br>
                            • 每次API请求携带DeviceToken<br>
                            • 后端验证Token是否匹配当前设备<br>
                            • 检测异地登录（IP地址变化）<br>
                            • 发现异常时强制重新登录<br><br>

                            <strong>设备管理：</strong><br>
                            • 用户可在"我的设备"页面查看已登录设备<br>
                            • 支持远程踢出其他设备<br>
                            • 限制最多3台设备同时在线
                        </p>
                    </div>
                </div>

                <h4 style="margin-top: 40px;">🏭 生产管理模块</h4>
                <div class="feature-list">
                    <div class="feature-item">
                        <h4>批次管理</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>创建批次界面：</strong><br>
                            • 选择产品类型（下拉列表，支持搜索）<br>
                            • 输入目标产量（数字键盘）<br>
                            • 选择负责人（从员工列表选择）<br>
                            • 拍摄现场照片（可选，最多3张）<br>
                            • 备注信息（语音输入支持）<br>
                            • 点击"创建批次"后自动生成溯源码<br><br>

                            <strong>批次详情页：</strong><br>
                            • 顶部显示批次状态（彩色标签）<br>
                            • 溯源码二维码（可分享）<br>
                            • 原材料消耗列表（可展开查看详情）<br>
                            • 生产进度条（已完成/目标产量）<br>
                            • 工时统计（参与人员和工时）<br>
                            • 质检记录（合格率统计）<br>
                            • AI成本分析按钮（点击查看智能分析）<br><br>

                            <strong>操作按钮：</strong><br>
                            • 开始生产（状态：计划中 → 生产中）<br>
                            • 记录消耗（打开原材料消耗表单）<br>
                            • 更新进度（输入已完成数量）<br>
                            • 完成生产（状态：生产中 → 已完成）
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>原材料管理</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>入库流程：</strong><br>
                            → 点击"原材料入库"<br>
                            → 扫描供应商二维码（自动填充供应商信息）<br>
                            → 选择原材料类型<br>
                            → 输入入库数量和单价<br>
                            → 拍摄原材料照片（质量检查）<br>
                            → 提交后生成批次码（自动编号）<br><br>

                            <strong>消耗记录：</strong><br>
                            → 在生产批次中点击"记录消耗"<br>
                            → 扫描原材料批次码（自动填充信息）<br>
                            → 输入消耗数量<br>
                            → 系统自动计算成本<br>
                            → 自动扣减库存<br>
                            → 库存不足时弹出警告<br><br>

                            <strong>库存查询：</strong><br>
                            • 按原材料类型分组显示<br>
                            • 显示总库存、可用库存、冻结库存<br>
                            • 低库存预警（红色标签）<br>
                            • 支持按供应商筛选<br>
                            • 支持按批次查看明细
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>质检管理</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>质检录入界面：</strong><br>
                            → 关联生产批次（扫码或列表选择）<br>
                            → 选择质检类型（原材料检验、过程检验、成品检验）<br>
                            → 填写质检项目（根据产品类型动态生成）<br>
                            → 拍摄质检照片（支持多张，自动压缩）<br>
                            → 填写质检结果（合格/不合格）<br>
                            → 不合格时必须填写问题描述<br>
                            → 提交后自动更新批次质检统计<br><br>

                            <strong>质检报告：</strong><br>
                            • 批次质检汇总（合格率、不合格原因分布）<br>
                            • 质检照片画廊（可滑动查看）<br>
                            • 质检历史趋势图（按时间线显示）<br>
                            • 支持导出PDF报告（带照片）
                        </p>
                    </div>
                </div>

                <h4 style="margin-top: 40px;">⏰ 考勤打卡模块</h4>
                <div class="feature-list">
                    <div class="feature-item">
                        <h4>打卡界面设计</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>主界面元素：</strong><br>
                            • 顶部显示当前时间（大字体）<br>
                            • 中央显示"上班打卡"或"下班打卡"按钮（根据状态自动切换）<br>
                            • 显示当前定位地址（GPS获取）<br>
                            • 今日工时统计（上班时间、已工作时长）<br>
                            • 本周工时汇总卡片<br><br>

                            <strong>打卡流程：</strong><br>
                            → 点击"上班打卡"按钮<br>
                            → 自动获取GPS位置（需要位置权限）<br>
                            → 验证是否在工厂围栏范围内（地理围栏）<br>
                            → 验证成功后记录打卡时间和位置<br>
                            → 显示打卡成功动画<br>
                            → 按钮自动切换为"下班打卡"<br><br>

                            <strong>异常处理：</strong><br>
                            • GPS定位失败：提示手动选择位置<br>
                            • 不在工厂范围：提示"外勤打卡"（需管理员审批）<br>
                            • 重复打卡：提示已打卡，显示打卡时间<br>
                            • 忘记下班打卡：次日提示补卡申请
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>工时统计页面</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>日历视图：</strong><br>
                            • 月历显示，每天显示工时小时数<br>
                            • 正常出勤：绿色标记<br>
                            • 迟到/早退：黄色标记<br>
                            • 缺勤：红色标记<br>
                            • 点击日期查看当天详细记录<br><br>

                            <strong>统计卡片：</strong><br>
                            • 本月总工时<br>
                            • 正常出勤天数<br>
                            • 迟到次数<br>
                            • 加班时长<br>
                            • 平均每日工时<br><br>

                            <strong>记录明细：</strong><br>
                            • 每条记录显示：日期、上班时间、下班时间、工时<br>
                            • 标注异常情况（迟到、早退、忘记打卡）<br>
                            • 支持申请补卡（填写原因，等待审批）
                        </p>
                    </div>
                </div>

                <h4 style="margin-top: 40px;">🤖 AI智能分析</h4>
                <div class="feature-list">
                    <div class="feature-item">
                        <h4>成本分析功能</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>触发方式：</strong><br>
                            • 在批次详情页点击"AI成本分析"按钮<br>
                            • 批次完成后自动推送分析结果（可选）<br><br>

                            <strong>分析内容：</strong><br>
                            → 系统收集批次数据（原材料消耗、人工成本、完成数量等）<br>
                            → 调用Python AI服务（DeepSeek API）<br>
                            → AI分析成本构成和异常点<br>
                            → 返回分析报告（JSON格式）<br>
                            → 移动端渲染为可读的卡片式报告<br><br>

                            <strong>报告内容包括：</strong><br>
                            • 成本总览（原材料、人工、其他）<br>
                            • 与历史平均对比（成本是否异常）<br>
                            • 异常原因分析（如"原材料单价上涨20%"）<br>
                            • 优化建议（如"考虑更换供应商A"）<br>
                            • 成本趋势预测（下次生产预估成本）<br><br>

                            <strong>用户交互：</strong><br>
                            • 分析中显示加载动画<br>
                            • 分析完成后显示结果卡片<br>
                            • 支持收藏报告（保存到本地）<br>
                            • 支持分享报告（导出PDF）
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>智能推荐功能（未来扩展）</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>生产计划推荐：</strong><br>
                            • AI根据历史销售数据预测下月需求<br>
                            • 自动生成生产计划建议<br>
                            • 优化原材料采购时机和数量<br><br>

                            <strong>质量预警：</strong><br>
                            • AI分析质检历史，预测质量风险<br>
                            • 提前预警可能出现的质量问题<br>
                            • 推荐质检重点关注项<br><br>

                            <strong>供应商评分：</strong><br>
                            • AI综合评估供应商表现（价格、质量、准时率）<br>
                            • 推荐最佳供应商组合<br>
                            • 预警供应商风险
                        </p>
                    </div>
                </div>
            </section>

            <!-- 第6章：数据流与业务流程 -->
            <section id="chapter-6">
                <h2><span class="section-number">6</span>数据流与业务流程</h2>

                <h3>6.1 核心业务流程</h3>

                <h4>🏭 完整生产流程（端到端）</h4>
                <div class="architecture-diagram">
                    <div style="padding: 30px;">
                        <div class="info-box">
                            <p style="font-size: 1.1em; margin-bottom: 15px;"><strong>从原材料采购到成品出库的完整数据流</strong></p>
                        </div>

                        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 20px;">
                            <h4 style="color: #667eea; margin: 0 0 20px 0;">阶段1：供应商管理与原材料采购</h4>
                            <p style="font-size: 1.05em; line-height: 2.2; color: #555;">
                                <strong>步骤1：供应商注册</strong><br>
                                → 工厂管理员在APP中添加新供应商<br>
                                → 填写供应商基本信息（公司名称、联系方式、地址）<br>
                                → 系统生成供应商唯一ID和二维码<br>
                                → 二维码可打印贴在供应商送货单上<br><br>

                                <strong>步骤2：原材料类型配置</strong><br>
                                → 在"工厂设置"中配置原材料类型（如：鱼肉、调料、包装材料）<br>
                                → 设置单位（kg、个、箱等）<br>
                                → 关联供应商（一种原材料可对应多个供应商）<br>
                                → 设置库存预警阈值（低于该值自动提醒采购）<br><br>

                                <strong>步骤3：原材料入库</strong><br>
                                → 仓库员工打开APP → 点击"原材料入库"<br>
                                → 扫描供应商二维码（自动填充供应商信息）<br>
                                → 选择原材料类型<br>
                                → 输入入库数量和单价<br>
                                → 拍摄原材料照片（质量检查依据）<br>
                                → 提交后：<br>
                                &nbsp;&nbsp;• 后端生成原材料批次记录（自动编号，如：MAT_2024001）<br>
                                &nbsp;&nbsp;• 更新库存表（总库存+入库数量）<br>
                                &nbsp;&nbsp;• 记录供应商交易历史<br>
                                &nbsp;&nbsp;• 通知管理员"新批次入库"
                            </p>
                        </div>

                        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 20px;">
                            <h4 style="color: #667eea; margin: 0 0 20px 0;">阶段2：生产计划与批次创建</h4>
                            <p style="font-size: 1.05em; line-height: 2.2; color: #555;">
                                <strong>步骤1：创建生产计划</strong><br>
                                → 管理员根据订单需求创建生产计划<br>
                                → 填写计划信息：产品类型、目标产量、计划日期<br>
                                → 系统自动计算所需原材料（根据产品配方）<br>
                                → 检查库存是否充足：<br>
                                &nbsp;&nbsp;• 充足：显示绿色标签，可直接执行<br>
                                &nbsp;&nbsp;• 不足：显示红色警告，提示采购<br><br>

                                <strong>步骤2：创建生产批次</strong><br>
                                → 操作员在APP中点击"创建生产批次"<br>
                                → 选择产品类型（如：鱼丸、鱼饼）<br>
                                → 输入目标产量（单位：kg或个）<br>
                                → 选择负责人（从员工列表中选择）<br>
                                → 可选：拍摄生产现场照片<br>
                                → 提交后：<br>
                                &nbsp;&nbsp;• 后端生成溯源码（唯一标识，如：FISH_2024_001）<br>
                                &nbsp;&nbsp;• 创建批次记录（状态：计划中）<br>
                                &nbsp;&nbsp;• 分配负责人，发送任务通知<br>
                                &nbsp;&nbsp;• 生成二维码（可打印贴在产品包装上）
                            </p>
                        </div>

                        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 20px;">
                            <h4 style="color: #667eea; margin: 0 0 20px 0;">阶段3：生产过程管理</h4>
                            <p style="font-size: 1.05em; line-height: 2.2; color: #555;">
                                <strong>步骤1：开始生产</strong><br>
                                → 负责人在批次详情页点击"开始生产"<br>
                                → 批次状态：计划中 → 生产中<br>
                                → 系统记录开始时间<br>
                                → 通知相关人员"批次已开始生产"<br><br>

                                <strong>步骤2：记录原材料消耗</strong><br>
                                → 在批次详情页点击"记录消耗"<br>
                                → 扫描原材料批次码（自动填充信息）<br>
                                → 输入消耗数量<br>
                                → 提交后：<br>
                                &nbsp;&nbsp;• 创建消耗记录（关联批次和原材料）<br>
                                &nbsp;&nbsp;• 自动扣减库存（总库存-消耗数量）<br>
                                &nbsp;&nbsp;• 计算成本（消耗数量 × 单价）<br>
                                &nbsp;&nbsp;• 累加到批次总成本<br>
                                &nbsp;&nbsp;• 库存不足时弹出警告，阻止提交<br><br>

                                <strong>步骤3：更新生产进度</strong><br>
                                → 定期更新已完成数量（如：已生产500kg）<br>
                                → 系统计算进度百分比（已完成/目标产量）<br>
                                → 在批次详情页显示进度条<br>
                                → 达到100%时自动提示"完成生产"<br><br>

                                <strong>步骤4：记录工时</strong><br>
                                → 员工通过打卡记录工作时间<br>
                                → 系统关联批次和员工工时<br>
                                → 自动计算人工成本（工时 × 时薪）<br>
                                → 累加到批次总成本
                            </p>
                        </div>

                        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 20px;">
                            <h4 style="color: #667eea; margin: 0 0 20px 0;">阶段4：质量检验</h4>
                            <p style="font-size: 1.05em; line-height: 2.2; color: #555;">
                                <strong>质检类型：</strong><br>
                                • 原材料检验（入库时）<br>
                                • 过程检验（生产中）<br>
                                • 成品检验（生产完成后）<br><br>

                                <strong>质检流程：</strong><br>
                                → 质检员打开APP → 点击"质检记录"<br>
                                → 选择质检类型<br>
                                → 关联生产批次（扫码或列表选择）<br>
                                → 填写质检项目（系统根据产品类型动态生成）<br>
                                → 拍摄质检照片（支持多张）<br>
                                → 填写质检结果：<br>
                                &nbsp;&nbsp;• 合格：直接提交<br>
                                &nbsp;&nbsp;• 不合格：必须填写问题描述和处理意见<br>
                                → 提交后：<br>
                                &nbsp;&nbsp;• 创建质检记录<br>
                                &nbsp;&nbsp;• 更新批次质检统计（合格率）<br>
                                &nbsp;&nbsp;• 不合格时通知负责人和管理员<br>
                                &nbsp;&nbsp;• 严重问题时可暂停批次生产
                            </p>
                        </div>

                        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 20px;">
                            <h4 style="color: #667eea; margin: 0 0 20px 0;">阶段5：完成生产与成本分析</h4>
                            <p style="font-size: 1.05em; line-height: 2.2; color: #555;">
                                <strong>步骤1：完成生产</strong><br>
                                → 负责人确认生产完成<br>
                                → 点击"完成生产"按钮<br>
                                → 批次状态：生产中 → 已完成<br>
                                → 系统记录完成时间<br>
                                → 计算总耗时（完成时间 - 开始时间）<br><br>

                                <strong>步骤2：自动成本汇总</strong><br>
                                → 系统自动汇总批次成本：<br>
                                &nbsp;&nbsp;• 原材料成本（所有消耗记录的成本总和）<br>
                                &nbsp;&nbsp;• 人工成本（所有员工工时 × 时薪）<br>
                                &nbsp;&nbsp;• 其他成本（水电、设备折旧等）<br>
                                &nbsp;&nbsp;• 总成本 = 原材料成本 + 人工成本 + 其他成本<br>
                                → 计算单位成本（总成本 / 完成数量）<br>
                                → 在批次详情页显示成本卡片<br><br>

                                <strong>步骤3：AI智能分析（可选）</strong><br>
                                → 管理员点击"AI成本分析"按钮<br>
                                → 移动端向后端发送分析请求<br>
                                → 后端收集批次数据：<br>
                                &nbsp;&nbsp;• 原材料消耗明细<br>
                                &nbsp;&nbsp;• 人工工时明细<br>
                                &nbsp;&nbsp;• 历史批次成本数据（用于对比）<br>
                                → 后端调用Python AI服务（DeepSeek API）<br>
                                → AI分析成本异常和优化建议<br>
                                → 返回分析报告（JSON格式）<br>
                                → 移动端渲染为可读的卡片式报告<br>
                                → 用户可保存或分享报告
                            </p>
                        </div>

                        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 20px;">
                            <h4 style="color: #667eea; margin: 0 0 20px 0;">阶段6：成品入库与溯源</h4>
                            <p style="font-size: 1.05em; line-height: 2.2; color: #555;">
                                <strong>步骤1：成品入库</strong><br>
                                → 仓库员工在批次详情页点击"成品入库"<br>
                                → 批次状态：已完成 → 已入库<br>
                                → 更新产品库存（成品库存+完成数量）<br>
                                → 生成成品二维码（用于出库和销售）<br><br>

                                <strong>步骤2：溯源查询</strong><br>
                                → 消费者扫描产品包装上的溯源码<br>
                                → 系统返回溯源信息：<br>
                                &nbsp;&nbsp;• 产品基本信息（名称、规格、生产日期）<br>
                                &nbsp;&nbsp;• 原材料来源（供应商、入库日期）<br>
                                &nbsp;&nbsp;• 生产过程（负责人、生产时间）<br>
                                &nbsp;&nbsp;• 质检结果（合格率、质检照片）<br>
                                &nbsp;&nbsp;• 工厂信息（名称、地址、联系方式）<br>
                                → 提升消费者信任度，符合食品安全法规
                            </p>
                        </div>
                    </div>
                </div>

                <h3>6.2 数据同步机制</h3>

                <h4>☁️ 离线-在线同步策略</h4>
                <div class="info-box">
                    <p style="font-size: 1.05em; line-height: 2;">
                        <strong>设计理念：</strong>保证生产现场网络不稳定时，数据录入不中断，网络恢复后自动同步到服务器。
                    </p>
                </div>

                <div class="feature-list">
                    <div class="feature-item">
                        <h4>本地存储策略</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>缓存数据类型：</strong><br>
                            • 核心数据（长期缓存）：<br>
                            &nbsp;&nbsp;- 用户信息（角色、权限）<br>
                            &nbsp;&nbsp;- 工厂配置（产品类型、原材料类型）<br>
                            &nbsp;&nbsp;- 供应商列表<br>
                            &nbsp;&nbsp;- 员工列表<br><br>

                            • 业务数据（临时缓存）：<br>
                            &nbsp;&nbsp;- 最近30天的生产批次<br>
                            &nbsp;&nbsp;- 库存数据（实时更新）<br>
                            &nbsp;&nbsp;- 待同步的离线记录<br><br>

                            <strong>存储技术：</strong><br>
                            • React Native AsyncStorage（持久化）<br>
                            • SQLite本地数据库（复杂查询）<br>
                            • Expo SecureStore（敏感数据）
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>离线操作流程</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>步骤1：检测网络状态</strong><br>
                            → 移动端使用NetInfo监听网络状态<br>
                            → 在线：显示绿色网络图标<br>
                            → 离线：显示红色离线图标+提示<br><br>

                            <strong>步骤2：离线数据录入</strong><br>
                            → 用户在离线状态下正常操作（如创建批次、记录消耗）<br>
                            → 数据先保存到本地数据库（SQLite）<br>
                            → 标记为"待同步"状态（isSynced: false）<br>
                            → 在界面上显示"离线记录"标签<br><br>

                            <strong>步骤3：网络恢复后自动同步</strong><br>
                            → 监听到网络恢复事件<br>
                            → 查询所有"待同步"记录<br>
                            → 按时间顺序依次上传到服务器<br>
                            → 上传成功后：<br>
                            &nbsp;&nbsp;• 更新本地记录状态（isSynced: true）<br>
                            &nbsp;&nbsp;• 更新服务器返回的ID（替换本地临时ID）<br>
                            &nbsp;&nbsp;• 显示同步成功提示<br>
                            → 上传失败时：<br>
                            &nbsp;&nbsp;• 保留"待同步"状态<br>
                            &nbsp;&nbsp;• 下次网络可用时重试<br>
                            &nbsp;&nbsp;• 记录错误日志供调试
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>冲突检测与解决</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>冲突场景：</strong><br>
                            • 场景1：多个员工同时编辑同一批次<br>
                            • 场景2：离线期间服务器数据已更新<br>
                            • 场景3：库存被其他用户消耗，导致库存不足<br><br>

                            <strong>解决策略：</strong><br>
                            • 乐观锁机制：<br>
                            &nbsp;&nbsp;- 数据带有version字段<br>
                            &nbsp;&nbsp;- 提交时检查version是否匹配<br>
                            &nbsp;&nbsp;- 不匹配时提示"数据已更新，请刷新后重试"<br><br>

                            • 库存冲突：<br>
                            &nbsp;&nbsp;- 同步前先检查当前库存<br>
                            &nbsp;&nbsp;- 库存不足时提示用户<br>
                            &nbsp;&nbsp;- 需要管理员审批或调整消耗数量<br><br>

                            • 关键字段冲突：<br>
                            &nbsp;&nbsp;- 服务器优先原则<br>
                            &nbsp;&nbsp;- 提示用户查看差异<br>
                            &nbsp;&nbsp;- 支持手动合并或丢弃本地更改
                        </p>
                    </div>
                </div>

                <h3>6.3 实时通知与告警</h3>

                <h4>🔔 通知系统设计</h4>
                <div class="feature-list">
                    <div class="feature-item">
                        <h4>通知类型</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>① 任务通知：</strong><br>
                            • 新生产批次分配<br>
                            • 质检任务分配<br>
                            • 补卡申请审批通知<br><br>

                            <strong>② 数据更新通知：</strong><br>
                            • 批次状态变更（开始生产、完成生产）<br>
                            • 库存变动（入库、消耗、盘点）<br>
                            • 质检结果更新<br><br>

                            <strong>③ 异常告警：</strong><br>
                            • 库存不足预警<br>
                            • 质检不合格告警<br>
                            • 成本异常告警<br>
                            • 设备故障告警（未来扩展）<br><br>

                            <strong>④ 系统通知：</strong><br>
                            • 用户注册待审批<br>
                            • 权限变更通知<br>
                            • 系统维护通知
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>通知推送机制</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>推送渠道：</strong><br>
                            • APP内通知（Notification Center）<br>
                            • 推送通知（Expo Push Notifications）<br>
                            • 短信通知（未来集成，紧急情况）<br><br>

                            <strong>推送流程：</strong><br>
                            → 后端业务逻辑触发通知事件<br>
                            → 后端查询目标用户（根据角色和权限）<br>
                            → 创建通知记录（数据库Notification表）<br>
                            → 调用Expo Push Notification API发送推送<br>
                            → 移动端接收推送：<br>
                            &nbsp;&nbsp;• APP在前台：显示应用内通知<br>
                            &nbsp;&nbsp;• APP在后台/关闭：显示系统推送通知<br>
                            &nbsp;&nbsp;• 用户点击通知：跳转到对应页面<br><br>

                            <strong>通知管理：</strong><br>
                            • 用户可在"通知中心"查看所有通知<br>
                            • 支持标记为已读/未读<br>
                            • 支持删除通知<br>
                            • 支持通知偏好设置（关闭某类通知）
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>库存预警机制</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>预警规则：</strong><br>
                            → 每种原材料设置安全库存阈值（如：最低500kg）<br>
                            → 系统定时检查库存（每小时）<br>
                            → 库存低于阈值时触发预警<br><br>

                            <strong>预警级别：</strong><br>
                            • 黄色预警：库存 < 安全库存的150%<br>
                            &nbsp;&nbsp;- 通知采购员关注<br>
                            &nbsp;&nbsp;- 在原材料列表显示黄色标签<br><br>

                            • 红色预警：库存 < 安全库存<br>
                            &nbsp;&nbsp;- 立即通知采购员和管理员<br>
                            &nbsp;&nbsp;- 在原材料列表显示红色标签<br>
                            &nbsp;&nbsp;- 创建生产批次时弹出警告<br><br>

                            • 紧急预警：库存 = 0<br>
                            &nbsp;&nbsp;- 推送紧急通知给所有管理员<br>
                            &nbsp;&nbsp;- 阻止创建需要该原材料的生产批次<br>
                            &nbsp;&nbsp;- 建议暂停相关生产计划
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>质量异常告警</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>触发条件：</strong><br>
                            • 单次质检不合格<br>
                            • 批次合格率 < 设定阈值（如95%）<br>
                            • 连续多次质检不合格（如3次）<br><br>

                            <strong>告警流程：</strong><br>
                            → 质检员提交不合格质检记录<br>
                            → 系统创建质量异常告警<br>
                            → 立即通知：<br>
                            &nbsp;&nbsp;• 批次负责人<br>
                            &nbsp;&nbsp;• 质检主管<br>
                            &nbsp;&nbsp;• 工厂管理员<br>
                            → 在批次详情页显示红色"质量异常"标签<br>
                            → 严重问题时可暂停批次生产<br>
                            → 要求填写整改措施和复检计划<br><br>

                            <strong>闭环管理：</strong><br>
                            • 创建整改任务<br>
                            • 跟踪整改进度<br>
                            • 复检验证<br>
                            • 记录整改结果<br>
                            • 汇总到质量报表
                        </p>
                    </div>
                </div>
            </section>

            <!-- 第7章：部署与运维 -->
            <section id="chapter-7">
                <h2><span class="section-number">7</span>部署与运维</h2>

                <h3>7.1 部署架构</h3>

                <h4>🚀 系统部署拓扑</h4>
                <div class="architecture-diagram">
                    <div style="padding: 30px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; color: white;">
                                <h4 style="color: white; margin: 0 0 15px 0;">📱 移动端部署</h4>
                                <p style="line-height: 2; font-size: 1.05em;">
                                    <strong>开发环境：</strong><br>
                                    • Expo开发服务器（本地）<br>
                                    • 热重载和即时刷新<br>
                                    • 开发者工具调试<br><br>

                                    <strong>测试环境：</strong><br>
                                    • Expo EAS Build<br>
                                    • 内部测试APK分发<br>
                                    • TestFlight（iOS）<br><br>

                                    <strong>生产环境：</strong><br>
                                    • Google Play商店<br>
                                    • 企业内部分发（APK）<br>
                                    • OTA热更新支持
                                </p>
                            </div>

                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 25px; border-radius: 12px; color: white;">
                                <h4 style="color: white; margin: 0 0 15px 0;">⚙️ 后端部署</h4>
                                <p style="line-height: 2; font-size: 1.05em;">
                                    <strong>开发环境：</strong><br>
                                    • 本地MySQL数据库<br>
                                    • Spring Boot本地运行<br>
                                    • 端口：10010<br><br>

                                    <strong>生产环境：</strong><br>
                                    • 服务器：139.196.165.140<br>
                                    • 部署路径：/www/wwwroot/cretas/<br>
                                    • JAR文件独立运行<br>
                                    • 宝塔面板管理（https://139.196.165.140:16435）<br>
                                    • 端口：10010（公网访问）
                                </p>
                            </div>

                            <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 25px; border-radius: 12px; color: white;">
                                <h4 style="color: white; margin: 0 0 15px 0;">🗄️ 数据库部署</h4>
                                <p style="line-height: 2; font-size: 1.05em;">
                                    <strong>开发环境：</strong><br>
                                    • MySQL 8.0本地安装<br>
                                    • 端口：3306<br>
                                    • 数据库：cretas_dev<br><br>

                                    <strong>生产环境：</strong><br>
                                    • MySQL 8.0服务器部署<br>
                                    • 主从复制（未来规划）<br>
                                    • 定时备份（每日）<br>
                                    • 数据库：cretas_prod
                                </p>
                            </div>

                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 25px; border-radius: 12px; color: white;">
                                <h4 style="color: white; margin: 0 0 15px 0;">🤖 AI服务部署</h4>
                                <p style="line-height: 2; font-size: 1.05em;">
                                    <strong>部署方式：</strong><br>
                                    • Python独立服务<br>
                                    • Flask/FastAPI框架<br>
                                    • 与Spring Boot通过HTTP通信<br><br>

                                    <strong>DeepSeek集成：</strong><br>
                                    • API密钥安全存储<br>
                                    • 请求缓存（Redis）<br>
                                    • 成本监控和配额管理<br>
                                    • 目标：<¥30/工厂/月
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <h4 style="margin-top: 40px;">🔄 部署流程</h4>
                <div class="feature-list">
                    <div class="feature-item">
                        <h4>后端部署流程</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>步骤1：本地构建</strong><br>
                            → 在项目根目录执行：mvn clean package -DskipTests<br>
                            → 生成JAR文件：target/cretas-backend-system-1.0.0.jar<br>
                            → 验证JAR文件大小和完整性<br><br>

                            <strong>步骤2：上传到服务器</strong><br>
                            → 使用SCP或SFTP上传JAR到服务器<br>
                            → 目标路径：/www/wwwroot/cretas/<br>
                            → 备份旧版本JAR（如：cretas-backend-system-1.0.0.jar.bak）<br><br>

                            <strong>步骤3：重启服务</strong><br>
                            → SSH登录服务器或使用宝塔面板<br>
                            → 执行重启脚本：bash /www/wwwroot/cretas/restart.sh<br>
                            → 脚本内容：<br>
                            &nbsp;&nbsp;• 杀死旧进程（ps aux + kill）<br>
                            &nbsp;&nbsp;• 启动新JAR（nohup java -jar）<br>
                            &nbsp;&nbsp;• 输出日志到cretas-backend.log<br><br>

                            <strong>步骤4：验证部署</strong><br>
                            → 检查进程是否运行：ps aux | grep cretas<br>
                            → 访问健康检查接口：curl http://139.196.165.140:10010/health<br>
                            → 查看日志确认无错误：tail -f cretas-backend.log<br>
                            → 移动端测试登录和核心功能
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>移动端部署流程</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>开发构建：</strong><br>
                            → 在CretasFoodTrace目录执行：npx expo start<br>
                            → 通过Expo Go APP扫码测试<br>
                            → 支持热重载，快速迭代<br><br>

                            <strong>测试构建：</strong><br>
                            → 使用Expo EAS Build创建测试APK<br>
                            → 配置eas.json（development/preview profile）<br>
                            → 执行：eas build --platform android --profile preview<br>
                            → 下载APK并分发给测试人员<br><br>

                            <strong>生产构建：</strong><br>
                            → 配置生产环境变量（API地址、密钥等）<br>
                            → 执行：eas build --platform android --profile production<br>
                            → 生成签名APK<br>
                            → 上传到Google Play商店或企业内部分发<br><br>

                            <strong>OTA热更新：</strong><br>
                            → 执行：eas update --branch production<br>
                            → 仅更新JavaScript bundle（不需要重新安装APP）<br>
                            → 用户下次打开APP自动下载更新<br>
                            → 适用于bug修复和小功能更新
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>数据库迁移流程</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>开发环境迁移：</strong><br>
                            → 修改实体类和数据库schema<br>
                            → 使用Spring Data JPA Entity生成<br>
                            → 本地测试迁移脚本<br><br>

                            <strong>生产环境迁移：</strong><br>
                            → 编写SQL迁移脚本（DDL）<br>
                            → 在测试数据库验证<br>
                            → 选择低峰期执行迁移<br>
                            → 备份数据库（mysqldump）<br>
                            → 执行迁移脚本<br>
                            → 验证数据完整性<br>
                            → 回滚计划（如失败）<br><br>

                            <strong>版本管理：</strong><br>
                            • 迁移脚本命名：V1.0.0__init.sql, V1.0.1__add_notification.sql<br>
                            • 使用Flyway或Liquibase管理迁移（未来考虑）<br>
                            • 保持迁移脚本幂等性（可重复执行）
                        </p>
                    </div>
                </div>

                <h3>7.2 监控与日志</h3>

                <h4>📊 监控系统</h4>
                <div class="feature-list">
                    <div class="feature-item">
                        <h4>服务器监控</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>宝塔面板监控：</strong><br>
                            • CPU使用率（告警阈值：>80%）<br>
                            • 内存使用率（告警阈值：>85%）<br>
                            • 磁盘空间（告警阈值：剩余<10GB）<br>
                            • 网络流量（监控异常流量）<br><br>

                            <strong>应用监控：</strong><br>
                            • Spring Boot Actuator健康检查<br>
                            • JVM堆内存使用率<br>
                            • 线程数和线程池状态<br>
                            • HTTP请求响应时间<br>
                            • API调用成功率和错误率<br><br>

                            <strong>数据库监控：</strong><br>
                            • MySQL连接数（最大连接数监控）<br>
                            • 慢查询日志（>2秒的查询）<br>
                            • 数据库锁等待<br>
                            • 表空间大小增长趋势
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>移动端监控</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>性能监控：</strong><br>
                            • 启动时间（冷启动/热启动）<br>
                            • 页面渲染时间（FPS）<br>
                            • API请求响应时间<br>
                            • 内存占用（避免内存泄漏）<br>
                            • 崩溃率（Crash Rate）<br><br>

                            <strong>用户行为监控：</strong><br>
                            • 日活用户（DAU）<br>
                            • 功能使用频率<br>
                            • 用户留存率<br>
                            • 平均会话时长<br><br>

                            <strong>工具：</strong><br>
                            • Sentry（错误追踪和崩溃报告）<br>
                            • Google Analytics（用户行为分析）<br>
                            • Firebase（性能监控和崩溃报告）
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>AI服务监控</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>成本监控：</strong><br>
                            • 实时监控每个工厂的API调用次数<br>
                            • 计算Token消耗和费用<br>
                            • 达到80%配额时预警<br>
                            • 超过配额时暂停服务并通知<br><br>

                            <strong>性能监控：</strong><br>
                            • DeepSeek API响应时间<br>
                            • 缓存命中率（目标：>60%）<br>
                            • 分析请求成功率<br>
                            • 错误类型统计<br><br>

                            <strong>质量监控：</strong><br>
                            • AI分析结果准确性（用户反馈）<br>
                            • 分析报告被采纳率<br>
                            • 用户满意度评分
                        </p>
                    </div>
                </div>

                <h4 style="margin-top: 40px;">📝 日志系统</h4>
                <div class="feature-list">
                    <div class="feature-item">
                        <h4>后端日志策略</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>日志级别：</strong><br>
                            • ERROR：严重错误（需要立即处理）<br>
                            • WARN：警告信息（潜在问题）<br>
                            • INFO：关键业务操作（用户登录、批次创建）<br>
                            • DEBUG：详细调试信息（仅开发环境）<br><br>

                            <strong>日志内容：</strong><br>
                            • 用户操作日志（who、when、what）<br>
                            • API请求日志（endpoint、参数、响应时间）<br>
                            • 数据库操作日志（SQL、执行时间）<br>
                            • 异常堆栈日志（完整stack trace）<br>
                            • 安全日志（登录失败、权限拒绝）<br><br>

                            <strong>日志文件管理：</strong><br>
                            • 按日期分割（cretas-backend-2024-01-01.log）<br>
                            • 日志保留期：30天<br>
                            • 自动压缩旧日志（gzip）<br>
                            • 关键日志归档（>30天）<br><br>

                            <strong>框架：</strong><br>
                            • SLF4J + Logback<br>
                            • 配置文件：logback-spring.xml
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>日志查询与分析</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>宝塔面板日志查看：</strong><br>
                            • 实时查看最新日志<br>
                            • 按关键词搜索（grep）<br>
                            • 按时间范围过滤<br>
                            • 下载日志文件<br><br>

                            <strong>日志分析需求：</strong><br>
                            • 错误频率统计<br>
                            • API响应时间分布<br>
                            • 用户活跃时段分析<br>
                            • 异常模式识别<br><br>

                            <strong>未来扩展：</strong><br>
                            • ELK Stack（Elasticsearch + Logstash + Kibana）<br>
                            • 集中式日志管理<br>
                            • 可视化仪表板<br>
                            • 智能告警规则
                        </p>
                    </div>
                </div>

                <h3>7.3 扩展性设计</h3>

                <h4>📈 横向扩展策略</h4>
                <div class="feature-list">
                    <div class="feature-item">
                        <h4>应用层扩展</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>当前架构：</strong><br>
                            • 单实例Spring Boot应用<br>
                            • 适用于中小规模（<50个工厂）<br><br>

                            <strong>扩展方案（未来）：</strong><br>
                            • 负载均衡：Nginx反向代理<br>
                            • 多实例部署：<br>
                            &nbsp;&nbsp;- 服务器1：139.196.165.140:10010<br>
                            &nbsp;&nbsp;- 服务器2：139.196.165.141:10010<br>
                            • 会话共享：Redis存储Session<br>
                            • 无状态设计：JWT Token认证<br><br>

                            <strong>性能优化：</strong><br>
                            • API缓存（Redis）<br>
                            • 数据库连接池优化<br>
                            • 异步处理（AI分析、通知推送）
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>数据库扩展</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>当前架构：</strong><br>
                            • 单MySQL实例<br>
                            • 适用于<100万条记录<br><br>

                            <strong>扩展方案（未来）：</strong><br>
                            • 读写分离：<br>
                            &nbsp;&nbsp;- 主库（写操作）<br>
                            &nbsp;&nbsp;- 从库（读操作）<br>
                            &nbsp;&nbsp;- Spring Data JPA读写分离配置<br><br>

                            • 分库分表：<br>
                            &nbsp;&nbsp;- 按factoryId分库（垂直分库）<br>
                            &nbsp;&nbsp;- 大表按时间分表（水平分表）<br>
                            &nbsp;&nbsp;- 使用ShardingSphere<br><br>

                            • 数据归档：<br>
                            &nbsp;&nbsp;- 历史数据（>2年）归档到冷存储<br>
                            &nbsp;&nbsp;- 保留热数据（最近2年）在主库
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>容量规划</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>数据增长预估：</strong><br>
                            • 每工厂每月生产批次：~100条<br>
                            • 每批次原材料消耗记录：~5条<br>
                            • 每批次质检记录：~3条<br>
                            • 每工厂每月总记录：~800条<br>
                            • 50个工厂年增长：~480,000条<br><br>

                            <strong>存储规划：</strong><br>
                            • 数据库存储：每条记录~2KB<br>
                            • 年数据量：~960MB<br>
                            • 加上照片：每张~200KB压缩后<br>
                            • 每月照片：~1000张 = 200MB<br>
                            • 年照片总量：~2.4GB<br>
                            • 建议服务器存储：500GB SSD<br><br>

                            <strong>性能规划：</strong><br>
                            • 当前服务器配置：<br>
                            &nbsp;&nbsp;- CPU：4核<br>
                            &nbsp;&nbsp;- 内存：8GB<br>
                            &nbsp;&nbsp;- 适用：50个工厂，500并发用户<br>
                            • 扩展阈值：<br>
                            &nbsp;&nbsp;- CPU>70%持续1小时：增加实例<br>
                            &nbsp;&nbsp;- 内存>80%：扩展内存或优化<br>
                            &nbsp;&nbsp;- 响应时间>2秒：优化查询或增加缓存
                        </p>
                    </div>
                </div>

                <h3>7.4 灾难恢复</h3>

                <h4>💾 备份策略</h4>
                <div class="feature-list">
                    <div class="feature-item">
                        <h4>数据库备份</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>全量备份：</strong><br>
                            • 频率：每日凌晨2:00<br>
                            • 方式：mysqldump<br>
                            • 保留期：最近30天<br>
                            • 存储位置：<br>
                            &nbsp;&nbsp;- 本地：/backup/mysql/daily/<br>
                            &nbsp;&nbsp;- 异地：云存储（阿里云OSS）<br><br>

                            <strong>增量备份：</strong><br>
                            • 频率：每6小时<br>
                            • 方式：binlog日志<br>
                            • 保留期：7天<br>
                            • 用于：快速恢复最近数据<br><br>

                            <strong>备份验证：</strong><br>
                            • 每周测试恢复一次<br>
                            • 验证数据完整性<br>
                            • 确保备份可用
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>文件备份</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>上传文件备份：</strong><br>
                            • 位置：/www/wwwroot/cretas/uploads/<br>
                            • 内容：质检照片、原材料照片<br>
                            • 频率：每日同步到云存储<br>
                            • 保留期：永久（符合溯源要求）<br><br>

                            <strong>应用程序备份：</strong><br>
                            • JAR文件版本管理<br>
                            • 每次部署保留旧版本<br>
                            • 配置文件版本控制（Git）
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>恢复流程</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>数据库恢复：</strong><br>
                            → 停止应用程序<br>
                            → 创建新数据库（如：cretas_restore）<br>
                            → 恢复全量备份：mysql < backup.sql<br>
                            → 应用增量备份（binlog replay）<br>
                            → 验证数据完整性<br>
                            → 切换应用到新数据库<br>
                            → 重启应用<br><br>

                            <strong>RTO（恢复时间目标）：</strong><br>
                            • 全量恢复：<2小时<br>
                            • 增量恢复：<30分钟<br><br>

                            <strong>RPO（恢复点目标）：</strong><br>
                            • 数据丢失：<6小时（增量备份间隔）<br>
                            • 关键业务：<1小时（未来优化）
                        </p>
                    </div>
                </div>
            </section>

            <!-- 第8章：安全与合规 -->
            <section id="chapter-8">
                <h2><span class="section-number">8</span>安全与合规</h2>

                <h3>8.1 安全机制</h3>

                <h4>🔐 认证与授权</h4>
                <div class="feature-list">
                    <div class="feature-item">
                        <h4>JWT双令牌认证</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>认证流程：</strong><br>
                            → 用户登录（用户名+密码）<br>
                            → 服务器验证凭据<br>
                            → 颁发AccessToken（有效期：15分钟）<br>
                            → 颁发RefreshToken（有效期：7天）<br>
                            → 移动端保存Token到SecureStore（加密存储）<br><br>

                            <strong>Token刷新机制：</strong><br>
                            → AccessToken即将过期（剩余5分钟）<br>
                            → 使用RefreshToken请求新AccessToken<br>
                            → 后端验证RefreshToken有效性<br>
                            → 颁发新AccessToken<br>
                            → 更新本地存储<br><br>

                            <strong>安全措施：</strong><br>
                            • Token签名：HMAC-SHA256<br>
                            • 密钥存储：环境变量（不提交到Git）<br>
                            • Token包含：userId、role、factoryId、deviceId<br>
                            • 防止Token重放：检查deviceId绑定<br>
                            • Token黑名单：用户登出后加入黑名单
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>RBAC权限控制</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>权限模型：</strong><br>
                            • 8级角色系统（详见第5章）<br>
                            • 角色与权限映射（Spring Security）<br>
                            • 动态权限加载（从数据库）<br><br>

                            <strong>API权限验证：</strong><br>
                            → 每个API请求携带AccessToken<br>
                            → Spring Security拦截器验证Token<br>
                            → 解析Token获取用户角色<br>
                            → 检查用户是否有访问该API的权限<br>
                            → 无权限：返回403 Forbidden<br>
                            → 有权限：继续执行业务逻辑<br><br>

                            <strong>数据权限：</strong><br>
                            • 工厂级隔离：factoryId过滤<br>
                            • 部门级隔离：departmentId过滤<br>
                            • 个人数据：只能查看自己的记录<br>
                            • 防止越权访问：在Service层再次验证
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>设备绑定与异地登录检测</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>设备绑定：</strong><br>
                            • 首次登录生成唯一DeviceId<br>
                            • 后端记录用户-设备关系<br>
                            • Token包含deviceId<br>
                            • 每次请求验证deviceId匹配<br><br>

                            <strong>异地登录检测：</strong><br>
                            • 记录用户登录IP地址<br>
                            • 检测IP地址变化幅度<br>
                            • 大幅变化时（如跨省）：<br>
                            &nbsp;&nbsp;- 触发异地登录告警<br>
                            &nbsp;&nbsp;- 通知用户确认<br>
                            &nbsp;&nbsp;- 可选：强制重新登录<br><br>

                            <strong>设备管理：</strong><br>
                            • 用户可查看已登录设备列表<br>
                            • 显示：设备型号、登录时间、IP地址<br>
                            • 支持远程踢出可疑设备<br>
                            • 限制最多3台设备同时在线
                        </p>
                    </div>
                </div>

                <h4 style="margin-top: 40px;">🛡️ 数据安全</h4>
                <div class="feature-list">
                    <div class="feature-item">
                        <h4>敏感数据加密</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>密码加密：</strong><br>
                            • 算法：BCrypt（Spring Security）<br>
                            • 加盐：自动生成随机盐值<br>
                            • 存储：只存储hash值，不存储明文<br>
                            • 强度：成本因子10（平衡安全和性能）<br><br>

                            <strong>通信加密：</strong><br>
                            • 生产环境强制HTTPS<br>
                            • TLS 1.2+<br>
                            • 证书：Let's Encrypt免费证书<br>
                            • 移动端强制证书验证<br><br>

                            <strong>数据库加密：</strong><br>
                            • 敏感字段（如手机号）：AES-256加密<br>
                            • 加密密钥：独立管理，不存储在代码中<br>
                            • 透明数据加密（TDE）：未来考虑
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>数据脱敏</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>日志脱敏：</strong><br>
                            • 密码：完全隐藏（不记录）<br>
                            • 手机号：中间4位打码（138****1234）<br>
                            • 身份证：中间部分打码<br>
                            • Token：只记录前8位<br><br>

                            <strong>接口脱敏：</strong><br>
                            • 非管理员用户查询他人信息时脱敏<br>
                            • 导出数据时根据权限脱敏<br>
                            • 第三方接口返回时脱敏
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>SQL注入防护</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>防护措施：</strong><br>
                            • 使用Spring Data JPA参数化查询<br>
                            • 禁止拼接SQL字符串<br>
                            • 输入验证：Spring Validation<br>
                            • 特殊字符过滤<br><br>

                            <strong>XSS防护：</strong><br>
                            • 前端输入转义<br>
                            • 后端输出转义（如富文本）<br>
                            • CSP（Content Security Policy）<br><br>

                            <strong>CSRF防护：</strong><br>
                            • JWT Token验证（无需CSRF Token）<br>
                            • SameSite Cookie（未来Web端）
                        </p>
                    </div>
                </div>

                <h3>8.2 合规性考虑</h3>

                <h4>📜 食品安全合规</h4>
                <div class="info-box">
                    <p style="font-size: 1.05em; line-height: 2;">
                        <strong>法律依据：</strong><br>
                        • 《中华人民共和国食品安全法》<br>
                        • 《食品生产许可管理办法》<br>
                        • 《食品安全国家标准 食品生产通用卫生规范》（GB 14881-2013）<br>
                        • 《食品安全法实施条例》
                    </p>
                </div>

                <div class="feature-list">
                    <div class="feature-item">
                        <h4>溯源合规</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>溯源要求：</strong><br>
                            • 原材料来源可追溯（供应商、批次、日期）<br>
                            • 生产过程可追溯（负责人、时间、工艺）<br>
                            • 质检记录可追溯（检验项目、结果、照片）<br>
                            • 溯源码唯一性（不可重复、不可伪造）<br><br>

                            <strong>系统实现：</strong><br>
                            • 生成唯一溯源码（批次ID）<br>
                            • 关联原材料批次记录<br>
                            • 记录完整生产流程<br>
                            • 保存质检照片（永久存储）<br>
                            • 提供消费者查询接口（扫码查询）<br><br>

                            <strong>数据保留期：</strong><br>
                            • 生产记录：至少2年<br>
                            • 质检记录：至少2年<br>
                            • 溯源数据：永久保存（食品安全要求）
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>数据保护合规</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>个人信息保护法（PIPL）：</strong><br>
                            • 用户明确授权：注册时同意隐私政策<br>
                            • 最小化原则：只收集必要信息<br>
                            • 用户权利：<br>
                            &nbsp;&nbsp;- 查询个人信息<br>
                            &nbsp;&nbsp;- 更正错误信息<br>
                            &nbsp;&nbsp;- 删除账号（注销功能）<br>
                            &nbsp;&nbsp;- 数据导出<br><br>

                            <strong>网络安全法：</strong><br>
                            • 数据境内存储（服务器在中国）<br>
                            • 网络安全等级保护（等保）<br>
                            • 数据备份和恢复机制<br>
                            • 安全审计日志
                        </p>
                    </div>

                    <div class="feature-item">
                        <h4>审计与合规检查</h4>
                        <p style="color: #555; font-size: 1.05em; line-height: 2;">
                            <strong>操作审计：</strong><br>
                            • 记录所有数据修改操作<br>
                            • 审计日志内容：<br>
                            &nbsp;&nbsp;- 操作人（userId + username）<br>
                            &nbsp;&nbsp;- 操作时间（精确到秒）<br>
                            &nbsp;&nbsp;- 操作类型（创建、更新、删除）<br>
                            &nbsp;&nbsp;- 操作对象（表名、记录ID）<br>
                            &nbsp;&nbsp;- 操作前后数据对比<br>
                            • 审计日志保留期：至少6个月<br><br>

                            <strong>定期合规检查：</strong><br>
                            • 每季度安全审计<br>
                            • 每年合规审查<br>
                            • 第三方安全评估（未来）<br>
                            • 渗透测试（年度）
                        </p>
                    </div>
                </div>

                <h3>8.3 安全最佳实践</h3>

                <h4>✅ 开发安全规范</h4>
                <div class="warning-box">
                    <p style="font-size: 1.05em; line-height: 2;">
                        <strong>禁止事项：</strong><br>
                        • 禁止在代码中硬编码密码和密钥<br>
                        • 禁止将敏感信息提交到Git仓库<br>
                        • 禁止在生产环境开启调试模式<br>
                        • 禁止使用弱密码（如：123456）<br>
                        • 禁止禁用安全特性（如HTTPS验证）<br><br>

                        <strong>必须事项：</strong><br>
                        • 必须使用环境变量管理配置<br>
                        • 必须对用户输入进行验证<br>
                        • 必须使用参数化查询防止SQL注入<br>
                        • 必须记录安全相关操作日志<br>
                        • 必须定期更新依赖库（安全补丁）<br><br>

                        <strong>代码审查：</strong><br>
                        • 所有代码合并前必须审查<br>
                        • 重点检查安全问题<br>
                        • 使用静态代码分析工具（SonarQube）
                    </p>
                </div>
            </section>

            <!-- 文档导航 -->
            <div style="background: #f8f9fa; padding: 30px; border-radius: 8px; text-align: center; margin-top: 50px;">
                <h3 style="border: none; padding: 0; margin-bottom: 20px;">📚 完整PRD文档导航</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <a href="./MRD-白垩纪食品溯源系统-市场需求文档-v4.0.html" style="background: white; border: 2px solid #667eea; color: #667eea; padding: 20px; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s; display: block;">
                        第1-2章：市场需求文档（MRD）
                    </a>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        第3-8章：技术架构与系统设计（当前）
                    </div>
                    <a href="./PRD-功能与文件映射-v1.0.html" style="background: white; border: 2px solid #667eea; color: #667eea; padding: 20px; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s; display: block;">
                        第9章：功能与文件映射
                    </a>
                    <a href="./PRD-白垩纪食品溯源系统-完整版.md" style="background: white; border: 2px solid #667eea; color: #667eea; padding: 20px; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.3s; display: block;">
                        完整版PRD（Markdown）
                    </a>
                </div>

                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <p style="color: #666; font-size: 0.95em; line-height: 1.8;">
                        <strong>📖 阅读建议</strong>：建议按顺序阅读文档，先了解产品概述和市场需求，再深入技术架构细节。<br>
                        如需快速了解系统全貌，可直接查看完整版PRD（Markdown）。
                    </p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
