# ç™½å©çºªé£Ÿå“æº¯æºç³»ç»Ÿ - è®¤è¯ç³»ç»Ÿè§„åˆ’æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-01-05
**å®æ–½å‘¨æœŸ**: 4å‘¨
**æ–‡æ¡£çŠ¶æ€**: å¾…å®æ–½

---

## ğŸ“‹ ç›®å½•

1. [è®¤è¯ç³»ç»Ÿæ¦‚è¿°](#è®¤è¯ç³»ç»Ÿæ¦‚è¿°)
2. [è§’è‰²æƒé™ä½“ç³»](#è§’è‰²æƒé™ä½“ç³»)
3. [ç™»å½•è®¤è¯è®¾è®¡](#ç™»å½•è®¤è¯è®¾è®¡)
4. [æ³¨å†Œæµç¨‹è®¾è®¡](#æ³¨å†Œæµç¨‹è®¾è®¡)
5. [å¿˜è®°å¯†ç /é‡ç½®å¯†ç è®¾è®¡](#å¿˜è®°å¯†ç é‡ç½®å¯†ç è®¾è®¡)
6. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
7. [APIæ¥å£è®¾è®¡](#apiæ¥å£è®¾è®¡)
8. [å‰ç«¯é¡µé¢è®¾è®¡](#å‰ç«¯é¡µé¢è®¾è®¡)
9. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)
10. [éªŒæ”¶æ ‡å‡†](#éªŒæ”¶æ ‡å‡†)

---

## è®¤è¯ç³»ç»Ÿæ¦‚è¿°

### 1.1 ç³»ç»Ÿå®šä½

ç™½å©çºªé£Ÿå“æº¯æºç³»ç»Ÿé‡‡ç”¨**ç®€åŒ–çš„è®¤è¯ç³»ç»Ÿè®¾è®¡**ï¼Œèšç„¦äºå®ç”¨æ€§å’Œå®‰å…¨æ€§çš„å¹³è¡¡ã€‚

**è®¾è®¡åŸåˆ™**:
- ğŸ¯ **ç®€å•å®ç”¨**: ç§»é™¤å¤æ‚çš„éªŒè¯æµç¨‹ï¼ˆçŸ­ä¿¡éªŒè¯ç ï¼‰
- ğŸ” **å®‰å…¨å¯é **: åŸºäºç™½åå•+å®‰å…¨é—®é¢˜çš„åŒé‡éªŒè¯
- ğŸ“± **ç§»åŠ¨ä¼˜å…ˆ**: ä¼˜åŒ–ç§»åŠ¨ç«¯ç”¨æˆ·ä½“éªŒ
- ğŸ­ **å¤šç§Ÿæˆ·**: æ”¯æŒå¤šå·¥å‚ç‹¬ç«‹è¿è¥

### 1.2 æ ¸å¿ƒåŠŸèƒ½

**è®¤è¯åŠŸèƒ½**:
- âœ… ç»Ÿä¸€ç™»å½•ï¼ˆè‡ªåŠ¨è¯†åˆ«å¹³å°ç”¨æˆ·/å·¥å‚ç”¨æˆ·ï¼‰
- âœ… ç™½åå•æ³¨å†Œï¼ˆæ— éœ€çŸ­ä¿¡éªŒè¯ï¼‰
- âœ… å®‰å…¨é—®é¢˜æ‰¾å›å¯†ç ï¼ˆ3ä¸ªå®‰å…¨é—®é¢˜éªŒè¯ï¼‰
- âœ… è‡ªåŠ¨ç”¨æˆ·åç”Ÿæˆ
- âœ… 7çº§è§’è‰²æƒé™ä½“ç³»

**ç§»é™¤çš„åŠŸèƒ½**ï¼ˆç®€åŒ–è®¾è®¡ï¼‰:
- âŒ ç”Ÿç‰©è¯†åˆ«ç™»å½•ï¼ˆæŒ‡çº¹/Face IDï¼‰- ä¸å®ç°
- âŒ çŸ­ä¿¡éªŒè¯ç éªŒè¯ - ä½¿ç”¨ç™½åå•æ›¿ä»£
- âŒ é‚®ç®±è¾“å…¥ - ä¸éœ€è¦
- âŒ ç”¨æˆ·åæ‰‹åŠ¨è¾“å…¥ - ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ
- âŒ è®¾å¤‡ç»‘å®šä¸€é”®ç™»å½• - ä¸å®ç°

### 1.3 æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ç§»åŠ¨ç«¯ (React Native)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  LoginScreen (ç™»å½•)              â”‚   â”‚
â”‚  â”‚  RegisterScreen (æ³¨å†Œ)           â”‚   â”‚
â”‚  â”‚  ForgotPasswordScreen (å¿˜è®°å¯†ç ) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ HTTPS/REST API
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          åç«¯API (Node.js + Express)     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  /api/mobile/auth/unified-login  â”‚   â”‚
â”‚  â”‚  /api/mobile/auth/register       â”‚   â”‚
â”‚  â”‚  /api/mobile/auth/verify-identityâ”‚   â”‚
â”‚  â”‚  /api/mobile/auth/reset-password â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            æ•°æ®åº“ (MySQL)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  users (ç”¨æˆ·è¡¨)                  â”‚   â”‚
â”‚  â”‚  platform_admins (å¹³å°ç®¡ç†å‘˜)    â”‚   â”‚
â”‚  â”‚  user_whitelist (ç™½åå•)         â”‚   â”‚
â”‚  â”‚  user_security_questions (å®‰å…¨é—®é¢˜)â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è§’è‰²æƒé™ä½“ç³»

### 2.1 è§’è‰²å±‚çº§æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¹³å°å±‚ (Platform Layer)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  platform_admin (å¹³å°ç®¡ç†å‘˜)            â”‚  â”‚
â”‚  â”‚  - ç®¡ç†æ‰€æœ‰å·¥å‚                         â”‚  â”‚
â”‚  â”‚  - ç®¡ç†æ‰€æœ‰ç”¨æˆ·                         â”‚  â”‚
â”‚  â”‚  - å¹³å°çº§é…ç½®                           â”‚  â”‚
â”‚  â”‚  - æ•°æ®è®¿é—®: æ‰€æœ‰å·¥å‚æ‰€æœ‰æ•°æ®           â”‚  â”‚
â”‚  â”‚  - ç™»å½•æ–¹å¼: ç”¨æˆ·å+å¯†ç                 â”‚  â”‚
â”‚  â”‚  - ç™»å½•åå¯¼èˆª: PlatformScreen           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å·¥å‚å±‚ (Factory Layer)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  factory_super_admin (å·¥å‚è¶…çº§ç®¡ç†å‘˜)   â”‚  â”‚
â”‚  â”‚  - å·¥å‚æ‰€æœ‰æƒé™                         â”‚  â”‚
â”‚  â”‚  - æ‰€æœ‰éƒ¨é—¨æ•°æ®                         â”‚  â”‚
â”‚  â”‚  - ç”¨æˆ·ç®¡ç†                             â”‚  â”‚
â”‚  â”‚  - æ•°æ®è®¿é—®: æœ¬å·¥å‚æ‰€æœ‰æ•°æ®             â”‚  â”‚
â”‚  â”‚  - ç™»å½•æ–¹å¼: ç”¨æˆ·å+å¯†ç                 â”‚  â”‚
â”‚  â”‚  - ç™»å½•åå¯¼èˆª: AdminScreen              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                      â”‚                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚         â†“            â†“            â†“           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚permissionâ”‚ â”‚ department  â”‚ â”‚ operator â”‚  â”‚
â”‚  â”‚  _admin  â”‚ â”‚   _admin    â”‚ â”‚          â”‚  â”‚
â”‚  â”‚æƒé™ç®¡ç†å‘˜â”‚ â”‚ éƒ¨é—¨ç®¡ç†å‘˜  â”‚ â”‚  æ“ä½œå‘˜  â”‚  â”‚
â”‚  â”‚          â”‚ â”‚             â”‚ â”‚          â”‚  â”‚
â”‚  â”‚ç™»å½•æ–¹å¼: â”‚ â”‚ç™»å½•æ–¹å¼:    â”‚ â”‚ç™»å½•æ–¹å¼: â”‚  â”‚
â”‚  â”‚ç”¨æˆ·åå¯†ç â”‚ â”‚ç”¨æˆ·åå¯†ç    â”‚ â”‚ç”¨æˆ·åå¯†ç â”‚  â”‚
â”‚  â”‚          â”‚ â”‚             â”‚ â”‚          â”‚  â”‚
â”‚  â”‚å¯¼èˆª:     â”‚ â”‚å¯¼èˆª:        â”‚ â”‚å¯¼èˆª:     â”‚  â”‚
â”‚  â”‚User      â”‚ â”‚Department   â”‚ â”‚Processingâ”‚  â”‚
â”‚  â”‚Managementâ”‚ â”‚Screen       â”‚ â”‚Screen    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                    â”‚
â”‚         â†“                                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚    â”‚viewerâ”‚                                  â”‚
â”‚    â”‚æŸ¥çœ‹è€…â”‚                                  â”‚
â”‚    â”‚      â”‚                                  â”‚
â”‚    â”‚ç™»å½•: â”‚                                  â”‚
â”‚    â”‚ç”¨æˆ·åâ”‚                                  â”‚
â”‚    â”‚å¯†ç   â”‚                                  â”‚
â”‚    â”‚      â”‚                                  â”‚
â”‚    â”‚å¯¼èˆª: â”‚                                  â”‚
â”‚    â”‚Home  â”‚                                  â”‚
â”‚    â”‚Screenâ”‚                                  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚         â”‚                                    â”‚
â”‚         â†“                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚unactivated â”‚                              â”‚
â”‚  â”‚  æœªæ¿€æ´»    â”‚                              â”‚
â”‚  â”‚            â”‚                              â”‚
â”‚  â”‚ç™»å½•: ç¦æ­¢  â”‚                              â”‚
â”‚  â”‚            â”‚                              â”‚
â”‚  â”‚æç¤º: è´¦å·  â”‚                              â”‚
â”‚  â”‚æœªæ¿€æ´»è¯·è”ç³»â”‚                              â”‚
â”‚  â”‚ç®¡ç†å‘˜      â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è§’è‰²æƒé™è¯¦ç»†æ¸…å•

#### **å¹³å°è§’è‰²**

##### platform_admin (å¹³å°ç®¡ç†å‘˜)

**åŸºæœ¬ä¿¡æ¯**:
| å±æ€§ | å€¼ |
|-----|---|
| æƒé™çº§åˆ« | 0 (æœ€é«˜) |
| ç”¨æˆ·ç±»å‹ | platform |
| æ•°æ®åº“è¡¨ | platform_admins |
| ç™»å½•æ–¹å¼ | ç”¨æˆ·å + å¯†ç  |
| ç™»å½•åå¯¼èˆª | PlatformScreen |

**æƒé™æ¸…å•**:

**å·¥å‚ç®¡ç†**:
- âœ… create_factory - åˆ›å»ºæ–°å·¥å‚
- âœ… delete_factory - åˆ é™¤å·¥å‚
- âœ… manage_all_factories - ç®¡ç†æ‰€æœ‰å·¥å‚
- âœ… view_factories - æŸ¥çœ‹å·¥å‚åˆ—è¡¨
- âœ… view_factory_details - æŸ¥çœ‹å·¥å‚è¯¦æƒ…
- âœ… factory_activation_control - å·¥å‚å¯ç”¨/åœç”¨

**ç”¨æˆ·ç®¡ç†**:
- âœ… manage_all_users - ç®¡ç†æ‰€æœ‰å·¥å‚çš„æ‰€æœ‰ç”¨æˆ·
- âœ… create_users - åˆ›å»ºç”¨æˆ·
- âœ… delete_users - åˆ é™¤ç”¨æˆ·
- âœ… activate_users - æ¿€æ´»ç”¨æˆ·
- âœ… assign_roles - åˆ†é…è§’è‰²
- âœ… view_users - æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨

**ç™½åå•ç®¡ç†**:
- âœ… manage_whitelist - ç®¡ç†æ‰€æœ‰å·¥å‚ç™½åå•
- âœ… add_whitelist_users - æ·»åŠ ç™½åå•
- âœ… remove_whitelist_users - åˆ é™¤ç™½åå•
- âœ… whitelist_bulk_import - æ‰¹é‡å¯¼å…¥ç™½åå•

**å¹³å°ç®¡ç†**:
- âœ… platform_settings - å¹³å°è®¾ç½®
- âœ… system_monitoring - ç³»ç»Ÿç›‘æ§
- âœ… platform_backup - å¹³å°æ•°æ®å¤‡ä»½
- âœ… manage_platform_admins - ç®¡ç†å…¶ä»–å¹³å°ç®¡ç†å‘˜

**æ•°æ®åˆ†æ**:
- âœ… view_platform_analytics - æŸ¥çœ‹å¹³å°çº§åˆ†æ
- âœ… export_platform_data - å¯¼å‡ºå¹³å°æ•°æ®
- âœ… cross_factory_reports - è·¨å·¥å‚æŠ¥è¡¨

**ç³»ç»ŸåŠŸèƒ½**:
- âœ… audit_all_logs - æŸ¥çœ‹æ‰€æœ‰å®¡è®¡æ—¥å¿—
- âœ… global_notifications - å…¨å±€é€šçŸ¥å‘é€

**æ•°æ®è®¿é—®èŒƒå›´**:
- æ‰€æœ‰å·¥å‚çš„æ‰€æœ‰æ•°æ®
- æ‰€æœ‰ç”¨æˆ·çš„æ‰€æœ‰ä¿¡æ¯
- æ‰€æœ‰ç³»ç»Ÿæ—¥å¿—

---

#### **å·¥å‚è§’è‰²**

##### factory_super_admin (å·¥å‚è¶…çº§ç®¡ç†å‘˜)

**åŸºæœ¬ä¿¡æ¯**:
| å±æ€§ | å€¼ |
|-----|---|
| æƒé™çº§åˆ« | 5 (å·¥å‚å†…æœ€é«˜) |
| ç”¨æˆ·ç±»å‹ | factory |
| æ•°æ®åº“è¡¨ | users |
| ç™»å½•æ–¹å¼ | ç”¨æˆ·å + å¯†ç  |
| ç™»å½•åå¯¼èˆª | AdminScreen |
| éƒ¨é—¨è®¿é—® | æ‰€æœ‰éƒ¨é—¨ |

**æƒé™æ¸…å•**:

**ç”¨æˆ·ç®¡ç†**:
- âœ… manage_factory_users - ç®¡ç†æœ¬å·¥å‚ç”¨æˆ·
- âœ… create_users - åˆ›å»ºç”¨æˆ·
- âœ… delete_users - åˆ é™¤ç”¨æˆ·
- âœ… activate_users - æ¿€æ´»ç”¨æˆ·
- âœ… assign_roles - åˆ†é…è§’è‰²ï¼ˆé™¤factory_super_adminå¤–ï¼‰

**ç™½åå•ç®¡ç†**:
- âœ… manage_factory_whitelist - ç®¡ç†æœ¬å·¥å‚ç™½åå•
- âœ… add_whitelist_users - æ·»åŠ ç™½åå•
- âœ… remove_whitelist_users - åˆ é™¤ç™½åå•

**å·¥å‚ç®¡ç†**:
- âœ… factory_settings - å·¥å‚è®¾ç½®
- âœ… manage_all_departments - ç®¡ç†æ‰€æœ‰éƒ¨é—¨
- âœ… factory_configuration - å·¥å‚é…ç½®

**ä¸šåŠ¡åŠŸèƒ½ï¼ˆæ‰€æœ‰éƒ¨é—¨ï¼‰**:
- âœ… processing_batch_create - åˆ›å»ºåŠ å·¥æ‰¹æ¬¡
- âœ… processing_batch_view_all - æŸ¥çœ‹æ‰€æœ‰æ‰¹æ¬¡
- âœ… processing_batch_edit - ç¼–è¾‘æ‰¹æ¬¡
- âœ… processing_batch_delete - åˆ é™¤æ‰¹æ¬¡
- âœ… quality_inspection_submit - æäº¤è´¨æ£€
- âœ… quality_inspection_approve - å®¡æ‰¹è´¨æ£€
- âœ… quality_inspection_view_all - æŸ¥çœ‹æ‰€æœ‰è´¨æ£€
- âœ… equipment_monitoring_view - æŸ¥çœ‹è®¾å¤‡ç›‘æ§
- âœ… timeclock_view_all - æŸ¥çœ‹æ‰€æœ‰æ‰“å¡è®°å½•
- âœ… dashboard_view_factory - æŸ¥çœ‹å·¥å‚ä»ªè¡¨æ¿

**æ•°æ®ç®¡ç†**:
- âœ… view_all_factory_data - æŸ¥çœ‹å·¥å‚æ‰€æœ‰æ•°æ®
- âœ… export_factory_data - å¯¼å‡ºå·¥å‚æ•°æ®
- âœ… delete_factory_data - åˆ é™¤æ•°æ®

**æŠ¥è¡¨**:
- âœ… view_factory_reports - æŸ¥çœ‹å·¥å‚æŠ¥è¡¨
- âœ… create_custom_reports - åˆ›å»ºè‡ªå®šä¹‰æŠ¥è¡¨
- âœ… schedule_reports - å®šæ—¶æŠ¥è¡¨

**ç³»ç»ŸåŠŸèƒ½**:
- âœ… audit_factory_logs - æŸ¥çœ‹å·¥å‚å®¡è®¡æ—¥å¿—
- âœ… factory_notifications - å·¥å‚é€šçŸ¥ç®¡ç†

**æ•°æ®è®¿é—®èŒƒå›´**:
- æœ¬å·¥å‚æ‰€æœ‰æ•°æ®
- æ‰€æœ‰éƒ¨é—¨æ•°æ®
- æ‰€æœ‰ç”¨æˆ·æ•°æ®

---

##### permission_admin (æƒé™ç®¡ç†å‘˜)

**åŸºæœ¬ä¿¡æ¯**:
| å±æ€§ | å€¼ |
|-----|---|
| æƒé™çº§åˆ« | 10 |
| ç”¨æˆ·ç±»å‹ | factory |
| æ•°æ®åº“è¡¨ | users |
| ç™»å½•æ–¹å¼ | ç”¨æˆ·å + å¯†ç  |
| ç™»å½•åå¯¼èˆª | UserManagementScreen |
| éƒ¨é—¨è®¿é—® | æ‰€æœ‰éƒ¨é—¨ï¼ˆåªè¯»ï¼‰ |

**æƒé™æ¸…å•**:

**ç”¨æˆ·ç®¡ç†**:
- âœ… activate_users - æ¿€æ´»ç”¨æˆ·
- âœ… assign_roles - åˆ†é…è§’è‰²ï¼ˆé™¤factory_super_adminå’Œpermission_adminå¤–ï¼‰
- âœ… manage_permissions - ç®¡ç†æƒé™
- âœ… view_users - æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨

**ç™½åå•ç®¡ç†**:
- âœ… manage_whitelist - ç®¡ç†ç™½åå•
- âœ… add_whitelist_users - æ·»åŠ ç™½åå•
- âœ… remove_whitelist_users - åˆ é™¤ç™½åå•
- âœ… whitelist_bulk_operations - æ‰¹é‡æ“ä½œ

**å®¡æ ¸åŠŸèƒ½**:
- âœ… review_user_applications - å®¡æ ¸ç”¨æˆ·ç”³è¯·
- âœ… approve_user_registrations - å®¡æ‰¹æ³¨å†Œ
- âœ… reject_user_applications - æ‹’ç»ç”³è¯·

**æŠ¥è¡¨**:
- âœ… view_user_reports - æŸ¥çœ‹ç”¨æˆ·æŠ¥è¡¨
- âœ… view_permission_reports - æŸ¥çœ‹æƒé™æŠ¥è¡¨
- âœ… export_user_data - å¯¼å‡ºç”¨æˆ·æ•°æ®

**å®¡è®¡**:
- âœ… view_user_logs - æŸ¥çœ‹ç”¨æˆ·æ—¥å¿—
- âœ… permission_change_logs - æƒé™å˜æ›´æ—¥å¿—

**æ•°æ®è®¿é—®èŒƒå›´**:
- æœ¬å·¥å‚æ‰€æœ‰ç”¨æˆ·æ•°æ®ï¼ˆè¯»å†™ï¼‰
- æœ¬å·¥å‚æ‰€æœ‰ä¸šåŠ¡æ•°æ®ï¼ˆåªè¯»ï¼‰

**ä¸å…è®¸çš„æ“ä½œ**:
- âŒ ä¸èƒ½åˆ›å»ºfactory_super_admin
- âŒ ä¸èƒ½åˆ›å»ºpermission_admin
- âŒ ä¸èƒ½åˆ é™¤factory_super_admin
- âŒ ä¸èƒ½ä¿®æ”¹ä¸šåŠ¡æ•°æ®

---

##### department_admin (éƒ¨é—¨ç®¡ç†å‘˜)

**åŸºæœ¬ä¿¡æ¯**:
| å±æ€§ | å€¼ |
|-----|---|
| æƒé™çº§åˆ« | 15 |
| ç”¨æˆ·ç±»å‹ | factory |
| æ•°æ®åº“è¡¨ | users |
| ç™»å½•æ–¹å¼ | ç”¨æˆ·å + å¯†ç  |
| ç™»å½•åå¯¼èˆª | DepartmentScreenï¼ˆæ ¹æ®departmentï¼‰ |
| éƒ¨é—¨è®¿é—® | ä»…æœ¬éƒ¨é—¨ |

**éƒ¨é—¨ç±»å‹**:
- `farming` - å…»æ®–éƒ¨é—¨
- `processing` - åŠ å·¥éƒ¨é—¨
- `logistics` - ç‰©æµéƒ¨é—¨
- `quality` - è´¨é‡éƒ¨é—¨
- `management` - ç®¡ç†éƒ¨é—¨

**æƒé™æ¸…å•**:

**éƒ¨é—¨ç”¨æˆ·ç®¡ç†**:
- âœ… manage_department_users - ç®¡ç†æœ¬éƒ¨é—¨ç”¨æˆ·
- âœ… activate_department_users - æ¿€æ´»æœ¬éƒ¨é—¨ç”¨æˆ·
- âœ… assign_department_roles - åˆ†é…è§’è‰²ï¼ˆä»…operatorå’Œviewerï¼‰
- âœ… manage_department_whitelist - ç®¡ç†æœ¬éƒ¨é—¨ç™½åå•

**éƒ¨é—¨æ•°æ®ç®¡ç†**:
- âœ… department_data_management - æœ¬éƒ¨é—¨æ•°æ®ç®¡ç†
- âœ… view_department_data - æŸ¥çœ‹æœ¬éƒ¨é—¨æ•°æ®
- âœ… edit_department_data - ç¼–è¾‘æœ¬éƒ¨é—¨æ•°æ®
- âœ… export_department_data - å¯¼å‡ºæœ¬éƒ¨é—¨æ•°æ®

**ä¸šåŠ¡åŠŸèƒ½ï¼ˆä»…æœ¬éƒ¨é—¨ï¼‰**:
- âœ… processing_batch_create - åˆ›å»ºæ‰¹æ¬¡ï¼ˆprocessingéƒ¨é—¨ï¼‰
- âœ… processing_batch_view_department - æŸ¥çœ‹æœ¬éƒ¨é—¨æ‰¹æ¬¡
- âœ… processing_batch_edit - ç¼–è¾‘æ‰¹æ¬¡
- âœ… quality_inspection_submit - æäº¤è´¨æ£€ï¼ˆqualityéƒ¨é—¨ï¼‰
- âœ… quality_inspection_approve - å®¡æ‰¹è´¨æ£€
- âœ… equipment_monitoring_view - æŸ¥çœ‹è®¾å¤‡ç›‘æ§
- âœ… timeclock_view_department - æŸ¥çœ‹æœ¬éƒ¨é—¨æ‰“å¡

**æŠ¥è¡¨**:
- âœ… view_department_reports - æŸ¥çœ‹éƒ¨é—¨æŠ¥è¡¨
- âœ… create_department_reports - åˆ›å»ºéƒ¨é—¨æŠ¥è¡¨

**éƒ¨é—¨è®¾ç½®**:
- âœ… department_settings - éƒ¨é—¨è®¾ç½®
- âœ… department_notifications - éƒ¨é—¨é€šçŸ¥

**æ•°æ®è®¿é—®èŒƒå›´**:
- æœ¬éƒ¨é—¨æ‰€æœ‰æ•°æ®
- æœ¬éƒ¨é—¨ç”¨æˆ·ä¿¡æ¯

**ä¸å…è®¸çš„æ“ä½œ**:
- âŒ ä¸èƒ½è®¿é—®å…¶ä»–éƒ¨é—¨æ•°æ®
- âŒ ä¸èƒ½ç®¡ç†å…¶ä»–éƒ¨é—¨ç”¨æˆ·
- âŒ ä¸èƒ½ä¿®æ”¹å·¥å‚é…ç½®

**å¯¼èˆªç¤ºä¾‹**:
```
processingéƒ¨é—¨ç®¡ç†å‘˜ â†’ ProcessingDashboardScreen
qualityéƒ¨é—¨ç®¡ç†å‘˜ â†’ QualityDashboardScreen
farmingéƒ¨é—¨ç®¡ç†å‘˜ â†’ FarmingDashboardScreen
```

---

##### operator (æ“ä½œå‘˜)

**åŸºæœ¬ä¿¡æ¯**:
| å±æ€§ | å€¼ |
|-----|---|
| æƒé™çº§åˆ« | 20 |
| ç”¨æˆ·ç±»å‹ | factory |
| æ•°æ®åº“è¡¨ | users |
| ç™»å½•æ–¹å¼ | ç”¨æˆ·å + å¯†ç  |
| ç™»å½•åå¯¼èˆª | ProcessingScreenæˆ–å…¶ä»–ä¸šåŠ¡é¡µé¢ |
| éƒ¨é—¨è®¿é—® | ä»…æœ¬éƒ¨é—¨ |

**æƒé™æ¸…å•**:

**æ•°æ®å½•å…¥**:
- âœ… data_entry - æ•°æ®å½•å…¥
- âœ… create_records - åˆ›å»ºè®°å½•
- âœ… update_records - æ›´æ–°è®°å½•ï¼ˆä»…æœ¬äººåˆ›å»ºï¼‰
- âœ… upload_files - ä¸Šä¼ æ–‡ä»¶

**ä¸šåŠ¡æ“ä½œ**:
- âœ… processing_batch_create - åˆ›å»ºæ‰¹æ¬¡
- âœ… processing_batch_view_own - æŸ¥çœ‹æœ¬äººæ‰¹æ¬¡
- âœ… quality_inspection_submit - æäº¤è´¨æ£€
- âœ… timeclock_in_out - æ‰“å¡
- âœ… equipment_usage_record - è®°å½•è®¾å¤‡ä½¿ç”¨

**æŸ¥çœ‹æƒé™**:
- âœ… view_own_records - æŸ¥çœ‹æœ¬äººè®°å½•
- âœ… view_department_data - æŸ¥çœ‹æœ¬éƒ¨é—¨æ•°æ®ï¼ˆåªè¯»ï¼‰
- âœ… basic_query - åŸºç¡€æŸ¥è¯¢

**æ•°æ®è®¿é—®èŒƒå›´**:
- æœ¬äººåˆ›å»ºçš„æ•°æ®ï¼ˆè¯»å†™ï¼‰
- æœ¬éƒ¨é—¨æ•°æ®ï¼ˆåªè¯»ï¼‰

**ä¸å…è®¸çš„æ“ä½œ**:
- âŒ ä¸èƒ½åˆ é™¤æ•°æ®
- âŒ ä¸èƒ½ç¼–è¾‘ä»–äººæ•°æ®
- âŒ ä¸èƒ½è®¿é—®å…¶ä»–éƒ¨é—¨æ•°æ®
- âŒ ä¸èƒ½å¯¼å‡ºæ•°æ®

---

##### viewer (æŸ¥çœ‹è€…)

**åŸºæœ¬ä¿¡æ¯**:
| å±æ€§ | å€¼ |
|-----|---|
| æƒé™çº§åˆ« | 30 |
| ç”¨æˆ·ç±»å‹ | factory |
| æ•°æ®åº“è¡¨ | users |
| ç™»å½•æ–¹å¼ | ç”¨æˆ·å + å¯†ç  |
| ç™»å½•åå¯¼èˆª | HomeScreenï¼ˆåªè¯»ä¸»é¡µï¼‰ |
| éƒ¨é—¨è®¿é—® | æˆæƒéƒ¨é—¨ |

**æƒé™æ¸…å•**:

**æŸ¥çœ‹æƒé™**:
- âœ… stats_view_basic - æŸ¥çœ‹åŸºç¡€ç»Ÿè®¡
- âœ… view_authorized_data - æŸ¥çœ‹æˆæƒæ•°æ®ï¼ˆåªè¯»ï¼‰
- âœ… view_reports - æŸ¥çœ‹æŠ¥è¡¨

**æ•°æ®è®¿é—®èŒƒå›´**:
- æˆæƒæ•°æ®ï¼ˆåªè¯»ï¼‰
- ä¸èƒ½åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ä»»ä½•æ•°æ®

**ä¸å…è®¸çš„æ“ä½œ**:
- âŒ ä¸èƒ½è¿›è¡Œä»»ä½•å†™æ“ä½œ
- âŒ ä¸èƒ½å¯¼å‡ºæ•°æ®
- âŒ ä¸èƒ½ä¸Šä¼ æ–‡ä»¶

**å…¸å‹ä½¿ç”¨åœºæ™¯**:
- è´¢åŠ¡äººå‘˜æŸ¥çœ‹ç”Ÿäº§æ•°æ®
- é«˜å±‚é¢†å¯¼æŸ¥çœ‹æŠ¥è¡¨
- å¤–éƒ¨å®¡è®¡äººå‘˜

---

##### unactivated (æœªæ¿€æ´»)

**åŸºæœ¬ä¿¡æ¯**:
| å±æ€§ | å€¼ |
|-----|---|
| æƒé™çº§åˆ« | 99 (æœ€ä½) |
| ç”¨æˆ·ç±»å‹ | factory |
| æ•°æ®åº“è¡¨ | users |
| ç™»å½•æ–¹å¼ | ç¦æ­¢ç™»å½• |
| ç™»å½•åå¯¼èˆª | N/A |

**çŠ¶æ€è¯´æ˜**:
- ç”¨æˆ·æ³¨å†Œåçš„åˆå§‹çŠ¶æ€ï¼ˆå¦‚æœåç»­éœ€è¦ç®¡ç†å‘˜å®¡æ‰¹ï¼‰
- æˆ–ç®¡ç†å‘˜åˆ›å»ºç”¨æˆ·åçš„å¾…æ¿€æ´»çŠ¶æ€

**ç™»å½•è¡Œä¸º**:
- å°è¯•ç™»å½•æ—¶è¿”å›é”™è¯¯: "è´¦å·æœªæ¿€æ´»ï¼Œè¯·è”ç³»ç®¡ç†å‘˜"
- æ— æ³•è®¿é—®ä»»ä½•åŠŸèƒ½

**æ¿€æ´»æµç¨‹**:
```
ç®¡ç†å‘˜æŸ¥çœ‹å¾…æ¿€æ´»ç”¨æˆ·åˆ—è¡¨
    â†“
é€‰æ‹©ç”¨æˆ· â†’ åˆ†é…è§’è‰² â†’ åˆ†é…éƒ¨é—¨ â†’ æ¿€æ´»
    â†“
ç”¨æˆ·æ”¶åˆ°é€šçŸ¥ï¼ˆå¦‚æœ‰é€šçŸ¥ç³»ç»Ÿï¼‰
    â†“
ç”¨æˆ·å¯ä»¥æ­£å¸¸ç™»å½•
```

---

### 2.3 æƒé™çŸ©é˜µè¡¨

| åŠŸèƒ½æ¨¡å— | platform_admin | factory_super_admin | permission_admin | department_admin | operator | viewer |
|---------|----------------|---------------------|------------------|------------------|----------|--------|
| **å¹³å°ç®¡ç†** | âœ… å®Œå…¨ | âŒ | âŒ | âŒ | âŒ | âŒ |
| **å·¥å‚ç®¡ç†** | âœ… æ‰€æœ‰å·¥å‚ | âœ… æœ¬å·¥å‚ | âŒ | âŒ | âŒ | âŒ |
| **ç”¨æˆ·ç®¡ç†** | âœ… æ‰€æœ‰ç”¨æˆ· | âœ… å·¥å‚æ‰€æœ‰ç”¨æˆ· | âœ… æƒé™ç®¡ç† | âœ… éƒ¨é—¨ç”¨æˆ· | âŒ | âŒ |
| **ç™½åå•ç®¡ç†** | âœ… æ‰€æœ‰å·¥å‚ | âœ… æœ¬å·¥å‚ | âœ… æœ¬å·¥å‚ | âœ… æœ¬éƒ¨é—¨ | âŒ | âŒ |
| **æ‰¹æ¬¡ç®¡ç†** | âœ… æ‰€æœ‰å·¥å‚ | âœ… æ‰€æœ‰éƒ¨é—¨ | ğŸ‘ï¸ åªè¯» | âœ… æœ¬éƒ¨é—¨ | âœ… åˆ›å»ºæŸ¥çœ‹ | ğŸ‘ï¸ åªè¯» |
| **è´¨æ£€ç®¡ç†** | âœ… æ‰€æœ‰å·¥å‚ | âœ… æ‰€æœ‰éƒ¨é—¨ | ğŸ‘ï¸ åªè¯» | âœ… æœ¬éƒ¨é—¨ | âœ… æäº¤ | ğŸ‘ï¸ åªè¯» |
| **å‘˜å·¥æ‰“å¡** | âœ… æ‰€æœ‰å·¥å‚ | âœ… æ‰€æœ‰éƒ¨é—¨ | ğŸ‘ï¸ åªè¯» | âœ… æœ¬éƒ¨é—¨ | âœ… æ‰“å¡ | ğŸ‘ï¸ åªè¯» |
| **è®¾å¤‡ç›‘æ§** | âœ… æ‰€æœ‰å·¥å‚ | âœ… æ‰€æœ‰è®¾å¤‡ | ğŸ‘ï¸ åªè¯» | âœ… æœ¬éƒ¨é—¨è®¾å¤‡ | ğŸ‘ï¸ åªè¯» | ğŸ‘ï¸ åªè¯» |
| **æˆæœ¬åˆ†æ** | âœ… æ‰€æœ‰å·¥å‚ | âœ… æœ¬å·¥å‚ | ğŸ‘ï¸ åªè¯» | âœ… æœ¬éƒ¨é—¨ | âŒ | ğŸ‘ï¸ åªè¯» |
| **æŠ¥è¡¨å¯¼å‡º** | âœ… æ‰€æœ‰æ•°æ® | âœ… å·¥å‚æ•°æ® | âœ… ç”¨æˆ·æ•°æ® | âœ… éƒ¨é—¨æ•°æ® | âŒ | âŒ |
| **ç³»ç»Ÿé…ç½®** | âœ… å¹³å°é…ç½® | âœ… å·¥å‚é…ç½® | âŒ | âŒ | âŒ | âŒ |

**å›¾ä¾‹**: âœ… å®Œå…¨è®¿é—® | ğŸ‘ï¸ åªè¯»è®¿é—® | âŒ æ— æƒè®¿é—®

---

### 2.4 ç™»å½•è®¤è¯æ–¹å¼ï¼ˆç»Ÿä¸€ï¼‰

**æ‰€æœ‰è§’è‰²ç»Ÿä¸€ä½¿ç”¨**: ç”¨æˆ·å + å¯†ç 

**ç™»å½•æµç¨‹**:
```
ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 
    â†“
ç‚¹å‡»"ç™»å½•"æŒ‰é’®
    â†“
å‰ç«¯è°ƒç”¨: POST /api/mobile/auth/unified-login
    â†“
åç«¯æ™ºèƒ½è¯†åˆ«ç”¨æˆ·ç±»å‹:
    ä¼˜å…ˆçº§1: åœ¨platform_adminsè¡¨æŸ¥æ‰¾ç”¨æˆ·å
        â”œâ”€ æ‰¾åˆ° â†’ å¹³å°ç”¨æˆ·ç™»å½•
        â””â”€ æœªæ‰¾åˆ° â†’ ç»§ç»­æŸ¥æ‰¾
    ä¼˜å…ˆçº§2: åœ¨usersè¡¨æŸ¥æ‰¾ç”¨æˆ·å
        â”œâ”€ æ‰¾åˆ° â†’ å·¥å‚ç”¨æˆ·ç™»å½•
        â””â”€ æœªæ‰¾åˆ° â†’ è¿”å›"ç”¨æˆ·ä¸å­˜åœ¨"
    â†“
éªŒè¯å¯†ç ï¼ˆbcryptå¯¹æ¯”ï¼‰
    â”œâ”€ å¯†ç é”™è¯¯ â†’ è¿”å›"å¯†ç é”™è¯¯"
    â””â”€ å¯†ç æ­£ç¡® â†’ ç»§ç»­
    â†“
æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
    â”œâ”€ isActive = false â†’ è¿”å›"è´¦å·æœªæ¿€æ´»"
    â””â”€ isActive = true â†’ ç»§ç»­
    â†“
ç”ŸæˆJWT Tokenï¼ˆaccessToken + refreshTokenï¼‰
    â†“
è¿”å›ç”¨æˆ·ä¿¡æ¯ + Token
    â†“
å‰ç«¯ä¿å­˜Tokenåˆ°SecureStore
    â†“
æ ¹æ®è§’è‰²å¯¼èˆªåˆ°å¯¹åº”é¡µé¢
```

**è‡ªåŠ¨ç™»å½•**:
```
Appå¯åŠ¨
    â†“
æ£€æŸ¥æœ¬åœ°Token
    â”œâ”€ æ— Token â†’ æ˜¾ç¤ºç™»å½•é¡µ
    â””â”€ æœ‰Token â†’ éªŒè¯Tokenæœ‰æ•ˆæ€§
            â”œâ”€ Tokenè¿‡æœŸ â†’ å°è¯•refreshToken
            â”‚       â”œâ”€ åˆ·æ–°æˆåŠŸ â†’ è‡ªåŠ¨ç™»å½•
            â”‚       â””â”€ åˆ·æ–°å¤±è´¥ â†’ æ˜¾ç¤ºç™»å½•é¡µ
            â””â”€ Tokenæœ‰æ•ˆ â†’ è‡ªåŠ¨ç™»å½•æˆåŠŸ
```

---

## ç™»å½•è®¤è¯è®¾è®¡

### 3.1 ç»Ÿä¸€ç™»å½•æµç¨‹

#### ç™»å½•ç•Œé¢è®¾è®¡

**EnhancedLoginScreen.tsx**

```typescript
ç•Œé¢å¸ƒå±€:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                  â”‚
â”‚    [Logo] ç™½å©çºªé£Ÿå“æº¯æºç³»ç»Ÿ     â”‚
â”‚                                  â”‚
â”‚  ç”¨æˆ·å: [___________]           â”‚
â”‚  å¯†ç :   [___________] [ğŸ‘ï¸]     â”‚
â”‚                                  â”‚
â”‚  [ ] è®°ä½å¯†ç                      â”‚
â”‚                                  â”‚
â”‚       [ç™»  å½•]                   â”‚
â”‚                                  â”‚
â”‚  [å¿˜è®°å¯†ç ]         [æ–°ç”¨æˆ·æ³¨å†Œ]  â”‚
â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### APIæ¥å£

```javascript
POST /api/mobile/auth/unified-login

è¯·æ±‚:
{
  username: string,    // ç”¨æˆ·åï¼ˆå¿…å¡«ï¼‰
  password: string,    // å¯†ç ï¼ˆå¿…å¡«ï¼‰
  deviceInfo?: {       // è®¾å¤‡ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
    deviceId: string,
    deviceModel: string,
    platform: 'ios' | 'android',
    osVersion: string,
    appVersion: string
  }
}

å“åº”ï¼ˆæˆåŠŸï¼‰:
{
  success: true,
  message: "ç™»å½•æˆåŠŸ",
  user: {
    id: number,
    username: string,
    fullName: string,
    phone: string,
    userType: 'platform' | 'factory',

    // å¹³å°ç”¨æˆ·ç‰¹æœ‰å­—æ®µ
    role?: 'platform_admin',

    // å·¥å‚ç”¨æˆ·ç‰¹æœ‰å­—æ®µ
    roleCode?: 'factory_super_admin' | 'permission_admin' | ...,
    factoryId?: string,
    department?: 'farming' | 'processing' | ...,

    permissions: {
      modules: { ... },
      features: [ ... ],
      role: string,
      userType: string,
      level: number
    }
  },
  tokens: {
    accessToken: string,
    refreshToken: string,
    expiresIn: number,    // ç§’ï¼Œé»˜è®¤86400ï¼ˆ24å°æ—¶ï¼‰
    tokenType: 'Bearer'
  }
}

å“åº”ï¼ˆå¤±è´¥ï¼‰:
{
  success: false,
  message: string,      // é”™è¯¯ä¿¡æ¯
  errorCode?: string    // é”™è¯¯ç 
}
```

#### é”™è¯¯å¤„ç†ï¼ˆ10ç§åœºæ™¯ï¼‰

| é”™è¯¯ç  | é”™è¯¯ä¿¡æ¯ | åœºæ™¯ | å‰ç«¯å¤„ç† |
|-------|---------|------|---------|
| INVALID_CREDENTIALS | ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ | ç”¨æˆ·åä¸å­˜åœ¨æˆ–å¯†ç é”™è¯¯ | æç¤ºç”¨æˆ·æ£€æŸ¥è¾“å…¥ |
| USER_NOT_FOUND | ç”¨æˆ·ä¸å­˜åœ¨ | ç”¨æˆ·åä¸åœ¨æ•°æ®åº“ | æç¤º"è¯·æ£€æŸ¥ç”¨æˆ·å" |
| WRONG_PASSWORD | å¯†ç é”™è¯¯ | å¯†ç ä¸æ­£ç¡® | æç¤º"å¯†ç é”™è¯¯ï¼Œè¿˜å‰©Xæ¬¡æœºä¼š" |
| ACCOUNT_NOT_ACTIVATED | è´¦å·æœªæ¿€æ´»ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ | isActive=false | æç¤ºè”ç³»ç®¡ç†å‘˜ |
| FACTORY_DISABLED | æ‰€å±å·¥å‚å·²åœç”¨ | factory.isActive=false | æç¤ºè”ç³»å¹³å°ç®¡ç†å‘˜ |
| ACCOUNT_LOCKED | è´¦å·å·²é”å®š | ç™»å½•å¤±è´¥æ¬¡æ•°è¿‡å¤š | æç¤º30åˆ†é’Ÿåé‡è¯• |
| NETWORK_ERROR | ç½‘ç»œè¿æ¥å¤±è´¥ | ç½‘ç»œå¼‚å¸¸ | æç¤ºæ£€æŸ¥ç½‘ç»œ |
| SERVER_ERROR | æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨ | æœåŠ¡å™¨500é”™è¯¯ | æç¤ºç¨åé‡è¯• |
| TOKEN_EXPIRED | ç™»å½•å·²è¿‡æœŸ | Tokenè¿‡æœŸ | è‡ªåŠ¨åˆ·æ–°æˆ–é‡æ–°ç™»å½• |
| INVALID_REQUEST | è¯·æ±‚å‚æ•°é”™è¯¯ | å‚æ•°ç¼ºå¤±æˆ–æ ¼å¼é”™è¯¯ | æç¤ºè¾“å…¥å®Œæ•´ |

#### å‰ç«¯é”™è¯¯å¤„ç†å®ç°

```typescript
// frontend/src/hooks/useLogin.ts
const ERROR_MESSAGES = {
  INVALID_CREDENTIALS: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•',
  USER_NOT_FOUND: 'ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·å',
  WRONG_PASSWORD: 'å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥',
  ACCOUNT_NOT_ACTIVATED: 'è´¦å·æœªæ¿€æ´»ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å¼€é€šæƒé™',
  FACTORY_DISABLED: 'æ‚¨æ‰€å±çš„å·¥å‚å·²åœç”¨ï¼Œè¯·è”ç³»å¹³å°ç®¡ç†å‘˜',
  ACCOUNT_LOCKED: 'è´¦å·å·²é”å®šï¼Œè¯·30åˆ†é’Ÿåå†è¯•',
  NETWORK_ERROR: 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®',
  SERVER_ERROR: 'æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•',
  TOKEN_EXPIRED: 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•',
  INVALID_REQUEST: 'è¯·è¾“å…¥å®Œæ•´çš„ç”¨æˆ·åå’Œå¯†ç '
};

const handleLoginError = (error: any) => {
  const errorCode = error.code || 'UNKNOWN';
  const message = ERROR_MESSAGES[errorCode] || 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';

  Alert.alert('ç™»å½•å¤±è´¥', message, [
    { text: 'é‡è¯•', onPress: () => retry() },
    { text: 'å¿˜è®°å¯†ç ', onPress: () => navigation.navigate('ForgotPassword') },
    { text: 'å–æ¶ˆ', style: 'cancel' }
  ]);
};
```

### 3.2 ç™»å½•åå¯¼èˆªé€»è¾‘

```typescript
// frontend/src/utils/navigationHelper.ts
export const getPostLoginRoute = (user: User) => {
  // å¹³å°ç”¨æˆ·
  if (user.userType === 'platform') {
    return 'PlatformScreen';
  }

  // å·¥å‚ç”¨æˆ· - æ ¹æ®è§’è‰²å¯¼èˆª
  switch (user.roleCode) {
    case 'factory_super_admin':
      return 'AdminScreen';

    case 'permission_admin':
      return 'UserManagementScreen';

    case 'department_admin':
      // æ ¹æ®éƒ¨é—¨å¯¼èˆª
      switch (user.department) {
        case 'processing':
          return 'ProcessingDashboardScreen';
        case 'quality':
          return 'QualityDashboardScreen';
        case 'farming':
          return 'FarmingDashboardScreen';
        case 'logistics':
          return 'LogisticsScreen';
        default:
          return 'HomeScreen';
      }

    case 'operator':
      // æ ¹æ®éƒ¨é—¨å¯¼èˆªåˆ°å¯¹åº”æ“ä½œé¡µé¢
      switch (user.department) {
        case 'processing':
          return 'ProcessingScreen';
        case 'quality':
          return 'QualityScreen';
        default:
          return 'HomeScreen';
      }

    case 'viewer':
      return 'HomeScreen';

    default:
      return 'HomeScreen';
  }
};
```

---

## æ³¨å†Œæµç¨‹è®¾è®¡

### 4.1 ç®€åŒ–æ³¨å†Œæµç¨‹

#### æ ¸å¿ƒè®¾è®¡æ€è·¯

**ä¸ä½¿ç”¨çŸ­ä¿¡éªŒè¯ç ï¼Œæ”¹ç”¨ç™½åå•éªŒè¯**:
- ç®¡ç†å‘˜é¢„å…ˆæ·»åŠ å…è®¸æ³¨å†Œçš„æ‰‹æœºå·åˆ°ç™½åå•
- ç”¨æˆ·æ³¨å†Œæ—¶æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦åœ¨ç™½åå•
- åœ¨ç™½åå•ä¸­å³å¯æ³¨å†Œï¼Œæ— éœ€çŸ­ä¿¡éªŒè¯

**è‡ªåŠ¨ç”Ÿæˆç”¨æˆ·å**:
- ç”¨æˆ·æ— éœ€æ‰‹åŠ¨è¾“å…¥ç”¨æˆ·å
- ç³»ç»Ÿæ ¹æ®è§„åˆ™è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€ç”¨æˆ·å
- æ ¼å¼: `{å·¥å‚ä»£ç }_{æ‰‹æœºå4ä½}_{éšæœº2ä½}`
- ç¤ºä¾‹: `FAC001_8000_AB`

**å¼ºåˆ¶è®¾ç½®å®‰å…¨é—®é¢˜**:
- æ³¨å†Œæ—¶å¿…é¡»è®¾ç½®3ä¸ªå®‰å…¨é—®é¢˜
- ç”¨äºåç»­æ‰¾å›å¯†ç 
- å®‰å…¨é—®é¢˜é¢„è®¾10ä¸ªé€‰é¡¹
- ç­”æ¡ˆåŠ å¯†å­˜å‚¨ï¼ˆbcryptï¼‰

#### æ³¨å†Œæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: ç™½åå•éªŒè¯                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·è¾“å…¥æ‰‹æœºå·                              â”‚
â”‚      â†“                                       â”‚
â”‚  ç‚¹å‡»"æ£€æŸ¥ç™½åå•"                            â”‚
â”‚      â†“                                       â”‚
â”‚  åç«¯æŸ¥è¯¢user_whitelistè¡¨                    â”‚
â”‚      â”œâ”€ ä¸åœ¨ç™½åå• â†’ æç¤º"æœªè¢«æˆæƒæ³¨å†Œ"     â”‚
â”‚      â””â”€ åœ¨ç™½åå• â†’ è¿”å›å·¥å‚ä¿¡æ¯              â”‚
â”‚              â†“                               â”‚
â”‚          å±•å¼€æ³¨å†Œè¡¨å•                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: å¡«å†™åŸºæœ¬ä¿¡æ¯                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ˜¾ç¤º:                                       â”‚
â”‚  - å·¥å‚åç§°ï¼ˆåªè¯»ï¼Œç”¨æˆ·ç¡®è®¤ï¼‰                â”‚
â”‚  - ç³»ç»Ÿç”¨æˆ·åï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼Œåªè¯»ï¼‰              â”‚
â”‚                                              â”‚
â”‚  ç”¨æˆ·è¾“å…¥:                                   â”‚
â”‚  - çœŸå®å§“åï¼ˆå¿…å¡«ï¼‰                          â”‚
â”‚  - å¯†ç ï¼ˆå¿…å¡«ï¼Œå¼ºåº¦éªŒè¯ï¼‰                    â”‚
â”‚  - ç¡®è®¤å¯†ç ï¼ˆå¿…å¡«ï¼Œä¸€è‡´æ€§æ£€æŸ¥ï¼‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: è®¾ç½®å®‰å…¨é—®é¢˜                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·ä»é¢„è®¾é—®é¢˜åº“é€‰æ‹©3ä¸ªé—®é¢˜:                â”‚
â”‚  - é—®é¢˜1: [ä¸‹æ‹‰é€‰æ‹©] ç­”æ¡ˆ1: [è¾“å…¥æ¡†]        â”‚
â”‚  - é—®é¢˜2: [ä¸‹æ‹‰é€‰æ‹©] ç­”æ¡ˆ2: [è¾“å…¥æ¡†]        â”‚
â”‚  - é—®é¢˜3: [ä¸‹æ‹‰é€‰æ‹©] ç­”æ¡ˆ3: [è¾“å…¥æ¡†]        â”‚
â”‚                                              â”‚
â”‚  éªŒè¯è§„åˆ™:                                   â”‚
â”‚  - 3ä¸ªé—®é¢˜ä¸èƒ½é‡å¤                           â”‚
â”‚  - æ¯ä¸ªç­”æ¡ˆè‡³å°‘2ä¸ªå­—ç¬¦                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: æäº¤æ³¨å†Œ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·å‹¾é€‰ç”¨æˆ·åè®®                            â”‚
â”‚      â†“                                       â”‚
â”‚  ç‚¹å‡»"æ³¨å†Œå¹¶ç™»å½•"                            â”‚
â”‚      â†“                                       â”‚
â”‚  åç«¯å¤„ç†:                                   â”‚
â”‚  1. è‡ªåŠ¨ç”Ÿæˆç”¨æˆ·å                           â”‚
â”‚  2. å¯†ç åŠ å¯†ï¼ˆbcryptï¼‰                       â”‚
â”‚  3. å®‰å…¨é—®é¢˜ç­”æ¡ˆåŠ å¯†ï¼ˆbcryptï¼‰               â”‚
â”‚  4. åˆ›å»ºç”¨æˆ·ï¼ˆé»˜è®¤roleCode: viewerï¼‰         â”‚
â”‚  5. åˆ›å»ºå®‰å…¨é—®é¢˜è®°å½•                         â”‚
â”‚  6. æ›´æ–°ç™½åå•çŠ¶æ€ä¸ºREGISTERED               â”‚
â”‚  7. ç”ŸæˆToken                               â”‚
â”‚      â†“                                       â”‚
â”‚  è¿”å›ç”¨æˆ·ä¿¡æ¯+Token                          â”‚
â”‚      â†“                                       â”‚
â”‚  å‰ç«¯è‡ªåŠ¨ç™»å½•                                â”‚
â”‚      â†“                                       â”‚
â”‚  æ ¹æ®è§’è‰²è·³è½¬åˆ°å¯¹åº”ä¸»é¡µ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ³¨å†Œé¡µé¢è®¾è®¡

#### RegisterScreen.tsx - ç•Œé¢è¯¦ç»†è®¾è®¡

```typescript
import React, { useState, useEffect } from 'react';
import {
  View, Text, TextInput, TouchableOpacity,
  ScrollView, Alert, ActivityIndicator,
  KeyboardAvoidingView, Platform
} from 'react-native';
import { Picker } from '@react-native-picker/picker';

// é¢„è®¾å®‰å…¨é—®é¢˜åº“
const SECURITY_QUESTIONS = [
  { id: 1, question: 'æ‚¨æ¯äº²çš„å§“åæ˜¯ä»€ä¹ˆï¼Ÿ' },
  { id: 2, question: 'æ‚¨å‡ºç”Ÿçš„åŸå¸‚æ˜¯å“ªé‡Œï¼Ÿ' },
  { id: 3, question: 'æ‚¨å°å­¦ç­ä¸»ä»»çš„å§“åæ˜¯ä»€ä¹ˆï¼Ÿ' },
  { id: 4, question: 'æ‚¨æœ€å–œæ¬¢çš„é£Ÿç‰©æ˜¯ä»€ä¹ˆï¼Ÿ' },
  { id: 5, question: 'æ‚¨çš„ç¬¬ä¸€ä¸ªå® ç‰©å«ä»€ä¹ˆåå­—ï¼Ÿ' },
  { id: 6, question: 'æ‚¨é…å¶çš„ç”Ÿæ—¥æ˜¯å‡ æœˆå‡ å·ï¼Ÿ' },
  { id: 7, question: 'æ‚¨çš„å·¥å·æ˜¯å¤šå°‘ï¼Ÿ' },
  { id: 8, question: 'æ‚¨å…¥èŒçš„å¹´ä»½æ˜¯å“ªä¸€å¹´ï¼Ÿ' },
  { id: 9, question: 'æ‚¨æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯ä»€ä¹ˆï¼Ÿ' },
  { id: 10, question: 'æ‚¨çš„èº«ä»½è¯å6ä½æ˜¯ä»€ä¹ˆï¼Ÿ' }
];

export const RegisterScreen = ({ navigation }) => {
  // === Stateç®¡ç† ===
  const [step, setStep] = useState(1); // å½“å‰æ­¥éª¤: 1=ç™½åå•éªŒè¯, 2=å¡«å†™ä¿¡æ¯

  // Step 1: ç™½åå•éªŒè¯
  const [phoneNumber, setPhoneNumber] = useState('');
  const [checkingWhitelist, setCheckingWhitelist] = useState(false);
  const [whitelistVerified, setWhitelistVerified] = useState(false);
  const [factoryInfo, setFactoryInfo] = useState(null);
  const [generatedUsername, setGeneratedUsername] = useState('');

  // Step 2: åŸºæœ¬ä¿¡æ¯
  const [fullName, setFullName] = useState('');
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [passwordStrength, setPasswordStrength] = useState(0);

  // Step 3: å®‰å…¨é—®é¢˜
  const [question1, setQuestion1] = useState(null);
  const [answer1, setAnswer1] = useState('');
  const [question2, setQuestion2] = useState(null);
  const [answer2, setAnswer2] = useState('');
  const [question3, setQuestion3] = useState(null);
  const [answer3, setAnswer3] = useState('');

  const [agreedToTerms, setAgreedToTerms] = useState(false);
  const [isRegistering, setIsRegistering] = useState(false);

  // === å¯†ç å¼ºåº¦è®¡ç®— ===
  useEffect(() => {
    if (!password) {
      setPasswordStrength(0);
      return;
    }

    let strength = 0;
    if (password.length >= 8) strength += 25;
    if (/[a-z]/.test(password)) strength += 25;
    if (/[A-Z]/.test(password)) strength += 25;
    if (/\d/.test(password)) strength += 25;

    setPasswordStrength(strength);
  }, [password]);

  // === æ£€æŸ¥ç™½åå• ===
  const handleCheckWhitelist = async () => {
    if (!phoneNumber || !/^1[3-9]\d{9}$/.test(phoneNumber)) {
      Alert.alert('æç¤º', 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
      return;
    }

    setCheckingWhitelist(true);

    try {
      const result = await authService.checkWhitelist(phoneNumber);

      if (result.success && result.isInWhitelist) {
        // ç™½åå•éªŒè¯é€šè¿‡
        setWhitelistVerified(true);
        setFactoryInfo(result.factories[0]); // å–ç¬¬ä¸€ä¸ªå·¥å‚

        // é¢„è§ˆç”Ÿæˆçš„ç”¨æˆ·å
        const username = await authService.previewUsername(
          result.factories[0].factoryId,
          phoneNumber
        );
        setGeneratedUsername(username);

        setStep(2); // è¿›å…¥å¡«å†™ä¿¡æ¯æ­¥éª¤
      } else {
        Alert.alert('æç¤º', 'æ‚¨çš„æ‰‹æœºå·æœªè¢«æˆæƒæ³¨å†Œï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ·»åŠ ç™½åå•');
      }
    } catch (error) {
      Alert.alert('é”™è¯¯', error.message || 'æ£€æŸ¥ç™½åå•å¤±è´¥');
    } finally {
      setCheckingWhitelist(false);
    }
  };

  // === è¡¨å•éªŒè¯ ===
  const validateForm = () => {
    // çœŸå®å§“åéªŒè¯
    if (!fullName || fullName.length < 2) {
      Alert.alert('æç¤º', 'è¯·è¾“å…¥çœŸå®å§“åï¼ˆè‡³å°‘2ä¸ªå­—ç¬¦ï¼‰');
      return false;
    }

    // å¯†ç å¼ºåº¦éªŒè¯
    if (passwordStrength < 75) {
      Alert.alert('æç¤º', 'å¯†ç å¼ºåº¦ä¸è¶³ï¼Œè¯·åŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—ï¼Œè‡³å°‘8ä½');
      return false;
    }

    // ç¡®è®¤å¯†ç éªŒè¯
    if (password !== confirmPassword) {
      Alert.alert('æç¤º', 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
      return false;
    }

    // å®‰å…¨é—®é¢˜éªŒè¯
    if (!question1 || !question2 || !question3) {
      Alert.alert('æç¤º', 'è¯·é€‰æ‹©3ä¸ªå®‰å…¨é—®é¢˜');
      return false;
    }

    // æ£€æŸ¥é—®é¢˜ä¸é‡å¤
    if (question1 === question2 || question1 === question3 || question2 === question3) {
      Alert.alert('æç¤º', 'å®‰å…¨é—®é¢˜ä¸èƒ½é‡å¤');
      return false;
    }

    // ç­”æ¡ˆéªŒè¯
    if (!answer1 || answer1.length < 2) {
      Alert.alert('æç¤º', 'è¯·è¾“å…¥å®‰å…¨é—®é¢˜1çš„ç­”æ¡ˆï¼ˆè‡³å°‘2ä¸ªå­—ç¬¦ï¼‰');
      return false;
    }
    if (!answer2 || answer2.length < 2) {
      Alert.alert('æç¤º', 'è¯·è¾“å…¥å®‰å…¨é—®é¢˜2çš„ç­”æ¡ˆï¼ˆè‡³å°‘2ä¸ªå­—ç¬¦ï¼‰');
      return false;
    }
    if (!answer3 || answer3.length < 2) {
      Alert.alert('æç¤º', 'è¯·è¾“å…¥å®‰å…¨é—®é¢˜3çš„ç­”æ¡ˆï¼ˆè‡³å°‘2ä¸ªå­—ç¬¦ï¼‰');
      return false;
    }

    // ç”¨æˆ·åè®®
    if (!agreedToTerms) {
      Alert.alert('æç¤º', 'è¯·é˜…è¯»å¹¶åŒæ„ç”¨æˆ·åè®®');
      return false;
    }

    return true;
  };

  // === æäº¤æ³¨å†Œ ===
  const handleRegister = async () => {
    if (!validateForm()) {
      return;
    }

    setIsRegistering(true);

    try {
      const result = await authService.register({
        phoneNumber,
        fullName,
        password,
        confirmPassword,
        securityQuestions: [
          { questionId: question1.id, question: question1.question, answer: answer1 },
          { questionId: question2.id, question: question2.question, answer: answer2 },
          { questionId: question3.id, question: question3.question, answer: answer3 }
        ]
      });

      if (result.success) {
        // æ³¨å†ŒæˆåŠŸï¼Œè‡ªåŠ¨ç™»å½•
        Alert.alert('æ³¨å†ŒæˆåŠŸ', `æ‚¨çš„ç”¨æˆ·åæ˜¯: ${result.user.username}\nè¯·å¦¥å–„ä¿ç®¡`, [
          {
            text: 'å¼€å§‹ä½¿ç”¨',
            onPress: () => {
              // å·²ç»è‡ªåŠ¨ç™»å½•ï¼Œç›´æ¥å¯¼èˆª
              const route = getPostLoginRoute(result.user);
              navigation.replace(route);
            }
          }
        ]);
      }
    } catch (error) {
      Alert.alert('æ³¨å†Œå¤±è´¥', error.message || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setIsRegistering(false);
    }
  };

  return (
    <KeyboardAvoidingView
      behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
      style={styles.container}
    >
      <ScrollView contentContainerStyle={styles.scrollContent}>
        <Text style={styles.title}>æ–°ç”¨æˆ·æ³¨å†Œ</Text>

        {/* Step 1: ç™½åå•éªŒè¯ */}
        {step === 1 && (
          <View style={styles.section}>
            <Text style={styles.stepTitle}>ç¬¬ä¸€æ­¥ï¼šéªŒè¯ç™½åå•</Text>

            <View style={styles.formField}>
              <Text style={styles.label}>æ‰‹æœºå· *</Text>
              <View style={styles.inputRow}>
                <TextInput
                  style={styles.input}
                  placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·"
                  keyboardType="phone-pad"
                  maxLength={11}
                  value={phoneNumber}
                  onChangeText={setPhoneNumber}
                  editable={!whitelistVerified}
                />
                <TouchableOpacity
                  style={styles.checkButton}
                  onPress={handleCheckWhitelist}
                  disabled={checkingWhitelist || whitelistVerified}
                >
                  {checkingWhitelist ? (
                    <ActivityIndicator color="#fff" />
                  ) : (
                    <Text style={styles.checkButtonText}>
                      {whitelistVerified ? 'âœ“ å·²éªŒè¯' : 'æ£€æŸ¥'}
                    </Text>
                  )}
                </TouchableOpacity>
              </View>
            </View>
          </View>
        )}

        {/* Step 2 & 3: å¡«å†™ä¿¡æ¯ï¼ˆç™½åå•éªŒè¯é€šè¿‡åæ˜¾ç¤ºï¼‰ */}
        {whitelistVerified && step === 2 && (
          <View>
            {/* å·¥å‚ä¿¡æ¯å±•ç¤º */}
            <View style={styles.infoBox}>
              <Text style={styles.infoLabel}>âœ“ æ‚¨å·²è¢«æˆæƒæ³¨å†Œ</Text>
              <Text style={styles.infoText}>
                å·¥å‚åç§°: {factoryInfo.factoryName}
              </Text>
              <Text style={styles.infoText}>
                ç³»ç»Ÿç”¨æˆ·å: {generatedUsername}
              </Text>
              <Text style={styles.infoNote}>
                ï¼ˆè¯·è®°ä½æ‚¨çš„ç”¨æˆ·åï¼Œç™»å½•æ—¶éœ€è¦ä½¿ç”¨ï¼‰
              </Text>
            </View>

            {/* åŸºæœ¬ä¿¡æ¯ */}
            <View style={styles.section}>
              <Text style={styles.stepTitle}>ç¬¬äºŒæ­¥ï¼šå¡«å†™åŸºæœ¬ä¿¡æ¯</Text>

              <View style={styles.formField}>
                <Text style={styles.label}>çœŸå®å§“å *</Text>
                <TextInput
                  style={styles.input}
                  placeholder="è¯·è¾“å…¥æ‚¨çš„çœŸå®å§“å"
                  value={fullName}
                  onChangeText={setFullName}
                />
              </View>

              <View style={styles.formField}>
                <Text style={styles.label}>å¯†ç  *</Text>
                <TextInput
                  style={styles.input}
                  placeholder="è‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—"
                  secureTextEntry
                  value={password}
                  onChangeText={setPassword}
                />
                {/* å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨ */}
                <View style={styles.strengthIndicator}>
                  <View style={styles.strengthBar}>
                    <View
                      style={[
                        styles.strengthFill,
                        { width: `${passwordStrength}%` },
                        passwordStrength < 50 && styles.strengthWeak,
                        passwordStrength >= 50 && passwordStrength < 75 && styles.strengthMedium,
                        passwordStrength >= 75 && styles.strengthStrong
                      ]}
                    />
                  </View>
                  <Text style={styles.strengthText}>
                    {passwordStrength === 0 && ''}
                    {passwordStrength > 0 && passwordStrength < 50 && 'å¼±'}
                    {passwordStrength >= 50 && passwordStrength < 75 && 'ä¸­ç­‰'}
                    {passwordStrength >= 75 && 'å¼º'}
                  </Text>
                </View>
              </View>

              <View style={styles.formField}>
                <Text style={styles.label}>ç¡®è®¤å¯†ç  *</Text>
                <TextInput
                  style={styles.input}
                  placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
                  secureTextEntry
                  value={confirmPassword}
                  onChangeText={setConfirmPassword}
                />
              </View>
            </View>

            {/* å®‰å…¨é—®é¢˜ */}
            <View style={styles.section}>
              <Text style={styles.stepTitle}>ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®å®‰å…¨é—®é¢˜ï¼ˆç”¨äºæ‰¾å›å¯†ç ï¼‰</Text>

              {/* å®‰å…¨é—®é¢˜1 */}
              <View style={styles.formField}>
                <Text style={styles.label}>å®‰å…¨é—®é¢˜ 1 *</Text>
                <Picker
                  selectedValue={question1?.id}
                  onValueChange={(itemValue) => {
                    const q = SECURITY_QUESTIONS.find(q => q.id === itemValue);
                    setQuestion1(q);
                  }}
                  style={styles.picker}
                >
                  <Picker.Item label="è¯·é€‰æ‹©å®‰å…¨é—®é¢˜" value={null} />
                  {SECURITY_QUESTIONS.map(q => (
                    <Picker.Item
                      key={q.id}
                      label={q.question}
                      value={q.id}
                      enabled={q.id !== question2?.id && q.id !== question3?.id}
                    />
                  ))}
                </Picker>
                <TextInput
                  style={styles.input}
                  placeholder="è¯·è¾“å…¥ç­”æ¡ˆ"
                  value={answer1}
                  onChangeText={setAnswer1}
                  editable={!!question1}
                />
              </View>

              {/* å®‰å…¨é—®é¢˜2 */}
              <View style={styles.formField}>
                <Text style={styles.label}>å®‰å…¨é—®é¢˜ 2 *</Text>
                <Picker
                  selectedValue={question2?.id}
                  onValueChange={(itemValue) => {
                    const q = SECURITY_QUESTIONS.find(q => q.id === itemValue);
                    setQuestion2(q);
                  }}
                  style={styles.picker}
                >
                  <Picker.Item label="è¯·é€‰æ‹©å®‰å…¨é—®é¢˜" value={null} />
                  {SECURITY_QUESTIONS.map(q => (
                    <Picker.Item
                      key={q.id}
                      label={q.question}
                      value={q.id}
                      enabled={q.id !== question1?.id && q.id !== question3?.id}
                    />
                  ))}
                </Picker>
                <TextInput
                  style={styles.input}
                  placeholder="è¯·è¾“å…¥ç­”æ¡ˆ"
                  value={answer2}
                  onChangeText={setAnswer2}
                  editable={!!question2}
                />
              </View>

              {/* å®‰å…¨é—®é¢˜3 */}
              <View style={styles.formField}>
                <Text style={styles.label}>å®‰å…¨é—®é¢˜ 3 *</Text>
                <Picker
                  selectedValue={question3?.id}
                  onValueChange={(itemValue) => {
                    const q = SECURITY_QUESTIONS.find(q => q.id === itemValue);
                    setQuestion3(q);
                  }}
                  style={styles.picker}
                >
                  <Picker.Item label="è¯·é€‰æ‹©å®‰å…¨é—®é¢˜" value={null} />
                  {SECURITY_QUESTIONS.map(q => (
                    <Picker.Item
                      key={q.id}
                      label={q.question}
                      value={q.id}
                      enabled={q.id !== question1?.id && q.id !== question2?.id}
                    />
                  ))}
                </Picker>
                <TextInput
                  style={styles.input}
                  placeholder="è¯·è¾“å…¥ç­”æ¡ˆ"
                  value={answer3}
                  onChangeText={setAnswer3}
                  editable={!!question3}
                />
              </View>
            </View>

            {/* ç”¨æˆ·åè®® */}
            <TouchableOpacity
              style={styles.checkboxRow}
              onPress={() => setAgreedToTerms(!agreedToTerms)}
            >
              <View style={styles.checkbox}>
                {agreedToTerms && <Text>âœ“</Text>}
              </View>
              <Text style={styles.checkboxLabel}>
                æˆ‘å·²é˜…è¯»å¹¶åŒæ„<Text style={styles.link}>ã€Šç”¨æˆ·åè®®ã€‹</Text>
              </Text>
            </TouchableOpacity>

            {/* æ³¨å†ŒæŒ‰é’® */}
            <TouchableOpacity
              style={[styles.registerButton, isRegistering && styles.buttonDisabled]}
              onPress={handleRegister}
              disabled={isRegistering}
            >
              {isRegistering ? (
                <ActivityIndicator color="#fff" />
              ) : (
                <Text style={styles.registerButtonText}>æ³¨å†Œå¹¶ç™»å½•</Text>
              )}
            </TouchableOpacity>
          </View>
        )}

        {/* è¿”å›ç™»å½• */}
        <TouchableOpacity
          style={styles.backToLogin}
          onPress={() => navigation.navigate('Login')}
        >
          <Text style={styles.backToLoginText}>å·²æœ‰è´¦å·ï¼Ÿè¿”å›ç™»å½•</Text>
        </TouchableOpacity>
      </ScrollView>
    </KeyboardAvoidingView>
  );
};
```

### 4.3 ç”¨æˆ·åç”Ÿæˆè§„åˆ™

#### ç”Ÿæˆç®—æ³•

```javascript
// backend/src/utils/usernameGenerator.js

import { PrismaClient } from '@prisma/client';
const prisma = new PrismaClient();

/**
 * ç”Ÿæˆå”¯ä¸€ç”¨æˆ·å
 * æ ¼å¼: {å·¥å‚ä»£ç }_{æ‰‹æœºå·å4ä½}_{éšæœº2ä½å¤§å†™å­—æ¯}
 * ç¤ºä¾‹: FAC001_8000_AB
 */
export const generateUsername = async (factoryId, phoneNumber) => {
  try {
    // 1. è·å–å·¥å‚ä»£ç 
    const factory = await prisma.factory.findUnique({
      where: { id: factoryId },
      select: { id: true }
    });

    if (!factory) {
      throw new Error('å·¥å‚ä¸å­˜åœ¨');
    }

    const factoryCode = factory.id; // "FAC001"

    // 2. æå–æ‰‹æœºå·å4ä½
    const phoneLast4 = phoneNumber.slice(-4); // "8000"

    // 3. ç”Ÿæˆéšæœº2ä½å¤§å†™å­—æ¯
    const getRandomLetters = () => {
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      return letters[Math.floor(Math.random() * 26)] +
             letters[Math.floor(Math.random() * 26)];
    };

    // 4. å°è¯•ç”Ÿæˆå”¯ä¸€ç”¨æˆ·åï¼ˆæœ€å¤šå°è¯•10æ¬¡ï¼‰
    let username;
    let attempts = 0;
    const maxAttempts = 10;

    while (attempts < maxAttempts) {
      const randomPart = getRandomLetters();
      username = `${factoryCode}_${phoneLast4}_${randomPart}`;

      // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
      const existingUser = await prisma.user.findFirst({
        where: { username }
      });

      if (!existingUser) {
        return username; // æ‰¾åˆ°å”¯ä¸€ç”¨æˆ·åï¼Œè¿”å›
      }

      attempts++;
    }

    // 5. å¦‚æœ10æ¬¡éƒ½é‡å¤ï¼Œä½¿ç”¨æ—¶é—´æˆ³å4ä½
    const timestamp = Date.now().toString().slice(-4);
    username = `${factoryCode}_${phoneLast4}_${timestamp}`;

    return username;
  } catch (error) {
    console.error('ç”Ÿæˆç”¨æˆ·åå¤±è´¥:', error);
    throw error;
  }
};

/**
 * é¢„è§ˆç”¨æˆ·åï¼ˆæ³¨å†Œé¡µé¢å®æ—¶æ˜¾ç¤ºï¼‰
 * ä¸æ£€æŸ¥å”¯ä¸€æ€§ï¼Œåªç”Ÿæˆé¢„è§ˆ
 */
export const previewUsername = (factoryId, phoneNumber) => {
  const factoryCode = factoryId;
  const phoneLast4 = phoneNumber.slice(-4);
  return `${factoryCode}_${phoneLast4}_XX`;
};
```

**ç”¨æˆ·åç¤ºä¾‹**:
| å·¥å‚ä»£ç  | æ‰‹æœºå· | ç”Ÿæˆç”¨æˆ·å |
|---------|-------|-----------|
| FAC001 | 13800138000 | FAC001_8000_AB |
| FAC002 | 13912345678 | FAC002_5678_CD |
| FAC003 | 15800001111 | FAC003_1111_EF |

### 4.4 åç«¯æ³¨å†ŒAPIè®¾è®¡

#### APIæ¥å£

```javascript
// backend/src/routes/mobile.js

// 1. æ£€æŸ¥ç™½åå•ï¼ˆç‹¬ç«‹æ¥å£ï¼‰
router.post('/auth/check-whitelist', async (req, res) => {
  const { phoneNumber } = req.body;

  try {
    const { checkWhitelistStatus } = await import('../controllers/authController.js');
    const result = await checkWhitelistStatus(phoneNumber);
    res.json(result);
  } catch (error) {
    res.status(500).json({ success: false, message: 'æ£€æŸ¥ç™½åå•å¤±è´¥' });
  }
});

// 2. é¢„è§ˆç”¨æˆ·åï¼ˆè¾…åŠ©æ¥å£ï¼‰
router.post('/auth/preview-username', async (req, res) => {
  const { factoryId, phoneNumber } = req.body;

  try {
    const { previewUsername } = await import('../utils/usernameGenerator.js');
    const username = previewUsername(factoryId, phoneNumber);
    res.json({ success: true, username });
  } catch (error) {
    res.status(500).json({ success: false, message: 'ç”Ÿæˆç”¨æˆ·åå¤±è´¥' });
  }
});

// 3. æ³¨å†Œæ¥å£ï¼ˆå•æ¥å£å®Œæˆæ•´ä¸ªæ³¨å†Œæµç¨‹ï¼‰
router.post('/auth/register', async (req, res) => {
  const {
    phoneNumber,
    fullName,
    password,
    confirmPassword,
    securityQuestions
  } = req.body;

  try {
    const { registerUser } = await import('../controllers/authController.js');
    const result = await registerUser({
      phoneNumber,
      fullName,
      password,
      confirmPassword,
      securityQuestions
    });

    if (!result.success) {
      return res.status(400).json(result);
    }

    res.status(201).json(result);
  } catch (error) {
    res.status(500).json({ success: false, message: 'æ³¨å†Œå¤±è´¥' });
  }
});
```

#### Controllerå®ç°

```javascript
// backend/src/controllers/authController.js

import { generateUsername } from '../utils/usernameGenerator.js';

/**
 * ç”¨æˆ·æ³¨å†Œï¼ˆå®Œæ•´æµç¨‹ï¼‰
 */
export const registerUser = async (data) => {
  const {
    phoneNumber,
    fullName,
    password,
    confirmPassword,
    securityQuestions
  } = data;

  try {
    // 1. éªŒè¯å¯†ç ä¸€è‡´æ€§
    if (password !== confirmPassword) {
      return { success: false, message: 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´' };
    }

    // 2. éªŒè¯å¯†ç å¼ºåº¦
    const passwordValidation = validatePasswordStrength(password);
    if (!passwordValidation.isValid) {
      return { success: false, message: passwordValidation.errors.join('ï¼›') };
    }

    // 3. æ£€æŸ¥ç™½åå•
    const whitelist = await prisma.userWhitelist.findFirst({
      where: {
        phoneNumber,
        status: 'PENDING',
        expiresAt: { gt: new Date() }
      },
      include: { factory: true }
    });

    if (!whitelist) {
      return { success: false, message: 'æ‰‹æœºå·æœªåœ¨ç™½åå•ä¸­æˆ–ç™½åå•å·²è¿‡æœŸ' };
    }

    const factoryId = whitelist.factoryId;

    // 4. æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²æ³¨å†Œ
    const existingUser = await prisma.user.findFirst({
      where: {
        OR: [
          { phone: phoneNumber },
          { factoryId, fullName } // åŒå·¥å‚åŒå§“åä¹Ÿè§†ä¸ºé‡å¤
        ]
      }
    });

    if (existingUser) {
      return { success: false, message: 'è¯¥æ‰‹æœºå·å·²è¢«æ³¨å†Œæˆ–å§“åé‡å¤' };
    }

    // 5. ç”Ÿæˆå”¯ä¸€ç”¨æˆ·å
    const username = await generateUsername(factoryId, phoneNumber);

    // 6. åŠ å¯†å¯†ç 
    const passwordHash = await hashPassword(password);

    // 7. åŠ å¯†å®‰å…¨é—®é¢˜ç­”æ¡ˆ
    const answer1Hash = await hashPassword(securityQuestions[0].answer);
    const answer2Hash = await hashPassword(securityQuestions[1].answer);
    const answer3Hash = await hashPassword(securityQuestions[2].answer);

    // 8. åˆ›å»ºç”¨æˆ·ï¼ˆä½¿ç”¨äº‹åŠ¡ï¼‰
    const result = await prisma.$transaction(async (tx) => {
      // åˆ›å»ºç”¨æˆ·
      const newUser = await tx.user.create({
        data: {
          factoryId,
          username,
          passwordHash,
          phone: phoneNumber,
          fullName,
          isActive: true,     // ç™½åå•ç”¨æˆ·è‡ªåŠ¨æ¿€æ´»
          roleCode: 'viewer', // é»˜è®¤è§’è‰²
          lastLogin: new Date()
        },
        include: {
          factory: {
            select: {
              id: true,
              name: true,
              industry: true
            }
          }
        }
      });

      // åˆ›å»ºå®‰å…¨é—®é¢˜è®°å½•
      await tx.userSecurityQuestion.create({
        data: {
          userId: newUser.id,
          question1: securityQuestions[0].question,
          answer1Hash,
          question2: securityQuestions[1].question,
          answer2Hash,
          question3: securityQuestions[2].question,
          answer3Hash
        }
      });

      // æ›´æ–°ç™½åå•çŠ¶æ€
      await tx.userWhitelist.update({
        where: { id: whitelist.id },
        data: { status: 'REGISTERED' }
      });

      return newUser;
    });

    // 9. ç”ŸæˆTokenï¼ˆè‡ªåŠ¨ç™»å½•ï¼‰
    const tokens = await generateAuthTokens(result, factoryId);

    // 10. ç”Ÿæˆç”¨æˆ·æƒé™
    const permissions = generateUserPermissions(result);

    // 11. è¿”å›å®Œæ•´ç”¨æˆ·ä¿¡æ¯ï¼ˆå«Tokenï¼‰
    return {
      success: true,
      message: 'æ³¨å†ŒæˆåŠŸ',
      user: {
        id: result.id,
        username: result.username,
        phone: result.phone,
        fullName: result.fullName,
        factoryId: result.factoryId,
        factory: result.factory,
        roleCode: result.roleCode,
        isActive: result.isActive,
        userType: 'factory',
        permissions,
        createdAt: result.createdAt.toISOString()
      },
      tokens
    };
  } catch (error) {
    console.error('æ³¨å†Œå¤±è´¥:', error);
    return { success: false, message: 'æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' };
  }
};
```

---

## å¿˜è®°å¯†ç /é‡ç½®å¯†ç è®¾è®¡

### 5.1 è®¾è®¡æ€è·¯

**ä¸ä½¿ç”¨çŸ­ä¿¡éªŒè¯ç ï¼Œæ”¹ç”¨å®‰å…¨é—®é¢˜éªŒè¯**:
- ç”¨æˆ·é€šè¿‡"çœŸå®å§“å+æ‰‹æœºå·"æ‰¾å›è´¦å·
- å›ç­”æ³¨å†Œæ—¶è®¾ç½®çš„3ä¸ªå®‰å…¨é—®é¢˜
- éªŒè¯é€šè¿‡åæ‰èƒ½é‡ç½®å¯†ç 
- é‡ç½®å¯†ç åæ’¤é”€æ‰€æœ‰æ—§Tokenï¼ˆå¼ºåˆ¶é‡æ–°ç™»å½•ï¼‰

**å¿˜è®°å¯†ç  = é‡ç½®å¯†ç **:
- åªæœ‰ä¸€ä¸ªå…¥å£"å¿˜è®°å¯†ç "
- åˆå¹¶ä¸ºç»Ÿä¸€æµç¨‹

### 5.2 é‡ç½®å¯†ç æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: èº«ä»½éªŒè¯                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·è¾“å…¥:                                   â”‚
â”‚  - çœŸå®å§“å                                  â”‚
â”‚  - æ‰‹æœºå·                                    â”‚
â”‚      â†“                                       â”‚
â”‚  ç‚¹å‡»"ä¸‹ä¸€æ­¥"                                â”‚
â”‚      â†“                                       â”‚
â”‚  åç«¯æŸ¥è¯¢usersè¡¨:                            â”‚
â”‚  WHERE fullName = ? AND phone = ?            â”‚
â”‚      â”œâ”€ æœªæ‰¾åˆ° â†’ æç¤º"ç”¨æˆ·ä¸å­˜åœ¨æˆ–ä¿¡æ¯ä¸åŒ¹é…"â”‚
â”‚      â””â”€ æ‰¾åˆ°ç”¨æˆ· â†’ æŸ¥è¯¢å®‰å…¨é—®é¢˜              â”‚
â”‚              â†“                               â”‚
â”‚          è¿”å›3ä¸ªå®‰å…¨é—®é¢˜ï¼ˆä¸è¿”å›ç­”æ¡ˆï¼‰        â”‚
â”‚              â†“                               â”‚
â”‚          ç”Ÿæˆä¸´æ—¶resetTokenï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆï¼‰     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: å›ç­”å®‰å…¨é—®é¢˜                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ˜¾ç¤ºç”¨æˆ·åï¼ˆæé†’ç”¨æˆ·ï¼‰                      â”‚
â”‚  æ˜¾ç¤º3ä¸ªå®‰å…¨é—®é¢˜                             â”‚
â”‚      â†“                                       â”‚
â”‚  ç”¨æˆ·è¾“å…¥3ä¸ªç­”æ¡ˆ                             â”‚
â”‚      â†“                                       â”‚
â”‚  ç‚¹å‡»"éªŒè¯ç­”æ¡ˆ"                              â”‚
â”‚      â†“                                       â”‚
â”‚  åç«¯éªŒè¯ç­”æ¡ˆï¼ˆbcryptå¯¹æ¯”ï¼‰                  â”‚
â”‚      â”œâ”€ ä»»ä¸€ç­”æ¡ˆé”™è¯¯ â†’ æç¤º"å®‰å…¨é—®é¢˜ç­”æ¡ˆé”™è¯¯"â”‚
â”‚      â””â”€ å…¨éƒ¨æ­£ç¡® â†’ ç”ŸæˆpasswordResetToken    â”‚
â”‚                    ï¼ˆ10åˆ†é’Ÿæœ‰æ•ˆï¼‰            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: è®¾ç½®æ–°å¯†ç                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·è¾“å…¥:                                   â”‚
â”‚  - æ–°å¯†ç ï¼ˆå¼ºåº¦éªŒè¯ï¼‰                        â”‚
â”‚  - ç¡®è®¤æ–°å¯†ç                                 â”‚
â”‚      â†“                                       â”‚
â”‚  ç‚¹å‡»"é‡ç½®å¯†ç "                              â”‚
â”‚      â†“                                       â”‚
â”‚  åç«¯å¤„ç†:                                   â”‚
â”‚  1. éªŒè¯passwordResetToken                   â”‚
â”‚  2. éªŒè¯å¯†ç å¼ºåº¦                             â”‚
â”‚  3. æ›´æ–°ç”¨æˆ·å¯†ç ï¼ˆbcryptåŠ å¯†ï¼‰               â”‚
â”‚  4. æ’¤é”€æ‰€æœ‰å·²æœ‰Tokenï¼ˆsessionsè¡¨ï¼‰          â”‚
â”‚  5. æ ‡è®°tempTokenä¸ºå·²ä½¿ç”¨                    â”‚
â”‚      â†“                                       â”‚
â”‚  æç¤º"å¯†ç é‡ç½®æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•"              â”‚
â”‚      â†“                                       â”‚
â”‚  è·³è½¬åˆ°ç™»å½•é¡µ                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 å‰ç«¯é¡µé¢è®¾è®¡

#### ForgotPasswordScreen.tsx - å¿˜è®°å¯†ç é¡µ

```typescript
export const ForgotPasswordScreen = ({ navigation }) => {
  const [step, setStep] = useState(1); // 1=èº«ä»½éªŒè¯, 2=å®‰å…¨é—®é¢˜, 3=è®¾ç½®æ–°å¯†ç 

  // Step 1 æ•°æ®
  const [fullName, setFullName] = useState('');
  const [phoneNumber, setPhoneNumber] = useState('');
  const [verifying, setVerifying] = useState(false);

  // Step 2 æ•°æ®
  const [username, setUsername] = useState(''); // æ˜¾ç¤ºç”¨æˆ·å
  const [securityQuestions, setSecurityQuestions] = useState([]);
  const [answer1, setAnswer1] = useState('');
  const [answer2, setAnswer2] = useState('');
  const [answer3, setAnswer3] = useState('');
  const [resetToken, setResetToken] = useState('');
  const [verifyingAnswers, setVerifyingAnswers] = useState(false);

  // Step 3 æ•°æ®
  const [newPassword, setNewPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [passwordResetToken, setPasswordResetToken] = useState('');
  const [resetting, setResetting] = useState(false);

  // === Step 1: éªŒè¯èº«ä»½ ===
  const handleVerifyIdentity = async () => {
    if (!fullName || !phoneNumber) {
      Alert.alert('æç¤º', 'è¯·è¾“å…¥çœŸå®å§“åå’Œæ‰‹æœºå·');
      return;
    }

    if (!/^1[3-9]\d{9}$/.test(phoneNumber)) {
      Alert.alert('æç¤º', 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®');
      return;
    }

    setVerifying(true);

    try {
      const result = await authService.verifyIdentity({
        fullName,
        phoneNumber
      });

      if (result.success) {
        setUsername(result.username);
        setSecurityQuestions(result.securityQuestions);
        setResetToken(result.resetToken);
        setStep(2); // è¿›å…¥å®‰å…¨é—®é¢˜éªŒè¯
      } else {
        Alert.alert('æç¤º', result.message || 'ç”¨æˆ·ä¸å­˜åœ¨æˆ–ä¿¡æ¯ä¸åŒ¹é…');
      }
    } catch (error) {
      Alert.alert('é”™è¯¯', error.message || 'éªŒè¯å¤±è´¥');
    } finally {
      setVerifying(false);
    }
  };

  // === Step 2: éªŒè¯å®‰å…¨é—®é¢˜ ===
  const handleVerifyAnswers = async () => {
    if (!answer1 || !answer2 || !answer3) {
      Alert.alert('æç¤º', 'è¯·å›ç­”æ‰€æœ‰å®‰å…¨é—®é¢˜');
      return;
    }

    setVerifyingAnswers(true);

    try {
      const result = await authService.verifySecurityAnswers({
        resetToken,
        answers: [answer1, answer2, answer3]
      });

      if (result.success) {
        setPasswordResetToken(result.passwordResetToken);
        setStep(3); // è¿›å…¥è®¾ç½®æ–°å¯†ç 
      } else {
        Alert.alert('æç¤º', result.message || 'å®‰å…¨é—®é¢˜ç­”æ¡ˆé”™è¯¯');
      }
    } catch (error) {
      Alert.alert('é”™è¯¯', error.message || 'éªŒè¯å¤±è´¥');
    } finally {
      setVerifyingAnswers(false);
    }
  };

  // === Step 3: é‡ç½®å¯†ç  ===
  const handleResetPassword = async () => {
    if (!newPassword || !confirmPassword) {
      Alert.alert('æç¤º', 'è¯·è¾“å…¥æ–°å¯†ç ');
      return;
    }

    if (newPassword !== confirmPassword) {
      Alert.alert('æç¤º', 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
      return;
    }

    // å¯†ç å¼ºåº¦éªŒè¯
    const strength = calculatePasswordStrength(newPassword);
    if (strength < 75) {
      Alert.alert('æç¤º', 'å¯†ç å¼ºåº¦ä¸è¶³ï¼Œè¯·åŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—ï¼Œè‡³å°‘8ä½');
      return;
    }

    setResetting(true);

    try {
      const result = await authService.resetPassword({
        passwordResetToken,
        newPassword,
        confirmPassword
      });

      if (result.success) {
        Alert.alert('æˆåŠŸ', 'å¯†ç é‡ç½®æˆåŠŸï¼Œè¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•', [
          {
            text: 'å»ç™»å½•',
            onPress: () => navigation.navigate('Login')
          }
        ]);
      }
    } catch (error) {
      Alert.alert('é”™è¯¯', error.message || 'é‡ç½®å¯†ç å¤±è´¥');
    } finally {
      setResetting(false);
    }
  };

  return (
    <KeyboardAvoidingView style={styles.container}>
      <ScrollView>
        {/* æ­¥éª¤æŒ‡ç¤ºå™¨ */}
        <View style={styles.stepIndicator}>
          <StepDot active={step >= 1} completed={step > 1} label="1" />
          <StepLine completed={step > 1} />
          <StepDot active={step >= 2} completed={step > 2} label="2" />
          <StepLine completed={step > 2} />
          <StepDot active={step >= 3} completed={false} label="3" />
        </View>

        {/* Step 1: èº«ä»½éªŒè¯ */}
        {step === 1 && (
          <View style={styles.section}>
            <Text style={styles.title}>æ‰¾å›å¯†ç </Text>
            <Text style={styles.subtitle}>è¯·è¾“å…¥æ³¨å†Œæ—¶çš„ä¿¡æ¯</Text>

            <TextInput
              style={styles.input}
              placeholder="çœŸå®å§“å"
              value={fullName}
              onChangeText={setFullName}
            />

            <TextInput
              style={styles.input}
              placeholder="æ‰‹æœºå·"
              keyboardType="phone-pad"
              maxLength={11}
              value={phoneNumber}
              onChangeText={setPhoneNumber}
            />

            <TouchableOpacity
              style={styles.button}
              onPress={handleVerifyIdentity}
              disabled={verifying}
            >
              {verifying ? (
                <ActivityIndicator color="#fff" />
              ) : (
                <Text style={styles.buttonText}>ä¸‹ä¸€æ­¥</Text>
              )}
            </TouchableOpacity>
          </View>
        )}

        {/* Step 2: å›ç­”å®‰å…¨é—®é¢˜ */}
        {step === 2 && (
          <View style={styles.section}>
            <Text style={styles.title}>å›ç­”å®‰å…¨é—®é¢˜</Text>
            <Text style={styles.subtitle}>
              ç”¨æˆ·å: {username}
            </Text>

            <View style={styles.questionBlock}>
              <Text style={styles.questionText}>
                é—®é¢˜1: {securityQuestions[0]}
              </Text>
              <TextInput
                style={styles.input}
                placeholder="è¯·è¾“å…¥ç­”æ¡ˆ"
                value={answer1}
                onChangeText={setAnswer1}
              />
            </View>

            <View style={styles.questionBlock}>
              <Text style={styles.questionText}>
                é—®é¢˜2: {securityQuestions[1]}
              </Text>
              <TextInput
                style={styles.input}
                placeholder="è¯·è¾“å…¥ç­”æ¡ˆ"
                value={answer2}
                onChangeText={setAnswer2}
              />
            </View>

            <View style={styles.questionBlock}>
              <Text style={styles.questionText}>
                é—®é¢˜3: {securityQuestions[2]}
              </Text>
              <TextInput
                style={styles.input}
                placeholder="è¯·è¾“å…¥ç­”æ¡ˆ"
                value={answer3}
                onChangeText={setAnswer3}
              />
            </View>

            <TouchableOpacity
              style={styles.button}
              onPress={handleVerifyAnswers}
              disabled={verifyingAnswers}
            >
              {verifyingAnswers ? (
                <ActivityIndicator color="#fff" />
              ) : (
                <Text style={styles.buttonText}>éªŒè¯ç­”æ¡ˆ</Text>
              )}
            </TouchableOpacity>

            <TouchableOpacity
              style={styles.backButton}
              onPress={() => setStep(1)}
            >
              <Text style={styles.backButtonText}>è¿”å›ä¸Šä¸€æ­¥</Text>
            </TouchableOpacity>
          </View>
        )}

        {/* Step 3: è®¾ç½®æ–°å¯†ç  */}
        {step === 3 && (
          <View style={styles.section}>
            <Text style={styles.title}>è®¾ç½®æ–°å¯†ç </Text>

            <TextInput
              style={styles.input}
              placeholder="æ–°å¯†ç ï¼ˆè‡³å°‘8ä½ï¼‰"
              secureTextEntry
              value={newPassword}
              onChangeText={setNewPassword}
            />

            {/* å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨ */}
            <PasswordStrengthIndicator password={newPassword} />

            <TextInput
              style={styles.input}
              placeholder="ç¡®è®¤æ–°å¯†ç "
              secureTextEntry
              value={confirmPassword}
              onChangeText={setConfirmPassword}
            />

            <TouchableOpacity
              style={styles.button}
              onPress={handleResetPassword}
              disabled={resetting}
            >
              {resetting ? (
                <ActivityIndicator color="#fff" />
              ) : (
                <Text style={styles.buttonText}>é‡ç½®å¯†ç </Text>
              )}
            </TouchableOpacity>
          </View>
        )}
      </ScrollView>
    </KeyboardAvoidingView>
  );
};
```

### 5.4 åç«¯APIè®¾è®¡

```javascript
// 1. éªŒè¯èº«ä»½
POST /api/mobile/auth/verify-identity
{
  fullName: "å¼ ä¸‰",
  phoneNumber: "13800138000"
}

å“åº”:
{
  success: true,
  userId: 123,
  username: "FAC001_8000_AB",  // è¿”å›ç”¨æˆ·åï¼Œæé†’ç”¨æˆ·
  securityQuestions: [
    "æ‚¨æ¯äº²çš„å§“åæ˜¯ä»€ä¹ˆï¼Ÿ",
    "æ‚¨å‡ºç”Ÿçš„åŸå¸‚æ˜¯å“ªé‡Œï¼Ÿ",
    "æ‚¨çš„å·¥å·æ˜¯å¤šå°‘ï¼Ÿ"
  ],
  resetToken: "temp_reset_abc123"  // 5åˆ†é’Ÿæœ‰æ•ˆ
}

// 2. éªŒè¯å®‰å…¨é—®é¢˜ç­”æ¡ˆ
POST /api/mobile/auth/verify-security-answers
{
  resetToken: "temp_reset_abc123",
  answers: ["ææ¢…", "åŒ—äº¬", "001"]
}

å“åº”:
{
  success: true,
  message: "éªŒè¯é€šè¿‡ï¼Œè¯·è®¾ç½®æ–°å¯†ç ",
  passwordResetToken: "pwd_reset_xyz789"  // 10åˆ†é’Ÿæœ‰æ•ˆ
}

// 3. é‡ç½®å¯†ç 
POST /api/mobile/auth/reset-password
{
  passwordResetToken: "pwd_reset_xyz789",
  newPassword: "NewPassword@123",
  confirmPassword: "NewPassword@123"
}

å“åº”:
{
  success: true,
  message: "å¯†ç é‡ç½®æˆåŠŸï¼Œè¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•"
}
```

#### Controllerå®ç°

```javascript
// backend/src/controllers/authController.js

/**
 * éªŒè¯èº«ä»½ï¼ˆçœŸå®å§“å+æ‰‹æœºå·ï¼‰
 */
export const verifyIdentity = async (req, res, next) => {
  try {
    const { fullName, phoneNumber } = req.body;

    // æŸ¥æ‰¾ç”¨æˆ·
    const user = await prisma.user.findFirst({
      where: {
        fullName,
        phone: phoneNumber,
        isActive: true  // åªèƒ½é‡ç½®å·²æ¿€æ´»ç”¨æˆ·çš„å¯†ç 
      }
    });

    if (!user) {
      throw new NotFoundError('ç”¨æˆ·ä¸å­˜åœ¨æˆ–ä¿¡æ¯ä¸åŒ¹é…');
    }

    // æŸ¥è¯¢å®‰å…¨é—®é¢˜
    const securityQuestions = await prisma.userSecurityQuestion.findUnique({
      where: { userId: user.id },
      select: {
        question1: true,
        question2: true,
        question3: true
        // æ³¨æ„ï¼šä¸è¿”å›ç­”æ¡ˆçš„Hash
      }
    });

    if (!securityQuestions) {
      throw new BusinessLogicError('è¯¥è´¦æˆ·æœªè®¾ç½®å®‰å…¨é—®é¢˜ï¼Œè¯·è”ç³»ç®¡ç†å‘˜é‡ç½®å¯†ç ');
    }

    // ç”Ÿæˆä¸´æ—¶é‡ç½®tokenï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆï¼‰
    const resetToken = await generateTempToken(
      'PASSWORD_RESET',
      user.factoryId,
      phoneNumber,
      { userId: user.id },
      5 // 5åˆ†é’Ÿ
    );

    res.json(createSuccessResponse({
      userId: user.id,
      username: user.username,
      securityQuestions: [
        securityQuestions.question1,
        securityQuestions.question2,
        securityQuestions.question3
      ],
      resetToken
    }, 'èº«ä»½éªŒè¯æˆåŠŸ'));
  } catch (error) {
    next(error);
  }
};

/**
 * éªŒè¯å®‰å…¨é—®é¢˜ç­”æ¡ˆ
 */
export const verifySecurityAnswers = async (req, res, next) => {
  try {
    const { resetToken, answers } = req.body;

    // éªŒè¯answersæ˜¯æ•°ç»„ä¸”æœ‰3ä¸ªå…ƒç´ 
    if (!Array.isArray(answers) || answers.length !== 3) {
      throw new ValidationError('è¯·å›ç­”æ‰€æœ‰å®‰å…¨é—®é¢˜');
    }

    // éªŒè¯resetToken
    const tokenData = await verifyAndUseTempToken(resetToken, 'PASSWORD_RESET');
    const userId = tokenData.data.userId;

    // è·å–å®‰å…¨é—®é¢˜è®°å½•
    const securityQuestions = await prisma.userSecurityQuestion.findUnique({
      where: { userId }
    });

    if (!securityQuestions) {
      throw new NotFoundError('å®‰å…¨é—®é¢˜è®°å½•ä¸å­˜åœ¨');
    }

    // éªŒè¯3ä¸ªç­”æ¡ˆï¼ˆbcryptå¯¹æ¯”ï¼‰
    const isAnswer1Valid = await verifyPassword(answers[0], securityQuestions.answer1Hash);
    const isAnswer2Valid = await verifyPassword(answers[1], securityQuestions.answer2Hash);
    const isAnswer3Valid = await verifyPassword(answers[2], securityQuestions.answer3Hash);

    if (!isAnswer1Valid || !isAnswer2Valid || !isAnswer3Valid) {
      throw new AuthenticationError('å®‰å…¨é—®é¢˜ç­”æ¡ˆé”™è¯¯');
    }

    // ç”Ÿæˆå¯†ç é‡ç½®tokenï¼ˆ10åˆ†é’Ÿæœ‰æ•ˆï¼‰
    const passwordResetToken = await generateTempToken(
      'PASSWORD_RESET_VERIFIED',
      tokenData.factoryId,
      tokenData.phoneNumber,
      { userId },
      10 // 10åˆ†é’Ÿ
    );

    res.json(createSuccessResponse({
      passwordResetToken
    }, 'éªŒè¯é€šè¿‡ï¼Œè¯·è®¾ç½®æ–°å¯†ç '));
  } catch (error) {
    next(error);
  }
};

/**
 * é‡ç½®å¯†ç 
 */
export const resetPassword = async (req, res, next) => {
  try {
    const { passwordResetToken, newPassword, confirmPassword } = req.body;

    // éªŒè¯å¯†ç ä¸€è‡´æ€§
    if (newPassword !== confirmPassword) {
      throw new ValidationError('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
    }

    // éªŒè¯å¯†ç å¼ºåº¦
    const validation = validatePasswordStrength(newPassword);
    if (!validation.isValid) {
      throw new ValidationError(validation.errors.join('ï¼›'));
    }

    // éªŒè¯resetToken
    const tokenData = await verifyAndUseTempToken(passwordResetToken, 'PASSWORD_RESET_VERIFIED');
    const userId = tokenData.data.userId;

    // æ›´æ–°å¯†ç 
    const newPasswordHash = await hashPassword(newPassword);
    await prisma.user.update({
      where: { id: userId },
      data: { passwordHash: newPasswordHash }
    });

    // æ’¤é”€è¯¥ç”¨æˆ·æ‰€æœ‰å·²æœ‰çš„tokenï¼ˆå¼ºåˆ¶é‡æ–°ç™»å½•ï¼‰
    await revokeUserTokens(userId, tokenData.factoryId);

    res.json(createSuccessResponse(null, 'å¯†ç é‡ç½®æˆåŠŸï¼Œè¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•'));
  } catch (error) {
    next(error);
  }
};
```

---

## æ•°æ®åº“è®¾è®¡

### 6.1 æ–°å¢æ•°æ®è¡¨

#### user_security_questions - ç”¨æˆ·å®‰å…¨é—®é¢˜è¡¨

```sql
CREATE TABLE user_security_questions (
  id VARCHAR(36) PRIMARY KEY,
  user_id INT NOT NULL,

  -- å®‰å…¨é—®é¢˜1
  question_1 VARCHAR(500) NOT NULL,
  answer_1_hash VARCHAR(255) NOT NULL,  -- bcryptåŠ å¯†

  -- å®‰å…¨é—®é¢˜2
  question_2 VARCHAR(500) NOT NULL,
  answer_2_hash VARCHAR(255) NOT NULL,

  -- å®‰å…¨é—®é¢˜3
  question_3 VARCHAR(500) NOT NULL,
  answer_3_hash VARCHAR(255) NOT NULL,

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY unique_user_questions (user_id),
  INDEX idx_user (user_id)
);
```

**å­—æ®µè¯´æ˜**:
- `user_id`: å…³è”usersè¡¨
- `question_1/2/3`: å®‰å…¨é—®é¢˜æ–‡æœ¬
- `answer_1/2/3_hash`: ç­”æ¡ˆçš„bcrypt Hashï¼ˆä¸å­˜å‚¨æ˜æ–‡ï¼‰
- `created_at`: åˆ›å»ºæ—¶é—´
- `updated_at`: æ›´æ–°æ—¶é—´ï¼ˆç”¨æˆ·å¯ä»¥ä¿®æ”¹å®‰å…¨é—®é¢˜ï¼‰

**Prisma Schema**:

```prisma
model UserSecurityQuestion {
  id        String   @id @default(uuid())
  userId    Int      @unique @map("user_id")

  question1    String @map("question_1") @db.VarChar(500)
  answer1Hash  String @map("answer_1_hash")

  question2    String @map("question_2") @db.VarChar(500)
  answer2Hash  String @map("answer_2_hash")

  question3    String @map("question_3") @db.VarChar(500)
  answer3Hash  String @map("answer_3_hash")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_security_questions")
}
```

### 6.2 ä¿®æ”¹ç°æœ‰è¡¨

#### usersè¡¨ä¿®æ”¹

```sql
-- é‚®ç®±æ”¹ä¸ºå¯é€‰ï¼ˆä¸å¼ºåˆ¶è¦æ±‚ï¼‰
ALTER TABLE users MODIFY COLUMN email VARCHAR(255) NULL;
```

**Prisma Schemaä¿®æ”¹**:

```prisma
model User {
  // ...å…¶ä»–å­—æ®µ
  email        String?  // æ”¹ä¸ºå¯é€‰

  // æ–°å¢å…³è”
  securityQuestions UserSecurityQuestion?

  // ...
}
```

---

## APIæ¥å£è®¾è®¡

### 7.1 è®¤è¯ç›¸å…³APIæ±‡æ€»

#### ç™»å½•ç›¸å…³ï¼ˆ1ä¸ªæ¥å£ï¼‰

```javascript
POST /api/mobile/auth/unified-login
// ç»Ÿä¸€ç™»å½•æ¥å£ï¼ˆå¹³å°ç”¨æˆ·+å·¥å‚ç”¨æˆ·æ™ºèƒ½è¯†åˆ«ï¼‰
```

#### æ³¨å†Œç›¸å…³ï¼ˆ3ä¸ªæ¥å£ï¼‰

```javascript
POST /api/mobile/auth/check-whitelist
// æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦åœ¨ç™½åå•

POST /api/mobile/auth/preview-username
// é¢„è§ˆç”Ÿæˆçš„ç”¨æˆ·åï¼ˆè¾…åŠ©æ¥å£ï¼‰

POST /api/mobile/auth/register
// ç”¨æˆ·æ³¨å†Œï¼ˆå•æ¥å£å®Œæˆæ•´ä¸ªæµç¨‹ï¼‰
```

#### å¿˜è®°å¯†ç ç›¸å…³ï¼ˆ3ä¸ªæ¥å£ï¼‰

```javascript
POST /api/mobile/auth/verify-identity
// éªŒè¯èº«ä»½ï¼ˆçœŸå®å§“å+æ‰‹æœºå·ï¼‰

POST /api/mobile/auth/verify-security-answers
// éªŒè¯å®‰å…¨é—®é¢˜ç­”æ¡ˆ

POST /api/mobile/auth/reset-password
// é‡ç½®å¯†ç 
```

#### è¾…åŠ©æ¥å£ï¼ˆå·²æœ‰ï¼‰

```javascript
POST /api/mobile/auth/refresh-token
// åˆ·æ–°Token

POST /api/mobile/auth/logout
// ç™»å‡º

GET  /api/mobile/auth/profile
// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
```

### 7.2 å®Œæ•´APIæ–‡æ¡£

è¯¦è§ [backend/API_DOCUMENTATION.md](../../backend/API_DOCUMENTATION.md)

---

## å‰ç«¯é¡µé¢è®¾è®¡

### 8.1 é¡µé¢æ¸…å•

#### å·²æœ‰é¡µé¢ï¼ˆ1ä¸ªï¼‰:
- âœ… `EnhancedLoginScreen.tsx` - ç™»å½•é¡µé¢

#### éœ€è¦æ–°å»ºé¡µé¢ï¼ˆ2ä¸ªï¼‰:
- ğŸ†• `RegisterScreen.tsx` - æ³¨å†Œé¡µé¢
- ğŸ†• `ForgotPasswordScreen.tsx` - å¿˜è®°å¯†ç é¡µé¢

#### éœ€è¦åˆ é™¤çš„é¡µé¢:
- âŒ `RegisterPhaseOneScreen.tsx` - åˆ é™¤ï¼ˆæ”¹ä¸ºå•é¡µé¢æ³¨å†Œï¼‰
- âŒ `RegisterPhaseTwoScreen.tsx` - åˆ é™¤ï¼ˆæ”¹ä¸ºå•é¡µé¢æ³¨å†Œï¼‰
- âŒ `ActivationScreen.tsx` - åˆ é™¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

### 8.2 ç»„ä»¶åº“è®¾è®¡

#### é€šç”¨è¡¨å•ç»„ä»¶

```
frontend/CretasFoodTrace/src/components/auth/
â”œâ”€â”€ FormField.tsx                    # è¡¨å•å­—æ®µå®¹å™¨
â”œâ”€â”€ PhoneInput.tsx                   # æ‰‹æœºå·è¾“å…¥
â”œâ”€â”€ PasswordInput.tsx                # å¯†ç è¾“å…¥ï¼ˆå¸¦æ˜¾ç¤º/éšè—ï¼‰
â”œâ”€â”€ PasswordStrengthIndicator.tsx    # å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨
â”œâ”€â”€ SecurityQuestionPicker.tsx       # å®‰å…¨é—®é¢˜é€‰æ‹©å™¨
â”œâ”€â”€ StepIndicator.tsx                # æ­¥éª¤æŒ‡ç¤ºå™¨
â”œâ”€â”€ LoadingButton.tsx                # åŠ è½½æŒ‰é’®
â””â”€â”€ ErrorMessage.tsx                 # é”™è¯¯æ¶ˆæ¯ç»„ä»¶
```

**å¤ç”¨æ€§è®¾è®¡**:
- æ‰€æœ‰è¡¨å•ç»„ä»¶åœ¨ç™»å½•ã€æ³¨å†Œã€é‡ç½®å¯†ç é¡µé¢ä¸­å¤ç”¨
- ç»Ÿä¸€çš„æ ·å¼å’Œäº¤äº’é€»è¾‘
- ç»Ÿä¸€çš„éªŒè¯è§„åˆ™

---

## å®æ–½è®¡åˆ’

### 9.1 æ—¶é—´è§„åˆ’ï¼ˆ4å‘¨ï¼‰

#### Week 1: æ¸…ç†Mockä»£ç  + æƒé™æ¢³ç†

**Day 1-2**: æ¸…ç†Mockä»£ç 
- [ ] åˆ é™¤ `backend/src/routes/mobile.js` ç¬¬60-114è¡Œï¼ˆMockç™»å½•ï¼‰
- [ ] ä¼˜åŒ– `backend/src/controllers/activationController.js`ï¼ˆä»æ•°æ®åº“è¯»å–æ¿€æ´»ç ï¼‰
- [ ] åˆ é™¤ `frontend/src/services/biometricManager.ts`ï¼ˆç”Ÿç‰©è¯†åˆ«ç›¸å…³ï¼‰
- [ ] åˆ é™¤ `frontend/src/hooks/useLogin.ts` ä¸­çš„ç”Ÿç‰©è¯†åˆ«é€»è¾‘

**Day 3-5**: æƒé™æ¢³ç†ä¸æ–‡æ¡£
- [ ] åˆ›å»º `docs/prd/è§’è‰²æƒé™å®Œæ•´æ¸…å•.md`
- [ ] å®Œå–„ `backend/src/config/permissions.js`
- [ ] åˆ›å»º `backend/src/services/permissionCache.js`ï¼ˆæƒé™ç¼“å­˜ï¼‰
- [ ] æµ‹è¯•æ‰€æœ‰è§’è‰²çš„æƒé™é…ç½®

**äº¤ä»˜ç‰©**:
- æ¸…ç†åçš„ä»£ç ï¼ˆæ— Mockæ®‹ç•™ï¼‰
- è§’è‰²æƒé™å®Œæ•´æ¸…å•æ–‡æ¡£

---

#### Week 2: æ³¨å†Œé¡µé¢å¼€å‘

**Day 1-2**: åç«¯APIå¼€å‘
- [ ] åˆ›å»º `backend/src/utils/usernameGenerator.js`
- [ ] å®ç° `registerUser()` controller
- [ ] å®ç°ç™½åå•æ£€æŸ¥ä¼˜åŒ–
- [ ] æ·»åŠ ç”¨æˆ·åé¢„è§ˆæ¥å£

**Day 3-4**: å‰ç«¯é¡µé¢å¼€å‘
- [ ] åˆ›å»º `RegisterScreen.tsx`
- [ ] åˆ›å»ºè¡¨å•ç»„ä»¶ï¼ˆPhoneInput, PasswordInputç­‰ï¼‰
- [ ] å®ç°è¡¨å•éªŒè¯é€»è¾‘
- [ ] å®ç°å®‰å…¨é—®é¢˜é€‰æ‹©

**Day 5**: æµ‹è¯•ä¸ä¼˜åŒ–
- [ ] æµ‹è¯•æ³¨å†Œæµç¨‹
- [ ] ä¼˜åŒ–UI/UX
- [ ] Bugä¿®å¤

**äº¤ä»˜ç‰©**:
- `RegisterScreen.tsx`ï¼ˆå®Œæ•´æ³¨å†Œé¡µé¢ï¼‰
- è¡¨å•ç»„ä»¶åº“
- æ³¨å†ŒAPI

---

#### Week 3: å¿˜è®°å¯†ç åŠŸèƒ½

**Day 1-2**: åç«¯APIå¼€å‘
- [ ] å®ç° `verifyIdentity()` controller
- [ ] å®ç° `verifySecurityAnswers()` controller
- [ ] å®ç° `resetPassword()` controller
- [ ] æ·»åŠ ä¸´æ—¶tokenç®¡ç†ï¼ˆPASSWORD_RESETç±»å‹ï¼‰

**Day 3**: æ•°æ®åº“è¿ç§»
- [ ] æ·»åŠ  `UserSecurityQuestion` æ¨¡å‹åˆ°schema.prisma
- [ ] è¿è¡Œæ•°æ®åº“è¿ç§»
- [ ] ä¸ºç°æœ‰ç”¨æˆ·ç”Ÿæˆé»˜è®¤å®‰å…¨é—®é¢˜ï¼ˆæ•°æ®è¿ç§»è„šæœ¬ï¼‰

**Day 4**: å‰ç«¯é¡µé¢å¼€å‘
- [ ] åˆ›å»º `ForgotPasswordScreen.tsx`
- [ ] å®ç°3æ­¥æµç¨‹ï¼ˆèº«ä»½éªŒè¯ â†’ å®‰å…¨é—®é¢˜ â†’ æ–°å¯†ç ï¼‰
- [ ] åˆ›å»ºStepIndicatorç»„ä»¶

**Day 5**: æµ‹è¯•ä¸ä¼˜åŒ–
- [ ] æµ‹è¯•å®Œæ•´æµç¨‹
- [ ] æµ‹è¯•é”™è¯¯åœºæ™¯
- [ ] Bugä¿®å¤

**äº¤ä»˜ç‰©**:
- `ForgotPasswordScreen.tsx`
- å¿˜è®°å¯†ç APIï¼ˆ3ä¸ªæ¥å£ï¼‰
- æ•°æ®åº“è¿ç§»è„šæœ¬

---

#### Week 4: ç”¨æˆ·ä½“éªŒä¼˜åŒ–

**Day 1-2**: ç™»å½•ä½“éªŒä¼˜åŒ–
- [ ] ä¼˜åŒ–é”™è¯¯æç¤ºï¼ˆ10ç§é”™è¯¯åœºæ™¯ï¼‰
- [ ] æ·»åŠ åŠ è½½åŠ¨ç”»
- [ ] ä¼˜åŒ–è‡ªåŠ¨ç™»å½•é€»è¾‘
- [ ] æ·»åŠ "è®°ä½å¯†ç "åŠŸèƒ½ï¼ˆæœ¬åœ°å­˜å‚¨ç”¨æˆ·åï¼‰

**Day 3**: æ³¨å†Œä½“éªŒä¼˜åŒ–
- [ ] å®æ—¶è¡¨å•éªŒè¯
- [ ] å¯†ç å¼ºåº¦å¯è§†åŒ–
- [ ] å®‰å…¨é—®é¢˜ä¸é‡å¤æ ¡éªŒ
- [ ] ä¼˜åŒ–ç”¨æˆ·å¼•å¯¼

**Day 4**: å¿˜è®°å¯†ç ä½“éªŒä¼˜åŒ–
- [ ] æ­¥éª¤æŒ‡ç¤ºå™¨ä¼˜åŒ–
- [ ] æ”¯æŒè¿”å›ä¸Šä¸€æ­¥
- [ ] å‹å¥½çš„é”™è¯¯æç¤º

**Day 5**: æ•´ä½“æµ‹è¯•
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆç™»å½•ã€æ³¨å†Œã€é‡ç½®å¯†ç ï¼‰
- [ ] æƒé™æµ‹è¯•ï¼ˆ7ä¸ªè§’è‰²ï¼‰
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] Bugä¿®å¤

**äº¤ä»˜ç‰©**:
- ä¼˜åŒ–åçš„æ‰€æœ‰è®¤è¯é¡µé¢
- å®Œæ•´æµ‹è¯•æŠ¥å‘Š

---

### 9.2 äººåŠ›éœ€æ±‚

| è§’è‰² | å·¥ä½œé‡ | è¯´æ˜ |
|-----|-------|------|
| åç«¯å¼€å‘ | 2äººå‘¨ | APIå¼€å‘ã€æ•°æ®åº“è¿ç§» |
| å‰ç«¯å¼€å‘ | 4äººå‘¨ | é¡µé¢å¼€å‘ã€ç»„ä»¶å¼€å‘ |
| UIè®¾è®¡ | 0.6äººå‘¨ | æ³¨å†Œé¡µé¢ã€å¿˜è®°å¯†ç é¡µé¢è®¾è®¡ |
| æµ‹è¯• | 1äººå‘¨ | åŠŸèƒ½æµ‹è¯•ã€å›å½’æµ‹è¯• |

**æ€»è®¡**: 7.6äººå‘¨

---

## éªŒæ”¶æ ‡å‡†

### 10.1 åŠŸèƒ½å®Œæ•´æ€§

#### å¿…é¡»å®Œæˆçš„åŠŸèƒ½:
- [ ] ç»Ÿä¸€ç™»å½•å¯ç”¨ï¼ˆå¹³å°+å·¥å‚ç”¨æˆ·ï¼‰
- [ ] 7ä¸ªè§’è‰²æƒé™æ¸…æ™°å®šä¹‰
- [ ] æ³¨å†Œæµç¨‹å®Œæ•´ï¼ˆç™½åå•æ£€æŸ¥ â†’ å¡«å†™ä¿¡æ¯ â†’ è‡ªåŠ¨ç™»å½•ï¼‰
- [ ] å¿˜è®°å¯†ç æµç¨‹å®Œæ•´ï¼ˆèº«ä»½éªŒè¯ â†’ å®‰å…¨é—®é¢˜ â†’ é‡ç½®å¯†ç ï¼‰
- [ ] æ‰€æœ‰Mockä»£ç å·²åˆ é™¤
- [ ] è‡ªåŠ¨ç”¨æˆ·åç”Ÿæˆå¯ç”¨
- [ ] å®‰å…¨é—®é¢˜éªŒè¯å¯ç”¨

#### å¿…é¡»åˆ é™¤çš„ä»£ç :
- [ ] Mockç™»å½•æ¥å£å·²åˆ é™¤
- [ ] ç”Ÿç‰©è¯†åˆ«ä»£ç å·²åˆ é™¤
- [ ] çŸ­ä¿¡éªŒè¯ç ä»£ç å·²åˆ é™¤
- [ ] ä¸¤é˜¶æ®µæ³¨å†Œæ—§ä»£ç å·²åˆ é™¤

---

### 10.2 ç”¨æˆ·ä½“éªŒ

#### ç™»å½•ä½“éªŒ:
- [ ] ç™»å½•æˆåŠŸç‡>99%
- [ ] é”™è¯¯æç¤ºå‹å¥½ï¼ˆ10ç§åœºæ™¯ï¼‰
- [ ] åŠ è½½çŠ¶æ€æ˜æ˜¾
- [ ] è‡ªåŠ¨ç™»å½•æµç•…
- [ ] å“åº”æ—¶é—´<2ç§’

#### æ³¨å†Œä½“éªŒ:
- [ ] æ³¨å†Œæµç¨‹æ¸…æ™°ï¼ˆ3æ­¥å¯è§†åŒ–ï¼‰
- [ ] è¡¨å•éªŒè¯å®æ—¶æç¤º
- [ ] å¯†ç å¼ºåº¦å¯è§†åŒ–
- [ ] ç”¨æˆ·åç”Ÿæˆé¢„è§ˆ
- [ ] å®Œæˆæ—¶é—´<3åˆ†é’Ÿ

#### é‡ç½®å¯†ç ä½“éªŒ:
- [ ] æ­¥éª¤æŒ‡ç¤ºå™¨æ¸…æ™°ï¼ˆ1/3, 2/3, 3/3ï¼‰
- [ ] å¯è¿”å›ä¸Šä¸€æ­¥
- [ ] é”™è¯¯æç¤ºå‹å¥½
- [ ] å®‰å…¨é—®é¢˜ç­”æ¡ˆæç¤ºï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰

---

### 10.3 å®‰å…¨æ€§

#### å¯†ç å®‰å…¨:
- [ ] å¯†ç å¼ºåº¦éªŒè¯ï¼ˆè‡³å°‘8ä½ï¼Œå¤§å°å†™å­—æ¯+æ•°å­—ï¼‰
- [ ] å¯†ç bcryptåŠ å¯†ï¼ˆ12è½®ï¼‰
- [ ] é‡ç½®å¯†ç åæ’¤é”€æ‰€æœ‰æ—§Token

#### å®‰å…¨é—®é¢˜:
- [ ] ç­”æ¡ˆbcryptåŠ å¯†å­˜å‚¨
- [ ] 3ä¸ªé—®é¢˜ä¸èƒ½é‡å¤
- [ ] ç­”æ¡ˆä¸èƒ½ä¸ºç©ºï¼ˆè‡³å°‘2ä¸ªå­—ç¬¦ï¼‰

#### Tokenå®‰å…¨:
- [ ] accessTokenæœ‰æ•ˆæœŸ24å°æ—¶
- [ ] refreshTokenæœ‰æ•ˆæœŸ7å¤©
- [ ] ä¸´æ—¶tokenæœ‰æ•ˆæœŸ5-10åˆ†é’Ÿ
- [ ] Tokenå­˜å‚¨åœ¨SecureStore

#### é˜²æš´åŠ›ç ´è§£:
- [ ] ç™»å½•å¤±è´¥5æ¬¡é”å®š30åˆ†é’Ÿï¼ˆå¾…å®ç°ï¼‰
- [ ] å®‰å…¨é—®é¢˜ç­”æ¡ˆé”™è¯¯3æ¬¡é”å®šï¼ˆå¾…å®ç°ï¼‰
- [ ] ä¸´æ—¶tokenè¿‡æœŸè‡ªåŠ¨å¤±æ•ˆ

---

### 10.4 æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|-----|-------|------|
| ç™»å½•å“åº”æ—¶é—´ | <2ç§’ | ä»ç‚¹å‡»ç™»å½•åˆ°è¿”å›ç»“æœ |
| æ³¨å†Œå“åº”æ—¶é—´ | <3ç§’ | ä»æäº¤æ³¨å†Œåˆ°è‡ªåŠ¨ç™»å½• |
| ç™½åå•æ£€æŸ¥ | <1ç§’ | æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦åœ¨ç™½åå• |
| æƒé™æ£€æŸ¥ | <100ms | ä½¿ç”¨ç¼“å­˜åçš„æƒé™éªŒè¯ |
| Tokenåˆ·æ–° | <1ç§’ | refreshTokenæ¢å–æ–°accessToken |

---

### 10.5 ä»£ç è´¨é‡

#### ä»£ç è§„èŒƒ:
- [ ] TypeScriptç±»å‹å®Œæ•´ï¼ˆå‰ç«¯ï¼‰
- [ ] å‡½æ•°æ³¨é‡Šå®Œæ•´ï¼ˆåç«¯ï¼‰
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] æ— console.logæ®‹ç•™

#### æµ‹è¯•è¦†ç›–:
- [ ] å•å…ƒæµ‹è¯•>80%è¦†ç›–ç‡
- [ ] é›†æˆæµ‹è¯•è¦†ç›–ä¸»è¦æµç¨‹
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•è¦†ç›–å®Œæ•´ä¸šåŠ¡æµç¨‹

---

## é™„å½•

### A. é¢„è®¾å®‰å…¨é—®é¢˜åº“

```javascript
// frontend/src/constants/securityQuestions.ts
export const SECURITY_QUESTIONS = [
  { id: 1, question: 'æ‚¨æ¯äº²çš„å§“åæ˜¯ä»€ä¹ˆï¼Ÿ', category: 'family' },
  { id: 2, question: 'æ‚¨å‡ºç”Ÿçš„åŸå¸‚æ˜¯å“ªé‡Œï¼Ÿ', category: 'personal' },
  { id: 3, question: 'æ‚¨å°å­¦ç­ä¸»ä»»çš„å§“åæ˜¯ä»€ä¹ˆï¼Ÿ', category: 'education' },
  { id: 4, question: 'æ‚¨æœ€å–œæ¬¢çš„é£Ÿç‰©æ˜¯ä»€ä¹ˆï¼Ÿ', category: 'preference' },
  { id: 5, question: 'æ‚¨çš„ç¬¬ä¸€ä¸ªå® ç‰©å«ä»€ä¹ˆåå­—ï¼Ÿ', category: 'personal' },
  { id: 6, question: 'æ‚¨é…å¶çš„ç”Ÿæ—¥æ˜¯å‡ æœˆå‡ å·ï¼Ÿ', category: 'family' },
  { id: 7, question: 'æ‚¨çš„å·¥å·æ˜¯å¤šå°‘ï¼Ÿ', category: 'work' },
  { id: 8, question: 'æ‚¨å…¥èŒçš„å¹´ä»½æ˜¯å“ªä¸€å¹´ï¼Ÿ', category: 'work' },
  { id: 9, question: 'æ‚¨æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯ä»€ä¹ˆï¼Ÿ', category: 'preference' },
  { id: 10, question: 'æ‚¨çš„èº«ä»½è¯å6ä½æ˜¯ä»€ä¹ˆï¼Ÿ', category: 'personal' }
];
```

### B. é”™è¯¯ç å®šä¹‰

```javascript
// backend/src/constants/errorCodes.js
export const AUTH_ERROR_CODES = {
  INVALID_CREDENTIALS: {
    code: 'INVALID_CREDENTIALS',
    message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯',
    httpStatus: 401
  },
  USER_NOT_FOUND: {
    code: 'USER_NOT_FOUND',
    message: 'ç”¨æˆ·ä¸å­˜åœ¨',
    httpStatus: 404
  },
  WRONG_PASSWORD: {
    code: 'WRONG_PASSWORD',
    message: 'å¯†ç é”™è¯¯',
    httpStatus: 401
  },
  ACCOUNT_NOT_ACTIVATED: {
    code: 'ACCOUNT_NOT_ACTIVATED',
    message: 'è´¦å·æœªæ¿€æ´»ï¼Œè¯·è”ç³»ç®¡ç†å‘˜',
    httpStatus: 403
  },
  FACTORY_DISABLED: {
    code: 'FACTORY_DISABLED',
    message: 'æ‰€å±å·¥å‚å·²åœç”¨',
    httpStatus: 403
  },
  WHITELIST_NOT_FOUND: {
    code: 'WHITELIST_NOT_FOUND',
    message: 'æ‰‹æœºå·æœªåœ¨ç™½åå•ä¸­',
    httpStatus: 403
  },
  PHONE_ALREADY_REGISTERED: {
    code: 'PHONE_ALREADY_REGISTERED',
    message: 'è¯¥æ‰‹æœºå·å·²è¢«æ³¨å†Œ',
    httpStatus: 409
  },
  SECURITY_ANSWER_WRONG: {
    code: 'SECURITY_ANSWER_WRONG',
    message: 'å®‰å…¨é—®é¢˜ç­”æ¡ˆé”™è¯¯',
    httpStatus: 401
  },
  PASSWORD_STRENGTH_LOW: {
    code: 'PASSWORD_STRENGTH_LOW',
    message: 'å¯†ç å¼ºåº¦ä¸è¶³',
    httpStatus: 400
  },
  TOKEN_EXPIRED: {
    code: 'TOKEN_EXPIRED',
    message: 'Tokenå·²è¿‡æœŸ',
    httpStatus: 401
  }
};
```

### C. æ•°æ®è¿ç§»è„šæœ¬

```javascript
// backend/scripts/migrate-security-questions.js
// ä¸ºç°æœ‰ç”¨æˆ·ç”Ÿæˆé»˜è®¤å®‰å…¨é—®é¢˜

import { PrismaClient } from '@prisma/client';
import { hashPassword } from '../src/utils/password.js';

const prisma = new PrismaClient();

async function migrateSecurityQuestions() {
  // æŸ¥æ‰¾æ²¡æœ‰å®‰å…¨é—®é¢˜çš„ç”¨æˆ·
  const usersWithoutQuestions = await prisma.user.findMany({
    where: {
      securityQuestions: null
    }
  });

  console.log(`æ‰¾åˆ°${usersWithoutQuestions.length}ä¸ªç”¨æˆ·éœ€è¦è®¾ç½®é»˜è®¤å®‰å…¨é—®é¢˜`);

  for (const user of usersWithoutQuestions) {
    // ç”Ÿæˆé»˜è®¤å®‰å…¨é—®é¢˜ï¼ˆä½¿ç”¨ç”¨æˆ·ä¿¡æ¯ï¼‰
    const defaultAnswer = `${user.fullName}_${user.id}`;
    const answerHash = await hashPassword(defaultAnswer);

    await prisma.userSecurityQuestion.create({
      data: {
        userId: user.id,
        question1: 'æ‚¨æ¯äº²çš„å§“åæ˜¯ä»€ä¹ˆï¼Ÿ',
        answer1Hash: answerHash,
        question2: 'æ‚¨å‡ºç”Ÿçš„åŸå¸‚æ˜¯å“ªé‡Œï¼Ÿ',
        answer2Hash: answerHash,
        question3: 'æ‚¨çš„å·¥å·æ˜¯å¤šå°‘ï¼Ÿ',
        answer3Hash: answerHash
      }
    });

    console.log(`å·²ä¸ºç”¨æˆ· ${user.username} è®¾ç½®é»˜è®¤å®‰å…¨é—®é¢˜`);
  }

  console.log('è¿ç§»å®Œæˆ');
}

migrateSecurityQuestions().catch(console.error).finally(() => prisma.$disconnect());
```

---

**æ–‡æ¡£ç»“æŸ**

*æ­¤æ–‡æ¡£ä¸ºç™½å©çºªé£Ÿå“æº¯æºç³»ç»Ÿè®¤è¯æ¨¡å—çš„å®Œæ•´è§„åˆ’ï¼ŒåŒ…å«æ‰€æœ‰ç»†èŠ‚å’Œå®æ–½æ­¥éª¤*
