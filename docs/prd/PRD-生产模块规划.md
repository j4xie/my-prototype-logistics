# 白垩纪食品溯源系统 - 生产模块功能规划

**文档版本**: v2.0
**创建日期**: 2025-01-05
**文档类型**: 功能需求文档(PRD)
**实施周期**: 4-6周

---

## 📋 目录

1. [生产模块概述](#生产模块概述)
2. [业务流程分析](#业务流程分析)
3. [功能模块详细设计](#功能模块详细设计)
4. [前端页面设计](#前端页面设计)
5. [页面跳转关系](#页面跳转关系)
6. [与其他模块的协作](#与其他模块的协作)
7. [优化方向与实施计划](#优化方向与实施计划)
8. [验收标准](#验收标准)

---

## 生产模块概述

### 1.1 系统定位

生产模块是白垩纪食品溯源系统的**核心业务模块**,负责管理从原材料接收到成品产出的完整生产流程。

**设计理念**:
- 🎯 **流程完整**: 覆盖生产全生命周期(原料→生产→质检→成本→追溯)
- 📊 **数据驱动**: 实时记录生产数据,支持成本核算和智能分析
- 🔗 **协同工作**: 与员工管理、设备监控、仓储等模块深度集成
- 💰 **成本可控**: 精细化成本核算,AI智能优化建议
- 📱 **移动优先**: 优化移动端操作体验,支持离线功能

### 1.2 核心功能清单

生产模块包含**8大子模块**,**31个前端页面**:

| 子模块 | 页面数 | 完成度 | 核心功能 |
|-------|-------|--------|---------|
| **批次管理** | 5页 | 20% | 批次CRUD、状态流转、时间线追踪 |
| **✅ 生产计划管理** | 1页 | **100%** | 生产计划CRUD、智能预估、库存管理、流程控制 |
| **🆕 商家管理** | 1页 | 0% | 商家信息、供货历史 |
| **🆕 产品与原料配置** | 2页 | 0% | 产品类型、原料类型、转换率配置 |
| **质量检验** | 4页 | 0% | 三阶段质检、质检统计、趋势分析 |
| **员工工作** | 3页 | 67% | 打卡、工时统计、工作记录 |
| **设备监控** | 4页 | 0% | 实时监控、告警管理、维护记录 |
| **成本核算** | 3页 | 33% | 成本计算、AI分析、趋势对比 |
| **生产仪表板** | 2页 | 50% | 生产概览、关键指标、数据导出 |
| **数据导出** | 1页 | 0% | 报表生成、数据导出 |
| **总计** | **26页** | **27%** | - |

**总体完成度**: **约35%** (后端100%完成,前端生产计划管理已完成)

### 1.3 当前状态评估

**✅ 已完成**:
- 后端业务逻辑和接口完善
- 数据库表结构设计完成
- 5个前端页面完整功能:
  - **ProductionPlanManagementScreen** (生产计划管理) ⭐ **新完成**
  - MaterialReceiptScreen (原料接收)
  - TimeClockScreen (员工打卡)
  - ClockHistoryScreen (打卡历史)
  - CostAnalysisDashboard (成本仪表板)

**❌ 待开发**:
- 18个前端页面(占总页面数82%)
  - 批次管理5页全部待开发
  - 质检管理4页全部待开发
  - 设备监控4页全部待开发
  - 成本分析2页待开发
  - 其他3页待开发
- DeepSeek AI真实集成(当前使用Mock数据)
- 离线功能支持
- 性能优化

**核心问题**:
- 前端UI严重缺失,用户无法完整使用生产功能
- 最关键的批次管理页面(批次列表、批次详情、批次创建)全部缺失
- 质检录入页面缺失,无法进行质量管理
- 设备监控页面缺失,无法实时查看设备状态

---

## 业务流程分析

### 2.1 完整生产业务线

生产模块覆盖**两大核心流程**,从原材料到成品交付的全过程管理:

#### ✅ 流程A: 生产计划管理流程 **已完成 (2025-10-06)**

```
原料入库 → 创建生产计划 → 预估原料用量 → 生产执行 →
记录原料消耗 → 成品称重 → 质检 → 成品出库 → 商家交付
```

**适用场景**: 按订单生产,需要明确产品类型、产量目标和交付商家

**完成状态**: ✅ 100%
- 前端: ProductionPlanManagementScreen (839行)
- 后端: 10个完整API端点 (738行)
- API客户端: 3个新文件 (productionPlanApiClient, productTypeApiClient, merchantApiClient)
- 功能: 完整的生产计划CRUD、智能预估原料、库存管理、状态流转

**权限配置**:
- platform_admin: 👁️ 只读 (可以查看,不能修改)
- super_admin: ✅ 完全权限
- dept_admin: ✅ 完全权限 (目前与super_admin相同)
- operator: ❌ 不访问 (主要用于打卡和工作报告)

**访问路径**: 首页 → 管理Tab → 生产计划管理

#### 流程B: 批次加工流程 (现有)

```
原料接收 → 原料质检(可选) → 批次创建 → 员工打卡 → 设备启用 →
开始生产 → 过程质检 → 完成生产 → 成品质检 → 设备停用 →
员工下班 → 成本核算 → AI分析(可选) → 数据归档
```

**适用场景**: 通用批次生产,关注生产过程追溯和成本核算

---

### 2.2 🆕 流程A详细说明: 生产计划管理流程

#### 步骤A1: 原料入库

**操作人员**: 仓库管理员
**使用页面**: MaterialReceiptScreen (✅ 已完成)
**操作内容**:
- 录入原材料类型(从原料类型字典选择,如:鲈鱼、带鱼、三文鱼)
- 录入入库重量(单位:kg)
- 录入采购成本(单位:元/kg)
- 录入供应商信息
- 系统自动创建批次记录,生成批次号
- 原料状态设置为"待使用"

**业务意义**: 建立原料库存,记录原料来源,为后续生产计划提供可用库存数据

#### 步骤A2: 创建生产计划 ✅ **已完成**

**操作人员**: 生产部门主管/管理员(factory_super_admin, department_admin)
**使用页面**: ProductionPlanManagementScreen ✅ **已完成**
**操作内容**:
1. **选择产品类型**:
   - 从产品类型列表中选择(如:鱼片、鱼头、鱼骨等)
   - 产品类型由管理员在"产品类型管理"中配置 ✅

2. **输入计划产量**:
   - 输入目标产量(单位:kg,必须>0)
   - 系统根据产品类型和原料类型,查询转换率配置
   - **自动计算预估原料用量** = 计划产量 / 转换率 × (1 + 损耗率)
   - 显示预估原料用量,供用户参考

3. **查看可用库存**:
   - 系统实时显示当前可用原料库存
   - 可用库存 = Σ(所有批次原料重量) - Σ(已消耗量)
   - 如果可用库存不足,给出警告提示

4. **选择目标商家**:
   - 从商家列表中选择交付目标
   - 商家信息需要事先在"商家管理"中配置
   - 显示商家基本信息(名称、联系方式、地址)

5. **填写备注**:
   - 可选填写生产计划备注信息

**系统自动操作**:
- 生成生产计划编号(格式:PLAN-20250105-001)
- 设置计划状态为"pending"(待生产)
- 记录创建人和创建时间
- 保存预估原料用量数据

**业务意义**: 明确生产目标,合理规划原料使用,确保库存充足,避免生产中断

#### 步骤A3: 生产执行

**操作人员**: 生产主管/操作员
**使用页面**: ProductionPlanDetailScreen (❌ 待开发)
**操作内容**:
1. 查看生产计划详情
2. 确认生产准备完成
3. 点击"开始生产"按钮
4. 系统更新计划状态为"in_progress"(生产中)

**业务意义**: 正式启动生产任务,进入生产执行阶段

#### 步骤A4: 记录原料消耗

**操作人员**: 生产操作员
**使用页面**: MaterialConsumptionScreen (❌ 待开发)
**操作内容**:
1. **选择批次**:
   - 从可用的原料批次中选择
   - 系统显示每个批次的剩余可用量
   - 支持从多个批次消耗原料(FIFO原则:先进先出)

2. **输入消耗量**:
   - 输入实际消耗的原料重量(单位:kg)
   - 系统验证消耗量不超过批次可用量
   - 自动更新批次剩余量

3. **保存消耗记录**:
   - 记录消耗时间、操作人、批次ID、消耗量
   - 关联到生产计划ID

**系统自动操作**:
- 更新批次可用库存
- 累计生产计划的实际原料用量
- 如果批次原料全部消耗完毕,标记批次为"已完全消耗"

**业务意义**: 精确追踪原料流向,支持批次溯源,准确计算原料成本

#### 步骤A5: 成品称重

**操作人员**: 质检员/生产主管
**使用页面**: ProductionPlanDetailScreen (❌ 待开发)
**操作内容**:
1. 生产完成后,对成品进行称重
2. 录入实际产量(单位:kg)
3. 系统计算实际转换率 = 实际产量 / 实际原料用量
4. 对比预估产量和实际产量,计算偏差率

**业务意义**: 验证生产效率,优化转换率配置,为后续生产提供参考数据

#### 步骤A6: 成品质检

**操作人员**: 质检员
**使用页面**: QualityInspectionCreateScreen (❌ 待开发)
**操作内容**:
- 选择质检类型:"成品质检"
- 进行感官检查、温度检测、微生物抽检
- 拍摄质检照片
- 判定质量等级:A级/B级/C级/不合格

**业务意义**: 确保成品质量,符合食品安全标准

#### 步骤A7: 成品出库

**操作人员**: 仓库管理员
**使用页面**: ShipmentRecordScreen (❌ 待开发)
**操作内容**:
1. **选择生产计划**:
   - 从已完成的生产计划中选择

2. **录入出库信息**:
   - 出库数量(kg)
   - 实际称重(kg)
   - 质量等级(引用质检结果)
   - 出库时间(自动记录)
   - 备注信息

3. **确认商家**:
   - 显示生产计划中指定的目标商家
   - 可修改实际交付商家(如果有变更)

4. **生成出库单**:
   - 系统生成出库单号(格式:SHIP-20250105-001)
   - 记录出库人、出库时间

**系统自动操作**:
- 更新生产计划状态为"shipped"(已出货)
- 创建商家供货历史记录
- 关联质检记录

**业务意义**: 完整记录成品流向,建立商家供货档案,支持全链路溯源

#### 步骤A8: 商家交付确认

**操作人员**: 物流部门/商家
**使用页面**: MerchantShipmentListScreen (❌ 待开发)
**操作内容**:
- 查看供货历史
- 商家确认收货
- 记录交付签收信息
- 可选:商家反馈(质量、时效性评价)

**业务意义**: 完成交付闭环,收集商家反馈,优化生产和物流流程

---

### 2.3 流程B详细说明: 批次加工流程 (现有)

#### 步骤1: 原材料接收

**操作人员**: 接收部门操作员
**使用页面**: MaterialReceiptScreen (✅ 已完成)
**操作内容**:
- 录入原材料类型(鲈鱼、带鱼、三文鱼等)
- 录入原材料重量(单位:kg)
- 录入原材料成本(单位:元,来自采购单)
- 录入供应商信息(供应商名称、联系方式)
- 拍摄原材料照片(可选,用于质量存证)
- 保存接收记录

**业务意义**: 建立原材料追溯基础,记录原料来源,为后续成本核算提供原料成本数据

#### 步骤2: 原材料质检(可选)

**操作人员**: 质检员
**使用页面**: QualityInspectionCreateScreen (❌ 待开发)
**操作内容**:
- 选择质检类型:"原料质检"
- 进行感官检查:
  - 外观:是否完整,有无破损
  - 色泽:是否正常,有无变色
  - 气味:是否新鲜,有无异味
- 测量温度(冷藏原料标准:≤4°C)
- 部分批次抽检微生物(大肠菌群、菌落总数)
- 拍摄质检照片(多角度拍摄原材料)
- 判定结果:合格/不合格/条件合格

**业务意义**: 确保原材料质量,防止不合格原料进入生产流程,从源头控制风险

**流程分支**:
- ✅ **合格** → 允许入库,继续步骤3(批次创建)
- ❌ **不合格** → 拒收退货,通知采购部门,流程终止
- ⚠️ **条件合格** → 可降级使用(如做饲料)或特殊处理

#### 步骤3: 批次创建

**操作人员**: 生产部门主管(department_admin)
**使用页面**: BatchCreateScreen (❌ 待开发)
**操作内容**:
- 选择产品类型(速冻鱼排、鱼丸、鱼糜、鱼干等)
- 选择使用的原材料(多选,从已接收的原材料中选择)
- 设置目标产量(单位:kg,必须>0)
- 选择生产线(生产线A、生产线B、生产线C)
- 分配批次负责人(从本部门员工列表中选择)
- 设置预计开始日期(不能早于当前日期)
- 填写预期售价(可选,用于利润率计算)
- 填写备注信息(可选)
- 点击"创建批次"按钮提交

**系统自动操作**:
- 生成唯一批次号(格式:FAC001-20250105-001)
- 检查生产线是否被其他批次占用
- 设置批次初始状态为planning(计划中)
- 创建批次时间线的第一条记录:"创建批次"
- 返回到批次列表页面

**业务意义**: 启动新的生产任务,明确生产目标、分配资源和责任人,是生产流程的正式起点

#### 步骤4: 员工上班打卡

**操作人员**: 生产员工(operator)
**使用页面**: TimeClockScreen (✅ 已完成)
**操作内容**:
- 点击"上班打卡"大按钮
- 系统自动获取GPS位置(1-3秒)
- GPS围栏验证(检查是否在工厂500米范围内)
- 选择工作类型:生产/质检/设备维护/物料搬运/清洁卫生/培训/其他
- 如果选择"生产",进一步选择参与的批次(从进行中的批次列表选择)
- 可选:拍摄打卡照片
- 提交打卡

**系统自动操作**:
- 创建打卡记录(保存时间、GPS位置、照片)
- 创建工作时段记录(记录开始时间、工作类型、关联批次ID)
- 显示打卡成功提示:"打卡成功,开始工作!当前时间:08:32"

**业务意义**: 准确记录员工工作时间,防止代打卡,为工时统计和人工成本计算提供基础数据

#### 步骤5: 设备使用开始

**操作方式**: 批次开始生产时关联设备
**记录内容**:
- 使用的设备(速冻机、切割机、包装机等,支持多选)
- 关联的批次ID
- 设备开始使用时间(自动记录)

**业务意义**: 记录设备使用情况,用于设备成本计算和设备利用率分析

#### 步骤6: 批次生产执行

**操作人员**: 生产主管(department_admin)
**使用页面**: BatchDetailScreen (❌ 待开发)
**操作内容**:
- 打开批次详情页
- 确认生产准备工作完成(原料到位、设备正常、人员到岗)
- 点击"开始生产"按钮
- 确认弹窗:"确定要开始生产吗?开始后将无法修改基本信息"
- 点击"确定"提交

**系统自动操作**:
- 批次状态从planning变更为in_progress
- 记录生产开始时间和操作人
- 生成时间线事件:"开始生产,操作人:张三,时间:2025-01-05 09:00"
- 状态徽章从蓝色"计划中"变为橙色"进行中"

**业务意义**: 标志生产正式开始,进入生产执行阶段,后续将记录实际生产数据

#### 步骤7: 过程质检(建议2-4小时/次)

**操作人员**: 质检员
**使用页面**: QualityInspectionCreateScreen (❌ 待开发)
**检测时机**: 生产过程中定期检测,建议每2-4小时检测一次
**操作内容**:
- 选择正在进行的批次(状态为in_progress的批次)
- 选择质检类型:"过程质检"
- 录入检测项结果:
  - 加工温度:实际值_°C (标准:85-95°C)
  - pH值:实际值 (标准:6.5-7.5)
  - 水分含量:实际值_% (标准:≤75%)
  - 加工时间:实际值_分钟
- 拍摄过程照片(拍摄生产现场、半成品状态)
- 系统自动判定每项是否合格(对比标准值)
- 系统自动计算质量评分
- 提交质检记录

**业务意义**: 实时监控生产过程质量,及时发现参数偏离,避免批量质量问题

**异常处理**:
- 如果过程质检不合格(如温度过低),系统提示质检员
- 质检员通知生产主管
- 主管评估后决定是否暂停生产并调整参数

#### 步骤8: 批次完成

**操作人员**: 生产主管(department_admin)
**使用页面**: BatchDetailScreen (❌ 待开发)
**操作内容**:
- 确认生产工作已完成
- 录入**实际产量**(必填项,单位:kg)
- 点击"完成生产"按钮
- 确认弹窗:"实际产量为420kg,确定完成生产吗?"
- 点击"确定"提交

**系统自动操作**:
- 批次状态从in_progress变更为quality_check
- 记录生产完成时间和实际产量
- 计算产量达成率 = 实际产量÷目标产量×100%
- 生成时间线事件:"完成生产,实际产量:420kg,达成率:105%"
- 状态徽章从橙色"进行中"变为黄色"质检中"

**业务意义**: 标志生产阶段结束,记录实际产出,进入质检验收阶段

#### 步骤9: 成品质检

**操作人员**: 质检员
**使用页面**: QualityInspectionCreateScreen (❌ 待开发)
**检测时机**: 批次状态为quality_check时,必须完成成品质检才能最终完成批次
**操作内容**:
- 选择quality_check状态的批次
- 选择质检类型:"成品质检"
- 进行全面质量检测(最严格):
  - **感官检查**: 色泽、气味、外观、口感
  - **理化指标**: 蛋白质含量(标准:≥15%)、脂肪含量(标准:≤5%)、水分含量
  - **微生物检测**: 大肠菌群(标准:≤100CFU/g)、沙门氏菌(标准:不得检出)
  - **重量检测**: 单位重量是否符合标准(如鱼排单个100±5g)
  - **包装检查**: 包装是否完整、真空度、标签信息正确性
- 拍摄成品照片(多角度拍摄,至少3张)
- 如有不合格项,详细记录:
  - 缺陷详情(具体描述问题)
  - 缺陷类型(色泽异常/微生物超标/包装破损等)
  - 纠正措施(如何处理这批产品)
- 系统自动计算质量评分(0-100分)
- 系统自动判定总体结果(合格/不合格/条件合格)
- 提交质检记录

**系统自动操作**:
- 如果质检结果为pass(合格),批次状态从quality_check变更为completed
- 如果质检结果为fail(不合格),批次状态变更为failed
- 如果质检结果为conditional_pass(条件合格),需要主管手动判定是降级出库还是报废
- 生成时间线事件:"成品质检完成,结果:合格,质量评分:95分"
- 通知批次负责人和主管质检结果

**业务意义**: 确保成品质量符合标准,决定批次能否出库销售,是质量管理的最后一道防线

#### 步骤10: 设备使用结束

**触发时机**: 批次完成时
**操作方式**: 系统自动记录或手动结束设备使用
**记录内容**:
- 设备停止使用时间
- 计算设备总使用时长(分钟)

**业务意义**: 完整记录设备使用数据,用于设备成本计算和设备利用率分析

#### 步骤11: 员工下班打卡

**操作人员**: 生产员工(operator)
**使用页面**: TimeClockScreen (✅ 已完成)
**操作内容**:
- 点击"下班打卡"大按钮
- 系统自动获取GPS位置
- 可选:填写工作总结(今日完成的工作内容)
- 可选:拍摄打卡照片
- 提交打卡

**系统自动操作**:
- 更新工作时段记录的结束时间
- 计算总工时 = 下班时间 - 上班时间(单位:分钟)
- 计算加班工时 = 总工时 - 480分钟(8小时),如果>0
- 判断打卡状态(正常/迟到/早退/加班)
- 显示:"打卡成功!今日工作8.5小时(加班0.5小时)"

**业务意义**: 完整记录工作时间,用于工资计算和人工成本核算

#### 步骤12: 成本核算

**触发时机**: 批次状态变更为completed时自动触发
**计算方式**: 系统自动计算

**成本构成四要素**:

**1. 原料成本 (40-50%)**
- **数据来源**: 批次创建时关联的原材料成本总和
- **计算方式**: 累加所有原材料的成本
- **示例**: 鲈鱼500kg×¥30/kg = ¥15,000

**2. 人工成本 (30-40%)**
- **数据来源**: 统计所有关联此批次的工作时段记录
- **计算方式**: 累加每个员工的(工时×时薪),加班工时按1.5倍计算
- **时薪标准**: 普通操作员¥20/小时,熟练操作员¥25/小时,班长¥30/小时
- **示例**: 5名员工,平均8小时,平均时薪¥22/小时 → 人工成本=5×8×22=¥880

**3. 设备成本 (10-20%)**
- **数据来源**: 统计所有关联此批次的设备使用记录
- **计算方式**: 累加每台设备的(使用时长×折旧率)
- **折旧率计算**: 设备购买价格÷预计使用小时数
- **示例**: 速冻机使用6小时,折旧率¥40/小时 → 设备成本=6×40=¥240

**4. 其他成本 (5-10%)**
- **包含内容**: 能耗(电费、水费)、包装材料、物流运输、质检费用等
- **计算方式**: 暂按前三项总和的5%估算(未来可配置明细)
- **示例**: (15000+880+240)×5% = ¥806

**总成本与单位成本**:
- **总成本** = 原料成本 + 人工成本 + 设备成本 + 其他成本 = ¥16,926
- **单位成本** = 总成本÷实际产量 = ¥16,926÷420kg = ¥40.30/kg

**利润计算**:
- **利润率** = (预期售价-单位成本)÷预期售价×100%
- **示例**: 预期售价¥58/kg → 利润率=(58-40.3)÷58×100%=30.5%
- **利润额** = 实际产量×(预期售价-单位成本) = 420×(58-40.3)=¥7,434

**成本审核规则**:
- operator和department_admin:只能查看成本,不能修改
- factory_super_admin:可以调整成本数据(如发现原料成本录入错误)
- 所有成本调整记录审计日志(调整人、时间、原因、调整前后值)

**业务意义**: 精准计算生产成本,为产品定价、利润分析和成本优化提供数据基础

#### 步骤13: AI成本分析(可选)

**操作人员**: 生产主管或工厂超管
**使用页面**: BatchCostDetailScreen (❌ 待开发)
**操作内容**:
- 进入批次成本详情页
- 查看成本构成(饼图+明细)
- 点击"AI智能分析"按钮
- 等待AI分析(通常3-5秒)
- 查看AI分析报告

**AI分析输出内容**:

**成本评估**:
- "本批次单位成本¥40.30/kg,比目标成本¥38.00/kg高6%"
- "成本超标金额:¥966"

**成本构成分析**:
- "原料成本占89%,在正常范围内(通常40-50%)" → 偏高警告
- "人工成本占5%,低于行业平均35%" → 效率很高
- "设备成本占1.4%,正常"

**历史对比**:
- "本批次成本比近30天同产品平均成本(¥39.2/kg)高3%"
- "主要差异在原料成本,高出¥450"

**问题识别**:
- "原料成本偏高,可能原因:原料单价上涨(从¥28/kg涨到¥30/kg)"
- "人工成本偏低,可能原因:本批次产量高(420kg>平均400kg),摊薄了人工成本"

**优化建议**(3-5条):
1. "建议与供应商重新议价,原料价格比上月高7%"
2. "建议保持当前生产效率,人工成本控制良好"
3. "建议适当提高目标产量至450kg,进一步摊薄固定成本"
4. "建议关注原料市场行情,考虑批量采购降低成本"

**成本控制策略**:
- **月度预算**: AI分析费用控制在¥30/月以内
- **缓存策略**: 相同批次5分钟内不重复调用AI(从缓存返回),节省费用
- **降级策略**: 月预算用完后,自动切换到规则引擎(基于固定规则的简单分析)
- **缓存提示**: 结果来自缓存时显示"(使用缓存结果,节省¥0.02)"

**业务意义**: 利用AI技术快速发现成本问题,提供可执行的优化建议,支持数据驱动的成本管理

#### 步骤14: 数据归档和追溯

**触发时机**: 批次状态为completed或failed后
**系统自动操作**:
- 批次数据永久保存,不可删除(防止数据丢失)
- 生成完整的批次档案(PDF格式)
- 支持通过批次号快速查询完整历史

**可追溯的完整信息**:

**原材料信息**:
- 供应商名称和联系方式
- 原料批次号(供应商提供)
- 接收日期和接收人
- 原料质检结果(如有)

**生产过程信息**:
- 参与员工列表(姓名、工时)
- 使用设备列表(设备名称、使用时长)
- 生产参数(温度、时间、pH等)
- 生产时长(开始时间→完成时间)

**质检信息**:
- 所有阶段的质检记录(原料/过程/成品)
- 质检结果和质量评分
- 质检照片(完整存档)
- 质检员信息

**成本信息**:
- 成本构成明细(原料/人工/设备/其他)
- 总成本和单位成本
- 利润率(如有售价)

**操作历史**:
- 完整的时间线记录(谁、何时、做了什么、数据变化)

**追溯应用场景**:

**场景1: 食品安全事件**
- 客户投诉食物中毒
- 通过产品包装上的追溯码查询批次号
- 查询批次的完整生产信息
- 定位原材料来源(哪个供应商、哪批原料)
- 检查质检记录(是否有异常)
- 追溯到同批次的其他产品,实施召回

**场景2: 质量问题召回**
- 发现某批次产品包装缺陷
- 通过批次号定位所有销售订单
- 通知客户召回产品
- 分析生产过程,找出问题原因(是设备故障还是操作失误)

**场景3: 成本分析**
- 对比不同批次的成本
- 分析成本差异原因(原料价格波动?人工效率?设备利用率?)
- 找出成本最优批次的生产参数

**场景4: 生产优化**
- 分析历史批次数据
- 找出最优生产参数(温度、时间、原料配比)
- 制定标准作业流程(SOP)

**业务意义**:
- 满足《食品安全法》的追溯要求
- 支持快速响应质量问题和食品安全事件
- 为生产优化提供历史数据分析基础

---

### 2.2 批次状态流转规则

批次从创建到完成经历**7个状态**,每个状态有不同的操作权限和页面表现。

#### 状态1: planning (计划中)

**状态徽章**: 蓝色背景,白色文字"计划中"

**状态说明**: 批次已创建,但尚未开始生产,处于准备阶段

**可执行操作**:
- ✅ **编辑批次**: 所有字段都可修改(产品类型、原材料、产量、生产线、负责人等)
- ✅ **删除批次**: 彻底删除,不可恢复
- ✅ **开始生产**: 将状态变更为in_progress

**操作权限**: department_admin及以上

**前置条件**(开始生产前需确认):
- 原材料已准备完毕且通过质检(如有原料质检)
- 生产线可用(未被其他批次占用)
- 批次负责人已分配
- 生产计划已明确

**页面显示**:
- 状态徽章:"计划中"(蓝色)
- 可见操作按钮:"编辑"、"删除"、"开始生产"(三个按钮都可见)
- 提示信息:"批次已创建,可以开始生产"或"请确认生产准备工作完成"

**典型用户操作**: 主管创建批次后,先不急于开始生产,等原料到齐、人员到位后再点"开始生产"

---

#### 状态2: in_progress (进行中)

**状态徽章**: 橙色背景,白色文字"进行中"

**状态说明**: 生产已开始,正在执行中,是批次的主要工作阶段

**可执行操作**:
- ✅ **暂停生产**: 遇到异常情况时暂停,状态变为paused
- ✅ **完成生产**: 生产工作完成后,录入实际产量,状态变为quality_check
- ✅ **修改实际产量**: 可随时更新当前产量(用于进度跟踪)
- ✅ **修改备注**: 可补充生产过程中的说明

**不可操作**:
- ❌ **删除批次**: 进行中的批次不允许删除
- ❌ **修改基本信息**: 产品类型、原材料、目标产量、生产线、负责人等不可修改

**操作权限**: department_admin及以上

**完成生产的必填项**: 实际产量(必须>0)

**页面显示**:
- 状态徽章:"进行中"(橙色,可能带动画效果)
- 可见操作按钮:"暂停生产"、"完成生产"
- 进度条:显示当前产量占目标产量的百分比(如已录入部分产量)
- 动态提示:"生产已进行2.5小时,建议进行过程质检"(2小时后显示)
- 关联信息:显示参与的员工数、使用的设备

**典型用户操作**: 主管在生产过程中定期打开批次详情,查看进度,必要时更新实际产量

---

#### 状态3: paused (已暂停)

**状态徽章**: 红色背景,白色文字"已暂停"

**状态说明**: 生产因异常情况暂停,等待问题解决

**暂停原因**(页面会显示具体原因):
- **设备故障**: 系统检测到设备严重告警时自动暂停(如温度异常、设备停机)
- **原材料不足**: 生产过程中原料用完,需要补充
- **质检不合格**: 过程质检发现问题,需要调整生产参数
- **人员不足**: 员工突然请假或调离
- **其他原因**: 用户手动暂停时需填写具体原因

**可执行操作**:
- ✅ **恢复生产**: 问题解决后,状态变回in_progress
- ✅ **取消生产**: 无法继续时,状态变为cancelled

**操作权限**: department_admin及以上

**恢复生产的前置条件**: 暂停原因已解决(需要主管确认)

**页面显示**:
- 状态徽章:"已暂停"(红色,带警告图标)
- 显示暂停原因:"设备EQ001故障,自动暂停"
- 显示暂停时长:"已暂停2小时15分钟"
- 可见操作按钮:"恢复生产"、"取消生产"
- 警告提示:"生产已暂停,请尽快处理并恢复"

**典型用户操作**: 主管收到设备故障通知,安排维修,故障解决后点击"恢复生产"

---

#### 状态4: quality_check (质检中)

**状态徽章**: 黄色背景,黑色文字"质检中"

**状态说明**: 生产已完成,等待成品质检验收,是质量管理的关键阶段

**可执行操作**:
- ✅ **创建质检记录**: 质检员进行成品质检
- ✅ **质检通过**: 质检结果为pass时,批次变为completed
- ✅ **质检不通过**: 质检结果为fail时,批次变为failed

**操作权限**:
- 创建质检记录:operator及以上
- 质检判定(通过/不通过):department_admin及以上

**质检通过的前置条件**:
- 必须有成品质检记录
- 质检结果为pass(合格)

**页面显示**:
- 状态徽章:"质检中"(黄色)
- 提示信息:"生产已完成,等待质检验收"
- 可见操作按钮:"创建质检记录"
- 如果已有质检记录:
  - 显示质检结果(合格/不合格/条件合格)
  - 显示质量评分(如95分)
  - 显示操作按钮:"质检通过"或"质检不通过"

**典型用户操作**:
- 主管完成生产,批次进入质检中状态
- 质检员看到待质检批次,进行质检并录入结果
- 主管根据质检结果,点击"质检通过"或"质检不通过"

---

#### 状态5: completed (已完成)

**状态徽章**: 绿色背景,白色文字"已完成"

**状态说明**: 批次生产完成且质检通过,可以出库销售,是成功的最终状态

**可执行操作**:
- ✅ **查看所有数据**: 所有信息只读
- ✅ **查看成本详情**: 查看成本构成和成本分析
- ✅ **请求AI分析**: 获取成本优化建议
- ✅ **导出批次报告**: 生成PDF报告

**不可操作**:
- ❌ **编辑信息**: 所有字段不可编辑(factory_super_admin可例外)
- ❌ **删除批次**: 已完成批次不允许删除,只能归档
- ❌ **状态变更**: 不能再变更为其他状态

**系统自动操作**:
- 触发成本自动计算(如果尚未计算)
- 数据归档,支持长期追溯查询
- 如果未来集成仓储模块,自动触发成品入库

**页面显示**:
- 状态徽章:"已完成"(绿色,带对勾图标)
- 所有信息字段只读,不可编辑
- 可见操作按钮:"查看成本详情"、"AI智能分析"、"导出报告"
- 显示完成信息:完成时间、总耗时(从创建到完成的总天数或小时数)
- 显示成果:实际产量、达成率、质量等级、单位成本

**典型用户操作**: 主管查看已完成批次的成本数据,请求AI分析获取优化建议

---

#### 状态6: failed (已失败)

**状态徽章**: 深红色背景,白色文字"已失败"

**状态说明**: 批次质检不通过或生产失败,产品不合格,是失败的最终状态

**失败原因**(页面会显示):
- **成品质检不合格**: 微生物超标、感官异常、理化指标不达标等
- **生产过程严重质量问题**: 过程质检多次不合格,无法纠正
- **设备故障导致报废**: 设备故障导致半成品或成品损坏

**可执行操作**:
- ✅ **查看所有数据**: 所有信息只读
- ✅ **查看失败原因**: 查看质检不合格的具体项目
- ✅ **记录处理措施**: 记录产品如何处理(报废/降级/返工)

**不可恢复**: 失败的批次不能再变更为其他状态,不能"起死回生"

**页面显示**:
- 状态徽章:"已失败"(深红色,带叉号图标)
- 显示失败原因:"成品质检不合格,大肠菌群超标(150CFU/g,标准≤100)"
- 显示处理措施:"产品已报废,损失金额:¥16,926"
- 所有信息只读
- 红色警示框:"此批次已失败,产品不可出库"

**典型用户操作**: 主管查看失败批次,分析失败原因,制定改进措施,避免再次发生

---

#### 状态7: cancelled (已取消)

**状态徽章**: 灰色背景,白色文字"已取消"

**状态说明**: 批次在planning或paused状态时被取消,未完成生产

**可取消的状态**: 仅planning(计划中)和paused(已暂停)可取消

**取消原因**(用户需填写):
- 订单取消(客户取消订单,不需要生产)
- 原材料不足且无法补充
- 生产线调整(优先生产其他产品)
- 设备长期故障无法修复
- 其他原因

**操作权限**: factory_super_admin(较高权限,防止误操作)

**操作流程**:
- 点击"取消生产"按钮
- 弹窗要求填写"取消原因"(必填)
- 确认后提交

**页面显示**:
- 状态徽章:"已取消"(灰色)
- 显示取消原因和取消时间
- 显示取消操作人
- 所有信息只读

**典型用户操作**: 工厂超管因客户取消订单,决定取消批次生产

---

### 2.3 跨模块协作关系

生产模块不是孤立运行的,需要与系统中的其他多个模块深度集成,形成完整的业务闭环。

#### 2.3.1 与认证模块的集成

**集成目的**: 实现基于角色的权限控制,不同角色看到不同功能

**权限控制矩阵**:

| 角色 | 可访问页面 | 可执行操作 | 数据范围 |
|-----|----------|----------|---------|
| **operator** | 批次列表(查看)、批次详情(查看)、打卡页面、质检创建 | 打卡、创建质检记录 | 仅自己参与的批次 |
| **department_admin** | 批次所有页面、质检所有页面、设备查看页面 | 批次CRUD、质检管理、设备查看 | 本部门所有批次 |
| **factory_super_admin** | 所有页面 | 所有操作、成本调整、强制状态变更 | 本工厂所有批次 |
| **platform_admin** | 所有页面(只读) | 仅查看、数据导出 | 所有工厂所有批次 |

**页面权限守卫**:
- 用户访问BatchCreateScreen,系统检查是否有batch:create权限
- 如果没有权限,显示"权限不足"页面,提示"需要department_admin及以上权限"
- 如果有权限,正常显示页面

**操作按钮权限控制**:
- 批次详情页的"编辑"按钮,只有department_admin及以上可见
- 批次详情页的"开始生产"按钮,根据用户角色和批次状态动态显示
- operator用户进入批次详情页,只能查看,看不到操作按钮

**业务价值**: 确保数据安全,防止越权操作,不同角色各司其职

---

#### 2.3.2 与员工管理模块的集成

生产模块需要员工数据(选择负责人),同时为员工模块提供工作数据(打卡关联批次)。

**集成点1: 批次负责人选择**

**业务场景**: 创建批次时需要分配批次负责人

**数据流向**: 员工管理模块 → 生产模块

**操作流程**:
1. 用户在BatchCreateScreen填写表单
2. 点击"批次负责人"选择器
3. 系统调用员工管理模块,获取员工列表
4. 筛选条件:部门=processing(生产部门),isActive=true(在职员工)
5. 显示员工列表,每个员工显示:姓名、部门、当前负责的批次数
6. 用户选择一名员工
7. 系统保存负责人ID到批次记录

**显示信息**:
- 员工姓名(如:张三)
- 部门(如:生产部)
- 当前负责批次数(如:2个批次) ← 用于判断工作负荷,避免分配过多任务

**业务价值**: 合理分配生产任务,避免某个负责人任务过重

---

**集成点2: 工时记录关联批次**

**业务场景**: 员工打卡时选择参与的批次,用于追踪人工投入

**数据流向**: 生产模块 ↔ 员工管理模块(双向)

**操作流程**:
1. 员工在TimeClockScreen上班打卡
2. 选择工作类型为"生产"
3. 系统显示当前进行中(in_progress)的批次列表
4. 员工选择今日参与的批次(如:FAC001-20250105-001 速冻鱼排)
5. 系统保存批次ID到打卡记录和工作时段记录
6. 下班打卡时,系统自动关联同一个批次

**数据关联**:
- 打卡记录表保存:relatedBatchId字段
- 工作时段记录表保存:relatedBatchId字段

**业务价值**: 精确追踪每个批次的人工投入,为成本计算提供准确数据

---

**集成点3: 成本核算读取工时数据**

**业务场景**: 批次完成后计算人工成本

**数据流向**: 员工管理模块 → 生产模块

**计算流程**:
1. 批次状态变更为completed时触发成本计算
2. 系统查询所有关联此批次的工作时段记录
3. 读取每个工作时段的:员工姓名、工时(分钟)、时薪(元/小时)
4. 计算每个员工的成本:工时÷60×时薪
5. 如有加班工时,按1.5倍时薪计算
6. 累加所有员工的成本,得到人工成本总额

**显示位置**: BatchCostDetailScreen的成本明细区域

**展示内容**:
- 人工成本总额:¥880
- 总工时:40小时
- 参与员工数:5人
- 平均时薪:¥22/小时
- 可展开查看明细:
  - 张三:8小时×¥20/小时=¥160
  - 李四:8小时×¥25/小时=¥200(熟练工)
  - ...

**业务价值**: 准确计算人工成本,分析人工效率,为成本优化提供数据

---

#### 2.3.3 与设备监控模块的集成

生产模块需要记录设备使用情况,设备模块的告警会影响生产批次。

**集成点1: 批次执行时记录设备使用**

**业务场景**: 批次开始生产时,记录使用的设备和时长

**数据流向**: 生产模块 → 设备管理模块

**操作流程**:
1. 主管在BatchDetailScreen点击"开始生产"
2. 弹窗提示:"请选择本次生产使用的设备"
3. 显示设备多选列表(速冻机、切割机、包装机等)
4. 用户选择设备(可选多台)
5. 点击"确定"后,批次开始生产
6. 系统为每台设备创建使用记录:
   - 设备ID、批次ID、开始时间
7. 批次完成时,自动记录设备停止时间,计算使用时长

**业务价值**: 追踪设备使用情况,计算设备成本,分析设备利用率

---

**集成点2: 成本核算读取设备数据**

**业务场景**: 批次完成后计算设备成本

**数据流向**: 设备管理模块 → 生产模块

**计算流程**:
1. 批次状态变更为completed时触发成本计算
2. 系统查询所有关联此批次的设备使用记录
3. 读取每台设备的:设备名称、使用时长(分钟)、折旧率(元/小时)
4. 计算每台设备的成本:使用时长÷60×折旧率
5. 累加所有设备的成本,得到设备成本总额

**显示位置**: BatchCostDetailScreen的成本明细区域

**展示内容**:
- 设备成本总额:¥240
- 使用设备:3台
- 可展开查看明细:
  - 1号速冻机:6小时×¥40/小时=¥240
  - 2号切割机:4小时×¥20/小时=¥80
  - ...

**业务价值**: 准确计算设备成本,分析设备使用效率

---

**集成点3: 设备异常影响批次状态**

**业务场景**: 设备严重故障时,自动暂停相关批次,避免继续生产造成更大损失

**数据流向**: 设备管理模块 → 生产模块(自动触发)

**自动暂停流程**:
1. 设备监控系统检测到1号速冻机温度异常(-5°C,标准≤-15°C)
2. 系统判定为严重告警(critical级别)
3. 设备监控模块触发告警处理逻辑
4. 查找正在使用该设备的批次(状态=in_progress且设备使用记录未结束)
5. 找到批次FAC001-20250105-001
6. 自动将批次状态从in_progress变更为paused
7. 记录暂停原因:"设备EQ001严重故障(温度异常),自动暂停"
8. 推送通知给批次负责人:"您负责的批次FAC001-20250105-001因设备故障已自动暂停"
9. 推送通知给生产主管:"批次FAC001-20250105-001因设备EQ001故障已自动暂停,请及时处理"

**恢复流程**:
1. 设备维修完成,状态恢复正常
2. 主管打开批次详情页
3. 看到暂停原因:"设备EQ001故障,已自动暂停"
4. 确认设备已修复
5. 点击"恢复生产"按钮
6. 批次状态从paused变回in_progress

**业务价值**: 自动化异常处理,减少人工响应时间,避免设备故障期间继续生产导致质量问题扩大

---

#### 2.3.4 与仓储模块的集成 (未来规划 - Phase 4+)

**集成点1: 批次创建时原料出库**

**业务场景**: 创建批次时需要从仓库领取原材料,减少库存

**操作流程**:
1. 用户在BatchCreateScreen选择原材料
2. 系统显示每种原材料的库存数量(从仓储模块读取)
3. 用户选择原材料和数量(如:鲈鱼500kg)
4. 系统检查库存是否充足:
   - 如果鲈鱼库存只有300kg,提示"库存不足,当前库存300kg,需要500kg"
   - 如果库存充足,允许创建批次
5. 批次创建成功后,自动触发原料出库:
   - 仓储模块创建出库单
   - 减少鲈鱼库存:800kg → 300kg
   - 记录出库用途:生产批次FAC001-20250105-001
6. 生产模块保存出库单号,用于追溯

**追溯关联**: 原材料的入库批次号(供应商批次)与生产批次号关联,支持向上追溯到供应商

**业务价值**: 实时库存管理,避免超领或缺料,支持原材料追溯

---

**集成点2: 批次完成时成品入库**

**业务场景**: 批次质检通过后,成品自动入库,增加成品库存

**操作流程**:
1. 批次质检通过,状态变更为completed
2. 系统自动触发成品入库:
   - 产品类型:速冻鱼排
   - 数量:420kg(实际产量)
   - 质量等级:A级
   - 生产日期:2025-01-05
   - 保质期:6个月(2025-07-05到期)
   - 批次号:FAC001-20250105-001
3. 仓储模块创建入库单,增加成品库存
4. 生成追溯码,绑定批次号(格式:批次号-流水号)
5. 生产模块保存入库单号

**追溯码应用**:
- 产品包装上打印追溯码二维码
- 客户扫描二维码,查询完整生产信息:
  - 生产日期、生产工厂、批次负责人
  - 原材料来源(供应商、产地)
  - 质检结果(质量评分、质检照片)
  - 生产过程关键参数

**保质期管理**:
- 仓储模块根据生产日期+保质期,计算到期日
- 支持FIFO先进先出管理
- 临期产品自动提醒(到期前30天)

**业务价值**: 自动化出入库管理,支持产品追溯,满足食品安全法要求

---

#### 2.3.5 与销售模块的集成 (未来规划 - Phase 5+)

**集成点1: 销售订单关联批次号**

**业务场景**: 销售出库时关联产品的生产批次,支持端到端追溯

**追溯链条**: 供应商 → 原材料批次 → 生产批次 → 成品 → 销售订单 → 客户

**客户追溯查询**:
- 客户扫描产品包装上的追溯码
- 系统显示追溯信息页面:
  - **生产信息**: 批次号、生产日期、生产工厂、批次负责人
  - **原材料**: 供应商名称、原材料产地、接收日期
  - **质检信息**: 质检日期、质量评分(95分)、质检照片(点击查看)
  - **生产参数**: 加工温度、加工时长等关键参数
  - **食用建议**: 保质期、储存条件、食用方法

**召回管理**:
- 如果某批次产品发现质量问题(如微生物超标)
- 通过批次号查询所有关联的销售订单
- 系统自动生成召回清单:哪些客户买了、买了多少、何时购买
- 销售模块通知客户,执行产品召回
- 追溯影响范围,控制风险

**业务价值**: 建立完整追溯链条,快速响应食品安全事件,保护消费者权益

---

**集成点2: 生产成本用于销售定价**

**业务场景**: 销售人员制定产品价格时,参考生产成本数据

**数据流向**: 生产模块 → 销售模块

**定价辅助流程**:
1. 销售人员创建新产品或调整价格
2. 选择产品类型:速冻鱼排
3. 系统调用生产模块,查询该产品近30天的平均单位成本
4. 系统显示:"速冻鱼排平均成本:¥40.5/kg(基于15个批次数据)"
5. 销售人员设置目标利润率:30%
6. 系统自动计算建议售价:¥40.5÷(1-30%)=¥57.86/kg
7. 销售人员参考建议价格,制定最终售价

**利润分析**:
- 销售订单完成后,系统计算实际利润:
  - 成本:从生产模块读取该批次的单位成本¥40.30/kg
  - 售价:从销售订单读取实际售价¥58/kg
  - 利润:¥58-¥40.30=¥17.70/kg
  - 利润率:¥17.70÷¥58×100%=30.5%

**业务价值**: 基于成本的科学定价,确保盈利,避免亏本销售

---

#### 2.3.6 与财务模块的集成 (未来规划 - Phase 6+)

**集成点1: 批次成本数据同步到财务**

**业务场景**: 批次完成后,成本数据自动同步到财务模块,用于会计核算

**数据流向**: 生产模块 → 财务模块(自动同步)

**同步时机**: 批次状态变更为completed时

**同步内容** (按会计科目分类):
- **原料成本**: ¥15,000 → 会计科目"直接材料成本"
- **人工成本**: ¥880 → 会计科目"直接人工成本"
- **设备成本**: ¥240 → 会计科目"制造费用-折旧"
- **其他成本**: ¥806 → 会计科目"制造费用-其他"

**财务模块用途**:
- 生成成本报表(生产成本表)
- 计算产品成本(用于存货核算)
- 分析成本结构(原料占比、人工占比)
- 编制财务报表(利润表)

**业务价值**: 自动化财务核算,减少财务人员手工录入,提高准确性

---

**集成点2: 利润分析读取生产和销售数据**

**业务场景**: 财务模块进行利润分析时,需要读取生产成本和销售收入

**数据流向**: 生产模块+销售模块 → 财务模块

**分析维度**:
- **按时间段**: 本月生产了哪些批次,总成本多少,销售收入多少,利润多少
- **按产品类型**: 速冻鱼排的总成本、销售收入、利润率
- **按生产线**: 生产线A的产量、成本、效益
- **按部门**: 生产部的成本、销售部的收入

**利润计算**:
- 总收入(销售模块统计) - 总成本(生产模块统计) = 利润
- 示例:本月销售¥500,000,生产成本¥350,000,利润=¥150,000,利润率=30%

**管理报表**:
- 生成利润表(月度/季度/年度)
- 生成成本分析表(成本构成、成本趋势)
- 支持经营决策(哪些产品最赚钱,哪些产品应该停产)

**业务价值**: 全面了解经营状况,支持管理层决策

---

### 2.4 关键业务规则

#### 规则1: 生产线占用规则

**规则描述**: 同一生产线同一时间只能有一个批次处于生产中(in_progress)状态

**验证时机**: 创建批次时或点击"开始生产"时

**验证逻辑**: 系统检查目标生产线是否有其他批次正在使用(状态=in_progress)

**用户提示**:
- 如果生产线被占用,显示红色警告框:
  - "生产线A正被批次FAC001-20250105-001占用"
  - "预计2小时后可用"
- 阻止创建或开始生产

**例外情况**: factory_super_admin可以强制创建(如紧急订单)
- 点击"强制创建"后,弹窗警告:"生产线A已被占用,强制创建可能导致生产冲突,确定继续吗?"
- 点击"确定"后允许创建,但记录警告日志

**业务意义**: 避免生产冲突,合理安排生产资源,防止生产线过载

---

#### 规则2: 质检必须规则

**规则描述**: 成品质检必须通过才能完成批次,未经质检或质检不合格的批次不允许出库

**验证时机**: 批次从quality_check状态变更为completed时

**验证逻辑**:
- 检查是否有成品质检记录
- 检查质检结果是否为pass(合格)

**用户提示**:
- 如果没有质检记录,点击"质检通过"按钮时提示:
  - "请先创建成品质检记录"
  - 提供快捷按钮:"去创建质检"
- 如果质检结果不是pass,点击"质检通过"时提示:
  - "当前质检结果为不合格,无法通过质检"
  - "请处理质检问题或标记批次为失败"

**异常处理**: 质检不通过时,主管点击"质检不通过"按钮,批次状态变为failed

**业务意义**: 确保产品质量,符合食品安全要求,防止不合格产品流入市场

---

#### 规则3: 成本计算时机

**规则描述**: 成本在特定时机自动计算,确保数据准确性

**自动计算时机**:
- **时机1**: 批次状态变更为completed时,系统自动触发成本计算
- **时机2**: 用户在BatchCostDetailScreen点击"重新计算成本"按钮时

**计算前提条件**:
- 批次必须有实际产量(actualQuantity>0)
- 工时记录和设备使用记录完整

**成本审核**:
- operator和department_admin:只能查看成本,不能修改
- factory_super_admin:可以调整成本数据
  - 使用场景:发现原料成本录入错误(实际¥15,000误录为¥18,000)
  - 操作方式:点击成本项旁的"调整"按钮,输入正确值和调整原因
  - 审计日志:记录调整人、调整时间、调整原因、调整前后值

**业务意义**: 及时准确计算成本,支持定价决策,同时允许纠错但记录审计

---

#### 规则4: 数据权限规则

**规则描述**: 不同角色只能查看和操作权限范围内的数据

**operator (操作员)**:
- **可查看**: 仅自己参与的批次(打卡时关联的批次)
- **可操作**: 创建质检记录、打卡
- **不可操作**: 创建批次、修改批次、删除批次、批次状态变更
- **页面限制**: 无法访问BatchCreateScreen、BatchEditScreen
- **数据隔离**: 在BatchListScreen只能看到自己参与的批次

**department_admin (部门管理员)**:
- **可查看**: 本部门所有批次(不限是否参与)
- **可操作**: 批次CRUD、批次状态变更、质检审批、设备查看
- **不可操作**: 调整成本、强制操作、跨部门数据访问
- **数据隔离**: 只能看到生产部门的批次,看不到质检部门的批次

**factory_super_admin (工厂超管)**:
- **可查看**: 本工厂所有批次(跨部门)
- **可操作**: 所有操作、成本调整、强制状态变更、删除已完成批次
- **数据隔离**: 只能看到本工厂的批次,看不到其他工厂的批次

**platform_admin (平台管理员)**:
- **可查看**: 所有工厂所有批次(全局视图)
- **可操作**: 仅查看、数据导出、跨工厂数据分析
- **不可操作**: 不能直接操作具体批次(避免误操作)

**权限实现**:
- 页面级权限:用户访问无权限页面时,显示"权限不足"提示页
- 数据级权限:API查询时根据用户角色过滤数据
- 操作级权限:操作按钮根据权限动态显示/隐藏

**业务意义**: 保护数据安全,防止越权操作,不同角色各司其职

---

#### 规则5: 离线数据同步规则

**规则描述**: 支持部分功能离线操作,联网后自动同步

**离线可操作**:
- ✅ **员工打卡**: 离线时可以打卡,数据保存在本地,联网后自动上传
- ✅ **质检记录创建**: 离线时可以创建质检记录(包括拍照),联网后同步
- ✅ **批次列表查看**: 查看本地缓存的批次数据

**离线不可操作**:
- ❌ **批次状态变更**: 需要实时性,必须联网操作
- ❌ **成本计算**: 需要服务器计算,必须联网
- ❌ **AI分析**: 需要调用DeepSeek API,必须联网
- ❌ **批次创建**: 需要生成批次号和检查冲突,必须联网

**同步策略**:
- **自动同步**: 检测到网络恢复时,自动上传离线数据
- **同步顺序**: 按时间顺序同步,先打卡记录,再质检记录
- **冲突检测**: 根据时间戳判断,后提交的数据覆盖先提交的
- **失败重试**: 同步失败时,最多重试3次
- **失败提示**: 3次重试后仍失败,提示用户:"部分数据同步失败,请检查网络后重试"

**用户提示**:
- 离线时,页面顶部显示黄色提示条:"当前处于离线模式,数据将在联网后自动同步"
- 离线操作成功时,显示:"数据已保存到本地,将在联网后自动上传"
- 同步成功时,显示Toast:"离线数据同步成功"

**业务价值**: 支持网络不稳定环境下的核心操作,避免因网络问题影响工作,提升用户体验

---

## 功能模块详细设计

### 3.1 批次管理模块

#### 3.1.1 模块定位

批次管理是生产模块的**核心主线**,管理生产批次的完整生命周期,串联起原材料、员工、设备、质检、成本等所有生产要素。

**模块作用**:
- 作为生产任务的容器,承载所有生产数据
- 提供批次的状态流转管理
- 支持批次的查询、筛选、追溯

**现有完成度**:
- ✅ 后端功能:100% 完成
- ❌ 前端页面:20% (仅MaterialReceiptScreen,其他4页全部待开发)

**待开发页面**:
1. **BatchListScreen** - 批次列表页 (优先级:P0,必须)
2. **BatchDetailScreen** - 批次详情页 (优先级:P0,必须)
3. **BatchCreateScreen** - 创建批次页 (优先级:P0,必须)
4. **BatchEditScreen** - 编辑批次页 (优先级:P1,重要)
5. **BatchTimelineScreen** - 批次时间线页 (优先级:P2,次要)

---

#### 3.1.2 核心功能详解

**功能1: 批次创建**

**功能定位**: 启动生产任务的入口,是生产流程的起点

**表单字段**:

| 字段名称 | 字段类型 | 是否必填 | 说明 | 示例值 |
|---------|---------|---------|------|--------|
| 产品类型 | 单选下拉 | 必填 | 选择要生产的产品 | 速冻鱼排 |
| 原材料列表 | 多选 | 必填 | 选择使用的原材料 | 鲈鱼500kg、盐5kg |
| 目标产量 | 数字输入 | 必填 | 计划生产数量(kg) | 400 |
| 生产线 | 单选下拉 | 必填 | 选择使用的生产线 | 生产线A |
| 批次负责人 | 单选 | 必填 | 分配批次负责人 | 张三 |
| 开始日期 | 日期选择 | 必填 | 计划开始日期 | 2025-01-06 |
| 预期售价 | 数字输入 | 可选 | 用于利润计算(元/kg) | 58 |
| 备注 | 多行文本 | 可选 | 补充说明 | 春节订单,加急 |

**字段验证规则**:
- 产品类型:必选
- 原材料:至少选择1种
- 目标产量:必须>0,建议范围100-1000kg
- 生产线:必选,且检查是否被占用
- 负责人:必选,从在职员工中选择
- 开始日期:不能早于当天

**系统自动操作**:
- 生成批次号:FAC001-20250105-001(工厂代码-日期-序号)
- 检查生产线占用:如果生产线A已被占用,提示并阻止创建
- 设置初始状态:planning
- 创建时间线记录:"创建批次,操作人:李四,时间:2025-01-05 14:30"

**用户体验**:
- 表单采用分步填写(可选):基本信息→原材料→生产安排→确认提交
- 实时表单验证:必填项未填时,提交按钮禁用并提示
- 创建确认:提交前弹窗确认,预览关键信息
- 创建成功:显示Success提示,自动跳转到批次详情页

**操作入口**:
- 入口1: ProcessingDashboardScreen → "创建批次"卡片
- 入口2: BatchListScreen → 右下角FAB浮动按钮(+图标)

**业务价值**: 规范化批次创建流程,明确生产目标,分配责任,是生产管理的第一步

---

**功能2: 批次列表查询**

**功能定位**: 批次管理的主工作界面,主管日常使用频率最高的页面

**列表布局**: 卡片式布局(Card Layout)

**单个批次卡片包含**:
- **头部**: 批次号(大字号)+状态徽章(彩色)
- **第1行**: 产品类型(速冻鱼排)+产量(400kg)
- **第2行**: 生产线(生产线A)+负责人(张三)
- **第3行**: 开始日期(2025-01-05)+进度条(如已有进度)
- **底部**: 快捷操作按钮(根据状态显示,如"开始生产"、"查看详情")

**筛选功能**:

**按状态筛选**(标签页):
- 全部(显示总数,如"全部(25)")
- 计划中(planning,蓝色标签)
- 进行中(in_progress,橙色标签)
- 质检中(quality_check,黄色标签)
- 已完成(completed,绿色标签)
- 已失败(failed,红色标签)
- 点击标签,列表自动筛选并刷新

**高级筛选**(点击"筛选"按钮,弹出筛选面板):
- 日期范围:选择开始日期范围(如:2025-01-01 ~ 2025-01-31)
- 产品类型:多选(速冻鱼排、鱼丸、鱼糜)
- 生产线:多选(生产线A、生产线B)
- 负责人:多选(从员工列表选择)
- 点击"应用筛选",列表更新

**搜索功能**:
- 顶部搜索框,placeholder:"搜索批次号或产品类型"
- 实时搜索(输入后300ms开始搜索)
- 支持模糊匹配(如输入"鱼排"匹配"速冻鱼排")

**排序功能**:
- 默认排序:按开始时间倒序(最新在前)
- 可选排序:按状态、按产量、按成本
- 点击排序按钮切换

**分页加载**:
- 每页显示20条批次
- 下拉刷新:Pull to Refresh,获取最新数据
- 上拉加载更多:滚动到底部自动加载下一页
- 加载状态:显示Loading图标和"加载中..."文字

**空状态**:
- 当前筛选条件下无批次时,显示空状态插图
- 提示文字:"暂无批次数据"
- 引导按钮:"创建批次"(点击跳转到BatchCreateScreen)

**用户权限过滤**:
- operator:仅显示自己参与的批次
- department_admin:显示本部门所有批次
- factory_super_admin:显示本工厂所有批次

**业务价值**: 快速定位批次,支持多维度查询,是生产管理的日常工作台

---

**功能3: 批次详情查看**

**功能定位**: 批次操作的中心页面,查看批次完整信息,执行批次操作

**页面布局** (分区卡片式):

**区域1: 批次头部**
- 批次号(大字号,可长按复制)
- 状态徽章(彩色,根据状态变化)
- 产品类型

**区域2: 状态流转可视化**
- 横向流程图:planning → in_progress → quality_check → completed
- 当前状态高亮显示(彩色)
- 已完成的状态打勾(绿色)
- 未完成的状态灰色显示

**区域3: 基本信息卡片**
- 生产线:生产线A
- 批次负责人:张三(可点击查看员工信息)
- 开始日期:2025-01-05
- 结束日期:2025-01-06(如已完成)
- 备注:春节订单,加急

**区域4: 产量信息卡片**
- 进度条:可视化显示实际产量/目标产量
- 目标产量:400kg
- 实际产量:420kg(如已录入,完成后显示)
- 达成率:105%(绿色,表示超额完成)
- 质量等级:A级(质检完成后显示)

**区域5: 成本信息卡片**
- 成本构成饼图:可视化显示原料/人工/设备/其他占比
- 总成本:¥16,926
- 单位成本:¥40.30/kg
- 利润率:30.5%(绿色表示盈利)
- "查看成本详情"链接 → 跳转到BatchCostDetailScreen

**区域6: 关联数据卡片**

**质检记录**:
- 显示所有质检记录列表(原料/过程/成品)
- 每条显示:质检类型、结果徽章(合格/不合格)、质检日期
- 点击质检记录 → 跳转到QualityInspectionDetailScreen
- "创建质检记录"链接 → 跳转到QualityInspectionCreateScreen

**工时记录**:
- 总工时:40小时
- 参与员工:5人
- "查看详细工时"链接 → 跳转到WorkRecordScreen(按批次筛选)

**设备使用记录**:
- 使用设备:1号速冻机(6小时)、2号切割机(4小时)
- "查看设备详情"链接 → 跳转到EquipmentDetailScreen

**区域7: 批次时间线(可折叠)**
- 默认显示最近3条事件
- 点击"展开完整时间线" → 跳转到BatchTimelineScreen
- 时间线事件显示:事件图标、事件名称、时间、操作人

**底部操作按钮组**(根据状态和权限动态显示):

**planning状态**:
- "编辑"按钮(outlined样式)
- "删除"按钮(outlined,红色文字)
- "开始生产"按钮(contained,主要按钮,绿色)

**in_progress状态**:
- "暂停生产"按钮(outlined,黄色)
- "完成生产"按钮(contained,绿色)

**paused状态**:
- "恢复生产"按钮(contained,绿色)
- "取消生产"按钮(outlined,红色)

**quality_check状态**:
- "创建质检"按钮(如无质检记录)
- "质检通过"按钮(contained,绿色,需有合格的质检记录)
- "质检不通过"按钮(outlined,红色)

**completed/failed状态**:
- "查看成本详情"按钮
- "AI智能分析"按钮
- "导出报告"按钮

**业务价值**: 全面了解批次信息,快速执行批次操作,是批次管理的核心页面

---

**功能4: 批次编辑**

**功能定位**: 修改批次信息,纠正录入错误或调整生产计划

**编辑规则**(不同状态可编辑的字段不同):

**planning状态** - 所有字段可编辑:
- 产品类型、原材料列表、目标产量、生产线、批次负责人、开始日期、预期售价、备注
- 用户场景:批次刚创建,发现目标产量录入错误,及时修改

**in_progress状态** - 仅部分字段可编辑:
- 实际产量(可随时更新,用于追踪进度)
- 备注(可补充生产过程中的说明)
- 其他字段不可编辑(避免影响正在进行的生产)
- 用户场景:生产进行到一半,主管更新当前产量

**其他状态** - 不允许编辑:
- quality_check、completed、failed、cancelled状态的批次不允许编辑
- 原因:这些状态的批次已经锁定,不应再修改
- 例外:factory_super_admin可以例外编辑(需填写编辑原因)

**表单布局**: 与BatchCreateScreen类似,但表单预填充现有数据

**保存操作**:
- 点击"保存修改"按钮
- 如果修改了关键字段(如生产线、负责人),弹窗确认
- 保存成功后,返回到BatchDetailScreen
- 生成时间线记录:"更新批次信息,操作人:李四"

**取消编辑**:
- 点击"取消"按钮或返回键
- 如果表单有修改,弹窗确认:"确定放弃修改吗?"

**业务价值**: 允许纠正错误,保证数据准确性,同时限制编辑范围避免误操作

---

**功能5: 批次删除**

**功能定位**: 清理不需要的批次

**删除规则**: 仅planning状态的批次可删除

**不可删除的状态**: in_progress、paused、quality_check、completed、failed(防止误删重要数据)

**操作流程**:
1. 在BatchDetailScreen点击"删除"按钮
2. 弹窗二次确认:
   - "确定要删除批次FAC001-20250105-001吗?"
   - "产品类型:速冻鱼排,目标产量:400kg"
   - "此操作不可恢复!"
3. 点击"确定删除"(红色按钮)
4. 删除成功,自动返回到BatchListScreen
5. 显示Toast提示:"批次已删除"

**软删除vs硬删除**: 建议使用软删除(标记为已删除但不物理删除),保留审计记录

**用户权限**: department_admin及以上

**业务价值**: 清理错误创建或已取消的批次,保持数据整洁,避免混淆

---

**功能6: 批次状态变更**

**功能定位**: 推进批次在生命周期中流转,管理生产进程

**支持的状态变更操作**:

| 操作名称 | 状态变化 | 必填项 | 确认弹窗 | 权限 |
|---------|---------|-------|---------|------|
| 开始生产 | planning → in_progress | 无 | 是 | department_admin+ |
| 暂停生产 | in_progress → paused | 暂停原因 | 是 | department_admin+ |
| 恢复生产 | paused → in_progress | 无 | 是 | department_admin+ |
| 完成生产 | in_progress → quality_check | 实际产量 | 是 | department_admin+ |
| 质检通过 | quality_check → completed | 质检记录 | 是 | department_admin+ |
| 质检不通过 | quality_check → failed | 失败原因 | 是 | department_admin+ |
| 取消生产 | planning/paused → cancelled | 取消原因 | 是 | factory_super_admin |

**确认弹窗示例**:

**开始生产**:
- 标题:"确定要开始生产吗?"
- 内容:"批次:FAC001-20250105-001,产品:速冻鱼排,目标产量:400kg"
- 警告:"开始后将无法修改基本信息(产品类型、原材料、生产线等)"
- 按钮:"取消"(灰色)、"确定开始"(绿色)

**完成生产**:
- 标题:"确定完成生产吗?"
- 内容:"请确认实际产量"
- 输入框:实际产量_kg(必填)
- 警告:"完成后批次将进入质检阶段"
- 按钮:"取消"、"确定完成"

**质检通过**:
- 标题:"确认批次质检通过吗?"
- 内容:"批次:FAC001-20250105-001,质检结果:合格,质量评分:95分"
- 警告:"通过后批次将完成,成本将自动计算"
- 按钮:"取消"、"确定通过"

**操作后反馈**:
- 操作成功:显示Toast"批次已开始生产",状态徽章实时更新
- 操作失败:显示错误原因,如"无法开始生产:生产线被占用"

**业务价值**: 规范化批次流转,防止误操作,确保每个关键操作都经过确认

---

**功能7: 批次时间线**

**功能定位**: 追溯批次完整历史,审计和问题排查

**时间线事件类型**:
- 创建批次、开始生产、暂停生产、恢复生产
- 更新信息(编辑批次)
- 质检(原料/过程/成品)
- 质检通过、质检不通过
- 完成生产、生产失败、取消生产

**单个事件包含**:
- 事件图标(不同类型用不同图标和颜色)
- 事件名称(如:"开始生产")
- 事件时间(精确到秒,如:"2025-01-05 09:00:32")
- 操作人员(如:"操作人:张三")
- 事件描述(如:"批次开始生产,使用生产线A")
- 相关数据变更(如:"状态:planning → in_progress")

**显示方式**:
- 时间线可视化:左侧时间轴(带竖线连接),右侧事件详情
- 按时间倒序排列(最新事件在顶部)
- 不同类型事件用不同颜色区分(开始生产=绿色,暂停=红色)

**筛选功能** (可选):
- 按事件类型筛选:仅显示质检事件、仅显示状态变更
- 按操作人筛选:仅显示某个人的操作

**刷新功能**:
- 支持下拉刷新,获取最新事件
- 适用于批次仍在进行中时,实时查看最新操作

**操作入口**: BatchDetailScreen → "展开完整时间线"链接

**业务价值**:
- 追溯批次完整历史,了解批次经历了什么
- 审计用途:检查操作是否合规,责任人是谁
- 问题排查:批次失败时,回溯找出问题发生时间点和原因

---

#### 3.1.3 批次编号生成规则

**编号格式**: `{工厂代码}-{日期YYYYMMDD}-{当日序号}`

**格式说明**:
- **工厂代码**: 3-6位字母数字组合,唯一标识一个工厂
  - 示例:FAC001、FAC002、SHFC01(上海工厂)
- **日期**: 8位数字,YYYYMMDD格式,表示批次创建日期
  - 示例:20250105(2025年1月5日)
- **当日序号**: 3位数字,从001开始递增,每日重置
  - 示例:001、002、010、099

**完整示例**:
- FAC001-20250105-001 (2025年1月5日,FAC001工厂的第1个批次)
- FAC001-20250105-002 (2025年1月5日,FAC001工厂的第2个批次)
- FAC001-20250106-001 (2025年1月6日,FAC001工厂的第1个批次,序号重置)
- FAC002-20250105-001 (2025年1月5日,FAC002工厂的第1个批次,不同工厂独立编号)

**生成规则**:
- 时机:批次创建时,系统自动生成
- 唯一性:批次号在全系统唯一(跨工厂、跨日期)
- 不可修改:批次号一旦生成,永久不变,即使批次失败或取消
- 序号计算:查询当日已创建批次数量,序号=数量+1

**业务价值**:
- **日期可读性**: 批次号包含日期,一眼看出批次时间,便于管理和追溯
- **工厂隔离**: 包含工厂代码,支持多工厂环境,避免混淆
- **唯一性**: 确保每个批次号全局唯一,支持准确追溯
- **规范性**: 格式统一,便于扫描、录入、打印

---

#### 3.1.4 未来优化方向

**优化1: 批次模板功能** (优先级: P1,建议Phase 4实施)

**需求背景**: 工厂经常生产相同或类似产品(如每周都生产速冻鱼排),每次创建批次都需要重复填写相同的配置,耗时且容易出错

**功能描述**: 将常用批次配置保存为模板,创建批次时快速加载

**用户操作流程**:

**创建模板**:
1. 在BatchCreateScreen填写完整的批次配置
2. 点击"保存为模板"按钮
3. 输入模板名称(如:"速冻鱼排标准批次")
4. 选择模板可见范围(仅我使用/本部门使用/全工厂使用)
5. 保存模板

**使用模板**:
1. 在BatchCreateScreen点击"选择模板"按钮
2. 显示模板列表(我的模板/部门模板)
3. 选择"速冻鱼排标准批次"模板
4. 系统自动填充:产品类型、原材料列表、目标产量、生产线
5. 用户只需修改:开始日期、实际负责人、本次产量(如需调整)
6. 点击"创建批次"完成

**模板管理**:
- 编辑模板:修改模板配置
- 删除模板:删除不再使用的模板
- 模板分享:department_admin可将模板设为"部门模板",供部门所有人使用

**预期效果**:
- 创建批次时间从5分钟减少到1分钟(减少80%时间)
- 减少70%的表单输入工作
- 降低录入错误率

---

**优化2: 批次复制功能** (优先级: P2,建议Phase 5实施)

**需求背景**: 需要重复生产与某个历史批次完全相同的产品

**功能描述**: 基于已有批次快速创建新批次

**用户操作流程**:
1. 在BatchDetailScreen点击"复制批次"按钮
2. 系统自动创建新批次:
   - 生成新批次号(如:FAC001-20250106-001)
   - 复制所有配置(产品类型、原材料、目标产量、生产线等)
   - 开始日期设为今天
   - 负责人保持不变
3. 跳转到BatchEditScreen,用户可修改部分参数
4. 点击"创建"完成

**可修改的参数**:
- 目标产量(如原批次400kg,本次需要450kg)
- 负责人(如原负责人休假,换成其他人)
- 开始日期
- 备注

**业务价值**: 快速创建重复批次,节省配置时间,适合标准化生产

---

**优化3: 批次预测功能** (优先级: P2,建议Phase 5实施)

**需求背景**: 新手主管创建批次时,不知道目标产量和成本应该设多少

**功能描述**: 基于历史批次数据,为新批次提供产量和成本预测

**功能表现** (在BatchCreateScreen):

**场景1: 选择产品类型后显示预测信息**
- 用户选择产品类型:"速冻鱼排"
- 系统查询近30天该产品的历史批次数据(15个批次)
- 显示预测信息卡片(蓝色背景):
  - "📊 根据历史15个批次数据:"
  - "平均产量:420kg(范围:380-450kg)"
  - "平均成本:¥40.2/kg"
  - "建议目标产量设置为400-450kg"

**场景2: 输入目标产量后显示成本预测**
- 用户输入目标产量:400kg
- 系统预测成本:¥40.2×400=¥16,080
- 显示:"预计成本:¥16,080,建议售价:¥58/kg(利润率:30%)"

**场景3: AI推荐生产参数** (如果AI功能可用)
- 系统分析历史最优批次(成本最低、质量最高)
- 推荐生产参数:
  - "建议原料配比:鲈鱼500kg+盐5kg+配料3kg"
  - "建议生产时长:8-10小时"
  - "建议加工温度:88-92°C"

**预期效果**: 帮助新手主管创建批次,减少盲目性,提高计划准确性

---

### 3.2 质量检验模块

#### 3.2.1 模块定位

质量检验模块负责生产过程中的**质量控制**,覆盖三阶段质检(原料→过程→成品),确保产品质量符合标准。

**模块作用**:
- 实施质量管理,防止不合格产品流入市场
- 为批次状态流转提供质检判定
- 积累质检数据,分析质量趋势

**现有完成度**:
- ✅ 后端功能:100% 完成
- ❌ 前端页面:0% (4个页面全部待开发)

**待开发页面**:
1. **QualityInspectionListScreen** - 质检列表页 (优先级:P0,必须)
2. **QualityInspectionCreateScreen** - 创建质检页 (优先级:P0,必须)
3. **QualityInspectionDetailScreen** - 质检详情页 (优先级:P1,重要)
4. **QualityStatisticsScreen** - 质检统计页 (优先级:P2,次要)

---

#### 3.2.2 三阶段质检流程

质检贯穿生产全过程,分为三个阶段,每个阶段检测重点不同。

**阶段1: 原料质检 (Raw Material Inspection)**

**检测时机**: 原材料接收入库前(业务流程步骤2)

**检测人员**: 质检员

**检测目的**: 确保原材料质量合格,防止不合格原料进入生产

**检测项目**(3-5项):
- **感官检查**:
  - 外观:是否完整,有无破损、变形
  - 色泽:是否正常,有无变色、发黑
  - 气味:是否新鲜,有无异味、腐臭
- **温度检测**: 冷藏原料温度是否≤4°C(用温度计测量)
- **微生物检测**(部分批次抽检):大肠菌群、菌落总数

**判定标准**:
- **合格(pass)**: 所有检测项达标 → 允许入库使用
- **不合格(fail)**: 有严重问题(腐败变质、微生物严重超标) → 拒收退货
- **条件合格(conditional_pass)**: 轻微问题(如温度略高4.5°C但未变质) → 可降级使用

**检测工具**: 温度计、感官评价表、微生物检测仪(实验室)

**质检频率**: 每批原材料必检(100%覆盖)

**业务意义**: 源头质量控制,防止不合格原料进入生产,降低后续风险

---

**阶段2: 过程质检 (Process Inspection)**

**检测时机**: 生产过程中定期检测,建议每2-4小时检测一次(业务流程步骤7)

**检测人员**: 质检员

**检测目的**: 实时监控生产过程,及时发现参数偏离,避免批量质量问题

**检测项目**(3-5项):
- **加工温度**: 是否在标准范围(如鱼排加工:85-95°C)
- **pH值**: 是否在6.5-7.5之间(用pH计测量)
- **水分含量**: 是否≤75%(用水分测定仪)
- **加工时间**: 是否符合工艺要求(如不少于10分钟)

**判定标准**:
- **合格(pass)**: 所有参数在正常范围内 → 继续生产
- **不合格(fail)**: 参数严重偏离(如温度<80°C或>100°C) → 需要停产调整

**检测工具**: 温度计、pH计、水分测定仪

**质检频率**: 根据批次时长,建议2-4小时检测一次,长时间生产(>8小时)至少检测3次

**异常处理**:
- 过程质检不合格时,质检员通知生产主管
- 主管评估严重程度:
  - 轻微偏离(如温度84°C,标准85°C) → 调整参数后继续
  - 严重偏离(如温度75°C) → 暂停生产,排查原因
- 如需暂停,主管在BatchDetailScreen点击"暂停生产",填写原因:"过程质检不合格,温度过低"

**业务意义**: 过程控制,实时发现和纠正问题,避免大批量返工或报废

---

**阶段3: 成品质检 (Final Product Inspection)**

**检测时机**: 批次生产完成后,批次状态为quality_check时(业务流程步骤9)

**检测人员**: 质检员

**检测目的**: 确保成品质量符合标准,决定批次能否出库销售,是质量管理的最后一道防线

**检测项目**(10+项,最全面):

**感官检查**:
- 色泽:是否金黄、有无发黑
- 气味:是否正常、有无异味
- 外观:形状是否完整、有无破损
- 口感:抽样试吃,口感是否正常

**理化指标检测**:
- 蛋白质含量:标准≥15%(用蛋白质测定仪)
- 脂肪含量:标准≤5%(用脂肪测定仪)
- 水分含量:标准≤75%(用水分测定仪)

**微生物检测**:
- 大肠菌群:标准≤100CFU/g(送实验室检测)
- 沙门氏菌:标准不得检出(送实验室检测)
- 菌落总数:标准≤10000CFU/g

**重量检测**:
- 单位重量检测:如鱼排单个重量应为100±5g
- 抽样称重10个产品,计算平均值

**包装检查**:
- 包装完整性:有无破损、漏气
- 真空度:真空包装是否合格
- 标签正确性:生产日期、保质期、产品信息是否正确

**判定标准**:
- **合格(pass)**: 所有检测项达标 → 批次变为completed,允许出库
- **不合格(fail)**: 有关键项不达标(如微生物超标) → 批次变为failed,产品报废或返工
- **条件合格(conditional_pass)**: 部分轻微问题(如重量略有偏差95g,标准100±5g) → 可降级处理(A级→B级)

**检测工具**: 理化分析仪、微生物检测仪、电子秤、真空度测试仪

**质检频率**: 每个批次必做(100%覆盖),是批次能否出库的关键判定

**业务意义**: 最终质量把关,确保成品符合标准,保护品牌声誉和消费者健康

---

#### 3.2.3 质检判定逻辑

**自动评分系统**:

**评分计算**: 质量评分 = 合格检测项数量 ÷ 总检测项数量 × 100

**示例**:
- 总共10个检测项
- 9个合格,1个不合格
- 质量评分 = 9÷10×100 = 90分

**评分等级**:
- 100分:完美,所有项目合格
- 90-99分:优秀,有1-2项轻微不合格
- 80-89分:良好,有多项轻微不合格
- <80分:不合格,有严重问题或多项不合格

---

**自动判定规则**:

**规则1: 全部合格** ✅
- 条件:所有检测项都合格
- 结果:判定为"合格(pass)",质量评分=100分
- 页面显示:绿色"合格"徽章

**规则2: 严重不合格项** ❌
- 条件:存在严重不合格项(大肠菌群超标、沙门氏菌检出、重金属超标)
- 结果:判定为"不合格(fail)",无论其他项是否合格
- 页面显示:红色"不合格"徽章,突出显示严重不合格项

**规则3: 轻微不合格** ⚠️
- 条件:不合格项≤2项,且无严重不合格项
- 结果:判定为"条件合格(conditional_pass)",质量评分=80-99分
- 页面显示:黄色"条件合格"徽章,列出不合格项
- 处理建议:"可降级处理(A级→B级)"

**规则4: 多项不合格** ❌
- 条件:不合格项>2项
- 结果:判定为"不合格(fail)",质量评分<80分
- 页面显示:红色"不合格"徽章,列出所有不合格项

---

**质检员操作流程**:

1. 在QualityInspectionCreateScreen创建质检记录
2. 选择批次和质检类型
3. 逐项录入检测结果(输入实际值)
4. 系统实时判定每个检测项是否合格:
   - 温度检测:标准≤4°C,实际值3.5°C → 合格(绿色对勾)
   - 大肠菌群:标准≤100CFU/g,实际值150CFU/g → 不合格(红色叉号)
5. 系统自动计算质量评分(如90分)
6. 系统自动判定总体结果(如:不合格,因大肠菌群超标)
7. 质检员可以手动调整总体结果(特殊情况):
   - 点击"手动调整"按钮
   - 选择调整后结果(如改为条件合格)
   - 必须填写调整原因(如:"虽然微生物略超标,但在可接受范围,可降级使用")
   - 调整会记录审计日志
8. 提交质检记录

**业务价值**: 标准化质检流程,减少主观判断,提高质检一致性,同时保留灵活性

---

#### 3.2.4 质检数据管理

**质检记录列表** (QualityInspectionListScreen):

**列表展示**:
- 质检记录卡片布局
- 显示信息:批次号、产品类型、质检类型、质检结果、质量评分、质检日期、质检员

**筛选功能**:
- 按质检类型筛选(标签页):全部/原料质检/过程质检/成品质检
- 按质检结果筛选:全部/合格/不合格/条件合格
- 按日期范围筛选
- 按批次筛选(输入批次号)
- 按质检员筛选

**搜索功能**:
- 搜索批次号或质检员姓名

**分页加载**: 每页20条,下拉刷新,上拉加载更多

**业务价值**: 查询历史质检记录,分析质检情况

---

**质检记录详情** (QualityInspectionDetailScreen):

**展示内容**:

**基本信息**:
- 批次号(可点击跳转到BatchDetailScreen)
- 产品类型
- 质检类型(原料/过程/成品)
- 质检日期和时间
- 质检员姓名

**检测项结果**:
- 列表展示所有检测项
- 每项显示:检测项名称、标准值、实际值、单项结果(合格/不合格)
- 不合格项用红色标识

**质量评分**:
- 大数字显示评分(如95分)
- 环形进度条可视化
- 评分说明(如:"优秀")

**判定结果**:
- 结果徽章(合格/不合格/条件合格)
- 如果不合格,显示不合格原因

**质检照片**:
- 照片网格展示(3列)
- 点击照片查看大图
- 支持左右滑动浏览

**缺陷信息**(如有不合格项):
- 缺陷详情(文字描述)
- 缺陷类型(标签,如:微生物超标、色泽异常)
- 纠正措施(文字描述)

**操作按钮**:
- "查看批次详情"(跳转到BatchDetailScreen)

**业务价值**: 查看质检完整信息,用于质量追溯和问题分析

---

**质检统计分析** (QualityStatisticsScreen):

**功能描述**: 统计分析质检数据,发现质量趋势和问题

**时间范围选择**: 今日/本周/本月/自定义范围

**关键指标卡片**:
- 今日质检次数:15次
- 今日合格率:93%(14合格/15总数)
- 本周合格率:95%(趋势:+2%,绿色向上箭头)
- 本周质检次数:86次

**图表1: 质检合格率趋势图**(折线图)
- 横轴:日期(近7天或30天)
- 纵轴:合格率(%)
- 折线:显示合格率变化趋势
- 目标线:95%合格率目标(红色虚线)
- 业务意义:掌握质量趋势,评估质量改进措施效果

**图表2: 不合格项TOP10**(横向柱状图)
- 显示最常见的10种不合格项
- 柱状图显示每种不合格项的出现次数
- 示例:大肠菌群超标(8次)、温度偏高(5次)、色泽异常(3次)
- 业务意义:找出质量薄弱环节,针对性改进

**图表3: 质检员绩效排名**(列表+评分)
- 显示所有质检员的绩效
- 排序依据:质检合格率
- 显示信息:质检员姓名、质检次数、合格率、平均质量评分
- 示例:张三(质检30次,合格率97%,平均评分96分)
- 业务意义:激励质检员,评估质检员能力

**按产品类型统计** (可选查看):
- 速冻鱼排:质检20次,合格率95%
- 鱼丸:质检10次,合格率90%
- 业务意义:分析不同产品的质量稳定性

**导出功能**:
- 导出质检统计报表(PDF或Excel)
- 用于质量管理会议和质量报告

**业务价值**: 数据驱动的质量管理,发现质量规律,持续改进

---

#### 3.2.5 未来优化方向

**优化1: 质检模板功能** (优先级: P1)

**需求背景**: 不同产品类型有不同的检测项,质检员每次都需要手动添加检测项,耗时且容易遗漏

**功能描述**: 按产品类型预设检测项模板,自动加载

**优化前**:
- 质检员创建成品质检记录
- 手动添加检测项:温度、pH、蛋白质、脂肪、大肠菌群...共10项
- 每项设置标准值和单位
- 耗时约5分钟

**优化后**:
- 质检员选择批次后,系统自动识别产品类型(速冻鱼排)
- 系统自动加载"速冻鱼排成品质检模板"(包含10个预设检测项)
- 质检员只需录入检测结果(实际值),不需要添加检测项
- 耗时约1-2分钟

**模板配置** (由factory_super_admin配置):
- 产品类型:速冻鱼排
- 检测项列表:
  - 温度(标准:≤-15°C,单位:°C)
  - 蛋白质(标准:≥15%,单位:%)
  - 脂肪(标准:≤5%,单位:%)
  - ...

**预期效果**: 创建质检记录时间减少70%,减少遗漏检测项的风险

---

**优化2: 照片AI识别** (优先级: P3,探索性功能)

**需求背景**: 感官检查依赖质检员主观判断,不同质检员标准可能不一致

**功能描述**: 上传质检照片后,AI自动识别可见缺陷,辅助判定

**用户操作流程**:
1. 质检员在QualityInspectionCreateScreen上传成品照片
2. 系统调用AI图像识别API
3. AI分析照片内容(3-5秒)
4. AI返回识别结果:
   - "检测到色泽偏暗,建议判定为B级"
   - "检测到包装轻微破损,建议条件合格"
   - "未检测到明显缺陷"
5. 质检员参考AI建议,做出最终判定

**AI识别能力**:
- 色泽异常(发黑、发黄、发白)
- 外观缺陷(破损、变形、杂质)
- 包装问题(破损、漏气、标签错误)

**业务价值**: 减少主观判断差异,提高质检一致性,辅助新手质检员

---

**优化3: 质检提醒功能** (优先级: P2)

**需求背景**: 过程质检容易被忘记,成品质检有时延迟,影响生产效率

**功能描述**: 自动提醒质检员及时进行质检

**提醒场景1: 过程质检到期提醒**
- 触发条件:批次开始生产2小时后
- 推送对象:质检员
- 通知内容:"批次FAC001-20250105-001已生产2小时,请进行过程质检"
- 点击通知:跳转到QualityInspectionCreateScreen,自动选中该批次

**提醒场景2: 质检不合格自动通知主管**
- 触发条件:质检结果判定为fail时
- 推送对象:生产主管
- 通知内容:"批次FAC001-20250105-001过程质检不合格,温度偏低(80°C),请及时处理"
- 点击通知:跳转到BatchDetailScreen

**提醒场景3: 成品质检待处理提醒**
- 触发条件:批次进入quality_check状态24小时后仍未完成质检
- 推送对象:质检员
- 通知内容:"批次FAC001-20250105-001待质检已24小时,请尽快完成"
- 点击通知:跳转到QualityInspectionCreateScreen

**业务价值**: 确保质检及时性,避免遗漏,提高质量管理效率

---

**(文档继续,由于篇幅限制,下面继续编写剩余模块和章节)**

### 3.3 员工工作管理模块

#### 3.3.1 模块定位

员工工作管理模块负责**员工出勤管理**和**工时统计**,为人工成本计算和工资发放提供数据支持。

**模块作用**:
- 记录员工打卡(上班/下班)
- 统计员工工时(日/周/月)
- 关联员工工作与生产批次

**现有完成度**:
- ✅ 后端功能:100% 完成
- ✅ 前端页面:67% (TimeClockScreen和ClockHistoryScreen已完成)

**待开发页面**:
1. **WorkRecordScreen** - 工作记录页 (优先级:P2)

**核心页面**:
- TimeClockScreen (打卡主页) - ✅ 已完成
- ClockHistoryScreen (打卡历史) - ✅ 已完成

---

#### 3.3.2 员工打卡功能说明

**上班打卡完整流程**:

1. **打开打卡页面**: 员工到达工厂,打开App,进入TimeClockScreen
2. **点击打卡按钮**: 页面中央大按钮"上班打卡"(绿色)
3. **GPS定位**: 系统自动获取GPS位置(通常1-3秒),页面显示"定位中..."
4. **GPS围栏验证**:
   - 系统计算用户位置与工厂位置的距离
   - 如果距离≤500米,验证通过,继续下一步
   - 如果距离>500米,显示红色提示:"不在打卡范围(距离工厂1.2km),请到工厂后再打卡",阻止打卡
5. **选择工作类型**: 下拉选择器,选项:
   - 生产(默认选中)
   - 质检
   - 设备维护
   - 物料搬运
   - 清洁卫生
   - 培训
   - 其他
6. **关联批次**(如果选择"生产"):
   - 显示进行中(in_progress)的批次列表
   - 每个批次显示:批次号、产品类型
   - 用户选择今日参与的批次
   - 如果当前无进行中批次,显示"暂无进行中的批次,请联系主管"
7. **拍照**(可选): 点击"拍摄打卡照片"按钮,打开相机拍照
8. **提交打卡**: 点击"确认打卡"按钮
9. **成功反馈**:
   - 显示大对勾动画
   - 显示"打卡成功,开始工作!"
   - 显示当前时间:"打卡时间:08:32"
   - 震动反馈(Haptic)

**下班打卡完整流程**:

1. **打开打卡页面**: 员工下班时打开App,进入TimeClockScreen
2. **检查打卡状态**: 页面显示"已上班打卡,打卡时间:08:32,已工作8小时28分钟"
3. **点击打卡按钮**: 页面中央大按钮"下班打卡"(蓝色)
4. **GPS定位**: 系统自动获取GPS位置
5. **填写工作总结**(可选):
   - 多行文本框,placeholder:"今日完成的工作内容(可选)"
   - 示例:"完成批次FAC001-20250105-001的质检工作,合格率100%"
6. **拍照**(可选): 拍摄下班打卡照片
7. **提交打卡**: 点击"确认打卡"按钮
8. **成功反馈**:
   - 显示大对勾动画
   - 显示"打卡成功,辛苦了!"
   - 显示工时统计:"今日工作8小时30分钟(加班30分钟)"
   - 震动反馈

**打卡状态判定逻辑**:

**判定标准**:
- 正常上班时间:9:00
- 正常下班时间:17:00
- 标准工作时长:8小时

**状态判定**:
- **正常**: 8:30-9:00上班,17:00-17:30下班,工时7.5-8.5小时 → 绿色"正常"标签
- **迟到**: 9:00后上班 → 红色"迟到"标签,显示迟到时长"迟到15分钟"
- **早退**: 17:00前下班 → 红色"早退"标签,显示早退时长"早退30分钟"
- **加班**: 工时>8小时 → 蓝色"加班"标签,显示加班时长"加班1小时"

**GPS围栏功能**:
- 工厂设置GPS中心点坐标和允许半径(默认500米)
- 打卡时计算用户位置与中心点的距离
- 在范围内才允许打卡
- GPS信号弱时(<10米精度),提示"GPS信号弱,请移动到空旷位置"

**业务价值**: 准确记录出勤,防止代打卡和异地打卡,为工时统计提供可靠数据

---

#### 3.3.3 工时统计功能说明

员工和管理员需要查看工时数据,用于考勤管理和工资计算。

**功能1: 日工时统计**

**查看方式**: TimeStatisticsScreen,选择"日"标签页

**展示内容**:
- 选择日期:日历选择器,默认今天
- 总工时:8.5小时(大字号显示)
- 加班工时:0.5小时(如果>0,单独显示)
- 打卡状态:正常/迟到/早退/加班(彩色徽章)
- 打卡次数:2次(上班1次+下班1次,正常为2)
- 工作时段列表(如果有多个时段):
  - 时段1:08:30-12:00 (3.5小时,工作类型:生产,批次:FAC001-20250105-001)
  - 时段2:13:00-17:30 (4.5小时,工作类型:生产,批次:FAC001-20250105-001)

**查看权限**:
- operator:只能查看自己的日工时
- department_admin:可选择查看本部门任意员工的日工时(用于审核)

**业务用途**: 员工查看自己的出勤,管理员审核员工工时

---

**功能2: 周工时统计**

**查看方式**: TimeStatisticsScreen,选择"周"标签页

**展示内容**:
- 选择周:周选择器,默认本周(周一到周日)
- 本周总工时:44小时(大字号)
- 本周工作天数:5天(排除周末)
- 平均每日工时:8.8小时
- 本周加班工时:4小时
- 每日工时柱状图:
  - 横轴:周一到周日
  - 纵轴:工时(小时)
  - 柱子颜色:正常工时(绿色),加班工时(蓝色叠加)
  - 周末显示灰色(如果有加班,显示加班工时)

**业务用途**: 员工了解本周工作量,管理员监控部门工作饱和度

---

**功能3: 月工时统计**

**查看方式**: TimeStatisticsScreen,选择"月"标签页

**展示内容**:
- 选择月份:月选择器,默认本月
- 本月总工时:176小时(大字号)
- 本月工作天数:22天
- 应出勤天数:22天(系统计算本月工作日,排除周末和法定节假日)
- 出勤率:100% (22天全勤)
- 本月加班工时:16小时
- 每日工时日历视图:
  - 日历格式显示每天的工时
  - 正常工时显示绿色数字(如:"8.0h")
  - 缺勤日期显示红色"缺勤"
  - 加班日期显示蓝色边框
  - 周末显示灰色背景

**导出功能**:
- "导出月度工时报表"按钮
- 生成Excel文件,包含列:日期、上班时间、下班时间、工时、加班时长、工作类型、关联批次
- 用于财务部门计算工资

**查看权限**:
- operator:可查看和导出自己的月工时
- department_admin:可查看和导出本部门所有员工的月工时(用于薪资核算)

**业务用途**: 薪资核算、考勤管理、员工绩效评估的数据基础

---

#### 3.3.4 未来优化方向

**1. GPS围栏优化** (优先级: P1)
- 支持多个打卡点(不同车间可设置不同GPS中心点)
- GPS信号弱时,允许手动打卡+后台审批机制
- 用户场景:员工在地下车间GPS信号差,可手动打卡,主管后台审批

**2. 班次管理** (优先级: P2)
- 支持多班次设置(早班7:00-15:00,中班15:00-23:00,夜班23:00-次日7:00)
- 系统自动识别员工所属班次并计算工时
- 不同班次的加班计算规则不同

**3. 工时导出优化** (优先级: P2)
- 支持批量导出多个员工的工时报表
- 支持自定义报表格式(选择导出字段)
- 支持定时自动导出(如每月1号自动生成上月工时报表)

---

### 3.4 设备监控模块

#### 3.4.1 模块定位

设备监控模块负责**设备状态监控**和**设备告警管理**,保障生产设备正常运行。

**模块作用**:
- 实时监控设备运行参数(温度、湿度、压力等)
- 自动检测参数异常并告警
- 记录设备使用情况,支持成本计算
- 管理设备维护

**现有完成度**:
- ✅ 后端功能:100% 完成
- ❌ 前端页面:0% (4个页面全部待开发)

**待开发页面**:
1. **EquipmentListScreen** - 设备列表页 (优先级:P1)
2. **EquipmentMonitoringScreen** - 实时监控页 (优先级:P0,必须)
3. **EquipmentDetailScreen** - 设备详情页 (优先级:P1)
4. **EquipmentAlertsScreen** - 设备告警页 (优先级:P0,必须)

---

#### 3.4.2 设备监控核心功能

**功能1: 设备列表管理**

**功能描述**: 查看工厂所有生产设备及其实时状态

**列表布局**: 卡片式布局

**单个设备卡片包含**:
- 设备名称(如:"1号速冻机")
- 设备编号(如:EQ001)
- 设备类型(速冻机/切割机/包装机等)
- 状态指示灯(实时更新):
  - 🟢 绿灯(正常):所有参数正常
  - 🟡 黄灯(警告):部分参数接近阈值
  - 🔴 红灯(故障):参数严重超标或设备停机
  - ⚪ 灰灯(离线/维护中):设备未连接
- 关键参数快速预览(如:温度:-18°C)

**筛选功能**:
- 按状态筛选:全部/正常/警告/故障/维护中
- 按设备类型筛选:速冻机/切割机/包装机/传送带/其他
- 按位置筛选:车间A/车间B

**排序功能**:
- 按状态排序(故障设备优先显示)
- 按设备编号排序

**快捷操作**:
- 点击设备卡片 → 查看设备详情(EquipmentDetailScreen)
- 长按设备 → 快捷菜单(查看监控/报修/查看告警)

**实时更新**: 每30秒自动刷新设备状态,状态变化时卡片闪烁提示

**业务价值**: 全局掌握设备状态,快速定位故障设备

---

**功能2: 设备实时监控**

**功能描述**: 实时查看多台设备的运行参数,及时发现异常

**页面布局** (EquipmentMonitoringScreen):
- 网格布局,一个屏幕显示3-4台设备
- 每台设备一个监控卡片
- 支持左右滑动查看更多设备

**单个监控卡片内容**:

**设备头部**:
- 设备名称:"1号速冻机"
- 状态指示灯(实时闪烁)
- 最后更新时间:"10秒前"

**实时参数展示**(大数字+单位):
- **温度**: -18°C (标准:-15~-22°C)
  - 参数在范围内:绿色数字
  - 参数接近阈值:黄色数字
  - 参数超标:红色数字并闪烁
- **湿度**: 75% (标准:60-80%)
- **压力**: 101kPa (标准:95-105kPa)
- **运行时长**: 2.5小时(本次连续运行)

**实时曲线图**:
- 显示最近1小时的温度变化曲线
- 横轴:时间(每5分钟一个点)
- 纵轴:温度值
- 绿色区域:标准范围(-15°C ~ -22°C)
- 蓝色曲线:实际温度变化
- 超出范围的点用红色标识

**自动刷新**:
- 每30秒自动请求最新数据
- 刷新时显示Loading小图标
- 页面顶部显示"最后更新:10秒前"

**告警提示**(如有异常):
- 卡片边框变红并闪烁
- 顶部显示红色告警条:"温度过高(-10°C),已超过标准值"
- 告警铃声(可选,用户可在设置中关闭)

**手动刷新**: 下拉刷新,立即获取最新数据

**业务价值**: 实时掌握设备运行状态,及时发现异常参数,避免设备故障和产品质量问题

---

**功能3: 设备详情查看**

**功能描述**: 查看单个设备的完整信息和历史数据

**页面布局** (EquipmentDetailScreen):

**区域1: 基本信息卡片**
- 设备编号:EQ001
- 设备名称:1号速冻机
- 设备类型:速冻机
- 安装位置:车间A-生产线A
- 购买日期:2023-05-15
- 使用年限:2年
- 设备规格:功率5kW,容量500kg/批

**区域2: 当前运行状态卡片**
- 状态徽章(正常/故障/维护中/离线)
- 当前运行参数:温度-18°C、湿度75%、压力101kPa
- 本次连续运行时长:2小时30分钟
- 累计运行时长:3650小时(总计)

**区域3: 参数历史曲线卡片**
- 时间范围选择器:近24小时/近7天/近30天
- 多参数折线图(温度、湿度、压力三条曲线叠加)
- 异常时段用红色背景标识

**区域4: 运行时长统计卡片**
- 本周累计运行时长:40小时
- 本月累计运行时长:160小时
- 设备利用率:66% (160小时÷(30天×8小时)×100%)

**区域5: 维护记录卡片**
- 维护历史列表(最近10次)
- 每条显示:维护日期、维护内容、维护人员、维护时长
- 下次计划维护日期:2025-02-01(如临近,显示红色提醒"距离维护还有5天")

**区域6: 使用记录卡片**
- 最近使用的批次列表(最近10个)
- 每条显示:批次号、产品类型、使用时长、使用日期
- 点击批次号 → 跳转到BatchDetailScreen

**区域7: 告警历史卡片**
- 最近告警列表(最近20条)
- 每条显示:告警时间、告警类型、严重程度、处理状态
- 点击告警 → 跳转到告警详情

**底部操作按钮**:
- "开始维护":设置设备状态为维护中
- "报修":创建维修工单(如果有维修模块)
- "查看实时监控" → 跳转到EquipmentMonitoringScreen

**业务价值**: 全面了解设备信息,支持设备维护决策,分析设备使用效率

---

**功能4: 设备告警管理**

**功能描述**: 管理设备告警,确保及时发现和处理异常

**告警列表展示** (EquipmentAlertsScreen):

**列表布局**: 告警卡片式布局,按时间倒序

**单个告警卡片包含**:
- 严重程度徽章(彩色):
  - 🔴 严重(critical):红色,设备故障、温度严重超标
  - 🟠 高(high):橙色,参数严重偏离
  - 🟡 中(medium):黄色,参数轻微偏离
  - 🔵 低(low):蓝色,提示信息
- 告警标题:"1号速冻机温度过高"
- 告警消息:"当前温度-10°C,超过标准值-15°C,偏差5°C"
- 设备信息:设备名称+设备编号
- 触发时间:"2小时前"(相对时间)
- 告警状态徽章:
  - 红色"活动中"(active):未处理
  - 黄色"已确认"(acknowledged):已查看但未解决
  - 绿色"已解决"(resolved):已处理完成

**筛选功能**:
- 按严重程度筛选:全部/严重/高/中/低
- 按状态筛选:全部/活动中/已确认/已解决
- 按设备筛选:多选设备
- 按日期范围筛选

**告警操作**:

**操作1: 确认告警**
- 适用:active(活动中)状态的告警
- 权限:department_admin及以上
- 操作:点击"确认"按钮
- 效果:告警状态变为acknowledged,卡片颜色从红变黄
- 业务意义:表示管理员已知晓,正在处理

**操作2: 解决告警**
- 适用:acknowledged(已确认)状态的告警
- 权限:department_admin及以上
- 操作:
  1. 点击"标记已解决"按钮
  2. 弹窗要求填写"处理说明"(必填)
  3. 示例:"已调整设备温度设置,现已恢复正常"
  4. 提交后,告警状态变为resolved,卡片变绿色
- 业务意义:记录问题处理情况,用于设备故障分析

**通知机制**:
- 新告警产生时,App推送通知给相关人员
- 严重告警(critical):推送给生产主管+工厂超管
- 一般告警(high/medium):推送给设备操作员
- 低级告警(low):不推送,仅在告警列表显示

**业务价值**: 及时发现和处理设备异常,减少停机时间,保障生产连续性

---

#### 3.4.3 告警自动触发说明

**触发时机**: 设备监控系统采集到新的监控数据时,自动检查是否超过阈值

**触发流程**:

1. **数据采集**: 设备传感器每隔1分钟采集一次数据(温度、湿度、压力等)
2. **数据上报**: 传感器将数据上报到监控系统
3. **阈值对比**: 系统读取该设备的告警阈值配置,逐项对比
4. **判定告警严重程度**:
   - 根据参数偏离标准值的程度,判定告警级别
   - 偏离越大,级别越高
5. **创建告警记录**: 如果超过阈值,创建告警记录
6. **推送通知**: 根据严重程度,推送给不同人员
7. **自动响应**(仅严重告警): 如果是critical级别,自动暂停相关批次

**告警阈值配置示例** (1号速冻机温度告警):

**标准温度范围**: -15°C 到 -22°C

**告警阈值**:
- **低(low)**: 温度在-13°C ~ -15°C或-22°C ~ -24°C → 黄色告警
- **中(medium)**: 温度在-10°C ~ -13°C或-24°C ~ -26°C → 橙色告警
- **高(high)**: 温度在-8°C ~ -10°C或<-26°C → 橙红色告警
- **严重(critical)**: 温度>-8°C → 红色告警+自动暂停批次

**告警去重逻辑**:
- 相同类型的告警在5分钟内只触发一次,避免告警轰炸
- 示例:温度持续偏高,只在第一次超标时告警,后续5分钟内不重复告警
- 如果参数恢复正常后再次超标,重新告警

**自动暂停批次** (仅critical级别告警):
- 触发条件:告警严重程度为critical
- 自动操作:
  1. 查找正在使用该���备的批次(状态=in_progress)
  2. 将批次状态变更为paused
  3. 记录暂停原因:"设备EQ001严重故障(温度过高),自动暂停"
  4. 推送通知给批次负责人和生产主管
- 恢复操作:设备故障解决后,主管手动点击"恢复生产"

**业务价值**: 自动化监控和告警,及时发现设备异常,减少人工巡检成本,避免设备故障导致的质量问题和生产损失

---

#### 3.4.4 未来优化方向

**1. 实时数据推送** (优先级: P1)
- 使用WebSocket连接,服务器实时推送监控数据
- 前端图表实时更新,无需30秒刷新
- 用户体验:监控数据流畅更新,响应更及时

**2. 设备维护提醒** (优先级: P2)
- 定期维护到期提醒:维护日期前7天推送提醒
- 运行时长达标提醒:累计运行500小时后提醒维护
- 预防性维护:基于运行时长和故障频率,智能推荐维护时间

**3. 设备使用分析** (优先级: P2)
- 设备利用率统计:分析哪些设备利用率高,哪些闲置
- 设备故障率分析:统计故障频率,识别易故障设备
- 设备投资回报分析:设备成本vs产出,评估设备投资价值

---

### 3.5 成本核算模块

#### 3.5.1 模块定位

成本核算模块负责**自动计算批次成本**,提供**成本分析**和**AI优化建议**。

**模块作用**:
- 精细化成本管理,为定价提供数据支持
- 提供成本分析,发现成本问题
- 利用AI技术,提供成本优化建议

**现有完成度**:
- ✅ 后端功能:80% (成本计算完成,AI分析使用Mock数据)
- ✅ 前端页面:33% (CostAnalysisDashboard已完成)

**待开发页面**:
1. **BatchCostDetailScreen** - 批次成本详情页 (优先级:P0,必须)
2. **CostTrendScreen** - 成本趋势分析页 (优先级:P1)

**需要优化**:
- DeepSeek AI真实集成(替换Mock数据)
- 成本对比功能(与目标成本、历史平均对比)

---

#### 3.5.2 成本构成详解

生产成本由**四项要素**组成,每项占比不同:

**1. 原料成本 (占40-50%,最大成本项)**

**数据来源**: 批次创建时用户录入的原材料成本总和

**计算方式**: 累加每种原材料的成本

**示例**:
- 鲈鱼:500kg × ¥30/kg = ¥15,000
- 盐:5kg × ¥5/kg = ¥25
- 配料:3kg × ¥20/kg = ¥60
- 原料成本 = ¥15,085

**成本占比**: 通常占总成本的40-50%,是最大的成本项

**优化方向**: 原料议价、供应商选择、批量采购

---

**2. 人工成本 (占30-40%)**

**数据来源**: 系统自动统计关联此批次的工作时段记录

**计算方式**: 累加每个员工的工时×时薪,加班按1.5倍计算

**时薪标准**:
- 普通操作员:¥20/小时
- 熟练操作员:¥25/小时
- 班长/主管:¥30/小时

**示例**:
- 张三(普通):8小时 × ¥20/小时 = ¥160
- 李四(熟练):8小时 × ¥25/小时 = ¥200
- 王五(班长):8小时 × ¥30/小时 = ¥240
- 加班工时:2小时 × ¥22.5/小时(平均) × 1.5 = ¥67.5
- 人工成本 = ¥667.5

**成本占比**: 通常占总成本的30-40%

**优化方向**: 提高生产效率、优化生产流程、员工培训

---

**3. 设备成本 (占10-20%)**

**数据来源**: 系统自动统计关联此批次的设备使用记录

**计算方式**: 累加每台设备的使用时长×折旧率

**折旧率说明**: 设备购买价格 ÷ 预计使用总小时数 = 折旧率(元/小时)
- 示例:100万元设备,使用10年,每年300天,每天8小时
- 预计使用总小时 = 10年×300天×8小时 = 24,000小时
- 折旧率 = ¥1,000,000 ÷ 24,000 = ¥41.67/小时

**示例**:
- 1号速冻机:使用6小时 × ¥41.67/小时 = ¥250
- 2号切割机:使用4小时 × ¥20/小时 = ¥80
- 设备成本 = ¥330

**成本占比**: 通常占总成本的10-20%

**优化方向**: 提高设备利用率、避免设备空转、合理安排批次

---

**4. 其他成本 (占5-10%)**

**包含项目**: 能耗(电费、水费)、包装材料、物流运输、质检费用等

**计算方式**: 暂按前三项总和的5%估算(未来可配置详细成本项)

**示例**:
- (¥15,085 + ¥667.5 + ¥330) × 5% = ¥804

**成本占比**: 通常占总成本的5-10%

---

**总成本与单位成本**:

**总成本计算**:
- 总成本 = 原料成本 + 人工成本 + 设备成本 + 其他成本
- 示例:¥15,085 + ¥667.5 + ¥330 + ¥804 = ¥16,887

**单位成本计算**:
- 单位成本 = 总成本 ÷ 实际产量(元/kg)
- 示例:¥16,887 ÷ 420kg = ¥40.21/kg

**利润计算**(如果有预期售价):
- 利润率 = (预期售价 - 单位成本) ÷ 预期售价 × 100%
- 示例:预期售价¥58/kg → 利润率 = (¥58 - ¥40.21) ÷ ¥58 × 100% = 30.7%
- 利润额 = 实际产量 × (预期售价 - 单位成本)
- 示例:420kg × (¥58 - ¥40.21) = ¥7,472

---

#### 3.5.3 成本分析功能

**功能1: 批次成本详情**

**功能描述**: 查看单个批次的成本构成和明细,是成本管理的核心页面

**页面布局** (BatchCostDetailScreen):

**区域1: 成本摘要卡片**(3个大数字卡片):
- **总成本**: ¥16,887 (大字号,醒目显示)
- **单位成本**: ¥40.21/kg
- **利润率**: 30.7% (绿色表示盈利,红色表示亏损)

**区域2: 成本构成饼图**
- 可视化显示四项成本的占比
- 饼图颜色:原料(红色)、人工(蓝色)、设备(绿色)、其他(灰色)
- 每个扇形显示:名称+金额+占比
- 点击扇形,高亮显示对应成本项

**区域3: 成本明细列表**(可展开/折叠):

**原料成本明细**:
- 总计:¥15,085 (89.3%)
- 展开明细:
  - 鲈鱼:500kg × ¥30/kg = ¥15,000
  - 盐:5kg × ¥5/kg = ¥25
  - 配料:3kg × ¥20/kg = ¥60

**人工成本明细**:
- 总计:¥667.5 (4.0%)
- 总工时:30小时
- 参与员工:4人
- 展开明细:
  - 张三:8h × ¥20/h = ¥160
  - 李四:8h × ¥25/h = ¥200
  - ...

**设备成本明细**:
- 总计:¥330 (2.0%)
- 使用设备:2台
- 展开明细:
  - 1号速冻机:6h × ¥41.67/h = ¥250
  - 2号切割机:4h × ¥20/h = ¥80

**其他成本**:
- 总计:¥804 (4.8%)
- 说明:能耗、包装等,按前三项5%估算

**区域4: 成本对比卡片**:

**与目标成本对比**:
- 目标成本:¥38.00/kg
- 实际成本:¥40.21/kg
- 差异:+¥2.21/kg (超出5.8%) 用红色显示
- 超标金额:¥928 (420kg × ¥2.21)

**与历史平均对比**:
- 历史平均成本:¥39.50/kg (近30天15个批次)
- 实际成本:¥40.21/kg
- 差异:+¥0.71/kg (高1.8%) 用黄色显示

**区域5: AI智能分析区域**:

- "AI智能分析"按钮(蓝色,prominent)
- 点击后:
  - 显示Loading:"AI分析中...预计3-5秒"
  - 分析完成后显示AI报告(见下节)

**业务价值**: 深入了解成本构成,发现成本问题,为优化提供数据基础

---

**功能2: AI成本分析**

**功能描述**: 利用DeepSeek AI分析批次成本,提供优化建议

**使用场景**: 批次完成后,主管希望了解成本是否合理,有无优化空间

**操作流程**:
1. 在BatchCostDetailScreen查看成本详情
2. 点击"AI智能分析"按钮
3. 系统显示Loading动画:"AI分析中..."
4. 3-5秒后显示分析结果(弹出底部抽屉或新区域)

**AI分析报告内容**:

**1. 成本评估**:
"本批次单位成本¥40.21/kg,比目标成本¥38.00/kg高5.8%,成本超标¥928"

**2. 成本构成分析**:
- "原料成本占89%,**明显偏高**(正常范围40-50%)"
- "人工成本占4%,**低于正常水平**(正常范围30-40%),生产效率很高"
- "设备成本占2%,正常"

**3. 历史对比**:
- "本批次成本比近30天同产品平均成本(¥39.50/kg)高1.8%"
- "主要差异在原料成本,高出¥450"

**4. 问题识别**:
- "原料成本偏高的可能原因:"
  - "原料单价上涨:从¥28/kg涨到¥30/kg(上涨7%)"
  - "原料用量偏多:本批次用料508kg,历史平均500kg"

**5. 优化建议**(3-5条):
1. "建议与供应商重新议价,原料价格比上月高7%,可尝试批量采购获得折扣"
2. "建议优化原料使用,本批次用料508kg,历史平��500kg,存在8kg浪费"
3. "建议保持当前生产效率,人工成本控制良好"
4. "建议适当提高目标产量至450kg,摊薄固定成本(人工、设备)"

**AI分析成本控制**:
- **缓存策略**: 相同批次5分钟内查询,从缓存返回(节省API费用)
- **显示提示**: "(使用缓存结果,节省¥0.02)"
- **月度预算**: AI分析总费用控制在¥30/月以内
- **降级策略**: 月预算用完后,自动切换到规则引擎(简单的成本对比分析,不调用AI)
- **降级提示**: "本月AI预算已用完,使用基础分析(下月1号自动恢复AI分析)"

**业务价值**: 利用AI技术快速发现成本问题和优化机会,提供可执行的建议,支持数据驱动的成本管理

---

**功能3: 成本趋势分析**

**功能描述**: 分析一段时间内的成本变化趋势,发现成本规律

**页面布局** (CostTrendScreen):

**时间范围选择**:
- 标签页:近7天/近30天/近90天
- 自定义范围:日期选择器,选择起止日期

**图表1: 单位成本趋势折线图**
- 横轴:日期
- 纵轴:单位成本(元/kg)
- 折线:显示每个批次的单位成本
- 平均线:显示平均成本(红色虚线)
- 目标线:显示目标成本(绿色虚线)
- 数据点:点击查看该批次详情
- 业务意义:掌握成本变化趋势,识别成本上涨/下降

**图表2: 成本对比柱状图**
- 对比不同产品类型的平均成本
- 横轴:产品类型(速冻鱼排、鱼丸、鱼糜)
- 纵轴:平均单位成本
- 柱子显示:本月平均vs上月平均
- 业务意义:对比不同产品的成本,识别高成本产品

**图表3: 成本构成堆叠图**
- 显示原料、人工、设备成本随时间的变化
- 横轴:日期
- 纵轴:成本金额
- 堆叠柱状图:每个柱子分三段(原料/人工/设备)
- 业务意义:分析成本结构变化,如人工成本逐月上升

**成本预警区域**:
- 成本超标预警:单位成本>目标成本时,显示红色警告
- 成本异常预警:成本突然上涨>20%时,显示黄色提示
- 提醒内容:"2025-01-03批次成本异常偏高(¥52/kg),高出平均成本32%,建议排查原因"

**导出功能**:
- "导出成本趋势报告"按钮
- 生成PDF报告,包含所有图表和数据表
- 用于成本分析会议

**业务价值**: 掌握成本变化规律,评估成本优化措施效果,支持管理决策

---

#### 3.5.4 未来优化方向

**1. DeepSeek AI真实集成** (优先级: P0,必须完成)
- 替换当前的Mock数据
- 集成真实DeepSeek API
- 实现缓存和预算控制
- 预期完成时间:Week 5

**2. 成本对比功能增强** (优先级: P1)
- 增加"同类批次对比"(选择相似批次,对比成本)
- 增加"成本构成对比"(对比不同批次的成本结构差异)
- 增加"成本排名"(显示成本最低和最高的批次)

**3. 成本预测功能** (优先级: P2)
- 基于历史数据,预测未来成本趋势
- 提前发现成本上涨风险
- 建议成本控制措施

---

### 3.6 生产仪表板模块

#### 3.6.1 模块定位

生产仪表板是生产模块的**主入口**,提供生产数据的可视化展示和快速导航。

**模块作用**:
- 一屏掌握生产全局
- 快速进入各功能模块
- 展示关键生产指标

**现有完成度**:
- ✅ 后端功能:100% 完成
- ✅ 前端页面:50% (ProcessingDashboardScreen已完成,需优化)

**待开发页面**:
1. **ProductionStatisticsScreen** - 生产统计详情页 (优先级:P2)

---

#### 3.6.2 仪表板核心指标

ProcessingDashboardScreen显示生产全局数据,是生产管理的"驾驶舱"。

**时间维度切换**:
- 标签页:今日/本周/本月
- 切换后,所有指标数据自动更新

**指标区域1: 生产概览**

**今日生产批次**:
- 数值:8个(大字号)
- 趋势:"+2 比昨日"(绿色向上箭头)
- 点击 → BatchListScreen(筛选今日创建的批次)

**今日完成批次**:
- 数值:5个
- 点击 → BatchListScreen(筛选今日完成的批次)

**今日产量**:
- 数值:2,100kg
- 趋势:"+300kg 比昨日"
- 点击 → ProductionStatisticsScreen

**今日合格率**:
- 数值:96%
- 颜色:绿色(>95%),黄色(90-95%),红色(<90%)
- 点击 → QualityStatisticsScreen

---

**指标区域2: 质量概览**

**质检次数**: 今日质检15次

**质检合格率**: 93% (14合格/15总数)

**不合格项TOP3**:
1. 温度偏高(3次)
2. 色泽异常(2次)
3. 包装破损(1次)
- 点击 → QualityStatisticsScreen(查看详情)

---

**指标区域3: 成本概览**

**今日总成本**: ¥85,200

**平均单位成本**: ¥40.5/kg

**成本超标批次**: 2个(显示红色警告数字)
- 点击 → BatchListScreen(筛选成本超标的批次)

---

**指标区域4: 人员概览**

**在岗人数**: 28人(实时统计当前已上班未下班的员工)

**今日总工时**: 224小时

**平均效率**: 85% (如果有效率数据)

---

**指标区域5: 设备概览**

**设备在线数**: 8/10台 (8台在线,10台总数)

**设备故障数**: 1台(红色显示,点击查看故障设备)

**活动告警数**: 3条(显示数字,点击 → EquipmentAlertsScreen)

---

**快速导航**:
- 点击各指标卡片,跳转到对应的详情页面
- 下方显示功能模块入口:
  - "批次管理" → BatchListScreen
  - "质检管理" → QualityInspectionListScreen
  - "设备监控" → EquipmentMonitoringScreen
  - "成本分析" → CostTrendScreen
  - "数据导出" → DataExportScreen

**自动刷新**:
- 仪表板数据每60秒自动刷新
- 显示"最后更新:30秒前"
- 支持手动下拉刷新

**业务价值**: 生产管理驾驶舱,一屏掌握生产全局,快速发现异常,及时决策

---

#### 3.6.3 未来优化方向

**1. 实时数据刷新** (优先级: P1)
- 将刷新间隔从60秒缩短到10秒
- 关键指标(如在岗人数、活动告警)实时更新

**2. 自定义仪表板** (优先级: P2)
- 用户自定义显示哪些指标
- 拖拽调整指标卡片的顺序和位置
- 保存个性化配置

**3. 数据导出优化** (优先级: P2)
- 支持导出仪表板快照(PDF)
- 支持邮件定时发送报表(如每日早上8点发送昨日生产报告)

---

## 前端页面设计

### 4.1 页面总览

生产模块共需**22个前端页面**,当前仅完成**4个页面**(18%完成度)。

**页面开发优先级**:

| 优先级 | 页面数 | 页面清单 | 说明 |
|-------|-------|---------|------|
| **P0 (必须)** | 7页 | 批次列表、批次详情、批次创建、质检创建、设备监控、设备告警、成本详情 | 核心功能,必须完成 |
| **P1 (重要)** | 8页 | 批次编辑、质检列表、质检详情、设备列表、设备详情、成本趋势、生产统计、工作记录 | 重要功能,建议完成 |
| **P2 (次要)** | 3页 | 批次时间线、质检统计、数据导出 | 次要功能,可后续补充 |
| **已完成** | 4页 | 原料接收、打卡主页、打卡历史、成本仪表板 | 已完成 |
| **总计** | **22页** | - | - |

**开发工作量估算**:
- P0页面:7页 × 4天/页 = 28天
- P1页面:8页 × 3天/页 = 24天
- P2页面:3页 × 2天/页 = 6天
- **总计**: 58天 (2名前端开发并行,约6周完成)

---

### 4.2 批次管理页面详细设计 (5页)

#### 4.2.1 BatchListScreen - 批次列表页 (P0)

**页面定位**: 批次管理的主工作界面,使用频率最高

**页面布局**:
- 顶部:搜索栏 + 筛选按钮
- 中部:状态标签页(横向滚动)
- 主体:批次列表(垂直滚动)
- 右下角:FAB浮动按钮(创建批次)

**功能清单**:
- [ ] 批次列表展示(卡片式,每页20条)
- [ ] 下拉刷新(Pull to Refresh)
- [ ] 上拉加载更多(Infinite Scroll)
- [ ] 状态筛选标签页(全部/计划中/进行中/质检中/已完成/已失败)
- [ ] 搜索功能(批次号、产品类型模糊匹配)
- [ ] 高级筛选(日期范围、生产线、负责人)
- [ ] 排序功能(按时间、按状态、按产量)
- [ ] 快捷操作(开始生产、查看详情)
- [ ] 空状态提示(暂无批次时显示)

**单个批次卡片结构**:
- 批次号(FAC001-20250105-001) + 状态徽章
- 产品类型(速冻鱼排) + 目标产量(400kg)
- 生产线(生产线A) + 负责人(张三)
- 开始日期(2025-01-05) + 进度条(如已有进度)
- 快捷按钮:"开始生产"或"查看详情"(根据状态)

**页面跳转**:
- 点击批次卡片 → BatchDetailScreen
- 点击FAB按钮 → BatchCreateScreen
- 快捷菜单"编辑" → BatchEditScreen

**用户权限影响**:
- operator:仅显示自己参与的批次
- department_admin:显示本部门所有批次
- factory_super_admin:显示本工厂所有批次

---

#### 4.2.2 BatchDetailScreen - 批次详情页 (P0)

**页面定位**: 批次操作的中心页面,查看完整信息,执行批次操作

**页面布局**: 垂直滚动,分区卡片

**功能清单**:
- [ ] 批次基本信息展示
- [ ] 批次状态流转可视化(流程图)
- [ ] 产量进度条
- [ ] 成本构成饼图
- [ ] 关联质检记录列表
- [ ] 关联工时记录汇总
- [ ] 关联设备使用记录
- [ ] 批次时间线(可展开)
- [ ] 底部操作按钮组(动态显示)

**区域结构** (详见3.1.2功能3)

**页面跳转**:
- "编辑"按钮 → BatchEditScreen
- "查看成本详情"链接 → BatchCostDetailScreen
- "查看完整时间线"链接 → BatchTimelineScreen
- "创建质检"链接 → QualityInspectionCreateScreen
- 质检记录项 → QualityInspectionDetailScreen

---

#### 4.2.3 BatchCreateScreen - 创建批次页 (P0)

**页面定位**: 启动生产任务的入口

**页面布局**: 垂直滚动表单

**功能清单**:
- [ ] 产品类型选择器(Picker)
- [ ] 原材料多选(支持搜索和添加)
- [ ] 目标产量数字输入(NumberInput)
- [ ] 生产线选择器(Picker,检查占用)
- [ ] 负责人选择器(从员工列表选择)
- [ ] 开始日期选择器(DatePicker,不能早于今天)
- [ ] 预期售价输入(可选)
- [ ] 备注多行文本输入
- [ ] 实时表单验证
- [ ] 提交前确认弹窗
- [ ] 底部操作按钮(取消/创建)

**表单字段** (详见3.1.2功能1)

**页面跳转**:
- 创建成功 → BatchDetailScreen(查看新创建的批次)
- 点击"取消" → 返回上一页

---

#### 4.2.4 BatchEditScreen - 编辑批次页 (P1)

**页面定位**: 修改批次信息

**页面布局**: 与BatchCreateScreen类似,但表单预填充

**功能清单**:
- [ ] 加载现有批次数据并预填充
- [ ] 根据批次状态禁用部分字段
- [ ] 表单验证
- [ ] 保存变更(PUT请求)
- [ ] 取消编辑确认
- [ ] 底部操作按钮(取消/保存修改)

**编辑规则**: planning状态全部可编辑,in_progress仅实际产量和备注可编辑

**页面跳转**:
- 保存成功 → BatchDetailScreen
- 点击"取消" → BatchDetailScreen

---

#### 4.2.5 BatchTimelineScreen - 批次时间线页 (P2)

**页面定位**: 追溯批次完整历史

**页面布局**: 垂直滚动时间线

**功能清单**:
- [ ] 时间线可视化展示
- [ ] 事件类型图标和颜色区分
- [ ] 事件详情展示(时间、操作人、描述)
- [ ] 下拉刷新(获取最新事件)
- [ ] 可选:按事件类型筛选

**事件类型** (详见3.1.2功能7)

**页面跳转**: 无(纯展示页面)

---

### 4.3 质检管理页面详细设计 (4页)

#### 4.3.1 QualityInspectionListScreen - 质检列表页 (P1)

**页面定位**: 查询历史质检记录

**功能清单**:
- [ ] 质检记录列表展示
- [ ] 按质检类型筛选(标签页:原料/过程/成品)
- [ ] 按质检结果筛选(合格/不合格/条件合格)
- [ ] 搜索(批次号、质检员)
- [ ] 下拉刷新、上拉加载
- [ ] FAB按钮(创建质检)

**单个质检记录卡片**:
- 批次号 + 质检结果徽章(合格/不合格)
- 产品类型 + 质检类型
- 质量评分(如95分,大字号)
- 质检日期 + 质检员

**页面跳转**:
- 点击记录 → QualityInspectionDetailScreen
- FAB按钮 → QualityInspectionCreateScreen

---

#### 4.3.2 QualityInspectionCreateScreen - 创建质检页 (P0)

**页面定位**: 录入质检数据,是质检工作的主要界面

**功能清单**:
- [ ] 批次选择器(从待质检批次列表选择)
- [ ] 质检类型选择(分段控件:原料/过程/成品)
- [ ] 检测项输入(根据类型加载检测项模板)
- [ ] 照片上传(最多10张)
- [ ] 不合格项记录(缺陷详情、纠正措施)
- [ ] 质检结果自动判定
- [ ] 提交质检记录

**表单结构**:
- 基本信息区:批次、质检类型
- 检测项区:列表展示所有检测项,逐项录入结果
- 照片区:网格展示照片,支持拍照和选择
- 不合格处理区:仅不合格时显示,填写缺陷详情和纠正措施

**页面跳转**:
- 提交成功 → QualityInspectionListScreen或BatchDetailScreen

---

#### 4.3.3 QualityInspectionDetailScreen - 质检详情页 (P1)

**页面定位**: 查看质检完整信息

**功能清单**:
- [ ] 质检基本信息展示
- [ ] 检测项结果列表(显示标准值vs实际值)
- [ ] 质量评分可视化(环形进度条)
- [ ] 质检照片网格展示(点击查看大图)
- [ ] 不合格项展示(如有)
- [ ] 关联批次信息
- [ ] "查看批次详情"按钮

**页面跳转**:
- "查看批次详情" → BatchDetailScreen

---

#### 4.3.4 QualityStatisticsScreen - 质检统计页 (P2)

**页面定位**: 质检数据分析

**功能清单**:
- [ ] 时间范围选择(今日/本周/本月)
- [ ] 关键指标卡片(质检次数、合格率)
- [ ] 质检合格率趋势折线图
- [ ] 不合格项TOP10横向柱状图
- [ ] 质检员绩效排名列表
- [ ] 数据导出按钮

**页面跳转**: 无

---

### 4.4 设备监控页面详细设计 (4页)

#### 4.4.1 EquipmentListScreen - 设备列表页 (P1)

**功能清单**:
- [ ] 设备列表展示(卡片式)
- [ ] 状态指示灯(绿/黄/红/灰)
- [ ] 按状态筛选(正常/警告/故障/维护中)
- [ ] 按设备类型筛选
- [ ] "实时监控"入口按钮

**页面跳转**:
- 点击设备 → EquipmentDetailScreen
- "实时监控" → EquipmentMonitoringScreen

---

#### 4.4.2 EquipmentMonitoringScreen - 实时监控页 (P0)

**功能清单**:
- [ ] 多设备监控面板(3-4台/屏)
- [ ] 实时参数展示(温度、湿度、压力、运行时长)
- [ ] 参数正常/异常标识(颜色区分)
- [ ] 实时曲线图(最近1小时)
- [ ] 告警提示(参数超标时闪烁)
- [ ] 自动刷新(每30秒)
- [ ] 手动刷新(下拉)

**页面跳转**:
- 点击监控卡片 → EquipmentDetailScreen

---

#### 4.4.3 EquipmentDetailScreen - 设备详情页 (P1)

**功能清单**:
- [ ] 设备基本信息
- [ ] 当前运行状态
- [ ] 参数历史曲线(可选时间范围)
- [ ] 运行时长统计
- [ ] 维护记录列表
- [ ] 使用记录列表(关联批次)
- [ ] 告警历史列表
- [ ] 操作按钮(开始维护、报修、查看监控)

**页面跳转**:
- 使用记录中的批次号 → BatchDetailScreen
- "查看实时监控" → EquipmentMonitoringScreen
- 告警记录 → EquipmentAlertsScreen

---

#### 4.4.4 EquipmentAlertsScreen - 设备告警页 (P0)

**功能清单**:
- [ ] 告警列表展示(按时间倒序)
- [ ] 严重程度徽章(红/橙/黄/蓝)
- [ ] 告警状态显示(活动中/已确认/已解决)
- [ ] 按严重程度筛选
- [ ] 按状态筛选
- [ ] 按设备筛选
- [ ] 告警操作(确认告警、标记已解决)
- [ ] 填写处理说明

**页面跳转**: 点击设备名称 → EquipmentDetailScreen

---

### 4.5 成本分析页面详细设计 (3页)

#### 4.5.1 CostAnalysisDashboard - 成本仪表板 (P2,已完成)

**页面定位**: 成本概览入口

**功能**: 显示今日/本周/本月的成本汇总数据

**页面跳转**:
- 点击批次 → BatchCostDetailScreen
- "成本趋势" → CostTrendScreen

---

#### 4.5.2 BatchCostDetailScreen - 批次成本详情页 (P0)

**功能清单**:
- [ ] 成本摘要(总成本、单位成本、利润率)
- [ ] 成本构成饼图
- [ ] 成本明细列表(可展开查看各项明细)
- [ ] 成本对比(vs目标成本、vs历史平均)
- [ ] AI智能分析按钮
- [ ] AI分析结果展示(成本评估+优化建议)
- [ ] 导出成本报告按钮

**页面跳转**: 返回 → BatchDetailScreen

---

#### 4.5.3 CostTrendScreen - 成本趋势分析页 (P1)

**功能清单**:
- [ ] 时间范围选择(近7/30/90天)
- [ ] 单位成本趋势折线图
- [ ] 成本对比柱状图(按产品类型)
- [ ] 成本构成堆叠图
- [ ] 成本预警区域
- [ ] 导出趋势报告

**页面跳转**: 点击数据点 → BatchCostDetailScreen

---

### 4.6 生产仪表板页面 (2页)

#### 4.6.1 ProcessingDashboardScreen - 生产仪表板 (P0,已完成50%)

**需要优化**:
- [ ] 优化数据展示布局
- [ ] 增加趋势箭头(比昨日+X)
- [ ] 优化快速导航入口
- [ ] 增加自动刷新

---

#### 4.6.2 ProductionStatisticsScreen - 生产统计详情页 (P2)

**功能清单**:
- [ ] 时间范围选择
- [ ] 生产数据详细统计(按产品类型、按生产线)
- [ ] 产量趋势图
- [ ] 效率分析
- [ ] 数据导出

---

### 4.7 其他页面

#### 4.7.1 WorkRecordScreen - 工作记录页 (P2)

**功能清单**:
- [ ] 个人工作记录列表
- [ ] 按批次筛选
- [ ] 按工作类型筛选
- [ ] 工作效率统计
- [ ] 工时明细

---

#### 4.7.2 DataExportScreen - 数据导出页 (P2)

**功能清单**:
- [ ] 选择导出类型(批次报表/质检报表/工时报表/成本报表)
- [ ] 选择时间范围
- [ ] 选择导出格式(PDF/Excel)
- [ ] 预览报表
- [ ] 导出到本地
- [ ] 分享报表

---

## 页面跳转关系

### 5.1 整体导航架构

**主入口**: ProcessingDashboardScreen(生产仪表板)

**一级导航** (从仪表板可直接进入):
- BatchListScreen (批次管理)
- QualityInspectionListScreen (质检管理)
- EquipmentListScreen (设备管理)
- EquipmentMonitoringScreen (实时监控)
- CostAnalysisDashboard (成本分析)
- DataExportScreen (数据导出)

**二级导航** (从一级页面进入):
- BatchDetailScreen、BatchCreateScreen、BatchEditScreen等

**三级导航** (从二级页面进入):
- BatchTimelineScreen、BatchCostDetailScreen等

---

### 5.2 批次管理模块导航流程

**主流程**:
ProcessingDashboardScreen
  → BatchListScreen
      → BatchDetailScreen
          → BatchEditScreen
          → BatchTimelineScreen
          → BatchCostDetailScreen
              → AI分析结果
  → BatchCreateScreen
      → BatchDetailScreen(新创建)

**跨模块跳转**:
BatchDetailScreen
  → QualityInspectionCreateScreen (创建质检)
  → QualityInspectionDetailScreen (查看质检)
  → WorkRecordScreen (查看工时)
  → EquipmentDetailScreen (查看设备)

---

### 5.3 质检管理模块导航流程

QualityInspectionListScreen
  → QualityInspectionDetailScreen
      → BatchDetailScreen (查看关联批次)
  → QualityInspectionCreateScreen
      → QualityInspectionListScreen (提交后)

QualityStatisticsScreen (独立页面,从仪表板进入)

---

### 5.4 设备监控模块导航流程

EquipmentListScreen
  → EquipmentDetailScreen
      → EquipmentMonitoringScreen
      → EquipmentAlertsScreen
      → BatchDetailScreen (使用记录中的批次)

EquipmentMonitoringScreen (可直接从仪表板进入)
  → EquipmentDetailScreen

EquipmentAlertsScreen (可直接从仪表板进入)
  → EquipmentDetailScreen

---

### 5.5 返回导航规则

**返回键/返回按钮行为**:
- BatchDetailScreen → BatchListScreen
- BatchCreateScreen → BatchListScreen
- BatchEditScreen → BatchDetailScreen
- 所有详情页 → 对应列表页

**底部Tab导航**:
- 用户可随时通过底部Tab切换到其他主模块(如切换到"工厂"、"我的")
- 返回生产模块时,保留之前的页面状态(如在批次详情页,切换后回来仍是详情页)

---

## 与其他模块的协作

### 6.1 认证模块 - 权限控制

**集成方式**: 所有生产页面都需要权限验证

**权限控制维度**:
- **页面访问权限**: 检查用户角色是否有权限访问该页面
- **数据访问权限**: 根据用户角色过滤显示的数据(operator只看自己的批次)
- **操作权限**: 根据用户角色显示/隐藏操作按钮

**不同角色的页面访问**:
- operator:批次列表(查看)、批次详情(查看)、打卡页面、质检创建
- department_admin:所有页面(批次CRUD、质检管理、设备查看)
- factory_super_admin:所有页面+成本调整权限
- platform_admin:所有页面(仅查看,不能操作)

---

### 6.2 员工管理模块 - 人力资源数据

**集成场景**:
1. **批次负责人选择**: 创建批次时选择负责人 → 读取员工列表
2. **工时关联批次**: 打卡时选择批次 → 保存批次ID到工时记录
3. **人工成本计算**: 批次完成时 → 读取工时数据计算人工成本

**数据流向**: 员工模块 ↔ 生产模块(双向)

---

### 6.3 设备监控模块 - 设备资源管理

**集成场景**:
1. **设备使用记录**: 批次开始生产时 → 记录使用的设备
2. **设备成本计算**: 批次完成时 → 读取设备使用数据计算设备成本
3. **设备告警影响批次**: 设备故障 → 自动暂停相关批次

**数据流向**: 设备模块 ↔ 生产模块(双向)

---

### 6.4 仓储模块 - 库存管理 (未来)

**集成场景**:
1. **原料出库**: 批次创建 → 触发原料出库,减少库存
2. **成品入库**: 批次完成 → 触发成品入库,增加库存,生成追溯码

**数据流向**: 生产模块 → 仓储模块

---

### 6.5 销售模块 - 追溯与定价 (未来)

**集成场景**:
1. **产品追溯**: 销售出库 → 关联批次号,客户扫码查询生产信息
2. **成本定价**: 销售定价 → 参考生产成本,计算建议售价

**数据流向**: 生产模块 → 销售模块

---

### 6.6 财务模块 - 会计核算 (未来)

**集成场景**:
1. **成本数据同步**: 批次完成 → 成本数据同步到财务系统
2. **利润分析**: 财务报表 → 读取生产成本和销售收入,计算利润

**数据流向**: 生产模块 → 财务模块

---

## 优化方向与实施计划

### 7.1 前端UI开发 (优先级: P0)

**目标**: 完成18个待开发页面

**工作量估算**:
- P0页面:7页 × 4天 = 28天
- P1页面:8页 × 3天 = 24天
- P2页面:3页 × 2天 = 6天
- **总计**: 58天

**开发资源**: 2名前端开发并行,预计6周完成

**技术要求**:
- 遵循Material Design 3设计规范
- 响应式布局(适配不同屏幕尺寸)
- 组件复用(抽取通用组件如Card、Button、StatusBadge)
- 性能优化(列表虚拟化、图片懒加载)

---

### 7.2 DeepSeek AI集成 (优先级: P0)

**目标**: 替换Mock数据,集成真实DeepSeek API

**实施内容**:
- 后端集成DeepSeek API
- 实现5分钟缓存策略
- 实现月度预算控制(¥30/月)
- 实现降级策略(预算用完后切换到规则引擎)
- 前端展示AI分析结果

**预计工期**: 1周(Week 5)

---

### 7.3 离线功能支持 (优先级: P1)

**目标**: 核心功能支持离线操作

**离线可操作**:
- 员工打卡(离线保存,联网后同步)
- 质检记录创建(离线保存,联网后同步)
- 批次列表查看(本地缓存)

**实施内容**:
- 使用AsyncStorage保存离线数据
- 实现网络状态检测
- 实现自动同步逻辑
- 用户提示(离线模式提示)

**预计工期**: 3-5天

---

### 7.4 性能优化 (优先级: P1)

**优化项**:
- 列表虚拟化(使用FlashList)
- 图片懒加载和压缩
- API数据缓存(React Query)
- 数据库查询优化(后端)

**性能目标**:
- 列表滚动≥60fps
- 图片加载<2秒
- API响应<500ms

**预计工期**: 5天(Week 6)

---

### 7.5 实施时间表

**总周期**: 6周

| 周次 | 主要任务 | 产出 | 责任人 |
|-----|---------|------|--------|
| **Week 1** | 批次管理UI(列表+详情) | 2页 | 前端1+2 |
| **Week 2** | 批次管理UI(创建+编辑+时间线) | 3页 | 前端1+2 |
| **Week 3** | 质检管理UI(4页) | 4页 | 前端1+2 |
| **Week 4** | 设备监控UI(4页) | 4页 | 前端1+2 |
| **Week 5** | 成本分析UI(2页)+AI集成 | 2页+AI | 前端1+后端1 |
| **Week 6** | 性能优化+测试+Bug修复 | 可发布 | 全员 |

**里程碑**:
- M1: Week 2结束 - 批次管理可用
- M2: Week 3结束 - 质检管理可用
- M3: Week 4结束 - 设备监控可用
- M4: Week 5结束 - AI分析可用
- M5: Week 6结束 - 系统优化完成,可发布

---

## 验收标准

### 8.1 功能完整性

- [ ] 22个页面全部完成(100%)
- [ ] 所有页面与后端集成正常
- [ ] 完整生产流程可走通(从批次创建到完成)
- [ ] 7种角色权限正确
- [ ] 离线功能可用(打卡、质检)
- [ ] AI分析真实可用(DeepSeek集成,月成本<¥30)

---

### 8.2 页面功能验收

**批次管理**:
- [ ] 可创建批次,批次号自动生成
- [ ] 可查询批次,支持筛选和搜索
- [ ] 可查看批次详情,信息完整
- [ ] 可编辑批次(根据状态限制字段)
- [ ] 可删除批次(仅planning状态)
- [ ] 可执行状态变更(开始/暂停/完成)
- [ ] 时间线完整记录操作历史

**质检管理**:
- [ ] 可创建质检记录,上传照片
- [ ] 质检结果自动判定
- [ ] 可查询质检记录
- [ ] 质检统计图表正确

**设备监控**:
- [ ] 可查看设备列表和状态
- [ ] 实时监控数据刷新正常
- [ ] 告警可查看和处理
- [ ] 设备详情信息完整

**成本分析**:
- [ ] 成本自动计算正确
- [ ] 成本明细展示完整
- [ ] AI分析可用,建议合理
- [ ] 成本趋势图表正确

---

### 8.3 性能指标

| 指标 | 目标值 | 验收方法 |
|-----|-------|---------|
| App启动时间 | <3秒 | 冷启动测试 |
| API响应时间 | <500ms | 性能测试 |
| 列表加载时间 | <2秒 | 页面加载测试 |
| 列表滚动帧率 | ≥60fps | 性能监控 |
| 图片加载时间 | <2秒 | 网络测试 |
| 内存占用 | <200MB | 内存监控 |

---

### 8.4 用户体验

- [ ] 操作流畅无卡顿
- [ ] 所有错误有友好提示
- [ ] 所有异步操作有Loading状态
- [ ] 所有关键操作有确认弹窗
- [ ] 所有列表有空状态提示
- [ ] 网络异常有提示和重试
- [ ] 表单验证提示清晰

---

### 8.5 代码质量

- [ ] TypeScript strict模式,无any类型
- [ ] ESLint无错误,警告<10个
- [ ] 通用组件提取到components目录
- [ ] API调用统一封装
- [ ] 错误处理完善(try-catch)
- [ ] 复杂逻辑有注释

---

## 附录

### A. 术语表

| 术语 | 说明 |
|-----|------|
| 批次 | 一次完整的生产过程 |
| 批次号 | 唯一标识批次,格式:FAC001-20250105-001 |
| 工时 | 员工工作时长,单位:小时或分钟 |
| 工种/工作类型 | 员工工作内容,如生产、质检、设备维护 |
| 质检 | 质量检验,包括原料、过程、成品三阶段 |
| 合格率 | 质检合格数÷总质检数×100% |
| 单位成本 | 总成本÷产量,单位:元/kg |
| 利润率 | (售价-成本)÷售价×100% |
| 折旧率 | 设备折旧费用,单位:元/小时 |
| 追溯码 | 产品追溯二维码,绑定批次号 |

---

**文档结束**

*本文档为白垩纪食品溯源系统生产模块的完整功能规划,聚焦功能需求和业务流程,不涉及技术实现细节。*

*文档版本: v2.0*
*最后更新: 2025-01-05*
