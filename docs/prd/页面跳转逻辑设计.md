# ç™½å©çºªé£Ÿå“æº¯æºç³»ç»Ÿ - é¡µé¢è·³è½¬é€»è¾‘è®¾è®¡

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**æ›´æ–°æ—¥æœŸ**: 2025-01-05

---

## ğŸ“‹ ç›®å½•

1. [å¯¼èˆªæ¶æ„æ¦‚è¿°](#å¯¼èˆªæ¶æ„æ¦‚è¿°)
2. [ç™»å½•åè·¯ç”±è§„åˆ™](#ç™»å½•åè·¯ç”±è§„åˆ™)
3. [è§’è‰²é¡µé¢è®¿é—®çŸ©é˜µ](#è§’è‰²é¡µé¢è®¿é—®çŸ©é˜µ)
4. [é¡µé¢è·³è½¬æµç¨‹](#é¡µé¢è·³è½¬æµç¨‹)
5. [æƒé™å®ˆå«æœºåˆ¶](#æƒé™å®ˆå«æœºåˆ¶)
6. [ä»£ç å®ç°](#ä»£ç å®ç°)

---

## å¯¼èˆªæ¶æ„æ¦‚è¿°

### 1.1 å¯¼èˆªå™¨å±‚çº§ç»“æ„

```
AppNavigator (Root)
â”‚
â”œâ”€ AuthStack (æœªç™»å½•)
â”‚  â”œâ”€ Login (ç™»å½•é¡µ)
â”‚  â”œâ”€ RegisterPhaseOne (æ³¨å†Œç¬¬ä¸€æ­¥)
â”‚  â””â”€ RegisterPhaseTwo (æ³¨å†Œç¬¬äºŒæ­¥)
â”‚
â””â”€ MainNavigator (å·²ç™»å½•)
   â”‚
   â”œâ”€ TabNavigator (åº•éƒ¨Tab)
   â”‚  â”‚
   â”‚  â”œâ”€ HomeTab
   â”‚  â”‚  â””â”€ HomeScreen (é¦–é¡µ)
   â”‚  â”‚
   â”‚  â”œâ”€ PlatformTab (å¹³å°ç®¡ç†å‘˜å¯è§)
   â”‚  â”‚  â””â”€ PlatformStack
   â”‚  â”‚     â”œâ”€ PlatformDashboard (å¹³å°ä»ªè¡¨æ¿)
   â”‚  â”‚     â”œâ”€ FactoryList (å·¥å‚åˆ—è¡¨)
   â”‚  â”‚     â””â”€ FactoryDetails (å·¥å‚è¯¦æƒ…)
   â”‚  â”‚
   â”‚  â”œâ”€ ProcessingTab (åŠ å·¥éƒ¨é—¨å¯è§)
   â”‚  â”‚  â””â”€ ProcessingStack
   â”‚  â”‚     â”œâ”€ ProcessingDashboard (åŠ å·¥ä»ªè¡¨æ¿)
   â”‚  â”‚     â”œâ”€ BatchList (æ‰¹æ¬¡åˆ—è¡¨)
   â”‚  â”‚     â”œâ”€ BatchDetail (æ‰¹æ¬¡è¯¦æƒ…)
   â”‚  â”‚     â”œâ”€ QualityInspection (è´¨æ£€)
   â”‚  â”‚     â”œâ”€ CostAnalysis (æˆæœ¬åˆ†æ)
   â”‚  â”‚     â””â”€ EquipmentMonitoring (è®¾å¤‡ç›‘æ§)
   â”‚  â”‚
   â”‚  â”œâ”€ TimeClockTab (å‘˜å·¥å¯è§)
   â”‚  â”‚  â””â”€ TimeClockStack
   â”‚  â”‚     â”œâ”€ TimeClockScreen (æ‰“å¡é¡µ)
   â”‚  â”‚     â”œâ”€ ClockHistory (æ‰“å¡è®°å½•)
   â”‚  â”‚     â””â”€ TimeStatistics (å·¥æ—¶ç»Ÿè®¡)
   â”‚  â”‚
   â”‚  â””â”€ AdminTab (ç®¡ç†å‘˜å¯è§)
   â”‚     â””â”€ AdminStack
   â”‚        â”œâ”€ UserManagement (ç”¨æˆ·ç®¡ç†)
   â”‚        â”œâ”€ WhitelistManagement (ç™½åå•ç®¡ç†)
   â”‚        â””â”€ PermissionManagement (æƒé™ç®¡ç†)
   â”‚
   â””â”€ Modal Screens (æ¨¡æ€é¡µé¢)
      â”œâ”€ UserProfile (ä¸ªäººèµ„æ–™)
      â”œâ”€ Settings (è®¾ç½®)
      â””â”€ Notifications (é€šçŸ¥)
```

### 1.2 å¯¼èˆªå™¨ç±»å‹

| å¯¼èˆªå™¨ | ç±»å‹ | ç”¨é€” |
|-------|------|------|
| **AppNavigator** | Stack Navigator | æ ¹å¯¼èˆªå™¨ï¼Œå¤„ç†è®¤è¯çŠ¶æ€ |
| **TabNavigator** | Bottom Tab Navigator | ä¸»ç•Œé¢åº•éƒ¨å¯¼èˆª |
| **ProcessingStack** | Stack Navigator | åŠ å·¥æ¨¡å—é¡µé¢æ ˆ |
| **TimeClockStack** | Stack Navigator | æ‰“å¡æ¨¡å—é¡µé¢æ ˆ |
| **AdminStack** | Stack Navigator | ç®¡ç†æ¨¡å—é¡µé¢æ ˆ |
| **PlatformStack** | Stack Navigator | å¹³å°ç®¡ç†é¡µé¢æ ˆ |

---

## ç™»å½•åè·¯ç”±è§„åˆ™

### 2.1 æ™ºèƒ½è·¯ç”±å‡½æ•°

**æ ¸å¿ƒé€»è¾‘**: `getPostLoginRoute(user: User): NavigationRoute`

```typescript
function getPostLoginRoute(user: User): NavigationRoute {
  const { userType, role, department } = user;

  // 1. å¹³å°ç®¡ç†å‘˜
  if (userType === 'platform') {
    if (role === 'platform_admin') {
      return {
        navigator: 'Main',
        screen: 'PlatformTab',
        params: { screen: 'PlatformDashboard' }
      };
    }
  }

  // 2. å·¥å‚è¶…çº§ç®¡ç†å‘˜
  if (role === 'factory_super_admin') {
    return {
      navigator: 'Main',
      screen: 'HomeTab',  // æ˜¾ç¤ºå·¥å‚æ¦‚è§ˆ
      params: { screen: 'HomeScreen' }
    };
  }

  // 3. æƒé™ç®¡ç†å‘˜
  if (role === 'permission_admin') {
    return {
      navigator: 'Main',
      screen: 'AdminTab',
      params: { screen: 'UserManagement' }
    };
  }

  // 4. éƒ¨é—¨ç®¡ç†å‘˜ - æ ¹æ®éƒ¨é—¨è·³è½¬
  if (role === 'department_admin') {
    switch (department) {
      case 'processing':
        return {
          navigator: 'Main',
          screen: 'ProcessingTab',
          params: { screen: 'ProcessingDashboard' }
        };
      case 'farming':
        return {
          navigator: 'Main',
          screen: 'FarmingTab',
          params: { screen: 'FarmingDashboard' }
        };
      case 'logistics':
        return {
          navigator: 'Main',
          screen: 'LogisticsTab',
          params: { screen: 'LogisticsDashboard' }
        };
      default:
        return {
          navigator: 'Main',
          screen: 'HomeTab',
          params: { screen: 'HomeScreen' }
        };
    }
  }

  // 5. æ“ä½œå‘˜ - ç›´æ¥åˆ°æ‰“å¡é¡µ
  if (role === 'operator') {
    return {
      navigator: 'Main',
      screen: 'TimeClockTab',
      params: { screen: 'TimeClockScreen' }
    };
  }

  // 6. æŸ¥çœ‹è€… - é¦–é¡µ
  return {
    navigator: 'Main',
    screen: 'HomeTab',
    params: { screen: 'HomeScreen' }
  };
}
```

### 2.2 ç™»å½•åè·³è½¬è§„åˆ™è¡¨

| è§’è‰² | userType | è·³è½¬ç›®æ ‡ | è¯´æ˜ |
|-----|----------|----------|------|
| **platform_admin** | platform | PlatformTab â†’ PlatformDashboard | å¹³å°ä»ªè¡¨æ¿ï¼Œæ˜¾ç¤ºæ‰€æœ‰å·¥å‚ |
| **factory_super_admin** | factory | HomeTab â†’ HomeScreen | å·¥å‚é¦–é¡µï¼Œæ˜¾ç¤ºæœ¬å·¥å‚æ¦‚è§ˆ |
| **permission_admin** | factory | AdminTab â†’ UserManagement | ç›´æ¥è¿›å…¥ç”¨æˆ·ç®¡ç† |
| **department_admin (åŠ å·¥éƒ¨)** | factory | ProcessingTab â†’ ProcessingDashboard | åŠ å·¥éƒ¨é—¨ä»ªè¡¨æ¿ |
| **department_admin (å…»æ®–éƒ¨)** | factory | FarmingTab â†’ FarmingDashboard | å…»æ®–éƒ¨é—¨ä»ªè¡¨æ¿ |
| **department_admin (ç‰©æµéƒ¨)** | factory | LogisticsTab â†’ LogisticsDashboard | ç‰©æµéƒ¨é—¨ä»ªè¡¨æ¿ |
| **operator** | factory | TimeClockTab â†’ TimeClockScreen | æ‰“å¡é¡µé¢ |
| **viewer** | factory | HomeTab â†’ HomeScreen | é¦–é¡µï¼ˆåªè¯»æ¨¡å¼ï¼‰ |

---

## è§’è‰²é¡µé¢è®¿é—®çŸ©é˜µ

### 3.1 åº•éƒ¨ Tab å¯è§æ€§

| Tabæ ‡ç­¾ | platform_admin | factory_super_admin | permission_admin | department_admin | operator | viewer |
|---------|----------------|---------------------|------------------|------------------|----------|--------|
| **é¦–é¡µ** | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| **å¹³å°** | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ |
| **å…»æ®–** | âœ… | âœ… | ğŸ‘ï¸ | âœ… (å…»æ®–éƒ¨) | âŒ | ğŸ‘ï¸ |
| **åŠ å·¥** | âœ… | âœ… | ğŸ‘ï¸ | âœ… (åŠ å·¥éƒ¨) | âœ… | ğŸ‘ï¸ |
| **ç‰©æµ** | âœ… | âœ… | ğŸ‘ï¸ | âœ… (ç‰©æµéƒ¨) | âŒ | ğŸ‘ï¸ |
| **æº¯æº** | âœ… | âœ… | ğŸ‘ï¸ | âœ… | ğŸ‘ï¸ | ğŸ‘ï¸ |
| **æ‰“å¡** | âŒ | âŒ | âŒ | âŒ | âœ… | âŒ |
| **ç®¡ç†** | âœ… | âœ… | âœ… | âŒ | âŒ | âŒ |

**å›¾ä¾‹**: âœ… å®Œå…¨è®¿é—® | ğŸ‘ï¸ åªè¯»è®¿é—® | âŒ ä¸å¯è§

### 3.2 é¡µé¢çº§è®¿é—®æ§åˆ¶

#### å¹³å°ç®¡ç†æ¨¡å— (ä»… platform_admin)

| é¡µé¢ | è·¯ç”± | æƒé™è¦æ±‚ | åŠŸèƒ½ |
|-----|------|---------|------|
| **å¹³å°ä»ªè¡¨æ¿** | `/platform/dashboard` | platform_admin | æ‰€æœ‰å·¥å‚æ¦‚è§ˆã€KPIç»Ÿè®¡ |
| **å·¥å‚åˆ—è¡¨** | `/platform/factories` | platform_admin | æ‰€æœ‰å·¥å‚åˆ—è¡¨ã€åˆ›å»ºå·¥å‚ |
| **å·¥å‚è¯¦æƒ…** | `/platform/factories/:id` | platform_admin | å•ä¸ªå·¥å‚è¯¦ç»†ä¿¡æ¯ã€é…ç½® |
| **ç”¨æˆ·æ€»è§ˆ** | `/platform/users` | platform_admin | æ‰€æœ‰å·¥å‚ç”¨æˆ·ç®¡ç† |
| **å¹³å°é…ç½®** | `/platform/settings` | platform_admin | å¹³å°çº§ç³»ç»Ÿé…ç½® |

#### åŠ å·¥æ¨¡å—

| é¡µé¢ | è·¯ç”± | æœ€ä½æƒé™ | platform_admin | factory_super_admin | department_admin (åŠ å·¥éƒ¨) | operator |
|-----|------|---------|----------------|---------------------|--------------------------|----------|
| **åŠ å·¥ä»ªè¡¨æ¿** | `/processing/dashboard` | operator | âœ… (æ‰€æœ‰å·¥å‚) | âœ… | âœ… (æœ¬éƒ¨é—¨) | ğŸ‘ï¸ (ä¸ªäºº) |
| **æ‰¹æ¬¡åˆ—è¡¨** | `/processing/batches` | operator | âœ… | âœ… | âœ… | ğŸ‘ï¸ |
| **åˆ›å»ºæ‰¹æ¬¡** | `/processing/batches/new` | department_admin | âœ… | âœ… | âœ… | âŒ |
| **æ‰¹æ¬¡è¯¦æƒ…** | `/processing/batches/:id` | operator | âœ… | âœ… | âœ… | ğŸ‘ï¸ |
| **è´¨æ£€è®°å½•** | `/processing/quality` | operator | âœ… | âœ… | âœ… | âœ… (æäº¤) |
| **æˆæœ¬åˆ†æ** | `/processing/cost-analysis` | department_admin | âœ… | âœ… | âœ… | âŒ |
| **è®¾å¤‡ç›‘æ§** | `/processing/equipment` | operator | âœ… | âœ… | âœ… | ğŸ‘ï¸ |

#### å‘˜å·¥ç®¡ç†æ¨¡å—

| é¡µé¢ | è·¯ç”± | æœ€ä½æƒé™ | åŠŸèƒ½ |
|-----|------|---------|------|
| **æ‰“å¡é¡µé¢** | `/timeclock/clock` | operator | ä¸Šç­/ä¸‹ç­æ‰“å¡ |
| **æ‰“å¡è®°å½•** | `/timeclock/history` | operator | æŸ¥çœ‹ä¸ªäººæ‰“å¡è®°å½• |
| **å·¥æ—¶ç»Ÿè®¡** | `/timeclock/statistics` | operator | æŸ¥çœ‹ä¸ªäººå·¥æ—¶ç»Ÿè®¡ |
| **å·¥ä½œè®°å½•** | `/timeclock/work-records` | department_admin | æŸ¥çœ‹éƒ¨é—¨å·¥ä½œè®°å½• |

#### ç®¡ç†æ¨¡å—

| é¡µé¢ | è·¯ç”± | æœ€ä½æƒé™ | åŠŸèƒ½ |
|-----|------|---------|------|
| **ç”¨æˆ·ç®¡ç†** | `/admin/users` | permission_admin | ç”¨æˆ·åˆ—è¡¨ã€åˆ›å»º/ç¼–è¾‘ç”¨æˆ· |
| **è§’è‰²åˆ†é…** | `/admin/users/:id/roles` | permission_admin | åˆ†é…ç”¨æˆ·è§’è‰² |
| **ç™½åå•ç®¡ç†** | `/admin/whitelist` | factory_super_admin | æ·»åŠ /åˆ é™¤ç™½åå• |
| **æƒé™é…ç½®** | `/admin/permissions` | factory_super_admin | æƒé™é…ç½®é¡µ |

---

## é¡µé¢è·³è½¬æµç¨‹

### 4.1 ç™»å½•æµç¨‹

```mermaid
graph TD
    A[Appå¯åŠ¨] --> B{æ£€æŸ¥Token}
    B -->|æœ‰æ•ˆToken| C[è‡ªåŠ¨ç™»å½•]
    B -->|æ— Token/è¿‡æœŸ| D[æ˜¾ç¤ºç™»å½•é¡µ]

    D --> E[ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç ]
    E --> F[ç‚¹å‡»ç™»å½•]
    F --> G{ç»Ÿä¸€ç™»å½•API}

    G -->|æˆåŠŸ| H{è¯†åˆ«ç”¨æˆ·è§’è‰²}
    G -->|å¤±è´¥| I[æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯]

    H -->|platform_admin| J[è·³è½¬å¹³å°ä»ªè¡¨æ¿]
    H -->|factory_super_admin| K[è·³è½¬å·¥å‚é¦–é¡µ]
    H -->|permission_admin| L[è·³è½¬ç”¨æˆ·ç®¡ç†]
    H -->|department_admin| M{æ£€æŸ¥éƒ¨é—¨}
    H -->|operator| N[è·³è½¬æ‰“å¡é¡µ]
    H -->|viewer| O[è·³è½¬é¦–é¡µåªè¯»]

    M -->|processing| P[è·³è½¬åŠ å·¥ä»ªè¡¨æ¿]
    M -->|farming| Q[è·³è½¬å…»æ®–ä»ªè¡¨æ¿]
    M -->|logistics| R[è·³è½¬ç‰©æµä»ªè¡¨æ¿]
    M -->|å…¶ä»–| K

    C --> H
```

### 4.2 platform_admin é¡µé¢è·³è½¬æµç¨‹

```
ç™»å½•æˆåŠŸ
    â†“
è·³è½¬åˆ°: PlatformTab â†’ PlatformDashboard
    â†“
æ˜¾ç¤ºå†…å®¹:
    - æ‰€æœ‰å·¥å‚åˆ—è¡¨å¡ç‰‡
    - å¹³å°çº§ KPI
    - å·¥å‚æ¿€æ´»çŠ¶æ€
    - ç”¨æˆ·æ€»æ•°ç»Ÿè®¡
    â†“
ç”¨æˆ·æ“ä½œé€‰é¡¹:
    â”œâ”€ ç‚¹å‡»"å·¥å‚ç®¡ç†" â†’ å·¥å‚åˆ—è¡¨é¡µ
    â”œâ”€ ç‚¹å‡»"ç”¨æˆ·ç®¡ç†" â†’ æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨
    â”œâ”€ ç‚¹å‡»"æ•°æ®åˆ†æ" â†’ è·¨å·¥å‚æŠ¥è¡¨
    â”œâ”€ ç‚¹å‡»æŸä¸ªå·¥å‚å¡ç‰‡ â†’ å·¥å‚è¯¦æƒ…é¡µ
    â””â”€ ç‚¹å‡»"é…ç½®" â†’ å¹³å°é…ç½®é¡µ
```

**PlatformDashboard å…³é”®æŒ‡æ ‡**:
```typescript
interface PlatformDashboardData {
  totalFactories: number;      // å·¥å‚æ€»æ•°
  activeFactories: number;     // æ¿€æ´»å·¥å‚æ•°
  totalUsers: number;          // ç”¨æˆ·æ€»æ•°
  totalBatches: number;        // æ€»æ‰¹æ¬¡æ•°
  todayProduction: number;     // ä»Šæ—¥ç”Ÿäº§é‡
  topFactories: Factory[];     // TOPå·¥å‚
  recentAlerts: Alert[];       // æœ€è¿‘å‘Šè­¦
}
```

### 4.3 factory_super_admin é¡µé¢è·³è½¬æµç¨‹

```
ç™»å½•æˆåŠŸ
    â†“
è·³è½¬åˆ°: HomeTab â†’ HomeScreen
    â†“
æ˜¾ç¤ºå†…å®¹:
    - æœ¬å·¥å‚æ¦‚è§ˆ
    - ä»Šæ—¥ç”Ÿäº§æ•°æ®
    - å‘˜å·¥å‡ºå‹¤æƒ…å†µ
    - è®¾å¤‡è¿è¡ŒçŠ¶æ€
    - æœ€è¿‘å‘Šè­¦
    â†“
åº•éƒ¨Tabæ˜¾ç¤º:
    â”œâ”€ é¦–é¡µ (å½“å‰)
    â”œâ”€ å…»æ®–
    â”œâ”€ åŠ å·¥
    â”œâ”€ ç‰©æµ
    â”œâ”€ æº¯æº
    â””â”€ ç®¡ç†
    â†“
ç”¨æˆ·å¯ç‚¹å‡»ä»»æ„Tabåˆ‡æ¢æ¨¡å—
```

**HomeScreen æ•°æ®ç»“æ„**:
```typescript
interface FactoryHomeData {
  factoryInfo: {
    id: string;
    name: string;
    todayProduction: number;
    todayAttendance: number;
  };
  productionSummary: {
    activeBatches: number;
    completedToday: number;
    qualityRate: number;
  };
  employeeSummary: {
    onDuty: number;
    total: number;
    absentRate: number;
  };
  equipmentSummary: {
    running: number;
    total: number;
    alerts: number;
  };
  recentAlerts: Alert[];
}
```

### 4.4 department_admin (åŠ å·¥éƒ¨) é¡µé¢è·³è½¬æµç¨‹

```
ç™»å½•æˆåŠŸ
    â†“
è·³è½¬åˆ°: ProcessingTab â†’ ProcessingDashboard
    â†“
æ˜¾ç¤ºå†…å®¹:
    - æœ¬éƒ¨é—¨ä»Šæ—¥ç”Ÿäº§æ•°æ®
    - è¿›è¡Œä¸­çš„æ‰¹æ¬¡
    - å¾…å¤„ç†è´¨æ£€
    - éƒ¨é—¨å‘˜å·¥å‡ºå‹¤
    - éƒ¨é—¨è®¾å¤‡çŠ¶æ€
    â†“
å¯ç”¨æ“ä½œ:
    â”œâ”€ åˆ›å»ºæ–°æ‰¹æ¬¡
    â”œâ”€ æŸ¥çœ‹æ‰¹æ¬¡åˆ—è¡¨
    â”œâ”€ è´¨æ£€è®°å½•
    â”œâ”€ æˆæœ¬åˆ†æ
    â””â”€ è®¾å¤‡ç›‘æ§
    â†“
æƒé™é™åˆ¶:
    - åªèƒ½æŸ¥çœ‹/æ“ä½œæœ¬éƒ¨é—¨æ•°æ®
    - ä¸èƒ½è®¿é—®å…¶ä»–éƒ¨é—¨æ•°æ®
    - å¯ä»¥æŸ¥çœ‹æœ¬éƒ¨é—¨å‘˜å·¥å·¥æ—¶
```

**ProcessingDashboard æ•°æ®ç»“æ„**:
```typescript
interface ProcessingDashboardData {
  departmentId: string;
  departmentName: string;
  stats: {
    todayProduction: number;
    activeBatches: number;
    pendingQuality: number;
    employeesOnDuty: number;
  };
  recentBatches: ProcessingBatch[];
  equipmentStatus: EquipmentStatus[];
  costTrend: CostTrendData;
}
```

### 4.5 operator é¡µé¢è·³è½¬æµç¨‹

```
ç™»å½•æˆåŠŸ
    â†“
è·³è½¬åˆ°: TimeClockTab â†’ TimeClockScreen
    â†“
æ˜¾ç¤ºå†…å®¹:
    - å¤§å·æ‰“å¡æŒ‰é’® (ä¸Šç­/ä¸‹ç­)
    - å½“å‰æ‰“å¡çŠ¶æ€
    - ä»Šæ—¥å·¥æ—¶
    - æœ¬æœˆç´¯è®¡å·¥æ—¶
    â†“
å¯ç”¨æ“ä½œ:
    â”œâ”€ ä¸Šç­æ‰“å¡ â†’ è®°å½•æ‰“å¡æ—¶é—´+GPS
    â”œâ”€ ä¸‹ç­æ‰“å¡ â†’ è®¡ç®—å·¥æ—¶
    â”œâ”€ æŸ¥çœ‹æ‰“å¡è®°å½•
    â””â”€ æŸ¥çœ‹å·¥æ—¶ç»Ÿè®¡
    â†“
åº•éƒ¨Tabæ˜¾ç¤º:
    â”œâ”€ é¦–é¡µ
    â”œâ”€ åŠ å·¥ (å¦‚æœæœ‰æƒé™)
    â””â”€ æ‰“å¡ (å½“å‰)
```

**TimeClockScreen UI å¸ƒå±€**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ã€å½“å‰çŠ¶æ€ã€‘               â”‚
â”‚    æœªæ‰“å¡ / å·²ä¸Šç­ / å·²ä¸‹ç­        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚    â”‚                     â”‚      â”‚
â”‚    â”‚   [ä¸Šç­æ‰“å¡] æŒ‰é’®     â”‚      â”‚
â”‚    â”‚   08:30 AM          â”‚      â”‚
â”‚    â”‚                     â”‚      â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚    â”‚   [ä¸‹ç­æ‰“å¡] æŒ‰é’®     â”‚      â”‚
â”‚    â”‚   å·²å·¥ä½œ: 4å°æ—¶30åˆ†   â”‚      â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä»Šæ—¥å·¥æ—¶: 0.0 å°æ—¶              â”‚
â”‚   æœ¬å‘¨å·¥æ—¶: 24.5 å°æ—¶             â”‚
â”‚   æœ¬æœˆå·¥æ—¶: 156.0 å°æ—¶            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æƒé™å®ˆå«æœºåˆ¶

### 5.1 å¯¼èˆªå®ˆå« (NavigationGuard)

**å®ç°ä½ç½®**: `src/navigation/NavigationGuard.tsx`

**å®ˆå«ç±»å‹**:
1. **è®¤è¯å®ˆå«**: æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
2. **æƒé™å®ˆå«**: æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰é¡µé¢è®¿é—®æƒé™
3. **Tabå®ˆå«**: åŠ¨æ€æ˜¾ç¤º/éšè—Tab

**å®ˆå«é€»è¾‘**:
```typescript
function canAccessScreen(
  user: User,
  screenName: string
): boolean {
  const userPermissions = getUserPermissions(user);
  const screenPermissions = SCREEN_PERMISSIONS[screenName];

  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ‰€éœ€æƒé™
  return screenPermissions.every(
    permission => userPermissions.includes(permission)
  );
}
```

### 5.2 Tab åŠ¨æ€æ˜¾ç¤ºé€»è¾‘

**TabNavigator é…ç½®**:
```typescript
const TabConfig = {
  Home: {
    icon: 'home',
    label: 'é¦–é¡µ',
    visible: () => true,  // æ‰€æœ‰è§’è‰²å¯è§
  },
  Platform: {
    icon: 'globe',
    label: 'å¹³å°',
    visible: (user) => user.userType === 'platform',  // ä»…å¹³å°ç®¡ç†å‘˜
  },
  Processing: {
    icon: 'cube',
    label: 'åŠ å·¥',
    visible: (user) => hasModuleAccess(user, 'processing_access'),
  },
  TimeClock: {
    icon: 'time',
    label: 'æ‰“å¡',
    visible: (user) => user.role === 'operator',  // ä»…æ“ä½œå‘˜
  },
  Admin: {
    icon: 'settings',
    label: 'ç®¡ç†',
    visible: (user) => ROLE_LEVELS[user.role] <= 10,  // ç®¡ç†å‘˜åŠä»¥ä¸Š
  },
};
```

### 5.3 é¡µé¢çº§æƒé™æ£€æŸ¥

**PermissionGuard ç»„ä»¶**:
```tsx
<PermissionGuard
  requiredPermissions={['processing_batch_create']}
  fallback={<Text>æ— æƒè®¿é—®æ­¤åŠŸèƒ½</Text>}
>
  <CreateBatchButton />
</PermissionGuard>
```

**å®ç°åŸç†**:
```typescript
const PermissionGuard: FC<Props> = ({
  requiredPermissions,
  children,
  fallback
}) => {
  const { user } = useAuthStore();
  const hasPermission = checkUserPermissions(
    user,
    requiredPermissions
  );

  return hasPermission ? children : (fallback || null);
};
```

---

## ä»£ç å®ç°

### 6.1 å¯¼èˆªå™¨é…ç½®ç¤ºä¾‹

**AppNavigator.tsx**:
```typescript
export function AppNavigator() {
  const { user, isAuthenticated } = useAuthStore();

  return (
    <NavigationContainer>
      <Stack.Navigator screenOptions={{ headerShown: false }}>
        {!isAuthenticated ? (
          // æœªç™»å½•ï¼šæ˜¾ç¤ºè®¤è¯é¡µé¢
          <>
            <Stack.Screen name="Login" component={LoginScreen} />
            <Stack.Screen name="RegisterPhaseOne" component={RegisterPhaseOneScreen} />
            <Stack.Screen name="RegisterPhaseTwo" component={RegisterPhaseTwoScreen} />
          </>
        ) : (
          // å·²ç™»å½•ï¼šæ˜¾ç¤ºä¸»ç•Œé¢
          <Stack.Screen name="Main" component={MainTabNavigator} />
        )}
      </Stack.Navigator>
    </NavigationContainer>
  );
}
```

**MainTabNavigator.tsx**:
```typescript
export function MainTabNavigator() {
  const { user } = useAuthStore();

  return (
    <Tab.Navigator>
      {/* é¦–é¡µ - æ‰€æœ‰è§’è‰² */}
      <Tab.Screen name="HomeTab" component={HomeScreen} />

      {/* å¹³å°ç®¡ç† - ä»… platform_admin */}
      {user.userType === 'platform' && (
        <Tab.Screen name="PlatformTab" component={PlatformStackNavigator} />
      )}

      {/* åŠ å·¥æ¨¡å— - æœ‰åŠ å·¥æƒé™çš„è§’è‰² */}
      {hasModuleAccess(user, 'processing_access') && (
        <Tab.Screen name="ProcessingTab" component={ProcessingStackNavigator} />
      )}

      {/* æ‰“å¡æ¨¡å— - ä»… operator */}
      {user.role === 'operator' && (
        <Tab.Screen name="TimeClockTab" component={TimeClockStackNavigator} />
      )}

      {/* ç®¡ç†æ¨¡å— - ç®¡ç†å‘˜åŠä»¥ä¸Š */}
      {ROLE_LEVELS[user.role] <= 10 && (
        <Tab.Screen name="AdminTab" component={AdminStackNavigator} />
      )}
    </Tab.Navigator>
  );
}
```

### 6.2 æ™ºèƒ½è·¯ç”±å®ç°

**navigationHelper.ts**:
```typescript
import { User } from '../types/auth';
import { FACTORY_ROLES } from '../types/auth';

interface NavigationRoute {
  screen: string;
  params?: Record<string, any>;
}

export function getPostLoginRoute(user: User): NavigationRoute {
  const { userType, role, department } = user;

  // å¹³å°ç®¡ç†å‘˜
  if (userType === 'platform' && role === 'platform_admin') {
    return {
      screen: 'PlatformTab',
      params: { screen: 'PlatformDashboard' }
    };
  }

  // å·¥å‚è¶…çº§ç®¡ç†å‘˜
  if (role === FACTORY_ROLES.FACTORY_SUPER_ADMIN) {
    return {
      screen: 'HomeTab',
      params: { screen: 'HomeScreen' }
    };
  }

  // æƒé™ç®¡ç†å‘˜
  if (role === FACTORY_ROLES.PERMISSION_ADMIN) {
    return {
      screen: 'AdminTab',
      params: { screen: 'UserManagement' }
    };
  }

  // éƒ¨é—¨ç®¡ç†å‘˜ - æ ¹æ®éƒ¨é—¨è·³è½¬
  if (role === FACTORY_ROLES.DEPARTMENT_ADMIN) {
    const departmentRoutes: Record<string, NavigationRoute> = {
      processing: {
        screen: 'ProcessingTab',
        params: { screen: 'ProcessingDashboard' }
      },
      farming: {
        screen: 'FarmingTab',
        params: { screen: 'FarmingDashboard' }
      },
      logistics: {
        screen: 'LogisticsTab',
        params: { screen: 'LogisticsDashboard' }
      },
      quality: {
        screen: 'QualityTab',
        params: { screen: 'QualityDashboard' }
      },
    };

    return departmentRoutes[department || 'processing'] || {
      screen: 'HomeTab',
      params: { screen: 'HomeScreen' }
    };
  }

  // æ“ä½œå‘˜ - ç›´æ¥åˆ°æ‰“å¡é¡µ
  if (role === FACTORY_ROLES.OPERATOR) {
    return {
      screen: 'TimeClockTab',
      params: { screen: 'TimeClockScreen' }
    };
  }

  // é»˜è®¤ï¼šé¦–é¡µ
  return {
    screen: 'HomeTab',
    params: { screen: 'HomeScreen' }
  };
}

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ¨¡å—è®¿é—®æƒé™
export function hasModuleAccess(
  user: User,
  module: string
): boolean {
  const userPermissions = getUserPermissions(user);
  return userPermissions.modules[module] === true;
}

// è·å–ç”¨æˆ·æƒé™
function getUserPermissions(user: User): UserPermissions {
  return FULL_ROLE_PERMISSIONS[user.role] || DEFAULT_PERMISSIONS;
}
```

### 6.3 ç™»å½•é¡µé¢å®ç°

**EnhancedLoginScreen.tsx å…³é”®é€»è¾‘**:
```typescript
const handleLogin = async () => {
  try {
    // 1. è°ƒç”¨ç™»å½•API
    const success = await login({
      username: username.trim(),
      password: password.trim(),
      rememberMe,
      biometricEnabled: rememberMe && biometricStatus.available,
    });

    if (success) {
      // 2. è·å–ç™»å½•åçš„ç”¨æˆ·ä¿¡æ¯
      const { user } = useAuthStore.getState();

      // 3. è®¡ç®—ç›®æ ‡è·¯ç”±
      const route = getPostLoginRoute(user);

      // 4. æ‰§è¡Œå¯¼èˆª
      navigation.replace('Main', route.params ? route : { screen: route.screen });
    }
  } catch (error) {
    console.error('Login failed:', error);
  }
};
```

---

## ç‰¹æ®Šåœºæ™¯å¤„ç†

### 7.1 é¦–æ¬¡ç™»å½•

```
ç”¨æˆ·é¦–æ¬¡ç™»å½•
    â†“
æ£€æµ‹ isFirstLogin = true
    â†“
æ˜¾ç¤ºå¼•å¯¼é¡µ (Onboarding)
    â†“
ä»‹ç»ç³»ç»ŸåŠŸèƒ½
    â†“
è®¾ç½®ä¸ªäººåå¥½
    â†“
å®Œæˆå¼•å¯¼
    â†“
æ ‡è®° isFirstLogin = false
    â†“
è·³è½¬åˆ°è§’è‰²å¯¹åº”çš„ä¸»é¡µ
```

### 7.2 æƒé™ä¸è¶³

```
ç”¨æˆ·å°è¯•è®¿é—®æŸé¡µé¢
    â†“
NavigationGuard æ£€æŸ¥æƒé™
    â†“
æƒé™ä¸è¶³
    â†“
æ˜¾ç¤ºæç¤º: "æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡µé¢"
    â†“
é€‰é¡¹:
    â”œâ”€ è¿”å›ä¸Šä¸€é¡µ
    â””â”€ è¿”å›é¦–é¡µ
```

### 7.3 Token è¿‡æœŸ

```
ç”¨æˆ·æ“ä½œè¿‡ç¨‹ä¸­
    â†“
API è¯·æ±‚è¿”å› 401
    â†“
å°è¯•ä½¿ç”¨ refreshToken åˆ·æ–°
    â”œâ”€ æˆåŠŸ â†’ é‡è¯•åŸè¯·æ±‚
    â””â”€ å¤±è´¥ â†’ æ¸…é™¤Token
                â†“
              æ˜¾ç¤ºç™»å½•é¡µ
                â†“
              æç¤º: "ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•"
```

### 7.4 è§’è‰²å˜æ›´

```
ç®¡ç†å‘˜ä¿®æ”¹äº†ç”¨æˆ·è§’è‰²
    â†“
ç”¨æˆ·ä¸‹æ¬¡æ‰“å¼€App
    â†“
æ£€æµ‹è§’è‰²ä¸æœ¬åœ°ç¼“å­˜ä¸ä¸€è‡´
    â†“
æ˜¾ç¤ºæç¤º: "æ‚¨çš„è§’è‰²å·²æ›´æ–°"
    â†“
æ¸…é™¤æœ¬åœ°å¯¼èˆªçŠ¶æ€
    â†“
æ ¹æ®æ–°è§’è‰²è·³è½¬åˆ°å¯¹åº”é¡µé¢
```

---

## é¡µé¢è·³è½¬å‚æ•°ä¼ é€’

### 8.1 è·¨é¡µé¢å‚æ•°ä¼ é€’

**åœºæ™¯1: æŸ¥çœ‹æ‰¹æ¬¡è¯¦æƒ…**
```typescript
// BatchList é¡µé¢
navigation.navigate('BatchDetail', {
  batchId: 'batch_123',
  batchNumber: 'BATCH-2025-001',
  readonly: !hasPermission('processing_batch_edit')
});

// BatchDetail é¡µé¢
const { batchId, readonly } = route.params;
```

**åœºæ™¯2: åˆ›å»ºæ‰¹æ¬¡åè·³è½¬**
```typescript
// CreateBatch é¡µé¢
const handleCreateBatch = async (batchData) => {
  const result = await createBatch(batchData);

  // è·³è½¬åˆ°è¯¦æƒ…é¡µ
  navigation.replace('BatchDetail', {
    batchId: result.id,
    justCreated: true
  });
};
```

**åœºæ™¯3: ä»é€šçŸ¥è·³è½¬**
```typescript
// æ”¶åˆ°æ¨é€é€šçŸ¥
const notification = {
  type: 'batch_quality_issue',
  batchId: 'batch_456'
};

// è·³è½¬åˆ°æ‰¹æ¬¡è¯¦æƒ…
navigation.navigate('Main', {
  screen: 'ProcessingTab',
  params: {
    screen: 'BatchDetail',
    params: { batchId: notification.batchId }
  }
});
```

---

## é¡µé¢è¿”å›å¤„ç†

### 9.1 è¿”å›é€»è¾‘

**æ™®é€šé¡µé¢è¿”å›**:
```typescript
// ä½¿ç”¨ç³»ç»Ÿè¿”å›æŒ‰é’®
navigation.goBack();

// æˆ–è¿”å›åˆ°æŒ‡å®šé¡µé¢
navigation.navigate('ProcessingDashboard');
```

**æ ¹é¡µé¢è¿”å›**:
```typescript
// TabNavigator çš„æ ¹é¡µé¢æŒ‰è¿”å›é”® â†’ æ˜¾ç¤ºé€€å‡ºç¡®è®¤
const handleBackPress = () => {
  Alert.alert(
    'ç¡®è®¤é€€å‡º',
    'ç¡®å®šè¦é€€å‡ºåº”ç”¨å—ï¼Ÿ',
    [
      { text: 'å–æ¶ˆ', style: 'cancel' },
      { text: 'é€€å‡º', onPress: () => BackHandler.exitApp() }
    ]
  );
  return true;
};
```

### 9.2 ç™»å‡ºè¿”å›

```typescript
const handleLogout = async () => {
  // 1. è°ƒç”¨ç™»å‡ºAPI
  await AuthService.logout();

  // 2. æ¸…é™¤æœ¬åœ°æ•°æ®
  await TokenManager.clearTokens();

  // 3. é‡ç½®å¯¼èˆªæ ˆåˆ°ç™»å½•é¡µ
  navigation.reset({
    index: 0,
    routes: [{ name: 'Login' }],
  });
};
```

---

## æ·±åº¦é“¾æ¥ (Deep Linking)

### 10.1 æ”¯æŒçš„æ·±åº¦é“¾æ¥

| é“¾æ¥ | ç›®æ ‡é¡µé¢ | ç¤ºä¾‹ |
|-----|---------|------|
| `cretas://batch/:id` | æ‰¹æ¬¡è¯¦æƒ… | `cretas://batch/batch_123` |
| `cretas://clock-in` | æ‰“å¡é¡µé¢ | `cretas://clock-in` |
| `cretas://profile` | ä¸ªäººèµ„æ–™ | `cretas://profile` |
| `cretas://notifications` | é€šçŸ¥åˆ—è¡¨ | `cretas://notifications` |

### 10.2 æ·±åº¦é“¾æ¥å¤„ç†

```typescript
const linking = {
  prefixes: ['cretas://', 'https://app.cretas.com'],
  config: {
    screens: {
      Main: {
        screens: {
          ProcessingTab: {
            screens: {
              BatchDetail: 'batch/:id',
            },
          },
          TimeClockTab: {
            screens: {
              TimeClockScreen: 'clock-in',
            },
          },
        },
      },
    },
  },
};
```

---

## é™„å½•

### A. é¡µé¢å®Œæ•´æ¸…å•

| æ¨¡å— | é¡µé¢åç§° | è·¯ç”± | æ–‡ä»¶è·¯å¾„ |
|-----|---------|------|---------|
| **è®¤è¯** | ç™»å½•é¡µ | `/login` | `screens/auth/EnhancedLoginScreen.tsx` |
| **è®¤è¯** | æ³¨å†Œç¬¬ä¸€æ­¥ | `/register/phase-one` | `screens/auth/RegisterPhaseOneScreen.tsx` |
| **è®¤è¯** | æ³¨å†Œç¬¬äºŒæ­¥ | `/register/phase-two` | `screens/auth/RegisterPhaseTwoScreen.tsx` |
| **é¦–é¡µ** | é¦–é¡µ | `/home` | `screens/main/HomeScreen.tsx` |
| **å¹³å°** | å¹³å°ä»ªè¡¨æ¿ | `/platform/dashboard` | `screens/platform/PlatformDashboardScreen.tsx` |
| **å¹³å°** | å·¥å‚åˆ—è¡¨ | `/platform/factories` | `screens/platform/FactoryListScreen.tsx` |
| **åŠ å·¥** | åŠ å·¥ä»ªè¡¨æ¿ | `/processing/dashboard` | `screens/processing/ProcessingDashboardScreen.tsx` |
| **åŠ å·¥** | æ‰¹æ¬¡åˆ—è¡¨ | `/processing/batches` | `screens/processing/BatchListScreen.tsx` |
| **åŠ å·¥** | æ‰¹æ¬¡è¯¦æƒ… | `/processing/batches/:id` | `screens/processing/BatchDetailScreen.tsx` |
| **åŠ å·¥** | åˆ›å»ºæ‰¹æ¬¡ | `/processing/batches/new` | `screens/processing/CreateBatchScreen.tsx` |
| **åŠ å·¥** | æˆæœ¬åˆ†æ | `/processing/cost-analysis` | `screens/processing/CostAnalysisDashboard.tsx` |
| **åŠ å·¥** | è®¾å¤‡ç›‘æ§ | `/processing/equipment` | `screens/processing/EquipmentMonitoringScreen.tsx` |
| **æ‰“å¡** | æ‰“å¡é¡µ | `/timeclock/clock` | `screens/timeclock/TimeClockScreen.tsx` |
| **æ‰“å¡** | æ‰“å¡è®°å½• | `/timeclock/history` | `screens/timeclock/ClockHistoryScreen.tsx` |
| **æ‰“å¡** | å·¥æ—¶ç»Ÿè®¡ | `/timeclock/statistics` | `screens/timeclock/TimeStatisticsScreen.tsx` |
| **ç®¡ç†** | ç”¨æˆ·ç®¡ç† | `/admin/users` | `screens/admin/UserManagementScreen.tsx` |
| **ç®¡ç†** | ç™½åå•ç®¡ç† | `/admin/whitelist` | `screens/management/WhitelistManagementScreen.tsx` |
| **ç®¡ç†** | æƒé™ç®¡ç† | `/admin/permissions` | `screens/management/PermissionManagementScreen.tsx` |

### B. å¯¼èˆªçŠ¶æ€æŒä¹…åŒ–

**æŒä¹…åŒ–é…ç½®**:
```typescript
import AsyncStorage from '@react-native-async-storage/async-storage';

const NAVIGATION_STATE_KEY = 'NAVIGATION_STATE_V1';

export const navigationPersistence = {
  // ä¿å­˜å¯¼èˆªçŠ¶æ€
  async save(state: NavigationState) {
    await AsyncStorage.setItem(
      NAVIGATION_STATE_KEY,
      JSON.stringify(state)
    );
  },

  // æ¢å¤å¯¼èˆªçŠ¶æ€
  async restore(): Promise<NavigationState | undefined> {
    const savedState = await AsyncStorage.getItem(NAVIGATION_STATE_KEY);
    return savedState ? JSON.parse(savedState) : undefined;
  },
};
```

---

**æ–‡æ¡£ç»“æŸ**

*æœ¬æ–‡æ¡£æè¿°äº†ç³»ç»Ÿçš„å®Œæ•´é¡µé¢è·³è½¬é€»è¾‘ï¼ŒåŒ…æ‹¬åŸºäºè§’è‰²çš„åŠ¨æ€å¯¼èˆªã€æƒé™å®ˆå«æœºåˆ¶ç­‰*
