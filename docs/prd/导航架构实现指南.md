# ç™½å©çºªé£Ÿå“æº¯æºç³»ç»Ÿ - å¯¼èˆªæ¶æ„å®ç°æŒ‡å—

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0
**æ›´æ–°æ—¥æœŸ**: 2025-01-05
**é€‚ç”¨èŒƒå›´**: React Native ç§»åŠ¨ç«¯

---

## ğŸ“‹ ç›®å½•

1. [å¯¼èˆªæ¶æ„è®¾è®¡](#å¯¼èˆªæ¶æ„è®¾è®¡)
2. [å®ç°æ­¥éª¤](#å®ç°æ­¥éª¤)
3. [ä»£ç ç»“æ„](#ä»£ç ç»“æ„)
4. [å®Œæ•´ä»£ç ç¤ºä¾‹](#å®Œæ•´ä»£ç ç¤ºä¾‹)
5. [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)

---

## å¯¼èˆªæ¶æ„è®¾è®¡

### 1.1 æ•´ä½“æ¶æ„

```
AppNavigator (æ ¹å¯¼èˆªå™¨)
â”‚
â”œâ”€ Loading (å¯åŠ¨åŠ è½½é¡µ)
â”‚
â”œâ”€ AuthStack (è®¤è¯æµç¨‹ - æœªç™»å½•çŠ¶æ€)
â”‚  â”œâ”€ Login
â”‚  â”œâ”€ RegisterPhaseOne
â”‚  â””â”€ RegisterPhaseTwo
â”‚
â””â”€ MainNavigator (ä¸»åº”ç”¨ - å·²ç™»å½•çŠ¶æ€)
   â”‚
   â””â”€ BottomTabNavigator
      â”‚
      â”œâ”€ HomeTab (é¦–é¡µTab)
      â”‚  â””â”€ HomeScreen
      â”‚
      â”œâ”€ PlatformTab (å¹³å°Tab - ä»…platform_admin)
      â”‚  â””â”€ PlatformStack
      â”‚     â”œâ”€ PlatformDashboard
      â”‚     â”œâ”€ FactoryList
      â”‚     â”œâ”€ FactoryDetail
      â”‚     â””â”€ PlatformSettings
      â”‚
      â”œâ”€ ProcessingTab (åŠ å·¥Tab)
      â”‚  â””â”€ ProcessingStack
      â”‚     â”œâ”€ ProcessingDashboard
      â”‚     â”œâ”€ BatchList
      â”‚     â”œâ”€ BatchDetail
      â”‚     â”œâ”€ CreateBatch
      â”‚     â”œâ”€ QualityInspection
      â”‚     â”œâ”€ CostAnalysis
      â”‚     â””â”€ EquipmentMonitoring
      â”‚
      â”œâ”€ TimeClockTab (æ‰“å¡Tab - ä»…operator)
      â”‚  â””â”€ TimeClockStack
      â”‚     â”œâ”€ TimeClockScreen
      â”‚     â”œâ”€ ClockHistory
      â”‚     â””â”€ TimeStatistics
      â”‚
      â””â”€ AdminTab (ç®¡ç†Tab - ç®¡ç†å‘˜)
         â””â”€ AdminStack
            â”œâ”€ UserManagement
            â”œâ”€ WhitelistManagement
            â””â”€ PermissionManagement
```

### 1.2 å¯¼èˆªå™¨èŒè´£

| å¯¼èˆªå™¨ | èŒè´£ | è·¯ç”±ç®¡ç† |
|-------|------|---------|
| **AppNavigator** | è®¤è¯çŠ¶æ€ç®¡ç† | ç™»å½•å‰/ååˆ‡æ¢ |
| **BottomTabNavigator** | æ¨¡å—åˆ‡æ¢ | åº•éƒ¨Tabå¯¼èˆª |
| **Stack Navigators** | é¡µé¢æ ˆç®¡ç† | é¡µé¢å‰è¿›/åé€€ |

---

## å®ç°æ­¥éª¤

### Step 1: åˆ›å»ºåŸºç¡€å¯¼èˆªå™¨

**æ–‡ä»¶ç»“æ„**:
```
src/navigation/
â”œâ”€â”€ AppNavigator.tsx              # æ ¹å¯¼èˆªå™¨
â”œâ”€â”€ MainTabNavigator.tsx          # åº•éƒ¨Tabå¯¼èˆª
â”œâ”€â”€ stacks/
â”‚   â”œâ”€â”€ PlatformStackNavigator.tsx    # å¹³å°æ¨¡å—æ ˆ
â”‚   â”œâ”€â”€ ProcessingStackNavigator.tsx  # åŠ å·¥æ¨¡å—æ ˆ
â”‚   â”œâ”€â”€ TimeClockStackNavigator.tsx   # æ‰“å¡æ¨¡å—æ ˆ
â”‚   â””â”€â”€ AdminStackNavigator.tsx       # ç®¡ç†æ¨¡å—æ ˆ
â”œâ”€â”€ guards/
â”‚   â”œâ”€â”€ NavigationGuard.tsx       # å¯¼èˆªå®ˆå«
â”‚   â””â”€â”€ PermissionGuard.tsx       # æƒé™å®ˆå«
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ navigationHelper.ts       # å¯¼èˆªå·¥å…·å‡½æ•°
â””â”€â”€ types.ts                      # å¯¼èˆªç±»å‹å®šä¹‰
```

### Step 2: å®šä¹‰å¯¼èˆªç±»å‹

**navigation/types.ts**:
```typescript
import { NavigatorScreenParams } from '@react-navigation/native';
import { NativeStackScreenProps } from '@react-navigation/native-stack';
import { BottomTabScreenProps } from '@react-navigation/bottom-tabs';

// æ ¹å¯¼èˆªå™¨å‚æ•°
export type RootStackParamList = {
  Loading: undefined;
  Login: undefined;
  RegisterPhaseOne: undefined;
  RegisterPhaseTwo: { tempToken: string };
  Main: NavigatorScreenParams<MainTabParamList>;
};

// ä¸»Tabå¯¼èˆªå‚æ•°
export type MainTabParamList = {
  HomeTab: undefined;
  PlatformTab: NavigatorScreenParams<PlatformStackParamList>;
  ProcessingTab: NavigatorScreenParams<ProcessingStackParamList>;
  TimeClockTab: NavigatorScreenParams<TimeClockStackParamList>;
  AdminTab: NavigatorScreenParams<AdminStackParamList>;
};

// å¹³å°æ¨¡å—æ ˆå‚æ•°
export type PlatformStackParamList = {
  PlatformDashboard: undefined;
  FactoryList: undefined;
  FactoryDetail: { factoryId: string };
  PlatformSettings: undefined;
};

// åŠ å·¥æ¨¡å—æ ˆå‚æ•°
export type ProcessingStackParamList = {
  ProcessingDashboard: undefined;
  BatchList: { status?: string };
  BatchDetail: { batchId: string; readonly?: boolean };
  CreateBatch: undefined;
  QualityInspection: { batchId: string };
  CostAnalysis: { batchId?: string };
  EquipmentMonitoring: undefined;
};

// æ‰“å¡æ¨¡å—æ ˆå‚æ•°
export type TimeClockStackParamList = {
  TimeClockScreen: undefined;
  ClockHistory: { employeeId?: number };
  TimeStatistics: { period?: 'daily' | 'weekly' | 'monthly' };
};

// ç®¡ç†æ¨¡å—æ ˆå‚æ•°
export type AdminStackParamList = {
  UserManagement: undefined;
  UserDetail: { userId: number };
  WhitelistManagement: undefined;
  PermissionManagement: undefined;
};

// é¡µé¢Propsç±»å‹
export type LoginScreenProps = NativeStackScreenProps<RootStackParamList, 'Login'>;
export type HomeScreenProps = BottomTabScreenProps<MainTabParamList, 'HomeTab'>;
export type BatchDetailScreenProps = NativeStackScreenProps<ProcessingStackParamList, 'BatchDetail'>;
// ... å…¶ä»–é¡µé¢Props
```

### Step 3: å®ç° AppNavigator

**navigation/AppNavigator.tsx**:
```typescript
import React, { useEffect, useState } from 'react';
import { NavigationContainer } from '@react-navigation/native';
import { createNativeStackNavigator } from '@react-navigation/native-stack';
import { useAuthStore } from '../store/authStore';
import { TokenManager } from '../services/tokenManager';

// å¯¼å…¥é¡µé¢
import LoginScreen from '../screens/auth/EnhancedLoginScreen';
import RegisterPhaseOneScreen from '../screens/auth/RegisterPhaseOneScreen';
import RegisterPhaseTwoScreen from '../screens/auth/RegisterPhaseTwoScreen';
import MainTabNavigator from './MainTabNavigator';
import LoadingScreen from '../screens/LoadingScreen';

import { RootStackParamList } from './types';

const Stack = createNativeStackNavigator<RootStackParamList>();

export function AppNavigator() {
  const { user, isAuthenticated, login } = useAuthStore();
  const [isLoading, setIsLoading] = useState(true);

  // åº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥Token
  useEffect(() => {
    const checkAuth = async () => {
      try {
        const token = await TokenManager.getAccessToken();
        if (token) {
          // å°è¯•è‡ªåŠ¨ç™»å½•
          // è¿™é‡Œå¯ä»¥è°ƒç”¨ /api/mobile/auth/profile éªŒè¯token
          // å¦‚æœæˆåŠŸï¼Œè®¾ç½®ç”¨æˆ·ä¿¡æ¯åˆ° store
        }
      } catch (error) {
        console.error('Auto login failed:', error);
      } finally {
        setIsLoading(false);
      }
    };

    checkAuth();
  }, []);

  if (isLoading) {
    return <LoadingScreen />;
  }

  return (
    <NavigationContainer>
      <Stack.Navigator screenOptions={{ headerShown: false }}>
        {!isAuthenticated ? (
          // æœªç™»å½•ï¼šè®¤è¯æµç¨‹
          <Stack.Group>
            <Stack.Screen name="Login" component={LoginScreen} />
            <Stack.Screen name="RegisterPhaseOne" component={RegisterPhaseOneScreen} />
            <Stack.Screen name="RegisterPhaseTwo" component={RegisterPhaseTwoScreen} />
          </Stack.Group>
        ) : (
          // å·²ç™»å½•ï¼šä¸»åº”ç”¨
          <Stack.Screen name="Main" component={MainTabNavigator} />
        )}
      </Stack.Navigator>
    </NavigationContainer>
  );
}
```

### Step 4: å®ç° MainTabNavigator

**navigation/MainTabNavigator.tsx**:
```typescript
import React from 'react';
import { createBottomTabNavigator } from '@react-navigation/bottom-tabs';
import { Ionicons } from '@expo/vector-icons';
import { useAuthStore } from '../store/authStore';
import { hasModuleAccess } from '../utils/navigationHelper';
import { ROLE_LEVELS } from '../constants/permissions';

// å¯¼å…¥Stack Navigators
import PlatformStackNavigator from './stacks/PlatformStackNavigator';
import ProcessingStackNavigator from './stacks/ProcessingStackNavigator';
import TimeClockStackNavigator from './stacks/TimeClockStackNavigator';
import AdminStackNavigator from './stacks/AdminStackNavigator';

// å¯¼å…¥é¡µé¢
import HomeScreen from '../screens/main/HomeScreen';

import { MainTabParamList } from './types';

const Tab = createBottomTabNavigator<MainTabParamList>();

export function MainTabNavigator() {
  const { user } = useAuthStore();

  if (!user) {
    return null;
  }

  return (
    <Tab.Navigator
      screenOptions={({ route }) => ({
        tabBarIcon: ({ focused, color, size }) => {
          const iconName = getTabIcon(route.name, focused);
          return <Ionicons name={iconName} size={size} color={color} />;
        },
        tabBarActiveTintColor: '#667eea',
        tabBarInactiveTintColor: 'gray',
        headerShown: true,
        headerStyle: {
          backgroundColor: '#667eea',
        },
        headerTintColor: '#fff',
        headerTitleStyle: {
          fontWeight: 'bold',
        },
      })}
    >
      {/* é¦–é¡µ - æ‰€æœ‰è§’è‰²å¯è§ */}
      <Tab.Screen
        name="HomeTab"
        component={HomeScreen}
        options={{ title: 'é¦–é¡µ' }}
      />

      {/* å¹³å°ç®¡ç† - ä»… platform_admin */}
      {user.userType === 'platform' && user.role === 'platform_admin' && (
        <Tab.Screen
          name="PlatformTab"
          component={PlatformStackNavigator}
          options={{ title: 'å¹³å°', headerShown: false }}
        />
      )}

      {/* åŠ å·¥æ¨¡å— - æœ‰åŠ å·¥æƒé™çš„è§’è‰² */}
      {hasModuleAccess(user, 'processing_access') && (
        <Tab.Screen
          name="ProcessingTab"
          component={ProcessingStackNavigator}
          options={{ title: 'åŠ å·¥', headerShown: false }}
        />
      )}

      {/* æ‰“å¡æ¨¡å— - ä»… operator */}
      {user.role === 'operator' && (
        <Tab.Screen
          name="TimeClockTab"
          component={TimeClockStackNavigator}
          options={{ title: 'æ‰“å¡', headerShown: false }}
        />
      )}

      {/* ç®¡ç†æ¨¡å— - ç®¡ç†å‘˜çº§åˆ« (level <= 10) */}
      {ROLE_LEVELS[user.role] <= 10 && (
        <Tab.Screen
          name="AdminTab"
          component={AdminStackNavigator}
          options={{ title: 'ç®¡ç†', headerShown: false }}
        />
      )}
    </Tab.Navigator>
  );
}

// Tabå›¾æ ‡æ˜ å°„
function getTabIcon(routeName: string, focused: boolean): any {
  const icons: Record<string, { focused: string; unfocused: string }> = {
    HomeTab: { focused: 'home', unfocused: 'home-outline' },
    PlatformTab: { focused: 'globe', unfocused: 'globe-outline' },
    ProcessingTab: { focused: 'cube', unfocused: 'cube-outline' },
    TimeClockTab: { focused: 'time', unfocused: 'time-outline' },
    AdminTab: { focused: 'settings', unfocused: 'settings-outline' },
  };

  return focused ? icons[routeName]?.focused : icons[routeName]?.unfocused;
}

export default MainTabNavigator;
```

### Step 5: å®ç°æ¨¡å—Stackå¯¼èˆªå™¨

**navigation/stacks/ProcessingStackNavigator.tsx**:
```typescript
import React from 'react';
import { createNativeStackNavigator } from '@react-navigation/native-stack';
import { ProcessingStackParamList } from '../types';

// å¯¼å…¥é¡µé¢
import ProcessingDashboardScreen from '../../screens/processing/ProcessingDashboardScreen';
import BatchListScreen from '../../screens/processing/BatchListScreen';
import BatchDetailScreen from '../../screens/processing/BatchDetailScreen';
import CreateBatchScreen from '../../screens/processing/CreateBatchScreen';
import CostAnalysisScreen from '../../screens/processing/CostAnalysisDashboard';
import EquipmentMonitoringScreen from '../../screens/processing/EquipmentUsageScreen';

const Stack = createNativeStackNavigator<ProcessingStackParamList>();

export function ProcessingStackNavigator() {
  return (
    <Stack.Navigator
      screenOptions={{
        headerStyle: {
          backgroundColor: '#667eea',
        },
        headerTintColor: '#fff',
        headerTitleStyle: {
          fontWeight: 'bold',
        },
      }}
    >
      <Stack.Screen
        name="ProcessingDashboard"
        component={ProcessingDashboardScreen}
        options={{ title: 'åŠ å·¥ä»ªè¡¨æ¿' }}
      />
      <Stack.Screen
        name="BatchList"
        component={BatchListScreen}
        options={{ title: 'æ‰¹æ¬¡åˆ—è¡¨' }}
      />
      <Stack.Screen
        name="BatchDetail"
        component={BatchDetailScreen}
        options={{ title: 'æ‰¹æ¬¡è¯¦æƒ…' }}
      />
      <Stack.Screen
        name="CreateBatch"
        component={CreateBatchScreen}
        options={{ title: 'åˆ›å»ºæ‰¹æ¬¡' }}
      />
      <Stack.Screen
        name="CostAnalysis"
        component={CostAnalysisScreen}
        options={{ title: 'æˆæœ¬åˆ†æ' }}
      />
      <Stack.Screen
        name="EquipmentMonitoring"
        component={EquipmentMonitoringScreen}
        options={{ title: 'è®¾å¤‡ç›‘æ§' }}
      />
    </Stack.Navigator>
  );
}

export default ProcessingStackNavigator;
```

**å…¶ä»–Stackå¯¼èˆªå™¨**ï¼šæŒ‰ç…§ç›¸åŒæ¨¡å¼å®ç°
- `PlatformStackNavigator.tsx`
- `TimeClockStackNavigator.tsx`
- `AdminStackNavigator.tsx`

### Step 6: å®ç°æƒé™å®ˆå«

**navigation/guards/PermissionGuard.tsx**:
```typescript
import React from 'react';
import { View, Text, StyleSheet } from 'react-native';
import { useAuthStore } from '../../store/authStore';
import { hasPermission } from '../../utils/permissionUtils';

interface PermissionGuardProps {
  requiredPermissions: string[];
  children: React.ReactNode;
  fallback?: React.ReactNode;
  mode?: 'any' | 'all';  // any: æ»¡è¶³ä»»ä¸€æƒé™ | all: æ»¡è¶³æ‰€æœ‰æƒé™
}

export const PermissionGuard: React.FC<PermissionGuardProps> = ({
  requiredPermissions,
  children,
  fallback,
  mode = 'all'
}) => {
  const { user } = useAuthStore();

  if (!user) {
    return fallback || <UnauthorizedView />;
  }

  const hasAccess = mode === 'all'
    ? requiredPermissions.every(p => hasPermission(user, p))
    : requiredPermissions.some(p => hasPermission(user, p));

  if (!hasAccess) {
    return fallback || <UnauthorizedView />;
  }

  return <>{children}</>;
};

// æ— æƒé™é»˜è®¤è§†å›¾
const UnauthorizedView = () => (
  <View style={styles.container}>
    <Text style={styles.text}>æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤åŠŸèƒ½</Text>
  </View>
);

const styles = StyleSheet.create({
  container: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#f5f5f5',
  },
  text: {
    fontSize: 16,
    color: '#666',
  },
});
```

**ä½¿ç”¨ç¤ºä¾‹**:
```tsx
// åœ¨é¡µé¢ä¸­ä½¿ç”¨
<PermissionGuard requiredPermissions={['processing_batch_create']}>
  <TouchableOpacity onPress={handleCreateBatch}>
    <Text>åˆ›å»ºæ‰¹æ¬¡</Text>
  </TouchableOpacity>
</PermissionGuard>

// ä½¿ç”¨è‡ªå®šä¹‰fallback
<PermissionGuard
  requiredPermissions={['admin_access']}
  fallback={<Text>éœ€è¦ç®¡ç†å‘˜æƒé™</Text>}
>
  <AdminPanel />
</PermissionGuard>
```

### Step 7: å®ç°å¯¼èˆªè¾…åŠ©å‡½æ•°

**utils/navigationHelper.ts**:
```typescript
import { User } from '../types/auth';
import { FACTORY_ROLES, PLATFORM_ROLES } from '../types/auth';
import { FULL_ROLE_PERMISSIONS } from '../constants/permissions';

// å¯¼èˆªç›®æ ‡æ¥å£
export interface NavigationTarget {
  screen: string;
  params?: Record<string, any>;
}

/**
 * è·å–ç™»å½•ååº”è·³è½¬çš„é¡µé¢
 */
export function getPostLoginRoute(user: User): NavigationTarget {
  const { userType, role, department } = user;

  // 1. å¹³å°ç®¡ç†å‘˜ â†’ å¹³å°ä»ªè¡¨æ¿
  if (userType === 'platform' && role === 'platform_admin') {
    return {
      screen: 'PlatformTab',
      params: { screen: 'PlatformDashboard' }
    };
  }

  // 2. å·¥å‚è¶…çº§ç®¡ç†å‘˜ â†’ å·¥å‚é¦–é¡µ
  if (role === FACTORY_ROLES.FACTORY_SUPER_ADMIN) {
    return {
      screen: 'HomeTab',
      params: { screen: 'HomeScreen' }
    };
  }

  // 3. æƒé™ç®¡ç†å‘˜ â†’ ç”¨æˆ·ç®¡ç†
  if (role === FACTORY_ROLES.PERMISSION_ADMIN) {
    return {
      screen: 'AdminTab',
      params: { screen: 'UserManagement' }
    };
  }

  // 4. éƒ¨é—¨ç®¡ç†å‘˜ â†’ å¯¹åº”éƒ¨é—¨ä»ªè¡¨æ¿
  if (role === FACTORY_ROLES.DEPARTMENT_ADMIN) {
    const departmentScreens: Record<string, NavigationTarget> = {
      processing: { screen: 'ProcessingTab', params: { screen: 'ProcessingDashboard' } },
      farming: { screen: 'FarmingTab', params: { screen: 'FarmingDashboard' } },
      logistics: { screen: 'LogisticsTab', params: { screen: 'LogisticsDashboard' } },
      quality: { screen: 'QualityTab', params: { screen: 'QualityDashboard' } },
    };

    return departmentScreens[department || 'processing'] || {
      screen: 'HomeTab',
      params: { screen: 'HomeScreen' }
    };
  }

  // 5. æ“ä½œå‘˜ â†’ æ‰“å¡é¡µ
  if (role === FACTORY_ROLES.OPERATOR) {
    return {
      screen: 'TimeClockTab',
      params: { screen: 'TimeClockScreen' }
    };
  }

  // 6. é»˜è®¤ â†’ é¦–é¡µ
  return {
    screen: 'HomeTab',
    params: { screen: 'HomeScreen' }
  };
}

/**
 * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ¨¡å—è®¿é—®æƒé™
 */
export function hasModuleAccess(user: User, module: string): boolean {
  const permissions = FULL_ROLE_PERMISSIONS[user.role];
  if (!permissions) {
    console.warn(`æœªæ‰¾åˆ°è§’è‰² ${user.role} çš„æƒé™é…ç½®`);
    return false;
  }

  return permissions.modules[module] === true;
}

/**
 * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç‰¹å®šåŠŸèƒ½æƒé™
 */
export function hasFeaturePermission(user: User, feature: string): boolean {
  const permissions = FULL_ROLE_PERMISSIONS[user.role];
  if (!permissions) return false;

  return permissions.features.includes(feature);
}

/**
 * è·å–ç”¨æˆ·å¯è§çš„Tabåˆ—è¡¨
 */
export function getVisibleTabs(user: User): string[] {
  const tabs: string[] = ['HomeTab'];  // é¦–é¡µæ‰€æœ‰äººå¯è§

  // å¹³å°Tab
  if (user.userType === 'platform' && user.role === 'platform_admin') {
    tabs.push('PlatformTab');
  }

  // ä¸šåŠ¡æ¨¡å—Tab
  if (hasModuleAccess(user, 'processing_access')) {
    tabs.push('ProcessingTab');
  }
  if (hasModuleAccess(user, 'farming_access')) {
    tabs.push('FarmingTab');
  }
  if (hasModuleAccess(user, 'logistics_access')) {
    tabs.push('LogisticsTab');
  }

  // æ‰“å¡Tab - ä»…æ“ä½œå‘˜
  if (user.role === FACTORY_ROLES.OPERATOR) {
    tabs.push('TimeClockTab');
  }

  // ç®¡ç†Tab - ç®¡ç†å‘˜çº§åˆ«
  if (ROLE_LEVELS[user.role] <= 10) {
    tabs.push('AdminTab');
  }

  return tabs;
}
```

---

## å®Œæ•´ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹1: PlatformStackNavigator

**navigation/stacks/PlatformStackNavigator.tsx**:
```typescript
import React from 'react';
import { createNativeStackNavigator } from '@react-navigation/native-stack';
import { PlatformStackParamList } from '../types';

// å¯¼å…¥é¡µé¢ç»„ä»¶
import PlatformDashboardScreen from '../../screens/platform/PlatformDashboardScreen';
import FactoryListScreen from '../../screens/platform/FactoryListScreen';

const Stack = createNativeStackNavigator<PlatformStackParamList>();

export function PlatformStackNavigator() {
  return (
    <Stack.Navigator
      screenOptions={{
        headerStyle: { backgroundColor: '#667eea' },
        headerTintColor: '#fff',
        headerTitleStyle: { fontWeight: 'bold' },
      }}
    >
      <Stack.Screen
        name="PlatformDashboard"
        component={PlatformDashboardScreen}
        options={{ title: 'å¹³å°ç®¡ç†' }}
      />
      <Stack.Screen
        name="FactoryList"
        component={FactoryListScreen}
        options={{ title: 'å·¥å‚åˆ—è¡¨' }}
      />
    </Stack.Navigator>
  );
}

export default PlatformStackNavigator;
```

### ç¤ºä¾‹2: ç™»å½•é¡µé¢å¯¼èˆª

**screens/auth/EnhancedLoginScreen.tsx (å…³é”®éƒ¨åˆ†)**:
```typescript
const EnhancedLoginScreen: React.FC<LoginScreenProps> = ({ navigation }) => {
  const { login } = useLogin();

  const handleLogin = async () => {
    try {
      const success = await login({
        username: username.trim(),
        password: password.trim(),
      });

      if (success) {
        // è·å–å½“å‰ç”¨æˆ·
        const { user } = useAuthStore.getState();

        // è®¡ç®—ç›®æ ‡è·¯ç”±
        const route = getPostLoginRoute(user);

        // å¯¼èˆªåˆ°ä¸»ç•Œé¢ï¼Œå¹¶æŒ‡å®šåˆå§‹Tab
        navigation.replace('Main', route.params);
      }
    } catch (error) {
      Alert.alert('ç™»å½•å¤±è´¥', error.message);
    }
  };

  return (
    <View>
      {/* ç™»å½•è¡¨å• */}
      <TextInput
        value={username}
        onChangeText={setUsername}
        placeholder="ç”¨æˆ·å"
      />
      <TextInput
        value={password}
        onChangeText={setPassword}
        secureTextEntry
        placeholder="å¯†ç "
      />
      <Button title="ç™»å½•" onPress={handleLogin} />
    </View>
  );
};
```

### ç¤ºä¾‹3: é¡µé¢è·³è½¬

**åœ¨ä»»æ„é¡µé¢ä¸­è·³è½¬**:
```typescript
// 1. è·³è½¬åˆ°æ‰¹æ¬¡è¯¦æƒ…
navigation.navigate('BatchDetail', { batchId: 'batch_123' });

// 2. ä»åŠ å·¥Tabè·³è½¬åˆ°æ‰“å¡Tab
navigation.navigate('TimeClockTab', {
  screen: 'TimeClockScreen'
});

// 3. è·¨Tabè·³è½¬åˆ°æ‰¹æ¬¡è¯¦æƒ…
navigation.navigate('Main', {
  screen: 'ProcessingTab',
  params: {
    screen: 'BatchDetail',
    params: { batchId: 'batch_456' }
  }
});

// 4. è¿”å›ä¸Šä¸€é¡µ
navigation.goBack();

// 5. è¿”å›åˆ°Tabæ ¹é¡µé¢
navigation.navigate('ProcessingDashboard');

// 6. é‡ç½®å¯¼èˆªæ ˆ
navigation.reset({
  index: 0,
  routes: [{ name: 'ProcessingDashboard' }],
});
```

---

## é¡µé¢ç”Ÿå‘½å‘¨æœŸå¤„ç†

### 5.1 é¡µé¢èšç„¦/å¤±ç„¦

**ä½¿ç”¨ useFocusEffect**:
```typescript
import { useFocusEffect } from '@react-navigation/native';

const BatchListScreen = () => {
  useFocusEffect(
    React.useCallback(() => {
      // é¡µé¢èšç„¦æ—¶æ‰§è¡Œ
      console.log('BatchList focused');
      loadBatches();

      // è¿”å›æ¸…ç†å‡½æ•°ï¼ˆé¡µé¢å¤±ç„¦æ—¶æ‰§è¡Œï¼‰
      return () => {
        console.log('BatchList unfocused');
      };
    }, [])
  );

  return <View>...</View>;
};
```

### 5.2 é¡µé¢å‚æ•°ç›‘å¬

```typescript
const BatchDetailScreen = ({ route, navigation }) => {
  const { batchId, readonly } = route.params;

  useEffect(() => {
    // å‚æ•°å˜åŒ–æ—¶é‡æ–°åŠ è½½æ•°æ®
    loadBatchDetail(batchId);
  }, [batchId]);

  return <View>...</View>;
};
```

---

## å¯¼èˆªçŠ¶æ€ç®¡ç†

### 6.1 å¯¼èˆªçŠ¶æ€æŒä¹…åŒ–

**å¯ç”¨æŒä¹…åŒ–**:
```typescript
import AsyncStorage from '@react-native-async-storage/async-storage';

const PERSISTENCE_KEY = 'NAVIGATION_STATE_V1';

export function AppNavigator() {
  const [isReady, setIsReady] = useState(false);
  const [initialState, setInitialState] = useState();

  useEffect(() => {
    const restoreState = async () => {
      try {
        const savedStateString = await AsyncStorage.getItem(PERSISTENCE_KEY);
        const state = savedStateString ? JSON.parse(savedStateString) : undefined;

        if (state !== undefined) {
          setInitialState(state);
        }
      } finally {
        setIsReady(true);
      }
    };

    restoreState();
  }, []);

  if (!isReady) {
    return <LoadingScreen />;
  }

  return (
    <NavigationContainer
      initialState={initialState}
      onStateChange={(state) => {
        AsyncStorage.setItem(PERSISTENCE_KEY, JSON.stringify(state));
      }}
    >
      {/* ... */}
    </NavigationContainer>
  );
}
```

### 6.2 æ·±åº¦é“¾æ¥é…ç½®

**linking é…ç½®**:
```typescript
const linking = {
  prefixes: ['cretas://', 'https://app.cretas.com'],
  config: {
    screens: {
      Login: 'login',
      Main: {
        screens: {
          HomeTab: 'home',
          PlatformTab: {
            screens: {
              PlatformDashboard: 'platform',
              FactoryList: 'platform/factories',
              FactoryDetail: 'platform/factories/:factoryId',
            },
          },
          ProcessingTab: {
            screens: {
              ProcessingDashboard: 'processing',
              BatchList: 'processing/batches',
              BatchDetail: 'processing/batches/:batchId',
              CreateBatch: 'processing/batches/new',
            },
          },
          TimeClockTab: {
            screens: {
              TimeClockScreen: 'timeclock',
              ClockHistory: 'timeclock/history',
            },
          },
        },
      },
    },
  },
};

// åœ¨ NavigationContainer ä¸­ä½¿ç”¨
<NavigationContainer linking={linking}>
  {/* ... */}
</NavigationContainer>
```

**æ·±åº¦é“¾æ¥ç¤ºä¾‹**:
```
cretas://processing/batches/batch_123
â†’ æ‰“å¼€Appå¹¶è·³è½¬åˆ°æ‰¹æ¬¡è¯¦æƒ…é¡µ

cretas://timeclock
â†’ æ‰“å¼€Appå¹¶è·³è½¬åˆ°æ‰“å¡é¡µ

https://app.cretas.com/platform/factories/TEST_2024_001
â†’ æ‰“å¼€Appå¹¶è·³è½¬åˆ°å·¥å‚è¯¦æƒ…é¡µ
```

---

## å¯¼èˆªæ‹¦æˆªå™¨

### 7.1 å…¨å±€å¯¼èˆªç›‘å¬

```typescript
import { useNavigationState } from '@react-navigation/native';

function useNavigationLogger() {
  const state = useNavigationState(state => state);

  useEffect(() => {
    if (state) {
      const currentRoute = getCurrentRoute(state);
      console.log('å¯¼èˆªåˆ°:', currentRoute);

      // è®°å½•é¡µé¢è®¿é—®æ—¥å¿—
      logPageView(currentRoute);
    }
  }, [state]);
}

function getCurrentRoute(state: any): string {
  if (!state || !state.routes) return '';

  const route = state.routes[state.index];

  if (route.state) {
    return getCurrentRoute(route.state);
  }

  return route.name;
}
```

### 7.2 å¯¼èˆªäº‹ä»¶ç›‘å¬

```typescript
const SomeScreen = ({ navigation }) => {
  useEffect(() => {
    // ç›‘å¬ç„¦ç‚¹äº‹ä»¶
    const unsubscribeFocus = navigation.addListener('focus', () => {
      console.log('Screen focused');
    });

    // ç›‘å¬å¤±ç„¦äº‹ä»¶
    const unsubscribeBlur = navigation.addListener('blur', () => {
      console.log('Screen blurred');
    });

    // ç›‘å¬è¿”å›æŒ‰é’®
    const unsubscribeBeforeRemove = navigation.addListener('beforeRemove', (e) => {
      // é˜»æ­¢é»˜è®¤è¡Œä¸º
      e.preventDefault();

      // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
      Alert.alert(
        'ç¡®è®¤ç¦»å¼€',
        'æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ',
        [
          { text: 'å–æ¶ˆ', style: 'cancel' },
          { text: 'ç¦»å¼€', onPress: () => navigation.dispatch(e.data.action) }
        ]
      );
    });

    // æ¸…ç†ç›‘å¬å™¨
    return () => {
      unsubscribeFocus();
      unsubscribeBlur();
      unsubscribeBeforeRemove();
    };
  }, [navigation]);

  return <View>...</View>;
};
```

---

## æ€§èƒ½ä¼˜åŒ–

### 8.1 æ‡’åŠ è½½é¡µé¢

```typescript
// ä½¿ç”¨ React.lazy å»¶è¿ŸåŠ è½½é¡µé¢
const BatchDetailScreen = React.lazy(() =>
  import('../../screens/processing/BatchDetailScreen')
);

// åœ¨å¯¼èˆªå™¨ä¸­ä½¿ç”¨
<Stack.Screen name="BatchDetail">
  {props => (
    <React.Suspense fallback={<LoadingScreen />}>
      <BatchDetailScreen {...props} />
    </React.Suspense>
  )}
</Stack.Screen>
```

### 8.2 Tabé¢„åŠ è½½

```typescript
<Tab.Navigator
  screenOptions={{
    lazy: false,  // ç¦ç”¨æ‡’åŠ è½½ï¼Œé¢„åŠ è½½æ‰€æœ‰Tab
    unmountOnBlur: false,  // åˆ‡æ¢Tabæ—¶ä¸å¸è½½é¡µé¢
  }}
>
  {/* Tabs */}
</Tab.Navigator>
```

### 8.3 ä¼˜åŒ–å¤§åˆ—è¡¨é¡µé¢

```typescript
// ä½¿ç”¨ FlatList çš„ä¼˜åŒ–é€‰é¡¹
<FlatList
  data={batches}
  renderItem={renderBatchItem}
  keyExtractor={item => item.id}

  // æ€§èƒ½ä¼˜åŒ–
  initialNumToRender={10}
  maxToRenderPerBatch={10}
  windowSize={5}
  removeClippedSubviews={true}

  // åˆ†é¡µåŠ è½½
  onEndReached={loadMoreBatches}
  onEndReachedThreshold={0.5}
/>
```

---

## æµ‹è¯•éªŒè¯

### 9.1 å¯¼èˆªæµ‹è¯•ç”¨ä¾‹

**æµ‹è¯•æ–‡ä»¶**: `__tests__/navigation/navigation.test.tsx`

```typescript
import { getPostLoginRoute } from '../../utils/navigationHelper';

describe('Navigation Logic', () => {
  test('platform_admin ç™»å½•åè·³è½¬åˆ°å¹³å°ä»ªè¡¨æ¿', () => {
    const user = {
      id: 1,
      username: 'platform_admin',
      userType: 'platform',
      role: 'platform_admin',
    };

    const route = getPostLoginRoute(user);

    expect(route.screen).toBe('PlatformTab');
    expect(route.params?.screen).toBe('PlatformDashboard');
  });

  test('factory_super_admin ç™»å½•åè·³è½¬åˆ°å·¥å‚é¦–é¡µ', () => {
    const user = {
      id: 2,
      username: 'factory_admin',
      userType: 'factory',
      role: 'factory_super_admin',
      factoryId: 'TEST_2024_001',
    };

    const route = getPostLoginRoute(user);

    expect(route.screen).toBe('HomeTab');
    expect(route.params?.screen).toBe('HomeScreen');
  });

  test('department_admin (åŠ å·¥éƒ¨) ç™»å½•åè·³è½¬åˆ°åŠ å·¥ä»ªè¡¨æ¿', () => {
    const user = {
      id: 3,
      username: 'processing_admin',
      userType: 'factory',
      role: 'department_admin',
      department: 'processing',
    };

    const route = getPostLoginRoute(user);

    expect(route.screen).toBe('ProcessingTab');
    expect(route.params?.screen).toBe('ProcessingDashboard');
  });

  test('operator ç™»å½•åè·³è½¬åˆ°æ‰“å¡é¡µ', () => {
    const user = {
      id: 4,
      username: 'operator_001',
      userType: 'factory',
      role: 'operator',
    };

    const route = getPostLoginRoute(user);

    expect(route.screen).toBe('TimeClockTab');
    expect(route.params?.screen).toBe('TimeClockScreen');
  });
});
```

### 9.2 æƒé™å®ˆå«æµ‹è¯•

```typescript
import { hasModuleAccess } from '../../utils/navigationHelper';

describe('Permission Guards', () => {
  test('platform_admin å¯è®¿é—®æ‰€æœ‰æ¨¡å—', () => {
    const user = {
      role: 'platform_admin',
      userType: 'platform',
    };

    expect(hasModuleAccess(user, 'processing_access')).toBe(true);
    expect(hasModuleAccess(user, 'platform_access')).toBe(true);
    expect(hasModuleAccess(user, 'admin_access')).toBe(true);
  });

  test('operator åªèƒ½è®¿é—®æ‰“å¡å’ŒåŸºæœ¬æ¨¡å—', () => {
    const user = {
      role: 'operator',
      userType: 'factory',
      department: 'processing',
    };

    expect(hasModuleAccess(user, 'processing_access')).toBe(true);
    expect(hasModuleAccess(user, 'admin_access')).toBe(false);
    expect(hasModuleAccess(user, 'platform_access')).toBe(false);
  });
});
```

---

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•æ·»åŠ æ–°çš„Tab?

**æ­¥éª¤**:
1. åœ¨ `types.ts` ä¸­æ·»åŠ æ–°çš„ ParamList
2. åˆ›å»ºæ–°çš„ StackNavigator
3. åœ¨ `MainTabNavigator.tsx` ä¸­æ·»åŠ  Tab.Screen
4. æ›´æ–° `getVisibleTabs()` å‡½æ•°
5. æ›´æ–°æƒé™é…ç½®

### Q2: å¦‚ä½•å®ç°æ¨¡æ€é¡µé¢?

**æ–¹æ³•**:
```typescript
// åœ¨ Stack.Navigator ä¸­ä½¿ç”¨ Stack.Group
<Stack.Navigator>
  <Stack.Group>
    {/* æ™®é€šé¡µé¢ */}
    <Stack.Screen name="Home" component={HomeScreen} />
  </Stack.Group>

  <Stack.Group screenOptions={{ presentation: 'modal' }}>
    {/* æ¨¡æ€é¡µé¢ */}
    <Stack.Screen name="Settings" component={SettingsScreen} />
    <Stack.Screen name="UserProfile" component={UserProfileScreen} />
  </Stack.Group>
</Stack.Navigator>
```

### Q3: å¦‚ä½•å¤„ç†æœªæˆæƒè®¿é—®?

**æ–¹æ³•**:
```typescript
// åœ¨æ¯ä¸ªéœ€è¦æƒé™çš„é¡µé¢ä¸­
const SomeProtectedScreen = () => {
  const { user } = useAuthStore();

  useEffect(() => {
    if (!hasPermission(user, 'required_permission')) {
      Alert.alert('æ— æƒè®¿é—®', 'æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡µé¢', [
        {
          text: 'è¿”å›',
          onPress: () => navigation.goBack()
        }
      ]);
    }
  }, []);

  return <View>...</View>;
};
```

### Q4: å¦‚ä½•å®ç°é¡µé¢åˆ‡æ¢åŠ¨ç”»?

**æ–¹æ³•**:
```typescript
<Stack.Navigator
  screenOptions={{
    animation: 'slide_from_right',  // ä»å³æ»‘å…¥
    // æˆ–å…¶ä»–åŠ¨ç”»: 'fade', 'slide_from_bottom', 'none'
  }}
>
  {/* Screens */}
</Stack.Navigator>
```

---

## æ€»ç»“

### å…³é”®è¦ç‚¹

1. **è®¤è¯çŠ¶æ€é©±åŠ¨**: æ ¹æ® `isAuthenticated` åˆ‡æ¢ Auth/Main å¯¼èˆªå™¨
2. **è§’è‰²é©±åŠ¨å¯¼èˆª**: ä¸åŒè§’è‰²çœ‹åˆ°ä¸åŒçš„Tabå’Œé¡µé¢
3. **æƒé™å®ˆå«**: åœ¨é¡µé¢çº§å’Œç»„ä»¶çº§éƒ½è¦æ£€æŸ¥æƒé™
4. **æ™ºèƒ½è·¯ç”±**: ç™»å½•åæ ¹æ®è§’è‰²è‡ªåŠ¨è·³è½¬åˆ°æœ€ç›¸å…³çš„é¡µé¢
5. **çŠ¶æ€åŒæ­¥**: å¯¼èˆªçŠ¶æ€ä¸è®¤è¯çŠ¶æ€ä¿æŒåŒæ­¥

### å®ç°æ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰é¡µé¢éƒ½æœ‰å¯¹åº”çš„ç±»å‹å®šä¹‰
- [ ] æ‰€æœ‰Tabéƒ½æœ‰æƒé™æ£€æŸ¥
- [ ] æ‰€æœ‰éœ€è¦æƒé™çš„é¡µé¢éƒ½åŒ…è£…äº† PermissionGuard
- [ ] ç™»å½•åè·¯ç”±é€»è¾‘è¦†ç›–æ‰€æœ‰è§’è‰²
- [ ] æ·±åº¦é“¾æ¥é…ç½®å®Œæ•´
- [ ] å¯¼èˆªçŠ¶æ€æŒä¹…åŒ–
- [ ] è¿”å›æŒ‰é’®å¤„ç†æ­£ç¡®
- [ ] æ¨¡æ€é¡µé¢é…ç½®æ­£ç¡®

---

**æ–‡æ¡£ç»“æŸ**

*æœ¬æ–‡æ¡£æä¾›äº†å®Œæ•´çš„å¯¼èˆªæ¶æ„å®ç°æŒ‡å—ï¼ŒåŒ…æ‹¬æ‰€æœ‰å¿…è¦çš„ä»£ç ç¤ºä¾‹*
