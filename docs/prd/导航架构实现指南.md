# 白垩纪食品溯源系统 - 导航架构实现指南

**文档版本**: v2.0
**更新日期**: 2025-01-05
**适用范围**: React Native 移动端

---

## 📋 目录

1. [导航架构设计](#导航架构设计)
2. [实现步骤](#实现步骤)
3. [代码结构](#代码结构)
4. [完整代码示例](#完整代码示例)
5. [测试验证](#测试验证)

---

## 导航架构设计

### 1.1 整体架构

```
AppNavigator (根导航器)
│
├─ Loading (启动加载页)
│
├─ AuthStack (认证流程 - 未登录状态)
│  ├─ Login
│  ├─ RegisterPhaseOne
│  └─ RegisterPhaseTwo
│
└─ MainNavigator (主应用 - 已登录状态)
   │
   └─ BottomTabNavigator
      │
      ├─ HomeTab (首页Tab)
      │  └─ HomeScreen
      │
      ├─ PlatformTab (平台Tab - 仅platform_admin)
      │  └─ PlatformStack
      │     ├─ PlatformDashboard
      │     ├─ FactoryList
      │     ├─ FactoryDetail
      │     └─ PlatformSettings
      │
      ├─ ProcessingTab (加工Tab)
      │  └─ ProcessingStack
      │     ├─ ProcessingDashboard
      │     ├─ BatchList
      │     ├─ BatchDetail
      │     ├─ CreateBatch
      │     ├─ QualityInspection
      │     ├─ CostAnalysis
      │     └─ EquipmentMonitoring
      │
      ├─ TimeClockTab (打卡Tab - 仅operator)
      │  └─ TimeClockStack
      │     ├─ TimeClockScreen
      │     ├─ ClockHistory
      │     └─ TimeStatistics
      │
      └─ AdminTab (管理Tab - 管理员)
         └─ AdminStack
            ├─ UserManagement
            ├─ WhitelistManagement
            └─ PermissionManagement
```

### 1.2 导航器职责

| 导航器 | 职责 | 路由管理 |
|-------|------|---------|
| **AppNavigator** | 认证状态管理 | 登录前/后切换 |
| **BottomTabNavigator** | 模块切换 | 底部Tab导航 |
| **Stack Navigators** | 页面栈管理 | 页面前进/后退 |

---

## 实现步骤

### Step 1: 创建基础导航器

**文件结构**:
```
src/navigation/
├── AppNavigator.tsx              # 根导航器
├── MainTabNavigator.tsx          # 底部Tab导航
├── stacks/
│   ├── PlatformStackNavigator.tsx    # 平台模块栈
│   ├── ProcessingStackNavigator.tsx  # 加工模块栈
│   ├── TimeClockStackNavigator.tsx   # 打卡模块栈
│   └── AdminStackNavigator.tsx       # 管理模块栈
├── guards/
│   ├── NavigationGuard.tsx       # 导航守卫
│   └── PermissionGuard.tsx       # 权限守卫
├── utils/
│   └── navigationHelper.ts       # 导航工具函数
└── types.ts                      # 导航类型定义
```

### Step 2: 定义导航类型

**navigation/types.ts**:
```typescript
import { NavigatorScreenParams } from '@react-navigation/native';
import { NativeStackScreenProps } from '@react-navigation/native-stack';
import { BottomTabScreenProps } from '@react-navigation/bottom-tabs';

// 根导航器参数
export type RootStackParamList = {
  Loading: undefined;
  Login: undefined;
  RegisterPhaseOne: undefined;
  RegisterPhaseTwo: { tempToken: string };
  Main: NavigatorScreenParams<MainTabParamList>;
};

// 主Tab导航参数
export type MainTabParamList = {
  HomeTab: undefined;
  PlatformTab: NavigatorScreenParams<PlatformStackParamList>;
  ProcessingTab: NavigatorScreenParams<ProcessingStackParamList>;
  TimeClockTab: NavigatorScreenParams<TimeClockStackParamList>;
  AdminTab: NavigatorScreenParams<AdminStackParamList>;
};

// 平台模块栈参数
export type PlatformStackParamList = {
  PlatformDashboard: undefined;
  FactoryList: undefined;
  FactoryDetail: { factoryId: string };
  PlatformSettings: undefined;
};

// 加工模块栈参数
export type ProcessingStackParamList = {
  ProcessingDashboard: undefined;
  BatchList: { status?: string };
  BatchDetail: { batchId: string; readonly?: boolean };
  CreateBatch: undefined;
  QualityInspection: { batchId: string };
  CostAnalysis: { batchId?: string };
  EquipmentMonitoring: undefined;
};

// 打卡模块栈参数
export type TimeClockStackParamList = {
  TimeClockScreen: undefined;
  ClockHistory: { employeeId?: number };
  TimeStatistics: { period?: 'daily' | 'weekly' | 'monthly' };
};

// 管理模块栈参数
export type AdminStackParamList = {
  UserManagement: undefined;
  UserDetail: { userId: number };
  WhitelistManagement: undefined;
  PermissionManagement: undefined;
};

// 页面Props类型
export type LoginScreenProps = NativeStackScreenProps<RootStackParamList, 'Login'>;
export type HomeScreenProps = BottomTabScreenProps<MainTabParamList, 'HomeTab'>;
export type BatchDetailScreenProps = NativeStackScreenProps<ProcessingStackParamList, 'BatchDetail'>;
// ... 其他页面Props
```

### Step 3: 实现 AppNavigator

**navigation/AppNavigator.tsx**:
```typescript
import React, { useEffect, useState } from 'react';
import { NavigationContainer } from '@react-navigation/native';
import { createNativeStackNavigator } from '@react-navigation/native-stack';
import { useAuthStore } from '../store/authStore';
import { TokenManager } from '../services/tokenManager';

// 导入页面
import LoginScreen from '../screens/auth/EnhancedLoginScreen';
import RegisterPhaseOneScreen from '../screens/auth/RegisterPhaseOneScreen';
import RegisterPhaseTwoScreen from '../screens/auth/RegisterPhaseTwoScreen';
import MainTabNavigator from './MainTabNavigator';
import LoadingScreen from '../screens/LoadingScreen';

import { RootStackParamList } from './types';

const Stack = createNativeStackNavigator<RootStackParamList>();

export function AppNavigator() {
  const { user, isAuthenticated, login } = useAuthStore();
  const [isLoading, setIsLoading] = useState(true);

  // 应用启动时检查Token
  useEffect(() => {
    const checkAuth = async () => {
      try {
        const token = await TokenManager.getAccessToken();
        if (token) {
          // 尝试自动登录
          // 这里可以调用 /api/mobile/auth/profile 验证token
          // 如果成功，设置用户信息到 store
        }
      } catch (error) {
        console.error('Auto login failed:', error);
      } finally {
        setIsLoading(false);
      }
    };

    checkAuth();
  }, []);

  if (isLoading) {
    return <LoadingScreen />;
  }

  return (
    <NavigationContainer>
      <Stack.Navigator screenOptions={{ headerShown: false }}>
        {!isAuthenticated ? (
          // 未登录：认证流程
          <Stack.Group>
            <Stack.Screen name="Login" component={LoginScreen} />
            <Stack.Screen name="RegisterPhaseOne" component={RegisterPhaseOneScreen} />
            <Stack.Screen name="RegisterPhaseTwo" component={RegisterPhaseTwoScreen} />
          </Stack.Group>
        ) : (
          // 已登录：主应用
          <Stack.Screen name="Main" component={MainTabNavigator} />
        )}
      </Stack.Navigator>
    </NavigationContainer>
  );
}
```

### Step 4: 实现 MainTabNavigator

**navigation/MainTabNavigator.tsx**:
```typescript
import React from 'react';
import { createBottomTabNavigator } from '@react-navigation/bottom-tabs';
import { Ionicons } from '@expo/vector-icons';
import { useAuthStore } from '../store/authStore';
import { hasModuleAccess } from '../utils/navigationHelper';
import { ROLE_LEVELS } from '../constants/permissions';

// 导入Stack Navigators
import PlatformStackNavigator from './stacks/PlatformStackNavigator';
import ProcessingStackNavigator from './stacks/ProcessingStackNavigator';
import TimeClockStackNavigator from './stacks/TimeClockStackNavigator';
import AdminStackNavigator from './stacks/AdminStackNavigator';

// 导入页面
import HomeScreen from '../screens/main/HomeScreen';

import { MainTabParamList } from './types';

const Tab = createBottomTabNavigator<MainTabParamList>();

export function MainTabNavigator() {
  const { user } = useAuthStore();

  if (!user) {
    return null;
  }

  return (
    <Tab.Navigator
      screenOptions={({ route }) => ({
        tabBarIcon: ({ focused, color, size }) => {
          const iconName = getTabIcon(route.name, focused);
          return <Ionicons name={iconName} size={size} color={color} />;
        },
        tabBarActiveTintColor: '#667eea',
        tabBarInactiveTintColor: 'gray',
        headerShown: true,
        headerStyle: {
          backgroundColor: '#667eea',
        },
        headerTintColor: '#fff',
        headerTitleStyle: {
          fontWeight: 'bold',
        },
      })}
    >
      {/* 首页 - 所有角色可见 */}
      <Tab.Screen
        name="HomeTab"
        component={HomeScreen}
        options={{ title: '首页' }}
      />

      {/* 平台管理 - 仅 platform_admin */}
      {user.userType === 'platform' && user.role === 'platform_admin' && (
        <Tab.Screen
          name="PlatformTab"
          component={PlatformStackNavigator}
          options={{ title: '平台', headerShown: false }}
        />
      )}

      {/* 加工模块 - 有加工权限的角色 */}
      {hasModuleAccess(user, 'processing_access') && (
        <Tab.Screen
          name="ProcessingTab"
          component={ProcessingStackNavigator}
          options={{ title: '加工', headerShown: false }}
        />
      )}

      {/* 打卡模块 - 仅 operator */}
      {user.role === 'operator' && (
        <Tab.Screen
          name="TimeClockTab"
          component={TimeClockStackNavigator}
          options={{ title: '打卡', headerShown: false }}
        />
      )}

      {/* 管理模块 - 管理员级别 (level <= 10) */}
      {ROLE_LEVELS[user.role] <= 10 && (
        <Tab.Screen
          name="AdminTab"
          component={AdminStackNavigator}
          options={{ title: '管理', headerShown: false }}
        />
      )}
    </Tab.Navigator>
  );
}

// Tab图标映射
function getTabIcon(routeName: string, focused: boolean): any {
  const icons: Record<string, { focused: string; unfocused: string }> = {
    HomeTab: { focused: 'home', unfocused: 'home-outline' },
    PlatformTab: { focused: 'globe', unfocused: 'globe-outline' },
    ProcessingTab: { focused: 'cube', unfocused: 'cube-outline' },
    TimeClockTab: { focused: 'time', unfocused: 'time-outline' },
    AdminTab: { focused: 'settings', unfocused: 'settings-outline' },
  };

  return focused ? icons[routeName]?.focused : icons[routeName]?.unfocused;
}

export default MainTabNavigator;
```

### Step 5: 实现模块Stack导航器

**navigation/stacks/ProcessingStackNavigator.tsx**:
```typescript
import React from 'react';
import { createNativeStackNavigator } from '@react-navigation/native-stack';
import { ProcessingStackParamList } from '../types';

// 导入页面
import ProcessingDashboardScreen from '../../screens/processing/ProcessingDashboardScreen';
import BatchListScreen from '../../screens/processing/BatchListScreen';
import BatchDetailScreen from '../../screens/processing/BatchDetailScreen';
import CreateBatchScreen from '../../screens/processing/CreateBatchScreen';
import CostAnalysisScreen from '../../screens/processing/CostAnalysisDashboard';
import EquipmentMonitoringScreen from '../../screens/processing/EquipmentUsageScreen';

const Stack = createNativeStackNavigator<ProcessingStackParamList>();

export function ProcessingStackNavigator() {
  return (
    <Stack.Navigator
      screenOptions={{
        headerStyle: {
          backgroundColor: '#667eea',
        },
        headerTintColor: '#fff',
        headerTitleStyle: {
          fontWeight: 'bold',
        },
      }}
    >
      <Stack.Screen
        name="ProcessingDashboard"
        component={ProcessingDashboardScreen}
        options={{ title: '加工仪表板' }}
      />
      <Stack.Screen
        name="BatchList"
        component={BatchListScreen}
        options={{ title: '批次列表' }}
      />
      <Stack.Screen
        name="BatchDetail"
        component={BatchDetailScreen}
        options={{ title: '批次详情' }}
      />
      <Stack.Screen
        name="CreateBatch"
        component={CreateBatchScreen}
        options={{ title: '创建批次' }}
      />
      <Stack.Screen
        name="CostAnalysis"
        component={CostAnalysisScreen}
        options={{ title: '成本分析' }}
      />
      <Stack.Screen
        name="EquipmentMonitoring"
        component={EquipmentMonitoringScreen}
        options={{ title: '设备监控' }}
      />
    </Stack.Navigator>
  );
}

export default ProcessingStackNavigator;
```

**其他Stack导航器**：按照相同模式实现
- `PlatformStackNavigator.tsx`
- `TimeClockStackNavigator.tsx`
- `AdminStackNavigator.tsx`

### Step 6: 实现权限守卫

**navigation/guards/PermissionGuard.tsx**:
```typescript
import React from 'react';
import { View, Text, StyleSheet } from 'react-native';
import { useAuthStore } from '../../store/authStore';
import { hasPermission } from '../../utils/permissionUtils';

interface PermissionGuardProps {
  requiredPermissions: string[];
  children: React.ReactNode;
  fallback?: React.ReactNode;
  mode?: 'any' | 'all';  // any: 满足任一权限 | all: 满足所有权限
}

export const PermissionGuard: React.FC<PermissionGuardProps> = ({
  requiredPermissions,
  children,
  fallback,
  mode = 'all'
}) => {
  const { user } = useAuthStore();

  if (!user) {
    return fallback || <UnauthorizedView />;
  }

  const hasAccess = mode === 'all'
    ? requiredPermissions.every(p => hasPermission(user, p))
    : requiredPermissions.some(p => hasPermission(user, p));

  if (!hasAccess) {
    return fallback || <UnauthorizedView />;
  }

  return <>{children}</>;
};

// 无权限默认视图
const UnauthorizedView = () => (
  <View style={styles.container}>
    <Text style={styles.text}>您没有权限访问此功能</Text>
  </View>
);

const styles = StyleSheet.create({
  container: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#f5f5f5',
  },
  text: {
    fontSize: 16,
    color: '#666',
  },
});
```

**使用示例**:
```tsx
// 在页面中使用
<PermissionGuard requiredPermissions={['processing_batch_create']}>
  <TouchableOpacity onPress={handleCreateBatch}>
    <Text>创建批次</Text>
  </TouchableOpacity>
</PermissionGuard>

// 使用自定义fallback
<PermissionGuard
  requiredPermissions={['admin_access']}
  fallback={<Text>需要管理员权限</Text>}
>
  <AdminPanel />
</PermissionGuard>
```

### Step 7: 实现导航辅助函数

**utils/navigationHelper.ts**:
```typescript
import { User } from '../types/auth';
import { FACTORY_ROLES, PLATFORM_ROLES } from '../types/auth';
import { FULL_ROLE_PERMISSIONS } from '../constants/permissions';

// 导航目标接口
export interface NavigationTarget {
  screen: string;
  params?: Record<string, any>;
}

/**
 * 获取登录后应跳转的页面
 */
export function getPostLoginRoute(user: User): NavigationTarget {
  const { userType, role, department } = user;

  // 1. 平台管理员 → 平台仪表板
  if (userType === 'platform' && role === 'platform_admin') {
    return {
      screen: 'PlatformTab',
      params: { screen: 'PlatformDashboard' }
    };
  }

  // 2. 工厂超级管理员 → 工厂首页
  if (role === FACTORY_ROLES.FACTORY_SUPER_ADMIN) {
    return {
      screen: 'HomeTab',
      params: { screen: 'HomeScreen' }
    };
  }

  // 3. 权限管理员 → 用户管理
  if (role === FACTORY_ROLES.PERMISSION_ADMIN) {
    return {
      screen: 'AdminTab',
      params: { screen: 'UserManagement' }
    };
  }

  // 4. 部门管理员 → 对应部门仪表板
  if (role === FACTORY_ROLES.DEPARTMENT_ADMIN) {
    const departmentScreens: Record<string, NavigationTarget> = {
      processing: { screen: 'ProcessingTab', params: { screen: 'ProcessingDashboard' } },
      farming: { screen: 'FarmingTab', params: { screen: 'FarmingDashboard' } },
      logistics: { screen: 'LogisticsTab', params: { screen: 'LogisticsDashboard' } },
      quality: { screen: 'QualityTab', params: { screen: 'QualityDashboard' } },
    };

    return departmentScreens[department || 'processing'] || {
      screen: 'HomeTab',
      params: { screen: 'HomeScreen' }
    };
  }

  // 5. 操作员 → 打卡页
  if (role === FACTORY_ROLES.OPERATOR) {
    return {
      screen: 'TimeClockTab',
      params: { screen: 'TimeClockScreen' }
    };
  }

  // 6. 默认 → 首页
  return {
    screen: 'HomeTab',
    params: { screen: 'HomeScreen' }
  };
}

/**
 * 检查用户是否有模块访问权限
 */
export function hasModuleAccess(user: User, module: string): boolean {
  const permissions = FULL_ROLE_PERMISSIONS[user.role];
  if (!permissions) {
    console.warn(`未找到角色 ${user.role} 的权限配置`);
    return false;
  }

  return permissions.modules[module] === true;
}

/**
 * 检查用户是否有特定功能权限
 */
export function hasFeaturePermission(user: User, feature: string): boolean {
  const permissions = FULL_ROLE_PERMISSIONS[user.role];
  if (!permissions) return false;

  return permissions.features.includes(feature);
}

/**
 * 获取用户可见的Tab列表
 */
export function getVisibleTabs(user: User): string[] {
  const tabs: string[] = ['HomeTab'];  // 首页所有人可见

  // 平台Tab
  if (user.userType === 'platform' && user.role === 'platform_admin') {
    tabs.push('PlatformTab');
  }

  // 业务模块Tab
  if (hasModuleAccess(user, 'processing_access')) {
    tabs.push('ProcessingTab');
  }
  if (hasModuleAccess(user, 'farming_access')) {
    tabs.push('FarmingTab');
  }
  if (hasModuleAccess(user, 'logistics_access')) {
    tabs.push('LogisticsTab');
  }

  // 打卡Tab - 仅操作员
  if (user.role === FACTORY_ROLES.OPERATOR) {
    tabs.push('TimeClockTab');
  }

  // 管理Tab - 管理员级别
  if (ROLE_LEVELS[user.role] <= 10) {
    tabs.push('AdminTab');
  }

  return tabs;
}
```

---

## 完整代码示例

### 示例1: PlatformStackNavigator

**navigation/stacks/PlatformStackNavigator.tsx**:
```typescript
import React from 'react';
import { createNativeStackNavigator } from '@react-navigation/native-stack';
import { PlatformStackParamList } from '../types';

// 导入页面组件
import PlatformDashboardScreen from '../../screens/platform/PlatformDashboardScreen';
import FactoryListScreen from '../../screens/platform/FactoryListScreen';

const Stack = createNativeStackNavigator<PlatformStackParamList>();

export function PlatformStackNavigator() {
  return (
    <Stack.Navigator
      screenOptions={{
        headerStyle: { backgroundColor: '#667eea' },
        headerTintColor: '#fff',
        headerTitleStyle: { fontWeight: 'bold' },
      }}
    >
      <Stack.Screen
        name="PlatformDashboard"
        component={PlatformDashboardScreen}
        options={{ title: '平台管理' }}
      />
      <Stack.Screen
        name="FactoryList"
        component={FactoryListScreen}
        options={{ title: '工厂列表' }}
      />
    </Stack.Navigator>
  );
}

export default PlatformStackNavigator;
```

### 示例2: 登录页面导航

**screens/auth/EnhancedLoginScreen.tsx (关键部分)**:
```typescript
const EnhancedLoginScreen: React.FC<LoginScreenProps> = ({ navigation }) => {
  const { login } = useLogin();

  const handleLogin = async () => {
    try {
      const success = await login({
        username: username.trim(),
        password: password.trim(),
      });

      if (success) {
        // 获取当前用户
        const { user } = useAuthStore.getState();

        // 计算目标路由
        const route = getPostLoginRoute(user);

        // 导航到主界面，并指定初始Tab
        navigation.replace('Main', route.params);
      }
    } catch (error) {
      Alert.alert('登录失败', error.message);
    }
  };

  return (
    <View>
      {/* 登录表单 */}
      <TextInput
        value={username}
        onChangeText={setUsername}
        placeholder="用户名"
      />
      <TextInput
        value={password}
        onChangeText={setPassword}
        secureTextEntry
        placeholder="密码"
      />
      <Button title="登录" onPress={handleLogin} />
    </View>
  );
};
```

### 示例3: 页面跳转

**在任意页面中跳转**:
```typescript
// 1. 跳转到批次详情
navigation.navigate('BatchDetail', { batchId: 'batch_123' });

// 2. 从加工Tab跳转到打卡Tab
navigation.navigate('TimeClockTab', {
  screen: 'TimeClockScreen'
});

// 3. 跨Tab跳转到批次详情
navigation.navigate('Main', {
  screen: 'ProcessingTab',
  params: {
    screen: 'BatchDetail',
    params: { batchId: 'batch_456' }
  }
});

// 4. 返回上一页
navigation.goBack();

// 5. 返回到Tab根页面
navigation.navigate('ProcessingDashboard');

// 6. 重置导航栈
navigation.reset({
  index: 0,
  routes: [{ name: 'ProcessingDashboard' }],
});
```

---

## 页面生命周期处理

### 5.1 页面聚焦/失焦

**使用 useFocusEffect**:
```typescript
import { useFocusEffect } from '@react-navigation/native';

const BatchListScreen = () => {
  useFocusEffect(
    React.useCallback(() => {
      // 页面聚焦时执行
      console.log('BatchList focused');
      loadBatches();

      // 返回清理函数（页面失焦时执行）
      return () => {
        console.log('BatchList unfocused');
      };
    }, [])
  );

  return <View>...</View>;
};
```

### 5.2 页面参数监听

```typescript
const BatchDetailScreen = ({ route, navigation }) => {
  const { batchId, readonly } = route.params;

  useEffect(() => {
    // 参数变化时重新加载数据
    loadBatchDetail(batchId);
  }, [batchId]);

  return <View>...</View>;
};
```

---

## 导航状态管理

### 6.1 导航状态持久化

**启用持久化**:
```typescript
import AsyncStorage from '@react-native-async-storage/async-storage';

const PERSISTENCE_KEY = 'NAVIGATION_STATE_V1';

export function AppNavigator() {
  const [isReady, setIsReady] = useState(false);
  const [initialState, setInitialState] = useState();

  useEffect(() => {
    const restoreState = async () => {
      try {
        const savedStateString = await AsyncStorage.getItem(PERSISTENCE_KEY);
        const state = savedStateString ? JSON.parse(savedStateString) : undefined;

        if (state !== undefined) {
          setInitialState(state);
        }
      } finally {
        setIsReady(true);
      }
    };

    restoreState();
  }, []);

  if (!isReady) {
    return <LoadingScreen />;
  }

  return (
    <NavigationContainer
      initialState={initialState}
      onStateChange={(state) => {
        AsyncStorage.setItem(PERSISTENCE_KEY, JSON.stringify(state));
      }}
    >
      {/* ... */}
    </NavigationContainer>
  );
}
```

### 6.2 深度链接配置

**linking 配置**:
```typescript
const linking = {
  prefixes: ['cretas://', 'https://app.cretas.com'],
  config: {
    screens: {
      Login: 'login',
      Main: {
        screens: {
          HomeTab: 'home',
          PlatformTab: {
            screens: {
              PlatformDashboard: 'platform',
              FactoryList: 'platform/factories',
              FactoryDetail: 'platform/factories/:factoryId',
            },
          },
          ProcessingTab: {
            screens: {
              ProcessingDashboard: 'processing',
              BatchList: 'processing/batches',
              BatchDetail: 'processing/batches/:batchId',
              CreateBatch: 'processing/batches/new',
            },
          },
          TimeClockTab: {
            screens: {
              TimeClockScreen: 'timeclock',
              ClockHistory: 'timeclock/history',
            },
          },
        },
      },
    },
  },
};

// 在 NavigationContainer 中使用
<NavigationContainer linking={linking}>
  {/* ... */}
</NavigationContainer>
```

**深度链接示例**:
```
cretas://processing/batches/batch_123
→ 打开App并跳转到批次详情页

cretas://timeclock
→ 打开App并跳转到打卡页

https://app.cretas.com/platform/factories/TEST_2024_001
→ 打开App并跳转到工厂详情页
```

---

## 导航拦截器

### 7.1 全局导航监听

```typescript
import { useNavigationState } from '@react-navigation/native';

function useNavigationLogger() {
  const state = useNavigationState(state => state);

  useEffect(() => {
    if (state) {
      const currentRoute = getCurrentRoute(state);
      console.log('导航到:', currentRoute);

      // 记录页面访问日志
      logPageView(currentRoute);
    }
  }, [state]);
}

function getCurrentRoute(state: any): string {
  if (!state || !state.routes) return '';

  const route = state.routes[state.index];

  if (route.state) {
    return getCurrentRoute(route.state);
  }

  return route.name;
}
```

### 7.2 导航事件监听

```typescript
const SomeScreen = ({ navigation }) => {
  useEffect(() => {
    // 监听焦点事件
    const unsubscribeFocus = navigation.addListener('focus', () => {
      console.log('Screen focused');
    });

    // 监听失焦事件
    const unsubscribeBlur = navigation.addListener('blur', () => {
      console.log('Screen blurred');
    });

    // 监听返回按钮
    const unsubscribeBeforeRemove = navigation.addListener('beforeRemove', (e) => {
      // 阻止默认行为
      e.preventDefault();

      // 显示确认对话框
      Alert.alert(
        '确认离开',
        '您有未保存的更改，确定要离开吗？',
        [
          { text: '取消', style: 'cancel' },
          { text: '离开', onPress: () => navigation.dispatch(e.data.action) }
        ]
      );
    });

    // 清理监听器
    return () => {
      unsubscribeFocus();
      unsubscribeBlur();
      unsubscribeBeforeRemove();
    };
  }, [navigation]);

  return <View>...</View>;
};
```

---

## 性能优化

### 8.1 懒加载页面

```typescript
// 使用 React.lazy 延迟加载页面
const BatchDetailScreen = React.lazy(() =>
  import('../../screens/processing/BatchDetailScreen')
);

// 在导航器中使用
<Stack.Screen name="BatchDetail">
  {props => (
    <React.Suspense fallback={<LoadingScreen />}>
      <BatchDetailScreen {...props} />
    </React.Suspense>
  )}
</Stack.Screen>
```

### 8.2 Tab预加载

```typescript
<Tab.Navigator
  screenOptions={{
    lazy: false,  // 禁用懒加载，预加载所有Tab
    unmountOnBlur: false,  // 切换Tab时不卸载页面
  }}
>
  {/* Tabs */}
</Tab.Navigator>
```

### 8.3 优化大列表页面

```typescript
// 使用 FlatList 的优化选项
<FlatList
  data={batches}
  renderItem={renderBatchItem}
  keyExtractor={item => item.id}

  // 性能优化
  initialNumToRender={10}
  maxToRenderPerBatch={10}
  windowSize={5}
  removeClippedSubviews={true}

  // 分页加载
  onEndReached={loadMoreBatches}
  onEndReachedThreshold={0.5}
/>
```

---

## 测试验证

### 9.1 导航测试用例

**测试文件**: `__tests__/navigation/navigation.test.tsx`

```typescript
import { getPostLoginRoute } from '../../utils/navigationHelper';

describe('Navigation Logic', () => {
  test('platform_admin 登录后跳转到平台仪表板', () => {
    const user = {
      id: 1,
      username: 'platform_admin',
      userType: 'platform',
      role: 'platform_admin',
    };

    const route = getPostLoginRoute(user);

    expect(route.screen).toBe('PlatformTab');
    expect(route.params?.screen).toBe('PlatformDashboard');
  });

  test('factory_super_admin 登录后跳转到工厂首页', () => {
    const user = {
      id: 2,
      username: 'factory_admin',
      userType: 'factory',
      role: 'factory_super_admin',
      factoryId: 'TEST_2024_001',
    };

    const route = getPostLoginRoute(user);

    expect(route.screen).toBe('HomeTab');
    expect(route.params?.screen).toBe('HomeScreen');
  });

  test('department_admin (加工部) 登录后跳转到加工仪表板', () => {
    const user = {
      id: 3,
      username: 'processing_admin',
      userType: 'factory',
      role: 'department_admin',
      department: 'processing',
    };

    const route = getPostLoginRoute(user);

    expect(route.screen).toBe('ProcessingTab');
    expect(route.params?.screen).toBe('ProcessingDashboard');
  });

  test('operator 登录后跳转到打卡页', () => {
    const user = {
      id: 4,
      username: 'operator_001',
      userType: 'factory',
      role: 'operator',
    };

    const route = getPostLoginRoute(user);

    expect(route.screen).toBe('TimeClockTab');
    expect(route.params?.screen).toBe('TimeClockScreen');
  });
});
```

### 9.2 权限守卫测试

```typescript
import { hasModuleAccess } from '../../utils/navigationHelper';

describe('Permission Guards', () => {
  test('platform_admin 可访问所有模块', () => {
    const user = {
      role: 'platform_admin',
      userType: 'platform',
    };

    expect(hasModuleAccess(user, 'processing_access')).toBe(true);
    expect(hasModuleAccess(user, 'platform_access')).toBe(true);
    expect(hasModuleAccess(user, 'admin_access')).toBe(true);
  });

  test('operator 只能访问打卡和基本模块', () => {
    const user = {
      role: 'operator',
      userType: 'factory',
      department: 'processing',
    };

    expect(hasModuleAccess(user, 'processing_access')).toBe(true);
    expect(hasModuleAccess(user, 'admin_access')).toBe(false);
    expect(hasModuleAccess(user, 'platform_access')).toBe(false);
  });
});
```

---

## 常见问题

### Q1: 如何添加新的Tab?

**步骤**:
1. 在 `types.ts` 中添加新的 ParamList
2. 创建新的 StackNavigator
3. 在 `MainTabNavigator.tsx` 中添加 Tab.Screen
4. 更新 `getVisibleTabs()` 函数
5. 更新权限配置

### Q2: 如何实现模态页面?

**方法**:
```typescript
// 在 Stack.Navigator 中使用 Stack.Group
<Stack.Navigator>
  <Stack.Group>
    {/* 普通页面 */}
    <Stack.Screen name="Home" component={HomeScreen} />
  </Stack.Group>

  <Stack.Group screenOptions={{ presentation: 'modal' }}>
    {/* 模态页面 */}
    <Stack.Screen name="Settings" component={SettingsScreen} />
    <Stack.Screen name="UserProfile" component={UserProfileScreen} />
  </Stack.Group>
</Stack.Navigator>
```

### Q3: 如何处理未授权访问?

**方法**:
```typescript
// 在每个需要权限的页面中
const SomeProtectedScreen = () => {
  const { user } = useAuthStore();

  useEffect(() => {
    if (!hasPermission(user, 'required_permission')) {
      Alert.alert('无权访问', '您没有权限访问此页面', [
        {
          text: '返回',
          onPress: () => navigation.goBack()
        }
      ]);
    }
  }, []);

  return <View>...</View>;
};
```

### Q4: 如何实现页面切换动画?

**方法**:
```typescript
<Stack.Navigator
  screenOptions={{
    animation: 'slide_from_right',  // 从右滑入
    // 或其他动画: 'fade', 'slide_from_bottom', 'none'
  }}
>
  {/* Screens */}
</Stack.Navigator>
```

---

## 总结

### 关键要点

1. **认证状态驱动**: 根据 `isAuthenticated` 切换 Auth/Main 导航器
2. **角色驱动导航**: 不同角色看到不同的Tab和页面
3. **权限守卫**: 在页面级和组件级都要检查权限
4. **智能路由**: 登录后根据角色自动跳转到最相关的页面
5. **状态同步**: 导航状态与认证状态保持同步

### 实现检查清单

- [ ] 所有页面都有对应的类型定义
- [ ] 所有Tab都有权限检查
- [ ] 所有需要权限的页面都包装了 PermissionGuard
- [ ] 登录后路由逻辑覆盖所有角色
- [ ] 深度链接配置完整
- [ ] 导航状态持久化
- [ ] 返回按钮处理正确
- [ ] 模态页面配置正确

---

**文档结束**

*本文档提供了完整的导航架构实现指南，包括所有必要的代码示例*
