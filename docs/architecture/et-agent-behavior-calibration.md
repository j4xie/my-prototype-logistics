# ET-Agent 行为校准机制架构

基于 arXiv:2601.06860 论文实现的 CRITIC + Reflexion 自我纠错系统

---

## 1. 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           用户输入 (User Query)                               │
│                      "查一下批次 MB-2026-001 的库存"                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         IntentExecutorService                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    1. 工具调用重复检测                                │   │
│  │                  ToolCallRedundancyService                          │   │
│  │         ┌─────────────────────────────────────────┐                 │   │
│  │         │  SHA-256 Hash → Redis 缓存 (5分钟TTL)   │                 │   │
│  │         │  重复调用? → 直接返回缓存结果            │                 │   │
│  │         └─────────────────────────────────────────┘                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    2. 执行工具 (Tool Execution)                      │   │
│  │              MaterialBatchQueryTool.execute(params)                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                          │                        │                         │
│                    成功 ✓                    失败 ✗                        │
│                          │                        │                         │
│                          ▼                        ▼                         │
│  ┌──────────────────────────────┐  ┌──────────────────────────────────┐   │
│  │   3a. 结果验证                │  │   3b. 失败分析                    │   │
│  │  ToolResultValidatorService  │  │  PromptInjectionService          │   │
│  └──────────────────────────────┘  └──────────────────────────────────┘   │
│                          │                        │                         │
└──────────────────────────┼────────────────────────┼─────────────────────────┘
                           │                        │
                           ▼                        ▼
              ┌────────────────────────────────────────────────────┐
              │              BehaviorCalibrationService             │
              │                    (协调中心)                        │
              │  ┌────────────────────────────────────────────┐    │
              │  │         需要纠正?                           │    │
              │  │  • CONDITION_IGNORED (条件被忽略)          │    │
              │  │  • PARTIAL_MATCH (部分匹配)                │    │
              │  │  • EMPTY_RESULT (空结果)                   │    │
              │  │  • PARAMETER_ERROR (参数错误)              │    │
              │  │  • DATA_NOT_FOUND (数据未找到)             │    │
              │  └────────────────────────────────────────────┘    │
              └────────────────────────────────────────────────────┘
                                      │
                          ┌───────────┴───────────┐
                          │                       │
                     不需要纠正               需要纠正
                          │                       │
                          ▼                       ▼
              ┌─────────────────┐    ┌─────────────────────────────┐
              │   返回结果给用户  │    │   CorrectionAgentService    │
              │                 │    │      (纠正代理)              │
              └─────────────────┘    └─────────────────────────────┘
                                                  │
                                                  ▼
                                     ┌─────────────────────────────┐
                                     │   ExternalVerifierService   │
                                     │      (外部验证器)            │
                                     │  • 验证数据可用性            │
                                     │  • 收集上下文信息            │
                                     │  • 生成纠正建议              │
                                     └─────────────────────────────┘
                                                  │
                                                  ▼
                                     ┌─────────────────────────────┐
                                     │   SelfCorrectionService     │
                                     │      (自我纠正)              │
                                     │  • 生成纠正后的查询          │
                                     │  • 重新执行工具              │
                                     │  • 最多重试 3 次             │
                                     └─────────────────────────────┘
                                                  │
                                                  ▼
                                     ┌─────────────────────────────┐
                                     │      返回纠正后的结果         │
                                     └─────────────────────────────┘
```

---

## 2. 核心服务关系图

```
                              ┌─────────────────────────┐
                              │  BehaviorCalibration    │
                              │       Service           │
                              │      (协调中心)          │
                              └───────────┬─────────────┘
                                          │
           ┌──────────────────────────────┼──────────────────────────────┐
           │                              │                              │
           ▼                              ▼                              ▼
┌─────────────────────┐      ┌─────────────────────┐      ┌─────────────────────┐
│ ToolCallRedundancy  │      │  PromptInjection    │      │  ToolResultValidator│
│     Service         │      │     Service         │      │      Service        │
├─────────────────────┤      ├─────────────────────┤      ├─────────────────────┤
│ • 重复调用检测       │      │ • 失败类型分析       │      │ • 结果意图匹配       │
│ • SHA-256 哈希      │      │ • 恢复提示生成       │      │ • 条件忽略检测       │
│ • Redis 缓存        │      │ • 替代工具建议       │      │ • 匹配分数计算       │
└─────────────────────┘      └─────────────────────┘      └─────────────────────┘
                                          │
                                          ▼
                              ┌─────────────────────────┐
                              │   CorrectionAgent       │
                              │      Service            │
                              │     (纠正代理)           │
                              └───────────┬─────────────┘
                                          │
                       ┌──────────────────┴──────────────────┐
                       │                                     │
                       ▼                                     ▼
           ┌─────────────────────┐               ┌─────────────────────┐
           │ ExternalVerifier    │               │  SelfCorrection     │
           │     Service         │               │     Service         │
           ├─────────────────────┤               ├─────────────────────┤
           │ • 数据可用性验证     │               │ • CRITIC 算法       │
           │ • 参数格式验证       │               │ • Reflexion 算法    │
           │ • 上下文信息收集     │               │ • 重试机制 (3次)    │
           │ • SQL 注入防护      │               │ • 纠正记录存储      │
           └─────────────────────┘               └─────────────────────┘
```

---

## 3. 失败类型分类图

```
                         ┌─────────────────────────────┐
                         │        FailureType          │
                         │        (失败类型)            │
                         └──────────────┬──────────────┘
                                        │
        ┌───────────────┬───────────────┼───────────────┬───────────────┐
        │               │               │               │               │
        ▼               ▼               ▼               ▼               ▼
┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
│PARAMETER_ERROR│ │PERMISSION_    │ │SERVICE_       │ │DATA_NOT_FOUND │ │VALIDATION_    │
│  参数错误      │ │   ERROR       │ │ UNAVAILABLE   │ │  数据未找到    │ │   ERROR       │
├───────────────┤ │  权限错误      │ │  服务不可用    │ ├───────────────┤ │  验证错误      │
│• 格式不正确    │ ├───────────────┤ ├───────────────┤ │• 批次不存在    │ ├───────────────┤
│• 缺少必填参数  │ │• 无权访问      │ │• 超时          │ │• 记录为空      │ │• 业务规则违反  │
│• 类型不匹配    │ │• Token过期    │ │• 连接失败      │ │• 条件过严      │ │• 数据不合法    │
└───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘
        │               │               │               │               │
        ▼               ▼               ▼               ▼               ▼
┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
│   恢复策略     │ │   恢复策略     │ │   恢复策略     │ │   恢复策略     │ │   恢复策略     │
├───────────────┤ ├───────────────┤ ├───────────────┤ ├───────────────┤ ├───────────────┤
│• 建议正确格式  │ │• 提示刷新登录  │ │• 稍后重试      │ │• 放宽查询条件  │ │• 提示正确值    │
│• 补充缺失参数  │ │• 联系管理员    │ │• 检查网络      │ │• 建议时间范围  │ │• 替代方案      │
└───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘

                   ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
                   │BUSINESS_ERROR │ │RESOURCE_      │ │   UNKNOWN     │
                   │  业务错误      │ │  CONFLICT     │ │   未知错误     │
                   ├───────────────┤ │  资源冲突      │ ├───────────────┤
                   │• 库存不足      │ ├───────────────┤ │• 未分类错误    │
                   │• 状态不允许    │ │• 并发修改      │ │• 系统异常      │
                   │• 流程约束      │ │• 锁定资源      │ │               │
                   └───────────────┘ └───────────────┘ └───────────────┘
```

---

## 4. 结果验证流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ToolResultValidatorService 验证流程                        │
└─────────────────────────────────────────────────────────────────────────────┘

                         用户输入: "查一下批次 MB-001 的信息"
                                        │
                                        ▼
                         ┌─────────────────────────────┐
                         │   提取用户查询条件           │
                         │   conditions: {             │
                         │     batchNumber: "MB-001"   │
                         │   }                         │
                         └──────────────┬──────────────┘
                                        │
                                        ▼
                         ┌─────────────────────────────┐
                         │   工具返回结果               │
                         │   {                         │
                         │     "content": [            │
                         │       {"batchNumber":"MB-100"},│
                         │       {"batchNumber":"MB-101"},│
                         │       {"batchNumber":"MB-102"} │
                         │     ],                      │
                         │     "totalElements": 3      │
                         │   }                         │
                         └──────────────┬──────────────┘
                                        │
                                        ▼
                         ┌─────────────────────────────┐
                         │   匹配分析                   │
                         │   • 期望: MB-001            │
                         │   • 实际: MB-100,101,102   │
                         │   • 匹配数: 0               │
                         │   • 总数: 3                 │
                         └──────────────┬──────────────┘
                                        │
           ┌────────────────────────────┼────────────────────────────┐
           │                            │                            │
           ▼                            ▼                            ▼
┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
│   matchScore = 1.0   │    │  matchScore = 0.5   │    │   matchScore = 0    │
│   (100% 匹配)        │    │   (50% 匹配)        │    │    (0% 匹配)        │
├─────────────────────┤    ├─────────────────────┤    ├─────────────────────┤
│   ✅ VALID          │    │  ⚠️ PARTIAL_MATCH   │    │  ❌ CONDITION_      │
│   结果有效           │    │  部分匹配            │    │     IGNORED        │
│   直接返回用户       │    │  需要纠正            │    │  条件被完全忽略     │
└─────────────────────┘    └─────────────────────┘    │  触发纠正流程       │
                                                      └─────────────────────┘
                                                                 │
                                                                 ▼
                                                      ┌─────────────────────┐
                                                      │ 生成纠正提示:        │
                                                      │ "用户查询批次MB-001 │
                                                      │  但返回了3条不匹配   │
                                                      │  的记录，请添加      │
                                                      │  WHERE batch_number │
                                                      │  = 'MB-001' 条件"   │
                                                      └─────────────────────┘
```

---

## 5. CRITIC + Reflexion 纠正流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      CRITIC + Reflexion 自我纠正算法                          │
│                          (基于 arXiv:2601.06860)                             │
└─────────────────────────────────────────────────────────────────────────────┘

Round 1: 初始执行
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│  用户查询     │ ──▶  │  LLM 生成    │ ──▶  │  工具执行    │
│  "查MB-001"  │      │  SQL 查询    │      │  返回结果    │
└──────────────┘      └──────────────┘      └──────────────┘
                                                   │
                                                   ▼
                                            ┌──────────────┐
                                            │ 外部验证器    │
                                            │ (CRITIC)     │
                                            │ 检测到问题:   │
                                            │ 条件被忽略    │
                                            └──────────────┘
                                                   │
                                    ┌──────────────┴──────────────┐
                                    │                             │
                               验证通过                        验证失败
                                    │                             │
                                    ▼                             ▼
                           ┌──────────────┐              ┌──────────────┐
                           │  返回结果    │              │ Reflexion    │
                           └──────────────┘              │ 生成反思:    │
                                                         │ "SQL缺少    │
                                                         │  WHERE条件" │
                                                         └──────────────┘
                                                                │
                                                                ▼
Round 2: 纠正后重试                                     ┌──────────────┐
┌──────────────┐      ┌──────────────┐                 │ 注入恢复提示 │
│  原始查询 +   │ ──▶  │  LLM 重新    │ ◀──────────────│ 到 LLM 上下文│
│  反思内容     │      │  生成查询    │                 └──────────────┘
└──────────────┘      └──────────────┘
                              │
                              ▼
                      ┌──────────────┐
                      │ 新 SQL:      │
                      │ SELECT *     │
                      │ WHERE batch  │
                      │ = 'MB-001'   │
                      └──────────────┘
                              │
                              ▼
                      ┌──────────────┐
                      │  工具执行    │
                      │  返回正确结果│
                      └──────────────┘
                              │
                              ▼
                      ┌──────────────┐
                      │ 外部验证器   │
                      │ 验证通过 ✅  │
                      └──────────────┘
                              │
                              ▼
                      ┌──────────────┐
                      │ 返回给用户   │
                      │ 纠正后的结果 │
                      └──────────────┘

重试机制:
┌─────────────────────────────────────────────────────────┐
│  最大重试次数: 3                                         │
│  每次重试间隔: 指数退避 (1s → 2s → 4s)                   │
│  重试条件: 验证失败 且 未达最大次数 且 shouldAttemptRecovery│
│  终止条件: 验证通过 或 达到最大次数 或 不可恢复错误        │
└─────────────────────────────────────────────────────────┘
```

---

## 6. 数据库表结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           数据库表关系图                                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────┐       ┌─────────────────────────┐
│   tool_call_records     │       │   tool_call_cache       │
│   (工具调用记录)         │       │   (调用缓存)             │
├─────────────────────────┤       ├─────────────────────────┤
│ id: BIGINT PK           │       │ id: BIGINT PK           │
│ session_id: VARCHAR     │       │ call_hash: VARCHAR UK   │
│ tool_name: VARCHAR      │       │ cached_result: TEXT     │
│ parameters: JSON        │       │ created_at: DATETIME    │
│ result: TEXT            │       │ expires_at: DATETIME    │
│ execution_time_ms: INT  │       └─────────────────────────┘
│ is_duplicate: BOOLEAN   │
│ is_corrected: BOOLEAN   │       ┌─────────────────────────┐
│ validation_result: ENUM │       │ correction_records      │
│ created_at: DATETIME    │       │   (纠正记录)            │
└─────────────────────────┘       ├─────────────────────────┤
            │                     │ id: BIGINT PK           │
            │ 1:N                 │ tool_call_id: BIGINT FK │
            ▼                     │ original_error: TEXT    │
┌─────────────────────────┐       │ failure_type: ENUM      │
│ tool_reliability_stats  │       │ recovery_prompt: TEXT   │
│   (工具可靠性统计)       │       │ corrected_params: JSON  │
├─────────────────────────┤       │ correction_result: TEXT │
│ id: BIGINT PK           │       │ is_successful: BOOLEAN  │
│ tool_name: VARCHAR UK   │       │ retry_count: INT        │
│ total_calls: INT        │       │ created_at: DATETIME    │
│ success_count: INT      │       └─────────────────────────┘
│ failure_count: INT      │
│ avg_execution_time: DBL │       ┌─────────────────────────┐
│ correction_success_rate │       │ behavior_calibration_   │
│ last_failure_type: ENUM │       │        metrics          │
│ updated_at: DATETIME    │       │   (校准指标)            │
└─────────────────────────┘       ├─────────────────────────┤
                                  │ id: BIGINT PK           │
                                  │ date: DATE UK           │
                                  │ total_tool_calls: INT   │
                                  │ duplicate_calls: INT    │
                                  │ failed_calls: INT       │
                                  │ corrected_calls: INT    │
                                  │ correction_success: INT │
                                  │ avg_correction_time: DBL│
                                  │ created_at: DATETIME    │
                                  └─────────────────────────┘
```

---

## 7. API 端点

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           REST API 端点                                      │
└─────────────────────────────────────────────────────────────────────────────┘

POST /api/mobile/ai/calibration/analyze
├── 请求: { "errorType": "...", "errorMessage": "...", "toolName": "..." }
└── 响应: { "failureType": "PARAMETER_ERROR", "recoveryPrompt": "...", "suggestions": [...] }

GET /api/mobile/ai/calibration/dashboard
├── 响应: {
│     "totalToolCalls": 1500,
│     "duplicateRate": 0.05,
│     "failureRate": 0.12,
│     "correctionSuccessRate": 0.85,
│     "topFailureTypes": [...],
│     "toolReliabilityRanking": [...]
│   }

GET /api/mobile/ai/calibration/tool/{toolName}/stats
├── 响应: {
│     "toolName": "material_batch_query",
│     "totalCalls": 500,
│     "successRate": 0.92,
│     "avgExecutionTime": 150,
│     "correctionSuccessRate": 0.88
│   }

POST /api/mobile/ai/calibration/verify
├── 请求: { "factoryId": "F001", "toolName": "...", "params": {...}, "error": "..." }
└── 响应: { "hasData": true, "suggestion": "...", "contextInfo": {...} }
```

---

## 8. 测试覆盖率

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        单元测试覆盖 (189 Tests)                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────┬────────┬─────────────────────────────────┐
│           测试类                │ 数量   │            覆盖功能              │
├────────────────────────────────┼────────┼─────────────────────────────────┤
│ PromptInjectionServiceTest     │   68   │ 失败分析、恢复提示、替代工具     │
├────────────────────────────────┼────────┼─────────────────────────────────┤
│ ExternalVerifierServiceTest    │   36   │ 数据验证、参数校验、SQL防护      │
├────────────────────────────────┼────────┼─────────────────────────────────┤
│ SelfCorrectionServiceTest      │   31   │ 纠正逻辑、重试机制、记录存储     │
├────────────────────────────────┼────────┼─────────────────────────────────┤
│ ToolResultValidatorServiceTest │   18   │ 意图匹配、条件检测、分数计算     │
├────────────────────────────────┼────────┼─────────────────────────────────┤
│ CorrectionAgentServiceTest     │   18   │ 纠正代理、LLM调用、结果处理      │
├────────────────────────────────┼────────┼─────────────────────────────────┤
│ ToolCallRedundancyServiceTest  │   10   │ 重复检测、哈希缓存、TTL管理      │
├────────────────────────────────┼────────┼─────────────────────────────────┤
│ BehaviorCalibrationServiceTest │    8   │ 协调流程、指标统计、整体集成     │
├────────────────────────────────┼────────┼─────────────────────────────────┤
│                         总计   │  189   │             100% PASS           │
└────────────────────────────────┴────────┴─────────────────────────────────┘
```

---

## 9. 关键代码文件

```
backend-java/src/main/java/com/cretas/aims/
├── service/calibration/
│   ├── BehaviorCalibrationService.java      # 协调中心接口
│   ├── ToolCallRedundancyService.java       # 重复检测接口
│   ├── PromptInjectionService.java          # 失败分析接口
│   ├── ToolResultValidatorService.java      # 结果验证接口
│   ├── ExternalVerifierService.java         # 外部验证接口
│   ├── SelfCorrectionService.java           # 自我纠正接口
│   ├── CorrectionAgentService.java          # 纠正代理接口
│   └── impl/
│       ├── BehaviorCalibrationServiceImpl.java
│       ├── ToolCallRedundancyServiceImpl.java
│       ├── PromptInjectionServiceImpl.java
│       ├── ToolResultValidatorServiceImpl.java
│       ├── ExternalVerifierServiceImpl.java
│       ├── SelfCorrectionServiceImpl.java
│       └── CorrectionAgentServiceImpl.java
├── entity/calibration/
│   ├── ToolCallRecord.java                  # 调用记录实体
│   ├── ToolCallCache.java                   # 缓存实体
│   ├── CorrectionRecord.java                # 纠正记录实体
│   ├── ToolReliabilityStats.java            # 可靠性统计实体
│   └── BehaviorCalibrationMetrics.java      # 校准指标实体
├── dto/calibration/
│   ├── FailureType.java                     # 失败类型枚举
│   ├── RecoveryPrompt.java                  # 恢复提示DTO
│   └── CalibrationDashboardDTO.java         # 仪表盘DTO
└── controller/
    └── BehaviorCalibrationController.java   # REST控制器
```
