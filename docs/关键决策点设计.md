## 关键决策点设计

### 1. 文档目的

本文档用于把“数字化转型的核心结果（去个人依赖）”落实为白垩纪系统的可落地设计清单：

- **把关键判断从人脑经验迁移为可执行规则**（可配置、可版本化、可复用）
- **把拍板迁移为流程约束**（状态机/审批流/权限边界）
- **把责任迁移为可追溯留痕**（可回放：who/when/what/before-after/why/ruleVersion）

输出形式：

- **现状已具备能力**（系统底座、接口、数据）
- **关键决策点清单**（每个决策：输入事实、规则、输出动作、审批与审计）
- **缺口与落地路线图**（按ROI排序、带验收口径）

### 2. 适用范围与优先级

- **范围**：白垩纪系统全局（生产/排产插单/库存/质检/供应商等），以“关键决策”作为主线。
- **优先级（当前业务最关键）**：
  - 排产与插单（含强制插单）
  - 质检放行（含返工/冻结/报废）
  - 供应商采购与验收（准入/禁入/加严验收）

### 3. 当前系统已具备的“去个人依赖”底座

#### 3.1 规则化能力（可执行规则）

- **已有能力**：Drools 规则引擎 + 规则存库 + 语法校验 + 热更新 + 工厂隔离 + 决策表（Excel→DRL）。
- **系统证据（实现入口）**：
  - `backend-java/src/main/java/com/cretas/aims/service/impl/RuleEngineServiceImpl.java`
  - `backend-java/src/main/java/com/cretas/aims/controller/RuleController.java`
  - `backend-java/src/main/java/com/cretas/aims/entity/rules/DroolsRule.java`
  - `backend-java/src/main/java/com/cretas/aims/controller/AIRuleController.java`（自然语言辅助生成规则与状态机配置）

这意味着：**“经验 → 规则”的承载方式已经存在**，无需从0开始补基础设施。

#### 3.2 流程化能力（状态机/流程约束入口）

- **已有能力**：状态机配置的管理入口已存在（与规则管理同属一个治理面）。
- **系统证据**：`RuleController` 下的状态机管理接口（state-machines）。

这意味着：可将“能不能走下一步”从代码硬编码，升级为**配置化流程门禁**。

#### 3.3 留痕能力（至少AI侧已跑通）

- **已有能力**：AI 相关调用链路存在审计日志落库模式（请求追踪、缓存命中、配额消耗、来源信息等）。
- **系统证据**：`backend-java/src/main/java/com/cretas/aims/service/AIEnterpriseService.java`（`AIAuditLog` 写入）

这意味着：审计体系的“写入方式与字段标准”在系统内已有成熟样板，可复用到业务关键决策。

### 4. 现状短板总结（为什么仍会依赖人）

从“去个人依赖”的验收口径看，当前主要短板集中在两类：

- **闭环不完整**：系统能记录或展示，但关键时刻仍可绕开流程或缺少审批链路。
- **可回放不足**：发生争议时，系统可能只能看到结果，缺少“为什么这么判”的规则版本与输入事实。

典型表现：

- 排产/插单存在“需要审批”的语义，但强制插单的审批记录在实现中仍有 TODO，容易退化为口头拍板。
- 质检可记录，但“放行/返工/冻结/报废”是否由规则驱动并强制门禁未形成统一闭环。
- 供应商已有台账与评级，但关键判断（准入/加严验收/禁入）还缺少可解释规则与回放。

### 5. 关键决策点总览（能力矩阵）

下表用于对齐目标与现状（结论用于指导后续迭代顺序）：

| 领域 | 关键决策 | 当前状态（简述） | 主要缺口 |
|---|---|---|---|
| 排产/插单 | 强制插单是否允许、是否需要审批、审批后如何生效 | 已有插单时段/影响分析/强制插单接口 | 审批闭环与审计缺失；规则化阈值不完整 |
| 质检放行 | 放行/返工/冻结/报废/加严抽检的动作决策 | 已有质检提交与统计 | 规则驱动动作与状态机门禁不足；审计不统一 |
| 供应商验收 | 准入/禁入/加严验收/价格异常处理 | 已有供应商台账/评级/状态切换 | 关键判断仍偏人工字段；缺少规则版本与回放 |
| 横切 | 统一审计 | AI侧已有审计范式 | 业务关键决策审计未统一；缺少可回放链路 |

### 6. 关键决策点设计清单（按领域）

本节给出可落地的“决策点模板”。每个决策点必须同时具备：

- **输入事实**（系统能拿到的数据项，明确来源）
- **规则**（可配置、可版本化、可解释）
- **输出动作**（系统自动动作或要求人工动作）
- **流程约束**（状态机与审批链）
- **审计留痕**（可回放）

#### 6.1 排产与插单（含强制插单）

##### 决策点 S1：插单时段推荐与风险等级判定

- **决策问题**：在给定产品类型、数量、交期条件下，系统如何给出可插单时段与推荐优先级？
- **输入事实**：
  - 产能（时段可用产能、产线切换成本、可用人员等）
  - 受影响计划列表（延迟分钟数、影响等级）
  - 订单交期与优先级（客户、违约风险、利润贡献等）
- **规则建议**：
  - 影响等级（none/low/medium/high）判定阈值：总延迟分钟数、影响计划数量、关键客户标识
  - 推荐分计算：交期紧迫度、影响等级、人员匹配度、切换成本
- **输出动作**：
  - 推荐时段列表（含解释：为什么推荐、风险在哪里）
  - 风险等级与建议策略（比如“需要审批/建议换产线/建议拆单”）
- **流程约束**：
  - 选中时段锁定（避免并发冲突）
  - 规则变更后影响可回放（推荐分应能解释）
- **审计留痕（最小字段）**：
  - requestId、factoryId、userId、输入条件快照、候选时段列表、最终选择、规则版本、推荐解释文本

##### 决策点 S2：强制插单的审批门禁

- **决策问题**：当用户选择强制插单（跳过影响检查）时，系统如何确保不依赖口头拍板？
- **输入事实**：
  - 强制插单请求（slotId、plannedQuantity、deadline、客户信息）
  - 影响分析结果（如果可计算则仍保留一份作为审计依据）
  - 当前角色权限（谁有权发起/谁有权审批/谁可越权）
- **规则建议**（示例）：
  - `impactLevel = high` 必须审批
  - `hasEnoughWorkers = false` 必须审批并要求补充方案（加班/外包/推迟某计划）
  - `totalDelayMinutes > X` 必须二级审批（部门主管 + 厂长/工厂超管）
- **输出动作**：
  - 生成审批单（pending）
  - 审批通过后才创建或激活生产计划（或将生产计划从 pending_approval → pending）
  - 审批拒绝则回滚锁定与计划
- **流程约束（状态机建议）**：
  - `urgentInsertApproval` 状态机：draft → submitted → approved/rejected → executed/void
  - `productionPlan` 状态机补充：pending_approval → pending → in_progress → completed/cancelled
- **审计留痕（最小字段）**：
  - 审批发起人、审批人、审批意见、审批依据（规则命中项）、审批前后影响对比、规则版本

#### 6.2 质检放行（含返工/冻结/报废）

##### 决策点 Q1：质检结果到处置动作的规则映射

- **决策问题**：质检完成后，系统如何给出“放行/返工/冻结/报废/加严抽检”的标准动作？
- **输入事实**：
  - 质检项结果（合格/不合格、缺陷类型、严重度、抽检比例、照片/证据）
  - 批次信息（产品类型、工艺环节、目标良品率）
  - 历史质量趋势（同供应商/同产品的缺陷率）
- **规则建议**：
  - 严重缺陷（critical）直接冻结并触发升级流程
  - 轻微缺陷允许返工并要求复检
  - 连续N次在同类缺陷上异常，触发“加严抽检”或供应商加严验收
- **输出动作**：
  - 自动生成处置建议与强制动作（能自动的自动执行，不能自动的要求人工确认）
- **流程约束（状态机建议）**：
  - 批次状态必须遵守：质检未通过不得进入 released/shipped
  - 返工必须产生返工记录与复检记录（不可只改字段）
- **审计留痕（最小字段）**：
  - 质检人、放行决策人、缺陷事实快照、命中规则、动作、例外理由（如有）

##### 决策点 Q2：放行权限与例外机制

- **决策问题**：谁能放行？什么情况下可以特批放行？特批如何追责？
- **输入事实**：
  - 用户角色与授权范围
  - 批次风险等级（来自 Q1）
- **规则建议**：
  - 高风险放行必须双人复核
  - 特批必须填写原因、有效期、复盘负责人
- **输出动作**：
  - 放行/拒绝放行/发起特批流程
- **审计留痕**：
  - 特批单的完整链路（原因、附件、审批人、有效期、复盘结论）

#### 6.3 供应商采购与验收（准入/禁入/加严验收）

##### 决策点 P1：供应商准入与分层策略

- **决策问题**：新供应商是否准入？准入后是普通验收还是加严验收？
- **输入事实**：
  - 供应商资质（证照、产品范围、合规记录）
  - 历史交付与质量（若无历史则走试用期策略）
  - 价格与波动（对比历史均值/市场参考价）
- **规则建议**（示例）：
  - 新供应商默认试用期：前N批强制加严验收
  - 评级低于R、或最近M次缺陷率超过阈值，自动降级或暂停
- **输出动作**：
  - 准入/拒绝/准入但加严验收
  - 生成准入决策记录（可追溯）
- **流程约束**：
  - 供应商状态变更（active/suspended）需要审批或满足规则条件
- **审计留痕**：
  - 准入决策依据、规则版本、责任人

##### 决策点 P2：到货验收策略与异常处理

- **决策问题**：某批到货如何验收？抽检比例多少？异常如何处置？
- **输入事实**：
  - 原料类型、到货批次、运输条件、历史问题类型
  - 供应商当前风险等级（来自 P1 规则输出）
- **规则建议**：
  - 高风险供应商的某些原料类别自动提高抽检比例
  - 触发阈值时自动冻结库存并通知采购与质检主管
- **输出动作**：
  - 验收策略（抽检比例、必检项、判定阈值）
  - 异常处置动作（冻结、退货、索赔、加严后续批次）
- **审计留痕**：
  - 验收策略生成依据、质检证据、处置动作链路

### 7. 横切设计：统一审计与可回放

为避免系统变成“电子记事本”，关键决策必须可回放。建议统一一个“决策审计”模型（实现上可用新表或AOP统一写入），至少覆盖：

- **主体信息**：factoryId、decisionType、entityType、entityId、requestId
- **人员与时间**：initiatorUserId、approverUserId（如有）、timestamps
- **输入事实快照**：factsJson（用于复盘与对比）
- **规则信息**：ruleGroup、ruleName、ruleVersion、matchedRules（命中列表）
- **输出动作**：decision、actionsJson、nextState
- **原因与例外**：reason、exceptionFlag、exceptionApprovalId
- **前后对比**：beforeJson、afterJson（核心字段差异）

### 8. 落地路线图（按ROI排序）

#### Phase A（最短路径，先解决“拍板依赖”）

- **A1 强制插单审批闭环**：把“等待审批”从文案变成真实流程与审计。
- **A2 关键决策审计统一化（最小可用）**：先覆盖插单审批与供应商状态变更。

验收口径（A阶段）：

- 同样输入条件下，插单风险判定一致；
- 强制插单必经审批门禁，绕不开；
- 审批链路可回放（规则版本、依据、批前批后影响对比）。

#### Phase B（把质检从“记录”升级为“决定下一步”）

- **B1 质检处置规则组落地**：规则输出动作与风险等级。
- **B2 批次状态机门禁接入关键路径**：质检未通过不可放行/出库/交付。

验收口径（B阶段）：

- 新人按系统规则也能得到与老师傅一致的放行/返工/冻结建议；
- 任意放行动作都有责任人、依据、证据与规则版本。

#### Phase C（把供应商判断从经验变成资产）

- **C1 准入/禁入/加严验收规则与决策表**：业务可配置、可解释、可回放。
- **C2 供应商风险等级联动到验收策略**：到货验收自动生成抽检策略。

验收口径（C阶段）：

- 换采购主管后，供应商准入/加严验收策略仍一致；
- 供应商状态变更必须有依据与审计记录。

### 9. 附录：与现有文档的关系

- 产品与业务目标：`docs/PRODUCT_DOCUMENT.md`
- 业务流程与数据流总览：`docs/BUSINESS_LOGIC_OVERVIEW.md`
- 配置化思想参考：`docs/配置化.md`


