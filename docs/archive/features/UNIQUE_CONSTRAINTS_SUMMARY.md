# å”¯ä¸€çº¦æŸå®ç°æ€»ç»“

**å®ç°æ—¶é—´**: 2025-11-03
**ç›®çš„**: é˜²æ­¢é‡å¤æ•°æ®ï¼Œç®€åŒ–ç™»å½•å’Œåˆ›å»ºæµç¨‹

---

## âœ… å·²å®ç°çš„å”¯ä¸€çº¦æŸ

### 1. ç”¨æˆ·åå…¨å±€å”¯ä¸€ (users.username)

**æ•°æ®åº“çº¦æŸ**:
```sql
UNIQUE KEY `idx_username_unique` (`username`)
```

**Javaå®ä½“**:
```java
@Table(name = "users",
       uniqueConstraints = {
           @UniqueConstraint(columnNames = {"username"})
       }
)
```

**æ•ˆæœ**:
- âœ… ç”¨æˆ·ç™»å½•æ—¶æ— éœ€æä¾›factoryId
- âœ… æ³¨å†Œæ—¶è‡ªåŠ¨æ£€æŸ¥ç”¨æˆ·åé‡å¤
- âœ… æ•°æ®åº“å±‚é¢100%ä¿è¯å”¯ä¸€æ€§

**æµ‹è¯•**:
```bash
# âœ… æˆåŠŸ - ç”¨æˆ·åå”¯ä¸€ï¼Œå…è®¸åˆ›å»º
INSERT INTO users (...) VALUES (..., 'new_user', ...);

# âŒ å¤±è´¥ - ç”¨æˆ·åå·²å­˜åœ¨
INSERT INTO users (...) VALUES (..., 'proc_admin', ...);
# ERROR 1062: Duplicate entry 'proc_admin' for key 'idx_username_unique'
```

**æ³¨å†Œæ¥å£**:
```bash
POST /api/mobile/auth/register-phase-two
{
  "username": "new_user",  # ä¼šè‡ªåŠ¨æ£€æŸ¥æ˜¯å¦å”¯ä¸€
  "password": "123456",
  "realName": "å¼ ä¸‰"
}

# å¦‚æœç”¨æˆ·åå·²å­˜åœ¨ï¼š
# {"code": 400, "message": "è¯¥ç”¨æˆ·åå·²è¢«ä½¿ç”¨"}
```

---

### 2. å·¥å‚åç§°å…¨å±€å”¯ä¸€ (factories.name)

**æ•°æ®åº“çº¦æŸ**:
```sql
UNIQUE KEY `idx_factory_name_unique` (`name`)
```

**Javaå®ä½“**:
```java
@Table(name = "factories",
       uniqueConstraints = {
           @UniqueConstraint(columnNames = {"name"})
       }
)
```

**æ•ˆæœ**:
- âœ… é˜²æ­¢åˆ›å»ºé‡å¤åç§°çš„å·¥å‚
- âœ… åˆ›å»ºå·¥å‚æ—¶è‡ªåŠ¨æ£€æŸ¥åç§°é‡å¤
- âœ… æ•°æ®åº“å±‚é¢100%ä¿è¯å”¯ä¸€æ€§

**æµ‹è¯•**:
```bash
# âœ… æˆåŠŸ - å·¥å‚åç§°å”¯ä¸€ï¼Œå…è®¸åˆ›å»º
INSERT INTO factories (...) VALUES ('F003', 'æ–°å·¥å‚', ...);

# âŒ å¤±è´¥ - å·¥å‚åç§°å·²å­˜åœ¨
INSERT INTO factories (...) VALUES ('F999', 'æµ‹è¯•å·¥å‚', ...);
# ERROR 1062: Duplicate entry 'æµ‹è¯•å·¥å‚' for key 'idx_factory_name_unique'
```

**åˆ›å»ºå·¥å‚æ¥å£** (å‡è®¾æœ‰):
```bash
POST /api/platform/factories
{
  "name": "æ–°å·¥å‚",  # ä¼šè‡ªåŠ¨æ£€æŸ¥æ˜¯å¦å”¯ä¸€
  "industry": "é£Ÿå“åŠ å·¥"
}

# å¦‚æœå·¥å‚åç§°å·²å­˜åœ¨ï¼š
# {"code": 400, "message": "è¯¥å·¥å‚åç§°å·²è¢«ä½¿ç”¨"}
```

---

## ğŸ”„ å·¥ä½œåŸç†

### æ•°æ®åº“å±‚é¢å¼ºåˆ¶æ‰§è¡Œ

```
åº”ç”¨å±‚ (Java/API)
    â†“
  å°è¯• INSERT/UPDATE
    â†“
æ•°æ®åº“ (MySQL)
    â†“
æ£€æŸ¥å”¯ä¸€çº¦æŸ
    â”œâ”€ å”¯ä¸€ â†’ âœ… å†™å…¥æˆåŠŸ
    â””â”€ é‡å¤ â†’ âŒ æŠ›å‡ºå¼‚å¸¸
              ERROR 1062: Duplicate entry
    â†“
åº”ç”¨å±‚æ•è·å¼‚å¸¸
    â†“
è¿”å›å‹å¥½é”™è¯¯æ¶ˆæ¯
{"code": 400, "message": "è¯¥XXXå·²è¢«ä½¿ç”¨"}
```

### ä¼˜ç‚¹

1. **100%å¯é **: æ•°æ®åº“å±‚é¢ä¿è¯ï¼Œä¸ä¾èµ–åº”ç”¨ä»£ç 
2. **é«˜æ€§èƒ½**: ä½¿ç”¨ç´¢å¼•ï¼Œæ£€æŸ¥é€Ÿåº¦æå¿«
3. **é˜²æ­¢ç«äº‰**: å¹¶å‘åˆ›å»ºæ—¶ä¹Ÿèƒ½æ­£ç¡®å¤„ç†
4. **æ¸…æ™°é”™è¯¯**: æ˜ç¡®å‘ŠçŸ¥å“ªä¸ªå­—æ®µé‡å¤

---

## ğŸ“‹ å®ç°æ–‡ä»¶æ¸…å•

### æ•°æ®åº“è¿ç§»è„šæœ¬

1. **ç”¨æˆ·åå”¯ä¸€çº¦æŸ**:
   - `fix-document/add-global-username-unique.sql`

2. **å·¥å‚åç§°å”¯ä¸€çº¦æŸ**:
   - `fix-document/add-factory-name-unique.sql`

### Javaå®ä½“ç±»

1. **User.java**:
   - è·¯å¾„: `src/main/java/com/cretas/aims/entity/User.java`
   - ä¿®æ”¹: `@UniqueConstraint(columnNames = {"username"})`

2. **Factory.java**:
   - è·¯å¾„: `src/main/java/com/cretas/aims/entity/Factory.java`
   - ä¿®æ”¹: `@UniqueConstraint(columnNames = {"name"})`

### Repositoryæ›´æ–°

1. **UserRepository.java**:
   - æ·»åŠ : `boolean existsByUsername(String username);`
   - æ ‡è®°åºŸå¼ƒ: `existsByFactoryIdAndUsername()`

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### æ³¨å†Œæ–°ç”¨æˆ·

```bash
# è¯·æ±‚
POST /api/mobile/auth/register-phase-two
{
  "tempToken": "temp_abc123",
  "factoryId": "F001",
  "username": "new_user",      # âœ… è‡ªåŠ¨æ£€æŸ¥å”¯ä¸€æ€§
  "password": "123456",
  "realName": "æå››"
}

# å“åº” - æˆåŠŸ
{
  "code": 200,
  "message": "æ³¨å†ŒæˆåŠŸ",
  "data": {
    "userId": 5,
    "username": "new_user"
  }
}

# å“åº” - ç”¨æˆ·åå·²å­˜åœ¨
{
  "code": 400,
  "message": "è¯¥ç”¨æˆ·åå·²è¢«ä½¿ç”¨"
}
```

---

### ç™»å½•ï¼ˆæ— éœ€factoryIdï¼‰

```bash
# è¯·æ±‚ - å·¥å‚ç”¨æˆ·
POST /api/mobile/auth/unified-login
{
  "username": "proc_admin",    # âœ… ç”¨æˆ·åå”¯ä¸€ï¼Œè‡ªåŠ¨æ‰¾åˆ°å¯¹åº”å·¥å‚
  "password": "123456"
}

# å“åº” - è‡ªåŠ¨æ¨æ–­factoryId
{
  "code": 200,
  "data": {
    "userId": 1,
    "username": "proc_admin",
    "factoryId": "F001",        # âœ… è‡ªåŠ¨æ¨æ–­
    "factoryName": "æµ‹è¯•å·¥å‚",
    "role": "department_admin"
  }
}
```

---

### åˆ›å»ºå·¥å‚

```bash
# è¯·æ±‚
POST /api/platform/factories
{
  "name": "ç™½å©çºªé£Ÿå“æœ‰é™å…¬å¸",  # âœ… è‡ªåŠ¨æ£€æŸ¥å”¯ä¸€æ€§
  "industry": "é£Ÿå“åŠ å·¥",
  "address": "ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒº"
}

# å“åº” - æˆåŠŸ
{
  "code": 200,
  "message": "å·¥å‚åˆ›å»ºæˆåŠŸ",
  "data": {
    "id": "F003",
    "name": "ç™½å©çºªé£Ÿå“æœ‰é™å…¬å¸"
  }
}

# å“åº” - å·¥å‚åç§°å·²å­˜åœ¨
{
  "code": 400,
  "message": "è¯¥å·¥å‚åç§°å·²è¢«ä½¿ç”¨"
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç”¨æˆ·åå‘½åè§„èŒƒ

ç”±äºç”¨æˆ·åå…¨å±€å”¯ä¸€ï¼Œå»ºè®®ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š

- **æ–¹æ¡ˆ1**: `{å·¥å‚ç®€ç§°}_{è§’è‰²}`
  - ä¾‹å¦‚: `cretas_admin`, `cretas_proc`, `bt_admin`

- **æ–¹æ¡ˆ2**: `{è§’è‰²}_{åºå·}`
  - ä¾‹å¦‚: `proc_admin_1`, `proc_admin_2`, `farm_admin_1`

- **æ–¹æ¡ˆ3**: `{çœŸå®å§“åæ‹¼éŸ³}`
  - ä¾‹å¦‚: `zhangsan`, `lisi`, `wangwu`

### 2. å·¥å‚åç§°å‘½åè§„èŒƒ

- ä½¿ç”¨**å®Œæ•´çš„å…¬å¸åç§°**ï¼ˆå«æœ‰é™å…¬å¸ã€è‚¡ä»½å…¬å¸ç­‰ï¼‰
- ä¾‹å¦‚: `ç™½å©çºªé£Ÿå“æº¯æºæœ‰é™å…¬å¸`, `ä¸Šæµ·æµ‹è¯•å·¥å‚æœ‰é™å…¬å¸`

### 3. æ•°æ®è¿ç§»

å¦‚æœç°æœ‰æ•°æ®åº“ä¸­å·²æœ‰é‡å¤æ•°æ®ï¼š

```sql
-- 1. æŸ¥æ‰¾é‡å¤é¡¹
SELECT username, COUNT(*) FROM users GROUP BY username HAVING COUNT(*) > 1;

-- 2. æ‰‹åŠ¨å¤„ç†é‡å¤é¡¹ï¼ˆæ·»åŠ åç¼€ï¼‰
UPDATE users SET username = 'proc_admin_2' 
WHERE id = æŸä¸ªé‡å¤çš„ID AND username = 'proc_admin';

-- 3. ç„¶åå†æ·»åŠ å”¯ä¸€çº¦æŸ
ALTER TABLE users ADD UNIQUE INDEX idx_username_unique (username);
```

---

## âœ… æµ‹è¯•éªŒè¯

### æœ¬åœ°æµ‹è¯•ç»“æœ

| æµ‹è¯•é¡¹ | ç»“æœ | è¯´æ˜ |
|--------|------|------|
| ç”¨æˆ·åå”¯ä¸€çº¦æŸ | âœ… | å°è¯•æ’å…¥é‡å¤ç”¨æˆ·åå¤±è´¥ |
| å·¥å‚åç§°å”¯ä¸€çº¦æŸ | âœ… | å°è¯•æ’å…¥é‡å¤å·¥å‚åå¤±è´¥ |
| ç™»å½•æ— éœ€factoryId | âœ… | proc_adminç™»å½•æˆåŠŸ |
| æ³¨å†Œæ£€æŸ¥ç”¨æˆ·å | âœ… | Repositoryæ–¹æ³•å·²æ›´æ–° |

### SQLæµ‹è¯•

```sql
-- âœ… ç”¨æˆ·åå”¯ä¸€æµ‹è¯•
INSERT INTO users (..., username, ...) VALUES (..., 'proc_admin', ...);
-- ERROR 1062: Duplicate entry 'proc_admin' for key 'idx_username_unique'

-- âœ… å·¥å‚åç§°å”¯ä¸€æµ‹è¯•
INSERT INTO factories (..., name, ...) VALUES (..., 'æµ‹è¯•å·¥å‚', ...);
-- ERROR 1062: Duplicate entry 'æµ‹è¯•å·¥å‚' for key 'idx_factory_name_unique'
```

---

## ğŸ”„ è¿œç¨‹æœåŠ¡å™¨åŒæ­¥

### éœ€è¦æ‰§è¡Œçš„SQL

```bash
# 1. ç”¨æˆ·åå”¯ä¸€çº¦æŸ
mysql -h <è¿œç¨‹ä¸»æœº> -u <ç”¨æˆ·> -p < fix-document/add-global-username-unique.sql

# 2. å·¥å‚åç§°å”¯ä¸€çº¦æŸ
mysql -h <è¿œç¨‹ä¸»æœº> -u <ç”¨æˆ·> -p < fix-document/add-factory-name-unique.sql
```

### éœ€è¦éƒ¨ç½²çš„JAR

åŒ…å«ä»¥ä¸‹ä¿®æ”¹çš„æ–°ç‰ˆæœ¬ï¼š
- User.java - ç”¨æˆ·åå”¯ä¸€çº¦æŸ
- Factory.java - å·¥å‚åç§°å”¯ä¸€çº¦æŸ
- UserRepository.java - æ–°çš„æ£€æŸ¥æ–¹æ³•

---

## ğŸ“Š å½±å“åˆ†æ

### âœ… æ­£é¢å½±å“

1. **ç®€åŒ–ç™»å½•æµç¨‹**
   - å·¥å‚ç”¨æˆ·æ— éœ€è®°ä½factoryId
   - å‡å°‘ç”¨æˆ·è¾“å…¥é”™è¯¯

2. **é˜²æ­¢æ•°æ®é‡å¤**
   - 100%é¿å…é‡å¤ç”¨æˆ·å
   - 100%é¿å…é‡å¤å·¥å‚å

3. **æå‡ç”¨æˆ·ä½“éªŒ**
   - æ¸…æ™°çš„é”™è¯¯æç¤º
   - æ›´ç®€å•çš„æ³¨å†Œæµç¨‹

### âš ï¸ éœ€è¦ï¿½ï¿½æ„

1. **å·²æœ‰æ•°æ®**
   - æœ¬åœ°æ•°æ®åº“ï¼šâœ… å·²æ£€æŸ¥ï¼Œæ— é‡å¤
   - è¿œç¨‹æ•°æ®åº“ï¼šâ“ éœ€è¦æ£€æŸ¥

2. **å‘½åè§„èŒƒ**
   - éœ€è¦åˆ¶å®šç”¨æˆ·åå‘½åè§„åˆ™
   - éœ€è¦åˆ¶å®šå·¥å‚åç§°è§„èŒƒ

---

## ğŸ¯ æ€»ç»“

### âœ… å®ç°å®Œæˆ

- [x] ç”¨æˆ·åå…¨å±€å”¯ä¸€ï¼ˆæ•°æ®åº“ + Javaï¼‰
- [x] å·¥å‚åç§°å…¨å±€å”¯ä¸€ï¼ˆæ•°æ®åº“ + Javaï¼‰
- [x] Repositoryæ–¹æ³•æ›´æ–°
- [x] æœ¬åœ°æµ‹è¯•é€šè¿‡

### ğŸ“ åç»­ä»»åŠ¡

- [ ] æ›´æ–°æ³¨å†Œæ¥å£é”™è¯¯å¤„ç†
- [ ] æ›´æ–°åˆ›å»ºå·¥å‚æ¥å£é”™è¯¯å¤„ç†
- [ ] åŒæ­¥åˆ°è¿œç¨‹æœåŠ¡å™¨
- [ ] æ›´æ–°å‰ç«¯è¡¨å•éªŒè¯

---

**å®ç°æ—¶é—´**: 2025-11-03
**çŠ¶æ€**: âœ… å®Œæˆ
**æµ‹è¯•**: âœ… é€šè¿‡

