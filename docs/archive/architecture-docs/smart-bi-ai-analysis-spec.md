# 动态BI + AI智能分析系统 完整技术规格文档

> **版本**: v1.0  
> **创建日期**: 2026-01-18  
> **目标用户**: 企业管理层（老板/高管）  
> **核心价值**: 上传Excel → 自动出图 → AI文字分析 → 自然语言问答

---

## 目录

1. [项目背景与目标](#一项目背景与目标)
2. [系统架构总览](#二系统架构总览)
3. [分析场景覆盖](#三分析场景覆盖)
4. [Excel动态识别规格](#四excel动态识别规格)
5. [核心指标体系](#五核心指标体系)
6. [智能图表生成规则](#六智能图表生成规则)
7. [AI分析Prompt模板](#七ai分析prompt模板)
8. [自然语言意图识别](#八自然语言意图识别)
9. [推荐算法规则](#九推荐算法规则)
10. [老板专属看板设计](#十老板专属看板设计)
11. [权限融合方案](#十一权限融合方案)
12. [数据接口规格](#十二数据接口规格)
13. [实施计划](#十三实施计划)
14. [文件结构](#十四文件结构)
15. [数据刷新与缓存策略](#十五数据刷新与缓存策略)
16. [前端导航与权限设计](#十六前端导航与权限设计)
17. [完整实施时间线](#十七完整实施时间线)

---

## 一、项目背景与目标

### 1.1 业务背景

企业管理层需要快速获取经营数据的洞察，但传统BI系统存在以下痛点：

- **数据导入繁琐**: 需要IT人员配置数据源，用户无法自助上传
- **报表固定死板**: 图表样式和维度固定，无法灵活调整
- **分析深度不足**: 只能看到数据，看不到问题和建议
- **交互方式单一**: 只能通过点击筛选，无法用自然语言提问

### 1.2 项目目标

构建一个**零代码、高适配、智能化**的动态BI+AI分析系统，实现：

1. **零代码**: 用户上传Excel即可自动识别字段、生成图表
2. **高适配**: 支持各种格式的财务/销售数据，动态适配字段名
3. **智能化**: AI自动生成分析报告，支持自然语言问答

### 1.3 核心用户场景

```
老板打开系统 → 看到经营看板和KPI卡片
           → 看到AI自动生成的文字分析（问题、机会、建议）
           → 点击快捷问题或输入自然语言提问
           → AI回答并可继续追问、下钻数据
```

### 1.4 与现有系统的融合

本系统将融合到现有的Cretas系统中，复用以下模块：

- **权限系统**: 复用现有的 sales（销售）、finance（财务）、analytics（分析）模块权限
- **报表服务**: 扩展现有的 ReportService，增加SmartBI分析能力
- **AI服务**: 复用现有的 AIEnterpriseService 的配额管理、缓存、审计日志机制
- **Excel工具**: 扩展现有的 ExcelUtil，增加动态字段识别能力

---

## 二、系统架构总览

### 2.1 整体数据流

系统的数据处理分为五个阶段：

**阶段一：Excel智能解析**
- 用户上传Excel文件
- 系统读取表头和样本数据
- 同义词映射引擎尝试匹配标准字段
- 对于无法匹配的字段，调用AI进行语义判断
- 输出字段映射结果和数据预览

**阶段二：数据特征分析**
- 分析每一列的数据类型（日期、数值、分类、ID）
- 识别数值列的子类型（金额、百分比、数量）
- 识别分类列的唯一值数量
- 输出数据特征分析结果

**阶段三：指标计算引擎**
- 根据识别的字段，计算可用指标
- 支持多维度聚合（按部门、区域、人员、产品）
- 计算同比、环比等趋势指标
- 输出结构化的指标数据

**阶段四：智能图表推荐**
- 根据数据特征推荐合适的图表类型
- 加载业务场景的固定图表模板
- 对于复杂情况，调用AI进行推荐
- 输出图表配置列表

**阶段五：AI分析生成**
- 加载对应场景的Prompt模板
- 填充结构化数据到模板
- 调用LLM生成分析报告
- 输出AI分析文本

**阶段六：自然语言交互**
- 接收用户的自然语言问题
- 意图识别确定问题类型
- 参数提取获取关键实体
- 动态生成SQL查询数据
- 调用AI生成回答

### 2.2 核心模块划分

**基础设施层（Phase 1）**
- Excel动态解析模块：负责读取和解析任意格式的Excel文件
- 字段映射引擎：通过同义词表和AI语义识别映射字段
- 数据特征分析器：自动识别列的数据类型和特征
- 指标计算引擎：提供可配置的指标计算公式

**分析模块层（Phase 2）**
- 销售分析服务：支持销售员、产品、客户三个维度的分析
- 部门分析服务：支持部门绩效、效率、成本的对比分析
- 区域分析服务：支持大区、省份、城市的地域分析
- 财务分析服务：支持成本、利润、应收、预算的财务分析

**AI智能层（Phase 3）**
- Prompt模板服务：管理各场景的AI分析Prompt模板
- 意图识别服务：识别用户自然语言问题的意图和参数
- 推荐算法服务：提供产品推荐、预警分级、激励方案生成

**API展示层（Phase 4）**
- SmartBI Controller：提供统一的API端点
- 图表配置API：提供图表类型和配置的数据结构
- 问答交互API：提供自然语言问答的接口

### 2.3 技术栈

- **后端框架**: Spring Boot 2.x
- **Excel处理**: EasyExcel（阿里巴巴）
- **AI服务**: 通义千问/DashScope API
- **数据库**: MySQL 8.0
- **缓存**: Redis（复用现有）

---

## 三、分析场景覆盖

### 3.1 场景全景图

本系统覆盖企业经营的七大分析场景：

| 场景 | 说明 | 核心问题 |
|-----|------|---------|
| **销售分析** | 分析销售业绩和趋势 | 谁卖得好？卖什么好？ |
| **部门分析** | 对比各部门的运营效率 | 哪个部门效率高？ |
| **区域分析** | 分析各地域的市场表现 | 哪个区域有潜力？ |
| **成本分析** | 分析成本结构和变化 | 成本花在哪里？ |
| **利润分析** | 分析盈利能力和趋势 | 利润来自哪里？ |
| **应收分析** | 分析应收账款和风险 | 谁欠钱？风险多大？ |
| **预算分析** | 对比预算执行情况 | 有没有超支？ |

### 3.2 分析维度

每个场景都支持四大分析维度：

**人员维度**
- 销售员个人绩效
- 部门团队表现
- 负责人管理效果

**产品维度**
- 产品类别销售
- 单品销量排名
- 产品毛利分析

**部门维度**
- 部门业绩排名
- 部门效率对比
- 部门成本分析

**地域维度**
- 大区销售分布
- 省份市场表现
- 城市下沉分析

### 3.3 交叉分析

除了单一维度，系统还支持交叉分析：

- **部门 × 区域**: 哪个部门在哪个区域表现好/差
- **人员 × 产品**: 哪个销售员擅长卖哪个产品
- **产品 × 区域**: 哪个产品在哪个区域卖得好

---

## 四、Excel动态识别规格

### 4.1 字段映射字典

系统预置了完整的同义词映射表，支持自动识别各种常见的字段名称。

#### 4.1.1 销售相关字段

| 标准字段 | 同义词列表 | 数据类型 | 必填 |
|---------|-----------|---------|------|
| order_date | 订单日期、日期、成交日期、销售日期、date | 日期 | 是 |
| salesperson_id | 销售员ID、员工编号、工号、emp_id | 字符串 | 是 |
| salesperson_name | 销售员、姓名、业务员、name | 字符串 | 是 |
| department | 部门、所属部门、团队、dept | 字符串 | 是 |
| region | 区域、大区、销售区域、area | 字符串 | 否 |
| province | 省份、省、province | 字符串 | 否 |
| city | 城市、市、city | 字符串 | 否 |
| customer_name | 客户、客户名称、公司名 | 字符串 | 否 |
| customer_type | 客户类型、客户分类 | 字符串 | 否 |
| product_id | 产品ID、商品编号、SKU | 字符串 | 否 |
| product_name | 产品、商品、品名 | 字符串 | 是 |
| product_category | 类别、品类、分类 | 字符串 | 否 |
| quantity | 数量、销售数量、件数、qty | 数值 | 是 |
| amount | 金额、销售额、成交金额、收入、revenue | 数值 | 是 |
| unit_price | 单价、售价、price | 数值 | 否 |
| monthly_target | 月目标、销售目标、目标金额、target | 数值 | 否 |

#### 4.1.2 财务相关字段

| 标准字段 | 同义词列表 | 数据类型 | 必填 |
|---------|-----------|---------|------|
| cost | 成本、成本金额、cost | 数值 | 否 |
| material_cost | 原材料成本、材料费、采购成本、进货成本 | 数值 | 否 |
| labor_cost | 人工成本、工资、人工费用、薪酬 | 数值 | 否 |
| overhead | 制造费用、间接费用、管理费用 | 数值 | 否 |
| total_cost | 总成本、成本合计 | 数值 | 否 |
| unit_cost | 成本价、采购价、进价 | 数值 | 否 |
| profit | 毛利、毛利额、利润、gross_profit | 数值 | 否 |
| gross_margin | 毛利率、利润率、margin | 百分比 | 否 |
| net_profit | 净利、净利润 | 数值 | 否 |
| net_margin | 净利率、净利润率 | 百分比 | 否 |

#### 4.1.3 应收应付字段

| 标准字段 | 同义词列表 | 数据类型 | 必填 |
|---------|-----------|---------|------|
| accounts_receivable | 应收账款、应收、AR | 数值 | 否 |
| accounts_payable | 应付账款、应付、AP | 数值 | 否 |
| collection | 回款、收款、已收 | 数值 | 否 |
| payment | 付款、已付 | 数值 | 否 |
| invoice_date | 开票日期、发票日期 | 日期 | 否 |
| due_date | 到期日、应收日期 | 日期 | 否 |
| aging_days | 账龄、天数 | 数值 | 否 |

#### 4.1.4 预算相关字段

| 标准字段 | 同义词列表 | 数据类型 | 必填 |
|---------|-----------|---------|------|
| budget_amount | 预算、预算金额、budget | 数值 | 否 |
| actual_amount | 实际、实际金额、actual | 数值 | 否 |
| variance | 差异、偏差 | 数值 | 否 |
| budget_category | 预算科目、费用类别 | 字符串 | 否 |

#### 4.1.5 组织架构字段

| 标准字段 | 同义词列表 | 数据类型 | 必填 |
|---------|-----------|---------|------|
| department_id | 部门编号、部门ID、dept_id | 字符串 | 否 |
| team | 团队、小组、group | 字符串 | 否 |
| manager | 负责人、经理、主管 | 字符串 | 否 |
| headcount | 人数、编制、员工数 | 数值 | 否 |
| hire_date | 入职日期、入职时间 | 日期 | 否 |
| cost_center | 成本中心 | 字符串 | 否 |

### 4.2 AI语义识别补充

当同义词表无法匹配时，系统会调用AI进行语义判断：

**触发条件**：字段名不在同义词表中，且该字段看起来有业务意义

**AI判断流程**：
1. 提取字段名和前5行样本数据
2. 构造Prompt询问AI该字段最可能对应的标准字段
3. AI返回匹配结果和置信度
4. 置信度大于70%则自动映射，否则提示用户手动选择

**示例**：
- 用户Excel字段名："业绩金额"
- AI判断：最可能对应 "amount"（销售额），置信度85%
- 系统自动映射

### 4.3 数据特征自动分析

系统会自动分析每一列的数据特征：

**日期列识别**
- 支持格式：yyyy-MM-dd、yyyy/MM/dd、yyyyMMdd、MM/dd/yyyy
- 判断规则：尝试解析为日期，成功率超过90%则判定为日期列

**数值列识别**
- 判断规则：数值占比超过95%，且有小数或大于100的值
- 子类型判断：
  - 金额：包含¥/$符号，或字段名含"金额/成本/收入"
  - 百分比：值在0-100或0-1之间，或字段名含"率"
  - 数量：整数为主，字段名含"数量/件数"

**分类列识别**
- 判断规则：唯一值数量小于总行数的20%，且唯一值不超过50个
- 典型示例：部门、区域、产品类别、客户类型

**ID列识别**
- 判断规则：唯一值数量约等于总行数，或字段名含"ID/编号/工号"

---

## 五、核心指标体系

### 5.1 销售指标

| 指标代码 | 指标名称 | 计算公式 | 单位 | 说明 |
|---------|---------|---------|------|------|
| SALES_AMOUNT | 销售额 | SUM(amount) | 元 | 基础销售金额 |
| ORDER_COUNT | 订单数 | COUNT(DISTINCT order_id) | 单 | 成交订单数量 |
| AVG_ORDER_VALUE | 客单价 | 销售额 / 订单数 | 元 | 平均每单金额 |
| DAILY_AVG_SALES | 日均销售 | 销售额 / 有效天数 | 元 | 日均销售额 |
| TARGET_COMPLETION | 目标完成率 | 实际销售额 / 目标 × 100 | % | 核心考核指标 |
| TARGET_GAP | 距目标差额 | 目标 - 实际销售额 | 元 | 完成目标还差多少 |
| MOM_GROWTH | 环比增长率 | (本期 - 上期) / 上期 × 100 | % | 与上月对比 |
| YOY_GROWTH | 同比增长率 | (本期 - 去年同期) / 去年同期 × 100 | % | 与去年同期对比 |
| SALES_PER_CAPITA | 人均产出 | 销售额 / 人数 | 元 | 人效指标 |
| CUSTOMER_COUNT | 客户数 | COUNT(DISTINCT customer) | 个 | 服务客户数 |
| NEW_CUSTOMER | 新客户数 | COUNT(首次购买客户) | 个 | 新开发客户 |
| CUSTOMER_RETENTION | 客户留存率 | 复购客户 / 上期客户 × 100 | % | 老客户留存 |

### 5.2 成本指标

| 指标代码 | 指标名称 | 计算公式 | 单位 | 说明 |
|---------|---------|---------|------|------|
| TOTAL_COST | 总成本 | SUM(cost) | 元 | 成本总额 |
| MATERIAL_COST_RATIO | 材料成本占比 | 材料成本 / 总成本 × 100 | % | 材料成本结构 |
| LABOR_COST_RATIO | 人工成本占比 | 人工成本 / 总成本 × 100 | % | 人工成本结构 |
| COST_PER_UNIT | 单位成本 | 总成本 / 销售数量 | 元 | 单件成本 |
| COST_PER_CAPITA | 人均成本 | 总成本 / 人数 | 元 | 人均投入 |
| COST_MOM_CHANGE | 成本环比变化 | (本期成本 - 上期成本) / 上期成本 × 100 | % | 成本趋势 |

### 5.3 利润指标

| 指标代码 | 指标名称 | 计算公式 | 单位 | 说明 |
|---------|---------|---------|------|------|
| GROSS_PROFIT | 毛利额 | 销售额 - 成本 | 元 | 毛利润 |
| GROSS_MARGIN | 毛利率 | 毛利额 / 销售额 × 100 | % | 盈利质量 |
| NET_PROFIT | 净利润 | 毛利 - 费用 | 元 | 最终利润 |
| NET_MARGIN | 净利率 | 净利润 / 销售额 × 100 | % | 净盈利能力 |
| ROI | 投入产出比 | 毛利 / 成本 × 100 | % | 投资回报 |
| PROFIT_PER_ORDER | 单笔利润 | 毛利额 / 订单数 | 元 | 每单贡献 |
| MARGIN_MOM_CHANGE | 毛利率环比 | 本期毛利率 - 上期毛利率 | pp | 盈利趋势 |

### 5.4 应收应付指标

| 指标代码 | 指标名称 | 计算公式 | 单位 | 说明 |
|---------|---------|---------|------|------|
| AR_BALANCE | 应收余额 | SUM(应收账款) | 元 | 应收总额 |
| AR_TURNOVER_DAYS | 应收周转天数 | 平均应收 / 日均销售额 | 天 | 回款效率 |
| COLLECTION_RATE | 回款率 | 已回款 / 应收总额 × 100 | % | 收款能力 |
| OVERDUE_RATIO | 逾期率 | 逾期应收 / 应收总额 × 100 | % | 风险指标 |
| AGING_30_RATIO | 30天以上账龄占比 | 30天以上应收 / 应收总额 × 100 | % | 账龄分布 |
| AGING_60_RATIO | 60天以上账龄占比 | 60天以上应收 / 应收总额 × 100 | % | 账龄分布 |
| AGING_90_RATIO | 90天以上账龄占比 | 90天以上应收 / 应收总额 × 100 | % | 高风险占比 |
| BAD_DEBT_RISK | 坏账风险金额 | 90天以上应收 × 坏账计提比例 | 元 | 风险量化 |
| AP_BALANCE | 应付余额 | SUM(应付账款) | 元 | 应付总额 |
| AP_TURNOVER_DAYS | 应付周转天数 | 平均应付 / 日均采购额 | 天 | 付款节奏 |

### 5.5 预算指标

| 指标代码 | 指标名称 | 计算公式 | 单位 | 说明 |
|---------|---------|---------|------|------|
| BUDGET_EXECUTION | 预算执行率 | 实际支出 / 预算 × 100 | % | 执行进度 |
| BUDGET_VARIANCE | 预算差异 | 实际 - 预算 | 元 | 偏差金额 |
| BUDGET_VARIANCE_RATE | 预算偏差率 | (实际 - 预算) / 预算 × 100 | % | 偏差比例 |
| BUDGET_REMAINING | 预算剩余 | 预算 - 已执行 | 元 | 剩余额度 |
| BUDGET_BURN_RATE | 预算消耗速度 | 已执行 / 已过天数 | 元/天 | 日均消耗 |
| BUDGET_FORECAST | 预算预测 | 消耗速度 × 剩余天数 + 已执行 | 元 | 预计执行 |

### 5.6 效率指标

| 指标代码 | 指标名称 | 计算公式 | 单位 | 说明 |
|---------|---------|---------|------|------|
| ACTIVE_DAYS | 活跃天数 | COUNT(有销售的日期) | 天 | 工作饱和度 |
| ACTIVE_RATE | 活跃率 | 活跃天数 / 工作日 × 100 | % | 出勤效率 |
| CONVERSION_RATE | 成交转化率 | 成交客户 / 拜访客户 × 100 | % | 销售能力 |
| PRODUCT_CONVERSION | 产品成交率 | 某产品成交次数 / 总成交次数 | % | 产品偏好 |

### 5.7 预警阈值配置

系统预置了各指标的预警阈值，用于自动生成预警提示：

**目标完成率**
- 红色预警（严重）：低于60%
- 黄色预警（关注）：60%~85%
- 绿色（正常）：高于85%

**毛利率**
- 红色预警：低于15%
- 黄色预警：15%~25%
- 绿色：高于25%

**环比增长率**
- 红色预警：低于-20%（急剧下滑）
- 黄色预警：-20%~-5%（小幅下滑）
- 绿色：高于-5%

**90天以上账龄占比**
- 红色预警：高于20%
- 黄色预警：10%~20%
- 绿色：低于10%

**预算执行率**
- 红色预警：高于120%（严重超支）
- 黄色预警：100%~120%（超支）
- 绿色：低于100%

---

## 六、智能图表生成规则

### 6.1 数据特征到图表类型的映射

系统根据数据特征自动推荐最合适的图表类型：

| 数据组合 | 推荐图表 | 配置说明 |
|---------|---------|---------|
| 时间列 + 1个数值列 | 折线图 | X轴为时间，Y轴为数值，展示趋势 |
| 时间列 + 多个数值列 | 多折线对比图 | X轴为时间，多条Y轴线，对比趋势 |
| 时间列 + 数值列 + 分类列 | 分组折线图 | 按分类拆分成多条线 |
| 分类列 + 1个数值列 | 柱状图（降序） | 展示TopN，按数值排序 |
| 分类列 + 2个数值列 | 分组柱状图 | 并列对比两个指标 |
| 分类列 + 百分比值 | 饼图或环形图 | 展示占比分布 |
| 目标列 + 实际列 | 完成率仪表盘 | 进度条样式展示完成情况 |
| 两个分类列 + 数值列 | 热力图 | 交叉分析 |
| 两个数值列 | 散点图 | 分析相关性 |
| 两个数值列 + 可选气泡大小 | 气泡图 | 三维度分析 |
| 地域列 + 数值列 | 地图 | 地理分布 |
| 层级分类 + 数值列 | 树图或旭日图 | 层级占比 |
| 多分类 + 多数值 | 雷达图 | 多维对比 |

### 6.2 销售场景图表模板

**销售额趋势图**
- 类型：折线图
- X轴：order_date（订单日期）
- Y轴：amount（销售额）
- 粒度选项：日、周、月
- 可选：叠加目标线
- 可选：显示环比标注

**销售员业绩排行**
- 类型：横向柱状图
- X轴：amount（销售额）
- Y轴：salesperson_name（销售员）
- 排序：降序
- 显示数量：Top 10
- 可选：叠加目标完成线
- 颜色规则：按完成率着色

**目标完成率仪表盘**
- 类型：仪表盘列表
- 指标：TARGET_COMPLETION
- 分组：salesperson_name
- 阈值：红色60%，黄色85%，绿色100%

**产品销售占比**
- 类型：饼图
- 数值：amount
- 分类：product_category
- 显示百分比标签

**销售额-毛利率分布**
- 类型：散点图
- X轴：amount（销售额）
- Y轴：GROSS_MARGIN（毛利率）
- 气泡大小：quantity（数量）
- 分类着色：salesperson_name
- 象限线：按平均值划分

**客户贡献Top10**
- 类型：横向柱状图
- X轴：amount
- Y轴：customer_name
- 排序：降序
- 显示数量：Top 10

### 6.3 部门场景图表模板

**部门业绩排行**
- 类型：横向柱状图
- X轴：amount
- Y轴：department
- 排序：降序
- 叠加目标完成线
- 颜色规则：按TARGET_COMPLETION着色

**部门目标完成率**
- 类型：仪表盘网格
- 指标：TARGET_COMPLETION
- 分组：department
- 布局：2x2网格

**部门销售趋势对比**
- 类型：多折线图
- X轴：week（周）
- Y轴：amount
- 系列：department

**部门效率矩阵**
- 类型：散点图
- X轴：SALES_PER_CAPITA（人均产出）
- Y轴：COST_PER_CAPITA（人均成本）
- 气泡大小：amount（销售额）
- 分类着色：department
- 象限标签：高效高投入、高效低投入、低效低投入、低效高投入

**部门销售占比变化**
- 类型：堆叠面积图
- X轴：month
- Y轴：amount
- 堆叠：department
- 显示百分比

**部门人员分布**
- 类型：环形图
- 数值：headcount
- 分类：department
- 中心文字：总人数

### 6.4 区域场景图表模板

**全国销售分布地图**
- 类型：中国地图
- 数值：amount
- 地理键：province
- 色阶：浅色到深色
- 提示信息：销售额、完成率、环比

**区域销售排行**
- 类型：横向柱状图
- X轴：amount
- Y轴：region
- 排序：降序
- 叠加目标完成线

**区域销售趋势**
- 类型：多折线图
- X轴：month
- Y轴：amount
- 系列：region
- 显示数量：Top 5

**区域目标完成情况**
- 类型：子弹图
- 实际值：amount
- 目标值：target
- 分组：region

**区域-省份销售占比**
- 类型：树图
- 数值：amount
- 一级分类：region
- 二级分类：province

**城市销售Top10**
- 类型：横向柱状图
- X轴：amount
- Y轴：city
- 排序：降序
- 显示数量：Top 10

### 6.5 财务场景图表模板

**利润趋势图**
- 类型：组合图
- X轴：month
- 柱状：GROSS_PROFIT（毛利额）
- 折线：GROSS_MARGIN（毛利率）

**成本结构饼图**
- 类型：饼图
- 数值：material_cost, labor_cost, overhead
- 标签：原材料、人工、制造费用

**应收账龄分布**
- 类型：堆叠柱状图
- X轴：customer_name
- 堆叠：0-30天、31-60天、61-90天、90天以上
- 显示数量：Top 10
- 排序：按总额降序

**应收账款趋势**
- 类型：组合图
- X轴：month
- 柱状：AR_BALANCE（应收余额）
- 折线：COLLECTION_RATE（回款率）

**预算执行瀑布图**
- 类型：瀑布图
- 分类：年度预算、Q1执行、Q2执行、Q3执行、Q4预测、剩余
- 显示累计

**预算vs实际对比**
- 类型：分组柱状图
- X轴：budget_category
- 分组：预算、实际
- 叠加差异线

**现金流趋势**
- 类型：面积图
- X轴：month
- Y轴：cash_balance
- 填充：渐变色

### 6.6 交叉分析图表模板

**部门-区域销售热力图**
- 类型：热力图
- X轴：region
- Y轴：department
- 数值：amount
- 色阶：白色到绿色

**销售员-产品成交分析**
- 类型：气泡图
- X轴：product_category
- Y轴：salesperson_name
- 气泡大小：amount
- 气泡颜色：GROSS_MARGIN

**区域内部门构成**
- 类型：堆叠柱状图
- X轴：region
- Y轴：amount
- 堆叠：department

---

## 七、AI分析Prompt模板

### 7.1 综合经营分析模板

**角色设定**：资深企业经营分析师，擅长从多维数据中发现业务问题并给出可执行建议

**数据输入**：
- 分析周期（起止日期）
- 数据范围描述
- 核心经营指标表（本期、上期、环比、目标、完成率）
- 部门表现表（销售额、完成率、人均产出、毛利率、环比）
- 区域表现表（销售额、完成率、环比、同比）
- 产品表现表（销售额、销量、毛利率、占比变化）

**分析任务**：
1. 经营概览：用2-3句话概括整体经营状况，突出最关键的1-2个发现
2. 业绩预警：按预警级别列出需要关注的部门和区域
3. 问题诊断：分析预警项的根本原因
4. 机会洞察：识别增长机会和高毛利机会
5. 行动建议：给出具体可执行的事项

**输出格式**：
- 经营概览（简短总结）
- 业绩预警（分红黄绿三级）
- 问题诊断（每个问题单独分析）
- 机会洞察（列表形式）
- 行动建议（本周重点和本月目标）

### 7.2 销售人员绩效分析模板

**角色设定**：销售团队主管，需要分析团队成员的业绩表现，识别问题并给出辅导建议

**数据输入**：
- 分析周期
- 团队/部门名称
- 销售员绩效汇总表（目标、实际、完成率、订单数、客单价、毛利率、环比、新客户）
- 销售员-产品明细表
- 销售员-客户明细表

**分析任务**：
1. 绩效排名与预警：按完成率排序，标记表现状态
2. 个人问题诊断：对低于80%完成率的销售员逐一分析
3. 产品推荐：根据历史成交数据推荐适合的产品
4. 激励方案：设计冲刺目标、主攻方向、激励措施

**输出格式**：每个销售员单独分析块

### 7.3 区域市场分析模板

**角色设定**：区域销售总监，需要分析各区域的市场表现，发现区域机会和问题

**数据输入**：
- 分析周期
- 区域销售汇总表（销售额、目标、完成率、环比、同比、人均产出、毛利率）
- 省份明细表
- 城市Top20表

**分析任务**：
1. 区域表现评估：排名和预警状态
2. 区域问题诊断：分析表现差的区域
3. 区域机会洞察：识别高增长低基数、高基数低增长、高毛利低销量区域
4. 资源调配建议：人员增减、预算分配、下沉市场建议

**输出格式**：包含地图热力描述的结构化报告

### 7.4 部门运营分析模板

**角色设定**：运营分析师，需要评估各部门的运营效率，发现管理问题

**数据输入**：
- 分析周期
- 部门业绩汇总表（人数、销售额、目标、完成率、人均产出、毛利率、环比）
- 部门成本汇总表（人工成本、运营成本、预算、执行率、人均成本、ROI）
- 部门人员结构表（完成率分布、新入职、离职）

**分析任务**：
1. 部门绩效排名
2. 效率矩阵分析：四象限划分
3. 部门问题诊断
4. 标杆学习建议
5. 各部门行动项

**输出格式**：包含效率象限图描述的结构化报告

### 7.5 财务分析模板

**角色设定**：财务分析师，需要分析公司财务状况，发现财务风险和改善机会

**数据输入**：
- 分析周期
- 利润分析表（收入、成本、毛利、毛利率、费用、净利、净利率）
- 成本结构表（成本类别、金额、占比、环比变化）
- 应收账款表（账龄分布、客户数）
- Top10应收客户表
- 预算执行表

**分析任务**：
1. 盈利分析：利润趋势、毛利率变化原因
2. 成本分析：成本结构、增长过快项、降本空间
3. 应收风险分析：账龄分布、坏账风险客户
4. 预算执行分析：超支科目、超支原因
5. 财务建议：现金流管理、成本控制、应收催收优先级

**输出格式**：包含关键财务指标预警的结构化报告

### 7.6 自然语言问答通用模板

**角色设定**：智能数据分析助手

**上下文信息**：
- 当前看板
- 当前筛选条件
- 用户历史问题

**数据上下文**：相关的数据片段

**回答要求**：
1. 直接回答用户问题，不绕弯子
2. 用数据说话，给出具体数字
3. 如果发现异常，主动指出
4. 如果有相关的深入问题，提示用户可以继续问
5. 回答控制在3-5句话内

---

## 八、自然语言意图识别

### 8.1 意图分类体系

系统将用户的自然语言问题分为以下几类意图：

**概览类意图**
- OVERVIEW：查看整体情况
- SUMMARY：生成汇总报告
- 示例句式："整体情况怎么样"、"本月总结"、"大盘数据"

**销售分析意图**
- SALES_OVERVIEW：销售概览
- SALESPERSON_DETAIL：查看某个销售员
- SALESPERSON_RANKING：销售员排名
- SALES_TARGET：目标完成情况
- 示例句式："销售情况"、"张三业绩"、"谁卖得最好"、"完成率多少"

**部门分析意图**
- DEPT_OVERVIEW：部门概览
- DEPT_DETAIL：查看某个部门
- DEPT_COMPARE：部门对比
- DEPT_STAFF：部门内人员情况
- DEPT_BENCHMARK：标杆部门
- 示例句式："部门对比"、"销售一部怎么样"、"一部和二部比"、"哪个部门做得好"

**区域分析意图**
- REGION_OVERVIEW：区域概览
- REGION_DETAIL：查看某个区域
- REGION_COMPARE：区域对比
- REGION_OPPORTUNITY：区域机会
- CITY_DRILL：城市下钻
- 示例句式："各地销售"、"华东怎么样"、"比较华东和华南"、"哪个区域有机会"

**产品分析意图**
- PRODUCT_OVERVIEW：产品概览
- PRODUCT_DETAIL：查看某个产品
- PRODUCT_RECOMMEND：产品推荐
- PRODUCT_MIX：产品结构
- 示例句式："哪个产品卖得好"、"推荐卖什么"、"产品结构"

**财务分析意图**
- PROFIT_ANALYSIS：利润分析
- COST_ANALYSIS：成本分析
- AR_ANALYSIS：应收分析
- BUDGET_ANALYSIS：预算分析
- CASHFLOW_ANALYSIS：现金流分析
- 示例句式："毛利怎么样"、"成本花在哪"、"谁欠钱"、"有没有超支"

**问题诊断意图**
- WHY_ANALYSIS：原因分析
- PROBLEM_FIND：发现问题
- ANOMALY_DETECT：异常检测
- 示例句式："为什么下降"、"有什么问题"、"哪里异常"

**建议类意图**
- ACTION_SUGGEST：行动建议
- INCENTIVE_PLAN：激励方案
- RESOURCE_ALLOC：资源分配
- 示例句式："怎么办"、"怎么激励"、"资源怎么分"

**预测类意图**
- FORECAST：预测
- TREND_PREDICT：趋势预测
- 示例句式："能完成目标吗"、"下个月会怎样"

**操作类意图**
- DRILL_DOWN：数据下钻
- COMPARE：对比
- FILTER：筛选
- EXPORT：导出
- 示例句式："展开看看"、"对比一下"、"只看华东"、"导出数据"

**交叉分析意图**
- DEPT_IN_REGION：部门在区域的表现
- SALESPERSON_PRODUCT：销售员的产品分析
- PRODUCT_REGION：产品的区域分布
- 示例句式："销售一部在华东怎么样"、"张三卖什么产品好"

### 8.2 参数提取规则

从用户问题中提取关键参数：

**时间范围提取**
- "今天" → today
- "昨天" → yesterday
- "本周" → this_week
- "上周" → last_week
- "本月" → this_month
- "上月" → last_month
- "本季度" → this_quarter
- "今年" → this_year
- "X月" → month:X
- "最近X天" → last_n_days:X
- 默认：this_month

**人名提取**
- 从销售员表中模糊匹配
- 支持姓名、工号

**部门名提取**
- 从部门表中匹配
- 支持别名，如"一部"→"销售一部"

**区域名提取**
- 从区域表中匹配
- 支持别名，如"华东"→"华东区"
- 支持省份、城市名

**产品名提取**
- 从产品表中模糊匹配
- 支持产品名、类别名

**指标名提取**
- "销售额/业绩/收入" → amount
- "毛利/利润" → profit
- "毛利率/利润率" → margin
- "完成率/达成率" → completion_rate
- "成本" → cost
- "订单/成交" → order_count

**方向词提取**
- "下降/下滑/降低/减少/差" → decrease
- "上升/增长/提高/增加/好" → increase

---

## 九、推荐算法规则

### 9.1 产品推荐评分模型

为每个销售员推荐最适合的产品，评分公式：

**总分 = 毛利分×35% + 库存分×15% + 历史成交分×35% + 热度分×15%**

**毛利分（0-100分）**
- 毛利率≥40%：100分
- 毛利率30%~40%：85分
- 毛利率20%~30%：70分
- 毛利率10%~20%：50分
- 毛利率<10%：30分

**库存分（0-100分）**
- 库存天数<7天：20分（库存紧张，不推荐）
- 库存天数7~14天：50分（偏紧）
- 库存天数14~45天：100分（健康，优先推荐）
- 库存天数45~90天：80分（略多，可推）
- 库存天数>90天：90分（积压，需要消化，提高权重）

**历史成交分（0-100分）**
- 该销售员成交率≥30%：100分（非常擅长）
- 成交率20%~30%：85分
- 成交率10%~20%：60分
- 成交率5%~10%：40分
- 成交率1%~5%：25分（有成交但不多）
- 成交率0%：15分（从未成交，谨慎推荐）

**热度分（0-100分）**
- 按全公司近30天销量排名的百分位计算
- 排名前10%：100分
- 排名前30%：80分
- 排名前50%：60分
- 排名后50%：40分

**推荐等级**
- ≥75分：强烈推荐
- 60~75分：推荐
- 45~60分：可尝试
- <45分：不推荐

### 9.2 销售员预警分级模型

对销售员进行预警分级，帮助管理层快速识别需要关注的人员。

**基础分（根据完成率）**
- 完成率<50%：10分
- 完成率50%~65%：30分
- 完成率65%~80%：50分
- 完成率80%~95%：70分
- 完成率≥95%：90分

**趋势调整（根据环比）**
- 环比<-30%：-20分（急剧下滑）
- 环比-30%~-15%：-10分（明显下滑）
- 环比-15%~-5%：-5分（小幅下滑）
- 环比-5%~+5%：0分（持平）
- 环比+5%~+15%：+5分（小幅增长）
- 环比>+15%：+10分（明显增长）

**问题诊断**
自动检测以下问题：
- 订单量不足：订单数低于团队平均的60%
- 客单价偏低：客单价低于团队平均的75%
- 产品毛利低：毛利率低于团队平均的85%
- 活跃度不足：活跃天数少于工作日的70%
- 客户流失：本月流失客户超过3个

**最终预警等级**
- 综合分<25分：红色（立即干预）
- 综合分25~50分：橙色（重点关注）
- 综合分50~70分：黄色（需要关注）
- 综合分≥70分：绿色（正常）

### 9.3 激励方案生成规则

为需要帮助的销售员自动生成个性化激励方案。

**冲刺目标设定**
- 已完成目标：设置超额目标（差额的30%）
- 差额在可达成的50%以内：设置全额冲刺目标
- 差额在可达成的50%~100%：设置80%作为冲刺目标
- 差额超过可达成范围：设置阶段性目标（可达成的70%）

**可达成范围计算**
- 基于过去30天的日均销售额
- 乘以剩余天数
- 乘以1.2（最多提升20%）

**产品策略**
- 推荐3个得分最高的产品作为主推
- 避免推荐得分低于45的产品

**客户策略**
- 推荐5个30天未购买的沉睡客户进行回访
- 推荐3个高潜力客户重点跟进

**激励措施**
- 冲刺目标≤5000元：完成奖励50元现金红包
- 冲刺目标5000~15000元：完成奖励150元现金红包
- 冲刺目标15000~30000元：完成奖励300元现金红包
- 冲刺目标>30000元：完成奖励销售额0.5%额外提成

**针对问题的额外激励**
- 订单量不足：每新增一个成交客户额外奖励30元
- 客户流失：每挽回一个流失客户奖励100元

### 9.4 区域机会评分模型

识别值得投入的区域机会。

**总分 = 增长分×30% + 基数分×20% + 毛利分×25% + 渗透空间分×25%**

**增长分（0-100分）**
- 环比增长≥30%：100分
- 环比增长15%~30%：80分
- 环比增长5%~15%：60分
- 环比-5%~+5%：40分
- 环比<-5%：20分

**基数分（0-100分）**
适中基数得分最高，太小风险高，太大增长难
- 销售额为公司区域平均的30%~70%：100分（潜力大）
- 销售额为公司区域平均的70%~120%：70分（正常）
- 销售额超过公司区域平均的120%：40分（基数大，增长难）
- 销售额低于公司区域平均的30%：50分（基数太小，风险高）

**毛利分（0-100分）**
- 毛利率≥30%：100分
- 毛利率25%~30%：80分
- 毛利率20%~25%：60分
- 毛利率<20%：40分

**渗透空间分（0-100分）**
- 市场渗透率≤10%：100分（大量空白市场）
- 渗透率10%~20%：80分
- 渗透率20%~40%：60分
- 渗透率>40%：30分（已较饱和）

**机会类型分类**
- 高增长+低基数：高增长潜力区（重点培育）
- 负增长+高基数：需要激活区（诊断问题）
- 高毛利+低销量：高利润深耕区（值得深耕）
- 低渗透：蓝海开拓区（市场开发）
- 其他：常规发展区

---

## 十、老板专属看板设计

### 10.1 看板布局结构

老板看板分为以下几个区域：

**顶部标题栏**
- 系统名称：经营驾驶舱
- 当前周期：2026年1月
- 更新时间：刚刚更新

**KPI卡片区（第一行）**
四个核心KPI卡片并排显示：
- 本月销售额：金额 + 环比变化
- 目标完成率：百分比 + 预警状态
- 毛利率：百分比 + 环比变化
- 应收余额：金额 + 30天以上占比

**部门与区域排行区（第二行）**
左右两栏并排：
- 左栏：部门业绩排行（前4名，含完成率和预警图标）
- 右栏：区域业绩排行（前4名，含完成率和预警图标）

**趋势图与占比图区（第三行）**
左右两栏并排：
- 左栏：销售额趋势折线图（按周）
- 右栏：产品销售占比饼图

**AI智能洞察区**
突出显示的文字区域：
- AI自动生成的3-4句核心发现
- 每条发现标注预警级别（红/黄）
- 亮点也要提及（绿色）

**快捷提问区**
- 预设的快捷问题按钮（4-6个）
- 自由输入框
- 发送按钮

### 10.2 KPI卡片设计

每个KPI卡片包含：
- 指标名称（标题）
- 当前值（大字）
- 变化指标（环比/同比，带箭头）
- 预警状态（红黄绿圆点或背景色）
- 可选的子指标

### 10.3 排行榜设计

排行榜包含：
- 排名图标（金银铜牌或预警图标）
- 名称（部门/区域）
- 完成率进度条
- 完成率数值
- 预警颜色（进度条颜色）

### 10.4 AI洞察区设计

AI洞察区包含：
- 醒目的标题图标
- 总结性描述（1-2句）
- 问题列表（带预警级别标记）
- 亮点描述（正面发现）

### 10.5 问答交互设计

**快捷问题**
预设常见问题按钮：
- 销售四部为什么差
- 西南区问题在哪
- 高毛利产品推荐
- 谁该奖励

**自由提问**
- 输入框支持自然语言
- 支持历史记录
- 支持追问（上下文保持）

**回答展示**
- AI回答文字
- 相关数据卡片
- 可下钻的选项
- 建议的后续问题

---

## 十一、权限融合方案

### 11.1 现有权限体系

系统现有的权限模块包括：
- dashboard：仪表盘
- production：生产
- warehouse：仓库
- quality：质量
- procurement：采购
- **sales：销售**
- hr：人事
- equipment：设备
- **finance：财务**
- system：系统
- **analytics：数据分析**

权限类型包括：
- none：无权限
- read：只读
- write：只写
- read_write：读写

### 11.2 SmartBI权限设计

SmartBI功能将融合到现有权限体系中，复用sales、finance、analytics模块：

**Excel上传功能**
- 权限要求：analytics:write
- 说明：需要数据分析写权限才能上传Excel

**销售分析功能**
- 权限要求：sales:read
- 说明：需要销售只读权限才能查看销售分析

**财务分析功能**
- 权限要求：finance:read
- 说明：需要财务只读权限才能查看财务分析

**老板看板功能**
- 权限要求：analytics:read
- 说明：需要数据分析只读权限才能查看看板

**自然语言问答功能**
- 权限要求：sales:read 或 finance:read
- 说明：根据问题涉及的数据范围动态检查权限

### 11.3 角色权限配置

**factory_super_admin（超级管理员）**
- 所有SmartBI功能均可访问

**dispatcher（调度员）**
- 可以上传Excel
- 可以查看销售分析
- 可以查看财务分析
- 可以使用老板看板
- 可以使用问答功能

**sales_manager（销售经理）**
- 可以查看销售分析
- 可以查看与销售相关的问答

**finance_manager（财务经理）**
- 可以查看财务分析
- 可以查看与财务相关的问答

**其他角色**
- 按其现有的sales/finance/analytics权限决定SmartBI功能访问范围

### 11.4 数据权限控制

除了功能权限，还需要数据权限控制：

**工厂隔离**
- 所有数据按factoryId隔离
- 用户只能看到自己所属工厂的数据

**部门隔离（可选）**
- 部门经理只能看到自己部门的详细数据
- 其他部门只显示汇总数据

**敏感字段脱敏**
- 对于低权限用户，敏感财务数据可脱敏显示

---

## 十二、数据接口规格

### 12.1 Excel上传解析接口

**端点**：POST /api/mobile/{factoryId}/smart-bi/upload

**权限**：analytics:write

**请求**：
- Content-Type: multipart/form-data
- file: Excel文件
- data_type: 数据类型（sales_order/salesperson/product/finance）

**响应**：
- success: 是否成功
- data.file_id: 上传后的文件ID
- data.detected_columns: 识别的字段映射列表
  - original: 原始字段名
  - mapped_to: 映射到的标准字段
  - confidence: 置信度
- data.unmapped_columns: 未能映射的字段列表
- data.row_count: 数据行数
- data.date_range: 数据的日期范围
- data.preview_data: 前5行预览数据

### 12.2 销售分析接口

**端点**：GET /api/mobile/{factoryId}/smart-bi/analysis/sales

**权限**：sales:read

**参数**：
- start_date: 开始日期
- end_date: 结束日期
- department: 部门筛选（可选）
- region: 区域筛选（可选）
- dimension: 分析维度（salesperson/product/customer）

**响应**：
- success: 是否成功
- data.metrics: 各项销售指标
- data.charts: 图表配置列表
- data.rankings: 排行榜数据
- data.alerts: 预警信息

### 12.3 部门分析接口

**端点**：GET /api/mobile/{factoryId}/smart-bi/analysis/department

**权限**：analytics:read

**参数**：
- start_date: 开始日期
- end_date: 结束日期
- department: 指定部门（可选，不传则分析所有部门）

**响应**：
- success: 是否成功
- data.metrics: 各部门指标
- data.charts: 图表配置
- data.efficiency_matrix: 效率矩阵数据
- data.benchmark: 标杆部门信息

### 12.4 区域分析接口

**端点**：GET /api/mobile/{factoryId}/smart-bi/analysis/region

**权限**：analytics:read

**参数**：
- start_date: 开始日期
- end_date: 结束日期
- region: 区域筛选（可选）
- level: 分析层级（region/province/city）

**响应**：
- success: 是否成功
- data.metrics: 各区域指标
- data.charts: 图表配置
- data.map_data: 地图数据
- data.opportunities: 区域机会列表

### 12.5 财务分析接口

**端点**：GET /api/mobile/{factoryId}/smart-bi/analysis/finance

**权限**：finance:read

**参数**：
- start_date: 开始日期
- end_date: 结束日期
- analysis_type: 分析类型（profit/cost/ar/budget）

**响应**：
- success: 是否成功
- data.metrics: 财务指标
- data.charts: 图表配置
- data.alerts: 财务预警
- data.recommendations: 财务建议

### 12.6 老板看板接口

**端点**：GET /api/mobile/{factoryId}/smart-bi/dashboard/executive

**权限**：analytics:read

**参数**：
- period: 周期（this_month/last_month/this_quarter）

**响应**：
- success: 是否成功
- data.kpi_cards: KPI卡片数据
- data.dept_ranking: 部门排行
- data.region_ranking: 区域排行
- data.charts: 图表配置
- data.ai_insights: AI洞察文字
- data.quick_questions: 快捷问题列表

### 12.7 自然语言问答接口

**端点**：POST /api/mobile/{factoryId}/smart-bi/query

**权限**：sales:read 或 finance:read（动态检查）

**请求**：
- user_input: 用户输入的自然语言问题
- context: 上下文信息
  - current_view: 当前所在的视图
  - selected_filters: 当前筛选条件
  - conversation_id: 会话ID（用于追问）

**响应**：
- success: 是否成功
- data.intent: 识别的意图
- data.params: 提取的参数
- data.answer: AI回答文字
- data.data_cards: 相关数据卡片
- data.drill_down_options: 可下钻的选项
- data.suggested_questions: 建议的后续问题

### 12.8 数据下钻接口

**端点**：POST /api/mobile/{factoryId}/smart-bi/drill-down

**权限**：继承父查询的权限

**请求**：
- dimension: 下钻维度
- filter_value: 筛选值
- parent_context: 父查询上下文

**响应**：
- success: 是否成功
- data.metrics: 下钻后的指标
- data.charts: 图表配置
- data.detail_table: 明细数据表

### 12.9 AI分析生成接口

**端点**：POST /api/mobile/{factoryId}/smart-bi/ai-analysis

**权限**：analytics:read

**请求**：
- analysis_type: 分析类型（overview/sales/department/region/finance）
- time_range: 时间范围
- scope: 分析范围

**响应**：
- success: 是否成功
- data.analysis_text: AI分析文字
- data.key_findings: 关键发现列表
- data.recommendations: 建议列表
- data.quota_used: 本次消耗的AI配额

---

## 十三、实施计划

### 13.1 Phase 1：基础设施层（可并行3个任务）

**任务1A：Excel动态解析模块**
- 创建DynamicExcelParser：不依赖固定Class的动态解析
- 创建FieldMappingEngine：同义词映射 + AI语义识别
- 创建DataFeatureAnalyzer：自动识别数据类型和特征
- 扩展ExcelUtil：添加动态读取方法
- 文件位置：service/smartbi/

**任务1B：智能BI核心服务**
- 创建SmartBIService接口和实现类
- 创建MetricCalculator：指标计算引擎
- 创建ChartRecommender：图表智能推荐
- 文件位置：service/smartbi/

**任务1C：数据库设计**
- smart_bi_datasets表：用户上传的数据集
- smart_bi_field_mappings表：字段映射配置
- smart_bi_analysis_cache表：分析结果缓存
- smart_bi_query_logs表：自然语言查询日志
- 文件位置：resources/db/migration/

### 13.2 Phase 2：分析模块层（可并行4个任务）

**任务2A：销售分析模块**
- 创建SalesAnalysisService
- 创建SalesMetricsDTO
- 实现人员/产品/客户三个维度的分析
- 扩展现有ReportService.getSalesReport()

**任务2B：部门分析模块**
- 创建DepartmentAnalysisService
- 创建DepartmentMetricsDTO
- 实现效率矩阵、标杆对比等分析

**任务2C：区域分析模块**
- 创建RegionAnalysisService
- 创建RegionMetricsDTO
- 实现大区/省份/城市层级分析
- 实现区域机会评分模型

**任务2D：财务分析模块**
- 创建FinanceAnalysisService
- 创建FinanceMetricsDTO
- 实现成本/利润/应收/预算分析
- 扩展现有ReportService.getFinanceReport()

### 13.3 Phase 3：AI智能层（可并行3个任务）

**任务3A：AI Prompt服务**
- 创建SmartBIPromptService
- 创建Prompt模板文件
- 复用AIEnterpriseService的配额和审计机制

**任务3B：意图识别服务**
- 创建SmartBIIntentService
- 创建IntentResultDTO
- 创建SmartBIIntentConfig配置
- 实现意图分类和参数提取

**任务3C：推荐算法服务**
- 创建RecommendationService
- 实现产品推荐评分模型
- 实现销售员预警分级模型
- 实现激励方案生成规则

### 13.4 Phase 4：API展示层（可并行3个任务）

**任务4A：SmartBI Controller**
- 创建SmartBIController
- 实现所有API端点
- 集成权限检查
- 融合到现有API路径体系

**任务4B：图表配置API**
- 创建ChartConfigDTO
- 创建DashboardConfigDTO
- 实现图表配置的数据结构

**任务4C：问答交互API**
- 实现query端点
- 实现drill-down端点
- 实现suggestions端点

### 13.5 任务依赖关系

Phase 1 → Phase 2 → Phase 3 → Phase 4

每个Phase内部的任务可以并行执行。

---

## 十四、文件结构

### 14.1 后端文件结构

```
backend-java/src/main/java/com/cretas/aims/
├── controller/
│   └── SmartBIController.java              # SmartBI统一控制器
│
├── service/
│   └── smartbi/
│       ├── SmartBIService.java             # 核心服务接口
│       ├── SmartBIServiceImpl.java         # 核心服务实现
│       ├── DynamicExcelParser.java         # Excel动态解析
│       ├── FieldMappingEngine.java         # 字段映射引擎
│       ├── DataFeatureAnalyzer.java        # 数据特征分析
│       ├── MetricCalculator.java           # 指标计算引擎
│       ├── ChartRecommender.java           # 图表推荐
│       ├── SalesAnalysisService.java       # 销售分析服务
│       ├── DepartmentAnalysisService.java  # 部门分析服务
│       ├── RegionAnalysisService.java      # 区域分析服务
│       ├── FinanceAnalysisService.java     # 财务分析服务
│       ├── SmartBIPromptService.java       # Prompt模板服务
│       ├── SmartBIIntentService.java       # 意图识别服务
│       └── RecommendationService.java      # 推荐算法服务
│
├── dto/
│   └── smartbi/
│       ├── ExcelParseResultDTO.java        # Excel解析结果
│       ├── FieldMappingDTO.java            # 字段映射
│       ├── SalesMetricsDTO.java            # 销售指标
│       ├── DepartmentMetricsDTO.java       # 部门指标
│       ├── RegionMetricsDTO.java           # 区域指标
│       ├── FinanceMetricsDTO.java          # 财务指标
│       ├── ChartConfigDTO.java             # 图表配置
│       ├── DashboardConfigDTO.java         # 看板配置
│       ├── IntentResultDTO.java            # 意图识别结果
│       ├── QueryRequestDTO.java            # 问答请求
│       └── QueryResponseDTO.java           # 问答响应
│
├── entity/
│   └── smartbi/
│       ├── SmartBIDataset.java             # 数据集实体
│       ├── SmartBIFieldMapping.java        # 字段映射实体
│       └── SmartBIQueryLog.java            # 查询日志实体
│
├── repository/
│   └── smartbi/
│       ├── SmartBIDatasetRepository.java
│       ├── SmartBIFieldMappingRepository.java
│       └── SmartBIQueryLogRepository.java
│
└── config/
    └── SmartBIConfig.java                  # SmartBI配置类
```

### 14.2 资源文件结构

```
backend-java/src/main/resources/
├── db/migration/
│   └── V2026_01_19_01__smart_bi_tables.sql  # 数据库迁移脚本
│
└── prompts/
    └── smartbi/
        ├── overview_analysis.md             # 综合分析模板
        ├── sales_analysis.md                # 销售分析模板
        ├── department_analysis.md           # 部门分析模板
        ├── region_analysis.md               # 区域分析模板
        ├── finance_analysis.md              # 财务分析模板
        └── qa_general.md                    # 问答通用模板
```

### 14.3 配置文件结构

```
backend-java/src/main/resources/
└── config/
    └── smartbi/
        ├── field_synonyms.json              # 字段同义词配置
        ├── metric_definitions.json          # 指标定义配置
        ├── chart_templates.json             # 图表模板配置
        ├── intent_patterns.json             # 意图模式配置
        └── alert_thresholds.json            # 预警阈值配置
```

---

## 十五、数据刷新与缓存策略

### 15.1 刷新频率分类

系统采用**实时优先策略**，非AI分析的图表数据全部实时获取，仅AI分析采用缓存：

| 数据类型 | 刷新策略 | 缓存策略 | 说明 |
|---------|---------|---------|------|
| **KPI卡片数据** | 实时 | 不缓存 | 每次打开/刷新重新查询 |
| **排行榜数据** | 实时 | 不缓存 | 每次打开/刷新重新查询 |
| **趋势图表数据** | 实时 | 不缓存 | 每次打开/切换条件重新查询 |
| **交叉分析图表** | 实时 | 不缓存 | 每次打开/下钻重新查询 |
| **AI分析报告** | 按需 | 2小时缓存 | 手动生成/定时生成，消耗AI配额 |
| **自然语言问答** | 按需 | 不缓存 | 每次提问，消耗AI配额 |

**设计原则**：
- **纯数据图表** = 实时查询，不消耗AI配额，不缓存
- **AI分析内容** = 按需生成，消耗AI配额，可缓存

### 15.2 图表数据刷新策略

#### 15.2.1 实时数据 vs AI分析

**实时数据（直接查询数据库，不消耗配额）**：
- KPI卡片（销售额、完成率、毛利率、应收余额）
- 部门排行榜、区域排行榜、销售员排行榜
- 产品销售占比饼图、销售趋势折线图
- 成本结构饼图、应收账龄分布
- 部门-区域热力图
- 所有下钻明细数据

**AI分析（调用LLM，消耗配额）**：
- AI智能洞察文字
- 经营日报/周报/月报
- 问题诊断与建议
- 自然语言问答回复
- 预测与趋势判断

#### 15.2.2 前端刷新机制

**实时数据刷新配置**：

| 数据类型 | 自动刷新 | 刷新间隔 | 缓存时间 |
|---------|---------|---------|---------|
| KPI卡片 | 是 | 30秒 | 不缓存 |
| 排行榜 | 是 | 1分钟 | 不缓存 |
| 趋势图 | 否（手动/切换条件） | - | 不缓存 |
| 交叉分析 | 否（手动/下钻） | - | 不缓存 |

**AI分析刷新配置**：

| 数据类型 | 自动刷新 | 缓存时间 | 配额消耗 |
|---------|---------|---------|---------|
| AI洞察 | 否 | 2小时 | 2次 |
| AI报告 | 否 | 24小时 | 5次 |
| 自然语言问答 | 否 | 不缓存 | 1次 |

#### 15.2.3 实时查询优化

为保证实时数据的查询性能，采用以下优化措施：

1. **数据库索引优化**：在订单表的工厂ID、日期、部门等字段上建立复合索引
2. **查询结果聚合**：在数据库层面完成聚合计算，避免返回大量明细数据
3. **预计算摘要表**：每日凌晨自动计算前一天的汇总数据，存入摘要表，加速查询

#### 15.2.4 刷新状态指示

前端需要展示数据新鲜度指示器：
- **实时数据**：显示绿色圆点 + "实时数据 · 刚刚更新" 或 "X分钟前"
- **AI分析**：显示黄色圆点 + "AI分析 · X小时前" + "刷新分析"按钮

#### 15.2.5 手动刷新按钮

- **实时数据区域**：提供刷新按钮，点击立即重新查询
- **AI分析区域**：提供"重新分析"按钮，点击消耗配额生成新分析

### 15.3 AI分析生成策略

#### 15.3.1 生成频率

| 分析类型 | 自动生成时间 | 手动生成 | 缓存有效期 |
|---------|-------------|---------|-----------|
| **经营日报** | 每日8:00 | 随时 | 当日有效 |
| **经营周报** | 每周一8:00 | 随时 | 本周有效 |
| **经营月报** | 每月1日8:00 | 随时 | 本月有效 |
| **实时问答** | - | 随时 | 不缓存 |
| **下钻分析** | - | 随时 | 30分钟 |

#### 15.3.2 定时任务说明

系统每日/每周/每月定时生成AI分析报告：
- **经营日报**：每日早上8:00自动生成，分析前一日数据
- **经营周报**：每周一早上8:00自动生成，分析上周数据
- **经营月报**：每月1日早上8:00自动生成，分析上月数据

生成的报告存入缓存表，用户打开看板时直接读取缓存，无需等待。

#### 15.3.3 AI配额管理

为避免AI调用成本失控，设置配额限制：

| 操作 | 单次消耗 | 每日限额/工厂 |
|------|---------|-------------|
| 综合分析报告 | 5次 | 20次 |
| 单维度分析 | 2次 | 50次 |
| 自然语言问答 | 1次 | 100次 |
| 下钻分析 | 1次 | 100次 |

#### 15.3.4 Pay-as-Analysis 按需付费模式

系统支持两种计费模式，工厂管理员可在设置中切换：

**模式一：配额制（默认）**
- 每日免费配额，用完即止
- 超出配额后禁止调用，次日重置
- 适合：预算固定、使用量可控的企业

**模式二：按需付费（Pay-as-Analysis）**
- 基础配额免费，超出部分按次计费
- 无硬性限制，按实际使用量结算
- 适合：分析需求波动大、愿意按需付费的企业

##### 计费模式配置

工厂SmartBI配置实体（FactorySmartBIConfig）包含以下字段：

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| factoryId | String | - | 工厂ID，主键 |
| billingMode | 枚举 | QUOTA | 计费模式：QUOTA（配额制）或 PAY_AS_ANALYSIS（按需付费） |
| pricePerAnalysis | 金额 | 0.10元 | 按需付费时的单次分析单价 |
| monthlySpendingLimit | 金额 | 0（无上限） | 月度消费上限，0表示不限制 |
| spendingAlertEnabled | 布尔 | true | 是否启用消费预警 |
| spendingAlertThreshold | 金额 | 100.00元 | 消费预警阈值 |
| autoScheduledAnalysis | 布尔 | true | 是否启用自动定时分析（日报/周报/月报） |

##### 按需付费价格表

| 操作类型 | 单价（元/次） | 说明 |
|---------|-------------|------|
| 综合分析报告 | ¥0.50 | 5次调用 × ¥0.10 |
| 单维度分析 | ¥0.20 | 2次调用 × ¥0.10 |
| 自然语言问答 | ¥0.10 | 1次调用 × ¥0.10 |
| 下钻分析 | ¥0.10 | 1次调用 × ¥0.10 |
| 定时日报生成 | ¥0.50 | 自动生成，可关闭 |

##### 消费控制机制

每次AI分析调用前，系统执行以下检查流程：

**1. 配额制模式检查**
- 获取当日配额使用状态
- 若配额已用尽，返回错误提示："今日AI分析配额已用完，明日重置或切换为按需付费模式"
- 用户可等待次日自动重置，或切换为按需付费模式继续使用

**2. 按需付费模式检查**
- 计算本次分析的预估费用
- 获取本月累计消费金额
- 若设置了月度消费上限，检查累计消费+预估费用是否超限
- 超限时返回错误提示："已达到本月消费上限，请调整上限或等待下月重置"
- 若累计消费达到预警阈值且预警已启用，发送消费预警通知

**3. 执行分析**
- 通过检查后，调用AI服务执行分析
- 分析完成后，记录本次消费到消费记录表

##### 消费记录表

**AI分析消费记录表（smart_bi_usage_records）**

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 自增主键 |
| factory_id | VARCHAR(50) | 工厂ID |
| user_id | BIGINT | 操作用户ID |
| analysis_type | VARCHAR(50) | 分析类型（dashboard/sales/finance/query/drilldown） |
| billing_mode | VARCHAR(20) | 计费模式（QUOTA/PAY_AS_ANALYSIS） |
| quota_consumed | INT | 消耗的配额次数，默认0 |
| amount_charged | DECIMAL(10,2) | 实际计费金额，默认0 |
| is_within_quota | BOOLEAN | 是否在免费配额内，默认true |
| created_at | DATETIME | 记录创建时间 |

索引：factory_id + created_at 联合索引，用于月度消费统计查询

**月度消费汇总视图（v_monthly_spending）**

该视图按工厂和月份汇总消费数据，包含：总请求次数、总配额使用量、总金额、实付金额（排除免费配额内的消费）

##### 前端开关UI

**计费模式设置组件（BillingSettings）**

该组件为工厂管理员提供AI分析计费的配置界面，包含以下功能区域：

**1. 计费模式切换**
- 单选按钮组，可选择"配额制"或"按需付费"模式
- 配额制：显示"每日免费配额，用完即止"说明
- 按需付费：显示"超出配额按次计费"说明

**2. 按需付费专属设置**（仅在选择按需付费模式时显示）
- 月度消费上限：金额输入框，带人民币符号前缀，0表示无上限
- 消费预警开关：带阈值金额输入框，开启后达到阈值时发送通知

**3. 自动定时分析开关**
- 开关控件，控制是否自动生成经营日报/周报/月报
- 提示文字说明按需付费模式下自动分析会产生费用

**4. 当前消费统计**
- 展示使用量统计组件（见下文）

##### 消费统计展示

**使用量统计组件（UsageStatistics）**

该组件展示工厂的AI分析使用情况，采用四列统计卡片布局：

| 指标 | 数据来源 | 显示格式 |
|------|---------|---------|
| 今日已用配额 | todayQuotaUsed / dailyQuotaLimit | 如"15 / 100" |
| 本月总调用 | monthlyRequests | 如"328次" |
| 本月消费 | monthlySpending | 如"¥32.80" |
| 节省金额 | savedAmount | 如"¥67.20"（绿色高亮） |

统计卡片下方展示消费趋势折线图，显示每日消费变化

##### API接口

**获取计费配置**
- 路径：GET /api/mobile/{factoryId}/smart-bi/billing/config
- 返回字段：billingMode（计费模式）、monthlySpendingLimit（月度上限）、spendingAlertEnabled（预警开关）、spendingAlertThreshold（预警阈值）、autoScheduledAnalysis（自动分析开关）

**更新计费配置**
- 路径：PUT /api/mobile/{factoryId}/smart-bi/billing/config
- 请求体：同上述返回字段，除billingMode外均为可选

**获取使用量统计**
- 路径：GET /api/mobile/{factoryId}/smart-bi/billing/usage
- 查询参数：period（today/this_week/this_month）
- 返回字段：quotaUsed、quotaLimit、totalRequests、totalSpending、savedAmount、dailyBreakdown（每日明细数组）

**获取消费明细**
- 路径：GET /api/mobile/{factoryId}/smart-bi/billing/records
- 查询参数：page、size、startDate、endDate
- 返回字段：分页消费记录列表，包含分析类型、计费模式、配额消耗、计费金额、创建时间

### 15.4 后端缓存实现

#### 15.4.1 缓存键设计

缓存键采用统一格式：smartbi:{工厂ID}:{分析类型}:{参数哈希}:{数据版本}

各组成部分说明：
- 工厂ID：如 F001，确保多租户数据隔离
- 分析类型：dashboard（驾驶舱）、sales（销售分析）、finance（财务分析）
- 参数哈希：根据时间范围、筛选条件等参数生成的哈希值，确保不同查询条件使用不同缓存
- 数据版本：如 v20260118，用于判断缓存是否需要失效

示例缓存键：
- smartbi:F001:dashboard:abc123:v20260118
- smartbi:F001:sales:def456:v20260118

#### 15.4.2 缓存失效策略

**主动失效**：当工厂数据发生更新时（如新订单、新销售记录），通过事件监听器自动清除该工厂的所有SmartBI缓存

**被动失效**：通过Redis TTL机制，缓存到期后自动失效。不同分析类型设置不同的TTL时长（参见15.3.1）

#### 15.4.3 缓存表结构

**AI分析缓存表（smart_bi_analysis_cache）**

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 自增主键 |
| factory_id | VARCHAR(50) | 工厂ID |
| cache_key | VARCHAR(255) | 完整缓存键 |
| analysis_type | VARCHAR(50) | 分析类型 |
| params_hash | VARCHAR(64) | 参数哈希值 |
| result_json | LONGTEXT | AI分析结果JSON |
| data_version | VARCHAR(20) | 数据版本号 |
| hit_count | INT | 缓存命中次数，默认0 |
| expires_at | DATETIME | 过期时间 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

索引：factory_id + cache_key 唯一索引，expires_at 索引（用于清理过期缓存）

### 15.5 用户体验优化

#### 15.5.1 加载状态展示

前端需要向用户展示当前数据的加载状态，包括以下几种情况：

| 状态 | 显示文案 | 触发条件 |
|------|---------|---------|
| FRESH | "数据已是最新" | 刚完成刷新或数据在有效期内 |
| STALE | "数据更新于 X 分钟前" | 数据仍可用但已非最新 |
| LOADING | "正在刷新..." | 正在从服务器获取最新数据 |
| ERROR | "刷新失败，点击重试" | 请求失败，允许用户手动重试 |

#### 15.5.2 后台预加载

当用户打开某个分析页面时，前端在后台静默预加载其他相关页面的数据：

**加载顺序**：
1. 首先加载当前页面的主要数据（如用户打开经营驾驶舱）
2. 延迟约2秒后，后台静默预加载销售分析和财务分析数据
3. 预加载不阻塞用户操作，不显示加载状态

**优势**：用户切换到其他分析页面时可立即展示数据，无需等待加载

#### 15.5.3 增量更新

对于大数据量的趋势图表，采用滑动窗口方式进行增量更新：

**更新机制**：
- 当有新数据点到达时，将其追加到数据数组末尾
- 同时移除数组最前端的旧数据点
- 保持图表显示的数据点数量恒定
- 避免全量刷新带来的性能开销和视觉跳动

---

## 十六、前端导航与权限设计

### 16.1 权限与入口对照表

| 角色 | 移动端导航器 | 移动端入口 | Web端入口 | 可用功能 |
|------|-------------|-----------|----------|---------|
| **factory_super_admin** | FactoryAdminNavigator | AI分析Tab | 数据分析菜单 | 全部功能 |
| **dispatcher** | DispatcherNavigator | 智能分析Tab（新增） | 数据分析菜单 | 全部功能 |
| **sales_manager** | MainNavigator | 销售分析Tab（新增） | 销售管理→智能分析 | 销售分析 |
| **finance_manager** | MainNavigator | 财务分析Tab（新增） | 财务管理→智能分析 | 财务分析 |

### 16.2 移动端导航结构

#### 16.2.1 工厂超管（FactoryAdminNavigator）

```
FactoryAdminNavigator
├── 首页Tab
├── AI分析Tab ← 扩展此Tab
│   ├── 成本分析（现有）
│   ├── 质检分析（现有）
│   ├── ─────────────
│   ├── 📊 经营驾驶舱 ← 新增
│   ├── 📈 销售分析 ← 新增
│   ├── 💰 财务分析 ← 新增
│   └── 📤 Excel上传 ← 新增
├── 报表Tab
├── 管理Tab
└── 我的Tab
```

#### 16.2.2 调度员（DispatcherNavigator）

```
DispatcherNavigator
├── 计划Tab
├── AI对话Tab
├── 📊 智能分析Tab ← 新增
│   ├── 经营驾驶舱
│   ├── 销售分析
│   ├── 财务分析
│   └── Excel上传
├── 人员Tab
└── 我的Tab
```

#### 16.2.3 销售经理/财务经理（MainNavigator）

```
MainNavigator
├── 首页Tab
├── 📈 销售分析Tab ← 条件显示（sales:read）
│   或
├── 💰 财务分析Tab ← 条件显示（finance:read）
├── 管理Tab（如有权限）
└── 我的Tab
```

### 16.3 移动端图表尺寸规范

移动端需要特别注意图表的尺寸适配，确保在不同屏幕上的显示效果。

#### 16.3.1 图表尺寸配置

将尺寸配置统一定义在 constants/chartSizes.ts 文件中，基于设备屏幕宽度动态计算：

| 布局类型 | 宽度计算 | 高度 | 适用场景 |
|---------|---------|------|---------|
| 全宽图表 | 屏幕宽度 - 32px | 220px | 趋势图、排行榜等需要完整展示的图表 |
| 半宽图表 | (屏幕宽度 - 48px) / 2 | 180px | 并排展示的两个图表 |
| KPI卡片 | (屏幕宽度 - 56px) / 2 | 100px | 2列布局的关键指标卡片 |
| 饼图 | 屏幕宽度 - 64px | 等于宽度 | 保持1:1正方形比例的饼图 |

#### 16.3.2 响应式断点

| 断点名称 | 屏幕宽度 | 代表设备 |
|---------|---------|---------|
| small | 320px | iPhone SE |
| medium | 375px | iPhone 12/13 |
| large | 414px | iPhone Plus/Max |
| tablet | 768px | iPad |

#### 16.3.3 图表组件列表

| 组件 | 用途 | 推荐高度 |
|------|------|---------|
| `MobileLineChart` | 趋势图 | 200-250 |
| `MobileBarChart` | 柱状图 | 220 |
| `MobilePieChart` | 饼图 | 屏幕宽度-64 |
| `MobileKPICard` | KPI卡片 | 100 |
| `MobileRankingList` | 排行榜 | FlatList滚动 |

### 16.4 Web端导航结构

#### 16.4.1 菜单配置扩展

**数据分析菜单**（analytics模块）

菜单路径：/analytics，图标：DataAnalysis

| 子菜单路径 | 标题 | 备注 |
|-----------|------|------|
| /analytics/overview | 分析概览 | 现有页面 |
| /analytics/trends | 趋势分析 | 现有页面 |
| /analytics/ai-report | AI分析报告 | 现有页面 |
| /analytics/smart-bi/dashboard | 经营驾驶舱 | SmartBI新增 |
| /analytics/smart-bi/sales | 智能销售分析 | SmartBI新增 |
| /analytics/smart-bi/finance | 智能财务分析 | SmartBI新增 |
| /analytics/smart-bi/upload | Excel上传 | SmartBI新增 |
| /analytics/smart-bi/query | AI问答 | SmartBI新增 |

**销售管理菜单**（sales_manager可见）

菜单路径：/sales

| 子菜单路径 | 标题 | 备注 |
|-----------|------|------|
| /sales/customers | 客户管理 | 现有页面 |
| /sales/smart-analysis | 智能销售分析 | SmartBI快捷入口 |

**财务管理菜单**（finance_manager可见）

菜单路径：/finance

| 子菜单路径 | 标题 | 备注 |
|-----------|------|------|
| /finance/cost-analysis | 成本分析 | 现有页面 |
| /finance/reports | 财务报表 | 现有页面 |
| /finance/smart-analysis | 智能财务分析 | SmartBI快捷入口 |

#### 16.4.2 权限矩阵更新

需要在 `web-admin/src/store/modules/permission.ts` 中确保以下配置：

| 角色 | analytics | sales | finance |
|------|-----------|-------|---------|
| factory_super_admin | rw | rw | rw |
| dispatcher | rw | r | r |
| sales_manager | r | rw | - |
| finance_manager | r | - | rw |

### 16.5 前端文件结构

#### 16.5.1 移动端新增文件

```
frontend/CretasFoodTrace/src/
├── components/smartbi/
│   ├── MobileLineChart.tsx
│   ├── MobileBarChart.tsx
│   ├── MobilePieChart.tsx
│   ├── MobileKPICard.tsx
│   ├── MobileRankingList.tsx
│   └── MobileHeatmap.tsx
├── screens/smartbi/
│   ├── ExecutiveDashboardScreen.tsx
│   ├── SalesAnalysisScreen.tsx
│   ├── FinanceAnalysisScreen.tsx
│   ├── ExcelUploadScreen.tsx
│   └── NLQueryScreen.tsx
├── services/api/
│   └── smartbi.ts
├── constants/
│   └── chartSizes.ts
└── types/
    └── smartbi.ts
```

#### 16.5.2 Web端新增文件

```
web-admin/src/
├── components/smartbi/
│   ├── TrendChart.vue
│   ├── RankingChart.vue
│   ├── PieChart.vue
│   ├── GaugeChart.vue
│   ├── HeatmapChart.vue
│   ├── ScatterChart.vue
│   ├── CombinedChart.vue
│   ├── MapChart.vue
│   └── KPICard.vue
├── views/analytics/smart-bi/
│   ├── Layout.vue
│   ├── Dashboard.vue
│   ├── SalesAnalysis.vue
│   ├── FinanceAnalysis.vue
│   ├── ExcelUpload.vue
│   └── AIQuery.vue
├── api/
│   └── smartbi.ts
└── types/
    └── smartbi.ts
```

---

## 十七、完整实施时间线

### 17.1 Phase 划分

| Phase | 内容 | 并行任务 | 预计周期 |
|-------|------|---------|---------|
| **Phase 1** | 后端基础设施层 | 3个 | Week 1-2 |
| **Phase 2** | 后端分析模块层 | 4个 | Week 3-4 |
| **Phase 3** | 后端AI智能层 | 3个 | Week 5-6 |
| **Phase 4** | 后端API展示层 | 3个 | Week 6-7 |
| **Phase 5** | 移动端导航与权限 | 2个 | Week 7-8 |
| **Phase 6** | 移动端图表与页面 | 3个 | Week 7-8 |
| **Phase 7** | Web端导航与权限 | 3个 | Week 8-9 |
| **Phase 8** | Web端图表与页面 | 3个 | Week 8-9 |
| **Phase 9** | 集成测试与优化 | - | Week 10 |

### 17.2 甘特图

```
Week 1-2:  [===== Phase 1: 后端基础设施 =====]
Week 3-4:  [===== Phase 2: 后端分析模块 =====]
Week 5-6:  [===== Phase 3: 后端AI层 =====]
Week 6-7:       [=== Phase 4: 后端API ===]
Week 7-8:            [=== Phase 5-6: 移动端 ===]
Week 8-9:                 [=== Phase 7-8: Web端 ===]
Week 10:                       [= 集成测试 =]
```

### 17.3 并行工作建议

#### 可并行的任务组

| 并行组 | 任务 | 说明 |
|--------|------|------|
| **A** | 1A + 1B + 1C | Phase 1 内部完全并行 |
| **B** | 2A + 2B + 2C + 2D | Phase 2 内部完全并行 |
| **C** | 3A + 3B + 3C | Phase 3 内部完全并行 |
| **D** | 移动端 + Web端 | Phase 5-6 与 Phase 7-8 可分Chat并行 |

#### 多Chat窗口并行建议

✅ **推荐分开的工作流**：
- Chat 1: 后端开发（Phase 1-4）
- Chat 2: 移动端开发（Phase 5-6）
- Chat 3: Web端开发（Phase 7-8）

⚠️ **需注意的冲突点**：
- 权限配置文件（permissionHelper.ts / permission.ts）
- API 类型定义应保持同步

---

## 附录A：术语表

| 术语 | 英文 | 说明 |
|-----|------|------|
| 动态BI | Dynamic BI | 不依赖固定数据源，支持用户自助上传数据的BI系统 |
| 字段映射 | Field Mapping | 将用户Excel的字段名映射到系统标准字段的过程 |
| 同义词表 | Synonym Dictionary | 预置的字段名同义词对照表 |
| 指标计算引擎 | Metric Calculator | 根据配置的公式计算各种业务指标的模块 |
| 图表推荐 | Chart Recommendation | 根据数据特征自动推荐合适图表类型的功能 |
| 意图识别 | Intent Recognition | 分析用户自然语言问题所属类型的过程 |
| 参数提取 | Parameter Extraction | 从用户问题中提取关键实体（人名、部门、时间等）的过程 |
| 预警分级 | Alert Classification | 根据指标值和阈值划分预警级别的机制 |
| 数据下钻 | Drill Down | 从汇总数据展开查看更细粒度数据的操作 |

---

## 附录B：修订历史

| 版本 | 日期 | 修订内容 | 作者 |
|-----|------|---------|------|
| v1.0 | 2026-01-18 | 初始版本 | AI分析团队 |
| v1.1 | 2026-01-18 | 新增第15章数据刷新与缓存策略、第16章前端导航设计、第17章实施时间线 | AI分析团队 |
| v1.2 | 2026-01-18 | 更新15章：非AI图表改为实时刷新；新增15.3.4 Pay-as-Analysis按需付费模式 | AI分析团队 |
| v1.3 | 2026-01-18 | 全文移除代码块，改为纯文字描述（表格、列表、文字说明） | AI分析团队 |

---

*文档结束*
