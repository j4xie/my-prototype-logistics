# AI成本分析功能 - 路由和按钮跳转验证清单

**日期**: 2025-10-06
**目的**: 验证所有AI相关的按钮点击和页面跳转都正确工作

---

## 📋 导航路径总览

```
主页
├─ 管理中心 (ManagementTab)
│  └─ AI分析设置 (AISettings) ← 新增
│     └─ [保存设置] → 保存成功提示
│
├─ 生产模块 (ProcessingTab)
│  ├─ 生产仪表板
│  │  └─ [成本分析] → CostAnalysisDashboard
│  │
│  └─ 批次列表
│     └─ 批次详情
│        └─ [成本分析] → CostAnalysisDashboard ← 核心页面
│           ├─ [获取AI优化建议] → AI分析结果
│           ├─ [快速提问] → AI追问结果
│           ├─ [输入自定义问题] → 自定义问题输入框
│           ├─ [重新分析] → 重新进行AI分析
│           └─ [导出报告] → 导出功能（待实现）
│
└─ 平台管理 (仅platform_admin)
   └─ AI配额管理 (AIQuotaManagement) ← 新增（需添加入口）
      └─ [编辑配额] → 编辑模式
         ├─ [保存] → 更新配额
         └─ [取消] → 取消编辑
```

---

## ✅ 验证清单 - 管理中心

### 1. 管理中心 → AI分析设置

#### 验证步骤：
1. [ ] 登录为`processing_admin`（factory_super_admin角色）
2. [ ] 点击底部Tab: "管理"
3. [ ] 应该看到"高级功能"分组
4. [ ] 点击"AI分析设置"（有NEW徽章，robot图标）
5. [ ] 应该跳转到AISettingsScreen

#### 预期界面内容：
- [ ] 顶部标题："AI分析设置"
- [ ] 右上角有保存图标
- [ ] 第1个卡片："📊 使用配额"（灰色锁图标，显示只读）
  - [ ] 显示："每周可用次数: X次"
  - [ ] 提示："配额由平台管理员统一管理..."
  - [ ] 显示本周使用情况和进度条
- [ ] 第2个卡片："🔧 基础设置"
  - [ ] "启用AI分析"开关
  - [ ] "语气风格"单选（专业/友好/简洁）
  - [ ] "分析目标"单选（成本优化/效率/利润）
  - [ ] "详细程度"单选（简略/标准/详细）
- [ ] 第3个卡片："📊 行业标准参数"
  - [ ] 人工成本占比标准（数字输入框 + %）
  - [ ] 设备利用率目标（数字输入框 + %）
  - [ ] 利润率目标（数字输入框 + %）
- [ ] 第4个卡片："✏️ 自定义提示词"
  - [ ] 多行文本输入框
- [ ] 第5个卡片："📈 本周使用统计"
  - [ ] 总调用/分析请求/追问次数
  - [ ] 按用户统计列表
- [ ] 底部"保存设置"大按钮

#### 功能验证：
- [ ] 修改语气为"友好" → 保存 → 提示"设置已保存"
- [ ] 返回 → 重新进入 → 语气应保持为"友好"
- [ ] 修改行业标准参数 → 保存 → 成功
- [ ] 关闭"启用AI分析"开关 → 保存 → 成功

---

## ✅ 验证清单 - 生产模块

### 2. 批次详情 → 成本分析

#### 导航路径A（从生产仪表板）：
1. [ ] 主页 → 生产模块Tab
2. [ ] 生产仪表板（ProcessingDashboard）
3. [ ] 点击"成本分析"按钮
4. [ ] 应该跳转到CostAnalysisDashboard

**注意**: 这个路径可能需要传递batchId参数，如果没有batchId可能会提示选择批次。

#### 导航路径B（从批次列表）：
1. [ ] 主页 → 生产模块Tab
2. [ ] 点击"批次列表"
3. [ ] 选择一个批次，进入BatchDetailScreen
4. [ ] 在批次详情页，找到"成本分析"按钮
5. [ ] 点击后应跳转到CostAnalysisDashboard（带batchId参数）

**预期**: 路径B是推荐路径，确保有batchId。

---

### 3. 成本分析Dashboard - 所有交互验证

#### 进入条件：
- [ ] 必须从批次详情进入（带batchId参数）
- [ ] 或者从导航参数传递batchId

#### 界面加载验证：
- [ ] 显示加载动画："加载成本数据中..."
- [ ] 加载完成后显示：
  - [ ] 批次信息卡片（批次号 + 状态chip）
  - [ ] 成本概览4格网格（4种颜色背景）
  - [ ] 人工详情卡片
  - [ ] 设备详情卡片
  - [ ] AI智能分析卡片（蓝色边框）

#### AI分析按钮交互：

##### 场景1: 首次进入（未使用AI）
- [ ] AI卡片显示："🤖 AI智能分析"
- [ ] **不显示**配额徽章（首次未调用）
- [ ] 显示描述文字
- [ ] 显示大按钮："获取AI优化建议"

##### 场景2: 点击"获取AI优化建议"
**步骤**:
1. [ ] 点击按钮
2. [ ] 按钮变为加载状态（转圈）
3. [ ] 显示："AI正在分析成本数据，请稍候..."
4. [ ] 等待3-8秒
5. [ ] 加载完成

**预期结果**:
- [ ] 右上角显示配额徽章："本周剩余: X/Y次"
- [ ] 配额徽章下方显示："X天后重置"
- [ ] 显示蓝色结果卡片："📋 分析结果"
- [ ] AI分析内容正确显示（中文，有结构）
- [ ] 显示两个按钮："重新分析" "导出报告"
- [ ] 显示"💬 快速提问:"标题
- [ ] 显示3个快速提问按钮
- [ ] 显示"输入自定义问题"按钮

##### 场景3: 点击快速提问（"如何降低人工成本？"）
**步骤**:
1. [ ] 点击快速提问按钮
2. [ ] 再次显示加载动画
3. [ ] AI返回结果

**预期结果**:
- [ ] AI回答针对人工成本优化
- [ ] 配额减少1次（如19/20 → 18/20）
- [ ] AI结果替换为新的回答
- [ ] 快速提问按钮仍可用

##### 场景4: 输入自定义问题
**步骤**:
1. [ ] 点击"输入自定义问题"
2. [ ] 显示文本输入框
3. [ ] 输入："如何提高利润率？"
4. [ ] 点击"发送"按钮

**预期结果**:
- [ ] AI分析自定义问题
- [ ] 配额再减1次
- [ ] 输入框关闭
- [ ] AI结果更新

##### 场景5: 重新分析
**步骤**:
1. [ ] 点击"重新分析"按钮

**预期结果**:
- [ ] 开始新的分析（不基于之前上下文）
- [ ] 配额减少
- [ ] AI结果更新

##### 场景6: 配额用尽
**前提**: 设置配额为1次，已使用1次

**预期结果**:
- [ ] 配额显示："本周剩余: 0/1次"
- [ ] 按钮文字变为："本周次数已用完"
- [ ] 按钮变灰（disabled状态）
- [ ] 快速提问按钮也disabled
- [ ] 自定义问题按钮也disabled
- [ ] 显示红色提示："下周一自动重置配额"

##### 场景7: 点击已禁用的按钮
**步骤**:
1. [ ] 配额为0时点击AI分析按钮

**预期结果**:
- [ ] 弹出Alert："本周AI分析次数已达上限（X次），请下周一再试"

---

## ✅ 验证清单 - 平台管理（待实现入口）

### 4. 平台管理 → AI配额管理

**⚠️ 注意**: 这个功能目前没有添加入口，需要补充平台管理员的导航

#### 临时测试方法：
可以先手动测试API端点（见前面的测试文档），UI界面已创建但需要：
1. 创建平台管理员导航
2. 添加AIQuotaManagement入口

---

## 🔍 详细交互验证表

### 成本分析Dashboard交互矩阵

| 序号 | 操作 | 前置条件 | 预期结果 | 配额变化 |
|------|------|---------|---------|---------|
| 1 | 进入页面 | 有batchId | 显示成本数据 | 不变 |
| 2 | 下拉刷新 | 任意 | 重新加载数据 | 不变 |
| 3 | 点击"获取AI优化建议" | 配额>0 | 显示AI结果 | -1 |
| 4 | 点击"如何降低人工成本？" | 配额>0 | 显示AI回答 | -1 |
| 5 | 点击"设备利用率如何优化？" | 配额>0 | 显示AI回答 | -1 |
| 6 | 点击"如何提高利润率？" | 配额>0 | 显示AI回答 | -1 |
| 7 | 输入自定义问题+发送 | 配额>0 | 显示AI回答 | -1 |
| 8 | 输入空问题+发送 | 任意 | Alert提示 | 不变 |
| 9 | 点击"重新分析" | 配额>0 | 新的AI分析 | -1 |
| 10 | 配额=0时点击AI按钮 | 配额=0 | Alert超限 | 不变 |
| 11 | AI禁用时点击 | enabled=false | Alert已禁用 | 不变 |

---

## 🧪 完整端到端测试流程

### 测试流程A: 工厂管理员配置AI → 员工使用

**步骤**:
1. [ ] 登录为`processing_admin`（factory_super_admin）
2. [ ] 进入管理中心
3. [ ] 点击"AI分析设置"
4. [ ] 修改语气为"友好"
5. [ ] 修改目标为"效率提升"
6. [ ] 修改人工成本标准为25%
7. [ ] 点击右上角保存图标
8. [ ] 看到"设置已保存"提示
9. [ ] 返回
10. [ ] 进入生产模块 → 批次列表 → 选择批次 → 成本分析
11. [ ] 点击"获取AI优化建议"
12. [ ] 验证AI回复：
    - [ ] 使用友好语气
    - [ ] 重点关注效率
    - [ ] 提到人工成本标准25%

---

### 测试流程B: 配额限制完整流程

**步骤**:
1. [ ] 数据库设置配额为3次：
   ```sql
   UPDATE factories SET ai_weekly_quota = 3 WHERE id = 'TEST_2024_001';
   ```
2. [ ] 登录React Native
3. [ ] 进入成本分析Dashboard
4. [ ] 第1次点击"获取AI优化建议"
   - [ ] 成功，显示"剩余2/3次"
5. [ ] 第2次点击"如何降低人工成本？"
   - [ ] 成功，显示"剩余1/3次"
6. [ ] 第3次输入自定义问题
   - [ ] 成功，显示"剩余0/3次"
7. [ ] 验证所有AI按钮变灰
8. [ ] 第4次尝试点击
   - [ ] 弹出Alert："本周次数已达上限"
   - [ ] 不发送请求
9. [ ] 检查数据库ai_usage_logs表
   - [ ] 应该只有3条记录
   - [ ] year和weekNumber正确
10. [ ] 恢复配额：
    ```sql
    UPDATE factories SET ai_weekly_quota = 20 WHERE id = 'TEST_2024_001';
    ```

---

## 🔄 返回按钮验证

### 成本分析Dashboard返回
- [ ] 点击左上角返回箭头
- [ ] 应返回到批次详情页

### AI设置页面返回
- [ ] 点击左上角返回箭头
- [ ] 应返回到管理中心主页

---

## 🎯 关键按钮清单

### CostAnalysisDashboard（7个可点击元素）
1. [ ] 返回按钮（Appbar左上角）
2. [ ] 刷新按钮（Appbar右上角）
3. [ ] "获取AI优化建议"按钮（大按钮，蓝色）
4. [ ] "重新分析"按钮（outlined）
5. [ ] "导出报告"按钮（outlined）
6. [ ] 3个快速提问按钮（text按钮）
7. [ ] "输入自定义问题"按钮（text按钮）
8. [ ] 自定义问题"发送"按钮（contained）
9. [ ] 自定义问题"取消"按钮（text）

### AISettingsScreen（6个可点击元素）
1. [ ] 返回按钮（Appbar左上角）
2. [ ] 保存按钮（Appbar右上角）
3. [ ] "启用AI分析"开关
4. [ ] 语气风格单选按钮组（3个）
5. [ ] 分析目标单选按钮组（3个）
6. [ ] 详细程度单选按钮组（3个）
7. [ ] 行业标准数字输入框（3个）
8. [ ] 自定义提示词文本框
9. [ ] "保存设置"大按钮（底部）

### ManagementScreen（AI相关1个）
1. [ ] "AI分析设置"列表项 → 跳转到AISettings

### AIQuotaManagementScreen（平台管理员）
1. [ ] 返回按钮
2. [ ] 刷新按钮
3. [ ] 每个工厂的"编辑"按钮
4. [ ] 编辑模式下的"保存"和"取消"按钮

---

## 🧩 路由参数验证

### CostAnalysisDashboard路由参数
```typescript
navigation.navigate('CostAnalysisDashboard', { 
  batchId: 'batch_123'  // ← 必需参数
})
```

**验证**:
- [ ] 有batchId参数时正常加载
- [ ] 无batchId参数时显示Alert并返回

---

## 📱 实际操作测试脚本

### 脚本1: 验证管理中心跳转
```
1. 启动React Native应用
2. 登录（processing_admin / 123456）
3. 点击底部Tab "管理"
4. 滚动到"高级功能"分组
5. 确认看到"AI分析设置"（robot图标 + NEW徽章）
6. 点击"AI分析设置"
7. ✅ 应进入AISettingsScreen
8. 验证所有卡片都显示
9. 点击左上角返回
10. ✅ 应回到ManagementScreen
```

### 脚本2: 验证成本分析+AI分析流程
```
1. 在主页点击"生产模块"Tab
2. 点击"批次列表"
3. 选择第一个批次
4. 在批次详情页，查找"成本分析"按钮或选项
   （如果没有，从ProcessingDashboard进入）
5. 点击进入成本分析
6. ✅ 验证成本数据显示正确
7. 点击"获取AI优化建议"
8. ✅ 等待加载（3-8秒）
9. ✅ 验证AI结果显示
10. ✅ 验证配额显示："本周剩余: X/20次"
11. 点击"如何降低人工成本？"
12. ✅ 验证AI回答
13. ✅ 验证配额减1
14. 点击"输入自定义问题"
15. 输入："如何优化？"
16. 点击"发送"
17. ✅ 验证AI回答
18. ✅ 验证配额再减1
```

### 脚本3: 验证AI设置修改生效
```
1. 进入管理中心 → AI分析设置
2. 修改语气为"友好"
3. 修改目标为"利润最大化"
4. 点击保存
5. 返回
6. 进入成本分析
7. 点击AI分析
8. ✅ 验证AI回复使用友好语气
9. ✅ 验证AI分析重点在利润优化
```

---

## ❌ 常见跳转问题排查

### 问题1: 点击按钮无反应
**排查**:
- [ ] 检查navigation.navigate调用是否正确
- [ ] 检查路由名称是否匹配（区分大小写）
- [ ] 查看RN DevTools console是否有错误
- [ ] 验证Stack.Screen是否已注册

### 问题2: 跳转后白屏/报错
**排查**:
- [ ] 检查组件import是否正确
- [ ] 检查是否有TypeScript错误
- [ ] 查看错误堆栈信息
- [ ] 验证组件export是否正确

### 问题3: 参数未传递
**排查**:
- [ ] 打印route.params验证
- [ ] 检查navigation.navigate第二个参数
- [ ] 验证类型定义是否正确

---

## ✅ 最终验证通过标准

### 必须全部通过的项（P0）
- [ ] 管理中心 → AI分析设置 → 跳转正确
- [ ] AI设置页面所有卡片正常显示
- [ ] AI设置保存功能正常
- [ ] 批次详情 → 成本分析 → 跳转正确
- [ ] 成本分析Dashboard正常显示成本数据
- [ ] "获取AI优化建议"按钮可点击
- [ ] AI分析结果正确显示
- [ ] 配额信息正确显示和更新
- [ ] 快速提问功能正常
- [ ] 自定义问题功能正常
- [ ] 配额用尽时按钮禁用

### 应该通过的项（P1）
- [ ] AI设置修改后分析风格变化
- [ ] 行业标准参数在分析中体现
- [ ] 使用统计正确显示
- [ ] 所有返回按钮正常工作
- [ ] 刷新功能正常

### 可选项（P2）
- [ ] 导出报告按钮（功能待实现）
- [ ] 平台配额管理界面（需添加入口）

---

## 📝 测试记录模板

```
测试人员: _________
测试日期: _________
环境: [ ] 开发环境 [ ] 测试环境

核心功能测试：
□ 成本分析Dashboard正常显示
□ AI分析按钮可点击且有响应
□ AI结果正确显示
□ 配额信息正确
□ 快速提问正常
□ 自定义问题正常

配额限流测试：
□ 配额计数正确
□ 超限提示正确
□ 按钮禁用正确

导航测试：
□ 管理中心 → AI设置 正常
□ 批次详情 → 成本分析 正常
□ 所有返回按钮正常

发现的问题：
1. _________________________
2. _________________________
3. _________________________

总体评价: [ ] 通过 [ ] 部分通过 [ ] 未通过
```

---

**按照这个清单逐项验证，确保所有按钮和跳转都正常工作！**
