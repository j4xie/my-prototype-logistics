---
description:
globs:
alwaysApply: false
---
# é£Ÿå“æº¯æºç³»ç»ŸAPIé›†æˆä»£ç†è§„åˆ™

## ä½¿ç”¨åœºæ™¯
- **APIå¯¹æ¥å¼€å‘æ—¶** - æ— è®ºæ˜¯Mock APIè¿˜æ˜¯çœŸå®åç«¯API
- **APIå®¢æˆ·ç«¯å°è£…æ—¶** - åˆ›å»ºç±»å‹å®‰å…¨çš„APIæœåŠ¡å±‚  
- **ç¯å¢ƒåˆ‡æ¢é…ç½®æ—¶** - Mockç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒçš„æ— ç¼åˆ‡æ¢
- **é”™è¯¯å¤„ç†ä¼˜åŒ–æ—¶** - ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

## ğŸ—ï¸ æ ¸å¿ƒåŸåˆ™

### ğŸ“‹ APIè®¾è®¡æ ‡å‡†
ä¸¥æ ¼éµå¾ªé£Ÿå“æº¯æºç³»ç»Ÿçš„APIè®¾è®¡è§„èŒƒï¼š

#### RESTfulæ¶æ„
- **èµ„æºå¯¼å‘**: URLä½¿ç”¨åè¯å¤æ•° (`/traces`, `/products`, `/users`)
- **HTTPè¯­ä¹‰**: GET(æŸ¥è¯¢)ã€POST(åˆ›å»º)ã€PUT(æ›´æ–°)ã€PATCH(éƒ¨åˆ†æ›´æ–°)ã€DELETE(åˆ é™¤)
- **æ ‡å‡†çŠ¶æ€ç **: 200/201/400/401/403/404/422/500
- **åˆ†é¡µæ”¯æŒ**: `?page=1&limit=20&sort=createdAt&order=desc`

#### å“åº”æ ¼å¼æ ‡å‡†
```typescript
// æˆåŠŸå“åº”
interface SuccessResponse<T> {
  success: true;
  data: T;
  meta?: PaginationMeta;
}

// é”™è¯¯å“åº”  
interface ErrorResponse {
  success: false;
  error: {
    code: string;
    message: string;
    details?: ValidationError[];
  };
}
```

### ğŸ”§ æŠ€æœ¯å®ç°è¦æ±‚

#### TypeScriptç±»å‹å®‰å…¨
```typescript
// å®šä¹‰å®Œæ•´çš„æ¥å£ç±»å‹
interface TraceResponse {
  id: string;
  batchCode: string;
  productName: string;
  status: 'ACTIVE' | 'COMPLETED' | 'CANCELLED';
  createdAt: string;
  updatedAt: string;
}

// APIå®¢æˆ·ç«¯ç±»å‹å®‰å…¨è°ƒç”¨
const trace = await apiClient.get<TraceResponse>(`/traces/${id}`);
```

#### ç¯å¢ƒæŠ½è±¡å±‚è®¾è®¡
```typescript
// ç¯å¢ƒé…ç½®æŠ½è±¡
interface ApiConfig {
  baseURL: string;
  timeout: number;
  useMockData: boolean;
  retryAttempts: number;
}

// è‡ªåŠ¨ç¯å¢ƒæ£€æµ‹
export const getApiConfig = (): ApiConfig => {
  const env = process.env.NEXT_PUBLIC_API_ENV || 'mock';
  
  const configs = {
    mock: {
      baseURL: '/api',
      timeout: 10000,
      useMockData: true,
      retryAttempts: 3
    },
    production: {
      baseURL: 'https://api.farm.com/v1',
      timeout: 20000,
      useMockData: false,
      retryAttempts: 5
    }
  };
  
  return configs[env] || configs.mock;
};
```

#### æœåŠ¡å±‚å°è£…æ¨¡å¼
```typescript
// åŸºç¡€APIæœåŠ¡ç±»
export abstract class BaseApiService {
  protected apiClient: ApiClient;
  
  constructor(apiClient: ApiClient) {
    this.apiClient = apiClient;
  }
  
  protected async handleRequest<T>(request: () => Promise<T>): Promise<T> {
    try {
      return await request();
    } catch (error) {
      if (error instanceof ApiError) {
        this.handleApiError(error);
      }
      throw error;
    }
  }
}

// å…·ä½“ä¸šåŠ¡æœåŠ¡å®ç°
export class TraceService extends BaseApiService {
  async getTrace(id: string): Promise<TraceResponse> {
    return this.handleRequest(() => 
      this.apiClient.get<TraceResponse>(`/traces/${id}`)
    );
  }
  
  async createTrace(data: TraceCreateRequest): Promise<TraceResponse> {
    return this.handleRequest(() =>
      this.apiClient.post<TraceResponse>('/traces', data)
    );
  }
}
```

### ğŸ”„ ç¯å¢ƒåˆ‡æ¢æœºåˆ¶

#### Mock APIæ”¯æŒ
```typescript
// æœåŠ¡å·¥å‚æ¨¡å¼
export class ApiServiceFactory {
  static createTraceService(): TraceService {
    const config = getApiConfig();
    const apiClient = new ApiClient(config);
    
    if (config.useMockData) {
      return new MockTraceService(apiClient);
    }
    
    return new TraceService(apiClient);
  }
}
```

## ğŸ¯ ä¸šåŠ¡åŸŸAPIå®ç°

### è®¤è¯æ¨¡å— (AuthService)
```typescript
export class AuthService extends BaseApiService {
  async login(credentials: LoginRequest): Promise<AuthResponse> {
    return this.handleRequest(() => 
      this.apiClient.post<AuthResponse>('/auth/login', credentials)
    );
  }
  
  async logout(): Promise<void> {
    return this.handleRequest(() => 
      this.apiClient.post<void>('/auth/logout')
    );
  }
}
```

### æº¯æºæ¨¡å— (TraceService)
```typescript
export class TraceService extends BaseApiService {
  async verifyTrace(id: string, code?: string): Promise<VerificationResponse> {
    return this.handleRequest(() =>
      this.apiClient.post<VerificationResponse>(`/traces/${id}/verify`, { code })
    );
  }
  
  async getTraceHistory(id: string): Promise<TraceHistory[]> {
    return this.handleRequest(() =>
      this.apiClient.get<TraceHistory[]>(`/traces/${id}/history`)
    );
  }
}
```

### ç”¨æˆ·æ¨¡å— (UserService)
```typescript
export class UserService extends BaseApiService {
  async getProfile(): Promise<UserProfile> {
    return this.handleRequest(() =>
      this.apiClient.get<UserProfile>('/users/profile')
    );
  }
  
  async updateProfile(data: ProfileUpdateRequest): Promise<UserProfile> {
    return this.handleRequest(() =>
      this.apiClient.put<UserProfile>('/users/profile', data)
    );
  }
}
```

## âš ï¸ é”™è¯¯å¤„ç†è§„èŒƒ

### æ ‡å‡†é”™è¯¯å¤„ç†
```typescript
// ç»Ÿä¸€é”™è¯¯å¤„ç†
const handleApiError = (error: ApiError): void => {
  switch (error.status) {
    case 401:
      // æœªè®¤è¯ï¼Œè·³è½¬ç™»å½•
      window.location.href = '/auth/login';
      break;
    case 403:
      showNotification('æƒé™ä¸è¶³ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'error');
      break;
    case 422:
      // éªŒè¯é”™è¯¯ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
      if (error.details) {
        showValidationErrors(error.details);
      }
      break;
    case 500:
      showNotification('æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
      break;
    default:
      showNotification(error.message, 'error');
  }
};
```

### è‡ªåŠ¨é‡è¯•æœºåˆ¶
```typescript
export const createRetryWrapper = <T extends any[], R>(
  fn: (...args: T) => Promise<R>,
  maxRetries: number = 3
) => {
  return async (...args: T): Promise<R> => {
    for (let attempt = 0; attempt <= maxRetries; attempt++) {
      try {
        return await fn(...args);
      } catch (error) {
        // ä¸é‡è¯•çš„é”™è¯¯ç±»å‹
        if (error instanceof ApiError && [400, 401, 403, 404, 422].includes(error.status)) {
          throw error;
        }
        
        if (attempt === maxRetries) {
          throw error;
        }
        
        // æŒ‡æ•°é€€é¿å»¶è¿Ÿ
        const delay = 1000 * Math.pow(2, attempt);
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  };
};
```

## ğŸ§ª æµ‹è¯•éªŒè¯æ ‡å‡†

### APIæµ‹è¯•ç”¨ä¾‹æ¨¡æ¿
```typescript
describe('TraceService', () => {
  let traceService: TraceService;
  
  beforeEach(() => {
    const apiClient = new ApiClient('/api');
    traceService = new TraceService(apiClient);
  });
  
  it('should return trace data for valid ID', async () => {
    const mockTrace: TraceResponse = { /* mock data */ };
    jest.spyOn(traceService['apiClient'], 'get').mockResolvedValue(mockTrace);
    
    const result = await traceService.getTrace('BATCH001');
    expect(result).toEqual(mockTrace);
  });
  
  it('should handle API errors correctly', async () => {
    const apiError = new ApiError(404, 'TRACE_NOT_FOUND', 'Trace not found');
    jest.spyOn(traceService['apiClient'], 'get').mockRejectedValue(apiError);
    
    await expect(traceService.getTrace('INVALID')).rejects.toThrow(ApiError);
  });
});
```

## ğŸ“ æ¥å£æ–‡æ¡£æ ‡å‡†

### æ–‡æ¡£æ¨¡æ¿æ ¼å¼
```markdown
#### POST /api/v1/traces - åˆ›å»ºæº¯æºæ‰¹æ¬¡

**è¯·æ±‚å‚æ•°**:
| å­—æ®µ | ç±»å‹ | å¿…éœ€ | æè¿° |
|------|------|------|------|
| batchCode | string | æ˜¯ | æ‰¹æ¬¡ç¼–ç  |
| productName | string | æ˜¯ | äº§å“åç§° |

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "id": "trace-456",
    "batchCode": "BATCH001"
  }
}
```

**é”™è¯¯ç **: 400, 401, 403, 422, 500
```

## å…³é”®è§„åˆ™
- ä¸¥æ ¼éµå¾ªRESTfulæ¶æ„å’Œç»Ÿä¸€å“åº”æ ¼å¼
- ä½¿ç”¨TypeScriptç¡®ä¿ç±»å‹å®‰å…¨
- å®ç°ç¯å¢ƒæŠ½è±¡å±‚æ”¯æŒMockå’Œç”Ÿäº§ç¯å¢ƒåˆ‡æ¢
- é‡‡ç”¨æœåŠ¡å±‚å°è£…æ¨¡å¼ç»„ç»‡ä¸šåŠ¡é€»è¾‘
- å»ºç«‹æ ‡å‡†åŒ–çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- ä¸ºæ‰€æœ‰APIæ“ä½œç¼–å†™å¯¹åº”çš„æµ‹è¯•ç”¨ä¾‹
- ä¿æŒæ¥å£æ–‡æ¡£çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§

## ç¤ºä¾‹

<example>
**æ­£ç¡®çš„APIé›†æˆå®ç°**ï¼š

```typescript
// 1. å®šä¹‰ç±»å‹å®‰å…¨çš„æ¥å£
interface TraceCreateRequest {
  batchCode: string;
  productName: string;
}

// 2. å®ç°æœåŠ¡å±‚
class TraceService extends BaseApiService {
  async createTrace(data: TraceCreateRequest): Promise<TraceResponse> {
    return this.handleRequest(() =>
      this.apiClient.post<TraceResponse>('/traces', data)
    );
  }
}

// 3. ä½¿ç”¨æœåŠ¡å·¥å‚
const traceService = ApiServiceFactory.createTraceService();
const result = await traceService.createTrace({
  batchCode: "BATCH001",
  productName: "æœ‰æœºè¥¿çº¢æŸ¿"
});
```
</example>

<example type="invalid">
**é”™è¯¯çš„APIé›†æˆæ–¹å¼**ï¼š

```typescript
// 1. ç¼ºå°‘ç±»å‹å®šä¹‰
const createTrace = async (data: any) => {
  const response = await fetch('/api/traces', {
    method: 'POST',
    body: JSON.stringify(data)
  });
  return response.json(); // æ²¡æœ‰ç±»å‹å®‰å…¨
};

// 2. ç›´æ¥ä½¿ç”¨fetchï¼Œæ²¡æœ‰é”™è¯¯å¤„ç†
// 3. æ²¡æœ‰ç¯å¢ƒæŠ½è±¡

