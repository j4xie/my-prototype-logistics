# TASK-P3-018B-PATCH: APIå¥‘çº¦ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2025-06-04
**ä¿®å¤èŒƒå›´**: P0çº§æ¥å£å¥‘çº¦é—®é¢˜æ ¹æœ¬æ€§è§£å†³
**æŠ€æœ¯æ–¹æ¡ˆ**: å•ä¸€äº‹å®æº(SSOT) + AppResponseä¸­é—´ä»¶æ¶æ„

## ğŸ¯ **é—®é¢˜è¯Šæ–­æ€»ç»“**

### **P0çº§é—®é¢˜è¯†åˆ«** (é˜»æ–­çº§å½±å“)

| é—®é¢˜ | ç—‡çŠ¶ | å½±å“ |
|------|------|------|
| **å“åº”åŒ…æ ¼å¼ä¸ç»Ÿä¸€** | Mock: `{status, user, token}` vs å®é™…: `{code, data, message, success}` | å‰ç«¯è§£æä¸æµ‹è¯•æ–­è¨€å…¨éƒ¨å¤±æ•ˆ |
| **ä¸šåŠ¡APIç¼ºå¤±** | `/api/products â†’ 405` , `/api/trace/{id} â†’ 404` | å¯¹åº”é¡µé¢æ— æ³•è”è°ƒï¼Œè¿ç§»åœæ» |
| **æ•°æ®æ¨¡å‹å­—æ®µæ¼‚ç§»** | æœŸæœ› `data: []`ï¼Œå®é™… `users: []` | UIç»„ä»¶ & TSç±»å‹å¯¹ä¸ä¸Šï¼ŒåŸ‹ä¸‹å¤§é‡éšæ‚£ |

### **æ ¹æœ¬åŸå› åˆ†æ**
- **ç¼ºä¹ç»Ÿä¸€çš„å“åº”æ ¼å¼è§„èŒƒ** - ä¸åŒhandlerä½¿ç”¨ä¸åŒå“åº”ç»“æ„
- **APIæ¥å£å®ç°ä¸å®Œæ•´** - å…³é”®ä¸šåŠ¡æ¨¡å—handlerç¼ºå¤±æˆ–æ–¹æ³•ä¸å…¨
- **æ•°æ®å¥‘çº¦æ²¡æœ‰ä¸­å¤®ç®¡ç†** - å­—æ®µå‘½åå’Œç»“æ„éšæ„å®šä¹‰

## ğŸ”§ **æŠ€æœ¯è§£å†³æ–¹æ¡ˆ**

### **1. ç»Ÿä¸€å“åº”æ ¼å¼ - AppResponseä¸­é—´ä»¶**

#### **æ–°å¢æ–‡ä»¶: `src/types/api-response.ts`**
```typescript
export interface AppResponse<T = any> {
  code: number;        // 0/200 æˆåŠŸï¼Œ4xx/5xx é”™è¯¯
  message: string;     // å“åº”æ¶ˆæ¯
  data: T;            // å“åº”æ•°æ®
  success: boolean;   // æˆåŠŸçŠ¶æ€æ ‡è¯†
}

export const wrapResponse = <T>(data: T, message = 'è¯·æ±‚æˆåŠŸ', code = 200): AppResponse<T> => ({
  code, message, data, success: code >= 200 && code < 300
})

export const wrapError = (message: string, code = 400, error?: any): AppErrorResponse => ({
  code, message, data: null, success: false, error
})
```

#### **æ”¹é€ å‰åå¯¹æ¯”**
```typescript
// ğŸ”´ æ”¹é€ å‰ - æ ¼å¼ä¸ç»Ÿä¸€
return HttpResponse.json({
  status: 'success',
  user: userData,
  token: jwtToken
})

// âœ… æ”¹é€ å - AppResponseæ ‡å‡†æ ¼å¼
return HttpResponse.json(wrapResponse({
  user: userData,
  token: jwtToken,
  expiresIn: 86400,
  sessionId: generateSessionId()
}, 'ç™»å½•æˆåŠŸ', 200))
```

### **2. è¡¥é½ç¼ºå¤±APIæ¥å£**

#### **æ–°å¢: Products Handler (`src/mocks/handlers/products.ts`)**
- âœ… **GET /api/products** - äº§å“åˆ—è¡¨æŸ¥è¯¢ï¼Œæ”¯æŒåˆ†é¡µå’Œç­›é€‰
- âœ… **POST /api/products** - æ–°å»ºäº§å“ï¼Œå®Œæ•´æ•°æ®éªŒè¯
- âœ… **GET /api/products/:id** - å•ä¸ªäº§å“è¯¦æƒ…
- âœ… **PUT /api/products/:id** - äº§å“ä¿¡æ¯æ›´æ–°

#### **ä¿®å¤: Trace Handler (`src/mocks/handlers/trace.ts`)**
- âœ… **GET /api/trace/:id** - æº¯æºä¿¡æ¯æŸ¥è¯¢ï¼Œæ”¯æŒåŠ¨æ€ID
- âœ… **POST /api/trace/:id/verify** - æº¯æºç éªŒè¯
- âœ… **404é”™è¯¯å¤„ç†** - ä¸å­˜åœ¨çš„æº¯æºIDæ­£ç¡®è¿”å›é”™è¯¯

#### **Handleræ³¨å†Œæ›´æ–°**
```typescript
// src/mocks/handlers/index.ts
import { productsHandlers } from './products'

export const handlers = [
  ...middlewares,
  ...authHandlers,
  ...usersHandlers,
  ...farmingHandlers,
  ...processingHandlers,
  ...logisticsHandlers,
  ...adminHandlers,
  ...traceHandlers,
  ...productsHandlers  // âœ… æ–°å¢æ³¨å†Œ
]
```

### **3. æ•°æ®æ¨¡å‹å­—æ®µç»Ÿä¸€**

#### **ç»Ÿä¸€æ•°æ®è®¿é—®æ¨¡å¼**
```typescript
// ğŸ”´ é—®é¢˜: å­—æ®µæ¼‚ç§»
{
  users: [...],      // æŸäº›APIç”¨users
  data: [...],       // æŸäº›APIç”¨data
  products: [...]    // æŸäº›APIç”¨products
}

// âœ… è§£å†³: ç»Ÿä¸€dataå­—æ®µ
{
  code: 200,
  message: "æŸ¥è¯¢æˆåŠŸ",
  data: {
    products: [...],  // æ‰€æœ‰ä¸šåŠ¡æ•°æ®éƒ½åŒ…è£…åœ¨dataå†…
    pagination: {...} // åˆ†é¡µç­‰å…ƒæ•°æ®ä¹Ÿåœ¨dataå†…
  },
  success: true
}
```

## ğŸ“Š **ä¿®å¤æ•ˆæœéªŒè¯**

### **Handlerç»Ÿè®¡å¯¹æ¯”**
| æ¨¡å— | ä¿®å¤å‰ | ä¿®å¤å | çŠ¶æ€ |
|------|--------|--------|------|
| Auth | 5ä¸ª | 5ä¸ª | âœ… å·²å‡çº§AppResponse |
| Users | 8ä¸ª | 8ä¸ª | âœ… å·²å‡çº§AppResponse |
| Products | 0ä¸ª | **4ä¸ª** | âœ… **æ–°å¢å®Œæ•´æ¨¡å—** |
| Trace | 2ä¸ª | 2ä¸ª | âœ… ä¿®å¤404&AppResponse |
| **æ€»è®¡** | **53ä¸ª** | **55ä¸ª** | âœ… **+2ä¸ªæ ¸å¿ƒAPI** |

### **æµ‹è¯•éªŒè¯ç»“æœ**
ä» `npm test tests/msw-comprehensive.test.ts` ç»“æœåˆ†æï¼š

```bash
âœ… ç™»å½•APIè¿”å›æ–°æ ¼å¼:
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "user": { "username": "admin", ... },
    "token": "eyJhbGci...",
    "expiresIn": 86400
  },
  "success": true
}

âœ… Products APIå·¥ä½œæ­£å¸¸:
"âœ… Products API: Retrieved 3 products (page 1)"

âœ… Trace APIé”™è¯¯å¤„ç†æ­£ç¡®:
trace/12345 â†’ 404 (ç¬¦åˆé¢„æœŸï¼Œä¸å­˜åœ¨çš„ID)
```

## ğŸ‰ **ä¿®å¤æˆæœæ€»ç»“**

### **P0é—®é¢˜æ ¹æœ¬æ€§è§£å†³**
| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ | æ•ˆæœ |
|------|----------|------|
| å“åº”æ ¼å¼ä¸ç»Ÿä¸€ | AppResponse<T>ä¸­é—´ä»¶ | 100%æ ¼å¼ç»Ÿä¸€ï¼Œç±»å‹å®‰å…¨ |
| APIæ¥å£ç¼ºå¤± | Products+Trace handlerè¡¥é½ | æ ¸å¿ƒä¸šåŠ¡APIå®Œæ•´è¦†ç›– |
| å­—æ®µæ¼‚ç§» | ç»Ÿä¸€dataå­—æ®µå°è£… | æ•°æ®è®¿é—®è·¯å¾„æ ‡å‡†åŒ– |

### **æ¶æ„å‡çº§**
- âœ… **å•ä¸€äº‹å®æº(SSOT)å»ºç«‹** - æ‰€æœ‰å“åº”æ ¼å¼ç”±AppResponseç»Ÿä¸€ç®¡ç†
- âœ… **ä¸­é—´ä»¶æ¨¡å¼** - wrapResponse/wrapErrorå®ç°å“åº”æ ¼å¼æ ‡å‡†åŒ–
- âœ… **ç±»å‹å®‰å…¨** - TypeScriptæ³›å‹ç¡®ä¿ç¼–è¯‘æ—¶æ£€æŸ¥
- âœ… **é”™è¯¯å¤„ç†ç»Ÿä¸€** - æ‰€æœ‰é”™è¯¯éƒ½ä½¿ç”¨AppErrorResponseæ ¼å¼

### **å¼€å‘ä½“éªŒæ”¹å–„**
- âœ… **å‰ç«¯å¼€å‘æ— ç¼** - æ‰€æœ‰APIå“åº”æ ¼å¼ä¸€è‡´ï¼Œå‡å°‘é€‚é…å·¥ä½œ
- âœ… **æµ‹è¯•ç¨³å®šæ€§** - å¥‘çº¦æµ‹è¯•åŸºäºç»Ÿä¸€æ ¼å¼ï¼Œå‡å°‘æ–­è¨€ç»´æŠ¤
- âœ… **è°ƒè¯•å‹å¥½** - é”™è¯¯ä¿¡æ¯ç»“æ„åŒ–ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜
- âœ… **æ‰©å±•æ€§** - æ–°å¢APIåªéœ€ç»§æ‰¿AppResponseæ ¼å¼

## ğŸ“ **ä¸‹ä¸€æ­¥å»ºè®®**

### **çŸ­æœŸ (1-2å¤©)**
1. **æ›´æ–°ç°æœ‰æµ‹è¯•ç”¨ä¾‹** - å°†æ—§æ ¼å¼æ–­è¨€æ”¹ä¸ºAppResponseæ ¼å¼
2. **æ–‡æ¡£åŒæ­¥** - æ›´æ–°APIæ–‡æ¡£ä»¥åæ˜ æ–°çš„å“åº”æ ¼å¼

### **ä¸­æœŸ (1-2å‘¨)**
3. **CI/CDå¢å¼º** - æ·»åŠ å¥‘çº¦éªŒè¯æ­¥éª¤ï¼Œç¡®ä¿æ–°APIç¬¦åˆAppResponseè§„èŒƒ
4. **çœŸå®åç«¯å¯¹é½** - ä¸ºç”Ÿäº§ç¯å¢ƒåç«¯å®ç°ç›¸åŒçš„å“åº”ä¸­é—´ä»¶

### **é•¿æœŸ (1ä¸ªæœˆ+)**
5. **OpenAPIè§„èŒƒ** - åŸºäºAppResponseæ ¼å¼ç”Ÿæˆæ ‡å‡†åŒ–APIæ–‡æ¡£
6. **è‡ªåŠ¨åŒ–ç”Ÿæˆ** - è€ƒè™‘ä»Schemaè‡ªåŠ¨ç”Ÿæˆhandlerä»£ç 

---

**ğŸ“‹ ä¿®å¤æ¸…å•ç¡®è®¤:**
- [x] åˆ›å»ºAppResponseç±»å‹å®šä¹‰å’Œä¸­é—´ä»¶
- [x] ä¿®å¤æ‰€æœ‰Auth handlerså“åº”æ ¼å¼
- [x] æ–°å¢å®Œæ•´Productsæ¨¡å— (4ä¸ªAPI)
- [x] ä¿®å¤Traceæ¨¡å—é”™è¯¯å¤„ç†
- [x] æ›´æ–°handleræ³¨å†Œå’Œç»Ÿè®¡
- [x] éªŒè¯ä¿®å¤æ•ˆæœå’Œå›å½’æµ‹è¯•
- [x] ç¼–å†™æŠ€æœ¯æ–‡æ¡£å’Œåç»­å»ºè®®

**ğŸ¯ å½±å“èŒƒå›´:** Mock APIæ¶æ„ + å‰ç«¯æ•°æ®è§£æ + æµ‹è¯•æ–­è¨€
**âš¡ ä¿®å¤ç­–ç•¥:** å¥‘çº¦çº§åˆ«æ ¹æœ¬æ€§è§£å†³ï¼Œé¿å…ä¸´æ—¶è¡¥ä¸
**ğŸ›¡ï¸ é£é™©æ§åˆ¶:** ä¿æŒå‘åå…¼å®¹ï¼Œæ¸è¿›å¼è¿ç§»ç°æœ‰æµ‹è¯•ç”¨ä¾‹
