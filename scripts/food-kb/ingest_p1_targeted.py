#!/usr/bin/env python3
"""
P1 靶向文档入库 — 修复 8 个弱分类品类 (MRR < 0.9)

Target weak categories:
  1. beverage (MRR=0.75) — 啤酒发酵工艺
  2. beverage (MRR=0.75) — 碳酸饮料灌装
  3. catering (MRR=0.75) — 学校食堂
  4. catering (MRR=0.75) — 餐饮应急处置
  5. edible_oil (MRR=0.83) — 食用油精炼
  6. bakery (MRR=0.85) — 烘焙微生物控制
  7. grain (MRR=0.87) — 粮食熏蒸
  8. contact_material (MRR=0.875) — 食品接触材料迁移测试

Usage:
  python ingest_p1_targeted.py --server http://47.100.235.168:8083
  python ingest_p1_targeted.py --server http://47.100.235.168:8083 --dry-run
  python ingest_p1_targeted.py --server http://47.100.235.168:8083 --verify-only
"""

import argparse
import json
import logging
import sys

import httpx

logging.basicConfig(level=logging.INFO, format="%(asctime)s [%(levelname)s] %(message)s")
logger = logging.getLogger("ingest_p1")

P1_DOCUMENTS = [
    # ===== Document 1: 啤酒发酵工艺参数与质量控制 (beverage, MRR=0.75) =====
    {
        "title": "啤酒发酵工艺参数与质量控制规范(GB 4927-2008)",
        "content": (
            "啤酒发酵是麦芽汁糖分在酵母作用下转化为酒精和CO₂的生化过程，是决定啤酒风味、口感和质量的核心工艺环节。"
            "GB 4927-2008《啤酒》规定了啤酒产品分类、原料要求和质量指标，是中国啤酒生产的基础性国家标准。\n\n"

            "一、发酵类型与温度控制：\n\n"
            "1. 上面发酵(Ale/艾尔啤酒)：\n"
            "   - 发酵温度：18-22°C(最适18-20°C)\n"
            "   - 酵母种类：Saccharomyces cerevisiae(酿酒酵母)\n"
            "   - 发酵位置：酵母在发酵后期浮至液面，形成泡盖\n"
            "   - 主发酵时间：5-7天\n"
            "   - 典型产品：IPA、世涛(Stout)、小麦啤酒\n"
            "   - 风味特点：果香、酯香浓郁，发酵速度快\n\n"

            "2. 下面发酵(Lager/拉格啤酒)：\n"
            "   - 发酵温度：8-14°C(最适10-12°C)\n"
            "   - 酵母种类：Saccharomyces pastorianus(巴氏酵母)\n"
            "   - 发酵位置：酵母在发酵后期沉降至底部\n"
            "   - 主发酵时间：7-10天\n"
            "   - 后发酵/贮酒时间：14-21天(0-4°C低温贮存)\n"
            "   - 典型产品：皮尔森、慕尼黑啤酒、中国主流工业啤酒\n"
            "   - 风味特点：口感清爽、麦香突出、酯香较低\n\n"

            "二、麦芽汁(Wort)规格要求：\n"
            "   - 原麦汁浓度：表示为柏拉图度(°P)，是发酵前麦芽汁可溶性固形物浓度\n"
            "   - 淡啤酒：原麦汁浓度7-9°P，酒精度2.5-3.5%vol\n"
            "   - 普通啤酒：原麦汁浓度10-12°P，酒精度3.5-4.5%vol\n"
            "   - 浓色/烈性啤酒：原麦汁浓度≥14°P，酒精度≥5.0%vol\n"
            "   - 无醇啤酒：酒精度≤0.5%vol，原麦汁浓度≥3.0°P(GB 4927-2008)\n"
            "   - pH值：麦芽汁pH应控制在5.2-5.5，过高影响酶活性和发酵\n"
            "   - 溶解氧：充氧8-12 mg/L(ppm)，满足酵母细胞膜合成需要\n\n"

            "三、发酵阶段与关键控制点：\n\n"
            "1. 酵母接种期(0-12h)：\n"
            "   - 接种量：15-20×10⁶ cells/mL(拉格)，10-15×10⁶ cells/mL(艾尔)\n"
            "   - 充氧：麦芽汁充氧至8-12 ppm，为酵母繁殖提供氧气\n"
            "   - 降温：麦芽汁冷却至发酵温度(拉格10-12°C，艾尔18-20°C)\n\n"

            "2. 主发酵期(1-7天)：\n"
            "   - 酵母繁殖：细胞数增加3-4倍\n"
            "   - 糖分消耗：可发酵糖(葡萄糖、果糖、麦芽糖、麦芽三糖)逐渐降低\n"
            "   - 酒精生成：酒精度逐渐上升至目标浓度\n"
            "   - CO₂释放：发酵罐需配备压力控制阀，防止爆罐\n"
            "   - 温度波动：±1°C(需自动温控系统)\n"
            "   - 双乙酰峰(Diacetyl Peak)：第3-4天达到峰值(0.3-0.6 ppm)，需后续降解\n\n"

            "3. 后发酵/贮酒期(Lagering，主要针对拉格啤酒)：\n"
            "   - 温度：0-4°C\n"
            "   - 时间：14-21天(传统拉格可达6周)\n"
            "   - 双乙酰降解：从0.3-0.6 ppm降至<0.1 ppm(成品标准)\n"
            "   - 酵母沉降：酵母细胞自溶，释放氨基酸改善风味\n"
            "   - CO₂饱和：自然碳酸化至2.4-2.6 volumes(拉格)，2.0-2.3 volumes(艾尔)\n"
            "   - 澄清：蛋白质-多酚复合物沉降，改善啤酒透明度\n\n"

            "四、发酵终点判定标准：\n"
            "   - 表观发酵度(ADF)：75-85%(原麦汁糖分被酵母消耗的比例)\n"
            "   - 残糖：1.5-3.0°P(未发酵的糊精和不可发酵糖)\n"
            "   - 双乙酰：<0.1 ppm(奶油味阈值0.15 ppm)\n"
            "   - pH值：4.2-4.6\n"
            "   - 酒精度：达到设计目标值(±0.2%vol)\n"
            "   - CO₂含量：拉格2.4-2.6 volumes，艾尔2.0-2.3 volumes\n\n"

            "五、质量控制指标(GB 4927-2008)：\n"
            "1. 感官指标：\n"
            "   - 色泽：淡黄色至深棕色(与啤酒类型对应)\n"
            "   - 泡沫：洁白细腻，持久性≥3分钟(优级品)\n"
            "   - 口感：酒体协调、杀口力适中、无异味\n\n"
            "2. 理化指标：\n"
            "   - 原麦汁浓度偏差：≤±0.3°P\n"
            "   - 酒精度：标注值±0.5%vol\n"
            "   - 双乙酰：<0.1 mg/L(优级品)\n"
            "   - 总酸：1.2-2.5 mL/10mL(以0.1mol/L NaOH滴定)\n"
            "   - 色度：4-40 EBC(欧洲啤酒色度单位)\n\n"

            "3. 微生物指标：\n"
            "   - 菌落总数：≤50 CFU/mL\n"
            "   - 大肠菌群：<3 MPN/100mL\n"
            "   - 致病菌：不得检出(沙门氏菌、志贺氏菌)\n\n"

            "六、常见发酵缺陷与控制：\n"
            "   - 双乙酰过高：延长贮酒时间，提高贮酒温度至4-6°C加速降解\n"
            "   - 硫化氢(H₂S)异味：提高发酵温度，促进硫化物挥发\n"
            "   - 高级醇过高：降低发酵温度，减少酵母应激\n"
            "   - 发酵停滞：检查酵母活力，补充营养盐(锌、镁)\n"
            "   - 染菌风险：严格清洗消毒(CIP/COP)，控制充氧环节无菌操作\n\n"

            "七、自动化监控技术：\n"
            "   - 在线密度计：实时监测麦芽汁比重，推算发酵进度\n"
            "   - 温度探头：多点温度监控，PLC自动调控冷却夹套\n"
            "   - 压力传感器：监控CO₂释放速率，防止压力过高\n"
            "   - 在线pH计/溶氧仪：监测发酵环境参数\n"
            "   - 快速双乙酰检测仪：GC或比色法快速测定\n\n"

            "法规依据：GB 4927-2008《啤酒》，GB 2758-2012《食品安全国家标准 发酵酒及其配制酒》。"
        ),
        "category": "process",
        "source": "GB 4927-2008/啤酒发酵",
        "version": "2024",
        "metadata": {
            "standard_no": "GB 4927-2008",
            "related_standards": "GB 2758-2012",
            "target_query": "啤酒发酵工艺参数与质量控制",
            "food_type": "beverage",
            "priority": "P1"
        }
    },

    # ===== Document 2: 碳酸饮料灌装线卫生管理与微生物控制 (beverage, MRR=0.75) =====
    {
        "title": "碳酸饮料灌装线卫生管理与微生物控制规范(GB 7101-2022)",
        "content": (
            "碳酸饮料(Carbonated Soft Drinks, CSD)是指在一定条件下充入CO₂气体的饮料制品，"
            "pH值通常<4.0，具有杀口感和爽快口感。GB 7101-2022《食品安全国家标准 饮料》于2022年12月30日实施，"
            "对碳酸饮料的生产卫生、微生物控制和灌装工艺提出了明确要求。\n\n"

            "一、灌装工艺类型与适用场景：\n\n"
            "1. 无菌冷灌装(Aseptic Cold Fill)：\n"
            "   - 工艺流程：产品瞬时灭菌(UHT 121-137°C/2-4秒) → 快速冷却至常温(20-25°C) → 无菌环境灌装\n"
            "   - 包装容器：PET瓶(可使用轻量化非结晶PET)\n"
            "   - 灌装温度：20-25°C\n"
            "   - 优势：保留风味和维生素、节能环保、轻量化包装\n"
            "   - 适用产品：含维生素C/果汁的碳酸饮料、功能饮料\n"
            "   - 无菌环境要求：ISO 5级洁净环境，空气过滤至0.3μm，紫外线+过氧化氢消毒\n\n"

            "2. 热灌装(Hot Fill)：\n"
            "   - 工艺流程：产品加热至85-95°C → 高温灌装 → 封盖 → 倒瓶杀菌(85°C/15-30秒) → 冷却\n"
            "   - 包装容器：耐热PET瓶(需结晶化处理)或玻璃瓶\n"
            "   - 灌装温度：85-92°C\n"
            "   - 优势：设备简单、成本低、无需无菌环境\n"
            "   - 劣势：能耗高、维生素损失、瓶子重量大(耐热PET瓶壁厚)\n"
            "   - 适用产品：茶饮料、果汁饮料(部分碳酸饮料不适用，CO₂会因温度升高而损失)\n\n"

            "3. 等压灌装(Isobaric/Counter-Pressure Filling，碳酸饮料主流工艺)：\n"
            "   - 原理：灌装前先向瓶内充入CO₂至与储液罐相同压力(3-4 bar)，"
            "然后开启液阀灌装，利用压差控制灌装速度，防止CO₂逸出和起泡\n"
            "   - 灌装温度：4-8°C(低温可提高CO₂溶解度)\n"
            "   - 灌装压力：3.0-4.5 bar(取决于CO₂含量目标)\n"
            "   - 灌装精度：±2 mL(高速灌装线每小时36000-72000瓶)\n"
            "   - CO₂损失：<5%(设计良好的灌装阀)\n"
            "   - 适用产品：可乐、雪碧、芬达等高碳酸饮料\n\n"

            "二、CO₂饱和度控制与测定：\n"
            "   - CO₂体积比(Volumes of CO₂)：表示1体积液体中溶解的CO₂气体体积(20°C, 1 atm标准)\n"
            "   - 可乐类：3.7-4.0 volumes(高碳酸)\n"
            "   - 柠檬汽水/雪碧：3.5-3.8 volumes\n"
            "   - 苏打水：3.0-3.5 volumes\n"
            "   - 低碳酸饮料：2.0-2.5 volumes\n"
            "   - 溶解度影响因素：温度(↑温度→↓溶解度)，压力(↑压力→↑溶解度)\n"
            "   - 测定方法：CO₂压力计法(GB/T 10792)或化学滴定法\n"
            "   - 过度碳酸化：出厂时故意提高10-15% CO₂含量，补偿运输和货架期损失\n\n"

            "三、瓶盖和灌装头的卫生消毒：\n\n"
            "1. 瓶盖消毒：\n"
            "   - 化学消毒：过氧乙酸(0.1-0.3%)或过氧化氢(3-5%)喷淋5-10秒\n"
            "   - 无菌水冲洗：去除消毒剂残留\n"
            "   - 臭氧消毒：10-15 ppm臭氧水喷淋\n"
            "   - 验证标准：瓶盖内表面菌落总数<10 CFU/个\n\n"

            "2. 灌装头/灌装阀消毒：\n"
            "   - CIP清洗：碱洗(NaOH 1.5-2.0%, 70°C, 15min) + 酸洗(HNO₃ 1.0%, 65°C, 10min)\n"
            "   - 热水消毒：85-95°C热水循环15-20分钟\n"
            "   - 化学消毒：过氧乙酸0.2%循环10分钟\n"
            "   - 频率：每班次生产前+品种切换+停产超过4小时\n\n"

            "3. PET瓶消毒(针对回收瓶或非无菌吹瓶)：\n"
            "   - 吹瓶-灌装一体机(Blow-Fill)：吹瓶后立即灌装，无需额外消毒\n"
            "   - 传统工艺：瓶外冲洗(自来水) → 瓶内冲洗(纯净水或臭氧水) → 倒置沥干\n"
            "   - 臭氧水浓度：2-5 ppm，接触时间≥5秒\n\n"

            "四、微生物控制关键点(GB 7101-2022)：\n"
            "1. 水处理：\n"
            "   - 生产用水应符合GB 5749《生活饮用水卫生标准》\n"
            "   - 纯净水/去离子水：反渗透(RO) + 紫外线消毒，电导率<10 μS/cm\n"
            "   - 微生物指标：菌落总数<10 CFU/mL，大肠菌群不得检出\n\n"

            "2. 配料罐和糖浆管路：\n"
            "   - 糖浆巴氏杀菌：80-85°C/15-30秒(糖浆pH<4.0可降低温度)\n"
            "   - 管路CIP：每天生产结束后清洗，防止糖浆残留滋生微生物\n"
            "   - 储罐换气口：0.22 μm除菌过滤器\n\n"

            "3. CO₂气体质量：\n"
            "   - 食品级CO₂：纯度≥99.9%，符合GB 1886.228《食品添加剂 二氧化碳》\n"
            "   - 微生物：<10 CFU/g\n"
            "   - 无异味、无油污、无有害气体(CO、NOx、SO₂)\n\n"

            "4. 灌装环境：\n"
            "   - 灌装区温度：≤25°C，相对湿度≤65%\n"
            "   - 空气洁净度：10万级(ISO 8级)，使用HEPA过滤\n"
            "   - 正压保护：灌装区相对外界正压≥10 Pa\n\n"

            "五、成品微生物标准(GB 7101-2022)：\n"
            "   - 菌落总数：≤100 CFU/mL(碳酸饮料)\n"
            "   - 霉菌和酵母：≤20 CFU/mL\n"
            "   - 大肠菌群：不得检出(n=5, c=0)\n"
            "   - 致病菌(沙门氏菌、金黄色葡萄球菌)：不得检出\n"
            "   注：碳酸饮料pH<4.0，抑制大部分细菌生长，主要风险是耐酸酵母和霉菌\n\n"

            "六、CO₂损失的预防措施：\n"
            "   - 低温储存：成品仓库温度≤25°C(理想15-20°C)\n"
            "   - 避光储存：紫外线加速PET老化，增加透气性\n"
            "   - 瓶盖扭矩：22-26 lb-in(2.5-2.9 N·m)，过松漏气，过紧损伤瓶口\n"
            "   - 运输振动：减少剧烈振动，防止CO₂析出\n"
            "   - 货架期：PET瓶装碳酸饮料6-9个月，玻璃瓶12个月\n\n"

            "法规依据：GB 7101-2022《食品安全国家标准 饮料》，GB 12695-2016《食品安全国家标准 饮料生产卫生规范》，"
            "GB 1886.228《食品添加剂 二氧化碳》。"
        ),
        "category": "process",
        "source": "GB 7101-2022/碳酸饮料灌装",
        "version": "2024",
        "metadata": {
            "standard_no": "GB 7101-2022",
            "related_standards": "GB 12695-2016, GB 1886.228",
            "target_query": "碳酸饮料灌装线卫生管理与微生物控制",
            "food_type": "beverage",
            "priority": "P1"
        }
    },

    # ===== Document 3: 学校食堂食品安全管理与营养健康规范 (catering, MRR=0.75) =====
    {
        "title": "学校食堂食品安全管理与营养健康规范(教育部等三部门令第45号)",
        "content": (
            "学校食堂是集体用餐单位中食品安全监管的重点区域。2019年教育部、国家市场监管总局、国家卫健委联合发布"
            "《学校食品安全与营养健康管理规定》(第45号令，2019年4月1日起施行)，明确了学校食品安全责任制、"
            "校长(园长)陪餐制度、食品留样制度等核心管理措施。\n\n"

            "一、法律责任体系：\n"
            "1. 校长(园长)第一责任人制度：\n"
            "   - 学校食品安全实行校长(园长)负责制\n"
            "   - 校长是本单位食品安全第一责任人\n"
            "   - 应建立健全食品安全管理制度，明确食品安全管理人员和岗位职责\n\n"

            "2. 校长陪餐制度(2019年新规亮点)：\n"
            "   - 中小学、幼儿园应当建立集中用餐陪餐制度\n"
            "   - 每餐均应当有学校相关负责人(校长/副校长/中层干部)与学生共同用餐\n"
            "   - 做好陪餐记录：就餐时间、菜品名称、食品感官、学生反馈、整改措施\n"
            "   - 陪餐人员签字确认，记录保存1学期以上\n"
            "   - 鼓励家长参与陪餐(家长委员会轮流参与)\n\n"

            "3. 专职食品安全管理人员配备：\n"
            "   - 学校食堂必须配备专职食品安全管理人员(第13条)\n"
            "   - 人员应经食品安全培训合格后上岗\n"
            "   - 每年参加食品安全培训不少于40学时\n"
            "   - 建立培训档案，包括培训时间、内容、考核结果\n\n"

            "二、食品留样制度(核心制度)：\n"
            "1. 留样范围：\n"
            "   - 学校食堂(含托幼机构食堂)\n"
            "   - 养老机构食堂\n"
            "   - 医疗机构食堂\n"
            "   - 中央厨房和集体用餐配送单位\n"
            "   - 重大活动餐饮服务单位\n\n"

            "2. 留样标准(125克/48小时规定)：\n"
            "   - 留样品种：每餐次供应的每个品种(包括主食、菜品、汤羹、调味品)\n"
            "   - 留样量：每个品种留样量不少于125克\n"
            "   - 留样容器：使用清洗消毒后的专用密封容器\n"
            "   - 储存条件：由专用留样冰箱冷藏保存，温度0-8°C\n"
            "   - 留样时间：保存48小时以上(≥48h)\n"
            "   - 留样标签：标注品名、留样时间(年月日时分)、留样人签名\n\n"

            "3. 留样管理制度：\n"
            "   - 双人双锁制度：留样冰箱由两名专人管理，两把锁钥匙分别保管\n"
            "   - 留样记录：品名、留样量、留样时间、留样人、冰箱温度\n"
            "   - 记录保存：留样记录保存6个月以上\n"
            "   - 冰箱专用：留样冰箱不得存放其他食品或物品\n"
            "   - 应急备用：发生食品安全事故时，留样用于流行病学调查和检验\n\n"

            "4. 125克标准的科学依据：\n"
            "   - 微生物检测：菌落总数、大肠菌群、致病菌检测需要≥25克\n"
            "   - 理化检测：农药残留、兽药残留、重金属等需要50-100克\n"
            "   - 复检留存：一次检测后仍需保留足够样品供复检\n"
            "   - 125克可满足2-3项检测+复检的需要\n\n"

            "三、食品原料采购与管理：\n"
            "1. 供应商资质审查：\n"
            "   - 建立供应商评估和准入制度\n"
            "   - 查验供应商食品经营许可证、营业执照\n"
            "   - 食品应具有合格证明文件(检验检疫证明、产品合格证)\n\n"

            "2. 进货查验制度：\n"
            "   - 查验食品包装标识、生产日期、保质期\n"
            "   - 感官检查：色泽、气味、状态\n"
            "   - 索证索票：留存供应商资质证明和每批次食品合格证明\n"
            "   - 记录保存：进货台账保存2年以上\n\n"

            "3. 禁止采购的食品：\n"
            "   - 超过保质期的食品\n"
            "   - 腐败变质、霉变、生虫的食品\n"
            "   - 未按规定检疫或检疫不合格的肉类及制品\n"
            "   - 病死、毒死或死因不明的禽畜肉类及制品\n"
            "   - 野生蘑菇、发芽土豆、鲜黄花菜、四季豆(未煮熟)\n"
            "   - 中小学、幼儿园食堂不得制售冷荤凉菜、生食、裱花蛋糕\n\n"

            "四、食品加工过程控制：\n"
            "1. 功能区域划分：\n"
            "   - 原料存储区、粗加工区、切配区、烹饪区、备餐区、餐具清洗消毒区\n"
            "   - 生熟分开、荤素分开\n"
            "   - 加工区与就餐区物理隔离\n\n"

            "2. 加工温度控制：\n"
            "   - 中心温度：肉类、禽类、蛋类制品中心温度≥70°C\n"
            "   - 烹饪时间：四季豆烹饪至失去原有生绿色和豆腥味\n"
            "   - 热菜供应：从烹饪到供餐不超过2小时\n\n"

            "3. 餐具清洗消毒：\n"
            "   - 热力消毒：煮沸/蒸汽100°C作用10分钟，或红外线消毒120°C作用10分钟\n"
            "   - 化学消毒：含氯消毒剂(有效氯250-500 mg/L)浸泡5分钟，清水冲洗\n"
            "   - 消毒后保洁：消毒后的餐具应存放在密闭保洁柜中\n\n"

            "五、营养健康管理(2019年新增要求)：\n"
            "1. 营养健康管理人员配备：\n"
            "   - 有条件的学校应配备营养专业人员或营养健康管理人员\n"
            "   - 制定带量食谱，标注菜品名称、原料、重量\n\n"

            "2. 公示制度：\n"
            "   - 每周食谱提前公示，接受师生和家长监督\n"
            "   - 公示食品原料主要供应商、食品安全管理人员\n\n"

            "3. 营养指导原则：\n"
            "   - 参照《学生餐营养指南》(WS/T 554-2017)\n"
            "   - 确保谷薯类、蔬菜水果类、鱼禽肉蛋类、奶豆坚果类食物供应\n"
            "   - 控制油盐糖摄入，少油少盐少糖\n\n"

            "六、监督检查与违法处理：\n"
            "   - 学校应每学期组织食品安全自查\n"
            "   - 市场监管部门开展学校食堂春秋季专项检查\n"
            "   - 未配备食品安全管理人员：责令改正，警告，拒不改正罚款5000-50000元\n"
            "   - 未建立陪餐制度：责令改正，警告\n"
            "   - 未落实食品留样：责令改正，警告，情节严重可罚款\n"
            "   - 发生食品安全事故：依据《食品安全法》追究刑事责任或吊销许可证\n\n"

            "法规依据：《学校食品安全与营养健康管理规定》(教育部等三部门令第45号，2019)，"
            "GB 31654-2021《食品安全国家标准 餐饮服务通用卫生规范》。"
        ),
        "category": "regulation",
        "source": "教育部等三部门令第45号/学校食堂",
        "version": "2024",
        "metadata": {
            "standard_no": "教育部等三部门令第45号",
            "related_standards": "GB 31654-2021, WS/T 554-2017",
            "target_query": "学校食堂食品安全管理与营养健康规范",
            "food_type": "catering",
            "priority": "P1"
        }
    },

    # ===== Document 4: 餐饮单位食品安全事故应急处置预案 (catering, MRR=0.75) =====
    {
        "title": "餐饮单位食品安全事故应急处置预案与报告制度(GB 31654-2021)",
        "content": (
            "食品安全事故(食物中毒)是餐饮服务单位的重大风险事件，可能导致群体性健康损害甚至死亡。"
            "GB 31654-2021《食品安全国家标准 餐饮服务通用卫生规范》和《食品安全法》对食品安全事故的应急处置、"
            "报告时限和责任追究提出了明确要求。\n\n"

            "一、食品安全事故定义与分级：\n\n"
            "1. 定义：\n"
            "   - 食源性疾病、食品污染等源于食品，对人体健康有危害或者可能有危害的事故\n"
            "   - 包括食物中毒、食源性感染、食源性中毒(化学性、生物性)\n\n"

            "2. 事故分级(按危害程度)：\n"
            "   - 特别重大(Ⅰ级)：死亡100人以上，或中毒1000人以上\n"
            "   - 重大(Ⅱ级)：死亡10-99人，或中毒100-999人\n"
            "   - 较大(Ⅲ级)：死亡3-9人，或中毒30-99人\n"
            "   - 一般(Ⅳ级)：死亡1-2人，或中毒30人以下\n"
            "   注：涉及学校、养老机构、医疗机构的食品安全事故，提高一级响应\n\n"

            "二、报告制度与时限要求(《食品安全法》第110条)：\n\n"
            "1. 事故单位报告义务：\n"
            "   - 发现食品安全事故后，应当立即停止经营活动\n"
            "   - 向所在地县级人民政府食品安全监督管理部门报告\n"
            "   - 报告时限：事故发生后2小时内(≤2h)\n"
            "   - 报告方式：电话报告+书面报告(后补)\n\n"

            "2. 报告内容：\n"
            "   - 事故单位名称、地址、联系人、联系方式\n"
            "   - 事故发生时间、地点、就餐人数、发病人数\n"
            "   - 中毒症状描述(呕吐、腹泻、发热、腹痛等)\n"
            "   - 可疑食品名称、来源、加工时间\n"
            "   - 已采取的应急措施\n"
            "   - 需要有关部门和单位协助的事项\n\n"

            "3. 逐级报告与信息发布：\n"
            "   - 县级→市级→省级：逐级上报，每级不超过2小时\n"
            "   - 特别重大事故(Ⅰ级)：省级政府应在2小时内向国务院报告\n"
            "   - 信息发布：由县级以上政府统一发布，禁止瞒报、谎报、迟报\n"
            "   - 媒体管理：未经授权，事故单位不得擅自对外发布信息\n\n"

            "三、应急处置流程(6步法)：\n\n"
            "第一步：立即停止经营，保护现场\n"
            "   - 停止使用可疑食品和原料\n"
            "   - 封存剩余食品、原料、工具、设备、餐具\n"
            "   - 保护留样食品(48小时留样)\n"
            "   - 保护呕吐物、排泄物，供采样检测\n"
            "   - 禁止破坏现场，禁止清洗消毒(等待调查)\n\n"

            "第二步：救治患者，防止事态扩大\n"
            "   - 立即拨打120急救电话\n"
            "   - 轻症患者：催吐(饮用温盐水或温开水)，送医院观察\n"
            "   - 重症患者(意识不清、休克)：保持呼吸道通畅，侧卧位，立即送医\n"
            "   - 就医信息：携带剩余可疑食品、呕吐物、留样食品供检测\n"
            "   - 禁止自行服药(可能掩盖症状、延误诊断)\n\n"

            "第三步：向监管部门报告(2小时内)\n"
            "   - 电话报告县级市场监管部门、卫健部门\n"
            "   - 学校食堂同时向教育主管部门报告\n"
            "   - 提供就餐名单、联系方式，便于流行病学调查\n\n"

            "第四步：配合调查，提供证据\n"
            "   - 提供食品留样(每个品种≥125克，48小时)\n"
            "   - 提供原料采购记录、进货凭证、供应商信息\n"
            "   - 提供从业人员健康证、培训记录\n"
            "   - 提供菜单、加工记录、温度记录\n"
            "   - 配合现场采样(食品、餐具、环境涂抹、从业人员粪便/呕吐物)\n\n"

            "第五步：追踪患者，统计人数\n"
            "   - 联系所有就餐人员，询问健康状况\n"
            "   - 建立患者登记表(姓名、性别、年龄、就餐时间、发病时间、症状、就医情况)\n"
            "   - 每日更新患者病情，向监管部门报告\n\n"

            "第六步：整改措施，恢复经营\n"
            "   - 查明事故原因后，制定整改方案\n"
            "   - 完成整改并通过监管部门验收后，方可恢复经营\n"
            "   - 召开员工培训会，分析事故教训\n"
            "   - 修订食品安全管理制度，防止类似事故再次发生\n\n"

            "四、常见食物中毒类型与识别：\n\n"
            "1. 细菌性食物中毒(占比70-80%)：\n"
            "   - 沙门氏菌：潜伏期12-24h，腹泻、发热、呕吐，来源：禽蛋、肉类\n"
            "   - 副溶血性弧菌：潜伏期6-18h，剧烈腹泻(水样便)，来源：海产品\n"
            "   - 金黄色葡萄球菌：潜伏期1-6h，呕吐为主，来源：奶制品、肉制品(带菌者污染)\n"
            "   - 致病性大肠杆菌：潜伏期12-72h，腹泻(血便)，来源：生蔬菜、未煮熟肉类\n"
            "   - 蜡样芽孢杆菌：潜伏期2-16h，呕吐或腹泻，来源：剩米饭、炒饭\n\n"

            "2. 化学性食物中毒：\n"
            "   - 亚硝酸盐：潜伏期10-30min，紫绀(嘴唇发紫)、头晕，来源：误用工业盐、腌制品\n"
            "   - 农药残留：潜伏期数分钟-2h，流涎、瞳孔缩小，来源：蔬菜未清洗\n"
            "   - 组胺：潜伏期数分钟，皮肤潮红、荨麻疹，来源：鲐鱼、金枪鱼(不新鲜)\n\n"

            "3. 有毒动植物中毒：\n"
            "   - 河豚毒素：潜伏期10-45min，口唇麻木、呼吸困难，致死率高\n"
            "   - 毒蘑菇：潜伏期6-12h，呕吐腹泻→肝肾衰竭，致死率高\n"
            "   - 四季豆皂素：潜伏期2-4h，恶心呕吐，来源：四季豆未煮熟\n"
            "   - 发芽土豆龙葵素：潜伏期2-4h，口舌发麻、呕吐\n\n"

            "五、预防措施(关键控制点)：\n"
            "   - 原料采购：禁止采购野生蘑菇、河豚、病死畜禽、发芽土豆\n"
            "   - 加工温度：肉类中心温度≥70°C，四季豆充分煮熟\n"
            "   - 时间控制：从烹饪到供餐≤2小时，剩余食品冷藏≤24小时后丢弃\n"
            "   - 交叉污染：生熟分开，案板、刀具、容器分开使用\n"
            "   - 从业人员：持有效健康证，有腹泻、发热、化脓性伤口者暂停接触食品\n"
            "   - 餐具消毒：热力消毒100°C/10min或化学消毒250-500 mg/L氯/5min\n\n"

            "六、法律责任：\n"
            "   - 未按规定报告食品安全事故：罚款50000-200000元(《食品安全法》第126条)\n"
            "   - 瞒报、谎报、迟报：对直接负责人给予警告、记过或撤职处分\n"
            "   - 造成严重后果：依法追究刑事责任(生产、销售不符合安全标准食品罪，最高可判无期徒刑)\n\n"

            "法规依据：《中华人民共和国食品安全法》(2021修正)，GB 31654-2021《食品安全国家标准 餐饮服务通用卫生规范》，"
            "《国家食品安全事故应急预案》(国办函〔2021〕64号)。"
        ),
        "category": "sop",
        "source": "GB 31654-2021/应急预案",
        "version": "2024",
        "metadata": {
            "standard_no": "GB 31654-2021",
            "related_standards": "食品安全法2021, 国办函〔2021〕64号",
            "target_query": "餐饮单位食品安全事故应急处置预案",
            "food_type": "catering",
            "priority": "P1"
        }
    },

    # ===== Document 5: 食用植物油精炼工艺全流程控制规范 (edible_oil, MRR=0.83) =====
    {
        "title": "食用植物油精炼工艺全流程控制规范(GB 2716-2018)",
        "content": (
            "食用植物油精炼是通过物理或化学方法去除毛油中的杂质(磷脂、游离脂肪酸、色素、气味物质)，"
            "改善油脂的色泽、气味、口感和稳定性。GB 2716-2018《食品安全国家标准 植物油》规定了精炼食用植物油的"
            "酸值、过氧化值、溶剂残留等质量安全指标。\n\n"

            "一、精炼工艺流程(四脱)：\n"
            "脱胶(Degumming) → 脱酸(Deacidification) → 脱色(Bleaching) → 脱臭(Deodorization)\n\n"

            "二、脱胶(Degumming)工艺：\n"
            "目的：去除磷脂、蛋白质、微量金属离子\n\n"
            "1. 水化脱胶(适用于低磷油脂)：\n"
            "   - 原理：磷脂吸水后膨胀、凝聚、沉降\n"
            "   - 温度：毛油加热至60-70°C\n"
            "   - 加水量：占油重的2-3%，水温80-90°C\n"
            "   - 搅拌：慢速搅拌30-60分钟，使磷脂充分水化\n"
            "   - 沉降：静置2-4小时，分离油脚(含水磷脂)\n"
            "   - 残留磷含量：降至50-200 ppm\n\n"

            "2. 酸炼脱胶(适用于高磷油脂，如菜籽油)：\n"
            "   - 酸液：磷酸(H₃PO₄)或柠檬酸，浓度0.1-0.3%\n"
            "   - 温度：70-80°C\n"
            "   - 原理：酸将非水化磷脂转化为水化磷脂，同时螯合金属离子\n"
            "   - 加水水化：加酸后加热水(占油重2-3%)水化30-60分钟\n"
            "   - 残留磷含量：降至10-30 ppm\n\n"

            "3. 酶法脱胶(磷脂酶C/A)：\n"
            "   - 温度：50-60°C(酶最适温度)\n"
            "   - 酶用量：50-100 ppm\n"
            "   - 反应时间：2-4小时\n"
            "   - 优势：降低酸值、减少中性油损失、环保\n"
            "   - 残留磷含量：≤5 ppm\n\n"

            "三、脱酸(Deacidification/Neutralization)工艺：\n"
            "目的：去除游离脂肪酸(Free Fatty Acids, FFA)\n\n"
            "1. 化学脱酸(碱炼法)：\n"
            "   - 碱液：NaOH溶液，浓度根据油脂酸值计算\n"
            "   - 理论碱量 = 油重 × 酸值 × 1.25(过量系数)\n"
            "   - 温度：脱胶油加热至70-80°C\n"
            "   - 中和反应：FFA + NaOH → 皂脚(脂肪酸钠盐) + H₂O\n"
            "   - 搅拌：快速搅拌10-15分钟，慢速搅拌20-30分钟\n"
            "   - 沉降分离：静置4-6小时，分离皂脚\n"
            "   - 水洗：85-90°C热水洗涤2-3次，去除残留碱和皂\n"
            "   - 脱酸后酸值：≤0.2 mg KOH/g(GB 2716-2018要求)\n\n"

            "2. 物理脱酸(蒸馏法)：\n"
            "   - 原理：高温高真空条件下，游离脂肪酸挥发蒸出\n"
            "   - 温度：230-260°C\n"
            "   - 真空度：0.1-0.5 kPa(1-5 mbar)\n"
            "   - 蒸汽喷射：0.5-1.5%直接蒸汽，增加气液接触面\n"
            "   - 优势：无皂脚损失、得率高、适用于高酸值油\n"
            "   - 缺点：设备投资大、能耗高\n\n"

            "四、脱色(Bleaching/Decolorization)工艺：\n"
            "目的：去除色素(叶绿素、胡萝卜素、叶黄素)、残留磷脂、微量金属\n\n"
            "1. 吸附脱色法：\n"
            "   - 吸附剂：活性白土(主流)或活性炭\n"
            "   - 白土用量：占油重2-5%(根据色素含量调整)\n"
            "   - 温度：95-108°C(标准105°C)\n"
            "   - 真空度：2-5 kPa(防止油脂氧化)\n"
            "   - 搅拌时间：20-30分钟\n"
            "   - 过滤：板框压滤或叶片过滤，去除白土\n\n"

            "2. 脱色效果评价：\n"
            "   - 色泽：罗维朋比色计，一级油≤Y30 R3.0(GB 2716-2018)\n"
            "   - 残留磷：≤3 mg/kg\n"
            "   - 过氧化值：脱色过程应防止氧化(真空保护)\n\n"

            "五、脱臭(Deodorization)工艺：\n"
            "目的：去除异味物质(低分子醛酮类、游离脂肪酸、挥发性有机物)\n\n"

            "1. 物理脱臭(蒸汽汽提法)：\n"
            "   - 温度：240-260°C(不同油种有差异)\n"
            "     · 大豆油/葵花籽油：240-250°C\n"
            "     · 棕榈油：250-260°C\n"
            "     · 高温敏感油脂(如亚麻籽油)：220-230°C\n"
            "   - 真空度：0.27-0.40 kPa(2-3 mbar，高真空)\n"
            "   - 直接蒸汽量：1.0-2.0%(占油重)\n"
            "   - 停留时间：40-90分钟(取决于油种和设备)\n"
            "   - 原理：蒸汽在高温高真空下携带挥发性物质逸出\n\n"

            "2. 脱臭过程分段控制：\n"
            "   - 预热段：脱色油从105°C逐步加热至脱臭温度(通过板式换热器)\n"
            "   - 脱臭段：240-260°C保温，注入直接蒸汽汽提\n"
            "   - 热回收段：脱臭油通过板式换热器冷却至80-100°C(加热进油)\n"
            "   - 急冷段：快速冷却至40-50°C，防止油脂氧化和回色\n\n"

            "3. 脱臭后质量指标：\n"
            "   - 气味：无异味，具有该油种固有清香味\n"
            "   - 酸值：≤0.2 mg KOH/g(一级油标准，GB 2716-2018)\n"
            "   - 过氧化值：≤5 mmol/kg(一级油标准)\n"
            "   - 溶剂残留(浸出油)：≤10 mg/kg\n"
            "   - 烟点：≥215°C(油品稳定性指标)\n\n"

            "六、成品油质量标准(GB 2716-2018)：\n"
            "1. 一级食用植物油：\n"
            "   - 酸值：≤0.20 mg KOH/g\n"
            "   - 过氧化值：≤5 mmol/kg\n"
            "   - 溶剂残留：≤10 mg/kg(浸出油)\n"
            "   - 色泽：≤Y30 R3.0(罗维朋)\n"
            "   - 烟点：≥215°C\n"
            "   - 水分及挥发物：≤0.05%\n\n"

            "2. 二级食用植物油：\n"
            "   - 酸值：≤0.30 mg KOH/g\n"
            "   - 过氧化值：≤5 mmol/kg\n"
            "   - 溶剂残留：≤50 mg/kg(浸出油)\n\n"

            "3. 三级/四级(保留营养型油脂)：\n"
            "   - 酸值：≤1.0 mg KOH/g(三级)，≤3.0(四级)\n"
            "   - 只经过简单脱胶/脱酸，保留生育酚、植物甾醇等营养成分\n\n"

            "七、污染物限量(GB 2716-2018)：\n"
            "   - 苯并[a]芘：≤10 μg/kg(一级油)\n"
            "   - 溶剂残留：≤10 mg/kg(一级浸出油)\n"
            "   - 黄曲霉毒素B₁：≤5 μg/kg(花生油、玉米油)\n"
            "   - 铅(Pb)：≤0.1 mg/kg\n"
            "   - 砷(As)：≤0.1 mg/kg\n\n"

            "八、精炼过程质量控制点：\n"
            "   - 脱胶后磷含量：≤30 ppm(化学脱胶)，≤5 ppm(酶法)\n"
            "   - 脱酸后酸值：≤0.3 mg KOH/g\n"
            "   - 脱色后色泽：≤Y30 R3.0\n"
            "   - 脱臭温度监控：±5°C波动(避免过度氧化或脱臭不彻底)\n"
            "   - 真空度监控：脱臭真空度<3 mbar(保证挥发性物质有效去除)\n"
            "   - 抗氧化剂添加：TBHQ≤200 mg/kg(GB 2760允许)\n\n"

            "法规依据：GB 2716-2018《食品安全国家标准 植物油》，GB 2760《食品安全国家标准 食品添加剂使用标准》。"
        ),
        "category": "process",
        "source": "GB 2716-2018/植物油精炼",
        "version": "2024",
        "metadata": {
            "standard_no": "GB 2716-2018",
            "related_standards": "GB 2760",
            "target_query": "食用植物油精炼工艺全流程控制规范",
            "food_type": "edible_oil",
            "priority": "P1"
        }
    },

    # ===== Document 6: 烘焙制品微生物控制与货架期管理 (bakery, MRR=0.85) =====
    {
        "title": "烘焙制品微生物控制与货架期管理规范(GB 7099-2015)",
        "content": (
            "烘焙制品(糕点、面包)因含水量、营养丰富，易发生霉菌污染导致货架期缩短。"
            "GB 7099-2015《食品安全国家标准 糕点、面包》规定了烘焙制品的微生物限量，"
            "GB 2760-2014规定了防腐剂使用限量，水分活度(aw)管理是延长货架期的核心技术。\n\n"

            "一、水分活度(aw)与微生物生长关系：\n\n"
            "1. 水分活度定义：\n"
            "   - aw = 食品中水蒸气压 / 纯水蒸气压(同温度)\n"
            "   - 取值范围：0-1.0，纯水aw=1.0\n"
            "   - aw反映食品中\"自由水\"含量，而非总水分含量\n\n"

            "2. 微生物生长的aw阈值：\n"
            "   - 细菌：aw ≥ 0.90(大部分致病菌)\n"
            "   - 酵母：aw ≥ 0.85\n"
            "   - 霉菌：aw ≥ 0.80(普通霉菌)，aw ≥ 0.70(嗜干霉菌)\n"
            "   - 嗜干霉菌(Xerophilic molds)：Eurotium、Aspergillus restrictus可在aw=0.65-0.70生长\n"
            "   - 微生物生长停止：aw < 0.60(所有微生物)\n\n"

            "3. 烘焙制品aw分类与货架期：\n"
            "   - 高水分糕点(aw > 0.85)：奶油蛋糕、慕斯蛋糕，货架期2-5天(冷藏)\n"
            "   - 中水分糕点(aw 0.70-0.85)：月饼、绿豆糕、蛋黄派，货架期30-60天\n"
            "   - 低水分糕点(aw < 0.70)：曲奇、威化、饼干，货架期6-12个月\n"
            "   - 面包(aw 0.90-0.95)：软面包货架期3-7天，硬面包(法棍)货架期1-2天\n\n"

            "二、霉菌污染的主要来源与预防：\n\n"

            "1. 污染来源：\n"
            "   - 原料污染：面粉、鸡蛋、奶制品携带霉菌孢子\n"
            "   - 环境污染：车间空气、操作台面、包装材料\n"
            "   - 人员污染：操作人员手部、工作服\n"
            "   - 冷却环节：烘烤后冷却过程是霉菌二次污染的高风险点\n\n"

            "2. 预防措施：\n"
            "   a) 原料控制：\n"
            "      - 面粉水分≤14.5%，储存温度≤25°C，相对湿度≤65%\n"
            "      - 鸡蛋表面清洗消毒(200-300 ppm含氯消毒液)\n"
            "      - 奶粉、糖浆密封保存，开封后尽快使用\n\n"

            "   b) 环境控制：\n"
            "      - 车间空气：10万级(ISO 8级)洁净度，HEPA过滤\n"
            "      - 紫外线消毒：冷却区、包装区安装UV灯，波长254 nm，照射强度≥90 μW/cm²\n"
            "      - 臭氧消毒：5-10 ppm臭氧熏蒸30-60分钟(夜间无人时)\n"
            "      - 正压保护：冷却区、包装区相对外界正压≥10 Pa\n\n"

            "   c) 人员卫生：\n"
            "      - 进入车间：更衣、洗手、戴口罩、帽子、手套\n"
            "      - 手部消毒：75%酒精或含氯消毒液(50-100 ppm)\n\n"

            "   d) 设备清洁：\n"
            "      - 每日清洁：搅拌机、模具、输送带\n"
            "      - 每周深度清洁：烤箱内壁、冷却隧道\n"
            "      - CIP清洗(管路系统)：碱洗+酸洗+消毒\n\n"

            "三、防腐剂使用规范(GB 2760-2014)：\n\n"

            "1. 山梨酸及其钾盐(最常用)：\n"
            "   - 限量：糕点≤1.0 g/kg(以山梨酸计)\n"
            "   - 作用机理：抑制霉菌、酵母细胞膜合成\n"
            "   - 最适pH：<6.0(弱酸性环境效果最佳)\n"
            "   - 添加方式：面团中直接添加或表面喷涂\n"
            "   - 优势：毒性低(ADI 0-25 mg/kg体重)，广谱抑菌\n\n"

            "2. 丙酸及其盐类：\n"
            "   - 限量：面包≤2.5 g/kg(以丙酸计)，糕点≤3.0 g/kg\n"
            "   - 作用机理：抑制霉菌孢子发芽和菌丝生长\n"
            "   - 适用产品：面包、蛋糕(不影响酵母发酵)\n"
            "   - 常用盐类：丙酸钙(Calcium Propionate, E282)\n\n"

            "3. 脱氢乙酸及其钠盐：\n"
            "   - 限量：糕点≤0.5 g/kg(以脱氢乙酸计)\n"
            "   - 作用：广谱防腐，但对霉菌效果不如山梨酸\n\n"

            "4. 纳他霉素(Natamycin, E235)：\n"
            "   - 限量：糕点表面≤300 mg/kg(仅表面使用，不得检出残留深度>5mm)\n"
            "   - 作用：特异性抗真菌，对细菌无效\n"
            "   - 使用方式：表面喷涂或浸泡(200-300 ppm纳他霉素溶液)\n\n"

            "5. 乙醇(酒精)喷涂：\n"
            "   - 浓度：55-65%乙醇溶液\n"
            "   - 方式：产品表面喷涂，迅速包装(利用酒精挥发产生的气相抑菌)\n"
            "   - 效果：可延长货架期30-50%\n"
            "   - 注意：不适用于儿童食品(残留酒精)\n\n"

            "四、货架期预测与控制：\n\n"

            "1. 货架期影响因素：\n"
            "   - 水分活度(aw)：主导因素\n"
            "   - 储存温度：每升高10°C，货架期缩短50%(Q10规则)\n"
            "   - 包装材料：氧气透过率(OTR)、水蒸气透过率(WVTR)\n"
            "   - 防腐剂种类和浓度\n"
            "   - 初始微生物负荷\n\n"

            "2. 货架期预测模型：\n"
            "   - 微生物生长动力学：Gompertz模型、Logistic模型\n"
            "   - 加速试验：37°C储存7天 ≈ 25°C储存28天(Q10=2)\n"
            "   - 感官评价：色泽、风味、质地变化\n\n"

            "3. 包装技术延长货架期：\n"
            "   a) 气调包装(MAP, Modified Atmosphere Packaging)：\n"
            "      - 气体组成：N₂ 80-90% + CO₂ 10-20%(或纯CO₂)\n"
            "      - 抑菌机理：CO₂抑制霉菌、酵母生长\n"
            "      - 货架期延长：2-3倍\n"
            "      - 适用产品：切片面包、蛋糕、月饼\n\n"

            "   b) 脱氧剂包装：\n"
            "      - 原理：铁粉+水+氧气→氧化铁(吸收包装内氧气)\n"
            "      - 效果：氧气浓度<0.1%，霉菌无法生长\n"
            "      - 注意：需配合高阻隔包装材料(OTR<50 cc/m²/day)\n\n"

            "   c) 酒精发生剂：\n"
            "      - 原理：小包缓释酒精蒸汽，抑菌\n"
            "      - 浓度：包装内达到2-5%酒精蒸汽\n\n"

            "五、微生物限量标准(GB 7099-2015)：\n"
            "1. 糕点(除裱花蛋糕)：\n"
            "   - 菌落总数：n=5, c=2, m=10⁴ CFU/g, M=10⁵ CFU/g\n"
            "   - 霉菌：≤150 CFU/g\n"
            "   - 大肠菌群：n=5, c=2, m=10 CFU/g, M=100 CFU/g\n"
            "   - 沙门氏菌：不得检出(25g)\n"
            "   - 金黄色葡萄球菌：n=5, c=1, m=100 CFU/g, M=1000 CFU/g\n\n"

            "2. 裱花蛋糕(冷藏糕点)：\n"
            "   - 菌落总数：≤5×10⁴ CFU/g\n"
            "   - 霉菌：≤50 CFU/g\n"
            "   - 大肠菌群：≤100 CFU/g\n"
            "   - 致病菌：沙门氏菌、金黄色葡萄球菌不得检出\n\n"

            "3. 面包：\n"
            "   - 菌落总数：≤1000 CFU/g(热加工后未再处理产品)\n"
            "   - 霉菌：≤150 CFU/g\n"
            "   - 大肠菌群：≤10 CFU/g\n\n"

            "六、货架期标识管理：\n"
            "   - 高水分糕点(aw>0.85)：冷藏(0-4°C)保质期2-7天\n"
            "   - 中水分糕点(aw 0.70-0.85)：常温保质期30-90天\n"
            "   - 低水分糕点(aw<0.70)：常温保质期6-12个月\n"
            "   - 标签标注：储存条件(冷藏/常温)、保质期、\"开封后尽快食用\"提示\n\n"

            "法规依据：GB 7099-2015《食品安全国家标准 糕点、面包》，GB 2760-2014《食品安全国家标准 食品添加剂使用标准》。"
        ),
        "category": "process",
        "source": "GB 7099-2015/烘焙微生物",
        "version": "2024",
        "metadata": {
            "standard_no": "GB 7099-2015",
            "related_standards": "GB 2760-2014",
            "target_query": "烘焙制品微生物控制与货架期管理",
            "food_type": "bakery",
            "priority": "P1"
        }
    },

    # ===== Document 7: 粮食仓储害虫防治与磷化铝熏蒸操作规范 (grain, MRR=0.87) =====
    {
        "title": "粮食仓储害虫防治与磷化铝熏蒸操作规范(GB/T 29890)",
        "content": (
            "粮食储藏期间害虫(储粮害虫)是导致粮食损失和品质下降的主要因素之一。磷化铝熏蒸是粮食害虫防治的主流化学方法，"
            "但磷化氢(PH₃)气体剧毒，操作不当可能导致人员中毒死亡。GB/T 29890《粮油储藏 磷化氢环流熏蒸技术规程》"
            "和GB 2715《食品安全国家标准 粮食》规定了熏蒸操作规范和残留限量。\n\n"

            "一、主要储粮害虫种类：\n"
            "1. 甲虫类(Coleoptera)：\n"
            "   - 玉米象(Sitophilus zeamais)：最常见，蛀食粮粒内部\n"
            "   - 米象(Sitophilus oryzae)：危害稻谷、小麦\n"
            "   - 谷蠹(Rhyzopertha dominica)：蛀食胚乳，产生粉末\n"
            "   - 锯谷盗(Oryzaephilus surinamensis)：蛀食破碎粮粒\n"
            "   - 赤拟谷盗(Tribolium castaneum)：杂食性，适应性强\n\n"

            "2. 蛾类(Lepidoptera)：\n"
            "   - 印度谷螟(Plodia interpunctella)：危害面粉、杂粮\n"
            "   - 玉米螟(Ostrinia furnacalis)：危害玉米穗\n\n"

            "3. 螨类(Acari)：\n"
            "   - 粉螨(Acarus siro)：高湿度环境(RH>70%)大量繁殖\n\n"

            "二、磷化铝熏蒸原理：\n"
            "1. 化学反应：\n"
            "   - AlP(固体) + 3H₂O → Al(OH)₃↓ + PH₃↑(磷化氢气体)\n"
            "   - 磷化铝片剂遇空气中水分缓慢释放磷化氢气体\n"
            "   - 释放速率：取决于温度、湿度(温度↑湿度↑→释放↑)\n\n"

            "2. 杀虫机理：\n"
            "   - PH₃气体穿透昆虫呼吸系统→抑制细胞色素氧化酶→细胞呼吸中断→窒息死亡\n"
            "   - 对卵、幼虫、蛹、成虫均有效\n"
            "   - 慢性毒剂：需足够浓度×时间(CT积累)\n\n"

            "三、熏蒸操作规范(GB/T 29890)：\n\n"

            "1. 熏蒸前准备：\n"
            "   - 粮温测定：粮温≥15°C(最适20-30°C)，<15°C杀虫效果差\n"
            "   - 粮食水分：≤14%(水分过高促进磷化铝分解，增加安全风险)\n"
            "   - 密闭性检查：仓房气密性测试，半衰期≥30秒(点燃烟雾消散时间)\n"
            "   - 警示标识：仓门悬挂\"熏蒸中毒,严禁入内\"警示牌\n\n"

            "2. 磷化铝用量计算：\n"
            "   - 仓房熏蒸：3-5克/立方米(g/m³)，常用3 g/m³\n"
            "   - 袋装堆垛熏蒸：6-9克/吨粮食\n"
            "   - 目标浓度：200-400 ppm(mg/L)磷化氢\n"
            "   - 换算：1克AlP片剂释放约0.33克PH₃气体\n\n"

            "3. 投药方式：\n"
            "   a) 表层施药法：\n"
            "      - 将磷化铝片剂均匀撒布在粮堆表面\n"
            "      - 覆盖塑料薄膜密封\n"
            "      - 适用：小型仓房、袋装粮\n\n"

            "   b) 深层施药法：\n"
            "      - 使用施药管插入粮堆深层(2-3米)投药\n"
            "      - 投药点间距4-5米\n"
            "      - 适用：散装粮食仓房\n\n"

            "   c) 环流熏蒸法(GB/T 29890推荐)：\n"
            "      - 使用环流风机将PH₃气体均匀分布至粮堆各部位\n"
            "      - 提高熏蒸效率，缩短熏蒸时间\n"
            "      - 环流速度：0.5-1.5 m/s\n\n"

            "4. 熏蒸时间与浓度：\n"
            "   - 标准条件(20-25°C)：\n"
            "     · 浓度200-300 ppm × 熏蒸时间72-96小时(3-4天)\n"
            "     · 浓度400-500 ppm × 熏蒸时间48-72小时\n"
            "   - 低温条件(15-20°C)：\n"
            "     · 延长熏蒸时间至5-7天\n"
            "   - CT值(Concentration × Time)：\n"
            "     · 杀灭成虫：CT = 200 ppm·h(例如200 ppm × 100小时)\n"
            "     · 杀灭卵：CT = 600-800 ppm·h(卵抗性最强)\n\n"

            "5. 浓度监测：\n"
            "   - 检测仪器：便携式磷化氢检测管或电化学传感器\n"
            "   - 监测频率：熏蒸开始后6h、24h、48h、72h各测1次\n"
            "   - 监测位点：粮堆上、中、下层各取样\n"
            "   - 浓度不足：补充投药至目标浓度\n\n"

            "6. 熏蒸终止与散气：\n"
            "   - 熏蒸结束条件：达到规定熏蒸时间 + CT值达标\n"
            "   - 自然散气：打开门窗、通风口，自然散气7-10天\n"
            "   - 机械通风：使用轴流风机强制通风48-72小时\n"
            "   - 残留检测：散气后测定粮食中PH₃残留<0.05 ppm(GB 2715安全限量)\n"
            "   - 进仓标准：仓内PH₃浓度<0.3 ppm，人员方可进入\n\n"

            "四、安全防护措施(重中之重)：\n\n"

            "1. 个人防护装备(PPE)：\n"
            "   - 防毒面具：全面罩正压式空气呼吸器(SCBA)或长管送风式呼吸器\n"
            "   - 防护服：密闭型防化服\n"
            "   - 手套：丁腈橡胶手套\n"
            "   - 禁止使用普通防毒面具(PH₃穿透性强)\n\n"

            "2. 作业人员资质：\n"
            "   - 必须持有《熏蒸作业人员资格证》\n"
            "   - 每年健康体检(肺功能、肝肾功能)\n"
            "   - 禁止单独作业，至少2人协同\n\n"

            "3. 中毒急救：\n"
            "   - PH₃职业暴露限值：MAC 0.3 mg/m³(8小时时间加权平均)\n"
            "   - 中毒症状：头痛、头晕、恶心、呼吸困难、肺水肿、惊厥\n"
            "   - 急救措施：\n"
            "     · 立即将患者转移至空气新鲜处\n"
            "     · 保持呼吸道通畅，吸氧\n"
            "     · 严重者立即送医(亚甲蓝注射治疗)\n"
            "     · 禁止口对口人工呼吸(施救者可能中毒)\n\n"

            "4. 仓房警戒：\n"
            "   - 熏蒸期间仓房上锁，设置警戒线\n"
            "   - 门口张贴\"磷化铝熏蒸,严禁入内,违者后果自负\"标识\n"
            "   - 专人值守，记录进出人员\n\n"

            "五、残留限量与检测(GB 2715-2016)：\n"
            "1. 磷化氢残留限量：\n"
            "   - 粮食及制品：≤0.05 mg/kg(以PH₃计)\n"
            "   - 检测方法：气相色谱法(GB/T 5009.41)\n\n"

            "2. 其他质量指标(熏蒸前后对比)：\n"
            "   - 脂肪酸值：变化<5 mg KOH/100g干基(无明显氧化)\n"
            "   - 发芽率：允许下降<10%(磷化铝对发芽率影响小)\n\n"

            "六、抗性管理：\n"
            "   - 害虫抗性：长期单一使用磷化铝导致抗性品系出现\n"
            "   - 综合防治(IPM)策略：\n"
            "     · 物理防治：低温储藏(<15°C)、气调储藏(CO₂/N₂)\n"
            "     · 生物防治：释放害虫天敌(寄生蜂)\n"
            "     · 化学防治：磷化铝 + 有机磷类(敌敌畏)交替使用\n"
            "     · 环境管理：仓房清洁、降低水分和温度\n\n"

            "七、替代技术：\n"
            "1. 气调储藏(CA, Controlled Atmosphere)：\n"
            "   - CO₂浓度40-60%，O₂<2%，窒息害虫\n"
            "   - 优势：无残留、无抗性、保持品质\n"
            "   - 缺点：成本高、需高气密性仓房\n\n"

            "2. 臭氧熏蒸：\n"
            "   - O₃浓度50-100 ppm，处理2-4小时\n"
            "   - 优势：快速分解为O₂，无残留\n\n"

            "3. 低温储藏：\n"
            "   - 粮温≤15°C，害虫停止繁殖\n"
            "   - 粮温≤10°C，害虫活动停止\n\n"

            "法规依据：GB/T 29890《粮油储藏 磷化氢环流熏蒸技术规程》，GB 2715-2016《食品安全国家标准 粮食》，"
            "GBZ 2.1-2019《工作场所有害因素职业接触限值 化学有害因素》。"
        ),
        "category": "process",
        "source": "GB/T 29890/粮食熏蒸",
        "version": "2024",
        "metadata": {
            "standard_no": "GB/T 29890",
            "related_standards": "GB 2715-2016, GBZ 2.1-2019",
            "target_query": "粮食仓储害虫防治与磷化铝熏蒸操作规范",
            "food_type": "grain",
            "priority": "P1"
        }
    },

    # ===== Document 8: 食品接触材料迁移测试方法与安全评估 (contact_material, MRR=0.875) =====
    {
        "title": "食品接触材料迁移测试方法与安全评估规范(GB 31604系列)",
        "content": (
            "食品接触材料(FCMs, Food Contact Materials)在正常使用条件下，可能向食品中迁移化学物质，"
            "影响食品安全和感官品质。GB 31604系列标准规定了迁移测试的通用规则和具体测试方法，"
            "EU 10/2011和GB 4806系列规定了塑料食品接触材料的组成物质清单和限量要求。\n\n"

            "一、食品接触材料分类：\n"
            "1. 塑料(最常用)：PET、PE、PP、PS、PC、PVC、尼龙等\n"
            "2. 金属：不锈钢、铝、镀锡钢板(罐头)\n"
            "3. 玻璃/陶瓷：玻璃容器、陶瓷餐具\n"
            "4. 纸张/纸板：食品包装纸、纸杯、纸盒\n"
            "5. 橡胶/硅胶：密封圈、硅胶铲、奶嘴\n"
            "6. 涂层/油墨：内涂层(罐头)、印刷油墨\n\n"

            "二、迁移测试的两大核心指标：\n\n"

            "1. 总迁移量(OML, Overall Migration Limit)：\n"
            "   - 定义：从食品接触材料迁移到食品或食品模拟物中的所有非挥发性物质总量\n"
            "   - 限量：≤10 mg/dm²(接触面积)或≤60 mg/kg(食品或模拟物)\n"
            "   - 意义：反映材料整体迁移风险\n"
            "   - 测试方法：GB 31604.8-2021/GB 31604.9-2016(蒸发残渣法)\n\n"

            "2. 特定迁移量(SML, Specific Migration Limit)：\n"
            "   - 定义：某一特定物质(单体、添加剂、降解产物)从材料迁移到食品中的量\n"
            "   - 限量：根据物质毒理学数据设定，单位mg/kg食品\n"
            "   - 常见物质限量：\n"
            "     · 双酚A(BPA)：≤0.6 mg/kg(婴幼儿用品禁用)\n"
            "     · 邻苯二甲酸酯类(DEHP)：≤1.5 mg/kg\n"
            "     · 己内酰胺(尼龙单体)：≤15 mg/kg\n"
            "     · 苯乙烯(PS单体)：≤0.6 mg/kg\n"
            "     · 氯乙烯单体(PVC)：≤0.01 mg/kg\n"
            "     · 甲醛：≤15 mg/kg\n"
            "     · 重金属(铅、镉、汞、六价铬)：各有限量\n\n"

            "三、食品模拟物选择(GB 31604.1-2023)：\n"
            "食品模拟物用于替代真实食品进行迁移测试，选择原则：匹配食品的溶解性、极性、脂肪含量\n\n"

            "1. 模拟物分类(EU 10/2011和GB 31604.1)：\n"
            "   - 模拟物A：10%乙醇(水溶液)→ 模拟水性食品(果汁、饮料、蔬菜)\n"
            "   - 模拟物B：3%乙酸(水溶液)→ 模拟酸性食品(醋、柑橘、番茄)\n"
            "   - 模拟物C：20%乙醇(水溶液)→ 模拟低醇食品(酒精饮料≤20%)\n"
            "   - 模拟物D1：50%乙醇(水溶液)→ 模拟高醇食品(白酒、烈酒)\n"
            "   - 模拟物D2：植物油(橄榄油、葵花籽油)→ 模拟高脂食品(食用油、黄油、奶酪)\n"
            "   - 模拟物E：异辛烷或95%乙醇→ 模拟干性食品(谷物、面粉、饼干)\n\n"

            "2. 模拟物选择示例：\n"
            "   - 矿泉水/纯净水 → 模拟物A(10%乙醇)\n"
            "   - 碳酸饮料/果汁 → 模拟物B(3%乙酸)\n"
            "   - 牛奶(含脂3-5%) → 模拟物D2(植物油)\n"
            "   - 食用油 → 模拟物D2(植物油)\n"
            "   - 酒类(≤20%酒精) → 模拟物C(20%乙醇)\n"
            "   - 白酒(>20%酒精) → 模拟物D1(50%乙醇)\n"
            "   - 酱油/醋 → 模拟物B(3%乙酸)\n"
            "   - 干性食品(面粉/大米) → 模拟物E(95%乙醇或异辛烷)\n\n"

            "四、迁移测试条件(时间+温度)：\n"
            "测试条件模拟实际使用的最严酷条件(worst-case scenario)\n\n"

            "1. 常温储存食品：\n"
            "   - 短期接触(≤24h)：40°C × 10天\n"
            "   - 长期接触(>24h)：40°C × 10天(替代常温6个月)\n\n"

            "2. 冷藏食品：\n"
            "   - 5°C × 10天(替代实际冷藏)\n\n"

            "3. 热灌装食品：\n"
            "   - 70°C × 2小时(模拟巴氏杀菌)\n"
            "   - 100°C × 30分钟(模拟沸水灌装)\n\n"

            "4. 冷冻食品：\n"
            "   - -20°C × 10天(替代冷冻储存)\n\n"

            "5. 微波加热：\n"
            "   - 100°C × 30分钟(模拟微波加热)\n\n"

            "6. 烘焙/烤箱：\n"
            "   - 175°C × 2小时(模拟烤箱烘焙)\n"
            "   - 230°C × 30分钟(模拟高温烘烤)\n\n"

            "五、总迁移量测试方法(GB 31604.8-2021)：\n\n"

            "1. 蒸发残渣法(最常用)：\n"
            "   - 步骤：\n"
            "     a) 样品与模拟物按规定面积体积比接触(例如6 dm²/1 L)\n"
            "     b) 在规定温度和时间下进行迁移测试\n"
            "     c) 取迁移液，蒸发至干，105°C恒重干燥\n"
            "     d) 称量残渣质量，计算迁移量(mg/dm²或mg/kg)\n"
            "   - 公式：总迁移量 = (残渣质量 / 接触面积)或(残渣质量 / 模拟物质量)\n\n"

            "2. 差重法(塑料材料)：\n"
            "   - 步骤：称量样品迁移前后质量差\n"
            "   - 适用：塑料材料整体迁移测试\n\n"

            "六、特定迁移量测试方法(GB 31604系列)：\n\n"

            "1. 单体和添加剂分析：\n"
            "   - 气相色谱-质谱联用(GC-MS)：适用于挥发性物质(苯乙烯、氯乙烯、己内酰胺)\n"
            "   - 液相色谱-质谱联用(LC-MS)：适用于非挥发性物质(双酚A、邻苯二甲酸酯)\n"
            "   - 高效液相色谱(HPLC)：甲醛、双酚A\n"
            "   - 紫外分光光度法：芳香胺(偶氮染料降解产物)\n\n"

            "2. 重金属迁移测试：\n"
            "   - ICP-MS(电感耦合等离子体质谱)：高灵敏度，检测限ppb级\n"
            "   - 原子吸收光谱(AAS)：铅、镉、铬、镍、砷\n"
            "   - GB 31604.49-2016(不锈钢)：铅≤0.01 mg/L，镉≤0.005 mg/L，铬≤0.4 mg/L，镍≤0.1 mg/L\n"
            "   - GB 4806.4-2016(搪瓷)：铅≤0.5 mg/L，镉≤0.02 mg/L\n\n"

            "七、安全评估流程：\n\n"

            "1. 危害识别：\n"
            "   - 识别材料中可能迁移的物质：单体、添加剂、助剂、降解产物、杂质\n\n"

            "2. 暴露评估：\n"
            "   - 计算每日摄入量(EDI, Estimated Daily Intake)\n"
            "   - EDI = (迁移量 × 食品消费量) / 体重\n"
            "   - 例：成人60kg，每日饮水2L，OML=10 mg/dm²(接触面积1 dm²)\n"
            "     EDI = (10 mg × 1 dm² × 2 L) / 60 kg = 0.33 mg/kg体重/天\n\n"

            "3. 风险表征：\n"
            "   - 比较EDI与TDI(Tolerable Daily Intake, 每日可耐受摄入量)\n"
            "   - TDI由毒理学数据(动物实验NOAEL)除以安全系数(100-1000)得出\n"
            "   - 例：双酚A的TDI = 0.05 mg/kg体重/天(EFSA 2015)\n"
            "   - 若EDI < TDI，则风险可接受\n\n"

            "4. 符合性声明(DoC, Declaration of Compliance)：\n"
            "   - 生产企业应提供DoC，证明材料符合GB 4806系列标准\n"
            "   - DoC内容：材料成分、迁移测试结果、符合性结论、使用条件限制\n\n"

            "八、中国与欧盟标准对比：\n\n"

            "| 项目 | 中国(GB 31604/GB 4806) | 欧盟(EU 10/2011) |\n"
            "|------|------------------------|------------------|\n"
            "| OML限量 | 10 mg/dm²或60 mg/kg | 10 mg/dm²或60 mg/kg |\n"
            "| 模拟物 | A/B/C/D1/D2/E(6种) | A/B/C/D1/D2/E(6种) |\n"
            "| 正面清单 | GB 4806.6-2016塑料清单 | EU 10/2011 Annex I清单 |\n"
            "| 双酚A限量 | 0.6 mg/kg(婴幼儿禁用) | 婴幼儿用品禁用 |\n"
            "| DEHP限量 | 1.5 mg/kg | 1.5 mg/kg |\n\n"

            "九、常见不合格项与改进措施：\n"
            "1. 总迁移量超标：\n"
            "   - 原因：材料配方中小分子添加剂过多、聚合度不足\n"
            "   - 改进：优化配方、提高聚合度、使用大分子添加剂\n\n"

            "2. 重金属超标(铅、镉)：\n"
            "   - 原因：原料污染、着色剂(颜料)含重金属\n"
            "   - 改进：更换符合食品级标准的着色剂、选用高纯度原料\n\n"

            "3. 双酚A超标：\n"
            "   - 原因：PC(聚碳酸酯)材料残留单体、高温使用导致降解\n"
            "   - 改进：婴幼儿用品禁用PC，改用PP、PPSU、Tritan\n\n"

            "4. 苯乙烯超标：\n"
            "   - 原因：PS(聚苯乙烯)材料聚合不完全、高温使用\n"
            "   - 改进：提高聚合度、避免高温接触(>80°C)\n\n"

            "法规依据：GB 31604.1-2023《食品安全国家标准 食品接触材料及制品迁移试验通则》，"
            "GB 31604.8-2021《食品安全国家标准 食品接触材料及制品 总迁移量的测定》，"
            "GB 4806系列《食品安全国家标准 食品接触材料及制品》，EU 10/2011《塑料食品接触材料法规》。"
        ),
        "category": "process",
        "source": "GB 31604系列/食品接触材料",
        "version": "2024",
        "metadata": {
            "standard_no": "GB 31604系列",
            "related_standards": "GB 4806系列, EU 10/2011",
            "target_query": "食品接触材料迁移测试方法与安全评估",
            "food_type": "contact_material",
            "priority": "P1"
        }
    },
]

VERIFICATION_QUERIES = [
    ("process", "啤酒发酵工艺参数与质量控制"),
    ("process", "碳酸饮料灌装线卫生管理与微生物控制"),
    ("regulation", "学校食堂食品安全管理与营养健康规范"),
    ("sop", "餐饮单位食品安全事故应急处置预案"),
    ("process", "食用植物油精炼工艺全流程控制规范"),
    ("process", "烘焙制品微生物控制与货架期管理"),
    ("process", "粮食仓储害虫防治与磷化铝熏蒸操作规范"),
    ("process", "食品接触材料迁移测试方法与安全评估"),
    # Additional queries to test coverage
    ("process", "啤酒上面发酵下面发酵温度区别"),
    ("process", "碳酸饮料等压灌装CO2损失控制"),
    ("regulation", "学校食堂校长陪餐制度食品留样125克48小时"),
    ("sop", "食物中毒2小时报告制度应急处置"),
    ("process", "食用油脱胶脱酸脱色脱臭温度参数"),
    ("process", "烘焙制品水分活度霉菌防控"),
    ("process", "磷化铝熏蒸粮食3克每立方米72小时"),
    ("process", "食品接触材料总迁移量特定迁移量限量"),
]


def ingest_documents(server: str, dry_run: bool = False):
    """Ingest P1 documents via /api/food-kb/ingest-batch API."""
    url = f"{server}/api/food-kb/ingest-batch"

    logger.info(f"Ingesting {len(P1_DOCUMENTS)} P1 targeted documents to {server}")

    if dry_run:
        for i, doc in enumerate(P1_DOCUMENTS, 1):
            logger.info(f"  [{i}] {doc['title']} (category={doc['category']}, "
                        f"content_len={len(doc['content'])} chars)")
        logger.info("DRY RUN — no documents ingested")
        return True

    payload = {"documents": P1_DOCUMENTS}

    try:
        with httpx.Client(timeout=120) as client:
            resp = client.post(url, json=payload)
            resp.raise_for_status()
            result = resp.json()

            if result.get("success"):
                logger.info(f"Successfully ingested {result.get('ingested', '?')} documents")
                if result.get("errors"):
                    for err in result["errors"]:
                        logger.warning(f"  Error: {err}")
                return True
            else:
                logger.error(f"Ingestion failed: {result.get('message', 'unknown error')}")
                return False
    except Exception as e:
        logger.error(f"HTTP error: {e}")
        return False


def verify_retrieval(server: str):
    """Test that the new documents are retrieved for target queries."""
    url = f"{server}/api/food-kb/query"

    logger.info(f"\nVerifying retrieval for {len(VERIFICATION_QUERIES)} test queries...")

    results = []
    with httpx.Client(timeout=30) as client:
        for category, query in VERIFICATION_QUERIES:
            try:
                resp = client.post(url, json={
                    "query": query,
                    "top_k": 3,
                    "similarity_threshold": 0.50,
                })
                resp.raise_for_status()
                data = resp.json()

                docs = data.get("data", [])
                if docs:
                    top = docs[0]
                    sim = top.get("similarity", 0)
                    title = top.get("title", "?")[:50]
                    status = "✅" if sim >= 0.80 else "⚠️"
                    logger.info(f"  {status} [{category}] \"{query[:40]}...\" → sim={sim:.4f} | {title}")
                    results.append((query, sim, title))
                else:
                    logger.warning(f"  ❌ [{category}] \"{query[:40]}...\" → no results")
                    results.append((query, 0, "NO RESULTS"))
            except Exception as e:
                logger.error(f"  ❌ [{category}] \"{query[:40]}...\" → error: {e}")
                results.append((query, 0, f"ERROR: {e}"))

    return results


def check_stats(server: str):
    """Check total document count after ingestion."""
    url = f"{server}/api/food-kb/stats"
    try:
        with httpx.Client(timeout=10) as client:
            resp = client.get(url)
            resp.raise_for_status()
            data = resp.json()
            total = data.get("data", {}).get("total_documents", data.get("total_documents", "?"))
            logger.info(f"\nKnowledge base total documents: {total}")
            return total
    except Exception as e:
        logger.error(f"Failed to get stats: {e}")
        return None


def main():
    parser = argparse.ArgumentParser(description="Ingest P1 targeted documents (8 weak categories)")
    parser.add_argument("--server", required=True, help="Python service URL")
    parser.add_argument("--dry-run", action="store_true", help="Preview without ingesting")
    parser.add_argument("--verify-only", action="store_true", help="Only run verification queries")
    args = parser.parse_args()

    server = args.server.rstrip("/")

    if args.verify_only:
        check_stats(server)
        verify_retrieval(server)
        return

    # Step 1: Check current stats
    check_stats(server)

    # Step 2: Ingest
    success = ingest_documents(server, dry_run=args.dry_run)
    if not success:
        sys.exit(1)

    if args.dry_run:
        return

    # Step 3: Verify
    import time
    logger.info("Waiting 3s for embedding indexing...")
    time.sleep(3)

    check_stats(server)
    verify_retrieval(server)


if __name__ == "__main__":
    main()
