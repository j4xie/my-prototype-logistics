# 意图路由系统6个失败Case深度分析：架构 vs 配置

**日期**: 2026-02-17
**模式**: Full (5 agents)
**语言**: Chinese

---

## Executive Summary

6个失败案例中，纯架构问题占2/6（优先级倒置、无意图组合），配置主导问题占2/6（短语/实体覆盖不足），混合问题占2/6。关键发现是2个系统级缺陷（优先级倒置+假意图码）造成50%严重失败。批评家质疑将Case3/5归为"混合"，应重新分类为"配置主导（70%配置/30%架构）"。立即修复T1配置项（3.5小时）可解决3个案例；T2架构修复（3天）可解决另外2个核心案例；T3长期方案（2-4周）处理复杂查询。**最高优先级是修复优先级倒置和假意图码bug，其次是完善否定模式和NER**。

---

## 失败案例分类矩阵（修正后）

| Case | 查询 | 根因分类 | 主要缺陷 | 修复层级 |
|------|------|----------|---------|---------|
| 1 | "库房里还剩多少猪肉" → FOOD_KNOWLEDGE | **纯架构** | 优先级倒置(A) + 假意图码(B) | T2 |
| 2 | "逾期未完成的订单" → ORDER_UPDATE | **混合** (60配/40架) | 否定模式缺失 | T1 |
| 3 | "大肠杆菌超标的原因和预防措施" → NEED_CLARIFICATION | **配置主导** (70配/30架) | 食品实体覆盖不足 | T1 |
| 4 | "上周生产了多少批次的牛肉产品" → NEED_CLARIFICATION | **纯架构** (85%) | 无意图组合 + 优先级倒置 | T3 |
| 5 | "销量前五的产品是哪些" → NEED_CLARIFICATION | **配置主导** (70配/30架) | 销售领域短语缺失 | T1 |
| 6 | "张三这个月请了几天假" → NEED_CLARIFICATION | **混合** (55架/45配) | 命名实体识别缺失 | T2 |

**净评估**：
- 纯架构：2/6 (Case 1, 4)
- 配置主导：2/6 (Case 3, 5)
- 混合：2/6 (Case 2, 6)
- 纯配置：0/6

---

## 4大架构缺陷

### 缺陷A — 优先级倒置
- 食品实体拦截层在意图分类**之前**运行
- 任何包含食品词（猪肉、牛肉、酸奶）的查询被强制路由到 FOOD_KNOWLEDGE
- 直接导致 Case 1，间接影响 Case 4

### 缺陷B — 假意图码
- `hasEntityIntentConflict()` 使用硬编码 "PROCESSING_GENERIC" 作为占位符
- 冲突检测函数收不到真实匹配意图，退化为布尔型 "是否包含食品词" 检查
- 放大 Case 1 的误路由

### 缺陷C — 早期拦截
- 食品知识检查在 ONNX/TwoStage 分类之前
- ML 置信度信号在决策时不可用
- 影响 Case 3

### 缺陷D — 规则膨胀
- IntentKnowledgeBase.java 5860行，O(n²) 跨域冲突
- 每新增食品实体 × 每个工厂意图 = 潜在误判
- 不可持续的增长模式

---

## 修复决策框架

### T1-立即执行（3.5小时）

| 修复项 | 影响案例 | 工作量 | 预期效果 |
|--------|---------|--------|---------|
| 添加"大肠杆菌"等食品实体到 FOOD_ENTITY_WORDS | Case 3 | 15min | 100% |
| 添加"销量"/"前五"等销售短语 | Case 5 | 1h | 100% |
| detectQuestionType() 添加否定模式 | Case 2 | 2h | >90% |

### T2-短期执行（3天）

| 修复项 | 影响案例 | 工作量 | 预期效果 |
|--------|---------|--------|---------|
| 修复 hasEntityIntentConflict() 假意图码 | Case 1 | 4h | 50% |
| 实施"并行仲裁"（非简单移动拦截顺序） | Case 1, 4 | 1day | Case1: 90%, Case4: 30% |
| 添加人名 NER 识别 | Case 6 | 1day | 100% |

### T3-条件执行（2-4周）

| 修复项 | 条件 | 影响案例 | 工作量 |
|--------|------|---------|--------|
| 意图组合/槽位填充 | Case4 仍>30%失败 | Case 4 | 2-4周 |
| LLM消歧层+仲裁 | 消歧成功率<85% | Case 1, 4 | 1周 |

---

## 关键争议与修正

### 争议1: "纯配置 0/6" 结论过于绝对
- **Analyst**: Case 3/5 是混合问题
- **Critic 反驳**: Case 3/5 的直接原因是短语/实体缺失，添加即修复
- **最终判定**: 修正为"配置主导 2/6"

### 争议2: T2"移动食品拦截到分类之后"的风险
- **Analyst**: 风险中等，可行
- **Critic 反驳**: 食品安全查询可能被 ONNX 误分类为设备/工厂意图
- **最终判定**: 风险升级为"高"，采用"并行仲裁"架构而非简单移动

### 争议3: LLM消歧的可靠性
- 短查询(<10字) LLM意图判断准确率低于长查询
- 6个失败案例多数是短查询（6-12字）
- **建议**: 结构化启发式 + LLM，而非纯 LLM

---

## 置信度评估

| 结论 | 置信度 | 理由 |
|------|--------|------|
| Case1是优先级倒置bug | ★★★★★ | 3方一致，代码证据清晰 |
| Case2是否定模式缺失 | ★★★★☆ | 共识，需验证泛化 |
| Case3/5是配置主导问题 | ★★★★☆ | Critic有效质疑后修正 |
| T2移动拦截顺序风险高 | ★★★☆☆ | 理论推理，非实际案例 |
| T1修复有效性>95% | ★★★★☆ | 配置修复通常可靠 |
| LLM消歧准确率85-92% | ★★★☆☆ | 需实测验证 |

---

## Open Questions

1. Case4"多条件组合"查询占比多少？（需生产日志统计）
2. LLM消歧在食品vs工厂边界的实际表现？（需100条标注评测）
3. 并行仲裁的冷启动数据来源？
4. 否定模式在Drools规则中的泛化？
5. 人名NER在工业数据中的误检率？
6. 实时埋点基础设施是否已有？

---

## Decision-Maker Summary

- **2小时**: 执行T1全部 → Case 2/3/5修复 → 准确率 90%→93%
- **3-4天**: 加做T2.1+T2.2 → Case 1/6修复 → F1 93%→95%
- **4周**: T1+T2+T3 → 全部案例 → F1 95%+

**核心建议**: 不要简单"移动拦截顺序"。采用"并行食品检测 + ONNX分类 + LLM仲裁"三层架构，既保护食品安全查询不漏过，又给予数据查询正确路由的机会。

---

### Process Note

- Mode: Full
- Researchers deployed: 3 (code-level, architecture, best practices)
- Total sources: code analysis + architecture patterns + NLU industry benchmarks
- Key disagreements: 3 resolved (config classification, T2 risk, LLM reliability), 1 unresolved (Case4 slot filling necessity)
- Phases completed: Research → Analysis → Critique → Integration
