# 意图路由架构改进方案 — Agent Team 分析报告

**日期**: 2026-02-18
**测试基线**: 142 cases, 90% intent accuracy, 94% type accuracy
**核心案例**: 102 cases = 100% type accuracy (已解决)
**困难案例**: 40 cases = 68% type accuracy (本报告关注)

---

## 执行摘要

142条E2E测试暴露了5个架构弱点，但核心问题可归纳为**2个架构缺陷 + 1个配置缺口**：

| 类别 | 根因 | 失败数 | 修复难度 |
|------|------|--------|---------|
| 写入动词被忽略 (C3) | 短语匹配只看名词，不看动词 | 4 | 中 — 需新检测层 |
| 食品实体过度优先 (D4) | hasEntityIntentConflict无数据信号感知 | 2 | 中 — 需信号权重 |
| 极短输入失败 (D3) | matchPhrase阈值过严 | 2 | 低 — 改阈值即可 |
| 跨域/长句/未知意图 (B8,D6) | 意图代码覆盖不全 | 3 | 低 — 加phrase mapping |
| 生命周期intent分类 (D5) | 测试集WRITE_INTENTS不全 | 3 | 已修复(测试侧) |

**推荐**: 实施3个改动 (A+B+D)，预计投入 ~2小时，将94%提升至97%+。

---

## 改进方案对比矩阵

| # | 方案 | 目标弱点 | 代码量 | 文件 | 时间 | 预期收益 | 风险 | ROI |
|---|------|---------|--------|------|------|---------|------|-----|
| **A** | 写动词前置检测层 | C3 (4失败) | +60行 | 2 | 1h | +2.8% (4/142) | 中 | ⭐⭐⭐⭐ |
| **B** | 短输入阈值放宽 | D3 (2失败) | +5行 | 1 | 15min | +1.4% (2/142) | 极低 | ⭐⭐⭐⭐⭐ |
| **D** | 数据上下文信号消歧 | D4 (2失败) | +20行 | 1 | 30min | +1.4% (2/142) | 中 | ⭐⭐⭐ |
| **E** | 领域分组计数 | 多域误判 | — | — | — | — | — | **已实现** |
| **F** | 统一冲突仲裁管道 | 代码重复 | +50行净 | 1 | 6h | 维护性↑ | 高 | ⭐⭐ |
| **G** | Phrase外部化YAML | 代码膨胀 | -300行 | 2+ | 8h | 灵活性↑ | 中 | ⭐⭐ |
| **H** | 食品知识独立RAG | D4根治 | +400行 | 4 | 2周 | 99%+ | 高 | ⭐ |

---

## 方案详细设计

### 方案A: 写动词前置检测层 (推荐立即实施)

**问题**: "建一个新批次"、"下一个采购单"、"更新订单发货地址"被短语匹配的名词部分("批次"→LIST, "采购单"→ORDER_LIST, "发货"→SHIPMENT_QUERY)抢先捕获，写入动词被忽略。

**方案**: 在短语匹配之前，扫描写入动词并结合后续名词推断写入意图。

```
设计:
  1. 定义写入动词集: {创建,新建,添加,录入,修改,更新,删除,取消,暂停,恢复,开始,建,下}
  2. 定义排除词集: {建议,建立概念,下面,下一步} (防止误触发)
  3. 如果检测到写入动词 + 业务名词(批次/订单/库存/发货)，
     则直接构建对应的写入intent，跳过通用短语匹配
  4. 如果写入动词后无明确业务名词，则不干预，继续原流程
```

**改动位置**:
- `AIIntentServiceImpl.java` — 在 `matchPhrase()` 调用之前插入写入动词检测
- `IntentKnowledgeBase.java` — 新增 `detectWriteAction(String input)` 方法

**预期效果**: 修复C3的4个失败 + D2的部分case，+2.8%准确率

**风险分析**:
- 误触发风险: "建议改进生产流程" 中的 "建" 可能被误判 → 通过排除词表解决
- 与现有phrase mapping冲突: 不会，因为写入检测优先级更高且更精确(动词+名词组合)

---

### 方案B: 短输入阈值放宽 (推荐立即实施)

**问题**: "订单"(2字)、"打卡"(2字)无法匹配，因为`matchPhrase()`要求 `phraseLength >= 4 OR coverageRatio >= 0.4`，2字phrase的覆盖率在2字输入中是100%但phrase本身太短。

**当前代码** (IntentKnowledgeBase.java ~line 5170):
```java
boolean isShortInput = (inputLength <= 6 && phraseLength >= 2);
if (isExactMatch || isLongPhrase || coverageRatio >= 0.4 || isShortInput) {
```

**问题**: v21.0已添加了 `isShortInput` 条件，但"订单"和"打卡"仍然失败。原因可能是：
1. 这些2字短语不在 `phraseToIntentMapping` 中
2. 或者被预处理器改变了

**方案**: 添加精确的2字短语映射:
```java
phraseToIntentMapping.put("订单", "ORDER_LIST");
phraseToIntentMapping.put("打卡", "CLOCK_IN");
```

**风险**: 极低 — "订单"在长输入中不会被匹配因为有更长的短语(如"查看订单")会胜出

---

### 方案D: 数据上下文信号消歧 (推荐立即实施)

**问题**: "猪肉冷库温度异常"和"添加剂检测结果"被食品实体("猪肉"、"添加剂")劫持到FOOD_KNOWLEDGE_QUERY，但"异常"和"检测结果"明确表示这是数据查询。

**方案**: 在食品实体冲突检测中，增加"数据上下文信号"反向检查:
```
数据信号词: {异常,故障,报警,告警,偏高,偏低,超限,检测结果,检测数据,检测报告,不合格,合格率}

逻辑: 如果输入同时包含食品实体AND数据信号词，
      则不跳转FOOD_KNOWLEDGE_QUERY，保留原路由结果
```

**改动位置**: `IntentKnowledgeBase.java` — 修改 `hasEntityIntentConflict()` 或新增 `containsDataContextSignal()` 方法

**风险**: 中 — "猪肉添加剂有哪些"不包含数据信号词，不受影响。但"食品检测报告"(食品知识)可能被误判 → 需要区分"食品安全的检测方法"(知识) vs "本厂的检测报告"(数据)

---

## 批判性审查

### 挑战1: 持续添加短语映射是否可持续?

**现状**: IntentKnowledgeBase.java 已有5900行，其中phraseToIntentMapping约500条。每次新测试失败都通过添加新短语修复。

**反驳**:
- 短期可行 — 500条映射在HashMap中查找是O(1)，性能无影响
- 长期问题 — 文件膨胀、合并冲突、新开发者认知负担
- **建议**: 当映射超过800条时迁移到外部YAML (方案G)，但**现在不是时候**

### 挑战2: 写动词检测层是否过度工程化?

**反面观点**: 可以继续用短语映射解决 — 直接添加"建一个新批次"→PROCESSING_BATCH_CREATE等

**分析**:
- 短语映射方式需要为每个动词+名词组合添加条目: 建+批次, 建+订单, 建+入库... = N*M条
- 写入检测层只需维护动词集(~12个)和名词→意图映射(~8个) = N+M条
- **结论**: 当N*M > N+M时(即N>1且M>1)，检测层更优。当前N=12, M=8, N*M=96 >> N+M=20

### 挑战3: 方案D是否只是在打补丁?

**反面观点**: "猪肉冷库温度异常"的根本问题是食品实体检测太靠前(Layer 0)，应该让ONNX分类器(Layer 1)处理

**分析**:
- ONNX分类器对"猪肉冷库温度异常"的分类结果未知 — 可能也分错(因为训练数据中这类边界case少)
- 方案D是一个轻量级的safety net，即使分类器分错也能纠正
- **长期**: 应该在ONNX训练数据中添加此类边界case，但短期方案D足够

### 挑战4: 94%是否已经足够好?

**反面观点**: 核心案例100%，困难案例中的"建一个新批次"、"下一个采购单"在真实场景中极少出现

**分析**:
- 对于工厂用户，口语化输入("建个批次"、"下单")其实很常见
- 但"猪肉冷库温度异常"可能确实罕见 — 用户更可能说"冷库温度报警了"
- **建议**: 方案A(写动词)投入产出比高，应该做; 方案D(食品消歧)可以做但优先级稍低

---

## 最终建议

### 立即实施 (本周, ~2小时)

| 优先级 | 方案 | 时间 | 预期效果 |
|--------|------|------|---------|
| 1 | B: 添加"订单"→ORDER_LIST, "打卡"→CLOCK_IN映射 | 15min | +1.4% |
| 2 | A: 写动词前置检测层 | 1h | +2.8% |
| 3 | D: 数据上下文信号消歧 | 30min | +1.4% |
| — | 回归测试142 cases | 15min | 验证无回归 |

**预计总效果**: 94% → 97%+ type accuracy, 90% → 95%+ intent accuracy

### 延后 (不建议本周做)

| 方案 | 原因 |
|------|------|
| F: 统一冲突仲裁 | 高回归风险，需要更完善的测试套件先行 |
| G: Phrase外部化 | 当前500条映射还不够多，性价比不高 |
| H: 食品独立RAG | 投入过大，当前方案D足以覆盖 |

### 架构健康度评估

| 维度 | 当前状态 | 建议 |
|------|---------|------|
| 准确率 | 94% (核心100%) | 97%+ 通过A+B+D |
| 代码复杂度 | 高 (5900+5400行) | 可接受，暂不重构 |
| 可维护性 | 中 (4处重复冲突检测) | 需要但不紧急 |
| 扩展性 | 低 (每个新意图需手动映射) | 长期需要YAML外部化 |
| 性能 | 好 (<50ms phrase match) | 无需优化 |

---

### Process Note
- Mode: Full
- Researchers deployed: 3 (1 timed out, 2 returned comprehensive findings)
- Total findings: 16 (8 NLU best practices + 8 improvement designs)
- Key disagreements: 1 resolved (phrase mapping vs detection layer → detection layer wins for N*M > N+M)
- Phases completed: Research → Analysis → Critique → Integration (synthesized by Manager)
