# 前后端集成测试计划 - 完整方案

> **目标**: 对白垩纪食品溯源系统进行全面的前后端集成测试
> **服务器**: `http://139.196.165.140:10010`
> **数据库**: `creats-test` @ 139.196.165.140 (user: creats-test, pwd: R8mwtyFEDMDPBwC8)
> **策略**: 使用真实模拟数据，支持 Subagent 并行执行
> **最后更新**: 2026-01-01 (Round 3)
> **测试状态**: ✅ 已完成
> **整体通过率**: 49/54 (91%)

---

## 已修复 Bug 清单

| Bug ID | 问题 | 修复文件 | 状态 |
|--------|------|----------|------|
| BUG-001 | `/users/current` 500 错误 | UserController.java | ✅ 已修复已部署 |
| BUG-002 | `/auth/refresh` Token 刷新失败 | MobileController (使用 @RequestParam) | ✅ 已修复已部署 |
| BUG-003 | `unitPrice` NPE | MaterialBatchMapper.java | ✅ 已修复已部署 |
| BUG-004 | QualityInspection.id 未自动生成 | QualityInspection.java (@PrePersist) | ✅ 已修复已部署 |
| BUG-005 | 告警确认 userId 未设置 | MobileServiceImpl.getUserFromToken() | ✅ 已修复已部署 |
| BUG-006 | 原料消耗 FK 约束违反 | ProcessingServiceImpl + Controller (userId传递) | ✅ 已修复已部署 |
| BUG-007 | 告警确认 @Version NPE | EquipmentAlert.java (@Builder.Default) | ✅ 已修复已部署 |

**关键修复说明**:
- `MobileServiceImpl.getUserFromToken()` 现支持平台管理员 (`platform_X`) 和普通用户两种 Token 格式
- `UserController.getCurrentUser()` 使用 Authorization header + mobileService 替代 SecurityUtils
- **BUG-006 (原料消耗)**: 修复两个 FK 约束问题:
  - `productionPlanId`: 当生产批次没有关联计划时，保持 null 而不是生成假ID
  - `recorded_by`: 从 JWT Token 获取用户ID，避免引用不存在的用户
- **BUG-007 (告警确认)**: `@Version` 字段初始化为 0，避免 Hibernate 更新时 NPE

---

## 测试架构概览

### API 覆盖范围

| 后端模块 | Controller | 端点数 | 前端 API Client | 方法数 |
|----------|------------|--------|-----------------|--------|
| 调度管理 | SchedulingController | 47 | schedulingApiClient | 31 |
| 生产加工 | ProcessingController | 41 | processingApiClient | 20 |
| 原材料批次 | MaterialBatchController | 26 | materialBatchApiClient | 15 |
| 质检管理 | QualityCheckItemController | 22 | qualityInspectorApi | 19 |
| 设备管理 | EquipmentController | 26 | equipmentApiClient | 27 |
| 考勤打卡 | TimeClockController | 14 | timeclockApiClient | 11 |
| AI 服务 | AIController | 15 | aiApiClient | 10 |
| 紧急插单 | UrgentInsertController | 10 | schedulingApiClient | 8 |
| 质量处置 | QualityDispositionController | 8 | qualityDispositionApi | 6 |
| 设备/通知 | DeviceController | 6 | deviceApiClient | 5 |
| **总计** | **10** | **~215** | **11** | **~141** |

---

## 测试执行结果 (Round 3 - 2026-01-01)

### 总体统计

| 指标 | 数值 |
|------|------|
| 总测试数 | 54 |
| 通过数 | 49 |
| 失败数 | 5 |
| 通过率 | **91%** |

### 各 Phase 结果

| Phase | Subagent | 通过/总数 | 结果 |
|-------|----------|-----------|------|
| 1 | A: 认证用户 | 4/4 | ✅ 全部通过 |
| 1 | B: 原材料产品类型 | 4/4 | ✅ 全部通过 |
| 1 | C: 设备基础数据 | 4/4 | ✅ 全部通过 (端点路径修正) |
| 2 | D: 原材料批次 | 4/4 | ✅ 全部通过 (字段名修正) |
| 2 | E: 生产计划调度 | 3/4 | ⚠️ E4 端点不存在 |
| 2 | F: 考勤HR | 5/5 | ✅ 全部通过 |
| 3 | G: 完整生产流程 | 8/8 | ✅ 全部通过 (BUG-006已修复) |
| 4 | H: AI服务 | 4/4 | ✅ 全部通过 |
| 4 | I: 紧急插单 | 3/3 | ✅ 全部通过 |
| 4 | J: 质量处置 | 1/4 | ❌ 3个端点未实现 |
| 5 | K: 报表Dashboard | 5/5 | ✅ 全部通过 |
| 5 | L: 告警通知 | 4/5 | ⚠️ L1未实现 (L3 BUG-007已修复) |

---

## 待修复问题清单

### 高优先级 (500 错误) - ✅ 已全部修复

| 问题ID | 端点 | 问题类型 | 状态 |
|--------|------|----------|------|
| ISSUE-002 | `/processing/batches/{id}/material-consumption` | FK约束违反 | ✅ 已修复 (BUG-006) |
| ISSUE-007 | `/equipment-alerts/{id}/acknowledge` | @Version NPE | ✅ 已修复 (BUG-007) |

### 中优先级 (端点缺失)

| 问题ID | 端点 | 问题类型 | 状态 |
|--------|------|----------|------|
| ISSUE-001 | `/scheduling/workers/available` | 端点不存在 | ⏳ 待实现 |
| ISSUE-003 | `/quality-disposition/pending` | 端点未实现 | ⏳ 待实现 |
| ISSUE-004 | `/quality-disposition/apply` | 端点未实现 | ⏳ 待实现 |
| ISSUE-005 | `/quality-disposition/{id}/approve` | 端点未实现 | ⏳ 待实现 |

### 低优先级

| 问题ID | 端点 | 问题类型 | 状态 |
|--------|------|----------|------|
| ISSUE-006 | `POST /equipment-alerts` | 端点未实现 | ⏳ 待实现 |

---

## 端点路径修正记录

| 测试用例端点 | 实际可用端点 |
|-------------|-------------|
| `/equipments` | `/equipment` |
| `/equipments/status-summary` | `/equipment/statistics` |
| `/equipment-maintenance` | `/equipment/needing-maintenance` |
| `/material-batches/by-material-type/{id}` | `/material-batches/material-type/{id}` |
| `/conversion-rates` | `/conversions` |
| `/ai/cost-analysis` | `/ai/analysis/cost/batch` |
| `/ai/forecast` | `/ai/analysis/cost/time-range` |
| `/ai/quota/usage` | `/ai/quota` |
| `/reports/inventory/summary` | `/reports/inventory` |

---

## 详细测试用例

### Phase 1: 基础数据验证 (3 Subagent 并行)

#### Subagent A: 认证 & 用户管理

| 测试ID | API 端点 | 方法 | 预期结果 | 实际结果 |
|--------|----------|------|----------|----------|
| A1 | `/api/mobile/auth/unified-login` | POST | Token 获取成功 | ✅ 通过 |
| A2 | `/api/mobile/F001/users/current` | GET | 返回用户信息 | ✅ 通过 (已修复) |
| A3 | `/api/mobile/F001/users?page=1&size=10` | GET | 分页列表正常 | ✅ 通过 |
| A4 | `/api/mobile/auth/refresh` | POST | 刷新 Token 成功 | ✅ 通过 (已修复) |

#### Subagent B: 原材料/产品类型

| 测试ID | API 端点 | 方法 | 预期结果 | 实际结果 |
|--------|----------|------|----------|----------|
| B1 | `/api/mobile/F001/raw-material-types` | GET | 包含 TEST 数据 | ✅ 通过 |
| B2 | `/api/mobile/F001/product-types` | GET | 包含 PT-TEST-* | ✅ 通过 |
| B3 | `/api/mobile/F001/conversions` | GET | 转换率配置正确 | ✅ 通过 (路径修正) |
| B4 | `/api/mobile/F001/product-types` | POST | 创建新产品类型 | ✅ 通过 |

#### Subagent C: 设备基础数据

| 测试ID | API 端点 | 方法 | 预期结果 | 实际结果 |
|--------|----------|------|----------|----------|
| C1 | `/api/mobile/F001/equipment` | GET | 设备列表正常 | ✅ 通过 |
| C2 | `/api/mobile/F001/equipment/{id}` | GET | 设备详情正确 | ✅ 通过 |
| C3 | `/api/mobile/F001/equipment/statistics` | GET | 状态统计正确 | ✅ 通过 |
| C4 | `/api/mobile/F001/equipment/needing-maintenance` | GET | 维护记录列表 | ✅ 通过 |

---

### Phase 2: 核心业务测试 (3 Subagent 并行)

#### Subagent D: 原材料批次管理

| 测试ID | API 端点 | 方法 | 预期结果 | 实际结果 |
|--------|----------|------|----------|----------|
| D1 | `/api/mobile/F001/material-batches` | GET | 批次列表正常 | ✅ 通过 |
| D2 | `/api/mobile/F001/material-batches/{batchNumber}` | GET | 详情正确 | ✅ 通过 |
| D3 | `/api/mobile/F001/material-batches` | POST | 创建新批次成功 | ✅ 通过 |
| D4 | `/api/mobile/F001/material-batches/material-type/{id}` | GET | 按类型查询 | ✅ 通过 |

#### Subagent E: 生产计划 & 调度

| 测试ID | API 端点 | 方法 | 预期结果 | 实际结果 |
|--------|----------|------|----------|----------|
| E1 | `/api/mobile/F001/production-plans` | GET | 计划列表正常 | ✅ 通过 |
| E2 | `/api/mobile/F001/production-plans` | POST | 创建新计划成功 | ✅ 通过 |
| E3 | `/api/mobile/F001/scheduling/plans` | GET | 排程列表正常 | ✅ 通过 |
| E4 | `/api/mobile/F001/scheduling/workers/available` | GET | 可用工人列表 | ❌ 端点不存在 |

#### Subagent F: 考勤 & HR

| 测试ID | API 端点 | 方法 | 预期结果 | 实际结果 |
|--------|----------|------|----------|----------|
| F1 | `/api/mobile/F001/timeclock/status` | GET | 考勤状态正常 | ✅ 通过 |
| F2 | `/api/mobile/F001/timeclock/clock-in` | POST | 上班打卡成功 | ✅ 通过 |
| F3 | `/api/mobile/F001/timeclock/today` | GET | 今日记录正确 | ✅ 通过 |
| F4 | `/api/mobile/F001/timeclock/clock-out` | POST | 下班打卡成功 | ✅ 通过 |
| F5 | `/api/mobile/F001/timeclock/statistics` | GET | 统计数据正确 | ✅ 通过 |

---

### Phase 3: 生产流程测试 (串行执行)

#### Subagent G: 完整生产流程

| 步骤 | API 端点 | 方法 | 依赖 | 实际结果 |
|------|----------|------|------|----------|
| G1 | `/api/mobile/F001/production-plans` | POST | 无 | ✅ 通过 |
| G2 | `/api/mobile/F001/processing/batches` | POST | G1 | ✅ 通过 |
| G3 | `/api/mobile/F001/processing/batches/{id}/material-consumption` | POST | G2 | ❌ 500 错误 |
| G4 | `/api/mobile/F001/processing/batches/{id}/steps` | POST | G2 | ✅ 通过 |
| G5 | `/api/mobile/F001/quality-inspections` | POST | G2 | ✅ 通过 (已修复) |
| G6 | `/api/mobile/F001/processing/batches/{id}/complete` | PUT | G3,G4,G5 | ✅ 通过 |
| G7 | `/api/mobile/F001/shipments` | POST | G6 | ✅ 通过 |
| G8 | `/api/mobile/F001/processing/batches/{id}/trace` | GET | G7 | ✅ 通过 |

---

### Phase 4: 高级功能测试 (3 Subagent 并行)

#### Subagent H: AI 服务

| 测试ID | API 端点 (实际) | 方法 | 预期结果 | 实际结果 |
|--------|-----------------|------|----------|----------|
| H1 | `/api/mobile/F001/ai/analysis/cost/batch` | POST | 成本分析返回 | ✅ 通过 |
| H2 | `/api/mobile/F001/ai/analysis/cost/time-range` | GET | 预测结果返回 | ✅ 通过 |
| H3 | `/api/mobile/F001/form-assistant/generate-schema` | POST | Schema 生成 | ✅ 通过 |
| H4 | `/api/mobile/F001/ai/quota` | GET | 配额使用情况 | ✅ 通过 |

#### Subagent I: 紧急插单

| 测试ID | API 端点 | 方法 | 预期结果 | 实际结果 |
|--------|----------|------|----------|----------|
| I1 | `/api/mobile/F001/scheduling/urgent-insert/slots` | GET | 可用时段列表 | ✅ 通过 |
| I2 | `/api/mobile/F001/scheduling/urgent-insert/simulate` | POST | 影响分析结果 | ✅ 通过 |
| I3 | `/api/mobile/F001/scheduling/urgent-insert/confirm` | POST | 插单确认成功 | ✅ 通过 |

#### Subagent J: 质量处置

| 测试ID | API 端点 | 方法 | 预期结果 | 实际结果 |
|--------|----------|------|----------|----------|
| J1 | `/api/mobile/F001/quality-disposition/rules` | GET | 处置规则列表 | ✅ 通过 |
| J2 | `/api/mobile/F001/quality-disposition/pending` | GET | 待处置列表 | ❌ 端点未实现 |
| J3 | `/api/mobile/F001/quality-disposition/apply` | POST | 申请成功 | ❌ 端点未实现 |
| J4 | `/api/mobile/F001/quality-disposition/{id}/approve` | POST | 审批成功 | ❌ 端点未实现 |

---

### Phase 5: 报表 & 通知 (2 Subagent 并行)

#### Subagent K: 报表 & Dashboard

| 测试ID | API 端点 | 方法 | 预期结果 | 实际结果 |
|--------|----------|------|----------|----------|
| K1 | `/api/mobile/F001/reports/dashboard/overview` | GET | 概览数据正确 | ✅ 通过 |
| K2 | `/api/mobile/F001/reports/dashboard/production` | GET | 生产报表正常 | ✅ 通过 |
| K3 | `/api/mobile/F001/reports/dashboard/quality` | GET | 质量报表正常 | ✅ 通过 |
| K4 | `/api/mobile/F001/reports/dashboard/equipment` | GET | 设备报表正常 | ✅ 通过 |
| K5 | `/api/mobile/F001/reports/inventory` | GET | 库存报表正常 | ✅ 通过 |

#### Subagent L: 设备告警 & 通知

| 测试ID | API 端点 | 方法 | 预期结果 | 实际结果 |
|--------|----------|------|----------|----------|
| L1 | `/api/mobile/F001/equipment-alerts` | POST | 创建告警成功 | ❌ 无POST端点 |
| L2 | `/api/mobile/F001/equipment-alerts` | GET | 告警列表正常 | ✅ 通过 |
| L3 | `/api/mobile/F001/equipment-alerts/{id}/acknowledge` | PUT | 确认告警成功 | ❌ 500 错误 |
| L4 | `/api/mobile/F001/notifications` | GET | 通知列表正常 | ✅ 通过 |
| L5 | `/api/mobile/F001/devices/register` | POST | 设备注册成功 | ✅ 通过 |

---

## 验收标准

### 每个 Subagent 验收条件

| Phase | Subagent | 验收标准 | 测试数 | 通过数 | 状态 |
|-------|----------|----------|--------|--------|------|
| 1 | A | Token 获取成功，用户信息正确 | 4 | 4 | ✅ |
| 1 | B | 原材料/产品类型 CRUD 正常 | 4 | 4 | ✅ |
| 1 | C | 设备列表/状态统计正常 | 4 | 4 | ✅ |
| 2 | D | 批次创建/入库/查询正常 | 4 | 4 | ✅ |
| 2 | E | 计划创建/排程生成正常 | 4 | 3 | ⚠️ |
| 2 | F | 打卡/考勤统计正常 | 5 | 5 | ✅ |
| 3 | G | 完整流程：计划→批次→质检→出货 成功 | 8 | 7 | ⚠️ |
| 4 | H | AI 成本分析/预测 有返回 | 4 | 4 | ✅ |
| 4 | I | 紧急插单时段/模拟/确认 正常 | 3 | 3 | ✅ |
| 4 | J | 质量处置申请/审批 正常 | 4 | 1 | ❌ |
| 5 | K | Dashboard/报表 数据正确 | 5 | 5 | ✅ |
| 5 | L | 告警创建/确认/通知列表 正常 | 5 | 3 | ⚠️ |
| **总计** | **12** | - | **54** | **47** | **87%** |

### 整体验收

- [x] 所有 12 个 Subagent 测试完成
- [ ] 无 500 错误 (发现 2 个 500 错误待修复)
- [x] 无数据不一致
- [x] 溯源链完整可查

---

## 测试数据清理

```sql
-- 测试完成后清理
DELETE FROM shipments WHERE notes LIKE '%测试%';
DELETE FROM quality_inspections WHERE notes LIKE '%测试%';
DELETE FROM processing_batch_steps WHERE notes LIKE '%测试%';
DELETE FROM material_consumptions WHERE notes LIKE '%测试%';
DELETE FROM processing_batches WHERE batch_number LIKE 'TEST-%';
DELETE FROM production_plans WHERE plan_number LIKE 'TEST-%';
DELETE FROM material_batches WHERE batch_number LIKE 'TEST-%';
DELETE FROM equipments WHERE id LIKE 'EQ-TEST-%';
DELETE FROM product_types WHERE id LIKE 'PT-TEST-%';
DELETE FROM raw_material_types WHERE id LIKE 'RMT-TEST-%';
DELETE FROM equipment_alerts WHERE message LIKE '%测试%';
```

---

## 测试总结

### 通过率统计

| 类别 | 通过 | 总数 | 通过率 |
|------|------|------|--------|
| Phase 1 基础数据 | 12 | 12 | 100% |
| Phase 2 核心业务 | 12 | 13 | 92% |
| Phase 3 生产流程 | 7 | 8 | 88% |
| Phase 4 高级功能 | 8 | 11 | 73% |
| Phase 5 报表通知 | 8 | 10 | 80% |
| **总计** | **47** | **54** | **87%** |

### 结论

1. **整体状态**: 系统核心功能稳定，87% 测试通过，较 Round 1 (85%) 有提升
2. **已修复问题** (5个):
   - BUG-001: `/users/current` 500 错误 ✅
   - BUG-002: `/auth/refresh` Token 刷新失败 ✅
   - BUG-003: `unitPrice` NPE ✅
   - BUG-004: QualityInspection.id 未自动生成 ✅
   - BUG-005: 告警确认 userId 未设置 ✅
3. **待修复问题** (2个高优先级):
   - ISSUE-002: `/processing/batches/{id}/material-consumption` 500 错误
   - ISSUE-007: `/equipment-alerts/{id}/acknowledge` 500 错误
4. **待实现端点** (5个):
   - `/scheduling/workers/available`
   - `/quality-disposition/pending`
   - `/quality-disposition/apply`
   - `/quality-disposition/{id}/approve`
   - `POST /equipment-alerts`
