# 意图关键词丰富与自动学习计划

## 用户需求
1. **丰富关键词列表** - 扩展现有18个意图的关键词覆盖
2. **自动学习机制** - LLM Fallback 成功后，基于置信度阈值自动添加新关键词
3. **前端管理界面** - 平台管理员/工厂超管可在APP内管理意图配置

---

## 任务进度汇总

| 任务 | 状态 | 完成日期 |
|------|------|----------|
| 任务0: 创建意图配置API客户端 | ✅ 已完成 | 2026-01-02 |
| 任务0: 创建意图配置管理界面 | ✅ 已完成 | 2026-01-02 |
| 任务1: 丰富关键词列表 (SQL) | ✅ 已完成 | 2026-01-02 |
| 任务2: 自动学习逻辑 (后端) | ✅ 已完成 | 2026-01-02 |
| 任务3: 新词提取算法 | ✅ 已完成 | 2026-01-02 (含在任务2中) |
| **部署验证: 服务器部署与测试** | ✅ 已完成 | 2026-01-02 |
| 任务4: 关键词效果追踪与自动清理 | ✅ 已完成 | 2026-01-03 |
| 任务5: 关键词晋升机制（工厂→全局） | ✅ 已完成 | 2026-01-03 |
| 任务6: 工厂级动态配置改造 | ✅ 已完成 | 2026-01-03 |

---

## 架构决策：混合模式 ✅ 用户已确认

- **平台级别 (scope = 'GLOBAL')**：基础关键词，所有工厂继承，平台管理员维护，factory_id = NULL
- **工厂级别 (scope = 'FACTORY')**：继承平台配置 + 工厂特有关键词，工厂超管可添加/覆盖，自动学习的新词存入工厂级别

---

## 架构决策：工厂学习阶段 ✅ 新增

新工厂不应直接使用 LLM Fallback，需要先经过**学习期**降低错误成本：

**阶段1：学习期 (LEARNING)**
- LLM 作为"顾问"，只识别不执行
- 用户看到候选意图列表 + "您想要做什么？"
- 用户选择正确意图后自动学习关键词
- 错误成本低：LLM 识别错误不影响用户

**自动升级条件（满足任一）**：
- 关键词匹配成功率 >= 80%（连续100次请求）
- 每个意图平均关键词数 >= 10 个
- 工厂使用超过 30 天

**阶段2：成熟期 (MATURE)**
- 正常模式：规则匹配优先 → LLM Fallback → 执行
- LLM 只在规则无法匹配时介入

---

## 架构决策：关键词晋升机制 ✅ 新增

**问题**：工厂级别学习的关键词只停留在该工厂，新工厂无法受益。

**解决方案**：跨工厂关键词自动晋升到全局

**晋升条件（需满足全部）**：
- N 个工厂都学习了相同关键词（默认 N=3）
- 平均有效分数 >= 阈值（默认 0.8）
- 无工厂删除/禁用过该关键词

**晋升后**：新工厂自动继承，无需LLM学习

---

## 架构决策：关键词交叉匹配处理 ✅ 新增

**问题**：同一关键词可能出现在多个意图中，例如"修改"同时存在于 BATCH_UPDATE、PLAN_UPDATE、PRODUCT_UPDATE 等意图。当用户输入匹配多个意图时，如何决定优先级？

**解决方案**：基于 TF-IDF 原理的 Specificity 权重

**原理**：
- 一个关键词出现在越多意图中，其特异性（specificity）越低
- 计算公式：`specificity = 1 / 该关键词出现的意图数量`
- 综合匹配得分：`matchScore = 关键词长度 × weight × specificity`

**示例**：

| 关键词 | 出现意图数 | specificity | 说明 |
|--------|-----------|-------------|------|
| "修改" | 5 | 0.2 | 通用词，低权重 |
| "修改批次" | 1 | 1.0 | 专属词，高权重 |
| "帮我改计划" | 1 | 1.0 | 专属词，高权重 |

**冲突处理规则**：
- 多个意图得分接近时（差距<20%），若有专属关键词匹配则优先选择
- 都是通用词匹配则返回候选列表让用户选择
- 用户选择后记录负反馈给未选中意图的关键词

**向后兼容性**：
- specificity 字段默认值 1.0，不影响已有数据
- 首次部署后通过调度任务批量计算 specificity

---

## 架构决策：LLM Fallback 与 Specificity 协调 ✅ 新增

**问题**：LLM Fallback 不使用关键词匹配，而是通过语义理解识别意图。当 LLM 成功匹配后自动学习新关键词时，如何与 Specificity 权重系统协调？

### 1. 新关键词初始化策略

当 LLM 自动学习新关键词时，设置初始值：
- **weight = 0.8**（手动添加的关键词是 1.0，LLM 学习的略低，需验证）
- **specificity = 1.0**（默认值，稍后批量计算）
- **effectiveness_score = 0.8**（初始效果分）
- **source = AUTO_LEARNED**（标记来源）

### 2. Specificity 延迟批量计算

新关键词的 specificity 不在学习时计算，而是通过每日调度任务批量处理：
- 调度时间：每日 05:30
- 统计每个关键词出现在多少个意图中
- 批量更新所有关键词的 specificity 值

### 3. LLM 置信度分级处理

根据 LLM 返回的置信度采取不同策略：

| LLM 置信度 | 动作 | 学习的关键词权重 |
|------------|------|-----------------|
| >= 0.95 | 直接执行 + 自动学习关键词 | weight = 0.9 |
| 0.90 - 0.95 | 直接执行 + 自动学习关键词 | weight = 0.7 |
| 0.70 - 0.90 | 提示用户确认 + 确认后学习 | weight = 0.8 |
| < 0.70 | 返回候选列表 + 不自动学习 | - |

### 4. 防止重复关键词学习

LLM 学习新关键词前，检查该词是否已存在于其他意图：
- 已存在于其他意图 → 跳过学习，避免制造更多交叉匹配问题
- 已存在于当前意图 → 跳过学习（已有）
- 全新词 → 保存到数据库

### 5. 关键词生命周期

```
[诞生]
├─ 手动添加 (weight=1.0, source=MANUAL)
└─ LLM学习 (weight=0.7-0.9, source=AUTO_LEARNED)
      ↓
[成长] - 调度任务每日处理
├─ specificity 重新计算
├─ effectiveness_score 基于 Wilson Score 更新
└─ weight 根据效果调整 (0.5 ~ 1.5)
      ↓
[验证] - 用户反馈
├─ 确认匹配正确 → positive_count++
└─ 选择其他意图 → negative_count++
      ↓
[晋升] - 跨工厂优秀关键词
├─ 3+工厂采用 + 平均效果>=0.8 + 无禁用
└─ 晋升为 GLOBAL 关键词 (source=PROMOTED)
      ↓
[淘汰] - 低效关键词清理
├─ effectiveness < 0.3 且 negative >= 5 → 删除
└─ 工厂级别删除不影响全局
```

### 6. 整体匹配流程

```
用户输入
    │
    ├─→ [1] 规则匹配（关键词）
    │       ├─ 计算得分: length × weight × specificity
    │       ├─ 单意图明确胜出 → 返回结果
    │       └─ 多意图得分接近 → 进入 [2]
    │
    ├─→ [2] LLM 判定（多选/无匹配场景）
    │       ├─ 返回意图 + confidence
    │       ├─ confidence >= 0.9 → 自动学习关键词
    │       └─ confidence < 0.9 → 提示用户确认
    │
    └─→ [3] 用户反馈
            ├─ 确认 → positive_count++
            └─ 选择其他 → negative_count++
```

---

## 当前现状

### 关键词现状（23个意图）
- 平均每个意图 5-6 个关键词
- 部分意图关键词较少
- 采用 substring 包含匹配

### 学习机制现状
- ✅ 每天4点生成 `IntentOptimizationSuggestion`（含 ADD_KEYWORD 类型）
- ✅ 从 RULE_MISS 记录中提取高频词
- ⚠️ 需要人工审核才能应用
- ✅ 已实现基于置信度的自动添加机制

---

## 已完成任务详情

### 任务0: 前端意图配置管理界面 ✅

**目标**: 让平台管理员/工厂超管可以在APP内管理意图关键词

**完成内容**:
1. `src/services/api/intentConfigApiClient.ts` - 后端API调用封装
2. `src/screens/management/IntentConfigScreen.tsx` - 意图配置管理页面
3. `ManagementScreen.tsx` - 添加入口导航
4. `ManagementStackNavigator.tsx` - 添加路由配置
5. `src/types/intent.ts` - 类型定义

**权限控制**:
| 功能 | 平台管理员 | 工厂超管 |
|------|------------|----------|
| 查看意图配置 | ✅ | ✅ |
| 修改关键词 | ✅ | ✅ |
| 自动学习配置 | ✅ | ✅ (仅本工厂) |

---

### 任务1: 丰富关键词列表 ✅

**目标**: 为每个意图增加 5-10 个同义词、口语表达、行业术语

**完成内容**:
- 创建 `V2026_01_03_1__enrich_intent_keywords.sql`
- 为全部23个意图扩充关键词：
  - ANALYSIS 分析类：COST_ANALYSIS, QUALITY_ANALYSIS, PRODUCTION_ANALYSIS, INVENTORY_ANALYSIS, TREND_PREDICTION
  - DATA_OP 数据操作类：BATCH_UPDATE, DATA_CORRECTION, BATCH_DELETE, PRODUCT_UPDATE, PLAN_UPDATE, MATERIAL_UPDATE, STATUS_CHANGE, QUANTITY_ADJUST
  - FORM 表单类：FORM_GENERATION, FORM_VALIDATION, FORM_SUGGESTION
  - SCHEDULE 排程类：SCHEDULE_OPTIMIZATION, RESOURCE_ALLOCATION, CAPACITY_PLANNING, URGENT_INSERT
  - SYSTEM 系统类：SYSTEM_REPORT, SYSTEM_CONFIG, USER_QUERY
- 包含审计日志记录和版本号更新

---

### 任务2: 自动学习逻辑 (后端) ✅

**目标**: 当 LLM Fallback 置信度 >= 0.9 时，自动将用户输入中的新词添加到关键词库

**完成内容**:

**1. 配置属性** (`AIIntentServiceImpl.java`):
- `autoLearnEnabled` - 自动学习开关（默认 true）
- `autoLearnConfidenceThreshold` - 置信度阈值（默认 0.9）
- `maxKeywordsPerIntent` - 每意图最大关键词数（默认 50）
- `STOP_WORDS` - 45个中文常用停用词

**2. 自动学习触发** (`tryLlmFallback()`):
- 当 LLM 匹配置信度 >= 阈值时触发
- 调用 `tryAutoLearnKeywords()` 方法

**3. 新增方法**:
- `tryAutoLearnKeywords()` - 编排自动学习流程
- `extractNewKeywords()` - 分词提取 + 停用词过滤 + 去重
- `autoAddKeywords()` - 持久化新关键词 + 缓存清除

**4. 配置文件** (`application.properties` + `application-prod.properties`):
- `cretas.ai.intent.auto-learn.enabled=true`
- `cretas.ai.intent.auto-learn.confidence-threshold=0.9`
- `cretas.ai.intent.auto-learn.max-keywords-per-intent=50`

---

### 任务3: 新词提取算法 ✅ (含在任务2中)

**目标**: 从用户输入中提取有价值的新关键词

**提取规则**:
1. 按空格/标点分割分词
2. 过滤停用词（的、是、了、把、我、要等45个）
3. 过滤已存在关键词
4. 过滤过短词（< 2字符）
5. 过滤纯数字
6. 保留有意义的新词
7. 单次最多学习3个新关键词

---

### 部署验证: 服务器部署与测试 ✅

**目标**: 将关键词丰富化和自动学习功能部署到生产服务器并验证

**完成内容**:

**1. 数据库迁移修正**:
- 发现生产环境表名为 `ai_intent_configs` (复数形式)
- 发现使用 `intent_code` 而非 `intent_name` 作为唯一标识
- 创建修正版 SQL: `/www/wwwroot/cretas/enrich_keywords_fixed.sql`

**2. 生产数据库现状** (5个意图):
| 意图代码 | 意图名称 | 原关键词数 | 丰富后关键词数 |
|----------|----------|------------|----------------|
| BATCH_UPDATE | 批次更新 | 7 | 25 |
| FORM_GENERATION | 表单生成 | 5 | 22 |
| MATERIAL_UPDATE | 原材料更新 | 6 | 18 |
| PLAN_UPDATE | 计划更新 | 6 | 21 |
| PRODUCT_UPDATE | 产品更新 | 6 | 18 |

**3. 验证测试结果**:
```
测试1: "帮我改批次的产量" → BATCH_UPDATE ✅ (新关键词"帮我改")
测试2: "编辑产品信息" → PRODUCT_UPDATE ✅ (新关键词"编辑产品")
测试3: "修改月计划" → PLAN_UPDATE ✅ (新关键词"月计划")
```

**4. 部署清单**:
- JAR: `/www/wwwroot/cretas/cretas-backend-system-1.0.0.jar`
- 后端服务 PID: 168276
- API端点: `POST /api/mobile/{factoryId}/ai-intents/recognize`

---

## 待开发任务

### 任务4: 关键词效果追踪与自动清理

**目标**: 追踪关键词匹配效果，自动降权/删除低效词

**效果追踪机制**：
- 用户确认意图 → 关键词正向反馈 +1
- 用户选择其他意图 → 关键词负向反馈 -1
- 用户取消/重新输入 → 无变化

**自动清理规则**：
| 条件 | 动作 |
|------|------|
| effectiveness_score < 0.3 且 负向反馈 >= 5 次 | 自动删除该关键词 |
| effectiveness_score < 0.5 | 降低该关键词匹配权重 |
| 工厂级别关键词低效 | 只删除工厂级别，不影响全局 |

---

### 任务5: 关键词晋升机制（工厂→全局）

**目标**: 当多个工厂学习了相同关键词且效果良好时，自动晋升到全局

**晋升流程**:
- 工厂学习关键词 → 记录到 keyword_factory_adoption
- 检查是否满足晋升条件 (3+工厂, 80%+效果, 无删除)
- 满足 → 自动晋升到全局
- 新工厂自动继承，无需LLM学习

---

### 任务6: 工厂级动态配置改造

**目标**: 原系统级配置改为工厂级动态配置，无需重启即时生效

**配置优先级**:
- 工厂级配置（存在则使用）
- 全局默认配置（application.properties，作为fallback）

---

## 文件修改清单

### 已完成文件

| 文件 | 改动类型 | 说明 |
|------|----------|------|
| `V2026_01_03_1__enrich_intent_keywords.sql` | 新增 | 一次性关键词扩充 |
| `AIIntentServiceImpl.java` | 修改 | 自动学习逻辑 + 新词提取 |
| `application.properties` | 修改 | 添加自动学习配置 |
| `application-prod.properties` | 修改 | 添加自动学习配置 |
| `intentConfigApiClient.ts` | 新增 | 前端API客户端 |
| `IntentConfigScreen.tsx` | 新增 | 意图配置管理界面 |
| `ManagementScreen.tsx` | 修改 | 添加入口 |
| `ManagementStackNavigator.tsx` | 修改 | 添加路由 |
| `intent.ts` | 新增 | 类型定义 |

### 已完成文件（任务4-6）

| 文件 | 改动类型 | 说明 |
|------|----------|------|
| `V2026_01_03_3__keyword_effectiveness.sql` | ✅ 已完成 | 关键词效果追踪表 |
| `V2026_01_03_4__keyword_factory_adoption.sql` | ✅ 已完成 | 跨工厂采用追踪表 |
| `V2026_01_03_5__factory_ai_learning_config.sql` | ✅ 已完成 | 工厂级配置表（含学习状态） |
| `KeywordEffectiveness.java` | ✅ 已完成 | 关键词效果追踪实体 |
| `KeywordFactoryAdoption.java` | ✅ 已完成 | 跨工厂采用记录实体 |
| `FactoryAILearningConfig.java` | ✅ 已完成 | 工厂级配置实体（含学习阶段） |

> **优化说明**：
> - 原计划的 `V5 (factory_learning_status)` 和 `V6 (factory_ai_learning_config)` 合并为单个 `V5` 迁移脚本
> - 原计划的 `FactoryIntentLearningStatus.java` 功能合并入 `FactoryAILearningConfig.java`，通过 `learningPhase` 字段和 `shouldTransitionToMature()` / `transitionToMature()` 方法实现学习阶段管理

---

## 配置项汇总

### 当前配置（已实现）

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `cretas.ai.intent.auto-learn.enabled` | true | 自动学习开关 |
| `cretas.ai.intent.auto-learn.confidence-threshold` | 0.9 | 置信度阈值 |
| `cretas.ai.intent.auto-learn.max-keywords-per-intent` | 50 | 每意图最大关键词数 |

### 已实现配置（工厂级动态配置）

> 以下配置现在通过 `FactoryAILearningConfig` 实体实现工厂级动态管理

| 配置项 | 对应字段 | 默认值 | 说明 |
|--------|----------|--------|------|
| 清理阈值 | `cleanupThreshold` | 0.3 | 低于此效果分的关键词将被清理 |
| 最小负反馈数 | `cleanupMinNegative` | 5 | 触发清理的最小负反馈数 |
| 晋升开关 | `promotionEnabled` | true | 是否启用关键词晋升 |
| 晋升最低有效分 | `promotionMinEffectiveness` | 0.8 | 晋升到全局的最低有效分 |
| 学习阶段 | `learningPhase` | LEARNING | LEARNING / MATURE |
| 成熟阈值天数 | `matureThresholdDays` | 90 | 多少天后自动转为成熟阶段 |
| LLM Fallback开关 | `llmFallbackEnabled` | true | 是否启用LLM兜底 |

---

## 预估工作量

| 任务 | 工作量 | 状态 |
|------|--------|------|
| 任务0: 前端意图配置管理界面 | 2小时 | ✅ 已完成 |
| 任务1: 丰富关键词 | 1.5小时 | ✅ 已完成 |
| 任务2: 自动学习逻辑 (后端) | 2小时 | ✅ 已完成 |
| 任务3: 新词提取算法 | 1小时 | ✅ 已完成 |
| 部署验证: 服务器部署与测试 | 1小时 | ✅ 已完成 |
| 任务4: 关键词效果追踪与自动清理 | 2小时 | ✅ 已完成 |
| 任务5: 关键词晋升机制（工厂→全局） | 2小时 | ✅ 已完成 |
| 任务6: 工厂级动态配置改造 | 1.5小时 | ✅ 已完成 |
| **总计** | **13小时** | **全部完成** |

---

## 并行工作建议

### Subagent 并行建议
- 可并行: ✅
- 建议: 可同时启动 2 个 agent 处理任务4-5

### 多 Chat 并行建议
- 可并行: ❌
- 原因: 任务4-6都涉及 `AIIntentServiceImpl.java` 同一文件，有冲突风险

---

## 扩展：AI 全面管理能力 ✅ 已完成 (2026-01-03)

### 概述
在关键词学习机制完成后，扩展实现了**AI 全面管理能力**，让工厂超管可以通过自然语言对话管理所有工厂配置。

### 新增 Handler（4个）

| Handler | Category | 功能 | 状态 |
|---------|----------|------|------|
| **SystemIntentHandler** | SYSTEM | 排产设置、工厂配置、功能开关 | ✅ Phase 1 |
| **UserIntentHandler** | USER | 用户创建/禁用、角色分配 | ✅ Phase 2 |
| **ConfigIntentHandler** | CONFIG | 设备维护、转换率、规则配置 | ✅ Phase 2 |
| **MetaIntentHandler** | META | 自我扩展（创建/更新/分析意图） | ✅ Phase 3 |

### 新增意图配置（14个）

| 意图代码 | 名称 | 类别 | 敏感度 |
|----------|------|------|--------|
| SCHEDULING_SET_AUTO | 排产全自动 | SYSTEM | HIGH |
| SCHEDULING_SET_MANUAL | 排产人工确认 | SYSTEM | HIGH |
| SCHEDULING_SET_DISABLED | 禁用自动排产 | SYSTEM | HIGH |
| FACTORY_FEATURE_TOGGLE | 功能开关 | SYSTEM | HIGH |
| FACTORY_NOTIFICATION_CONFIG | 通知设置 | SYSTEM | MEDIUM |
| USER_CREATE | 创建用户 | USER | HIGH |
| USER_DISABLE | 禁用用户 | USER | HIGH |
| USER_ROLE_ASSIGN | 角色分配 | USER | CRITICAL |
| EQUIPMENT_MAINTENANCE | 设备维护 | CONFIG | MEDIUM |
| CONVERSION_RATE_UPDATE | 转换率配置 | CONFIG | MEDIUM |
| RULE_CONFIG | 规则配置 | CONFIG | HIGH |
| INTENT_CREATE | 创建AI意图 | META | CRITICAL |
| INTENT_UPDATE | 更新AI意图 | META | HIGH |
| INTENT_ANALYZE | 分析意图使用 | META | LOW |

### 新增文件

```
backend-java/src/main/java/com/cretas/aims/service/handler/
├── SystemIntentHandler.java      # SYSTEM 类意图
├── UserIntentHandler.java        # USER 类意图
├── ConfigIntentHandler.java      # CONFIG 类意图
└── MetaIntentHandler.java        # META 类意图

backend-java/src/main/resources/db/migration/
└── V2026_01_04_1__ai_management_intents.sql
```

### 与关键词学习机制的关系

新增的意图配置同样受益于：
- ✅ 关键词自动学习 - LLM Fallback 成功后自动积累关键词
- ✅ 效果追踪 - 跟踪每个关键词的匹配效果
- ✅ 跨工厂晋升 - 优秀关键词自动晋升到全局
- ✅ 工厂学习阶段 - 新工厂从 LEARNING 阶段开始
